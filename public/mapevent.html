<!DOCTYPE html>
<html lang="fr" style="background:#020617;">
<head>
    <!-- CRITICAL: Premier paint toujours sombre, jamais blanc -->
    <style>html,body{background:#020617!important;margin:0;min-height:100vh;min-height:100dvh;overflow-x:hidden}#topbar{position:fixed!important;top:0!important;left:0!important;right:0!important;height:64px!important;z-index:100!important;background:#020617!important;display:flex!important;align-items:center!important;visibility:visible!important;opacity:1!important}#map{background:#020617!important;position:absolute;top:64px;left:0;right:0;bottom:0;min-height:50vh;min-height:calc(100dvh - 64px);z-index:5}.leaflet-container{background:#0f172a!important}@media(max-width:768px){#map{top:56px!important;bottom:60px!important;min-height:200px!important}#topbar{height:56px!important}}#app-loader{position:fixed;inset:0;z-index:9999;background:#020617;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .4s}#app-loader.hide{opacity:0;pointer-events:none}#app-loader .spinner{width:40px;height:40px;border:3px solid rgba(0,255,195,.2);border-top-color:#00ffc3;border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}#app-loader .logo{color:#00ffc3;font-size:22px;font-weight:800;margin-bottom:16px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}</style>
    <!-- Preconnect CDN Cloudflare (Leaflet, MarkerCluster) -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <!-- Preconnect vers l'API Lambda pour eviter le cold start -->
    <link rel="preconnect" href="https://ctp67u5hgni2rbfr3kp4p74kxa0gxycf.lambda-url.eu-west-1.on.aws" crossorigin>
    <link rel="dns-prefetch" href="https://ctp67u5hgni2rbfr3kp4p74kxa0gxycf.lambda-url.eu-west-1.on.aws">
    <!-- Preconnect pour les tuiles de carte -->
    <link rel="preconnect" href="https://a.tile.openstreetmap.org" crossorigin>
    <link rel="dns-prefetch" href="https://a.tile.openstreetmap.org">
    <meta charset="UTF-8">
    <title>MapEvent – Carte mondiale des événements, bookings et services</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP SUPPRIMÉE - L'extension de navigateur injecte sa propre CSP restrictive -->
    <!-- Pas de CSP dans le HTML pour éviter les conflits avec l'extension -->
    
    <!-- Meta standard SEO -->
    <meta name="description" content="Trouvez des événements, artistes à réserver et services professionnels partout dans le monde sur une seule carte interactive. Gratuit." id="meta-description">
    <meta name="keywords" content="événements, carte, concerts, festivals, booking, artistes, services, agenda, gratuit, mapevent">
    <meta name="author" content="MapEvent">
    <link rel="canonical" href="https://mapevent.world/">

    <!-- Open Graph / Facebook / WhatsApp / Discord -->
    <meta property="og:type" content="website" id="og-type">
    <meta property="og:url" content="https://mapevent.world/" id="og-url">
    <meta property="og:title" content="MapEvent – Événements, Bookings et Services sur une carte" id="og-title">
    <meta property="og:description" content="Trouvez des événements, artistes à réserver et services professionnels partout dans le monde. 3 cartes en 1, gratuit." id="og-description">
    <meta property="og:image" content="https://mapevent.world/assets/og-preview.png" id="og-image">
    <meta property="og:image:width" content="1200" id="og-image-width">
    <meta property="og:image:height" content="630" id="og-image-height">
    <meta property="og:image:alt" content="MapEvent - Carte mondiale des événements">
    <meta property="og:site_name" content="MapEvent">
    <meta property="og:locale" content="fr_FR">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" id="twitter-card">
    <meta name="twitter:url" content="https://mapevent.world/" id="twitter-url">
    <meta name="twitter:title" content="MapEvent – Événements, Bookings et Services sur une carte" id="twitter-title">
    <meta name="twitter:description" content="Trouvez des événements, artistes à réserver et services professionnels partout dans le monde. 3 cartes en 1, gratuit." id="twitter-description">
    <meta name="twitter:image" content="https://mapevent.world/assets/og-preview.png" id="twitter-image">
    <meta name="twitter:image:alt" content="MapEvent - Carte mondiale des événements">

    <!-- PWA (id + start_url absolue dans manifest = raccourci plus persistant) -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MapEvent">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png">

    <!-- Leaflet (cdnjs - CDN rapide et fiable) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"
      crossorigin=""
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"
      crossorigin=""
      defer
    ></script>
    
    <!-- Leaflet MarkerCluster (cdnjs) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js" defer></script>
    
    <!-- Stripe.js - chargé à la demande pour ne pas ralentir le premier affichage -->
    <!-- Voir window.loadStripe() ci-dessous -->

    <!-- Google Identity Services - chargé à la demande pour ne pas ralentir le premier affichage -->
    <!-- Voir window.loadGoogleIdentity() ci-dessous -->
    
    <!-- Lazy-loaders pour scripts lourds non-critiques -->
    <script>
    // Stripe : chargé uniquement quand on ouvre un paiement
    window._stripeLoaded = false;
    window.loadStripe = function() {
      return new Promise(function(resolve) {
        if (window._stripeLoaded || window.Stripe) { resolve(); return; }
        var s = document.createElement('script');
        s.src = 'https://js.stripe.com/v3/';
        s.onload = function() { window._stripeLoaded = true; resolve(); };
        s.onerror = function() { resolve(); };
        document.head.appendChild(s);
      });
    };
    // Google Identity : chargé uniquement quand on ouvre la connexion
    window._gsiLoaded = false;
    window.loadGoogleIdentity = function() {
      return new Promise(function(resolve) {
        if (window._gsiLoaded || (window.google && window.google.accounts)) { resolve(); return; }
        var s = document.createElement('script');
        s.src = 'https://accounts.google.com/gsi/client';
        s.onload = function() { window._gsiLoaded = true; resolve(); };
        s.onerror = function() { resolve(); };
        document.head.appendChild(s);
      });
    };
    // Pré-charger ces scripts après le premier affichage (idle time)
    if ('requestIdleCallback' in window) {
      requestIdleCallback(function() { window.loadGoogleIdentity(); window.loadStripe(); }, {timeout: 5000});
    } else {
      setTimeout(function() { window.loadGoogleIdentity(); window.loadStripe(); }, 3000);
    }
    </script>
    
    <!-- VIEWPORT PROGRESSIF: Les events sont chargés dynamiquement selon le zoom/viewport -->
    <!-- Plus de prefetch massif - chargement par zone visible uniquement -->
    <!-- Service IndexedDB - defer pour ne pas bloquer le premier rendu -->
    <script src="indexeddb_service.js" defer></script>

    <style>
        :root {
            --ui-body-bg: #020617;
            --ui-topbar-bg: #020617;
            --ui-card-bg: #020617;
            --ui-card-border: rgba(148,163,184,0.6);
            --ui-text-main: #e5e7eb;
            --ui-text-muted: #9ca3af;
            --btn-main-bg: linear-gradient(135deg,#22c55e,#4ade80);
            --btn-main-text: #022c22;
            --btn-main-shadow: 0 8px 22px rgba(34,197,94,0.75);
            --btn-alt-bg: rgba(15,23,42,0.9);
            --btn-alt-text: #e5e7eb;
            --pill-border: rgba(148,163,184,0.6);
        }

        * {
            box-sizing: border-box;
        }
        
        /* ⭐ CLUSTER STYLES - Dégradé classe, look professionnel */
        .custom-cluster-icon {
            background: transparent !important;
        }
        
        .marker-cluster {
            background-clip: padding-box;
            border-radius: 50%;
        }
        
        .marker-cluster div {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .marker-cluster:hover div {
            transform: scale(1.08);
            box-shadow: 0 3px 12px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.15);
        }
        
        /* Animation pulse douce sur les gros clusters */
        .marker-cluster-large div {
            animation: cluster-pulse 2.5s ease-in-out infinite;
        }
        
        @keyframes cluster-pulse {
            0%, 100% { box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
            50% { box-shadow: 0 3px 12px rgba(0,0,0,0.28), 0 0 0 1px rgba(255,255,255,0.12); }
        }
        
        /* Ligne de spiderfy - animation fluide quand les marqueurs se déplient */
        .leaflet-cluster-anim .leaflet-marker-icon,
        .leaflet-cluster-anim .leaflet-marker-shadow {
            transition: transform 0.3s ease-out, opacity 0.3s ease-in !important;
        }
        
        /* Lignes de connexion spiderfy (du cluster vers chaque marqueur) */
        .leaflet-cluster-spider-leg .leaflet-cluster-spider-leg-line {
            stroke: rgba(255, 255, 255, 0.5);
            stroke-width: 2;
        }
        
        /* Cluster avec nombre - curseur pointer */
        .custom-cluster-icon {
            cursor: pointer;
        }
        .custom-cluster-icon:hover {
            transform: scale(1.1);
            transition: transform 0.15s ease;
        }
        
        /* Style simple pour les inputs autofill */
        input:-webkit-autofill {
            -webkit-box-shadow: 0 0 0 30px rgba(15,23,42,0.5) inset !important;
            -webkit-text-fill-color: var(--ui-text-main) !important;
        }

        html, body {
            margin: 0;
            height: 100%;
            min-height: 100vh;
            min-height: 100dvh;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            background: #020617;
            background: var(--ui-body-bg);
            color: var(--ui-text-main);
            overflow: hidden;
        }

        /* TOPBAR */
        #topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: var(--ui-topbar-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 50;
            border-bottom: 1px solid rgba(148,163,184,0.5);
        }

        #logo-main {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #logo-main .icon {
            width: 30px;
            height: 30px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #22c55e, #0f172a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        #logo-main .text {
            font-weight: 800;
            font-size: 18px;
        }
        #logo-tagline {
            font-size: 11px;
            color: var(--ui-text-muted);
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .topbar-center {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pill {
            padding: 7px 16px;
            border-radius: 999px;
            border: 1px solid var(--pill-border);
            background: rgba(15,23,42,0.85);
            color: var(--ui-text-main);
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .pill.small {
            padding: 7px 12px;
            font-size: 12px;
        }

        /* ═══════════════════════════════════════════════════════════════
           BOUTON COMPTE - DESIGN PREMIUM PRO MAX
           ═══════════════════════════════════════════════════════════════ */
        
        #account-topbar-btn {
            min-width: auto !important;
            max-width: none !important;
            width: auto !important;
            flex-shrink: 0 !important;
            white-space: nowrap !important;
            padding: 5px 16px 5px 5px !important;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%) !important;
            border: 1px solid rgba(0, 255, 195, 0.3) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            position: relative !important;
            overflow: visible !important;
        }

        #account-topbar-btn:hover {
            border-color: rgba(0, 255, 195, 0.6) !important;
            box-shadow: 0 0 20px rgba(0, 255, 195, 0.25), 0 4px 15px rgba(0, 0, 0, 0.3) !important;
            transform: translateY(-1px) !important;
        }

        #account-topbar-btn:active {
            transform: translateY(0) !important;
        }

        /* Container avatar avec bordure gradient */
        #account-topbar-btn #account-avatar {
            position: relative !important;
            width: 34px !important;
            height: 34px !important;
            min-width: 34px !important;
            min-height: 34px !important;
            border-radius: 50% !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 18px !important;
            overflow: visible !important;
            flex-shrink: 0 !important;
            background: linear-gradient(135deg, #00ffc3 0%, #3b82f6 50%, #8b5cf6 100%) !important;
            padding: 2px !important;
            box-shadow: 0 2px 10px rgba(0, 255, 195, 0.3) !important;
            transition: all 0.3s ease !important;
        }

        #account-topbar-btn:hover #account-avatar {
            box-shadow: 0 4px 20px rgba(0, 255, 195, 0.5), 0 0 30px rgba(59, 130, 246, 0.3) !important;
            transform: scale(1.05) !important;
        }

        /* Conteneur interne pour l'image */
        #account-topbar-btn #account-avatar::before {
            content: '';
            position: absolute;
            inset: 2px;
            background: #0f172a;
            border-radius: 50%;
            z-index: 0;
        }

        #account-topbar-btn #account-avatar img {
            position: relative !important;
            width: calc(100% - 4px) !important;
            height: calc(100% - 4px) !important;
            object-fit: cover !important;
            border-radius: 50% !important;
            display: block !important;
            z-index: 1 !important;
            border: none !important;
        }

        /* Indicateur de statut "en ligne" */
        #account-topbar-btn #account-avatar::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #22c55e 0%, #10b981 100%);
            border: 2px solid #0f172a;
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 0 6px rgba(34, 197, 94, 0.6);
            animation: pulse-status 2s ease-in-out infinite;
        }

        @keyframes pulse-status {
            0%, 100% { 
                box-shadow: 0 0 6px rgba(34, 197, 94, 0.6);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
                transform: scale(1.1);
            }
        }

        /* Nom d'utilisateur premium */
        #account-topbar-btn #account-name {
            max-width: 150px !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            margin-left: 10px !important;
            font-weight: 600 !important;
            font-size: 13px !important;
            background: linear-gradient(90deg, #fff 0%, #00ffc3 100%) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            letter-spacing: 0.3px !important;
        }

        /* Style emoji quand pas de photo */
        #account-topbar-btn #account-avatar:not(:has(img)) {
            background: linear-gradient(135deg, rgba(0, 255, 195, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%) !important;
            border: 2px solid rgba(0, 255, 195, 0.4) !important;
            padding: 0 !important;
        }

        #account-topbar-btn #account-avatar:not(:has(img))::before {
            display: none;
        }

        #account-topbar-btn #account-avatar:not(:has(img))::after {
            display: none; /* Pas d'indicateur "en ligne" si pas connecté */
        }

        .pill.btn-main {
            background: var(--btn-main-bg);
            color: var(--btn-main-text);
            border: none;
            box-shadow: var(--btn-main-shadow);
            font-weight: 600;
        }

        .pill.btn-alt {
            background: var(--btn-alt-bg);
            color: var(--btn-alt-text);
        }

        .pill.btn-blue {
            background: linear-gradient(135deg,#0ea5e9,#38bdf8);
            color: #022c22;
            box-shadow: 0 6px 18px rgba(56,189,248,0.7);
            border:none;
            font-weight:600;
        }

        .pill.btn-violet {
            background: linear-gradient(135deg,#a855f7,#ec4899);
            color: #fdf2ff;
            box-shadow: 0 6px 18px rgba(236,72,153,0.7);
            border:none;
            font-weight:600;
        }

        .mode-btn {
            padding: 8px 16px;
            border-radius: 999px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: #e5e7eb;
            font-size: 13px;
            cursor: pointer;
        }
        .mode-btn.active {
            background: #00ffc3;
            color:#000;
        }

        /* MAP - visible immédiatement, pas d'écran blanc/noir */
        #map {
            position:absolute;
            top:64px;
            left:0;
            right:0;
            bottom:0;
            z-index: 5;
            background:#020617;
            min-height:50vh;
            min-height:calc(100dvh - 64px);
            will-change:transform;
        }

        /* SEARCH */
        #map-search-container {
            position:absolute;
            top:80px;
            left:48px;
            z-index:30;
        }
        #map-search-input {
            width:260px;
            max-width:70vw;
            padding:10px 14px;
            border-radius:999px;
            border:none;
            outline:none;
            font-size:13px;
            box-shadow:0 6px 18px rgba(0,0,0,0.45);
        }

        /* PUBLISH */
        #map-publish-btn {
            position:absolute;
            top:80px;
            right:20px;
            background:var(--btn-main-bg);
            color:var(--btn-main-text);
            padding:12px 26px;
            font-size:14px;
            border-radius:32px;
            border:2px solid rgba(250,250,250,0.7);
            font-weight:800;
            cursor:pointer;
            z-index:30;
            box-shadow:var(--btn-main-shadow);
        }

        /* FILTER PANEL - contenant optimisé pour réactivité */
        #left-panel {
            position:absolute;
            top:80px;
            left:10px;
            width:300px;
            max-height:calc(100vh - 100px);
            background:var(--ui-card-bg);
            border-radius:14px;
            border:1px solid var(--ui-card-border);
            padding:14px;
            overflow-y:auto;
            display:none;
            z-index:80;
            color:var(--ui-text-main);
            font-size:13px;
            box-shadow:0 20px 60px rgba(0,0,0,0.5);
            will-change:transform;
        }

        /* LIST VIEW */
        #list-view {
            position:absolute;
            top:64px;
            left:0;
            right:0;
            bottom:0;
            background:var(--ui-body-bg);
            color:var(--ui-text-main);
            overflow-y:auto;
            padding:16px;
            display:none; /* Caché par défaut, s'affiche quand listViewOpen = true */
            z-index:40;
        }

        /* MODAL PUBLISH - Déplaçable comme le filtre - Peut être ouvert avec le filtre */
        #publish-modal-backdrop {
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.3);
            display:none;
            align-items:flex-start;
            justify-content:flex-end;
            z-index:100; /* Au-dessus du left-panel (80) pour être toujours visible */
            pointer-events:auto; /* Permet d'interagir avec le modal */
            backdrop-filter: none; /* Pas de blur pour que le filtre soit net */
        }
        #publish-modal {
            position:absolute;
            top:80px;
            right:20px;
            width:100%;
            max-width:520px;
            max-height:calc(100vh - 100px);
            background:var(--ui-card-bg);
            border-radius:16px;
            border:1px solid var(--ui-card-border);
            padding:16px;
            overflow-y:auto;
            box-shadow:0 20px 60px rgba(0,0,0,0.5);
            pointer-events:auto; /* Le modal lui-même est cliquable */
            cursor:move; /* Curseur pour indiquer qu'on peut déplacer */
        }
        #publish-modal-header {
            cursor:move;
            user-select:none;
            padding-bottom:8px;
            border-bottom:1px solid var(--ui-card-border);
            margin-bottom:12px;
        }

        /* Scrollbars invisibles dans les popups Leaflet */
        .leaflet-popup-content {
            margin: 0 !important;
            padding: 0 !important;
            scrollbar-width: none; /* Firefox */
            width: 380px !important;
            box-sizing: border-box !important;
        }
        .leaflet-popup-content::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* Labels checkbox pour dates */
        .date-checkbox-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* Modal content styles - moved from inline to avoid CSP issues */
        .modal-register-section {
            margin-top: 16px;
            text-align: center;
        }

        .btn-create-account {
            padding: 8px 16px;
            border-radius: 999px;
            border: 1px solid #00ffc3;
            background: transparent;
            color: #00ffc3;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-create-account:hover {
            background: rgba(0, 255, 195, 0.1);
        }

        /* Login modal styles - moved from inline to avoid CSP issues */
        .login-modal-container {
            text-align: center;
            padding: 20px;
            max-width: 400px;
            margin: 0 auto;
        }

        .login-modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .login-modal-title {
            margin: 0 0 10px;
            font-size: 22px;
            font-weight: 700;
        }

        .login-modal-description {
            color: var(--ui-text-muted);
            margin-bottom: 24px;
        }

        .login-form-field {
            margin-bottom: 16px;
            text-align: left;
        }

        .login-form-field:last-of-type {
            margin-bottom: 20px;
        }

        .login-form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 6px;
        }

        .login-form-input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--ui-card-border);
            background: rgba(15, 23, 42, 0.9);
            color: var(--ui-text-main);
            font-size: 14px;
        }

        .login-btn-primary {
            width: 100%;
            padding: 14px;
            border-radius: 999px;
            border: none;
            background: var(--btn-main-bg);
            color: var(--btn-main-text);
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 12px;
            font-size: 15px;
        }

        .login-btn-secondary {
            width: 100%;
            padding: 10px;
            border-radius: 999px;
            border: 1px solid var(--ui-card-border);
            background: transparent;
            color: var(--ui-text-main);
            cursor: pointer;
        }

        /* Formulaire professionnel style Facebook */
        .pro-register-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 32px 24px;
            background: var(--ui-card-bg);
            border-radius: 12px;
        }

        .pro-register-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .pro-register-logo {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .pro-register-title {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            margin: 0 0 8px 0;
        }

        .pro-register-subtitle {
            font-size: 15px;
            color: var(--ui-text-muted);
            margin: 0;
        }

        .pro-register-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .pro-register-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .pro-register-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .pro-register-label {
            font-size: 13px;
            font-weight: 600;
            color: #fff;
        }

        .pro-register-label .required {
            color: #ff4444;
        }

        .pro-register-input {
            width: 100%;
            padding: 12px 14px;
            border-radius: 8px;
            border: 1px solid var(--ui-card-border);
            background: rgba(15, 23, 42, 0.9);
            color: var(--ui-text-main);
            font-size: 15px;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .pro-register-input:focus {
            outline: none;
            border-color: #00ffc3;
            box-shadow: 0 0 0 3px rgba(0, 255, 195, 0.1);
        }

        .pro-register-input::placeholder {
            color: var(--ui-text-muted);
        }

        .pro-register-photo-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 20px;
            border: 2px dashed var(--ui-card-border);
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.5);
            cursor: pointer;
            transition: all 0.2s;
        }

        .pro-register-photo-upload:hover {
            border-color: #00ffc3;
            background: rgba(0, 255, 195, 0.05);
        }

        .pro-register-photo-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #00ffc3;
            display: none;
        }

        .pro-register-photo-preview.show {
            display: block;
        }

        .pro-register-photo-placeholder {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }

        .pro-register-photo-text {
            font-size: 14px;
            color: var(--ui-text-muted);
            text-align: center;
        }

        .pro-register-photo-input {
            display: none;
        }

        .pro-register-password-container {
            position: relative;
        }

        .pro-register-password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--ui-text-muted);
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
        }

        .pro-register-password-toggle:hover {
            color: #fff;
        }

        .pro-register-password-strength {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }

        .pro-register-password-strength-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #22c55e);
            width: 0%;
            transition: width 0.3s;
        }

        /* Styles pour l'autocomplete d'adresse */
        .address-suggestions {
            position: absolute !important;
            top: 100% !important;
            left: 0 !important;
            right: 0 !important;
            background: #0a0e1a !important;
            background-color: #0a0e1a !important;
            border: 2px solid rgba(255,255,255,0.6) !important;
            border-radius: 8px !important;
            margin-top: 4px !important;
            max-height: 300px !important;
            overflow-y: auto !important;
            z-index: 10001 !important;
            box-shadow: 0 8px 32px rgba(0,0,0,1), inset 0 0 0 1px rgba(255,255,255,0.1) !important;
            opacity: 1 !important;
            backdrop-filter: none !important;
            isolation: isolate !important;
            mix-blend-mode: normal !important;
        }

        .address-suggestion-item {
            padding: 12px !important;
            cursor: pointer !important;
            border-bottom: 1px solid rgba(255,255,255,0.15) !important;
            transition: background 0.2s !important;
            background: #0a0e1a !important;
            background-color: #0a0e1a !important;
            opacity: 1 !important;
            backdrop-filter: none !important;
            isolation: isolate !important;
            mix-blend-mode: normal !important;
        }

        .address-suggestion-item:hover {
            background: rgba(0,255,195,0.25) !important;
            background-color: rgba(0,255,195,0.25) !important;
        }

        .address-suggestion-item:last-child {
            border-bottom: none !important;
        }
        
        .address-suggestion {
            background: #0a0e1a !important;
            background-color: #0a0e1a !important;
            opacity: 1 !important;
            backdrop-filter: none !important;
            isolation: isolate !important;
            mix-blend-mode: normal !important;
        }
        
        .address-suggestion:hover {
            background: rgba(0,255,195,0.25) !important;
            background-color: rgba(0,255,195,0.25) !important;
        }
        
        #pro-address-suggestions-wrapper {
            background: transparent !important;
            isolation: isolate !important;
            mix-blend-mode: normal !important;
        }
        
        #pro-address-suggestions {
            background: #050810 !important;
            background-color: #050810 !important;
            opacity: 1 !important;
            backdrop-filter: none !important;
            isolation: isolate !important;
            mix-blend-mode: normal !important;
            box-shadow: 0 8px 40px rgba(0,0,0,1), inset 0 0 0 2px rgba(0,0,0,0.5) !important;
            max-height: 120px !important;
            overflow-y: auto !important;
        }
        
        #pro-address-suggestions .address-suggestion {
            background: #050810 !important;
            background-color: #050810 !important;
            opacity: 1 !important;
            backdrop-filter: none !important;
            isolation: isolate !important;
            mix-blend-mode: normal !important;
        }
        
        #pro-address-suggestions * {
            background-color: transparent !important;
            mix-blend-mode: normal !important;
        }
        
        #pro-address-suggestions .address-suggestion > div {
            background: transparent !important;
            background-color: transparent !important;
            mix-blend-mode: normal !important;
        }
        
        #pro-address-suggestions::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0e1a;
            z-index: -1;
            border-radius: 8px;
            mix-blend-mode: normal;
        }
        
        #pro-address-suggestions::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: #0a0e1a;
            z-index: -2;
            border-radius: 10px;
            mix-blend-mode: normal;
        }
            margin-top: 8px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .pro-register-password-strength-fill {
            height: 100%;
            width: 0%;
            transition: all 0.3s;
            border-radius: 2px;
        }

        .pro-register-password-strength-fill.weak {
            width: 33%;
            background: #ff4444;
        }

        .pro-register-password-strength-fill.medium {
            width: 66%;
            background: #ffaa00;
        }

        .pro-register-password-strength-fill.strong {
            width: 100%;
            background: #00ffc3;
        }

        .pro-register-error {
            font-size: 12px;
            color: #ff4444;
            margin-top: 4px;
        }

        .pro-register-success {
            font-size: 12px;
            color: #00ffc3;
            margin-top: 4px;
        }

        .pro-register-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
        }

        .pro-register-btn-primary {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #00ffc3 0%, #00d4aa 100%);
            color: #000;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pro-register-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 255, 195, 0.3);
        }

        .pro-register-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .pro-register-btn-secondary {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--ui-card-border);
            background: transparent;
            color: var(--ui-text-main);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pro-register-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .pro-register-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 24px 0;
        }

        .pro-register-divider-line {
            flex: 1;
            height: 1px;
            background: var(--ui-card-border);
        }

        .pro-register-divider-text {
            font-size: 13px;
            color: var(--ui-text-muted);
        }

        .pro-register-legal {
            font-size: 11px;
            color: var(--ui-text-muted);
            text-align: center;
            margin-top: 16px;
            line-height: 1.5;
        }

        .pro-register-legal a {
            color: #00ffc3;
            text-decoration: none;
        }

        .pro-register-legal a:hover {
            text-decoration: underline;
        }

        /* Animations pour le formulaire pro */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pro-register-container {
            animation: slideInUp 0.4s ease-out;
        }

        .pro-register-field {
            animation: slideInUp 0.4s ease-out;
            animation-fill-mode: both;
        }

        .pro-register-field:nth-child(1) { animation-delay: 0.05s; }
        .pro-register-field:nth-child(2) { animation-delay: 0.1s; }
        .pro-register-field:nth-child(3) { animation-delay: 0.15s; }
        .pro-register-field:nth-child(4) { animation-delay: 0.2s; }
        .pro-register-field:nth-child(5) { animation-delay: 0.25s; }
        .pro-register-field:nth-child(6) { animation-delay: 0.3s; }
        .pro-register-field:nth-child(7) { animation-delay: 0.35s; }

        /* Amélioration du design du formulaire */
        .pro-register-input:invalid:not(:placeholder-shown) {
            border-color: #ef4444;
        }

        .pro-register-input:valid:not(:placeholder-shown) {
            border-color: #22c55e;
        }

        /* Effet de focus amélioré */
        .pro-register-input:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 255, 195, 0.2);
        }

        /* Photo upload amélioré */
        .pro-register-photo-upload:has(.pro-register-photo-preview.show) {
            border-color: #00ffc3;
            background: rgba(0, 255, 195, 0.05);
        }

        /* Welcome warning modal styles */
        .welcome-warning-container {
            text-align: center;
            padding: 32px;
            max-width: 500px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease-in;
        }

        .welcome-warning-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: scaleIn 0.4s ease-out;
        }

        .welcome-warning-title {
            margin: 0 0 16px;
            font-size: 28px;
            font-weight: 700;
            color: #fff;
        }

        .welcome-warning-message {
            color: var(--ui-text-muted);
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .welcome-warning-button {
            width: 100%;
            padding: 14px;
            border-radius: 999px;
            border: none;
            background: var(--btn-main-bg);
            color: var(--btn-main-text);
            font-weight: 700;
            cursor: pointer;
            font-size: 15px;
            transition: transform 0.2s, opacity 0.2s;
        }

        .welcome-warning-button:hover {
            transform: scale(1.02);
            opacity: 0.9;
        }

        /* Register modal styles - moved from inline to avoid CSP issues */
        .register-modal-container {
            text-align: center;
            padding: 24px;
            max-width: 600px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease-in;
        }

        .register-modal-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: scaleIn 0.4s ease-out;
        }

        .register-modal-title {
            margin: 0 0 12px;
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            background: linear-gradient(135deg, #00ffc3, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .register-modal-description {
            color: var(--ui-text-muted);
            margin-bottom: 28px;
            line-height: 1.7;
            font-size: 15px;
        }

        .register-social-buttons {
            margin-bottom: 24px;
        }

        .register-social-buttons > div {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-social {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid rgba(59,130,246,0.3);
            background: rgba(59,130,246,0.1);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .btn-social:hover {
            background: rgba(59,130,246,0.2);
            border-color: rgba(59,130,246,0.5);
        }

        .register-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
        }

        .register-divider-line {
            flex: 1;
            height: 1px;
            background: var(--ui-card-border);
        }

        .register-divider-text {
            color: var(--ui-text-muted);
            font-size: 13px;
        }

        .register-features {
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
        }

        .register-features-title {
            font-weight: 600;
            font-size: 15px;
            color: #3b82f6;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .register-features-list {
            margin: 0;
            padding-left: 24px;
            color: var(--ui-text-muted);
            font-size: 14px;
            line-height: 2;
        }

        .register-address-explanation {
            background: rgba(0,255,195,0.1);
            border: 1px solid rgba(0,255,195,0.3);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 24px;
            text-align: left;
        }

        .register-address-title {
            font-weight: 600;
            font-size: 15px;
            color: #00ffc3;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .register-address-text {
            margin: 0;
            color: var(--ui-text-muted);
            font-size: 14px;
            line-height: 1.7;
        }

        .btn-create-email-account {
            width: 100%;
            padding: 16px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            font-size: 16px;
            margin-top: 8px;
            box-shadow: 0 4px 15px rgba(59,130,246,0.4);
            transition: all 0.2s;
        }

        .btn-create-email-account:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59,130,246,0.6);
        }

        .register-cancel-btn {
            width: 100%;
            padding: 12px;
            border-radius: 999px;
            border: 1px solid var(--ui-card-border);
            background: transparent;
            color: var(--ui-text-main);
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s;
        }

        .register-cancel-btn:hover {
            background: rgba(15,23,42,0.5);
        }

        .register-legal-text {
            margin-top: 20px;
            font-size: 11px;
            color: var(--ui-text-muted);
            line-height: 1.6;
        }

        .register-legal-link {
            color: #3b82f6;
            text-decoration: underline;
        }

        /* Social buttons for registration step 1 */
        .btn-social-facebook {
            border-color: rgba(24, 119, 242, 0.3);
            background: rgba(24, 119, 242, 0.1);
            color: #1877f2;
            transition: all 0.2s;
        }

        .btn-social-facebook:hover {
            background: rgba(24, 119, 242, 0.2);
            border-color: rgba(24, 119, 242, 0.5);
        }

        .btn-social-apple {
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            transition: all 0.2s;
        }

        .btn-social-apple:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Animations for registration modal */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Register Step 2 styles - moved from inline to avoid CSP issues */
        .register-step2-container {
            padding: 24px;
            max-width: 550px;
            margin: 0 auto;
            max-height: 85vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-in;
        }

        .register-step2-header {
            text-align: center;
            margin-bottom: 28px;
        }

        .register-avatar-preview {
            font-size: 56px;
            margin-bottom: 12px;
            animation: scaleIn 0.4s ease-out;
        }

        .register-step2-title {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }

        .register-step2-subtitle {
            color: var(--ui-text-muted);
            margin-top: 8px;
            font-size: 14px;
        }

        .register-step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
        }

        .register-step-dot {
            width: 60px;
            height: 4px;
            background: var(--ui-card-border);
            border-radius: 2px;
        }

        .register-step-dot.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .register-name-fields {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .register-field-wrapper {
            margin-bottom: 20px;
        }

        .register-field {
            flex: 1;
        }

        .register-field-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .register-field-status {
            margin-left: 8px;
            font-size: 12px;
            font-weight: 400;
        }

        .register-required {
            color: #ef4444;
        }

        .register-optional {
            color: var(--ui-text-muted);
            font-weight: 400;
        }

        .register-input {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 1px solid var(--ui-card-border);
            background: rgba(15, 23, 42, 0.9);
            color: var(--ui-text-main);
            font-size: 15px;
            transition: all 0.2s;
        }

        .register-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .register-password-container {
            position: relative;
        }

        .register-password-input {
            padding-right: 40px;
        }

        .register-password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--ui-text-muted);
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
        }

        .register-password-strength-bar {
            margin-top: 8px;
            height: 4px;
            background: var(--ui-card-border);
            border-radius: 2px;
            overflow: hidden;
        }

        .register-password-strength-fill {
            height: 100%;
            width: 0%;
            transition: all 0.3s;
            background: #ef4444;
        }

        .register-password-requirements {
            margin-top: 8px;
            font-size: 11px;
            color: var(--ui-text-muted);
        }

        .register-password-req {
            margin-bottom: 2px;
        }

        .register-avatar-name {
            color: var(--ui-text-muted);
            font-weight: 400;
            margin-left: 8px;
        }

        .register-avatar-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
            background: rgba(15, 23, 42, 0.5);
            padding: 16px;
            border-radius: 14px;
            border: 1px solid var(--ui-card-border);
            max-height: 300px;
            overflow-y: auto;
        }

        .register-avatar-option {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            background: rgba(15, 23, 42, 0.5);
        }

        .register-avatar-option:hover,
        .register-avatar-option.hover {
            transform: scale(1.1);
            border-color: rgba(0, 255, 195, 0.5);
        }

        .register-avatar-option.selected {
            border-color: #00ffc3;
            background: rgba(0, 255, 195, 0.2);
        }

        .register-textarea {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 1px solid var(--ui-card-border);
            background: rgba(15, 23, 42, 0.9);
            color: var(--ui-text-main);
            font-size: 14px;
            resize: none;
            height: 70px;
            transition: all 0.2s;
        }

        .register-textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .register-textarea-counter {
            text-align: right;
            font-size: 11px;
            color: var(--ui-text-muted);
            margin-top: 6px;
        }

        .register-terms-container {
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .register-terms-label {
            display: flex;
            align-items: start;
            gap: 12px;
            cursor: pointer;
        }

        .register-terms-checkbox {
            margin-top: 4px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        .register-terms-text {
            flex: 1;
            font-size: 13px;
            color: var(--ui-text-main);
            line-height: 1.6;
        }

        .register-terms-link {
            color: #3b82f6;
            text-decoration: underline;
        }

        .register-step-buttons {
            display: flex;
            gap: 12px;
        }

        .register-btn-secondary {
            flex: 1;
            padding: 14px;
            border-radius: 999px;
            border: 1px solid var(--ui-card-border);
            background: transparent;
            color: var(--ui-text-main);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .register-btn-secondary:hover {
            background: rgba(15, 23, 42, 0.5);
        }

        .register-btn-primary {
            flex: 1;
            padding: 14px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            transition: all 0.2s;
        }

        .register-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
        }

        .register-feedback {
            margin-top: 6px;
            font-size: 12px;
        }

        /* Simplified registration step 1 styles */
        .register-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .register-button-primary {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .register-button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        .register-button-secondary {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--ui-card-border);
            background: transparent;
            color: var(--ui-text-main);
            font-weight: 500;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .register-button-secondary:hover {
            background: rgba(15, 23, 42, 0.5);
        }
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.5);
            background: rgba(15,23,42,0.85);
            color: var(--ui-text-main);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .date-checkbox-label:hover {
            border-color: #00ffc3;
            background: rgba(0,255,195,0.1);
        }
        .date-checkbox-label.active {
            background: rgba(0,255,195,0.2);
            border-color: #00ffc3;
            color: #00ffc3;
        }
        .date-checkbox-label input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }

        /* Scrollbar custom pour le panneau filtre */
        #left-panel::-webkit-scrollbar,
        #explorer-columns::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        #left-panel::-webkit-scrollbar-track,
        #explorer-columns::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
        #left-panel::-webkit-scrollbar-thumb,
        #explorer-columns::-webkit-scrollbar-thumb {
            background: rgba(0,255,195,0.4);
            border-radius: 3px;
        }
        #left-panel::-webkit-scrollbar-thumb:hover,
        #explorer-columns::-webkit-scrollbar-thumb:hover {
            background: rgba(0,255,195,0.6);
        }

        /* Checkbox custom */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(0,255,195,0.5);
            border-radius: 4px;
            background: rgba(15,23,42,0.9);
            cursor: pointer;
            position: relative;
            transition: all 0.15s;
        }
        input[type="checkbox"]:checked {
            background: #00ffc3;
            border-color: #00ffc3;
        }
        input[type="checkbox"]:checked::after {
            content: "✓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-size: 12px;
            font-weight: bold;
        }
        input[type="checkbox"]:hover {
            border-color: #00ffc3;
        }

        /* Séparateur topbar */
        .separator {
            width: 1px;
            height: 24px;
            background: rgba(148,163,184,0.3);
            margin: 0 8px;
        }

        /* Animations */
        @keyframes slideUp {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes slideDown {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, 100%); opacity: 0; }
        }
        @keyframes pulse-subtle {
            /* Animation très subtile - légère pulsation */
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.015); }
        }
        
        /* Nouvelles animations pour popups et modals */
        @keyframes popupSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        @keyframes modalFadeIn {
            from { 
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to { 
                opacity: 1;
                backdrop-filter: blur(8px);
            }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 5px currentColor, 0 0 10px currentColor; }
            50% { box-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; }
        }
        @keyframes bounce-in {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Styles pour popups Leaflet améliorés */
        .leaflet-popup-content-wrapper {
            background: linear-gradient(135deg, rgba(15,23,42,0.98) 0%, rgba(30,41,59,0.98) 100%) !important;
            border-radius: 16px !important;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1) !important;
            animation: popupSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            border: 1px solid rgba(0,255,195,0.2) !important;
            padding: 0 !important;
        }
        .leaflet-popup-tip {
            background: rgba(15,23,42,0.98) !important;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4) !important;
        }
        .leaflet-popup-close-button {
            color: #94a3b8 !important;
            font-size: 24px !important;
            width: 30px !important;
            height: 30px !important;
            padding: 4px !important;
            transition: all 0.2s !important;
        }
        .leaflet-popup-close-button:hover {
            color: #00ffc3 !important;
            background: rgba(0,255,195,0.1) !important;
            border-radius: 50% !important;
        }
        
        /* Animation marqueurs au survol - DÉSACTIVÉE pour éviter le déplacement */
        .leaflet-marker-icon {
            transition: filter 0.2s !important;
        }
        .leaflet-marker-icon:hover {
            /* Pas de transform scale pour éviter le déplacement */
            filter: drop-shadow(0 4px 12px rgba(0,255,195,0.4)) !important;
            z-index: 10000 !important;
        }
        
        /* Animation backdrop modal */
        #publish-modal-backdrop {
            animation: modalFadeIn 0.3s ease-out;
            backdrop-filter: none; /* Pas de blur pour que le filtre soit net */
        }
        #publish-modal {
            animation: popupSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Boutons avec effet ripple */
        .pill {
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .pill:active {
            transform: translateY(0);
        }
        
        /* Effet shimmer pour éléments loading */
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        /* Effet glow pour éléments importants */
        .glow-effect {
            animation: glow-pulse 2s infinite;
        }
        @keyframes pulse-halo-platinum {
            /* Halo platine rouge qui gonfle/dégonfle en gardant la largeur max */
            0%, 100% { 
                transform: translate(-50%,-50%) scale(1);
                opacity: 0.8;
                box-shadow: 0 0 8px rgba(239,68,68,0.6);
            }
            50% { 
                transform: translate(-50%,-50%) scale(1.08);
                opacity: 1;
                box-shadow: 0 0 12px rgba(239,68,68,0.8);
            }
        }
        @keyframes pulse-halo-platinum-2 {
            /* Deuxième halo platine rouge */
            0%, 100% { 
                transform: translate(-50%,-50%) scale(1);
                opacity: 0.6;
            }
            50% { 
                transform: translate(-50%,-50%) scale(1.12);
                opacity: 0.8;
            }
        }
        @keyframes star-point-orbit {
            /* Point étoile filante rouge qui tourne autour de la bordure */
            0% { 
                transform: translate(-50%,-50%) translateY(-30px) rotate(0deg);
                opacity: 0.8;
            }
            50% {
                opacity: 1;
            }
            100% { 
                transform: translate(-50%,-50%) translateY(-30px) rotate(360deg);
                opacity: 0.8;
            }
        }
        @keyframes star-point-glow {
            /* Lueur de l'étoile filante rouge */
            0%, 100% { 
                box-shadow: 0 0 6px #ef4444, 0 0 12px #ef4444;
            }
            50% { 
                box-shadow: 0 0 10px #ef4444, 0 0 20px #ef4444, 0 0 30px rgba(239,68,68,0.5);
            }
        }
        
        /* Animations progressives pour Top 10 positions 1-10 */
        @keyframes pulse-halo-1 {
            0%, 100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
        }
        @keyframes pulse-halo-2 {
            0%, 100% { opacity: 0.75; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.95; transform: translate(-50%, -50%) scale(1.08); }
        }
        @keyframes pulse-halo-3 {
            0%, 100% { opacity: 0.7; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.9; transform: translate(-50%, -50%) scale(1.06); }
        }
        @keyframes pulse-halo-4 {
            0%, 100% { opacity: 0.65; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.85; transform: translate(-50%, -50%) scale(1.04); }
        }
        @keyframes pulse-halo-5 {
            0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.03); }
        }
        @keyframes pulse-halo-6 {
            0%, 100% { opacity: 0.55; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.75; transform: translate(-50%, -50%) scale(1.02); }
        }
        @keyframes pulse-halo-7 {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.7; transform: translate(-50%, -50%) scale(1.01); }
        }
        @keyframes pulse-halo-8 {
            0%, 100% { opacity: 0.45; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.65; transform: translate(-50%, -50%) scale(1.01); }
        }
        @keyframes pulse-halo-9 {
            0%, 100% { opacity: 0.4; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.005); }
        }
        @keyframes pulse-halo-10 {
            0%, 100% { opacity: 0.35; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.55; transform: translate(-50%, -50%) scale(1); }
        }
        
        /* Rotation de l'étoile filante */
        @keyframes rotate-star-1 {
            from { transform: translate(-50%, -50%) rotate(0deg) translateY(-35px) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg) translateY(-35px) rotate(-360deg); }
        }
        @keyframes rotate-star-2 {
            from { transform: translate(-50%, -50%) rotate(0deg) translateY(-32px) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg) translateY(-32px) rotate(-360deg); }
        }
        @keyframes rotate-star-3 {
            from { transform: translate(-50%, -50%) rotate(0deg) translateY(-30px) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg) translateY(-30px) rotate(-360deg); }
        }
        @keyframes rotate-star-4 {
            from { transform: translate(-50%, -50%) rotate(0deg) translateY(-28px) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg) translateY(-28px) rotate(-360deg); }
        }
        @keyframes rotate-star-5 {
            from { transform: translate(-50%, -50%) rotate(0deg) translateY(-26px) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg) translateY(-26px) rotate(-360deg); }
        }
        @keyframes rotate-star-6 {
            from { transform: translate(-50%, -50%) rotate(0deg) translateY(-24px) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg) translateY(-24px) rotate(-360deg); }
        }
        @keyframes rotate-star-7 {
            from { transform: translate(-50%, -50%) rotate(0deg) translateY(-22px) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg) translateY(-22px) rotate(-360deg); }
        }
        
        /* Scintillement des particules */
        @keyframes twinkle-1 {
            0%, 100% { opacity: 0.8; transform: translate(-50%, -50%) rotate(0deg) translateY(-35px) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) rotate(0deg) translateY(-35px) scale(1.3); }
        }
        @keyframes twinkle-2 {
            0%, 100% { opacity: 0.7; transform: translate(-50%, -50%) rotate(0deg) translateY(-32px) scale(1); }
            50% { opacity: 0.9; transform: translate(-50%, -50%) rotate(0deg) translateY(-32px) scale(1.2); }
        }
        @keyframes twinkle-3 {
            0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) rotate(0deg) translateY(-30px) scale(1); }
            50% { opacity: 0.8; transform: translate(-50%, -50%) rotate(0deg) translateY(-30px) scale(1.15); }
        }
        @keyframes twinkle-4 {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) rotate(0deg) translateY(-28px) scale(1); }
            50% { opacity: 0.7; transform: translate(-50%, -50%) rotate(0deg) translateY(-28px) scale(1.1); }
        }
        @keyframes twinkle-5 {
            0%, 100% { opacity: 0.4; transform: translate(-50%, -50%) rotate(0deg) translateY(-26px) scale(1); }
            50% { opacity: 0.6; transform: translate(-50%, -50%) rotate(0deg) translateY(-26px) scale(1.05); }
        }

        /* Pointeurs boost - Leader mondial - Design pro 2025 */
        .marker-platinum {
            /* Top 10 : Halo qui gonfle/dégonfle + point étoile filante */
        }
        .marker-platinum .halo-ring-platinum {
            animation: pulse-halo-platinum 3s ease-in-out infinite;
        }
        .marker-platinum .halo-ring-platinum-2 {
            animation: pulse-halo-platinum-2 3.5s ease-in-out infinite;
        }
        .marker-platinum .star-point-platinum {
            animation: star-point-orbit 3s linear infinite, star-point-glow 1.5s ease-in-out infinite;
        }
        .marker-gold {
            /* Gold : Pas de halo, juste couleur jaune */
        }
        .marker-silver {
            /* Silver : Juste bordure fine, pas d'animation */
        }
        .marker-bronze {
            /* Bronze : Juste bordure fine, pas d'animation */
        }

        /* Logo animation */
        .logo-icon {
            transition: transform 0.3s ease;
        }
        #logo-main:hover .logo-icon {
            transform: rotate(10deg) scale(1.1);
        }

        /* Panneau filtre draggable */
        #left-panel {
            cursor: default;
            transition: box-shadow 0.2s;
        }
        #left-panel.dragging {
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            cursor: grabbing;
        }
        #left-panel-header {
            cursor: grab;
        }
        #left-panel-header:active {
            cursor: grabbing;
        }

        /* Mode boutons hover */
        .mode-btn {
            transition: all 0.2s ease;
        }
        .mode-btn:hover:not(.active) {
            background: rgba(0,255,195,0.1);
            border-color: rgba(0,255,195,0.5);
        }

        /* Cards hover effect */
        .event-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }

        /* Badge vérifié */
        .verified-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 600;
        }

        /* Bloc répétition - nouveau design avec cases à cocher */
        .repeat-checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--ui-text-main);
            cursor: pointer;
            margin-bottom: 8px;
        }
        .repeat-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #00ffc3;
        }
        .repeat-section-container {
            margin-top: 10px;
            padding: 12px;
            background: var(--ui-card-bg);
            border: 1px solid var(--ui-card-border);
            border-radius: 8px;
        }
        .repeat-type-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 12px;
        }
        .repeat-type-checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--ui-text-main);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .repeat-type-checkbox-label:hover {
            background: rgba(0,255,195,0.05);
        }
        .repeat-type-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #00ffc3;
        }
        .repeat-calendar-container {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--ui-card-border);
        }
        .repeat-calendar-label {
            font-size: 11px;
            color: var(--ui-text-muted);
            margin-bottom: 10px;
        }
        .repeat-days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }
        .repeat-day-btn {
            padding: 8px 4px;
            border-radius: 6px;
            border: 1px solid var(--ui-card-border);
            background: transparent;
            color: var(--ui-text-main);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .repeat-day-btn:hover {
            background: rgba(0,255,195,0.1);
            border-color: rgba(0,255,195,0.4);
        }
        .repeat-day-btn.selected {
            background: rgba(0,255,195,0.2);
            border-color: #00ffc3;
            color: #00ffc3;
            font-weight: 600;
        }
        .repeat-monthly-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-bottom: 6px;
        }
        .repeat-monthly-weekday {
            text-align: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--ui-text-muted);
            padding: 4px;
        }
        .repeat-monthly-days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }
        .repeat-monthly-day-btn {
            padding: 6px 4px;
            border-radius: 6px;
            border: 1px solid var(--ui-card-border);
            background: transparent;
            color: var(--ui-text-main);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 28px;
        }
        .repeat-monthly-day-btn:hover:not(.disabled) {
            background: rgba(0,255,195,0.1);
            border-color: rgba(0,255,195,0.4);
        }
        .repeat-monthly-day-btn.selected {
            background: rgba(0,255,195,0.2);
            border-color: #00ffc3;
            color: #00ffc3;
            font-weight: 600;
        }
        .repeat-monthly-day-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .repeat-summary {
            font-size: 11px;
            color: var(--ui-text-muted);
            padding: 6px 8px;
            background: transparent;
            margin-bottom: 8px;
        }
        .repeat-summary.has-selection {
            color: var(--ui-text-main);
        }
        .repeat-summary-label {
            color: var(--ui-text-muted);
            font-weight: 500;
        }
        .repeat-summary.has-selection .repeat-summary-label {
            color: #00ffc3;
        }
        .repeat-pricing-info {
            font-size: 10px;
            color: var(--ui-text-muted);
            padding: 6px 8px;
            background: transparent;
            border-top: 1px solid var(--ui-card-border);
            margin-top: 8px;
            padding-top: 8px;
        }

        /* Boost badges */
        .boost-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 600;
        }
        .boost-badge.platinum {
            background: linear-gradient(135deg, #e5e4e2, #ffffff);
            color: #1f2937;
            animation: glow 2s ease-in-out infinite;
        }
        .boost-badge.gold {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #1f2937;
        }
        .boost-badge.silver {
            background: linear-gradient(135deg, #c0c0c0, #e5e5e5);
            color: #1f2937;
        }
        .boost-badge.bronze {
            background: linear-gradient(135deg, #cd7f32, #daa06d);
            color: white;
        }

        /* Status overlays */
        .status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .status-overlay.complet {
            background: rgba(234,179,8,0.85);
            color: #1f2937;
        }
        .status-overlay.annule {
            background: rgba(239,68,68,0.85);
            color: white;
        }
        .status-overlay.reporte {
            background: rgba(59,130,246,0.85);
            color: white;
        }
        
        /* Responsive mobile pour les boutons auth */
        @media (max-width: 768px) {
            #auth-buttons {
                gap: 6px !important;
            }
            #auth-buttons .pill {
                padding: 6px 12px !important;
                font-size: 11px !important;
            }
        }
        
        /* ============================================
           PWA MOBILE LAYOUT
           Appliqué uniquement sur écrans < 768px
           ============================================ */
        @media (max-width: 768px) {
            /* TOPBAR MOBILE - Compact */
            #topbar {
                height: 56px !important;
                padding: 0 8px !important;
            }
            
            /* Logo compact sur mobile */
            #logo-main .text {
                display: none !important;
            }
            #logo-main #logo-tagline {
                display: none !important;
            }
            
            /* Cacher les éléments déplacés dans le menu compte */
            #eco-badge,
            #subscription-badge,
            #alerts-btn,
            #cart-btn {
                display: none !important;
            }
            
            /* Mode buttons (Event/Booking/Services) - Déplacés en bas */
            .topbar-center,
            #topbar > div:nth-child(2) {
                display: none !important;
            }
            
            /* Bouton Filtres dans la topbar - Style vert, décalé à gauche */
            #mobile-filter-topbar-btn {
                display: flex !important;
                position: absolute !important;
                left: calc(50% - 1.5cm) !important;
                transform: translateX(-50%) !important;
                padding: 8px 20px !important;
                background: transparent !important;
                border: 2px solid #22c55e !important;
                border-radius: 20px !important;
                color: #22c55e !important;
                font-weight: 600 !important;
                font-size: 13px !important;
                cursor: pointer !important;
                gap: 6px !important;
                align-items: center !important;
            }
            
            #mobile-filter-topbar-btn:active {
                background: rgba(34,197,94,0.1) !important;
            }
            
            /* Topbar droite - Garder compte et thèmes */
            .topbar-right {
                gap: 8px !important;
            }
            
            /* Boutons thème plus compacts */
            .topbar-right .pill[onclick*="Theme"] {
                padding: 6px 10px !important;
                font-size: 14px !important;
            }
            
            /* CARTE - Visible immédiatement sur mobile */
            #map {
                top: 56px !important;
                bottom: 60px !important;
                min-height: 200px !important;
            }
            
            /* BARRE D'ACTIONS MOBILE - Sous la barre catégories (56px topbar + 46px chips + 8px gap) */
            #map-search-container {
                top: 110px !important;
                left: 8px !important;
                right: auto !important;
                width: calc(100% - 130px) !important;
                max-width: none !important;
            }
            
            #map-search-container input {
                padding: 10px 12px !important;
                font-size: 14px !important;
            }
            
            /* Bouton Publier - À droite, aligné avec la recherche */
            #map-publish-btn {
                top: 110px !important;
                right: 8px !important;
                padding: 10px 14px !important;
                font-size: 13px !important;
            }
            
            /* Bouton Filtrer - Créer un bouton flottant */
            #left-panel {
                position: fixed !important;
                top: 56px !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 60px !important;
                width: 100% !important;
                max-width: 100% !important;
                border-radius: 0 !important;
                z-index: 90 !important;
            }
            
            /* NAVIGATION MOBILE - Barre fixe en bas */
            .mobile-nav-bar {
                display: flex !important;
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                height: 60px !important;
                background: var(--ui-topbar-bg) !important;
                border-top: 1px solid rgba(148,163,184,0.3) !important;
                z-index: 100 !important;
                justify-content: space-around !important;
                align-items: center !important;
                padding: 0 10px !important;
            }
            
            .mobile-nav-bar .nav-btn {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 8px 16px !important;
                background: transparent !important;
                border: none !important;
                color: var(--ui-text-muted) !important;
                font-size: 11px !important;
                cursor: pointer !important;
                transition: all 0.2s !important;
                border-radius: 12px !important;
            }
            
            .mobile-nav-bar .nav-btn.active {
                color: #22c55e !important;
                background: rgba(34,197,94,0.1) !important;
            }
            
            .mobile-nav-bar .nav-btn .nav-icon {
                font-size: 20px !important;
                margin-bottom: 2px !important;
            }
            
            /* Chips catégories scrollables - visible sur mobile */
            .category-chips-bar {
                display: block !important;
                position: fixed !important;
                top: 56px !important;
                left: 0 !important;
                right: 0 !important;
                height: 46px !important;
                z-index: 75 !important;
                background: rgba(2,6,23,0.92) !important;
                backdrop-filter: blur(10px) !important;
                -webkit-backdrop-filter: blur(10px) !important;
                border-bottom: 1px solid rgba(148,163,184,0.2) !important;
            }
            .category-chips-bar::-webkit-scrollbar,
            #category-chips-inner::-webkit-scrollbar { display: none !important; }
            
            /* Mode découverte - cartes swipe horizontales (au-dessus nav + mini-player) */
            .discovery-carousel {
                display: block !important;
                position: fixed !important;
                bottom: 72px !important;
                left: 0 !important;
                right: 0 !important;
                height: 130px !important;
                z-index: 70 !important;
                overflow: hidden;
                pointer-events: none;
            }
            .discovery-carousel.has-items { pointer-events: auto; }
            #discovery-carousel-inner {
                display: flex !important;
                gap: 12px !important;
                padding: 12px 16px !important;
                overflow-x: auto !important;
                scroll-snap-type: x mandatory !important;
                -webkit-overflow-scrolling: touch !important;
                scrollbar-width: none !important;
                height: 100% !important;
            }
            #discovery-carousel-inner::-webkit-scrollbar { display: none !important; }
            .discovery-card {
                flex-shrink: 0 !important;
                width: 260px !important;
                min-height: 90px !important;
                scroll-snap-align: center !important;
                border-radius: 12px !important;
                overflow: hidden !important;
                background: var(--ui-card-bg) !important;
                border: 1px solid var(--ui-card-border) !important;
                cursor: pointer !important;
                transition: transform 0.2s !important;
            }
            .discovery-card:active { transform: scale(0.98); }
            
            /* Liste view sur mobile */
            #list-view {
                top: 56px !important;
                bottom: 60px !important;
            }
            
            /* Modals sur mobile - Plein écran */
            .modal-backdrop {
                padding: 0 !important;
            }
            
            /* Formulaire publication plein écran sur mobile */
            #publish-modal-backdrop {
                align-items: stretch !important;
                justify-content: center !important;
            }
            #publish-modal {
                top: 0 !important;
                right: 0 !important;
                left: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                border-radius: 0 !important;
                margin: 0 !important;
                display: flex !important;
                flex-direction: column !important;
            }
            #publish-modal-inner {
                flex: 1 !important;
                min-height: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
            }
            #publish-modal-inner form {
                flex: 1 !important;
                min-height: 0 !important;
                display: flex !important;
                flex-direction: column !important;
            }
            #publish-modal-inner form > div:first-of-type {
                flex: 1 !important;
                min-height: 0 !important;
                overflow-y: auto !important;
            }
            
            .modal-container,
            .login-modal-container,
            .register-modal-container,
            .pro-register-container {
                width: 100% !important;
                max-width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                border-radius: 0 !important;
                margin: 0 !important;
            }
            
            /* Bouton installation PWA */
            .pwa-install-btn {
                display: flex !important;
                align-items: center !important;
                gap: 8px !important;
                padding: 12px 16px !important;
                background: linear-gradient(135deg, #667eea, #764ba2) !important;
                color: white !important;
                border: none !important;
                border-radius: 12px !important;
                font-size: 14px !important;
                font-weight: 600 !important;
                cursor: pointer !important;
                width: 100% !important;
                justify-content: center !important;
            }
        }
        
        /* Cacher la barre de navigation mobile sur desktop */
        .mobile-nav-bar {
            display: none;
        }
        
        .discovery-carousel {
            display: none !important;
        }
        
        /* Chips catégories - cachés sur desktop */
        .category-chips-bar {
            display: none;
        }
        
        /* MINI-PLAYER AUDIO - Fixe en bas, reste visible sur la map (comme Spotify) */
        #audio-mini-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 72px;
            background: linear-gradient(180deg, rgba(15,23,42,0.98), rgba(15,23,42,0.99));
            border-top: 1px solid rgba(139,92,246,0.4);
            z-index: 100000;
            display: none;
            align-items: center;
            gap: 12px;
            padding: 0 16px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
        }
        #audio-mini-player.visible {
            display: flex !important;
        }
        @media (max-width: 768px) {
            #audio-mini-player { bottom: 70px; height: 80px; }
        }
        
        /* Popup bottom sheet style mobile (Google Maps) */
        @media (max-width: 768px) {
            #popup-modal-backdrop {
                align-items: flex-end !important;
                padding: 0 !important;
                padding-top: 0 !important;
            }
            #popup-modal-content {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                max-height: 85vh !important;
                border-radius: 20px 20px 0 0 !important;
                animation: bottomSheetSlideUp 0.35s cubic-bezier(0.32, 0.72, 0, 1) !important;
            }
            @keyframes bottomSheetSlideUp {
                from { transform: translateY(100%); opacity: 0.9; }
                to { transform: translateY(0); opacity: 1; }
            }
            .popup-drag-handle {
                width: 40px;
                height: 4px;
                background: rgba(148,163,184,0.5);
                border-radius: 2px;
                margin: 10px auto 6px;
                flex-shrink: 0;
            }
        }
        /* Barre d'actions fixe en bas des popups (event/booking/service) */
        .popup-actions-sticky {
            background: var(--ui-card-bg, #1e293b) !important;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
        }
        @media (prefers-color-scheme: light) {
            .popup-actions-sticky {
                background: var(--ui-card-bg, #ffffff) !important;
            }
        }
    </style>
</head>
<body style="background:#020617;">
    <!-- Loading screen visible IMMEDIATEMENT pendant le chargement des scripts -->
    <div id="app-loader"><div class="logo">MapEvent</div><div class="spinner"></div><div id="loader-status" style="color:#9ca3af;font-size:13px;margin-top:12px;font-family:-apple-system,sans-serif;text-align:center;"></div></div>
    <!-- FALLBACK v7: Détection PWA ultra-rapide + retry agressif + pageshow + focus -->
    <script>
    (function(){
      var KEY = '__mapevent_retry';
      var retryCount = 0;
      try { retryCount = parseInt(sessionStorage.getItem(KEY)) || 0; } catch(e){}
      
      // Détecter si on est en mode PWA standalone (raccourci écran d'accueil)
      var isPWA = false;
      try { isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true; } catch(e){}
      
      function checkAppLoaded() {
        var loader = document.getElementById('app-loader');
        if (!loader || loader.classList.contains('hide')) return;
        
        // Si map_logic.js est chargé (définit _hideAppLoader), laisser finir normalement
        if (typeof window._hideAppLoader === 'function') {
          setTimeout(function() {
            var l = document.getElementById('app-loader');
            if (l && !l.classList.contains('hide')) {
              l.classList.add('hide');
              setTimeout(function(){ if(l.parentNode) l.parentNode.removeChild(l); }, 500);
            }
          }, 3000);
          try { sessionStorage.removeItem(KEY); } catch(e){}
          return;
        }
        
        // JS pas chargé : auto-reload (max 2 tentatives)
        if (retryCount < 2) {
          console.warn('[FALLBACK] JS non chargé, auto-reload #' + (retryCount + 1));
          try { sessionStorage.setItem(KEY, String(retryCount + 1)); } catch(e){}
          // Forcer update SW
          if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
          }
          location.reload();
          return;
        }
        
        // Après 2 auto-retries, montrer un bouton recharger
        console.warn('[FALLBACK] JS non chargé après 2 retries, affichage bouton');
        try { sessionStorage.removeItem(KEY); } catch(e){}
        var status = document.getElementById('loader-status');
        if (status) {
          status.innerHTML = '<div>Chargement lent...</div>' +
            '<button onclick="location.reload()" style="margin-top:16px;padding:12px 32px;background:linear-gradient(135deg,#22c55e,#4ade80);color:#022c22;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;-webkit-tap-highlight-color:transparent;">Recharger</button>' +
            '<div style="margin-top:10px;font-size:11px;color:#6b7280;">V\u00e9rifiez votre connexion internet</div>';
        }
      }
      
      // Nettoyer le compteur au bout de 20s si l'app charge normalement
      setTimeout(function(){ try { sessionStorage.removeItem(KEY); } catch(e){} }, 20000);
      
      // Masquer le loader après 2s max (safety net si map_logic lent ou erreur)
      setTimeout(function() {
        var l = document.getElementById('app-loader');
        if (l && !l.classList.contains('hide')) {
          l.classList.add('hide');
          setTimeout(function(){ if(l.parentNode) l.parentNode.removeChild(l); }, 500);
          console.log('[FALLBACK] Loader masqué après 2s');
        }
      }, 2000);
      // PWA standalone = vérifier après 3s (plus agressif)
      // Navigateur normal = vérifier après 5s
      setTimeout(checkAppLoaded, isPWA ? 3000 : 5000);
      
      // === FIX: pageshow pour bfcache Android Chrome ===
      window.addEventListener('pageshow', function(e) {
        if (e.persisted) {
          setTimeout(function() {
            var mapEl = document.getElementById('map');
            if (!mapEl || mapEl.children.length === 0) {
              console.warn('[FALLBACK] Page bfcache cassée, reload...');
              location.reload();
            } else if (typeof L !== 'undefined' && typeof map !== 'undefined' && map && typeof map.invalidateSize === 'function') {
              try { map.invalidateSize(); } catch(ex) {}
            }
          }, 500);
        }
      });
      
      // === FIX: focus handler pour certains navigateurs mobiles ===
      var lastFocusCheck = 0;
      window.addEventListener('focus', function() {
        var now = Date.now();
        if (now - lastFocusCheck < 3000) return;
        lastFocusCheck = now;
        setTimeout(function() {
          if (typeof L !== 'undefined' && typeof map !== 'undefined' && map && typeof map.invalidateSize === 'function') {
            try { map.invalidateSize(); } catch(ex) {}
          }
        }, 300);
      });
    })();
    </script>
    <div id="topbar">
        <div class="topbar-left" style="display:flex;align-items:center;gap:12px;">
            <div id="logo-main" style="cursor:pointer;" onclick="openAboutModal()" title="À propos de MapEvent">
                <div class="logo-icon" style="position:relative;">
                    <svg width="42" height="42" viewBox="0 0 42 42" fill="none" style="filter:drop-shadow(0 2px 6px rgba(0,255,195,0.4));">
                        <defs>
                            <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#00ffc3"/>
                                <stop offset="100%" stop-color="#3b82f6"/>
                            </linearGradient>
                        </defs>
                        
                        <!-- Halo anime - Double cercle - Change avec le theme custom -->
                        <circle id="logo-halo-1" cx="21" cy="21" r="20" fill="none" stroke="#00ffc3" stroke-width="1.5" opacity="0.5">
                            <animate attributeName="r" values="19;21;19" dur="2.2s" repeatCount="indefinite"/>
                            <animate attributeName="opacity" values="0.3;0.6;0.3" dur="2.2s" repeatCount="indefinite"/>
                        </circle>
                        <circle id="logo-halo-2" cx="21" cy="21" r="17" fill="none" stroke="#00ffc3" stroke-width="1" opacity="0.3">
                            <animate attributeName="r" values="16;19;16" dur="2.8s" repeatCount="indefinite"/>
                            <animate attributeName="opacity" values="0.2;0.5;0.2" dur="2.8s" repeatCount="indefinite"/>
                        </circle>
                        
                        <!-- Logo App Mobile: Pin de carte stylise -->
                        <g transform="translate(8,4)">
                            <!-- Pin body -->
                            <path d="M13 0C5.82 0 0 5.82 0 13c0 9.75 13 21 13 21s13-11.25 13-21C26 5.82 20.18 0 13 0z" fill="url(#logoGrad)" stroke="rgba(255,255,255,0.3)" stroke-width="1.5"/>
                            <!-- Inner circle -->
                            <circle cx="13" cy="12" r="7" fill="rgba(0,0,0,0.25)"/>
                            <circle cx="13" cy="12" r="5.5" fill="white"/>
                            <!-- M letter -->
                            <text x="13" y="15.5" text-anchor="middle" font-family="system-ui,-apple-system,sans-serif" font-weight="900" font-size="10" fill="url(#logoGrad)">M</text>
                            <!-- Small event dots -->
                            <circle cx="5" cy="8" r="1.5" fill="#f59e0b" opacity="0.9"/>
                            <circle cx="21" cy="8" r="1.5" fill="#ec4899" opacity="0.9"/>
                            <circle cx="13" cy="4" r="1.2" fill="#fff" opacity="0.7"/>
                        </g>
                    </svg>
                </div>
                <div style="display:flex;flex-direction:column;align-items:center;">
                    <div class="text" style="background:linear-gradient(90deg,#00ffc3,#3b82f6);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-weight:800;font-size:18px;">MAP EVENT</div>
                    <div id="logo-tagline" style="font-size:12px;color:var(--ui-text-muted);line-height:1.2;text-align:center;">Votre plateforme événementielle</div>
                    <div id="stats-counts-badge" style="font-size:11px;color:var(--ui-text-muted);margin-top:2px;">—</div>
                </div>
            </div>
            
            <!-- Sauver la Terre (1 cm à droite) -->
            <div id="eco-badge" onclick="openEcoMissionModal()" style="cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 12px;background:linear-gradient(135deg,rgba(34,197,94,0.2),rgba(16,185,129,0.1));border:1px solid rgba(34,197,94,0.4);border-radius:999px;transition:all 0.3s;margin-left:16px;" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 0 15px rgba(34,197,94,0.5)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none'">
                <span style="font-size:18px;">🌍</span>
                <span style="font-size:11px;color:#22c55e;font-weight:600;">Sauver la Terre</span>
            </div>
        </div>

        <!-- Bouton Filtres MOBILE - Visible uniquement sur mobile, centré dans la topbar -->
        <button id="mobile-filter-topbar-btn" onclick="toggleLeftPanel()" style="display:none;">
            ⚙️ Filtres
        </button>

        <div class="topbar-center" style="display:flex;justify-content:center;align-items:center;gap:12px;flex:1;">
            <!-- Filtrer (encore un peu plus à gauche, ~1 cm) -->
            <button class="mode-btn" onclick="toggleLeftPanel()" style="background:linear-gradient(135deg,rgba(0,255,195,0.2),rgba(59,130,246,0.2));border:1px solid rgba(0,255,195,0.5);color:#00ffc3;font-weight:600;margin-right:16px;">🔍 Filtrer</button>
            
            <!-- Modes (bien centrés) -->
            <div style="display:flex;gap:8px;">
                <button class="mode-btn active" onclick="switchMode('event')">🎉 Events</button>
                <button class="mode-btn" onclick="switchMode('booking')">🎤 Booking</button>
                <button class="mode-btn" onclick="switchMode('service')">🔧 Services</button>
            </div>
            
            <!-- Liste (un peu plus à droite, ~1 cm) -->
            <button class="mode-btn" onclick="toggleListView()" style="background:linear-gradient(135deg,rgba(0,255,195,0.2),rgba(59,130,246,0.2));border:1px solid rgba(0,255,195,0.5);color:#00ffc3;font-weight:600;margin-left:16px;">📋 Liste</button>
        </div>

        <div class="topbar-right">
            <button id="subscription-badge" class="pill small" onclick="openSubscriptionModal()">
                <span>💎</span>
                <span id="subscription-label">ABOS</span>
            </button>
            <script>
                // Forcer "ABOS" au chargement (sans setInterval pour économiser CPU mobile)
                (function() {
                    const forceABOS = () => {
                        const label = document.getElementById("subscription-label");
                        if (label) { label.textContent = "ABOS"; }
                    };
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', forceABOS);
                    } else {
                        forceABOS();
                    }
                })();
            </script>
            <button id="alerts-btn" class="pill small" onclick="openProximityAlertsView()" style="position:relative;">
                <span>🔔</span>
                <span>Alertes</span>
                <span id="alerts-count" style="position:absolute;top:-6px;right:-6px;background:#3b82f6;color:white;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;display:none;">0</span>
            </button>
            <button id="cart-btn" class="pill small" onclick="openCartModal()" style="position:relative;">
                <span>🛒</span>
                <span>Panier</span>
                <span id="cart-count" style="position:absolute;top:-6px;right:-6px;background:#ef4444;color:white;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;display:none;">0</span>
            </button>
            <!-- Bouton Auth (affiché seulement si non connecté) -->
            <div id="auth-buttons" style="display:none;gap:8px;align-items:center;flex-wrap:wrap;">
                <button id="login-topbar-btn" class="pill small" onclick="if(typeof window.openLoginModal === 'function') { window.openLoginModal(); } else if(typeof window.openAuthModal === 'function') { window.openAuthModal('login'); } else if(typeof openLoginModal === 'function') { openLoginModal(); }" style="background:transparent;border:1px solid rgba(255,255,255,0.2);color:var(--ui-text-main);font-weight:600;padding:8px 16px;white-space:nowrap;font-size:13px;cursor:pointer;">
                    Connexion
                </button>
            </div>
            <button id="account-topbar-btn" class="pill small" onclick="openAccountModal()">
                <span id="account-avatar">👤</span>
                <span id="account-name">Compte</span>
            </button>
            <button class="pill small" onclick="cycleUITheme()" title="Changer le thème">🎨</button>
            <button class="pill small" onclick="cycleMapTheme()" title="Changer la carte">🗺️</button>
        </div>
    </div>

    <!-- Chips catégories scrollables (mobile) -->
    <div id="category-chips-bar" class="category-chips-bar">
      <div id="category-chips-inner" style="display:flex;gap:8px;padding:8px 12px;overflow-x:auto;scroll-snap-type: inline mandatory;-webkit-overflow-scrolling:touch;scrollbar-width:none;align-items:center;height:100%;">
      </div>
    </div>

    <div id="map"></div>

    <!-- Mode découverte - Cartes horizontales swipe (mobile) -->
    <div id="discovery-carousel" class="discovery-carousel">
      <div id="discovery-carousel-inner"></div>
    </div>

    <!-- NAVIGATION MOBILE - Barre fixe en bas (visible uniquement sur mobile via CSS) -->
    <nav class="mobile-nav-bar" id="mobile-nav">
        <button class="nav-btn active" onclick="switchMode('event'); updateMobileNav('event');" id="mobile-nav-event">
            <span class="nav-icon">📅</span>
            <span>Events</span>
        </button>
        <button class="nav-btn" onclick="switchMode('booking'); updateMobileNav('booking');" id="mobile-nav-booking">
            <span class="nav-icon">🎤</span>
            <span>Booking</span>
        </button>
        <button class="nav-btn" onclick="switchMode('service'); updateMobileNav('service');" id="mobile-nav-service">
            <span class="nav-icon">🔧</span>
            <span>Services</span>
        </button>
    </nav>

    <!-- MINI-PLAYER AUDIO - Apparaît quand un son joue -->
    <div id="audio-mini-player">
        <button id="mini-player-play" style="width:48px;height:48px;border-radius:50%;border:none;background:linear-gradient(135deg,#a78bfa,#8b5cf6);color:white;cursor:pointer;font-size:18px;flex-shrink:0;display:flex;align-items:center;justify-content:center;">▶</button>
        <div id="mini-player-info" style="flex:1;min-width:0;overflow:hidden;cursor:pointer;" onclick="openCurrentPlayingPopup()" title="Voir l'artiste">
            <div id="mini-player-title" style="font-size:13px;font-weight:600;color:#e5e7eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">—</div>
            <div id="mini-player-subtitle" style="font-size:11px;color:#a78bfa;">Piste 1</div>
        </div>
        <button id="mini-player-rewind" style="width:36px;height:36px;border-radius:50%;border:1px solid rgba(167,139,250,0.5);background:transparent;color:#a78bfa;cursor:pointer;font-size:14px;flex-shrink:0;" title="-15s">⏪</button>
        <button id="mini-player-forward" style="width:36px;height:36px;border-radius:50%;border:1px solid rgba(167,139,250,0.5);background:transparent;color:#a78bfa;cursor:pointer;font-size:14px;flex-shrink:0;" title="+15s">⏩</button>
        <span id="mini-player-time" style="font-size:11px;color:#a78bfa;font-variant-numeric:tabular-nums;min-width:70px;text-align:right;">0:00</span>
    </div>

    <div id="map-search-container">
        <input
          id="map-search-input"
          type="text"
          placeholder="Rechercher une ville..."
        />
    </div>

    <button id="map-publish-btn" onclick="openPublishModal()">
        Publier
    </button>
    
    <!-- Bouton Assistant AI désactivé pour l'instant -->
    <!-- <button id="map-ai-assistant-btn" onclick="openAIAssistantModal()" style="
        position:fixed;
        bottom:20px;
        right:20px;
        width:60px;
        height:60px;
        border-radius:50%;
        border:none;
        background:linear-gradient(135deg,#00ffc3,#3b82f6);
        color:#000;
        font-size:28px;
        cursor:pointer;
        box-shadow:0 4px 20px rgba(0,255,195,0.5);
        z-index:1000;
        display:flex;
        align-items:center;
        justify-content:center;
        transition:all 0.3s;
    " onmouseover="this.style.transform='scale(1.1)';this.style.boxShadow='0 6px 25px rgba(0,255,195,0.7)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 20px rgba(0,255,195,0.5)'" title="Assistant AI - Test">
        🤖
    </button> -->

    <div id="left-panel"></div>
    <div id="list-view"></div>

    <!-- MODAL PUBLISH -->
    <div id="publish-modal-backdrop" onclick="closePublishModal(event)">
        <div id="publish-modal">
            <div id="publish-modal-inner"></div>
        </div>
    </div>

    <!-- SCRIPT DE FALLBACK SUPPRIMÉ - Le formulaire s'affiche uniquement dans le callback OAuth après validation Google -->
    
    <!-- ⚠️ NETTOYAGE AGRESSIF LOCALSTORAGE - Doit être AVANT tous les autres scripts -->
    <script>
    (function() {
      try {
        // Liste des clés ESSENTIELLES à garder - tout le reste sera supprimé
        var KEEP = ['currentUser','accessToken','refreshToken','id_token','stayLoggedIn','theme','language','userLang','lastMode','filtersState','mapCenter','mapZoom','cookiesAccepted','userPosition','pendingPublishData'];
        var allKeys = [];
        for (var i = 0; i < localStorage.length; i++) { allKeys.push(localStorage.key(i)); }
        var removed = 0;
        allKeys.forEach(function(k) {
          if (k && KEEP.indexOf(k) === -1) {
            try { localStorage.removeItem(k); removed++; } catch(e) {}
          }
        });
        if (removed > 0) { console.log('[STORAGE] Nettoyage agressif: ' + removed + ' entrées non-essentielles supprimées'); }
      } catch (e) { console.warn('[STORAGE] Erreur nettoyage:', e); }
    })();
    </script>
    <!-- Modules core et services (doit être chargé avant auth.js) -->
    <script type="module" src="js/load-modules.js"></script>
    <!-- Module AUTH (fonctions d'authentification) -->
    <script src="auth.js?v=20260213-SWv7" defer></script>
    <!-- Script de diagnostic username (développement uniquement) -->
    <script>
      // Exposer une fonction globale pour lancer le diagnostic
      window.diagnosticUsername = function() {
        // Charger le script de diagnostic
        fetch('tests/diagnostic/diagnostic-username-simple.js')
          .then(response => response.text())
          .then(code => {
            eval(code);
          })
          .catch(err => {
            console.error('❌ Erreur chargement diagnostic:', err);
            console.log('%c💡 Alternative: Ouvrez tests/diagnostic/DIAGNOSTIC_USERNAME_CONSOLE.txt et copiez-collez le code dans la console', 'color: #f59e0b; font-weight: bold;');
          });
      };
      console.log('%c💡 Pour lancer le diagnostic username, tapez: diagnosticUsername()', 'color: #00ffc3; font-weight: bold;');
      console.log('%c💡 Ou ouvrez: tests/diagnostic/DIAGNOSTIC_USERNAME_CONSOLE.txt et copiez-collez le code', 'color: #00ffc3; font-weight: bold;');
    </script>
    <!-- Logique principale de la carte -->
    <script src="map_logic.js?v=20260217-fix" defer></script>
    <!-- Script pour mettre à jour les métadonnées Open Graph immédiatement au chargement -->
    <script>
      // Mettre à jour les métadonnées Open Graph dès le chargement de la page
      // pour que les scrapers des réseaux sociaux les détectent
      (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('event');
        const bookingId = urlParams.get('booking');
        const serviceId = urlParams.get('service');
        
        if (eventId || bookingId || serviceId) {
          // Mettre à jour le titre de la page immédiatement avec l'ID
          // (le titre complet sera mis à jour quand les données seront chargées)
          document.title = eventId ? `Événement ${eventId} - MapEvent` : 
                           bookingId ? `Booking ${bookingId} - MapEvent` :
                           `Service ${serviceId} - MapEvent`;
          
          // Attendre que map_logic.js soit chargé et que les données soient disponibles
          let attempts = 0;
          const maxAttempts = 20; // 10 secondes max
          
          const checkAndUpdate = setInterval(() => {
            attempts++;
            
            if (typeof window.updateOpenGraphMetadata === 'function' && 
                typeof window.checkUrlParamsAndUpdateMetadata === 'function') {
              
              // Utiliser la fonction dédiée qui gère les tentatives multiples
              window.checkUrlParamsAndUpdateMetadata();
              clearInterval(checkAndUpdate);
            } else if (attempts >= maxAttempts) {
              clearInterval(checkAndUpdate);
              console.warn('⚠️ Impossible de charger les fonctions de métadonnées');
            }
          }, 500); // Vérifier toutes les 500ms
        }
      })();
    </script>
    
    <!-- PWA: Enregistrement du Service Worker et gestion de l'installation -->
    <script>
      // Variables globales PWA
      window.pwaInstallPrompt = null;
      window.isPWAInstalled = false;
      
      // Vérifier si l'app est installée en mode standalone
      if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
        window.isPWAInstalled = true;
        console.log('[PWA] App installée en mode standalone');
      }
      
      // Enregistrement du Service Worker avec mise à jour automatique
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then((registration) => {
              console.log('[PWA] Service Worker enregistré:', registration.scope);
              // Vérifier les mises à jour périodiquement (toutes les 30min)
              setInterval(() => registration.update(), 30 * 60 * 1000);
              // Vérifier immédiatement à chaque retour au premier plan
              document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') registration.update();
              });
            })
            .catch((error) => {
              console.error('[PWA] Erreur enregistrement Service Worker:', error);
            });
        });
      }
      
      // ===== CORRECTION ÉCRAN BLANC MOBILE v6 =====
      // Quand l'app PWA revient du background, vérifier que la carte est fonctionnelle
      // Si le DOM est vide ou la carte cassée, recharger proprement
      document.addEventListener('visibilitychange', function() {
        if (document.visibilityState !== 'visible') return;
        
        // Attendre un peu que le navigateur restaure l'état (500ms au lieu de 1000ms)
        setTimeout(function() {
          var mapEl = document.getElementById('map');
          var topbar = document.getElementById('topbar');
          
          // Si les éléments DOM essentiels ont disparu → page cassée
          if (!mapEl || !topbar) {
            console.warn('[PWA] DOM cassé après retour background, reload...');
            location.reload();
            return;
          }
          
          // Vérifier que la carte Leaflet est toujours initialisée
          if (typeof L !== 'undefined' && typeof map !== 'undefined' && map && typeof map.invalidateSize === 'function') {
            // Forcer le recalcul de la taille (corrige les tuiles grises)
            try { map.invalidateSize(); } catch(e) {}
          } else if (mapEl.children.length === 0) {
            // La carte n'a jamais été initialisée ou a été purgée
            console.warn('[PWA] Carte non initialisée après retour, reload...');
            location.reload();
          }
          
          // Vérifier que le loader n'est pas resté bloqué
          var loader = document.getElementById('app-loader');
          if (loader && !loader.classList.contains('hide') && typeof window._hideAppLoader === 'function') {
            window._hideAppLoader();
          }
        }, 500);
      });
      
      // Capturer l'événement beforeinstallprompt pour l'installation PWA
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        window.pwaInstallPrompt = e;
        console.log('[PWA] Installation disponible');
        // Afficher le bouton d'installation si nécessaire
        if (typeof window.showPWAInstallButton === 'function') {
          window.showPWAInstallButton();
        }
      });
      
      // Fonction globale pour installer la PWA
      window.installPWA = async function() {
        if (!window.pwaInstallPrompt) {
          var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          if (isIOS) {
            alert('Partager (↑) → Sur l\'écran d\'accueil → Ajouter');
          } else {
            alert('Menu (⋮) → Installer l\'application');
          }
          return false;
        }
        
        try {
          window.pwaInstallPrompt.prompt();
          const { outcome } = await window.pwaInstallPrompt.userChoice;
          console.log('[PWA] Choix utilisateur:', outcome);
          
          if (outcome === 'accepted') {
            window.pwaInstallPrompt = null;
            window.isPWAInstalled = true;
            return true;
          }
          return false;
        } catch (error) {
          console.error('[PWA] Erreur installation:', error);
          return false;
        }
      };
      
      // Détecter si l'app vient d'être installée
      window.addEventListener('appinstalled', () => {
        window.isPWAInstalled = true;
        window.pwaInstallPrompt = null;
        console.log('[PWA] Application installée avec succès!');
      });
      
      // Fonction pour mettre à jour la navigation mobile
      window.updateMobileNav = function(mode) {
        const buttons = document.querySelectorAll('.mobile-nav-bar .nav-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        
        const activeBtn = document.getElementById('mobile-nav-' + mode);
        if (activeBtn) {
          activeBtn.classList.add('active');
        }
      };
      
      // Fonction pour afficher le bouton d'installation PWA
      window.showPWAInstallButton = function() {
        const installBtn = document.getElementById('pwa-install-popup-btn');
        if (installBtn) installBtn.style.display = 'flex';
        // Afficher aussi le bloc add-to-home si en attente
        if (typeof window.showAddToHomeOverlay === 'function') window.showAddToHomeOverlay();
      };
      
      // Overlay simple "Ajouter à l'écran d'accueil" - affiché à l'ouverture sur mobile, un clic suffit
      window.showAddToHomeOverlay = function() {
        if (window.isPWAInstalled) return;
        var isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|webOS/i.test(navigator.userAgent);
        if (!isMobile) return;
        if (localStorage.getItem('addToHomeDismissed')) return;
        
        var overlay = document.getElementById('add-to-home-overlay');
        if (overlay) return;
        
        overlay = document.createElement('div');
        overlay.id = 'add-to-home-overlay';
        overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;padding:16px;background:linear-gradient(135deg,rgba(102,126,234,0.95),rgba(118,75,162,0.95));display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);-webkit-tap-highlight-color:transparent;';
        overlay.innerHTML = '<button type="button" id="add-to-home-btn" style="flex:1;padding:14px 20px;background:#fff;color:#667eea;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">📱 Ajouter à l\'écran d\'accueil</button><button type="button" id="add-to-home-skip" style="padding:10px 14px;background:transparent;color:rgba(255,255,255,0.9);border:1px solid rgba(255,255,255,0.5);border-radius:10px;font-size:13px;cursor:pointer;">Passer</button>';
        document.body.insertBefore(overlay, document.body.firstChild);
        
        document.getElementById('add-to-home-btn').onclick = function() {
          overlay.remove();
          localStorage.setItem('addToHomeDismissed', Date.now());
          if (typeof installPWA === 'function') installPWA();
        };
        document.getElementById('add-to-home-btn').ontouchend = function(e) { e.preventDefault(); this.onclick(); };
        document.getElementById('add-to-home-skip').onclick = function() {
          overlay.remove(); localStorage.setItem('addToHomeDismissed', Date.now());
        };
      };
      
      // Popup d'accueil avec option PWA
      window.showWelcomePopup = function() {
        // Ne pas afficher si déjà installée en PWA
        if (window.isPWAInstalled) return;
        
        // Ne pas afficher si déjà vue récemment
        const lastShown = localStorage.getItem('welcomePopupShown');
        const now = Date.now();
        if (lastShown && (now - parseInt(lastShown)) < 24 * 60 * 60 * 1000) {
          return; // Moins de 24h
        }
        
        const isMobile = window.innerWidth <= 768;
        
        const popup = document.createElement('div');
        popup.id = 'welcome-popup-overlay';
        popup.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;-webkit-tap-highlight-color:transparent;';
        popup.setAttribute('role', 'dialog');
        popup.setAttribute('aria-label', 'Bienvenue MapEvent');
        popup.onclick = function(e) {
          if (e.target === popup) {
            if (typeof closeWelcomePopup === 'function') closeWelcomePopup();
          }
        };
        
        popup.innerHTML = `
          <div class="welcome-popup-card" style="background:var(--ui-card-bg, #1a1a2e);border-radius:20px;padding:30px;max-width:400px;text-align:center;border:1px solid rgba(148,163,184,0.3);" onclick="event.stopPropagation();">
            <div style="font-size:48px;margin-bottom:16px;">🗺️</div>
            <h2 style="color:#fff;margin:0 0 12px;font-size:24px;">Bienvenue sur MapEvent</h2>
            <p style="color:#9ca3af;margin:0 0 20px;font-size:14px;line-height:1.5;">
              Site actif sauf abonnements et fonctions sociales à venir.
            </p>
            ${isMobile && window.pwaInstallPrompt ? `
              <button type="button" class="pwa-install-btn" style="margin-bottom:12px;display:flex;align-items:center;gap:8px;padding:14px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;width:100%;justify-content:center;-webkit-tap-highlight-color:transparent;">
                📱 Installer l'app mobile
              </button>
            ` : isMobile ? `
              <button type="button" class="pwa-install-btn" style="margin-bottom:12px;display:flex;align-items:center;gap:8px;padding:14px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;width:100%;justify-content:center;-webkit-tap-highlight-color:transparent;">
                📱 Version smartphone
              </button>
            ` : ''}
            <button type="button" id="welcome-continuer-btn" style="padding:14px 24px;min-height:48px;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;width:100%;-webkit-tap-highlight-color:transparent;">
              Continuer sur le site
            </button>
          </div>
        `;
        
        document.body.appendChild(popup);
        var continuerBtn = document.getElementById('welcome-continuer-btn');
        var pwaBtn = popup.querySelector('.pwa-install-btn');
        function doClose() { if (typeof closeWelcomePopup === 'function') closeWelcomePopup(); }
        if (continuerBtn) {
          continuerBtn.addEventListener('click', doClose);
          continuerBtn.addEventListener('touchend', function(e) { e.preventDefault(); doClose(); }, { passive: false });
        }
        if (pwaBtn) {
          pwaBtn.addEventListener('click', function() { if (typeof installPWA === 'function') installPWA().then(doClose); });
          pwaBtn.addEventListener('touchend', function(e) { e.preventDefault(); if (typeof installPWA === 'function') installPWA().then(doClose); }, { passive: false });
        }
      };
      
      window.closeWelcomePopup = function() {
        const popup = document.getElementById('welcome-popup-overlay');
        if (popup) {
          popup.remove();
        }
        localStorage.setItem('welcomePopupShown', Date.now().toString());
      };
      
      // Rappel discret (1x par semaine) pour iOS : ré-ajouter à l'écran d'accueil si le raccourci a disparu
      function showPwaRappelRaccourci() {
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (!isIOS || window.isPWAInstalled) return;
        var last = localStorage.getItem('pwaRappelRaccourciShown');
        if (last && (Date.now() - parseInt(last)) < 7 * 24 * 60 * 60 * 1000) return;
        var toast = document.createElement('div');
        toast.id = 'pwa-rappel-toast';
        toast.style.cssText = 'position:fixed;bottom:20px;left:16px;right:16px;background:rgba(30,30,50,0.95);color:#e5e7eb;padding:14px 16px;border-radius:12px;font-size:13px;z-index:99998;border:1px solid rgba(102,126,234,0.4);box-shadow:0 4px 20px rgba(0,0,0,0.3);';
        toast.innerHTML = 'Pour garder MapEvent sur votre écran : <strong>Partager</strong> → <strong>Sur l\'écran d\'accueil</strong>. <button id="pwa-rappel-ok" style="margin-left:8px;padding:6px 12px;background:#667eea;color:white;border:none;border-radius:8px;font-size:12px;cursor:pointer;">OK</button>';
        document.body.appendChild(toast);
        document.getElementById('pwa-rappel-ok').onclick = function() {
          localStorage.setItem('pwaRappelRaccourciShown', Date.now().toString());
          toast.remove();
        };
        setTimeout(function() {
          if (document.getElementById('pwa-rappel-toast')) {
            document.getElementById('pwa-rappel-toast').remove();
          }
        }, 12000);
      }
      
      // Sur mobile : afficher le bouton "Ajouter à l'écran d'accueil" dès l'ouverture
      window.addEventListener('load', function() {
        if (window.isPWAInstalled) return;
        var isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|webOS/i.test(navigator.userAgent);
        if (!isMobile) return;
        // Android : attendre beforeinstallprompt ou 500ms. iOS : afficher direct
        if (window.pwaInstallPrompt) {
          window.showAddToHomeOverlay();
        } else {
          setTimeout(function() { window.showAddToHomeOverlay(); }, 300);
        }
      });
      
      // Afficher la popup "À propos" (logo) après un court délai
      setTimeout(() => {
        if (window.isPWAInstalled) return;
        const lastShown = localStorage.getItem('welcomePopupShown');
        const now = Date.now();
        if (lastShown && (now - parseInt(lastShown)) < 24 * 60 * 60 * 1000) return;
        if (typeof window.openAboutModal === 'function') {
          window.openAboutModal();
          localStorage.setItem('welcomePopupShown', Date.now().toString());
        }
      }, 2000);
      // Rappel raccourci iOS (après la popup d'accueil)
      setTimeout(showPwaRappelRaccourci, 5000);
      
      // Compteurs totaux (affichage immédiat, fetch non bloquant)
      (function() {
        var fmt = function(n) {
          if (n >= 1000000) return (n/1e6).toFixed(1).replace(/\.0$/, '') + 'M';
          if (n >= 1000) return (n/1000).toFixed(1).replace(/\.0$/, '') + 'k';
          return String(n);
        };
        var api = (window.API_BASE_URL || 'https://ctp67u5hgni2rbfr3kp4p74kxa0gxycf.lambda-url.eu-west-1.on.aws/api');
        fetch(api + '/stats/counts', { cache: 'no-store' }).then(function(r) { return r.json(); }).then(function(d) {
          var el = document.getElementById('stats-counts-badge');
          if (el && d) {
            var parts = [];
            if (d.events != null) parts.push(fmt(d.events) + ' events');
            if (d.bookings != null) parts.push(fmt(d.bookings) + ' bookings');
            if (d.services != null) parts.push(fmt(d.services) + ' services');
            el.textContent = parts.length ? parts.join(' • ') : '—';
          }
        }).catch(function() {});
      })();
    </script>
</body>
</html>
