<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nettoyage localStorage - MapEvent</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            margin-top: 0;
            text-align: center;
        }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
        }
        .success {
            background: rgba(34, 197, 94, 0.3);
            border: 2px solid #22c55e;
        }
        .info {
            background: rgba(59, 130, 246, 0.3);
            border: 2px solid #3b82f6;
        }
        .error {
            background: rgba(239, 68, 68, 0.3);
            border: 2px solid #ef4444;
        }
        button {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px 0;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.02);
        }
        .btn-primary {
            background: #22c55e;
            color: white;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-secondary {
            background: #64748b;
            color: white;
        }
        .info-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
        }
        code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Nettoyage localStorage</h1>
        
        <div id="status" class="status info">
            ‚è≥ Analyse du localStorage en cours...
        </div>
        
        <div class="info-box">
            <strong>üìä √âtat actuel :</strong>
            <div id="storage-info"></div>
        </div>
        
        <div class="info-box" style="background: rgba(34, 197, 94, 0.2); border: 2px solid #22c55e;">
            <strong>‚úÖ DONN√âES CONSERV√âES (essentielles) :</strong>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li><code>currentUser</code> - Votre profil utilisateur (nom, email, avatar, etc.)</li>
                <li><code>cognito_tokens</code> - Tokens de connexion Google</li>
            </ul>
        </div>
        
        <div class="info-box" style="background: rgba(239, 68, 68, 0.2); border: 2px solid #ef4444;">
            <strong>üóëÔ∏è DONN√âES SUPPRIM√âES (non essentielles) :</strong>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li><code>eventsData</code> - Liste des √©v√©nements (recharg√©e automatiquement)</li>
                <li><code>bookingsData</code> - Liste des bookings (recharg√©e automatiquement)</li>
                <li><code>servicesData</code> - Liste des services (recharg√©e automatiquement)</li>
                <li><code>discussion_*</code> - Discussions (peuvent √™tre recharg√©es)</li>
                <li><code>pendingReports</code> - Rapports en attente</li>
                <li>Donn√©es volumineuses dans <code>currentUser</code> (history, photos, etc.)</li>
            </ul>
            <div style="margin-top: 10px; font-size: 13px; opacity: 0.9;">
                ‚ö†Ô∏è Ces donn√©es peuvent √™tre recharg√©es depuis le serveur si n√©cessaire.
            </div>
        </div>
        
        <button class="btn-primary" onclick="nettoyerSelectif()">
            üßπ Nettoyer les donn√©es non essentielles (S√âCURIS√â)
        </button>
        
        <button class="btn-danger" onclick="viderCompletement()">
            üóëÔ∏è Vider compl√®tement (vous serez d√©connect√©)
        </button>
        
        <button class="btn-secondary" onclick="window.location.href='/'">
            ‚Üê Retour au site
        </button>
    </div>

    <script>
        // Analyser le localStorage au chargement
        function analyserStorage() {
            const statusEl = document.getElementById('status');
            const infoEl = document.getElementById('storage-info');
            
            try {
                let total = 0;
                const keys = [];
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key) {
                        const value = localStorage.getItem(key);
                        const size = (key.length + value.length) * 2; // UTF-16 = 2 bytes par caract√®re
                        total += size;
                        keys.push({ key, size });
                    }
                }
                
                const totalMB = (total / 1024 / 1024).toFixed(2);
                const limitMB = 5; // Limite approximative du localStorage
                
                let html = `<div>Taille totale : <strong>${totalMB} MB</strong> / ~${limitMB} MB</div>`;
                html += `<div style="margin-top: 10px;"><strong>Cl√©s trouv√©es :</strong></div>`;
                html += `<ul style="margin: 5px 0; padding-left: 20px;">`;
                
                keys.sort((a, b) => b.size - a.size).forEach(item => {
                    const sizeKB = (item.size / 1024).toFixed(2);
                    html += `<li><code>${item.key}</code> : ${sizeKB} KB</li>`;
                });
                html += `</ul>`;
                
                infoEl.innerHTML = html;
                
                if (totalMB > limitMB * 0.8) {
                    statusEl.className = 'status error';
                    statusEl.textContent = `‚ö†Ô∏è localStorage presque plein (${totalMB} MB) ! Nettoyage recommand√©.`;
                } else {
                    statusEl.className = 'status success';
                    statusEl.textContent = `‚úÖ localStorage OK (${totalMB} MB utilis√©s)`;
                }
            } catch (e) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå Erreur : ${e.message}`;
            }
        }
        
        // Nettoyer s√©lectivement (garde currentUser et tokens)
        function nettoyerSelectif() {
            const statusEl = document.getElementById('status');
            statusEl.className = 'status info';
            statusEl.textContent = '‚è≥ Nettoyage en cours...';
            
            try {
                // Sauvegarder les donn√©es essentielles AVANT tout nettoyage
                const currentUser = localStorage.getItem('currentUser');
                const tokens = localStorage.getItem('cognito_tokens');
                
                console.log('‚úÖ Donn√©es essentielles sauvegard√©es :');
                console.log('  - currentUser :', currentUser ? 'pr√©sent' : 'absent');
                console.log('  - cognito_tokens :', tokens ? 'pr√©sent' : 'absent');
                
                // Supprimer UNIQUEMENT les donn√©es volumineuses non essentielles
                localStorage.removeItem('eventsData');
                localStorage.removeItem('bookingsData');
                localStorage.removeItem('servicesData');
                
                // Supprimer toutes les discussions
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k && (k.startsWith('discussion_') || k.startsWith('pendingReports'))) {
                        keysToRemove.push(k);
                    }
                }
                keysToRemove.forEach(k => localStorage.removeItem(k));
                
                // R√©duire currentUser si n√©cessaire (mais garder les donn√©es importantes)
                if (currentUser) {
                    try {
                        const userObj = JSON.parse(currentUser);
                        
                        // CONSERVER ces donn√©es importantes :
                        // - id, email, username, name, firstName, lastName
                        // - avatar, profilePhoto, avatarDescription
                        // - isLoggedIn, profileComplete, subscription, role
                        // - agenda, favorites (limit√©s √† 50 mais conserv√©s)
                        // - postalAddress
                        
                        // Supprimer UNIQUEMENT les donn√©es vraiment volumineuses :
                        delete userObj.history; // Historique (peut √™tre r√©g√©n√©r√©)
                        delete userObj.photos; // Photos (peuvent √™tre recharg√©es)
                        delete userObj.profilePhotos; // Photos de profil (gard√©es dans profilePhoto)
                        delete userObj.eventStatusHistory; // Historique des statuts
                        
                        // Limiter les tableaux volumineux mais les CONSERVER
                        if (userObj.agenda && userObj.agenda.length > 50) {
                            userObj.agenda = userObj.agenda.slice(-50); // Garder les 50 derniers
                        }
                        if (userObj.favorites && userObj.favorites.length > 50) {
                            userObj.favorites = userObj.favorites.slice(-50); // Garder les 50 derniers
                        }
                        
                        // S'assurer que les donn√©es importantes sont toujours l√†
                        const importantData = {
                            id: userObj.id,
                            email: userObj.email,
                            username: userObj.username,
                            name: userObj.name,
                            firstName: userObj.firstName,
                            lastName: userObj.lastName,
                            avatar: userObj.avatar,
                            profilePhoto: userObj.profilePhoto,
                            avatarDescription: userObj.avatarDescription,
                            isLoggedIn: userObj.isLoggedIn,
                            profileComplete: userObj.profileComplete,
                            subscription: userObj.subscription,
                            role: userObj.role,
                            postalAddress: userObj.postalAddress
                        };
                        
                        // Fusionner avec les donn√©es r√©duites
                        const cleanedUser = { ...importantData, ...userObj };
                        
                        localStorage.setItem('currentUser', JSON.stringify(cleanedUser));
                        console.log('‚úÖ currentUser nettoy√© mais donn√©es importantes conserv√©es');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erreur lors du nettoyage de currentUser, conservation de l\'original');
                        // Si erreur, garder l'original intact
                        if (currentUser) localStorage.setItem('currentUser', currentUser);
                    }
                }
                
                // V√©rifier que les donn√©es essentielles sont toujours l√†
                const checkUser = localStorage.getItem('currentUser');
                const checkTokens = localStorage.getItem('cognito_tokens');
                
                if (!checkUser && currentUser) {
                    // Restaurer si perdu
                    localStorage.setItem('currentUser', currentUser);
                    console.log('‚úÖ currentUser restaur√©');
                }
                if (!checkTokens && tokens) {
                    // Restaurer si perdu
                    localStorage.setItem('cognito_tokens', tokens);
                    console.log('‚úÖ cognito_tokens restaur√©');
                }
                
                statusEl.className = 'status success';
                statusEl.textContent = '‚úÖ Nettoyage r√©ussi ! Vos donn√©es importantes sont conserv√©es. Rechargez la page.';
                
                setTimeout(() => {
                    analyserStorage();
                }, 500);
            } catch (e) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå Erreur : ${e.message}`;
                console.error('Erreur nettoyage:', e);
            }
        }
        
        // Vider compl√®tement
        function viderCompletement() {
            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir vider compl√®tement le localStorage ?\n\nVous serez d√©connect√© et devrez vous reconnecter.')) {
                return;
            }
            
            const statusEl = document.getElementById('status');
            statusEl.className = 'status info';
            statusEl.textContent = '‚è≥ Vidage en cours...';
            
            try {
                localStorage.clear();
                statusEl.className = 'status success';
                statusEl.textContent = '‚úÖ localStorage vid√© ! Redirection dans 2 secondes...';
                
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            } catch (e) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå Erreur : ${e.message}`;
            }
        }
        
        // Analyser au chargement
        analyserStorage();
    </script>
</body>
</html>

