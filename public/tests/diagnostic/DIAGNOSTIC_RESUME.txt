// ============================================
// DIAGNOSTIC USERNAME - R√âSUM√â VISIBLE
// ============================================
// Copiez-collez ce code dans la console

(function() {
  const pendingLS = localStorage.getItem('pendingRegisterDataForGoogle');
  const currentUserLS = localStorage.getItem('currentUser');
  const pendingSS = sessionStorage.getItem('pendingRegisterDataForGoogle');
  const currentUserSS = sessionStorage.getItem('currentUser');
  const accountName = document.getElementById('account-name');
  
  let pendingLS_parsed = null;
  let currentUserLS_parsed = null;
  let pendingSS_parsed = null;
  let currentUserSS_parsed = null;
  
  try { if (pendingLS) pendingLS_parsed = JSON.parse(pendingLS); } catch(e) {}
  try { if (currentUserLS) currentUserLS_parsed = JSON.parse(currentUserLS); } catch(e) {}
  try { if (pendingSS) pendingSS_parsed = JSON.parse(pendingSS); } catch(e) {}
  try { if (currentUserSS) currentUserSS_parsed = JSON.parse(currentUserSS); } catch(e) {}
  
  // Trouver le username
  let found = false;
  let source = '';
  let value = '';
  
  if (pendingLS_parsed?.username && pendingLS_parsed.username !== 'null' && !pendingLS_parsed.username.includes('@')) {
    found = true;
    source = 'localStorage';
    value = pendingLS_parsed.username;
  } else if (pendingSS_parsed?.username && pendingSS_parsed.username !== 'null' && !pendingSS_parsed.username.includes('@')) {
    found = true;
    source = 'sessionStorage';
    value = pendingSS_parsed.username;
  } else if (window.pendingRegisterData?.username && window.pendingRegisterData.username !== 'null' && !window.pendingRegisterData.username.includes('@')) {
    found = true;
    source = 'window.pendingRegisterData';
    value = window.pendingRegisterData.username;
  } else if (window.currentUser?.username && window.currentUser.username !== 'null' && !window.currentUser.username.includes('@')) {
    found = true;
    source = 'window.currentUser';
    value = window.currentUser.username;
  }
  
  const displayed = accountName ? accountName.textContent : null;
  const displayName = typeof getUserDisplayName === 'function' && window.currentUser ? getUserDisplayName(window.currentUser) : null;
  
  // Afficher un r√©sum√© tr√®s visible
  console.log('\n\n');
  console.log('%c' + '‚ïê'.repeat(80), 'color: #00ffc3;');
  console.log('%cüîç DIAGNOSTIC USERNAME - R√âSUM√â', 'color: #00ffc3; font-size: 18px; font-weight: bold;');
  console.log('%c' + '‚ïê'.repeat(80), 'color: #00ffc3;');
  console.log('');
  
  console.log('%c1. USERNAME TROUV√â:', 'color: #3b82f6; font-weight: bold;');
  if (found) {
    console.log('   ‚úÖ OUI:', value);
    console.log('   üìç Source:', source);
  } else {
    console.log('   ‚ùå NON - Aucun username valide trouv√©');
  }
  
  console.log('');
  console.log('%c2. USERNAME AFFICH√â:', 'color: #3b82f6; font-weight: bold;');
  console.log('   üì± Dans le bloc compte:', displayed || '‚ùå NON TROUV√â');
  console.log('   üë§ getUserDisplayName():', displayName || '‚ùå NON DISPONIBLE');
  
  console.log('');
  console.log('%c3. D√âTAILS:', 'color: #3b82f6; font-weight: bold;');
  console.log('   localStorage.pendingRegisterDataForGoogle.username:', pendingLS_parsed?.username || '‚ùå MANQUANT');
  console.log('   localStorage.currentUser.username:', currentUserLS_parsed?.username || '‚ùå MANQUANT');
  console.log('   sessionStorage.pendingRegisterDataForGoogle.username:', pendingSS_parsed?.username || '‚ùå MANQUANT');
  console.log('   window.currentUser.username:', window.currentUser?.username || '‚ùå MANQUANT');
  console.log('   window.pendingRegisterData.username:', window.pendingRegisterData?.username || '‚ùå MANQUANT');
  
  console.log('');
  console.log('%c4. PROBL√àME D√âTECT√â:', 'color: #3b82f6; font-weight: bold;');
  if (found && displayed && displayed !== value) {
    console.log('   ‚ö†Ô∏è OUI - Le username trouv√© ne correspond pas √† celui affich√© !');
    console.log('      Trouv√©:', value);
    console.log('      Affich√©:', displayed);
    console.log('      getUserDisplayName():', displayName);
  } else if (found && displayed && displayed === value) {
    console.log('   ‚úÖ NON - Tout est correct');
  } else if (!found) {
    console.log('   ‚ö†Ô∏è OUI - Aucun username valide trouv√©, le syst√®me utilise probablement l\'email');
  } else {
    console.log('   ‚ùì Impossible de d√©terminer');
  }
  
  console.log('');
  console.log('%c' + '‚ïê'.repeat(80), 'color: #00ffc3;');
  console.log('%c‚úÖ Diagnostic termin√©', 'color: #22c55e; font-weight: bold;');
  console.log('%c' + '‚ïê'.repeat(80), 'color: #00ffc3;');
  console.log('\n\n');
  
  // Retourner un objet pour inspection
  return {
    found: found,
    source: source,
    value: value,
    displayed: displayed,
    displayName: displayName,
    match: found && displayed ? (displayed === value) : false,
    problem: found && displayed && displayed !== value
  };
})();
