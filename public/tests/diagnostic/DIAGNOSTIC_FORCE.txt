// ============================================
// DIAGNOSTIC USERNAME - VERSION FORCE AFFICHAGE
// ============================================
// Copiez-collez TOUT ce code dans la console (F12)

(function() {
  const results = [];
  
  // localStorage
  const pendingLS = localStorage.getItem('pendingRegisterDataForGoogle');
  const currentUserLS = localStorage.getItem('currentUser');
  
  results.push('ðŸ“¦ LOCALSTORAGE:');
  if (pendingLS) {
    try {
      const p = JSON.parse(pendingLS);
      results.push('  pendingRegisterDataForGoogle.username: ' + (p.username || 'âŒ MANQUANT'));
    } catch(e) {
      results.push('  pendingRegisterDataForGoogle: âŒ ERREUR PARSING');
    }
  } else {
    results.push('  pendingRegisterDataForGoogle: âŒ NON TROUVÃ‰');
  }
  
  if (currentUserLS) {
    try {
      const c = JSON.parse(currentUserLS);
      results.push('  currentUser.username: ' + (c.username || 'âŒ MANQUANT'));
    } catch(e) {
      results.push('  currentUser: âŒ ERREUR PARSING');
    }
  } else {
    results.push('  currentUser: âŒ NON TROUVÃ‰');
  }
  
  // sessionStorage
  const pendingSS = sessionStorage.getItem('pendingRegisterDataForGoogle');
  const currentUserSS = sessionStorage.getItem('currentUser');
  
  results.push('\nðŸ“¦ SESSIONSTORAGE:');
  if (pendingSS) {
    try {
      const p = JSON.parse(pendingSS);
      results.push('  pendingRegisterDataForGoogle.username: ' + (p.username || 'âŒ MANQUANT'));
    } catch(e) {
      results.push('  pendingRegisterDataForGoogle: âŒ ERREUR PARSING');
    }
  } else {
    results.push('  pendingRegisterDataForGoogle: âŒ NON TROUVÃ‰');
  }
  
  if (currentUserSS) {
    try {
      const c = JSON.parse(currentUserSS);
      results.push('  currentUser.username: ' + (c.username || 'âŒ MANQUANT'));
    } catch(e) {
      results.push('  currentUser: âŒ ERREUR PARSING');
    }
  } else {
    results.push('  currentUser: âŒ NON TROUVÃ‰');
  }
  
  // window.currentUser
  results.push('\nðŸŒ WINDOW.CURRENTUSER:');
  if (window.currentUser) {
    results.push('  username: ' + (window.currentUser.username || 'âŒ MANQUANT'));
    results.push('  email: ' + (window.currentUser.email || 'âŒ MANQUANT'));
    const isValid = window.currentUser.username && 
                    window.currentUser.username !== 'null' && 
                    window.currentUser.username !== '' &&
                    !window.currentUser.username.includes('@');
    results.push('  isValid: ' + (isValid ? 'âœ…' : 'âŒ'));
  } else {
    results.push('  âŒ N\'EXISTE PAS');
  }
  
  // window.pendingRegisterData
  results.push('\nðŸŒ WINDOW.PENDINGREGISTERDATA:');
  if (window.pendingRegisterData) {
    results.push('  username: ' + (window.pendingRegisterData.username || 'âŒ MANQUANT'));
  } else {
    results.push('  âŒ N\'EXISTE PAS');
  }
  
  // getUserDisplayName
  results.push('\nðŸ‘¤ GETUSERDISPLAYNAME:');
  if (typeof getUserDisplayName === 'function' && window.currentUser) {
    const displayName = getUserDisplayName(window.currentUser);
    results.push('  RÃ©sultat: ' + displayName);
  } else {
    results.push('  âŒ FONCTION NON DISPONIBLE');
  }
  
  // Bloc compte
  results.push('\nðŸ“± BLOC COMPTE:');
  const accountName = document.getElementById('account-name');
  if (accountName) {
    results.push('  Texte affichÃ©: ' + accountName.textContent);
  } else {
    results.push('  âŒ Ã‰LÃ‰MENT NON TROUVÃ‰');
  }
  
  // RÃ©sumÃ©
  results.push('\nðŸ“Š RÃ‰SUMÃ‰:');
  let found = false;
  let source = '';
  let value = '';
  
  if (pendingLS) {
    try {
      const p = JSON.parse(pendingLS);
      if (p.username && p.username !== 'null' && p.username !== '' && !p.username.includes('@')) {
        found = true;
        source = 'localStorage';
        value = p.username;
      }
    } catch(e) {}
  }
  
  if (!found && pendingSS) {
    try {
      const p = JSON.parse(pendingSS);
      if (p.username && p.username !== 'null' && p.username !== '' && !p.username.includes('@')) {
        found = true;
        source = 'sessionStorage';
        value = p.username;
      }
    } catch(e) {}
  }
  
  if (!found && window.pendingRegisterData) {
    if (window.pendingRegisterData.username && 
        window.pendingRegisterData.username !== 'null' && 
        window.pendingRegisterData.username !== '' &&
        !window.pendingRegisterData.username.includes('@')) {
      found = true;
      source = 'window.pendingRegisterData';
      value = window.pendingRegisterData.username;
    }
  }
  
  if (!found && window.currentUser) {
    if (window.currentUser.username && 
        window.currentUser.username !== 'null' && 
        window.currentUser.username !== '' &&
        !window.currentUser.username.includes('@')) {
      found = true;
      source = 'window.currentUser';
      value = window.currentUser.username;
    }
  }
  
  if (found) {
    results.push('  âœ… Username trouvÃ©: ' + value + ' dans ' + source);
  } else {
    results.push('  âŒ Aucun username valide trouvÃ©');
  }
  
  if (accountName) {
    results.push('  ðŸ“± AffichÃ©: ' + accountName.textContent);
  }
  
  // Afficher tout d'un coup
  console.log('%cðŸ” DIAGNOSTIC USERNAME', 'color: #00ffc3; font-size: 16px; font-weight: bold;');
  console.log('='.repeat(80));
  results.forEach(r => console.log(r));
  console.log('='.repeat(80));
  console.log('%câœ… Diagnostic terminÃ©', 'color: #22c55e; font-weight: bold;');
  
  // Retourner un objet pour inspection
  return {
    pendingLS: pendingLS ? JSON.parse(pendingLS) : null,
    currentUserLS: currentUserLS ? JSON.parse(currentUserLS) : null,
    pendingSS: pendingSS ? JSON.parse(pendingSS) : null,
    currentUserSS: currentUserSS ? JSON.parse(currentUserSS) : null,
    windowCurrentUser: window.currentUser,
    windowPendingRegisterData: window.pendingRegisterData,
    accountName: accountName ? accountName.textContent : null,
    getUserDisplayName: typeof getUserDisplayName === 'function' && window.currentUser ? getUserDisplayName(window.currentUser) : null,
    found: found,
    source: source,
    value: value
  };
})();
