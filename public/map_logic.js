// ===============================
// BUILD ID - V√©rification d√©ploiement
// ===============================
console.log("BUILD_ID", "mes-annonces-v2", new Date().toISOString(), location.href);

// Signal au loader HTML que le JS est bien charg√©
window._hideAppLoader = function() {
  var loader = document.getElementById('app-loader');
  if (loader && !loader.classList.contains('hide')) {
    loader.classList.add('hide');
    setTimeout(function(){ if(loader.parentNode) loader.parentNode.removeChild(loader); }, 500);
  }
};
// Masquer le loader d√®s que le DOM est pr√™t
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() { window._hideAppLoader(); });
} else {
  window._hideAppLoader();
}

// ===============================
// PROTECTION LOCALSTORAGE MINIMALE
// ===============================
// Bloque SEULEMENT currentUser (cause du quota), garde tout le reste
(function() {
  'use strict';
  if (window.__storageProtected) return; // D√©j√† fait dans auth.js
  window.__storageProtected = true;
  
  // Supprimer UNIQUEMENT currentUser
  try { localStorage.removeItem('currentUser'); } catch(e) {}
  
  // Surcharger setItem pour bloquer UNIQUEMENT currentUser
  const originalSetItem = localStorage.setItem.bind(localStorage);
  localStorage.setItem = function(key, value) {
    if (key === 'currentUser') return; // Bloqu√©
    try {
      originalSetItem(key, value);
    } catch(e) {
      try { localStorage.removeItem('currentUser'); } catch(e2) {}
      try { originalSetItem(key, value); } catch(e3) {}
    }
  };
  
  console.log('[STORAGE] Protection currentUser activ√©e');
})();

// ===============================
// GESTION D'ERREURS GLOBALE - Silencieuse (logs uniquement)
// ===============================
window.addEventListener('error', function(e) {
  // Ignorer les erreurs des extensions navigateur
  const filename = e.filename || '';
  if (filename.includes('content.js') || 
      filename.includes('chrome-extension://') || 
      filename.includes('moz-extension://') ||
      filename.includes('safari-extension://')) {
    return; // Ignorer silencieusement les erreurs des extensions
  }
  
  // Logger l'erreur dans la console (pas d'overlay intrusif)
  console.warn('[MAP] Erreur JS:', e.message, '- Fichier:', filename, 'Ligne:', e.lineno);
});

window.addEventListener('unhandledrejection', function(e) {
  // Logger uniquement, pas d'alerte intrusive
  console.warn('[MAP] Promise rejection:', e.reason?.message || e.reason);
});

// ===============================
// CONFIGURATION API - Lambda Function URL
// ===============================
// NOTE: API_BASE_URL est d√©clar√©e dans auth.js et expos√©e via window.API_BASE_URL
// Utiliser la variable globale si elle existe, sinon la d√©finir
if (typeof window.API_BASE_URL === 'undefined') {
  window.API_BASE_URL = "https://ctp67u5hgni2rbfr3kp4p74kxa0gxycf.lambda-url.eu-west-1.on.aws/api";
}
// Ne pas cr√©er de r√©f√©rence locale pour √©viter conflit avec const dans auth.js
// Toutes les r√©f√©rences √† API_BASE_URL dans ce fichier utilisent window.API_BASE_URL

// ===============================
// COGNITO AUTH (Google) - PKCE SPA
// ===============================
// NOTE: COGNITO est d√©clar√© dans auth.js et expos√© via window.COGNITO
// V√©rifier qu'il existe, sinon le d√©finir
if (typeof window.COGNITO === 'undefined') {
  window.COGNITO = {
    domain: "https://eu-west-19o9j6xsdr.auth.eu-west-1.amazoncognito.com",
    clientId: "63rm6h0m26q41lotbho6704dod",
    redirectUri: "https://mapevent.world/",
    scopes: ["openid", "email", "profile"],
  };
}
// Toutes les r√©f√©rences √† COGNITO dans ce fichier utilisent window.COGNITO

// NOTE: Les fonctions base64UrlEncode, randomString, sha256, pkceChallengeFromVerifier
// sont d√©finies dans auth.js et sont accessibles globalement
// Si elles ne sont pas disponibles, les d√©finir ici comme fallback
if (typeof base64UrlEncode === 'undefined') {
  function base64UrlEncode(arrayBuffer) {
    const bytes = new Uint8Array(arrayBuffer);
    let binary = "";
    bytes.forEach((b) => (binary += String.fromCharCode(b)));
    return btoa(binary).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
  }
}

if (typeof randomString === 'undefined') {
  function randomString(len = 64) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
    const rnd = new Uint8Array(len);
    crypto.getRandomValues(rnd);
    return Array.from(rnd).map((val) => chars[val % chars.length]).join("");
  }
}

if (typeof sha256 === 'undefined') {
  async function sha256(str) {
    const data = new TextEncoder().encode(str);
    return crypto.subtle.digest("SHA-256", data);
  }
}

if (typeof pkceChallengeFromVerifier === 'undefined') {
  async function pkceChallengeFromVerifier(verifier) {
    const digest = await sha256(verifier);
    return base64UrlEncode(digest);
  }
}

function authSave(key, val) {
  sessionStorage.setItem(key, val);
}
function authLoad(key) {
  return sessionStorage.getItem(key);
}
function authClearTemp() {
  ["pkce_verifier", "oauth_state"].forEach((k) => sessionStorage.removeItem(k));
}

// Fonction utilitaire pour sauvegarder avec gestion de quota localStorage
// PRIORITY HOTFIX: Fonction pour sauvegarder uniquement les champs essentiels de l'utilisateur
function saveUserSlim(userObj) {
  if (!userObj) return null;
  
  // NE JAMAIS stocker l'objet user complet - seulement les champs essentiels
  const slimUser = {
    id: userObj.id || null,
    email: userObj.email || '',
    username: userObj.username || '',
    profileComplete: userObj.profileComplete || false,
    profile_photo_url: userObj.profile_photo_url || userObj.profilePhoto || null,
    role: userObj.role || 'user',
    subscription: userObj.subscription || 'free',
    hasPassword: userObj.hasPassword || false,
    hasPostalAddress: userObj.hasPostalAddress || false,
    // Token si n√©cessaire (pour refresh)
    accessToken: userObj.accessToken || null,
    refreshToken: userObj.refreshToken || null
  };
  
  // Taille estim√©e (approximative)
  const slimSize = JSON.stringify(slimUser).length;
  console.log(`[SAVE USER SLIM] Taille: ${(slimSize / 1024).toFixed(2)}KB (vs ${userObj ? JSON.stringify(userObj).length / 1024 : 0}KB original)`);
  
  return slimUser;
}

// Fonction pour mettre √† jour l'UI "logged-in" (remplace le bloc "Connexion" par "Compte")
function updateAuthUI(slimUser) {
  if (!slimUser || !slimUser.id) {
    console.warn('[UPDATE AUTH UI] slimUser invalide');
    return;
  }
  
  console.log('[UPDATE AUTH UI] Mise √† jour UI avec slimUser:', { id: slimUser.id, email: slimUser.email, username: slimUser.username });
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Pr√©server toutes les propri√©t√©s n√©cessaires de currentUser
  // S'assurer que currentUser a toutes les propri√©t√©s n√©cessaires pour les popups
  if (!currentUser || typeof currentUser !== 'object') {
    // Si currentUser n'existe pas, utiliser getDefaultUser pour l'initialiser
    if (typeof getDefaultUser === 'function') {
      currentUser = getDefaultUser();
    } else {
      // Fallback : initialiser manuellement les propri√©t√©s n√©cessaires
      currentUser = {
        isLoggedIn: false,
        favorites: [],
        agenda: [],
        likes: [],
        participating: [],
        subscription: 'free'
      };
    }
  }
  
  // S'assurer que toutes les propri√©t√©s n√©cessaires existent
  if (!Array.isArray(currentUser.favorites)) {
    currentUser.favorites = [];
  }
  if (!Array.isArray(currentUser.agenda)) {
    currentUser.agenda = [];
  }
  if (!Array.isArray(currentUser.likes)) {
    currentUser.likes = [];
  }
  if (!Array.isArray(currentUser.participating)) {
    currentUser.participating = [];
  }
  if (!currentUser.subscription) {
    currentUser.subscription = 'free';
  }
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que reviews est un objet (pas undefined)
  if (!currentUser.reviews || typeof currentUser.reviews !== 'object') {
    currentUser.reviews = {};
  }
  
  // Mettre √† jour currentUser global en pr√©servant toutes les propri√©t√©s existantes
  currentUser = {
    ...currentUser, // Pr√©server toutes les propri√©t√©s existantes (favorites, agenda, likes, etc.)
    ...slimUser,    // Ajouter les nouvelles donn√©es slim
    isLoggedIn: true
  };
  
  // Exposer globalement pour fallback
  window.currentUser = currentUser;
  
  // Mettre √† jour les boutons auth
  if (typeof updateAuthButtons === 'function') {
    updateAuthButtons();
  }
  
  // Mettre √† jour le bloc compte
  if (typeof updateAccountBlockLegitimately === 'function') {
    updateAccountBlockLegitimately();
  }
  
  console.log('[UPDATE AUTH UI] UI mise √† jour - bouton "Connexion" ‚Üí "Compte"');
}

// Fonction pour r√©cup√©rer le token d'authentification
// V√©rifie localStorage si "Rester connect√©" est coch√©, sinon sessionStorage
// Cherche aussi dans cognito_tokens si le token direct n'existe pas
function getAuthToken() {
  // V√©rifier si "Rester connect√©" est activ√©
  const rememberMe = localStorage.getItem('rememberMe') === 'true';
  
  // 1. Chercher directement dans localStorage/sessionStorage
  let token = rememberMe 
    ? localStorage.getItem('accessToken') 
    : sessionStorage.getItem('accessToken');
  
  // 2. Si pas trouv√©, chercher dans cognito_tokens
  if (!token) {
    try {
      const cognitoTokens = localStorage.getItem('cognito_tokens');
      if (cognitoTokens) {
        const parsed = JSON.parse(cognitoTokens);
        token = parsed.access_token || parsed.accessToken || null;
      }
    } catch (e) {
      console.warn('[AUTH] Erreur parsing cognito_tokens:', e);
    }
  }
  
  // 3. Fallback sur currentUser
  if (!token) {
    token = currentUser?.accessToken || currentUser?.access_token || null;
  }
  
  return token;
}

// Fonction pour r√©cup√©rer le refresh token
function getRefreshToken() {
  const rememberMe = localStorage.getItem('rememberMe') === 'true';
  
  if (rememberMe) {
    return localStorage.getItem('refreshToken') || currentUser?.refreshToken || null;
  } else {
    return sessionStorage.getItem('refreshToken') || currentUser?.refreshToken || null;
  }
}

// Exposer les fonctions globalement
window.getAuthToken = getAuthToken;
window.getRefreshToken = getRefreshToken;

// Helpers pour stockage avec fallback localStorage -> sessionStorage -> m√©moire
function safeSetJSON(key, value) {
  const s = JSON.stringify(value);
  try {
    localStorage.setItem(key, s);
    return "localStorage";
  } catch (e) {
    try {
      sessionStorage.setItem(key, s);
      return "sessionStorage";
    } catch (e2) {
      window.__MEMORY_STORE__ = window.__MEMORY_STORE__ || {};
      window.__MEMORY_STORE__[key] = value;
      return "memory";
    }
  }
}

function safeGetJSON(key) {
  try {
    const v = localStorage.getItem(key);
    if (v) return JSON.parse(v);
  } catch {}
  try {
    const v = sessionStorage.getItem(key);
    if (v) return JSON.parse(v);
  } catch {}
  if (window.__MEMORY_STORE__ && window.__MEMORY_STORE__[key]) return window.__MEMORY_STORE__[key];
  return null;
}

function clearAuthStorage() {
  try { localStorage.removeItem("currentUser"); } catch {}
  try { sessionStorage.removeItem("currentUser"); } catch {}
  if (window.__MEMORY_STORE__) delete window.__MEMORY_STORE__["currentUser"];
}

function safeSetItem(key, value) {
  try {
    localStorage.setItem(key, value);
    return true;
  } catch (e) {
    if (e.name === 'QuotaExceededError' || e.message.includes('quota')) {
      console.warn(`‚ö†Ô∏è localStorage plein (quota exceeded) pour ${key}...`);
      
      // PRIORITY HOTFIX: Si c'est currentUser, nettoyer la cl√© et continuer (ne pas freeze UI)
      if (key === 'currentUser') {
        try {
          // Supprimer l'ancien currentUser pour lib√©rer de l'espace
          localStorage.removeItem('currentUser');
          console.warn('‚ö†Ô∏è currentUser supprim√© pour lib√©rer de l\'espace');
          
          // Si value est un objet user, essayer de sauvegarder la version slim
          try {
            const userObj = typeof value === 'string' ? JSON.parse(value) : value;
            const slimUser = saveUserSlim(userObj);
            if (slimUser) {
              // ‚ö†Ô∏è OPTIMISATION : Exclure photoData avant sauvegarde
              const userForStorage = (typeof window.removePhotoDataForStorage === 'function') 
                ? window.removePhotoDataForStorage(slimUser) 
                : slimUser;
              const slimJson = JSON.stringify(userForStorage);
              localStorage.setItem('currentUser', slimJson);
              console.log('‚úÖ Version slim de currentUser sauvegard√©e (photoData exclu)');
              return true;
            }
          } catch (parseError) {
            console.warn('‚ö†Ô∏è Impossible de parser/sauvegarder version slim:', parseError);
          }
          
          // Continuer le flow m√™me si on ne peut pas sauvegarder
          console.warn('‚ö†Ô∏è Continuation du flow sans sauvegarder currentUser (quota exceeded)');
          return false; // Indiquer que la sauvegarde a √©chou√© mais continuer
        } catch (cleanError) {
          console.error('‚ùå Erreur lors du nettoyage currentUser:', cleanError);
          // Continuer quand m√™me
          return false;
        }
      }
      
      // Pour les autres cl√©s, nettoyage ULTRA-AGRESSIF
      try {
        // Supprimer toutes les cl√©s sauf celles qu'on veut garder
        const keysToKeep = ['cognito_tokens']; // On va tout supprimer sauf √ßa
        const allKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          if (k && !keysToKeep.includes(k)) {
            allKeys.push(k);
          }
        }
        
        // Supprimer toutes les cl√©s non critiques
        allKeys.forEach(k => {
          try {
            localStorage.removeItem(k);
          } catch (err) {
            // Ignorer les erreurs de suppression individuelle
          }
        });
        
        // √âTAPE 3: Si c'est currentUser, cr√©er une version MINIMALE
        if (key === 'currentUser') {
          try {
            const userObj = JSON.parse(value);
            // GARDER UNIQUEMENT les champs absolument essentiels
            const minimalUser = {
              id: userObj.id || null,
              email: userObj.email || '',
              username: userObj.username || '',
              name: userObj.name || '',
              firstName: userObj.firstName || '',
              lastName: userObj.lastName || '',
              avatar: userObj.avatar || 'üë§',
              profilePhoto: userObj.profilePhoto || null,
              avatarDescription: userObj.avatarDescription || '',
              isLoggedIn: userObj.isLoggedIn || false,
              profileComplete: userObj.profileComplete || false,
              subscription: userObj.subscription || 'free',
              role: userObj.role || 'user',
              postalAddress: userObj.postalAddress || '',
              provider: userObj.provider || null,
              googleValidated: userObj.googleValidated || false,
              // Initialiser les tableaux vides (pas de donn√©es)
              agenda: [],
              favorites: [],
              likes: [],
              participating: [],
              alerts: [],
              statusAlerts: [],
              proximityAlerts: [],
              eventAlarms: [],
              reviews: {},
              addresses: [],
              friends: [],
              friendRequests: [],
              sentRequests: [],
              blockedUsers: [],
              conversations: [],
              groups: [],
              profileLinks: [],
              history: [],
              photos: [],
              profilePhotos: [],
              eventStatusHistory: {},
              smsNotifications: 0,
              smsLimit: 0,
              emailNotifications: 0,
              notificationPreferences: { email: true, sms: false },
              privacySettings: {
                showName: true,
                showAvatar: true,
                showBio: true,
                showEmail: false,
                showAddresses: false,
                showFavorites: true,
                showAgenda: true,
                showParticipating: true,
                showFriends: true,
                showActivity: true
              },
              lastSeen: new Date().toISOString()
            };
            value = JSON.stringify(minimalUser);
            console.log(`‚úÖ currentUser r√©duit √† la version minimale (${value.length} caract√®res)`);
          } catch (parseError) {
            console.warn('‚ö†Ô∏è Impossible de parser currentUser, utilisation de la valeur originale r√©duite');
            // Cr√©er un objet minimal m√™me si le parsing √©choue
            value = JSON.stringify({
              id: null,
              email: '',
              username: '',
              name: '',
              isLoggedIn: false,
              profileComplete: false,
              subscription: 'free',
              role: 'user'
            });
          }
        }
        
        // √âTAPE 4: Restaurer les tokens si n√©cessaire
        if (criticalData.tokens && !localStorage.getItem('cognito_tokens')) {
          try {
            localStorage.setItem('cognito_tokens', criticalData.tokens);
          } catch (tokenError) {
            console.warn('‚ö†Ô∏è Impossible de restaurer les tokens:', tokenError);
          }
        }
        
        // √âTAPE 5: Essayer de sauvegarder la nouvelle valeur
        try {
          localStorage.setItem(key, value);
          console.log(`‚úÖ ${key} sauvegard√© apr√®s nettoyage ultra-agressif`);
          
          // Restaurer l'ancien currentUser si on vient de sauvegarder autre chose
          if (key !== 'currentUser' && criticalData.existingUser) {
            try {
              // Essayer de restaurer l'ancien currentUser apr√®s avoir sauvegard√© la nouvelle cl√©
              const existingUserObj = JSON.parse(criticalData.existingUser);
              const minimalExistingUser = {
                id: existingUserObj.id || null,
                email: existingUserObj.email || '',
                username: existingUserObj.username || '',
                name: existingUserObj.name || '',
                firstName: existingUserObj.firstName || '',
                lastName: existingUserObj.lastName || '',
                avatar: existingUserObj.avatar || 'üë§',
                profilePhoto: existingUserObj.profilePhoto || null,
                isLoggedIn: existingUserObj.isLoggedIn || false,
                profileComplete: existingUserObj.profileComplete || false,
                subscription: existingUserObj.subscription || 'free',
                role: existingUserObj.role || 'user',
                postalAddress: existingUserObj.postalAddress || '',
                provider: existingUserObj.provider || null
              };
              // ‚ö†Ô∏è OPTIMISATION : Exclure photoData avant sauvegarde
              const userForStorage = (typeof window.removePhotoDataForStorage === 'function') 
                ? window.removePhotoDataForStorage(minimalExistingUser) 
                : minimalExistingUser;
              localStorage.setItem('currentUser', JSON.stringify(userForStorage));
            } catch (restoreError) {
              console.warn('‚ö†Ô∏è Impossible de restaurer currentUser:', restoreError);
            }
          }
          
          if (typeof showNotification === 'function') {
            showNotification('‚úÖ Stockage nettoy√©. Vos donn√©es essentielles sont conserv√©es.', 'success');
          }
          return true;
        } catch (e2) {
          console.error(`‚ùå Impossible de sauvegarder ${key} m√™me apr√®s nettoyage ultra-agressif:`, e2);
          
          // DERNI√àRE TENTATIVE : Vider compl√®tement et ne garder QUE les tokens
          try {
            const tokens = criticalData.tokens;
            localStorage.clear();
            if (tokens) {
              localStorage.setItem('cognito_tokens', tokens);
            }
            
            // Essayer de sauvegarder la version minimale
            if (key === 'currentUser') {
              localStorage.setItem(key, value);
              console.log(`‚úÖ localStorage vid√© compl√®tement, ${key} sauvegard√© (version minimale)`);
            } else {
              // Pour les autres cl√©s, essayer quand m√™me
              localStorage.setItem(key, value);
            }
            
            if (typeof showNotification === 'function') {
              showNotification('‚ö†Ô∏è Stockage local vid√©. Vos donn√©es sont sauvegard√©es sur le serveur.', 'warning');
            }
            return true;
          } catch (e3) {
            console.error(`‚ùå √âCHEC TOTAL pour ${key}:`, e3);
            if (typeof showNotification === 'function') {
              showNotification('‚ö†Ô∏è Impossible de sauvegarder localement. Vos donn√©es sont sur le serveur.', 'warning');
            }
            return false;
          }
        }
      } catch (cleanupError) {
        console.error(`‚ùå Erreur lors du nettoyage:`, cleanupError);
        return false;
      }
    } else {
      // Erreur non li√©e au quota
      console.error(`‚ùå Erreur lors de la sauvegarde de ${key}:`, e);
      return false;
    }
  }
}

function saveSession(tokens) {
  safeSetItem("cognito_tokens", JSON.stringify(tokens));
}
function loadSession() {
  const raw = localStorage.getItem("cognito_tokens");
  return raw ? JSON.parse(raw) : null;
}
function clearSession() {
  localStorage.removeItem("cognito_tokens");
}

function decodeJwtPayload(token) {
  const payload = token.split(".")[1];
  const pad = payload.length % 4 === 0 ? "" : "=".repeat(4 - (payload.length % 4));
  const b64 = (payload + pad).replace(/-/g, "+").replace(/_/g, "/");
  const json = atob(b64);
  return JSON.parse(json);
}

// 1) Lance login Google (Hosted UI Cognito)
// Verrou anti double-submit pour connexion Google
// NOTE: isGoogleLoginInProgress est d√©clar√©e dans auth.js et expos√©e via window.isGoogleLoginInProgress

async function startGoogleLogin() {
  // GUARD: √âviter double-clic et double flow concurrent
  if (window.isGoogleLoginInProgress) {
    console.warn('‚ö†Ô∏è Connexion Google d√©j√† en cours - double clic ignor√©');
    return;
  }
  
  window.isGoogleLoginInProgress = true;
  
  try {
    const verifier = randomString(80);
    const challenge = await pkceChallengeFromVerifier(verifier);
    const state = randomString(24);

    authSave("pkce_verifier", verifier);
    authSave("oauth_state", state);

    // ‚ö†Ô∏è COMPORTEMENT PRO : prompt=select_account pour TOUJOURS afficher le choix du compte Google
    // Cela permet √† l'utilisateur de choisir quel compte utiliser √† chaque connexion
    const authorizeUrl =
      `${window.COGNITO.domain}/oauth2/authorize` +
      `?client_id=${encodeURIComponent(window.COGNITO.clientId)}` +
      `&response_type=code` +
      `&scope=${encodeURIComponent(window.COGNITO.scopes.join(" "))}` +
      `&redirect_uri=${encodeURIComponent(window.COGNITO.redirectUri)}` +
      `&state=${encodeURIComponent(state)}` +
      `&code_challenge=${encodeURIComponent(challenge)}` +
      `&code_challenge_method=S256` +
      `&identity_provider=Google` +
      `&prompt=select_account`;

    console.log('[GOOGLE LOGIN] URL avec s√©lection de compte forc√©e');
    window.location.assign(authorizeUrl);
    // Note: isGoogleLoginInProgress sera r√©initialis√© au retour du callback
  } catch (error) {
    console.error('‚ùå Erreur startGoogleLogin:', error);
    window.isGoogleLoginInProgress = false;
    showNotification('‚ùå Erreur lors de la connexion Google', 'error');
  }
}

// 2) Traite le retour Cognito: https://mapevent.world/?code=...&state=...
async function handleCognitoCallbackIfPresent() {
  // GUARD ROBUSTE: √âviter double traitement du callback
  if (window._oauthCallbackProcessed) {
    console.warn('‚ö†Ô∏è Callback OAuth D√âJ√Ä TRAIT√â - Ignor√©');
    return;
  }
  
  if (window.isGoogleLoginInProgress && window.location.search.includes('code=')) {
    console.warn('‚ö†Ô∏è Callback OAuth EN COURS de traitement - Ignor√©');
    return;
  }
  
  // Marquer comme trait√© IMM√âDIATEMENT pour √©viter tout double appel
  window._oauthCallbackProcessed = true;
  
  console.log('üîç handleCognitoCallbackIfPresent appel√©', {
    url: window.location.href,
    hasCode: !!new URL(window.location.href).searchParams.get("code"),
    hasState: !!new URL(window.location.href).searchParams.get("state"),
    hasError: !!new URL(window.location.href).searchParams.get("error")
  });
  
  const url = new URL(window.location.href);
  const code = url.searchParams.get("code");
  const state = url.searchParams.get("state");
  const error = url.searchParams.get("error");

  console.log('üìã Param√®tres OAuth:', { code: !!code, state: !!state, error });

  if (error) {
    console.error('‚ùå Erreur OAuth:', error);
    showNotification("‚ùå Erreur login: " + error, "error");
    window._oauthCallbackProcessed = false;
    window.isGoogleLoginInProgress = false;
    return;
  }
  if (!code) {
    console.log('‚ÑπÔ∏è Pas de code OAuth dans l\'URL - pas un callback');
    window._oauthCallbackProcessed = false;
    window.isGoogleLoginInProgress = false;
    return;
  }

  console.log('‚úÖ Code OAuth d√©tect√© - Traitement du callback...');

  const expectedState = authLoad("oauth_state");
  if (!state || state !== expectedState) {
    console.warn('‚ùå State OAuth invalide ou manquant (redirection mobile ?). R√©essayez.');
    showNotification("‚ùå Connexion expir√©e. R√©essayez en cliquant sur Connexion Google.", "error");
    window._oauthCallbackProcessed = false;
    return;
  }

  const verifier = authLoad("pkce_verifier");
  if (!verifier) {
    console.warn('‚ùå PKCE verifier manquant (redirection smartphone ?). R√©essayez.');
    showNotification("‚ùå Connexion expir√©e. R√©essayez en cliquant sur Connexion Google.", "error");
    window._oauthCallbackProcessed = false;
    return;
  }

  const body = new URLSearchParams({
    grant_type: "authorization_code",
    client_id: window.COGNITO.clientId,
    code,
    redirect_uri: window.COGNITO.redirectUri,
    code_verifier: verifier,
  });

  const tokenRes = await fetch(`${window.COGNITO.domain}/oauth2/token`, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body.toString(),
  });

  if (!tokenRes.ok) {
    const txt = await tokenRes.text();
    console.warn("Token error:", txt);
    showNotification("‚ùå Impossible d‚Äô√©changer le code (token).", "error");
    return;
  }

  const tokens = await tokenRes.json();
  saveSession(tokens);
  authClearTemp();

  // Nettoyer l‚ÄôURL (enlever ?code=...&state=...)
  url.searchParams.delete("code");
  url.searchParams.delete("state");
  url.searchParams.delete("session_state");
  window.history.replaceState({}, document.title, url.toString());
  try {
    if (typeof closeAuthModal === 'function') closeAuthModal();
    if (typeof closePublishModal === 'function') closePublishModal();
    var b = document.getElementById('publish-modal-backdrop');
    if (b) { b.style.display = 'none'; b.style.visibility = 'hidden'; }
    if (window.focus) window.focus();
  } catch (e) {}

  // Construire un user "MapEvent"
  try {
    const payload = decodeJwtPayload(tokens.id_token);
    
    // LOGS CRITIQUES pour d√©boguer la photo
    console.log('[PHOTO] Payload JWT Cognito:', {
      email: payload.email,
      name: payload.name,
      picture: payload.picture ? payload.picture.substring(0, 100) + '...' : 'ABSENTE',
      sub: payload.sub,
      allKeys: Object.keys(payload)
    });
    
    if (!payload.picture) {
      console.warn('[WARNING] payload.picture est ABSENT du token JWT Cognito!');
      console.log('[INFO] Toutes les cles du payload:', Object.keys(payload));
    }
    
    // Initialiser currentUser avec toutes les propri√©t√©s n√©cessaires
    currentUser = {
      isLoggedIn: true,
      provider: "google",
      email: payload.email || "",
      name: payload.name || payload.email || "Utilisateur",
      avatar: payload.picture || "üë§",
      lastLoginAt: new Date().toISOString(),
      sub: payload.sub,
      // Propri√©t√©s n√©cessaires pour √©viter les erreurs undefined
      likes: [],
      agenda: [],
      participating: [],
      favorites: [],
      friendRequests: [],
      eventStatusHistory: {},
      profileComplete: false, // Flag pour savoir si le profil est complet
      username: null,
      profilePhoto: payload.picture || null,
      profile_photo_url: payload.picture || null, // Ajouter aussi profile_photo_url
      postalAddress: null,
      password: null
    };
    
    // PRIORITY HOTFIX: Ne jamais stocker l'objet user complet
    const slimUser = saveUserSlim(currentUser);
    if (slimUser) {
      safeSetItem("currentUser", JSON.stringify(slimUser));
    }
    
    // Mettre √† jour le bloc compte temporairement avec la photo Google
    setTimeout(() => {
      if (typeof window.updateAccountBlock === 'function') {
        window.updateAccountBlock();
      }
    }, 100);
    
    // Essayer de synchroniser avec le backend
    console.log('[OAUTH] Cognito callback - Synchronisation avec backend...', {
      email: currentUser.email,
      name: currentUser.name,
      sub: currentUser.sub,
      picture: payload.picture ? payload.picture.substring(0, 50) + '...' : 'NULL'
    });
    
    try {
      // Utiliser window.API_BASE_URL (d√©finie dans auth.js)
      const requestBody = {
        email: currentUser.email,
        name: currentUser.name,
        sub: currentUser.sub,
        picture: payload.picture || null
      };
      
      console.log('[OAUTH] Envoi requete OAuth Google au backend:', {
        email: requestBody.email,
        name: requestBody.name,
        picture: requestBody.picture ? requestBody.picture.substring(0, 50) + '...' : 'NULL'
      });
      
      // API_BASE_URL contient d√©j√† '/api', donc pas besoin de l'ajouter √† nouveau
      const syncResponse = await fetch(`${window.API_BASE_URL}/user/oauth/google`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${tokens.id_token}`
        },
        body: JSON.stringify(requestBody)
      });
      
      if (syncResponse.ok) {
        const syncData = await syncResponse.json();
        console.log('[OK] Synchronisation backend reussie:', {
          ok: syncData.ok,
          isNewUser: syncData.isNewUser,
          profileComplete: syncData.profileComplete,
          userProfilePhoto: syncData.user?.profile_photo_url ? syncData.user.profile_photo_url.substring(0, 50) + '...' : 'VIDE',
          hasAccessToken: !!syncData.accessToken,
          hasRefreshToken: !!syncData.refreshToken
        });
        
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE FIX 401 : Sauvegarder les tokens MapEvent retourn√©s par le backend
        // Ces tokens JWT sont n√©cessaires pour tous les appels API authentifi√©s (/api/user/events, etc.)
        // Sans cette sauvegarde, le frontend utilise les tokens Cognito (invalides pour notre backend)
        if (syncData.accessToken && syncData.refreshToken) {
          const tokensMapEvent = {
            access_token: syncData.accessToken,
            refresh_token: syncData.refreshToken
          };
          saveSession(tokensMapEvent);
          console.log('[OAUTH] ‚úÖ Tokens MapEvent sauvegard√©s - Fix erreur 401 pour /api/user/events');
          
          // Sauvegarder aussi directement dans localStorage/sessionStorage pour getAuthToken()
          const rememberMe = localStorage.getItem('rememberMe') === 'true';
          if (rememberMe) {
            localStorage.setItem('accessToken', syncData.accessToken);
            localStorage.setItem('refreshToken', syncData.refreshToken);
          } else {
            sessionStorage.setItem('accessToken', syncData.accessToken);
            sessionStorage.setItem('refreshToken', syncData.refreshToken);
          }
          console.log('[OAUTH] ‚úÖ Tokens MapEvent aussi sauvegard√©s dans accessToken direct');
        } else {
          console.warn('[OAUTH] ‚ö†Ô∏è Pas de tokens MapEvent dans la r√©ponse backend - Risque erreur 401');
        }
        
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : V√©rifier si c'est une validation Google apr√®s formulaire d'inscription
        const pendingFormData = localStorage.getItem('pendingRegisterDataForGoogle');
        if (pendingFormData && window.isRegisteringWithGoogle) {
          console.log('[OAUTH] ‚úÖ Validation Google apr√®s formulaire d√©tect√©e - Cr√©ation du compte avec donn√©es du formulaire');
          
          // Afficher le modal d'attente avec sablier
          let modal = document.getElementById('authModal');
          if (!modal) {
            modal = document.getElementById('publish-modal-inner');
          }
          
          // S'assurer que le backdrop existe et est visible
          let backdrop = document.getElementById('publish-modal-backdrop');
          if (!backdrop) {
            backdrop = document.createElement('div');
            backdrop.id = 'publish-modal-backdrop';
            backdrop.style.cssText = 'position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;background:rgba(0,0,0,0.8)!important;z-index:99999!important;display:flex!important;align-items:center!important;justify-content:center!important;visibility:visible!important;opacity:1!important;padding-top:40px!important;padding-bottom:40px!important;box-sizing:border-box!important;';
            document.body.appendChild(backdrop);
          }
          
          // S'assurer que le modal inner existe
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'publish-modal-inner';
            modal.style.cssText = 'background:#1e293b!important;border-radius:20px!important;padding:0!important;max-width:600px!important;width:90%!important;max-height:90vh!important;overflow-y:auto!important;';
            backdrop.appendChild(modal);
          }
          
          // FORCER l'affichage du backdrop
          if (backdrop) {
            backdrop.style.display = 'flex';
            backdrop.style.visibility = 'visible';
            backdrop.style.opacity = '1';
            backdrop.style.zIndex = '99999';
          }
          
          // Afficher le modal d'attente avec sablier
          if (modal) {
            modal.innerHTML = `
              <div id="authModal" data-mode="creating" style="padding:40px;max-width:500px;margin:0 auto;text-align:center;position:relative;">
                <div style="font-size:64px;margin-bottom:20px;animation:spin 2s linear infinite;">‚è≥</div>
                <h2 style="margin:0 0 8px;font-size:28px;font-weight:800;color:#fff;background:linear-gradient(135deg,#00ffc3,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Connexion en cours...</h2>
                <p style="margin:0;font-size:14px;color:var(--ui-text-muted);">Cr√©ation de votre compte en cours, veuillez patienter</p>
              </div>
              <style>
                @keyframes spin {
                  from { transform: rotate(0deg); }
                  to { transform: rotate(360deg); }
                }
              </style>
            `;
            modal.style.display = 'block';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
          }
          
          try {
            const formData = JSON.parse(pendingFormData);
            console.log('[OAUTH] Donn√©es du formulaire:', {
              email: formData.email,
              username: formData.username,
              firstName: formData.firstName,
              lastName: formData.lastName,
              hasPhoto: !!formData.photoData,
              hasAddresses: formData.addresses && formData.addresses.length > 0
            });
            
            // Pr√©parer le payload pour cr√©er le compte avec les donn√©es du formulaire
            const addresses = formData.addresses || [];
            if (formData.selectedAddress && !addresses.find(a => a.lat === formData.selectedAddress.lat)) {
              addresses.push(formData.selectedAddress);
            }
            
            const payload = {
              email: formData.email || currentUser.email,
              username: formData.username,
              password: formData.password || '',
              firstName: formData.firstName || '',
              lastName: formData.lastName || '',
              profilePhoto: formData.photoData || '',
              addresses: addresses,
              userId: syncData.user?.id || null,
              googleSub: currentUser.sub || null,
              sub: currentUser.sub || null
            };
            
            // Si une adresse postale a √©t√© s√©lectionn√©e, l'ajouter
            if (formData.selectedAddress) {
              payload.postalAddress = formData.selectedAddress.label || formData.selectedAddress.address || '';
            }
            
            console.log('[OAUTH] Cr√©ation compte avec /user/oauth/google/complete:', {
              email: payload.email,
              username: payload.username,
              hasPhoto: !!payload.profilePhoto,
              hasAddresses: addresses.length > 0
            });
            
            // Cr√©er le compte avec les donn√©es du formulaire
            const completeResponse = await fetch(`${window.API_BASE_URL}/user/oauth/google/complete`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            
            if (completeResponse.ok) {
              const completeData = await completeResponse.json();
              console.log('[OAUTH] ‚úÖ Compte cr√©√© avec succ√®s apr√®s validation Google:', completeData);
              
              // Nettoyer les donn√©es en attente
              localStorage.removeItem('pendingRegisterDataForGoogle');
              window.isRegisteringWithGoogle = false;
              
              // Mettre √† jour currentUser avec les donn√©es du compte cr√©√©
              if (completeData.user) {
                const slimUser = {
                  id: completeData.user.id || syncData.user?.id,
                  email: completeData.user.email || formData.email,
                  username: completeData.user.username || formData.username,
                  firstName: completeData.user.firstName || completeData.user.first_name || formData.firstName,
                  lastName: completeData.user.lastName || completeData.user.last_name || formData.lastName,
                  role: completeData.user.role || 'user',
                  subscription: completeData.user.subscription || 'free',
                  profile_photo_url: completeData.user.profile_photo_url || null,
                  hasPassword: completeData.user.hasPassword || false,
                  hasPostalAddress: completeData.user.hasPostalAddress || false,
                  profileComplete: completeData.user.profileComplete !== undefined ? completeData.user.profileComplete : true,
                  isLoggedIn: true
                };
                
                currentUser = { ...currentUser, ...slimUser };
                
                // Sauvegarder dans localStorage
                try {
                  const slimJson = JSON.stringify(slimUser);
                  localStorage.setItem('currentUser', slimJson);
                } catch (e) {
                  try { sessionStorage.setItem('currentUser', slimJson); } catch (e2) {}
                }
                
                // Mettre √† jour l'UI
                if (typeof updateAuthUI === 'function') {
                  updateAuthUI(slimUser);
                }
                
                showNotification('‚úÖ Compte cr√©√© avec succ√®s ! Vous √™tes maintenant connect√©.', 'success');
                closeAuthModal();
                closePublishModal();
              }
              
              window.isGoogleLoginInProgress = false;
              return; // Sortir ici, le compte est cr√©√©
            } else {
              const errorData = await completeResponse.json().catch(() => ({ error: 'Erreur lors de la cr√©ation du compte' }));
              console.error('[OAUTH] ‚ùå Erreur cr√©ation compte:', errorData);
              showNotification(`‚ùå Erreur: ${errorData.error || 'Erreur lors de la cr√©ation du compte'}`, 'error');
              // Continuer avec le flux normal en cas d'erreur
            }
          } catch (error) {
            console.error('[OAUTH] ‚ùå Erreur lors de la cr√©ation du compte apr√®s validation Google:', error);
            showNotification('‚ùå Erreur lors de la cr√©ation du compte', 'error');
            // Continuer avec le flux normal en cas d'erreur
          }
        }
        
        // FLOW INTELLIGENT : G√©rer les diff√©rents cas selon les donn√©es
        if (syncData.ok && syncData.user) {
          const profileComplete = syncData.profileComplete === true;
          const missingData = syncData.missingData || [];
          const needsEmailVerification = syncData.needsEmailVerification === true;
          const isNewUser = syncData.isNewUser === true;
          
          // LOGS POUR D√âBOGAGE
          console.log('[OAUTH] Donn√©es re√ßues du backend:', {
            profileComplete: profileComplete,
            isNewUser: isNewUser,
            missingData: missingData,
            needsEmailVerification: needsEmailVerification,
            user: {
              id: syncData.user.id,
              email: syncData.user.email,
              username: syncData.user.username,
              firstName: syncData.user.firstName || syncData.user.first_name,
              lastName: syncData.user.lastName || syncData.user.last_name,
              profile_photo_url: syncData.user.profile_photo_url ? syncData.user.profile_photo_url.substring(0, 50) + '...' : 'null'
            }
          });
          
          // ========================================
          // R√àGLE 1: NOUVEAU COMPTE ‚Üí TOUJOURS FORMULAIRE COMPLET
          // ========================================
          if (isNewUser) {
            console.log('[OAUTH] NOUVEAU COMPTE - Affichage formulaire complet (toujours demand√© pour nouveau compte)');
            showNotification('‚ö†Ô∏è Veuillez compl√©ter votre profil pour continuer.', 'info');
            // Afficher le formulaire d'inscription complet
            if (typeof showProRegisterForm === 'function') {
              showProRegisterForm();
            } else if (typeof window.showProRegisterForm === 'function') {
              window.showProRegisterForm();
            }
            // Pr√©-remplir avec les donn√©es Google
            if (syncData.user) {
              window.registerData = {
                email: syncData.user.email || currentUser.email || '',
                username: syncData.user.username || currentUser.email?.split('@')[0]?.substring(0, 20) || '',
                password: '',
                passwordConfirm: '',
                firstName: syncData.user.firstName || syncData.user.first_name || currentUser.name?.split(' ')[0] || '',
                lastName: syncData.user.lastName || syncData.user.last_name || currentUser.name?.split(' ').slice(1).join(' ') || '',
                profilePhoto: syncData.user.profile_photo_url || payload.picture || '',
                postalAddress: '',
                avatarId: 1,
                avatarDescription: '',
                addresses: [],
                emailVerificationCode: null,
                emailVerified: false,
                verificationAttempts: 0,
                lastVerificationAttempt: null,
                registrationAttempts: 0,
                lastRegistrationAttempt: null,
                captchaAnswer: null,
                codeSentAt: null,
                codeExpiresAt: null,
                resendCountdown: 0,
                lastResendAttempt: null
              };
            }
            window.isGoogleLoginInProgress = false;
            return;
          }
          
          // ========================================
          // R√àGLE 2: COMPTE EXISTANT ‚Üí Demander SEULEMENT ce qui manque
          // ========================================
          // CAS 1: Profil complet ‚Üí Connexion directe
          if (profileComplete === true && missingData.length === 0 && !needsEmailVerification) {
            console.log('[OAUTH] ‚û°Ô∏è CAS: COMPTE EXISTANT COMPLET (profileComplete=true, missingData=[], needsEmailVerification=false) - CONNEXION DIRECTE');
            console.log('[OAUTH] syncData.user:', {
              id: syncData.user.id,
              email: syncData.user.email,
              username: syncData.user.username,
              firstName: syncData.user.firstName || syncData.user.first_name,
              lastName: syncData.user.lastName || syncData.user.last_name,
              profile_photo_url: syncData.user.profile_photo_url ? syncData.user.profile_photo_url.substring(0, 50) + '...' : 'null',
              picture: payload.picture ? payload.picture.substring(0, 50) + '...' : 'null'
            });
            
            // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : R√©cup√©rer le username depuis localStorage AVANT de cr√©er slimUser
            let savedUsernameFromForm = null;
            let savedPhotoDataFromForm = null;
            try {
              const savedFromStorage = localStorage.getItem('pendingRegisterDataForGoogle');
              if (savedFromStorage) {
                const savedPendingData = JSON.parse(savedFromStorage);
                savedUsernameFromForm = savedPendingData?.username || null;
                savedPhotoDataFromForm = savedPendingData?.photoData || null;
                console.log('[OAUTH] ‚úÖ‚úÖ‚úÖ Donn√©es r√©cup√©r√©es depuis localStorage:', {
                  username: savedUsernameFromForm || 'MANQUANT',
                  hasPhotoData: !!savedPhotoDataFromForm
                });
              } else {
                console.log('[OAUTH] ‚ö†Ô∏è Aucune donn√©e dans localStorage (pendingRegisterDataForGoogle)');
              }
            } catch (e) {
              console.error('[OAUTH] ‚ùå Erreur r√©cup√©ration depuis localStorage:', e);
            }
            
            // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è VALIDATION STRICTE : Utiliser le username du formulaire s'il est valide
            let finalUsername = savedUsernameFromForm || syncData.user.username || currentUser.email?.split('@')[0]?.substring(0, 20) || 'Utilisateur';
            if (savedUsernameFromForm && savedUsernameFromForm !== 'null' && savedUsernameFromForm !== '' && !savedUsernameFromForm.includes('@')) {
              finalUsername = savedUsernameFromForm;
              console.log('[OAUTH] ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ Username du FORMULAIRE utilis√©:', finalUsername);
            } else if (syncData.user.username && syncData.user.username !== 'null' && syncData.user.username !== '' && !syncData.user.username.includes('@')) {
              finalUsername = syncData.user.username;
              console.log('[OAUTH] ‚ö†Ô∏è Username du backend utilis√© (formulaire invalide):', finalUsername);
            } else {
              finalUsername = currentUser.email?.split('@')[0]?.substring(0, 20) || 'Utilisateur';
              console.log('[OAUTH] ‚ùå Aucun username valide, utilisation email part:', finalUsername);
            }
            
            const slimUser = {
              id: syncData.user.id || currentUser.id,
              email: syncData.user.email || currentUser.email,
              username: finalUsername, // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è PRIORIT√â ABSOLUE au username du formulaire
              firstName: syncData.user.firstName || syncData.user.first_name || currentUser.name?.split(' ')[0] || '',
              lastName: syncData.user.lastName || syncData.user.last_name || currentUser.name?.split(' ').slice(1).join(' ') || '',
              role: syncData.user.role || 'user',
              subscription: syncData.user.subscription || 'free',
              profile_photo_url: syncData.user.profile_photo_url || payload.picture || null,
              hasPassword: syncData.user.hasPassword || false,
              hasPostalAddress: syncData.user.hasPostalAddress || false,
              profileComplete: true,
              isLoggedIn: true
            };
            
            console.log('[OAUTH] slimUser cr√©√©:', {
              id: slimUser.id,
              firstName: slimUser.firstName,
              lastName: slimUser.lastName,
              username: slimUser.username,
              profile_photo_url: slimUser.profile_photo_url ? slimUser.profile_photo_url.substring(0, 50) + '...' : 'null'
            });
            
            // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Utiliser connectUser comme "Continuer sans v√©rifier" pour √©viter les erreurs de popup
            // Forcer le username et photoData dans currentUser AVANT connectUser
            if (typeof window !== 'undefined') {
              if (window.currentUser === undefined) {
                window.currentUser = {};
              }
              if (finalUsername && finalUsername !== 'Utilisateur' && !finalUsername.includes('@')) {
                window.currentUser.username = finalUsername;
                console.log('[OAUTH] ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ Username FORC√â dans window.currentUser:', finalUsername);
              }
              if (savedPhotoDataFromForm && savedPhotoDataFromForm !== 'null' && savedPhotoDataFromForm !== '') {
                window.currentUser.photoData = savedPhotoDataFromForm;
                console.log('[OAUTH] ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ photoData FORC√â dans window.currentUser');
              }
            }
            
            // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Afficher la fen√™tre d'attente EXACTEMENT comme "Continuer sans v√©rifier"
            // Chercher le modal dans publish-modal-inner ou authModal (EXACTEMENT comme createAccountWithoutVerification)
            let modal = document.getElementById('authModal');
            if (!modal) {
              modal = document.getElementById('publish-modal-inner');
            }
            
            // S'assurer que le backdrop existe et est visible (CR√âER s'il n'existe pas)
            let backdrop = document.getElementById('publish-modal-backdrop');
            if (!backdrop) {
              console.log('[OAUTH] üì¶ Cr√©ation backdrop (n\'existe pas)');
              backdrop = document.createElement('div');
              backdrop.id = 'publish-modal-backdrop';
              backdrop.style.cssText = 'position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;background:rgba(0,0,0,0.8)!important;z-index:99999!important;display:flex!important;align-items:center!important;justify-content:center!important;visibility:visible!important;opacity:1!important;padding-top:40px!important;padding-bottom:40px!important;box-sizing:border-box!important;';
              document.body.appendChild(backdrop);
            }
            
            // S'assurer que le modal inner existe (CR√âER s'il n'existe pas)
            if (!modal) {
              console.log('[OAUTH] üì¶ Cr√©ation modal inner (n\'existe pas)');
              modal = document.createElement('div');
              modal.id = 'publish-modal-inner';
              modal.style.cssText = 'background:#1e293b!important;border-radius:20px!important;padding:0!important;max-width:600px!important;width:90%!important;max-height:90vh!important;overflow-y:auto!important;';
              backdrop.appendChild(modal);
            }
            
            // FORCER l'affichage du backdrop (EXACTEMENT comme createAccountWithoutVerification)
            if (backdrop) {
              backdrop.style.display = 'flex';
              backdrop.style.visibility = 'visible';
              backdrop.style.opacity = '1';
              backdrop.style.zIndex = '99999';
            }
            
            // FORCER l'affichage du modal inner
            if (modal) {
              modal.style.display = 'block';
              modal.style.visibility = 'visible';
              modal.style.opacity = '1';
            }
            
            // Afficher la fen√™tre "Connexion en cours..." EXACTEMENT comme "Continuer sans v√©rifier"
            if (modal) {
              modal.innerHTML = `
                <div id="authModal" data-mode="connecting" style="padding:40px;max-width:500px;margin:0 auto;text-align:center;position:relative;">
                  <div style="font-size:64px;margin-bottom:20px;">‚è≥</div>
                  <h2 style="margin:0 0 8px;font-size:28px;font-weight:800;color:#fff;background:linear-gradient(135deg,#00ffc3,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Connexion en cours...</h2>
                  <p style="margin:0;font-size:14px;color:var(--ui-text-muted);">Veuillez patienter</p>
                </div>
              `;
              console.log('[OAUTH] ‚úÖ‚úÖ‚úÖ Fen√™tre d\'attente affich√©e (comme "Continuer sans v√©rifier")');
            } else {
              console.error('[OAUTH] ‚ùå Modal non trouv√© et impossible √† cr√©er pour afficher la fen√™tre d\'attente');
            }
            
            // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Utiliser connectUser au lieu de updateAuthUI directement (comme "Continuer sans v√©rifier")
            // R√©cup√©rer les tokens depuis localStorage
            let accessToken = null;
            let refreshToken = null;
            try {
              const cognitoTokens = localStorage.getItem('cognito_tokens');
              if (cognitoTokens) {
                const tokens = JSON.parse(cognitoTokens);
                accessToken = tokens.access_token || tokens.accessToken;
                refreshToken = tokens.refresh_token || tokens.refreshToken;
              }
            } catch (e) {
              console.error('[OAUTH] ‚ùå Erreur r√©cup√©ration tokens:', e);
            }
            
            if (accessToken && typeof window.connectUser === 'function') {
              console.log('[OAUTH] ‚úÖ‚úÖ‚úÖ Utilisation connectUser (comme "Continuer sans v√©rifier")');
              const tokens = { access_token: accessToken, refresh_token: refreshToken };
              // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : connectUser ferme d√©j√† les modals automatiquement (comme "Continuer sans v√©rifier")
              // Ne pas fermer les modals ici pour √©viter les erreurs de popup
              window.connectUser(slimUser, tokens, true); // true = rester connect√© par d√©faut
              // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è NOTE : connectUser affiche d√©j√† une notification de succ√®s, pas besoin d'en afficher une autre ici
            } else {
              // Fallback : utiliser updateAuthUI si connectUser n'est pas disponible
              console.warn('[OAUTH] ‚ö†Ô∏è connectUser non disponible, utilisation updateAuthUI');
              currentUser = { ...currentUser, ...slimUser, isLoggedIn: true };
              if (finalUsername && finalUsername !== 'Utilisateur' && !finalUsername.includes('@')) {
                currentUser.username = finalUsername;
              }
              if (savedPhotoDataFromForm && savedPhotoDataFromForm !== 'null' && savedPhotoDataFromForm !== '') {
                currentUser.photoData = savedPhotoDataFromForm;
              }
              updateAuthUI(slimUser);
              
              try {
                const userForStorage = (typeof window.removePhotoDataForStorage === 'function') 
                  ? window.removePhotoDataForStorage(slimUser) 
                  : slimUser;
                const slimJson = JSON.stringify(userForStorage);
                localStorage.setItem('currentUser', slimJson);
              } catch (e) {
                try { 
                  const userForStorage = (typeof window.removePhotoDataForStorage === 'function') 
                    ? window.removePhotoDataForStorage(slimUser) 
                    : slimUser;
                  sessionStorage.setItem('currentUser', JSON.stringify(userForStorage)); 
                } catch (e2) {}
              }
              
              setTimeout(() => {
                closeAuthModal();
                closePublishModal();
              }, 500);
              
              const displayName = finalUsername || slimUser.username || slimUser.email?.split('@')[0] || 'Utilisateur';
              showNotification(`‚úÖ Bienvenue ${displayName} ! Vous √™tes connect√©.`, 'success');
            }
            
            window.isGoogleLoginInProgress = false;
            return;
          }
          
          // CAS 2: Compte existant avec donn√©es manquantes ‚Üí Demander SEULEMENT ce qui manque
          if (missingData.length > 0) {
            console.log('[OAUTH] Compte existant - Donn√©es manquantes:', missingData);
            
            // Si seulement la photo manque ‚Üí Formulaire photo uniquement
            if (missingData.length === 1 && missingData[0] === 'photo') {
              console.log('[OAUTH] Photo manquante uniquement - Affichage formulaire photo');
              showPhotoUploadForm(syncData.user);
              window.isGoogleLoginInProgress = false;
              return;
            }
            
            // Si plusieurs donn√©es manquent ou autres donn√©es ‚Üí Formulaire adapt√©
            // Pour l'instant, afficher le formulaire complet pr√©-rempli
            console.log('[OAUTH] Plusieurs donn√©es manquantes - Affichage formulaire complet pr√©-rempli');
            showNotification(`‚ö†Ô∏è Veuillez compl√©ter les informations manquantes: ${missingData.join(', ')}`, 'warning');
            if (typeof showProRegisterForm === 'function') {
              showProRegisterForm();
            } else if (typeof window.showProRegisterForm === 'function') {
              window.showProRegisterForm();
            }
            // Pr√©-remplir avec les donn√©es existantes
            if (syncData.user) {
              window.registerData = {
                email: syncData.user.email || currentUser.email || '',
                username: syncData.user.username || currentUser.email?.split('@')[0]?.substring(0, 20) || '',
                password: '',
                passwordConfirm: '',
                firstName: syncData.user.firstName || syncData.user.first_name || currentUser.name?.split(' ')[0] || '',
                lastName: syncData.user.lastName || syncData.user.last_name || currentUser.name?.split(' ').slice(1).join(' ') || '',
                profilePhoto: syncData.user.profile_photo_url || payload.picture || '',
                postalAddress: '',
                avatarId: 1,
                avatarDescription: '',
                addresses: [],
                emailVerificationCode: null,
                emailVerified: false,
                verificationAttempts: 0,
                lastVerificationAttempt: null,
                registrationAttempts: 0,
                lastRegistrationAttempt: null,
                captchaAnswer: null,
                codeSentAt: null,
                codeExpiresAt: null,
                resendCountdown: 0,
                lastResendAttempt: null
              };
            }
            window.isGoogleLoginInProgress = false;
            return;
          }
          
          // CAS 3: Compte existant, profil complet, besoin confirmation email ‚Üí Modal confirmation email uniquement
          if (needsEmailVerification && profileComplete) {
            console.log('[OAUTH] Compte existant - Confirmation email requise - Modal confirmation email uniquement');
            const slimUser = {
              id: syncData.user.id || currentUser.id,
              email: syncData.user.email || currentUser.email,
              username: syncData.user.username || currentUser.email?.split('@')[0]?.substring(0, 20) || 'Utilisateur',
              firstName: syncData.user.firstName || syncData.user.first_name || currentUser.name?.split(' ')[0] || '',
              lastName: syncData.user.lastName || syncData.user.last_name || currentUser.name?.split(' ').slice(1).join(' ') || '',
              role: syncData.user.role || 'user',
              subscription: syncData.user.subscription || 'free',
              profile_photo_url: syncData.user.profile_photo_url || payload.picture || null,
              hasPassword: syncData.user.hasPassword || false,
              hasPostalAddress: syncData.user.hasPostalAddress || false,
              profileComplete: true,
              isLoggedIn: true
            };
            
            currentUser = { ...currentUser, ...slimUser, isLoggedIn: true };
            updateAuthUI(slimUser);
            
            try {
              // ‚ö†Ô∏è OPTIMISATION : Exclure photoData avant sauvegarde
              const userForStorage = (typeof window.removePhotoDataForStorage === 'function') 
                ? window.removePhotoDataForStorage(slimUser) 
                : slimUser;
              const slimJson = JSON.stringify(userForStorage);
              localStorage.setItem('currentUser', slimJson);
            } catch (e) {
              try { 
                const userForStorage = (typeof window.removePhotoDataForStorage === 'function') 
                  ? window.removePhotoDataForStorage(slimUser) 
                  : slimUser;
                sessionStorage.setItem('currentUser', JSON.stringify(userForStorage)); 
              } catch (e2) {}
            }
            
            // Afficher modal confirmation email
            showEmailVerificationModal(syncData.user.email, syncData.user.username || 'Utilisateur');
            window.isGoogleLoginInProgress = false;
            return;
          }
          
          // CAS 4: Fallback ‚Üí Connexion directe quand m√™me
          console.log('[OAUTH] Fallback - Connexion directe');
          const slimUser = {
            id: syncData.user.id || currentUser.id,
            email: syncData.user.email || currentUser.email,
            username: syncData.user.username || currentUser.email?.split('@')[0]?.substring(0, 20) || 'Utilisateur',
            firstName: syncData.user.firstName || syncData.user.first_name || currentUser.name?.split(' ')[0] || '',
            lastName: syncData.user.lastName || syncData.user.last_name || currentUser.name?.split(' ').slice(1).join(' ') || '',
            role: syncData.user.role || 'user',
            subscription: syncData.user.subscription || 'free',
            profile_photo_url: syncData.user.profile_photo_url || payload.picture || null,
            hasPassword: syncData.user.hasPassword || false,
            hasPostalAddress: syncData.user.hasPostalAddress || false,
            profileComplete: profileComplete,
            isLoggedIn: true
          };
          
          currentUser = { ...currentUser, ...slimUser, isLoggedIn: true };
          updateAuthUI(slimUser);
          
          try {
            const slimJson = JSON.stringify(slimUser);
            localStorage.setItem('currentUser', slimJson);
          } catch (e) {
            try { sessionStorage.setItem('currentUser', slimJson); } catch (e2) {}
          }
          
          closeAuthModal();
          closePublishModal();
          const displayName = slimUser.username || slimUser.firstName || slimUser.email?.split('@')[0] || 'Utilisateur';
          showNotification(`‚úÖ Bienvenue ${displayName} !`, 'success');
          window.isGoogleLoginInProgress = false;
          return;
        } else {
          // Fallback si syncData.ok est false ou syncData.user est manquant
          console.warn('‚ö†Ô∏è R√©ponse backend invalide, connexion avec donn√©es Google uniquement');
          
          // Se connecter quand m√™me avec les donn√©es Google disponibles
          const slimUser = {
            id: currentUser.id || `user_${Date.now()}`,
            email: currentUser.email,
            username: currentUser.email?.split('@')[0]?.substring(0, 20) || 'Utilisateur',
            firstName: currentUser.name?.split(' ')[0] || '',
            lastName: currentUser.name?.split(' ').slice(1).join(' ') || '',
            role: 'user',
            subscription: 'free',
            profile_photo_url: payload.picture || null,
            hasPassword: false,
            hasPostalAddress: false,
            profileComplete: false,
            isLoggedIn: true
          };
          
          currentUser = { ...currentUser, ...slimUser, isLoggedIn: true };
          updateAuthUI(slimUser);
          
          try {
            const slimJson = JSON.stringify(slimUser);
            localStorage.setItem('currentUser', slimJson);
          } catch (e) {
            try {
              sessionStorage.setItem('currentUser', slimJson);
            } catch (e2) {
              console.warn('‚ö†Ô∏è Impossible de sauvegarder user');
            }
          }
          
          closeAuthModal();
          closePublishModal();
          showNotification('‚úÖ Connexion Google r√©ussie !', 'success');
          window.isGoogleLoginInProgress = false;
        }
      } else {
        throw new Error(`Backend sync failed: ${syncResponse.status}`);
      }
    } catch (apiError) {
      console.warn('‚ö†Ô∏è Erreur lors de l\'appel API backend:', apiError);
      
      // V√âRIFIER SI LE PROFIL EST D√âJ√Ä COMPLET AVANT D'AFFICHER LE FORMULAIRE
      // Si currentUser.profileComplete === true dans localStorage, ne JAMAIS afficher le formulaire
      const savedUser = localStorage.getItem('currentUser');
      let savedUserObj = null;
      try {
        if (savedUser) {
          savedUserObj = JSON.parse(savedUser);
        }
      } catch (e) {
        console.warn('‚ö†Ô∏è Impossible de parser currentUser depuis localStorage:', e);
      }
      
      // V√©rifier aussi dans currentUser actuel (peut √™tre d√©fini plus haut)
      const isProfileComplete = (savedUserObj && savedUserObj.profileComplete === true) || 
                                 (currentUser && currentUser.profileComplete === true);
      
      if (isProfileComplete) {
        console.log('‚úÖ Profil d√©j√† complet - Connexion directe sans formulaire (fallback)');
        // Restaurer l'utilisateur depuis localStorage ou utiliser currentUser
        if (savedUserObj) {
          currentUser = {
            ...currentUser,
            ...savedUserObj,
            isLoggedIn: true,
            profileComplete: true // GARANTIR que profileComplete est true
          };
        } else {
          currentUser.profileComplete = true;
          currentUser.isLoggedIn = true;
        }
        // PRIORITY HOTFIX: Ne jamais stocker l'objet user complet
        const slimUser = saveUserSlim(currentUser);
        if (slimUser) {
          safeSetItem("currentUser", JSON.stringify(slimUser));
        }
        // INTERDICTION : Ne pas modifier le bloc compte - fonctions supprim√©es
        showNotification(`‚úÖ Connexion r√©ussie ! Bienvenue ${currentUser.name || currentUser.email}`, "success");
        
        // Nettoyer l'URL des param√®tres OAuth
        if (window.history && window.history.replaceState) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        // FERMER le formulaire s'il √©tait ouvert (s√©curit√© suppl√©mentaire)
        closePublishModal();
        return; // Ne JAMAIS afficher le formulaire si le profil est complet
      }
      
      // FLOW SIMPLIFI√â : Se connecter quand m√™me avec les donn√©es Google disponibles
      // Comme les leaders mondiaux, on se connecte m√™me si le backend √©choue
      console.log('‚úÖ Connexion avec donn√©es Google uniquement (backend indisponible)');
      
      // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : R√©cup√©rer le username depuis pendingRegisterDataForGoogle (donn√©es du formulaire d'inscription)
      let savedUsername = null;
      let savedPhotoData = null;
      let savedPostalAddress = null;
      try {
        const pendingData = localStorage.getItem('pendingRegisterDataForGoogle') || sessionStorage.getItem('pendingRegisterDataForGoogle');
        if (pendingData) {
          const parsed = JSON.parse(pendingData);
          if (parsed.username && parsed.username !== 'null' && parsed.username !== '' && !parsed.username.includes('@')) {
            savedUsername = parsed.username;
            console.log('[FALLBACK] ‚úÖ Username r√©cup√©r√© depuis pendingRegisterDataForGoogle:', savedUsername);
          }
          if (parsed.photoData && parsed.photoData !== 'null' && parsed.photoData.length > 100) {
            savedPhotoData = parsed.photoData;
            console.log('[FALLBACK] ‚úÖ photoData r√©cup√©r√© depuis pendingRegisterDataForGoogle');
          }
          if (parsed.selectedAddress?.label) {
            savedPostalAddress = parsed.selectedAddress.label;
            console.log('[FALLBACK] ‚úÖ Adresse postale r√©cup√©r√©e:', savedPostalAddress);
          }
        }
      } catch (e) {
        console.warn('[FALLBACK] ‚ö†Ô∏è Erreur lecture pendingRegisterDataForGoogle:', e);
      }
      
      // Aussi v√©rifier localStorage.currentUser (donn√©es d'une connexion pr√©c√©dente)
      if (!savedUsername) {
        try {
          const savedCurrentUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
          if (savedCurrentUser) {
            const parsed = JSON.parse(savedCurrentUser);
            if (parsed.username && parsed.username !== 'null' && parsed.username !== '' && !parsed.username.includes('@') && parsed.username !== 'Utilisateur') {
              savedUsername = parsed.username;
              console.log('[FALLBACK] ‚úÖ Username r√©cup√©r√© depuis localStorage.currentUser:', savedUsername);
            }
          }
        } catch (e) {
          console.warn('[FALLBACK] ‚ö†Ô∏è Erreur lecture localStorage.currentUser:', e);
        }
      }
      
      const slimUser = {
        id: currentUser.id || `user_${Date.now()}`,
        email: currentUser.email,
        username: savedUsername || null, // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è NE JAMAIS utiliser l'email - getUserDisplayName affichera "Compte" si null
        firstName: currentUser.name?.split(' ')[0] || '',
        lastName: currentUser.name?.split(' ').slice(1).join(' ') || '',
        role: 'user',
        subscription: 'free',
        profile_photo_url: payload.picture || null,
        photoData: savedPhotoData || null,
        postalAddress: savedPostalAddress || null,
        hasPassword: false,
        hasPostalAddress: !!savedPostalAddress,
        profileComplete: false,
        isLoggedIn: true
      };
      
      console.log('[FALLBACK] slimUser cr√©√©:', { username: slimUser.username, hasPhotoData: !!slimUser.photoData, postalAddress: slimUser.postalAddress });
      
      currentUser = { ...currentUser, ...slimUser, isLoggedIn: true };
      updateAuthUI(slimUser);
      
      try {
        const slimJson = JSON.stringify(slimUser);
        localStorage.setItem('currentUser', slimJson);
      } catch (e) {
        try {
          sessionStorage.setItem('currentUser', slimJson);
        } catch (e2) {
          console.warn('‚ö†Ô∏è Impossible de sauvegarder user');
        }
      }
      
      closeAuthModal();
      closePublishModal();
      showNotification('‚úÖ Connexion Google r√©ussie !', 'success');
      window.isGoogleLoginInProgress = false;
    }
  } catch (e) {
    console.warn(e);
    showNotification("‚úÖ Connect√© (token re√ßu).", "success");
  }
}

// Fonction centralis√©e pour afficher le formulaire d'inscription apr√®s validation Google
function displayRegistrationFormAfterGoogleAuth(backendUser) {
  // FONCTION D√âSACTIV√âE : Plus jamais de formulaire apr√®s OAuth Google
  // Comme les leaders mondiaux, on se connecte directement
  console.log('‚ö†Ô∏è displayRegistrationFormAfterGoogleAuth appel√© mais D√âSACTIV√â - Connexion directe Google');
  
  // Ne jamais afficher de formulaire apr√®s OAuth Google - connexion directe
  if (currentUser && currentUser.isLoggedIn) {
    console.log('‚úÖ Utilisateur d√©j√† connect√© - pas de formulaire n√©cessaire');
    return;
  }
  
  // Si l'utilisateur n'est pas connect√©, se connecter directement avec les donn√©es Google
  const slimUser = {
    id: backendUser?.id || currentUser.id || `user_${Date.now()}`,
    email: backendUser?.email || currentUser.email,
    username: backendUser?.username || currentUser.email?.split('@')[0]?.substring(0, 20) || 'Utilisateur',
    firstName: backendUser?.firstName || backendUser?.first_name || currentUser.name?.split(' ')[0] || '',
    lastName: backendUser?.lastName || backendUser?.last_name || currentUser.name?.split(' ').slice(1).join(' ') || '',
    role: backendUser?.role || 'user',
    subscription: backendUser?.subscription || 'free',
    profile_photo_url: backendUser?.profile_photo_url || payload?.picture || currentUser.avatar || null,
    hasPassword: backendUser?.hasPassword || false,
    hasPostalAddress: backendUser?.hasPostalAddress || false,
    profileComplete: true, // OAuth Google = toujours complet
    isLoggedIn: true
  };
  
  currentUser = { ...currentUser, ...slimUser, isLoggedIn: true };
  updateAuthUI(slimUser);
  
  try {
    const slimJson = JSON.stringify(slimUser);
    localStorage.setItem('currentUser', slimJson);
  } catch (e) {
    try {
      sessionStorage.setItem('currentUser', slimJson);
    } catch (e2) {
      console.warn('‚ö†Ô∏è Impossible de sauvegarder user');
    }
  }
  
  closeAuthModal();
  closePublishModal();
  showNotification('‚úÖ Connexion Google r√©ussie !', 'success');
}

// 3) Logout (Hosted UI)
function startCognitoLogout() {
  clearSession();
  localStorage.removeItem("currentUser");
  const logoutUrl =
    `${window.COGNITO.domain}/logout` +
    `?client_id=${encodeURIComponent(window.COGNITO.clientId)}` +
    `&logout_uri=${encodeURIComponent(window.COGNITO.redirectUri)}`;
  window.location.assign(logoutUrl);
}

// ============================================
// MAPEVENT ‚Äì LOGIQUE FRONTEND (VERSION PRO)
// Avec :
//  - MAP + POPUPS + DEMO
//  - Event List fullscreen
//  - Filtre EXPLORATEUR multi-colonnes (Leader One Neon Pro)
//  - Filtres dates pour le mode EVENT
//  - Chargement arbres depuis /trees/*.json
//
// STRAT√âGIE COMMERCIALE FUTURE (√† impl√©menter c√¥t√© backend) :
//  - Events : Envoyer un mail de confirmation √† l'organisateur
//    ‚Üí Rotation : 1 event par organisateur, puis passer au suivant
//    ‚Üí Faire le tour complet avant de revenir vers le m√™me organisateur
//    ‚Üí L'organisateur doit publier lui-m√™me ses prochains events
//  - Booking/Service : Publier tous les points automatiquement
//    ‚Üí Enlever seulement si un utilisateur paie pour publier son propre point
//    ‚Üí Si l'IA d√©tecte un doublon/rapport, enlever le point automatique
//  - Logique IA : D√©tection de doublons et conflits lors des paiements
// ============================================

// --- CONFIG PATHS ---
// Les assets sont dans assets/ √† la racine du bucket S3
// Depuis la racine CloudFront, on acc√®de √† assets/
const ASSETS_BASE = "assets";
const CAT_IMG_DIR = "category_images";
const EVENT_OVERLAYS_DIR = "event_overlays";

const MODE_IMAGE_FOLDERS = {
  event: "event",
  booking: "booking",
  service: "service"
};

const OVERLAY_IMAGES = {
  DEFAULT: `${ASSETS_BASE}/${EVENT_OVERLAYS_DIR}/eventdefault.jpg`,
  CANCELED: `${ASSETS_BASE}/${EVENT_OVERLAYS_DIR}/canceled.jpg`,
  COMPLETED: `${ASSETS_BASE}/${EVENT_OVERLAYS_DIR}/completed.jpg`,
  REPORTED: `${ASSETS_BASE}/${EVENT_OVERLAYS_DIR}/reported.jpg`,
  POSTPONED: `${ASSETS_BASE}/${EVENT_OVERLAYS_DIR}/postponed.jpg`
};

const DEFAULT_EVENT_IMAGE = OVERLAY_IMAGES.DEFAULT;

// --- √âTAT GLOBAL ---
let map;
let tileLayer;
let markersLayer;
let markerMap = {};

// --- VIEWPORT PROGRESSIF ---
// Chargement progressif: cercles agr√©g√©s aux faibles zooms, events r√©els aux forts zooms
let geoCirclesLayer = null;           // Layer pour les cercles agr√©g√©s (zoom < 10)
let loadedEventIds = new Set();       // IDs des events d√©j√† charg√©s (√©vite les doublons)
let viewportFetchTimeout = null;      // Timer debounce pour les fetch viewport
let lastViewportKey = '';             // Cl√© du dernier viewport charg√© (√©vite re-fetch inutile)
const VIEWPORT_ZOOM_THRESHOLD = 10;   // Zoom √† partir duquel on charge les events r√©els

let currentMode = "event"; // "event" | "booking" | "service"
let currentLanguage = "fr";

// Langues support√©es ‚Äì MEILLEURE AU MONDE (90+ langues, couverture maximale)
const SUPPORTED_LANGUAGES = [
  "fr", "en", "es", "zh", "hi", "de", "it", "pt", "ru", "ar", "ja", "ko", "nl", "tr", "pl", "vi", "id", "th",
  "uk", "sv", "no", "da", "fi", "el", "he", "ro", "ms", "cs", "hu", "sk", "bg", "hr", "sr", "lt", "lv", "et", "sl",
  "ta", "bn", "ur", "fa", "mr", "sw", "am", "af", "ca", "pa", "tl", "my", "ne", "is", "sq", "mk", "bs", "gl",
  "cy", "ka", "hy", "az", "kk", "uz", "ml", "te", "gu", "kn", "si", "eu", "mn", "ga", "lb", "mt",
  "yo", "ha", "ig", "so", "rw", "mg", "wo", "st", "tn", "xh", "zu", "km", "lo", "sd", "ps", "ky", "tk", "tg",
  "br", "gd", "fy", "ku", "ht", "jv", "su", "ny", "om", "ti", "dv", "bo", "dz", "or", "as", "kmr", "ckb"
];

// CRITIQUE: Initialiser window.translations IMM√âDIATEMENT avec un objet vide
// pour √©viter toute erreur TDZ avant que les traductions compl√®tes ne soient charg√©es
// Cette initialisation doit √™tre SYNCHRONE et IMM√âDIATE
// NE JAMAIS utiliser const/let/var translations car cela cr√©e une TDZ
(function() {
  if (typeof window !== 'undefined') {
    // S'assurer que window.translations existe AVANT toute utilisation
    if (!window.translations || typeof window.translations !== 'object') {
      window.translations = {};
    }
    SUPPORTED_LANGUAGES.forEach(lang => {
      if (!window.translations[lang] || typeof window.translations[lang] !== 'object') {
        window.translations[lang] = {};
      }
    });
  }
})();

// CRITIQUE: window.translations sera d√©fini juste apr√®s, mais on initialise window.t() d'abord
// pour √©viter les erreurs de r√©f√©rence
// CRITIQUE: window.t() DOIT √™tre d√©fini AVANT window.translations pour √©viter les erreurs TDZ
// Mais window.t() doit utiliser window.translations, donc on initialise window.translations d'abord
// FONCTION window.t - VERSION S√âCURIS√âE SANS TDZ
window.t = function(k) {
  if (!k) return '';
  try {
    var w = window;
    if (!w || !w.translations) return k;
    var l = (typeof currentLanguage !== 'undefined' && currentLanguage) ? currentLanguage : 'fr';
    if (w.translations[l] && w.translations[l][k]) return w.translations[l][k];
    if (w.translations.fr && w.translations.fr[k]) return w.translations.fr[k];
    if (w.translations.en && w.translations.en[k]) return w.translations.en[k];
    return k;
  } catch(e) {
    return k;
  }
};

// D√©finir les fonctions critiques IMM√âDIATEMENT pour √©viter les erreurs de r√©f√©rence
// Ces fonctions seront red√©finies plus tard avec leurs impl√©mentations compl√®tes
// Ouvre la discussion d'un √©v√©nement (depuis la popup)
window.openEventDiscussion = function(type, id) {
  try {
    if (typeof currentUser === 'undefined' || !currentUser || !currentUser.isLoggedIn) {
      if (typeof window.openLoginModal === 'function') window.openLoginModal();
      else if (typeof openLoginModal === 'function') openLoginModal();
      return;
    }
    if (typeof window.openDiscussionModal === 'function') {
      window.openDiscussionModal(type, id);
    } else if (typeof openDiscussionModal === 'function') {
      openDiscussionModal(type, id);
    } else {
      setTimeout(() => {
        if (typeof window.openDiscussionModal === 'function') window.openDiscussionModal(type, id);
        else if (typeof openDiscussionModal === 'function') openDiscussionModal(type, id);
      }, 150);
    }
  } catch (e) {
    console.warn('openEventDiscussion error:', e);
  }
};

// Stub pour openGroupsModal - sera remplac√© par l'impl√©mentation compl√®te plus tard
// CRITIQUE: Cette fonction DOIT √™tre disponible imm√©diatement pour √©viter les erreurs
window.openGroupsModal = function() {
  try {
    // V√©rifier si currentUser est disponible et si l'utilisateur est connect√©
    if (typeof currentUser !== 'undefined' && currentUser && currentUser.isLoggedIn) {
      // Si l'impl√©mentation compl√®te est d√©j√† disponible (assign√©e plus tard), elle sera utilis√©e
      // Sinon, attendre un peu et r√©essayer
      setTimeout(() => {
        try {
          const currentImpl = window.openGroupsModal;
          // Si la fonction a √©t√© remplac√©e par l'impl√©mentation compl√®te (plus de 500 caract√®res)
          if (currentImpl && currentImpl.toString().length > 500) {
            currentImpl();
          } else if (typeof window.openLoginModal === 'function') {
            window.openLoginModal();
          } else if (typeof openLoginModal === 'function') {
            openLoginModal();
          }
        } catch (e) {
          console.warn('openGroupsModal error:', e);
        }
      }, 50);
    } else {
      // Utilisateur non connect√© - ouvrir le modal de connexion
      if (typeof window.openLoginModal === 'function') {
        window.openLoginModal();
      } else if (typeof openLoginModal === 'function') {
        openLoginModal();
      } else {
        // Attendre que openLoginModal soit disponible
        setTimeout(() => {
          if (typeof window.openLoginModal === 'function') {
            window.openLoginModal();
          } else if (typeof openLoginModal === 'function') {
            openLoginModal();
          }
        }, 100);
      }
    }
  } catch (e) {
    console.warn('openGroupsModal stub error:', e);
  }
};

// Stub pour sharePopup - sera remplac√© par l'impl√©mentation compl√®te plus tard
window.sharePopup = function(type, id) {
  try {
    if (!type || !id) {
      console.warn('sharePopup: type and id are required');
      return;
    }
    
    // V√©rifier si shareItem est disponible
    if (typeof shareItem === 'function') {
      shareItem(type, id);
    } else if (typeof window.shareItem === 'function') {
      window.shareItem(type, id);
    } else {
      // Attendre que shareItem soit disponible
      setTimeout(() => {
        try {
          if (typeof shareItem === 'function') {
            shareItem(type, id);
          } else if (typeof window.shareItem === 'function') {
            window.shareItem(type, id);
          } else {
            console.warn('sharePopup: shareItem not available yet');
          }
        } catch (e) {
          console.warn('sharePopup timeout error:', e);
        }
      }, 100);
    }
  } catch (e) {
    console.warn('sharePopup stub error:', e);
  }
};

// DICTIONNAIRE DE TRADUCTIONS COMPLET (d√©plac√© ici pour √™tre disponible avant initLanguage)
// ============================================
// CRITIQUE: Ne JAMAIS r√©assigner window.translations compl√®tement car cela cr√©e une TDZ
// Au lieu de cela, remplir progressivement les objets existants
// Initialiser d'abord avec un objet vide pour √©viter les erreurs TDZ
if (!window.translations) {
  window.translations = {};
}
SUPPORTED_LANGUAGES.forEach(lang => {
  if (!window.translations[lang] || typeof window.translations[lang] !== 'object') {
    window.translations[lang] = {};
  }
});

// CRITIQUE: Remplir progressivement au lieu de r√©assigner compl√®tement
// Cela √©vite toute TDZ car on modifie les objets existants au lieu de les remplacer
// CRITIQUE: Ne JAMAIS utiliser 'const translations' - utiliser un nom diff√©rent
const translationsDataObject = {
  fr: {
    // UI Topbar
    "filter": "Filtrer", "list": "Liste", "events": "Events", "booking": "Booking", "services": "Services",
    "agenda": "Agenda", "alerts": "ABOS", "account": "Compte", "cart": "Panier",
    "search_city": "Rechercher une ville...", "publish": "Publier",
    
    // Popups Events
    "event_title": "√âv√©nement", "date": "Date", "address": "Adresse", "description": "Description",
    "category": "Cat√©gorie", "organizer": "Organisateur", "price": "Prix", "free": "Gratuit",
    "add_to_agenda": "Ajouter √† mon agenda", "like": "J'aime", "favorite": "Favoris", "participate": "Participer",
    "leave_review": "Laisser un avis", "contact_ai": "Contact IA", "report": "Signaler",
    "participants": "participants", "registered": "Inscrit", "in_agenda": "Dans agenda",
    "share": "Partager", "route": "Itin√©raire", "review": "Avis", "contact": "Contact", "reviews": "avis",
    "ai_detected": "Publi√© par MapEvent", "check_source": "v√©rifier la source",
    "booking_link": "Lien de r√©servation", "rating": "Note",
    
    // Popups Booking
    "booking_title": "R√©servation", "artist": "Artiste", "level": "Niveau", "sound_preview": "Aper√ßu sonore",
    "get_contact": "Obtenir contact", "pay": "Payer", "view_subs": "Voir les abos", "add_to_cart": "Ajouter au panier",
    "verified": "V√©rifi√©", "website": "Site web", "email": "Email", "phone": "T√©l√©phone",
    
    // Popups Service
    "service_title": "Service", "company": "Entreprise", "contact_info": "Informations de contact",
    
    // Agenda
    "my_agenda": "Mon agenda", "my_favorites": "Mes favoris", "my_subscriptions": "Mes abonnements",
    "agenda_empty": "Votre agenda est vide", "add_from_map": "Ajoutez des √©v√©nements depuis la carte !",
    "remove_from_agenda": "Retirer de l'agenda",
    
    // Messages
    "city_found": "trouv√©e !", "city_not_found": "non trouv√©e", "searching": "Recherche de",
    "language_changed": "Langue chang√©e", "removed_from_agenda": "Retir√© de l'agenda",
    
    // Filtres
    "filter_by_date": "Filtrer par date", "today": "Aujourd'hui", "tomorrow": "Demain",
    "weekend": "Ce week-end", "week": "Cette semaine", "month": "Ce mois",
    "select_period": "Ou s√©lectionner une p√©riode", "from": "Du", "to": "Au",
    "reset_all": "R√©initialiser tout", "selected_categories": "Cat√©gories s√©lectionn√©es",
    "cumulative": "cumulable",
    
    // Formulaire de publication
    "publish_mode": "Publier ‚Äì Mode", "main_category": "Cat√©gorie principale", "choose_category": "Choisir cat√©gorie‚Ä¶",
    "start": "D√©but", "end": "Fin", "title_name": "Titre", "full_address": "Adresse compl√®te",
    "phone": "T√©l√©phone", "email": "Email", "full_description": "Description compl√®te",
    "main_photo": "Photo principale", "ticketing": "Billetterie", "ticket_link": "Lien billetterie",
    "social_links": "Liens r√©seaux", "video_links": "Liens vid√©os", "sound_links": "Liens sons (SoundCloud, YouTube, Spotify‚Ä¶)",
    "paste_sound_links": "Coller vos liens sons", "level": "Niveau (D√©butant, Pro, Headliner‚Ä¶)",
    "price_estimate": "Estimation de prix √† n√©gocier", "price_example": "ex: 500.‚Äì la soir√©e (√† n√©gocier)",
    "price_not_detected": "Si l'IA ne d√©tecte pas de prix ou a un doute : \"Estimation de prix non d√©tect√©e\".",
    "visibility_choice": "Choix de visibilit√© (paiement √† l'√©tape suivante) :",
    "standard_point": "1.‚Äì : Point standard sur la map + Event List.",
    "bronze_boost": "5.‚Äì Boost Bronze : Pointeur bronze, priorit√© dans la liste.",
    "silver_boost": "10.‚Äì Boost Silver : Pointeur argent, forte priorit√©.",
    "platinum_boost": "TOP 10 ‚Äì Boost Platinum : ench√®res, pointeur platine ultra visible.",
    "subscription_recommended": "üíé Abonnement recommand√©",
    "save_on_events": "√âconomisez sur vos publications events",
    "unlimited_contacts": "Contacts illimit√©s + r√©ductions",
    "view_subs": "Voir les abos",
    "publish_and_pay": "Publier et payer",
    
    // Autres
    "close": "Fermer", "save": "Enregistrer", "cancel": "Annuler", "confirm": "Confirmer",
    "loading": "Chargement...", "error": "Erreur", "success": "Succ√®s", "info": "Information",
    "translate": "Traduire", "hide_translation": "Masquer traduction", "translation_error": "Erreur de traduction",
    "try_again": "R√©essayez"
  },
  en: {
    "filter": "Filter", "list": "List", "events": "Events", "booking": "Booking", "services": "Services",
    "agenda": "Agenda", "alerts": "Alerts", "account": "Account", "cart": "Cart",
    "search_city": "Search for a city...", "publish": "Publish",
    "event_title": "Event", "date": "Date", "address": "Address", "description": "Description",
    "category": "Category", "organizer": "Organizer", "price": "Price", "free": "Free",
    "add_to_agenda": "Add to my agenda", "like": "Like", "favorite": "Favorites", "participate": "Participate",
    "leave_review": "Leave a review", "contact_ai": "AI Contact", "report": "Report",
    "participants": "participants", "registered": "Registered", "in_agenda": "In agenda",
    "share": "Share", "route": "Route", "review": "Review", "contact": "Contact", "reviews": "reviews",
    "ai_detected": "Detected by AI", "check_source": "Check source",
    "booking_link": "Booking link", "rating": "Rating",
    "booking_title": "Booking", "artist": "Artist", "level": "Level", "sound_preview": "Sound preview",
    "get_contact": "Get contact", "pay": "Pay", "view_subs": "View subscriptions", "add_to_cart": "Add to cart",
    "verified": "Verified", "website": "Website", "email": "Email", "phone": "Phone",
    "service_title": "Service", "company": "Company", "contact_info": "Contact information",
    "my_agenda": "My agenda", "my_favorites": "My favorites", "my_subscriptions": "My subscriptions",
    "agenda_empty": "Your agenda is empty", "add_from_map": "Add events from the map!",
    "remove_from_agenda": "Remove from agenda",
    "city_found": "found !", "city_not_found": "not found", "searching": "Searching for",
    "language_changed": "Language changed", "removed_from_agenda": "Removed from agenda",
    "filter_by_date": "Filter by date", "today": "Today", "tomorrow": "Tomorrow",
    "weekend": "This weekend", "week": "This week", "month": "This month",
    "select_period": "Or select a period", "from": "From", "to": "To",
    "reset_all": "Reset all", "selected_categories": "Selected categories",
    "cumulative": "cumulative",
    "publish_mode": "Publish ‚Äì Mode", "main_category": "Main category", "choose_category": "Choose category‚Ä¶",
    "start": "Start", "end": "End", "title_name": "Title", "full_address": "Full address",
    "phone": "Phone", "email": "Email", "full_description": "Full description",
    "main_photo": "Main photo", "ticketing": "Ticketing", "ticket_link": "Ticket link",
    "social_links": "Social links", "video_links": "Video links", "sound_links": "Sound links (SoundCloud, YouTube, Spotify‚Ä¶)",
    "paste_sound_links": "Paste your sound links", "level": "Level (Beginner, Pro, Headliner‚Ä¶)",
    "price_estimate": "Price estimate to negotiate", "price_example": "e.g.: 500.‚Äì per evening (to negotiate)",
    "price_not_detected": "If AI doesn't detect a price or has doubts: \"Price estimate not detected\".",
    "visibility_choice": "Visibility choice (payment at next step):",
    "standard_point": "1.‚Äì : Standard point on map + Event List.",
    "bronze_boost": "5.‚Äì Bronze Boost : Bronze pointer, priority in list.",
    "silver_boost": "10.‚Äì Silver Boost : Silver pointer, high priority.",
    "platinum_boost": "TOP 10 ‚Äì Platinum Boost : auctions, ultra-visible platinum pointer.",
    "subscription_recommended": "üíé Recommended subscription",
    "save_on_events": "Save on your event publications",
    "unlimited_contacts": "Unlimited contacts + discounts",
    "view_subs": "View subscriptions",
    "publish_and_pay": "Publish and pay",
    "close": "Close", "save": "Save", "cancel": "Cancel", "confirm": "Confirm",
    "loading": "Loading...", "error": "Error", "success": "Success", "info": "Information",
    "translate": "Translate", "hide_translation": "Hide translation", "translation_error": "Translation error",
    "try_again": "Try again"
  },
  es: {
    "filter": "Filtrar", "list": "Lista", "events": "Eventos", "booking": "Reservas", "services": "Servicios",
    "agenda": "Agenda", "alerts": "Alertas", "account": "Cuenta", "cart": "Carrito",
    "search_city": "Buscar una ciudad...", "publish": "Publicar",
    "event_title": "Evento", "date": "Fecha", "address": "Direcci√≥n", "description": "Descripci√≥n",
    "category": "Categor√≠a", "organizer": "Organizador", "price": "Precio", "free": "Gratis",
    "add_to_agenda": "A√±adir a mi agenda", "like": "Me gusta", "favorite": "Favoritos", "participate": "Participar",
    "leave_review": "Dejar una rese√±a", "contact_ai": "Contacto IA", "report": "Reportar",
    "participants": "participantes", "registered": "Inscrito", "in_agenda": "En agenda",
    "share": "Compartir", "route": "Ruta", "review": "Rese√±a", "contact": "Contacto", "reviews": "rese√±as",
    "ai_detected": "Detectado por IA", "check_source": "Verificar fuente",
    "booking_link": "Enlace de reserva", "rating": "Calificaci√≥n",
    "booking_title": "Reserva", "artist": "Artista", "level": "Nivel", "sound_preview": "Vista previa de sonido",
    "get_contact": "Obtener contacto", "pay": "Pagar", "view_subs": "Ver suscripciones", "add_to_cart": "A√±adir al carrito",
    "verified": "Verificado", "website": "Sitio web", "email": "Email", "phone": "Tel√©fono",
    "service_title": "Servicio", "company": "Empresa", "contact_info": "Informaci√≥n de contacto",
    "my_agenda": "Mi agenda", "my_favorites": "Mis favoritos", "my_subscriptions": "Mis suscripciones",
    "agenda_empty": "Tu agenda est√° vac√≠a", "add_from_map": "¬°A√±ade eventos desde el mapa!",
    "remove_from_agenda": "Quitar de la agenda",
    "city_found": "encontrada !", "city_not_found": "no encontrada", "searching": "Buscando",
    "language_changed": "Idioma cambiado", "removed_from_agenda": "Eliminado de la agenda",
    "filter_by_date": "Filtrar por fecha", "today": "Hoy", "tomorrow": "Ma√±ana",
    "weekend": "Este fin de semana", "week": "Esta semana", "month": "Este mes",
    "select_period": "O seleccionar un per√≠odo", "from": "Desde", "to": "Hasta",
    "reset_all": "Restablecer todo", "selected_categories": "Categor√≠as seleccionadas",
    "cumulative": "acumulable",
    "close": "Cerrar", "save": "Guardar", "cancel": "Cancelar", "confirm": "Confirmar",
    "loading": "Cargando...", "error": "Error", "success": "√âxito", "info": "Informaci√≥n",
    "translate": "Traducir", "hide_translation": "Ocultar traducci√≥n", "translation_error": "Error de traducci√≥n",
    "try_again": "Intentar de nuevo"
  },
  zh: {
    "filter": "Á≠õÈÄâ", "list": "ÂàóË°®", "events": "Ê¥ªÂä®", "booking": "È¢ÑËÆ¢", "services": "ÊúçÂä°",
    "agenda": "Êó•Á®ã", "alerts": "ÊèêÈÜí", "account": "Ë¥¶Êà∑", "cart": "Ë¥≠Áâ©ËΩ¶",
    "search_city": "ÊêúÁ¥¢ÂüéÂ∏Ç...", "publish": "ÂèëÂ∏É",
    "event_title": "Ê¥ªÂä®", "date": "Êó•Êúü", "address": "Âú∞ÂùÄ", "description": "ÊèèËø∞",
    "category": "Á±ªÂà´", "organizer": "ÁªÑÁªáËÄÖ", "price": "‰ª∑Ê†º", "free": "ÂÖçË¥π",
    "add_to_agenda": "Ê∑ªÂä†Âà∞ÊàëÁöÑÊó•Á®ã", "like": "ÂñúÊ¨¢", "favorite": "Êî∂Ëóè", "participate": "ÂèÇ‰∏é",
    "leave_review": "Áïô‰∏ãËØÑËÆ∫", "contact_ai": "AIËÅîÁ≥ª", "report": "‰∏æÊä•",
    "participants": "ÂèÇ‰∏éËÄÖ", "registered": "Â∑≤Ê≥®ÂÜå", "in_agenda": "Âú®Êó•Á®ã‰∏≠",
    "share": "ÂàÜ‰∫´", "route": "Ë∑ØÁ∫ø", "review": "ËØÑËÆ∫", "contact": "ËÅîÁ≥ª", "reviews": "ËØÑËÆ∫",
    "ai_detected": "AIÊ£ÄÊµã", "check_source": "Ê£ÄÊü•Êù•Ê∫ê",
    "booking_link": "È¢ÑËÆ¢ÈìæÊé•", "rating": "ËØÑÂàÜ",
    "booking_title": "È¢ÑËÆ¢", "artist": "Ëâ∫ÊúØÂÆ∂", "level": "Á∫ßÂà´", "sound_preview": "Â£∞Èü≥È¢ÑËßà",
    "get_contact": "Ëé∑ÂèñËÅîÁ≥ªÊñπÂºè", "pay": "ÊîØ‰ªò", "view_subs": "Êü•ÁúãËÆ¢ÈòÖ", "add_to_cart": "Ê∑ªÂä†Âà∞Ë¥≠Áâ©ËΩ¶",
    "verified": "Â∑≤È™åËØÅ", "website": "ÁΩëÁ´ô", "email": "ÁîµÂ≠êÈÇÆ‰ª∂", "phone": "ÁîµËØù",
    "service_title": "ÊúçÂä°", "company": "ÂÖ¨Âè∏", "contact_info": "ËÅîÁ≥ª‰ø°ÊÅØ",
    "my_agenda": "ÊàëÁöÑÊó•Á®ã", "my_favorites": "ÊàëÁöÑÊî∂Ëóè", "my_subscriptions": "ÊàëÁöÑËÆ¢ÈòÖ",
    "agenda_empty": "ÊÇ®ÁöÑÊó•Á®ã‰∏∫Á©∫", "add_from_map": "‰ªéÂú∞ÂõæÊ∑ªÂä†Ê¥ªÂä®ÔºÅ",
    "remove_from_agenda": "‰ªéÊó•Á®ã‰∏≠ÁßªÈô§",
    "city_found": "Â∑≤ÊâæÂà∞ÔºÅ", "city_not_found": "Êú™ÊâæÂà∞", "searching": "Ê≠£Âú®ÊêúÁ¥¢",
    "language_changed": "ËØ≠Ë®ÄÂ∑≤Êõ¥Êîπ", "removed_from_agenda": "Â∑≤‰ªéÊó•Á®ã‰∏≠ÁßªÈô§",
    "filter_by_date": "ÊåâÊó•ÊúüÁ≠õÈÄâ", "today": "‰ªäÂ§©", "tomorrow": "ÊòéÂ§©",
    "weekend": "Êú¨Âë®Êú´", "week": "Êú¨Âë®", "month": "Êú¨Êúà",
    "select_period": "ÊàñÈÄâÊã©Êó∂Èó¥ÊÆµ", "from": "‰ªé", "to": "Âà∞",
    "reset_all": "ÈáçÁΩÆÂÖ®ÈÉ®", "selected_categories": "Â∑≤ÈÄâÁ±ªÂà´",
    "cumulative": "Á¥ØÁßØ",
    "close": "ÂÖ≥Èó≠", "save": "‰øùÂ≠ò", "cancel": "ÂèñÊ∂à", "confirm": "Á°ÆËÆ§",
    "loading": "Âä†ËΩΩ‰∏≠...", "error": "ÈîôËØØ", "success": "ÊàêÂäü", "info": "‰ø°ÊÅØ",
    "translate": "ÁøªËØë", "hide_translation": "ÈöêËóèÁøªËØë", "translation_error": "ÁøªËØëÈîôËØØ",
    "try_again": "ÈáçËØï"
  },
  hi: {
    "filter": "‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞", "list": "‡§∏‡•Ç‡§ö‡•Ä", "events": "‡§á‡§µ‡•á‡§Ç‡§ü‡•ç‡§∏", "booking": "‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó", "services": "‡§∏‡•á‡§µ‡§æ‡§è‡§Ç",
    "agenda": "‡§è‡§ú‡•á‡§Ç‡§°‡§æ", "alerts": "‡§Ö‡§≤‡§∞‡•ç‡§ü", "account": "‡§ñ‡§æ‡§§‡§æ", "cart": "‡§ï‡§æ‡§∞‡•ç‡§ü",
    "search_city": "‡§∂‡§π‡§∞ ‡§ñ‡•ã‡§ú‡•á‡§Ç...", "publish": "‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç",
    "event_title": "‡§á‡§µ‡•á‡§Ç‡§ü", "date": "‡§§‡§æ‡§∞‡•Ä‡§ñ", "address": "‡§™‡§§‡§æ", "description": "‡§µ‡§ø‡§µ‡§∞‡§£",
    "category": "‡§∂‡•ç‡§∞‡•á‡§£‡•Ä", "organizer": "‡§Ü‡§Ø‡•ã‡§ú‡§ï", "price": "‡§Æ‡•Ç‡§≤‡•ç‡§Ø", "free": "‡§Æ‡•Å‡§´‡•ç‡§§",
    "add_to_agenda": "‡§Æ‡•á‡§∞‡•á ‡§è‡§ú‡•á‡§Ç‡§°‡§æ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç", "like": "‡§™‡§∏‡§Ç‡§¶", "favorite": "‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ", "participate": "‡§≠‡§æ‡§ó ‡§≤‡•á‡§Ç",
    "leave_review": "‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§õ‡•ã‡§°‡§º‡•á‡§Ç", "contact_ai": "AI ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï", "report": "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü",
    "participants": "‡§™‡•ç‡§∞‡§§‡§ø‡§≠‡§æ‡§ó‡•Ä", "registered": "‡§™‡§Ç‡§ú‡•Ä‡§ï‡•É‡§§", "in_agenda": "‡§è‡§ú‡•á‡§Ç‡§°‡§æ ‡§Æ‡•á‡§Ç",
    "share": "‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç", "route": "‡§Æ‡§æ‡§∞‡•ç‡§ó", "review": "‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ", "contact": "‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï", "reviews": "‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ‡§è‡§Ç",
    "ai_detected": "AI ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ", "check_source": "‡§∏‡•ç‡§∞‡•ã‡§§ ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç",
    "booking_link": "‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§≤‡§ø‡§Ç‡§ï", "rating": "‡§∞‡•á‡§ü‡§ø‡§Ç‡§ó",
    "booking_title": "‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó", "artist": "‡§ï‡§≤‡§æ‡§ï‡§æ‡§∞", "level": "‡§∏‡•ç‡§§‡§∞", "sound_preview": "‡§ß‡•ç‡§µ‡§®‡§ø ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§µ‡§≤‡•ã‡§ï‡§®",
    "get_contact": "‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç", "pay": "‡§≠‡•Å‡§ó‡§§‡§æ‡§®", "view_subs": "‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§¶‡•á‡§ñ‡•á‡§Ç", "add_to_cart": "‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
    "verified": "‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§", "website": "‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü", "email": "‡§à‡§Æ‡•á‡§≤", "phone": "‡§´‡§º‡•ã‡§®",
    "service_title": "‡§∏‡•á‡§µ‡§æ", "company": "‡§ï‡§Ç‡§™‡§®‡•Ä", "contact_info": "‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä",
    "my_agenda": "‡§Æ‡•á‡§∞‡§æ ‡§è‡§ú‡•á‡§Ç‡§°‡§æ", "my_favorites": "‡§Æ‡•á‡§∞‡•á ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ", "my_subscriptions": "‡§Æ‡•á‡§∞‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ‡§è‡§Ç",
    "agenda_empty": "‡§Ü‡§™‡§ï‡§æ ‡§è‡§ú‡•á‡§Ç‡§°‡§æ ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à", "add_from_map": "‡§Æ‡§æ‡§®‡§ö‡§ø‡§§‡•ç‡§∞ ‡§∏‡•á ‡§á‡§µ‡•á‡§Ç‡§ü ‡§ú‡•ã‡§°‡§º‡•á‡§Ç!",
    "remove_from_agenda": "‡§è‡§ú‡•á‡§Ç‡§°‡§æ ‡§∏‡•á ‡§π‡§ü‡§æ‡§è‡§Ç",
    "city_found": "‡§Æ‡§ø‡§≤ ‡§ó‡§Ø‡§æ !", "city_not_found": "‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ", "searching": "‡§ñ‡•ã‡§ú ‡§∞‡§π‡•á ‡§π‡•à‡§Ç",
    "language_changed": "‡§≠‡§æ‡§∑‡§æ ‡§¨‡§¶‡§≤‡•Ä", "removed_from_agenda": "‡§è‡§ú‡•á‡§Ç‡§°‡§æ ‡§∏‡•á ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ",
    "filter_by_date": "‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§∏‡•á ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç", "today": "‡§Ü‡§ú", "tomorrow": "‡§ï‡§≤",
    "weekend": "‡§á‡§∏ ‡§∏‡§™‡•ç‡§§‡§æ‡§π‡§æ‡§Ç‡§§", "week": "‡§á‡§∏ ‡§∏‡§™‡•ç‡§§‡§æ‡§π", "month": "‡§á‡§∏ ‡§Æ‡§π‡•Ä‡§®‡•á",
    "select_period": "‡§Ø‡§æ ‡§è‡§ï ‡§Ö‡§µ‡§ß‡§ø ‡§ö‡•Å‡§®‡•á‡§Ç", "from": "‡§∏‡•á", "to": "‡§§‡§ï",
    "reset_all": "‡§∏‡§≠‡•Ä ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç", "selected_categories": "‡§ö‡§Ø‡§®‡§ø‡§§ ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç",
    "cumulative": "‡§∏‡§Ç‡§ö‡§Ø‡•Ä",
    "close": "‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç", "save": "‡§∏‡§π‡•á‡§ú‡•á‡§Ç", "cancel": "‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç", "confirm": "‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç",
    "loading": "‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...", "error": "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø", "success": "‡§∏‡§´‡§≤‡§§‡§æ", "info": "‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä",
    "translate": "‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶ ‡§ï‡§∞‡•á‡§Ç", "hide_translation": "‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶ ‡§õ‡•Å‡§™‡§æ‡§è‡§Ç", "translation_error": "‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø",
    "try_again": "‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç"
  },
  de: { "filter": "Filtern", "list": "Liste", "events": "Events", "booking": "Booking", "services": "Dienste", "agenda": "Agenda", "alerts": "Abos", "account": "Konto", "cart": "Warenkorb", "search_city": "Stadt suchen...", "publish": "Ver√∂ffentlichen", "event_title": "Event", "date": "Datum", "address": "Adresse", "description": "Beschreibung", "category": "Kategorie", "organizer": "Veranstalter", "price": "Preis", "free": "Kostenlos", "add_to_agenda": "Zu meinem Kalender", "like": "Gef√§llt mir", "favorite": "Favoriten", "participate": "Teilnehmen", "leave_review": "Bewertung schreiben", "contact_ai": "KI-Kontakt", "report": "Melden", "participants": "Teilnehmer", "registered": "Registriert", "in_agenda": "Im Kalender", "share": "Teilen", "route": "Route", "review": "Bewertung", "contact": "Kontakt", "reviews": "Bewertungen", "ai_detected": "Von KI erkannt", "check_source": "Quelle pr√ºfen", "booking_link": "Buchungslink", "rating": "Bewertung", "booking_title": "Buchung", "artist": "K√ºnstler", "level": "Niveau", "sound_preview": "H√∂rprobe", "get_contact": "Kontakt", "pay": "Bezahlen", "view_subs": "Abos anzeigen", "add_to_cart": "In den Warenkorb", "verified": "Verifiziert", "website": "Webseite", "email": "E-Mail", "phone": "Telefon", "service_title": "Dienstleistung", "company": "Unternehmen", "contact_info": "Kontakt", "my_agenda": "Mein Kalender", "my_favorites": "Favoriten", "my_subscriptions": "Abos", "agenda_empty": "Kalender leer", "add_from_map": "Events von der Karte hinzuf√ºgen!", "remove_from_agenda": "Aus Kalender entfernen", "city_found": "gefunden!", "city_not_found": "nicht gefunden", "searching": "Suche", "language_changed": "Sprache ge√§ndert", "removed_from_agenda": "Aus Kalender entfernt", "filter_by_date": "Nach Datum filtern", "today": "Heute", "tomorrow": "Morgen", "weekend": "Dieses Wochenende", "week": "Diese Woche", "month": "Diesen Monat", "select_period": "Zeitraum w√§hlen", "from": "Von", "to": "Bis", "reset_all": "Zur√ºcksetzen", "selected_categories": "Kategorien", "cumulative": "kumulativ", "publish_mode": "Ver√∂ffentlichen ‚Äì Modus", "main_category": "Hauptkategorie", "choose_category": "Kategorie w√§hlen‚Ä¶", "start": "Start", "end": "Ende", "title_name": "Titel", "full_address": "Adresse", "full_description": "Beschreibung", "main_photo": "Hauptfoto", "ticketing": "Ticketing", "ticket_link": "Ticket-Link", "social_links": "Soziale Links", "video_links": "Video-Links", "sound_links": "Sound-Links", "paste_sound_links": "Sound-Links einf√ºgen", "price_estimate": "Preissch√§tzung", "price_example": "z. B. 500.‚Äì pro Abend", "price_not_detected": "Preis nicht erkannt.", "visibility_choice": "Sichtbarkeit (Zahlung im n√§chsten Schritt):", "standard_point": "1.‚Äì : Standard-Punkt", "bronze_boost": "5.‚Äì Bronze", "silver_boost": "10.‚Äì Silber", "platinum_boost": "TOP 10 ‚Äì Platin", "subscription_recommended": "üíé Abo empfohlen", "save_on_events": "Sparen bei Events", "unlimited_contacts": "Unbegrenzte Kontakte", "publish_and_pay": "Ver√∂ffentlichen und zahlen", "close": "Schlie√üen", "save": "Speichern", "cancel": "Abbrechen", "confirm": "Best√§tigen", "loading": "Laden...", "error": "Fehler", "success": "Erfolg", "info": "Info", "translate": "√úbersetzen", "hide_translation": "√úbersetzung ausblenden", "translation_error": "√úbersetzungsfehler", "try_again": "Erneut versuchen" },
  it: { "filter": "Filtra", "list": "Lista", "events": "Eventi", "booking": "Booking", "services": "Servizi", "agenda": "Agenda", "alerts": "Abos", "account": "Account", "cart": "Carrello", "search_city": "Cerca citt√†...", "publish": "Pubblica", "event_title": "Evento", "date": "Data", "address": "Indirizzo", "description": "Descrizione", "category": "Categoria", "organizer": "Organizzatore", "price": "Prezzo", "free": "Gratis", "add_to_agenda": "Aggiungi al calendario", "like": "Mi piace", "favorite": "Preferiti", "participate": "Partecipa", "leave_review": "Lascia una recensione", "contact_ai": "Contatto IA", "report": "Segnala", "participants": "partecipanti", "registered": "Iscritto", "in_agenda": "In agenda", "share": "Condividi", "route": "Percorso", "review": "Recensione", "contact": "Contatto", "reviews": "recensioni", "ai_detected": "Rilevato da IA", "check_source": "Verifica fonte", "booking_link": "Link prenotazione", "rating": "Valutazione", "booking_title": "Prenotazione", "artist": "Artista", "level": "Livello", "sound_preview": "Anteprima audio", "get_contact": "Contatto", "pay": "Paga", "view_subs": "Abbonamenti", "add_to_cart": "Aggiungi al carrello", "verified": "Verificato", "website": "Sito web", "email": "Email", "phone": "Telefono", "service_title": "Servizio", "company": "Azienda", "contact_info": "Contatti", "my_agenda": "La mia agenda", "my_favorites": "Preferiti", "my_subscriptions": "Abbonamenti", "agenda_empty": "Agenda vuota", "add_from_map": "Aggiungi eventi dalla mappa!", "remove_from_agenda": "Rimuovi da agenda", "city_found": "trovata!", "city_not_found": "non trovata", "searching": "Ricerca", "language_changed": "Lingua cambiata", "removed_from_agenda": "Rimosso da agenda", "filter_by_date": "Filtra per data", "today": "Oggi", "tomorrow": "Domani", "weekend": "Questo weekend", "week": "Questa settimana", "month": "Questo mese", "select_period": "Seleziona periodo", "from": "Da", "to": "A", "reset_all": "Reimposta", "selected_categories": "Categorie", "cumulative": "cumulativo", "publish_mode": "Pubblica ‚Äì Modo", "main_category": "Categoria principale", "choose_category": "Scegli categoria‚Ä¶", "start": "Inizio", "end": "Fine", "title_name": "Titolo", "full_address": "Indirizzo completo", "full_description": "Descrizione", "main_photo": "Foto principale", "ticketing": "Biglietteria", "ticket_link": "Link biglietti", "social_links": "Link social", "video_links": "Link video", "sound_links": "Link audio", "paste_sound_links": "Incolla link audio", "price_estimate": "Stima prezzo", "price_example": "es. 500.‚Äì a serata", "price_not_detected": "Prezzo non rilevato.", "visibility_choice": "Visibilit√† (pagamento al passo successivo):", "standard_point": "1.‚Äì : Punto standard", "bronze_boost": "5.‚Äì Bronze", "silver_boost": "10.‚Äì Argento", "platinum_boost": "TOP 10 ‚Äì Platino", "subscription_recommended": "üíé Abbonamento consigliato", "save_on_events": "Risparmia sugli eventi", "unlimited_contacts": "Contatti illimitati", "publish_and_pay": "Pubblica e paga", "close": "Chiudi", "save": "Salva", "cancel": "Annulla", "confirm": "Conferma", "loading": "Caricamento...", "error": "Errore", "success": "Successo", "info": "Info", "translate": "Traduci", "hide_translation": "Nascondi traduzione", "translation_error": "Errore traduzione", "try_again": "Riprova" },
  pt: { "filter": "Filtrar", "list": "Lista", "events": "Eventos", "booking": "Reservas", "services": "Servi√ßos", "agenda": "Agenda", "alerts": "Alertas", "account": "Conta", "cart": "Carrinho", "search_city": "Pesquisar cidade...", "publish": "Publicar", "event_title": "Evento", "date": "Data", "address": "Morada", "description": "Descri√ß√£o", "category": "Categoria", "organizer": "Organizador", "price": "Pre√ßo", "free": "Gr√°tis", "add_to_agenda": "Adicionar √† agenda", "like": "Gosto", "favorite": "Favoritos", "participate": "Participar", "leave_review": "Deixar avalia√ß√£o", "contact_ai": "Contacto IA", "report": "Reportar", "participants": "participantes", "registered": "Inscrito", "in_agenda": "Na agenda", "share": "Partilhar", "route": "Percurso", "review": "Avalia√ß√£o", "contact": "Contacto", "reviews": "avalia√ß√µes", "ai_detected": "Detetado por IA", "check_source": "Verificar fonte", "booking_link": "Link reserva", "rating": "Classifica√ß√£o", "booking_title": "Reserva", "artist": "Artista", "level": "N√≠vel", "sound_preview": "Pr√©-visualiza√ß√£o √°udio", "get_contact": "Obter contacto", "pay": "Pagar", "view_subs": "Ver subscri√ß√µes", "add_to_cart": "Adicionar ao carrinho", "verified": "Verificado", "website": "Site", "email": "Email", "phone": "Telefone", "service_title": "Servi√ßo", "company": "Empresa", "contact_info": "Contacto", "my_agenda": "A minha agenda", "my_favorites": "Favoritos", "my_subscriptions": "Subscri√ß√µes", "agenda_empty": "Agenda vazia", "add_from_map": "Adicione eventos do mapa!", "remove_from_agenda": "Remover da agenda", "city_found": "encontrada!", "city_not_found": "n√£o encontrada", "searching": "A pesquisar", "language_changed": "Idioma alterado", "removed_from_agenda": "Removido da agenda", "filter_by_date": "Filtrar por data", "today": "Hoje", "tomorrow": "Amanh√£", "weekend": "Este fim de semana", "week": "Esta semana", "month": "Este m√™s", "select_period": "Ou selecionar per√≠odo", "from": "De", "to": "At√©", "reset_all": "Repor", "selected_categories": "Categorias", "cumulative": "acumul√°vel", "publish_mode": "Publicar ‚Äì Modo", "main_category": "Categoria principal", "choose_category": "Escolher categoria‚Ä¶", "start": "In√≠cio", "end": "Fim", "title_name": "T√≠tulo", "full_address": "Morada completa", "full_description": "Descri√ß√£o", "main_photo": "Foto principal", "ticketing": "Bilhetes", "ticket_link": "Link bilhetes", "social_links": "Redes sociais", "video_links": "Links v√≠deo", "sound_links": "Links √°udio", "paste_sound_links": "Colar links √°udio", "price_estimate": "Estimativa de pre√ßo", "price_example": "ex.: 500.‚Äì por noite", "price_not_detected": "Pre√ßo n√£o detetado.", "visibility_choice": "Visibilidade (pagamento no pr√≥ximo passo):", "standard_point": "1.‚Äì : Ponto standard", "bronze_boost": "5.‚Äì Bronze", "silver_boost": "10.‚Äì Prata", "platinum_boost": "TOP 10 ‚Äì Platina", "subscription_recommended": "üíé Subscri√ß√£o recomendada", "save_on_events": "Poupe em eventos", "unlimited_contacts": "Contactos ilimitados", "publish_and_pay": "Publicar e pagar", "close": "Fechar", "save": "Guardar", "cancel": "Cancelar", "confirm": "Confirmar", "loading": "A carregar...", "error": "Erro", "success": "Sucesso", "info": "Informa√ß√£o", "translate": "Traduzir", "hide_translation": "Ocultar tradu√ß√£o", "translation_error": "Erro de tradu√ß√£o", "try_again": "Tentar novamente" },
  ru: { "filter": "–§–∏–ª—å—Ç—Ä", "list": "–°–ø–∏—Å–æ–∫", "events": "–°–æ–±—ã—Ç–∏—è", "booking": "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "services": "–£—Å–ª—É–≥–∏", "agenda": "–ö–∞–ª–µ–Ω–¥–∞—Ä—å", "alerts": "–û–ø–æ–≤–µ—â–µ–Ω–∏—è", "account": "–ê–∫–∫–∞—É–Ω—Ç", "cart": "–ö–æ—Ä–∑–∏–Ω–∞", "search_city": "–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞...", "publish": "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å", "event_title": "–°–æ–±—ã—Ç–∏–µ", "date": "–î–∞—Ç–∞", "address": "–ê–¥—Ä–µ—Å", "description": "–û–ø–∏—Å–∞–Ω–∏–µ", "category": "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "organizer": "–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä", "price": "–¶–µ–Ω–∞", "free": "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ", "add_to_agenda": "–í –∫–∞–ª–µ–Ω–¥–∞—Ä—å", "like": "–ù—Ä–∞–≤–∏—Ç—Å—è", "favorite": "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ", "participate": "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å", "leave_review": "–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤", "contact_ai": "–ö–æ–Ω—Ç–∞–∫—Ç –ò–ò", "report": "–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è", "participants": "—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", "registered": "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω", "in_agenda": "–í –∫–∞–ª–µ–Ω–¥–∞—Ä–µ", "share": "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è", "route": "–ú–∞—Ä—à—Ä—É—Ç", "review": "–û—Ç–∑—ã–≤", "contact": "–ö–æ–Ω—Ç–∞–∫—Ç", "reviews": "–æ—Ç–∑—ã–≤–æ–≤", "ai_detected": "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –ò–ò", "check_source": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫", "booking_link": "–°—Å—ã–ª–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è", "rating": "–†–µ–π—Ç–∏–Ω–≥", "booking_title": "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "artist": "–ê—Ä—Ç–∏—Å—Ç", "level": "–£—Ä–æ–≤–µ–Ω—å", "sound_preview": "–ü—Ä–æ—Å–ª—É—à–∞—Ç—å", "get_contact": "–ö–æ–Ω—Ç–∞–∫—Ç", "pay": "–û–ø–ª–∞—Ç–∏—Ç—å", "view_subs": "–ü–æ–¥–ø–∏—Å–∫–∏", "add_to_cart": "–í –∫–æ—Ä–∑–∏–Ω—É", "verified": "–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ", "website": "–°–∞–π—Ç", "email": "Email", "phone": "–¢–µ–ª–µ—Ñ–æ–Ω", "service_title": "–£—Å–ª—É–≥–∞", "company": "–ö–æ–º–ø–∞–Ω–∏—è", "contact_info": "–ö–æ–Ω—Ç–∞–∫—Ç—ã", "my_agenda": "–ú–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å", "my_favorites": "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ", "my_subscriptions": "–ü–æ–¥–ø–∏—Å–∫–∏", "agenda_empty": "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—É—Å—Ç", "add_from_map": "–î–æ–±–∞–≤—å—Ç–µ —Å–æ–±—ã—Ç–∏—è —Å –∫–∞—Ä—Ç—ã!", "remove_from_agenda": "–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è", "city_found": "–Ω–∞–π–¥–µ–Ω–æ!", "city_not_found": "–Ω–µ –Ω–∞–π–¥–µ–Ω–æ", "searching": "–ü–æ–∏—Å–∫", "language_changed": "–Ø–∑—ã–∫ –∏–∑–º–µ–Ω—ë–Ω", "removed_from_agenda": "–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è", "filter_by_date": "–ü–æ –¥–∞—Ç–µ", "today": "–°–µ–≥–æ–¥–Ω—è", "tomorrow": "–ó–∞–≤—Ç—Ä–∞", "weekend": "–í —ç—Ç–∏ –≤—ã—Ö–æ–¥–Ω—ã–µ", "week": "–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ", "month": "–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ", "select_period": "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥", "from": "–°", "to": "–ü–æ", "reset_all": "–°–±—Ä–æ—Å–∏—Ç—å", "selected_categories": "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏", "cumulative": "—Å—É–º–º–∞—Ä–Ω–æ", "publish_mode": "–ü—É–±–ª–∏–∫–∞—Ü–∏—è ‚Äì –†–µ–∂–∏–º", "main_category": "–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è", "choose_category": "–í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é‚Ä¶", "start": "–ù–∞—á–∞–ª–æ", "end": "–ö–æ–Ω–µ—Ü", "title_name": "–ù–∞–∑–≤–∞–Ω–∏–µ", "full_address": "–ê–¥—Ä–µ—Å", "full_description": "–û–ø–∏—Å–∞–Ω–∏–µ", "main_photo": "–§–æ—Ç–æ", "ticketing": "–ë–∏–ª–µ—Ç—ã", "ticket_link": "–°—Å—ã–ª–∫–∞ –Ω–∞ –±–∏–ª–µ—Ç—ã", "social_links": "–°–æ—Ü—Å–µ—Ç–∏", "video_links": "–í–∏–¥–µ–æ", "sound_links": "–ê—É–¥–∏–æ", "paste_sound_links": "–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫–∏", "price_estimate": "–û—Ä–∏–µ–Ω—Ç–∏—Ä —Ü–µ–Ω—ã", "price_example": "–Ω–∞–ø—Ä. 500.‚Äì –∑–∞ –≤–µ—á–µ—Ä", "price_not_detected": "–¶–µ–Ω–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞.", "visibility_choice": "–í–∏–¥–∏–º–æ—Å—Ç—å (–æ–ø–ª–∞—Ç–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ):", "standard_point": "1.‚Äì : –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ç–æ—á–∫–∞", "bronze_boost": "5.‚Äì –ë—Ä–æ–Ω–∑–∞", "silver_boost": "10.‚Äì –°–µ—Ä–µ–±—Ä–æ", "platinum_boost": "TOP 10 ‚Äì –ü–ª–∞—Ç–∏–Ω–∞", "subscription_recommended": "üíé –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É", "save_on_events": "–≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è—Ö", "unlimited_contacts": "–ë–µ–∑–ª–∏–º–∏—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤", "publish_and_pay": "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å", "close": "–ó–∞–∫—Ä—ã—Ç—å", "save": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "cancel": "–û—Ç–º–µ–Ω–∞", "confirm": "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", "loading": "–ó–∞–≥—Ä—É–∑–∫–∞...", "error": "–û—à–∏–±–∫–∞", "success": "–£—Å–ø–µ—Ö", "info": "–ò–Ω—Ñ–æ", "translate": "–ü–µ—Ä–µ–≤–µ—Å—Ç–∏", "hide_translation": "–°–∫—Ä—ã—Ç—å –ø–µ—Ä–µ–≤–æ–¥", "translation_error": "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞", "try_again": "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å" }
};

// CRITIQUE: Remplir progressivement window.translations au lieu de le r√©assigner
// Cela √©vite toute TDZ car on modifie les objets existants
Object.keys(translationsDataObject).forEach(lang => {
  if (window.translations[lang] && typeof window.translations[lang] === 'object') {
    Object.assign(window.translations[lang], translationsDataObject[lang]);
  } else {
    window.translations[lang] = translationsDataObject[lang];
  }
});

// S'assurer que window.translations est toujours un objet valide apr√®s assignation
if (!window.translations || typeof window.translations !== 'object') {
  window.translations = {};
  SUPPORTED_LANGUAGES.forEach(lang => { window.translations[lang] = {}; });
}
SUPPORTED_LANGUAGES.forEach(lang => {
  if (!window.translations[lang] || typeof window.translations[lang] !== 'object') {
    window.translations[lang] = window.translations[lang] || {};
  }
  // Langues sans dictionnaire complet : h√©riter de l'anglais (fallback mondial)
  if (window.translations.en && Object.keys(window.translations[lang]).length < 10) {
    window.translations[lang] = Object.assign({}, window.translations.en, window.translations[lang]);
  }
});

// CRITIQUE: window.translations est maintenant rempli directement ci-dessus (ligne 160)
// Pas besoin d'Object.assign car nous assignons directement √† window.translations
// La fonction window.t() est d√©j√† d√©finie plus haut (ligne 65) et utilise window.translations
// Elle fonctionnera automatiquement maintenant que window.translations est rempli

// Les fonctions sharePopup et openGroupsModal sont d√©j√† d√©finies plus haut (lignes 87-156)
// Elles seront remplac√©es par les impl√©mentations compl√®tes plus tard dans le fichier

let eventsData = [];
let bookingsData = [];
let servicesData = [];

// Exposer les donn√©es globalement pour le script de m√©tadonn√©es
window.eventsData = eventsData;
window.bookingsData = bookingsData;
window.servicesData = servicesData;

let filteredData = null;
let leftPanelOpen = false;
let listViewOpen = false;
let selectedCityForSorting = null; // Ville s√©lectionn√©e pour le tri par distance

let uiThemeIndex = 0;
let mapThemeIndex = 0;

// Custom theme config (couleurs personnalisees par l'utilisateur)
window.customThemeConfig = null;
// Charger depuis localStorage en fallback
try {
  const saved = localStorage.getItem('customThemeConfig');
  if (saved) window.customThemeConfig = JSON.parse(saved);
} catch(e) {}

// Arbres pour logique image
let EVENTS_TREE = null;
let BOOKING_TREE = null;
let SERVICE_TREE = null;

// --- CONFIGURATION CONTACT ---
const MAPEVENT_CONTACT_EMAIL = "mapevent777@gmail.com";

// --- 30+ AVATARS DISPONIBLES ---
const AVAILABLE_AVATARS = [
  // Personnages
  { id: 1, emoji: "ü¶ä", name: "Renard", category: "animaux" },
  { id: 2, emoji: "üê∫", name: "Loup", category: "animaux" },
  { id: 3, emoji: "ü¶Å", name: "Lion", category: "animaux" },
  { id: 4, emoji: "üêØ", name: "Tigre", category: "animaux" },
  { id: 5, emoji: "üêª", name: "Ours", category: "animaux" },
  { id: 6, emoji: "üêº", name: "Panda", category: "animaux" },
  { id: 7, emoji: "üê®", name: "Koala", category: "animaux" },
  { id: 8, emoji: "ü¶Ñ", name: "Licorne", category: "fantaisie" },
  { id: 9, emoji: "üêâ", name: "Dragon", category: "fantaisie" },
  { id: 10, emoji: "ü¶Ö", name: "Aigle", category: "animaux" },
  { id: 11, emoji: "ü¶ã", name: "Papillon", category: "animaux" },
  { id: 12, emoji: "üê¨", name: "Dauphin", category: "animaux" },
  { id: 13, emoji: "ü¶à", name: "Requin", category: "animaux" },
  { id: 14, emoji: "üêô", name: "Pieuvre", category: "animaux" },
  { id: 15, emoji: "ü¶ú", name: "Perroquet", category: "animaux" },
  // Musique & F√™te
  { id: 16, emoji: "üéß", name: "DJ", category: "musique" },
  { id: 17, emoji: "üé∏", name: "Rockeur", category: "musique" },
  { id: 18, emoji: "üé§", name: "Chanteur", category: "musique" },
  { id: 19, emoji: "üéπ", name: "Pianiste", category: "musique" },
  { id: 20, emoji: "ü•Å", name: "Batteur", category: "musique" },
  { id: 21, emoji: "üé∑", name: "Saxophoniste", category: "musique" },
  { id: 22, emoji: "üé∫", name: "Trompettiste", category: "musique" },
  // Personnages humains stylis√©s
  { id: 23, emoji: "üßô", name: "Mage", category: "fantaisie" },
  { id: 24, emoji: "üßö", name: "F√©e", category: "fantaisie" },
  { id: 25, emoji: "üßõ", name: "Vampire", category: "fantaisie" },
  { id: 26, emoji: "üßü", name: "Zombie", category: "fantaisie" },
  { id: 27, emoji: "üëª", name: "Fant√¥me", category: "fantaisie" },
  { id: 28, emoji: "üëΩ", name: "Alien", category: "fantaisie" },
  { id: 29, emoji: "ü§ñ", name: "Robot", category: "tech" },
  { id: 30, emoji: "ü¶∏", name: "Super-h√©ros", category: "fantaisie" },
  // Sport & Loisirs
  { id: 31, emoji: "‚öΩ", name: "Footballeur", category: "sport" },
  { id: 32, emoji: "üèÄ", name: "Basketteur", category: "sport" },
  { id: 33, emoji: "üéø", name: "Skieur", category: "sport" },
  { id: 34, emoji: "üèÑ", name: "Surfeur", category: "sport" },
  { id: 35, emoji: "üö¥", name: "Cycliste", category: "sport" },
  // Nature & Cosmos
  { id: 36, emoji: "üåü", name: "√âtoile", category: "cosmos" },
  { id: 37, emoji: "üåô", name: "Lune", category: "cosmos" },
  { id: 38, emoji: "‚òÄÔ∏è", name: "Soleil", category: "cosmos" },
  { id: 39, emoji: "üåà", name: "Arc-en-ciel", category: "nature" },
  { id: 40, emoji: "üî•", name: "Flamme", category: "√©l√©ments" },
  // Plus d'avatars pour atteindre 30+
  { id: 41, emoji: "üé≠", name: "Masque", category: "art" },
  { id: 42, emoji: "üé®", name: "Artiste", category: "art" },
  { id: 43, emoji: "üé™", name: "Cirque", category: "art" },
  { id: 44, emoji: "üé¨", name: "Cin√©ma", category: "art" },
  { id: 45, emoji: "üéÆ", name: "Gamer", category: "tech" },
  { id: 46, emoji: "üíª", name: "Tech", category: "tech" },
  { id: 47, emoji: "üöÄ", name: "Rocket", category: "cosmos" },
  { id: 48, emoji: "üõ∏", name: "OVNI", category: "cosmos" },
  { id: 49, emoji: "üåç", name: "Terre", category: "nature" },
  { id: 50, emoji: "üåä", name: "Vague", category: "nature" },
  { id: 51, emoji: "‚õ∞Ô∏è", name: "Montagne", category: "nature" },
  { id: 52, emoji: "üå≤", name: "Arbre", category: "nature" },
  { id: 53, emoji: "üå∫", name: "Fleur", category: "nature" },
  { id: 54, emoji: "üçï", name: "Pizza", category: "food" },
  { id: 55, emoji: "üçî", name: "Burger", category: "food" },
  { id: 56, emoji: "‚òï", name: "Caf√©", category: "food" },
  { id: 57, emoji: "üç∫", name: "Bi√®re", category: "food" },
  { id: 58, emoji: "üç∑", name: "Vin", category: "food" },
  { id: 59, emoji: "üéØ", name: "Cible", category: "sport" },
  { id: 60, emoji: "üèÜ", name: "Troph√©e", category: "sport" },
  { id: 61, emoji: "üíé", name: "Diamant", category: "luxe" },
  { id: 62, emoji: "üëë", name: "Couronne", category: "luxe" },
  { id: 63, emoji: "üéÅ", name: "Cadeau", category: "divers" },
  { id: 64, emoji: "üéà", name: "Ballon", category: "divers" },
  { id: 65, emoji: "üéä", name: "Confetti", category: "divers" },
  { id: 66, emoji: "üéâ", name: "F√™te", category: "divers" },
  { id: 67, emoji: "‚ú®", name: "√âtincelle", category: "divers" },
  { id: 68, emoji: "üí´", name: "√âtoile filante", category: "cosmos" },
  { id: 69, emoji: "üå†", name: "M√©t√©ore", category: "cosmos" },
  { id: 70, emoji: "ü¶â", name: "Hibou", category: "animaux" }
];

// --- DONN√âES UTILISATEUR ---

// Fonction pour obtenir un utilisateur par d√©faut (jamais null)
function getDefaultUser() {
  return {
    id: null,
    name: "",
    email: "",
    avatar: "üë§",
    avatarId: null,
    avatarDescription: "", // Description optionnelle de l'avatar
    bio: "", // Bio de l'utilisateur
    isLoggedIn: false, // Par d√©faut non connect√©
    favorites: [],      // IDs des favoris
    agenda: [],         // IDs dans l'agenda (permanent si pay√©)
    likes: [],          // IDs lik√©s
    participating: [],  // IDs √©v√©nements participation
    alerts: [],         // Alertes personnalis√©es
    statusAlerts: [],   // Alertes de statut (GRATUITES et ILLIMIT√âES)
    pendingStatusNotifications: [], // Notifications de changement de statut √† afficher au login
    proximityAlerts: [], // Alertes de proximit√© (items lik√©s dans un rayon de 70km)
    eventAlarms: [],    // Alarmes pour les √©v√©nements dans l'agenda [{eventId, type, value, time, triggered}]
    reviews: {},        // Reviews par item
    subscription: "free",
    agendaLimit: 20,
    alertLimit: 0,
    eventStatusHistory: {},
    addresses: [],
    smsNotifications: 0,
    smsLimit: 0,
    emailNotifications: 0,
    notificationPreferences: {
      email: true,
      sms: false
    },
    // ============================================
    // OPTIONS DE CONFIDENTIALIT√â - RGPD FRIENDLY (PRIV√â PAR D√âFAUT)
    // ============================================
    profile_public: false,           // Profil priv√© par d√©faut
    show_name: false,                // Nom masqu√© par d√©faut
    show_photo: false,               // Photo masqu√©e par d√©faut
    show_city_country_only: false,  // Ville/pays masqu√©s par d√©faut
    privacySettings: {
      showName: false,        // Masqu√© par d√©faut (RGPD)
      showAvatar: false,      // Masqu√© par d√©faut (RGPD)
      showBio: false,         // Masqu√© par d√©faut (RGPD)
      showEmail: false,       // Toujours masqu√© (jamais public)
      showAddresses: false,   // Toujours masqu√© (jamais public)
      showFavorites: false,   // Masqu√© par d√©faut (RGPD)
      showAgenda: false,      // Masqu√© par d√©faut (RGPD)
      showParticipating: false, // Masqu√© par d√©faut (RGPD)
      showFriends: false,     // Masqu√© par d√©faut (RGPD)
      showActivity: false      // Masqu√© par d√©faut (RGPD)
    },
    // Champs onboarding
    profile_photo_url: null,
    address_verified: false,
    address_lat: null,
    address_lng: null,
    address_label: null,
    address_country_code: null,
    address_city: null,
    address_postcode: null,
    address_street: null,
    // --- NOUVELLES FONCTIONNALIT√âS SOCIALES ---
    friends: [],           // Liste des IDs d'amis
    friendRequests: [],    // Demandes d'amis re√ßues: [{fromUserId, fromUserName, fromUserAvatar, date}]
    sentRequests: [],      // Demandes d'amis envoy√©es
    blockedUsers: [],      // Utilisateurs bloqu√©s
    conversations: [],     // IDs des conversations
    groups: [],            // Groupes cr√©√©s/rejoints: [{id, name, type, category, country, members: [], messages: []}]
    socialAlerts: [],      // Alertes sociales: [{type, fromUserId, message, date, read}]
    registeredCountry: 'CH', // Pays d'enregistrement (d√©tect√© depuis l'adresse)
    lastSeen: null,        // Derni√®re connexion
    profileLinks: [],      // Liens vers r√©seaux sociaux: [{platform, url}]
    profilePhotos: [],     // Photos du profil (URLs)
    profileVideos: [],     // Vid√©os du profil (URLs)
    createdAt: null,       // Date de cr√©ation du compte
    lastLoginAt: null      // Derni√®re connexion
  };
}

// Helper pour v√©rifier si l'utilisateur est connect√© (null-safe)
function isLoggedIn() {
  return currentUser && currentUser.isLoggedIn === true;
}

// Initialiser currentUser avec getDefaultUser() (jamais null)
let currentUser = getDefaultUser();
window.currentUser = currentUser;

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è SYNCHRONISATION CRITIQUE : Fonction pour synchroniser currentUser depuis auth.js
// auth.js met √† jour window.currentUser, cette fonction synchronise la variable locale
function syncCurrentUser(newUser) {
  if (newUser && typeof newUser === 'object') {
    currentUser = { ...currentUser, ...newUser };
    window.currentUser = currentUser;
    console.log('[SYNC] currentUser synchronis√© depuis auth.js:', { 
      isLoggedIn: currentUser.isLoggedIn, 
      username: currentUser.username 
    });
  }
}
window.syncCurrentUser = syncCurrentUser;

// Synchroniser automatiquement si window.currentUser existe d√©j√† (rechargement page)
if (window.currentUser && window.currentUser.isLoggedIn) {
  currentUser = { ...currentUser, ...window.currentUser };
  console.log('[SYNC] currentUser synchronis√© depuis window au chargement');
}

// Contacts pay√©s (permanent, ne dispara√Æt jamais)
let paidContacts = [];

// Panier (contacts √† acheter)
let cart = [];

// Lecteur audio r√©el pour bookings et events (√©coute + seek + drag)
// Variable globale pour le drag audio
let _audioDragging = null; // { prefix, itemId, trackIndex }
// √âtat du mini-player (type Spotify)
let _currentPlaying = null; // { prefix, itemId, trackIndex, title, subtitle }

function formatAudioTime(seconds) {
  if (!seconds || isNaN(seconds) || !isFinite(seconds)) return '0:00';
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  return m + ':' + (s < 10 ? '0' : '') + s;
}

function seekAudio(prefix, itemId, trackIndex, ev) {
  const audio = document.getElementById(`${prefix}-audio-${itemId}-${trackIndex}`);
  const progBar = document.getElementById(`progress-${prefix}-${itemId}-${trackIndex}`);
  const seekBar = document.getElementById(`seekbar-${prefix}-${itemId}-${trackIndex}`);
  if (!audio || !seekBar) return;
  const rect = seekBar.getBoundingClientRect();
  const clientX = ev.touches ? ev.touches[0].clientX : ev.clientX;
  const pct = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
  if (audio.duration && !isNaN(audio.duration)) {
    audio.currentTime = pct * audio.duration;
  } else {
    audio.load();
    audio.addEventListener('loadedmetadata', function onMeta() {
      audio.removeEventListener('loadedmetadata', onMeta);
      if (audio.duration && !isNaN(audio.duration)) {
        audio.currentTime = pct * audio.duration;
      }
      updateAudioTimeDisplay(prefix, itemId, trackIndex);
    }, { once: true });
  }
  if (progBar) progBar.style.width = (100 * pct) + '%';
  updateAudioTimeDisplay(prefix, itemId, trackIndex);
}

function startAudioDrag(prefix, itemId, trackIndex, ev) {
  ev.preventDefault();
  ev.stopPropagation();
  _audioDragging = { prefix, itemId, trackIndex };
  seekAudio(prefix, itemId, trackIndex, ev);
}

function updateAudioTimeDisplay(prefix, itemId, trackIndex) {
  const audio = document.getElementById(`${prefix}-audio-${itemId}-${trackIndex}`);
  const timeEl = document.getElementById(`time-${prefix}-${itemId}-${trackIndex}`);
  if (!audio || !timeEl) return;
  const current = formatAudioTime(audio.currentTime);
  const total = formatAudioTime(audio.duration);
  timeEl.textContent = current + ' / ' + total;
}

// Drag global handlers (mouse + touch)
document.addEventListener('mousemove', function(ev) {
  if (!_audioDragging) return;
  seekAudio(_audioDragging.prefix, _audioDragging.itemId, _audioDragging.trackIndex, ev);
});
document.addEventListener('mouseup', function() { _audioDragging = null; });
document.addEventListener('touchmove', function(ev) {
  if (!_audioDragging) return;
  seekAudio(_audioDragging.prefix, _audioDragging.itemId, _audioDragging.trackIndex, ev);
}, { passive: false });
document.addEventListener('touchend', function() { _audioDragging = null; });

function showMiniPlayer(prefix, itemId, trackIndex, title, subtitle) {
  _currentPlaying = { prefix, itemId, trackIndex, title: title || '‚Äî', subtitle: subtitle || 'Piste ' + (trackIndex + 1) };
  const el = document.getElementById('audio-mini-player');
  if (!el) return;
  el.classList.add('visible');
  document.getElementById('mini-player-title').textContent = _currentPlaying.title;
  document.getElementById('mini-player-subtitle').textContent = _currentPlaying.subtitle;
  updateMiniPlayerUI();
}

function hideMiniPlayer() {
  _currentPlaying = null;
  const el = document.getElementById('audio-mini-player');
  if (el) el.classList.remove('visible');
}

// Ouvrir la popup de l'artiste/event en cours d'√©coute
function openCurrentPlayingPopup() {
  if (!_currentPlaying) return;
  const { prefix, itemId } = _currentPlaying;
  // D√©terminer le type √† partir du pr√©fixe audio (booking, event, service)
  const type = prefix;
  const numId = parseInt(itemId);
  
  // Trouver l'item dans les donn√©es
  const dataArr = type === 'booking' ? bookingsData : type === 'event' ? eventsData : servicesData;
  const item = dataArr.find(i => i.id === numId);
  
  if (item) {
    // Ouvrir la popup de l'item (m√™me fonction que le clic depuis la liste)
    if (typeof openPopupFromList === 'function') {
      openPopupFromList(type, numId);
    }
  } else {
    showNotification("L'artiste n'est plus visible sur la carte. Rapprochez-vous de sa position.", "info");
  }
}
window.openCurrentPlayingPopup = openCurrentPlayingPopup;

function updateMiniPlayerUI() {
  if (!_currentPlaying) return;
  const { prefix, itemId, trackIndex } = _currentPlaying;
  const audio = document.getElementById(`${prefix}-audio-${itemId}-${trackIndex}`);
  const timeEl = document.getElementById('mini-player-time');
  const playBtn = document.getElementById('mini-player-play');
  if (!audio) return;
  if (timeEl) timeEl.textContent = formatAudioTime(audio.currentTime) + ' / ' + formatAudioTime(audio.duration);
  if (playBtn) playBtn.innerHTML = audio.paused ? '‚ñ∂' : '‚è∏';
}

function seekAudioOffset(prefix, itemId, trackIndex, deltaSeconds) {
  const audio = document.getElementById(`${prefix}-audio-${itemId}-${trackIndex}`);
  const progBar = document.getElementById(`progress-${prefix}-${itemId}-${trackIndex}`);
  if (!audio) return;
  let t = audio.currentTime + deltaSeconds;
  t = Math.max(0, Math.min(audio.duration || 0, t));
  audio.currentTime = t;
  if (progBar && audio.duration) progBar.style.width = (100 * t / audio.duration) + '%';
  updateAudioTimeDisplay(prefix, itemId, trackIndex);
  updateMiniPlayerUI();
}

async function toggleAudioGeneric(prefix, itemId, trackIndex) {
  if (navigator.vibrate) navigator.vibrate(10);
  const audio = document.getElementById(`${prefix}-audio-${itemId}-${trackIndex}`);
  const btn = document.getElementById(`btn-${prefix}-${itemId}-${trackIndex}`);
  const progressBar = document.getElementById(`progress-${prefix}-${itemId}-${trackIndex}`);
  const container = document.querySelector(`[data-audio-track] [id="btn-${prefix}-${itemId}-${trackIndex}"]`)?.closest('[data-audio-track]');
  const title = container?.getAttribute('data-item-title') || '‚Äî';
  const subtitle = container?.getAttribute('data-track-label') || ('Piste ' + (trackIndex + 1));
  if (!audio) return;
  
  if (audio.paused) {
    // Mode hors-ligne : utiliser le cache si disponible
    const originalUrl = audio.getAttribute('data-original-src') || audio.src;
    if (!navigator.onLine && window.indexedDBService?.getAudioCache) {
      try {
        const blobUrl = await window.indexedDBService.getAudioCache(originalUrl);
        if (blobUrl) audio.src = blobUrl;
      } catch (_) {}
    }
    // Stopper les autres audios (booking + event)
    // Couper UNIQUEMENT les autres sons (pas celui qu'on lance) - un seul son √† la fois
    document.querySelectorAll('audio[id^="booking-audio-"], audio[id^="event-audio-"]').forEach(a => {
      if (a !== audio) { a.pause(); a.currentTime = 0; }
    });
    document.querySelectorAll('[id^="progress-booking-"], [id^="progress-event-"]').forEach(p => {
      if (p !== progressBar) p.style.width = '0%';
    });
    document.querySelectorAll('[id^="btn-booking-"], [id^="btn-event-"]').forEach(b => {
      if (b !== btn) b.innerHTML = '‚ñ∂';
    });
    // Reset tous les time displays
    document.querySelectorAll('[id^="time-booking-"], [id^="time-event-"]').forEach(t => {
      const tid = t.id;
      if (!tid.includes(`${prefix}-${itemId}-${trackIndex}`)) t.textContent = '0:00';
    });
    
    audio.play();
    if (btn) btn.innerHTML = '‚è∏';
    showMiniPlayer(prefix, itemId, trackIndex, title, subtitle);
    // Cache pour mode hors-ligne (apr√®s chargement)
    const origUrl = audio.getAttribute('data-original-src') || audio.src;
    if (navigator.onLine && origUrl && window.indexedDBService?.setAudioCache && !origUrl.startsWith('blob:')) {
      audio.oncanplay = async () => {
        audio.oncanplay = null;
        try {
          const r = await fetch(origUrl, { mode: 'cors' });
          if (r.ok) {
            const blob = await r.blob();
            await window.indexedDBService.setAudioCache(origUrl, blob);
          }
        } catch (_) {}
      };
    }
    audio.onended = () => {
      if (btn) btn.innerHTML = '‚ñ∂';
      if (progressBar) progressBar.style.width = '0%';
      updateAudioTimeDisplay(prefix, itemId, trackIndex);
      hideMiniPlayer();
    };
    audio.ontimeupdate = () => {
      if (_audioDragging) return;
      if (progressBar && audio.duration) {
        progressBar.style.width = (100 * audio.currentTime / audio.duration) + '%';
      }
      updateAudioTimeDisplay(prefix, itemId, trackIndex);
      updateMiniPlayerUI();
    };
  } else {
    audio.pause();
    if (btn) btn.innerHTML = '‚ñ∂';
    hideMiniPlayer();
  }
}

function toggleBookingAudio(bookingId, trackIndex) {
  toggleAudioGeneric('booking', bookingId, trackIndex);
}
function toggleEventAudio(eventId, trackIndex) {
  toggleAudioGeneric('event', eventId, trackIndex);
}

window.toggleBookingAudio = toggleBookingAudio;
window.toggleEventAudio = toggleEventAudio;
window.seekBookingAudio = (id, i, ev) => seekAudio('booking', id, i, ev);
window.seekEventAudio = (id, i, ev) => seekAudio('event', id, i, ev);
window.startAudioDrag = startAudioDrag;
window.seekAudioOffset = seekAudioOffset;

// Initialiser les boutons du mini-player (apr√®s chargement DOM)
function initMiniPlayerButtons() {
  const playBtn = document.getElementById('mini-player-play');
  const rewindBtn = document.getElementById('mini-player-rewind');
  const forwardBtn = document.getElementById('mini-player-forward');
  if (playBtn) playBtn.onclick = () => {
    if (!_currentPlaying) return;
    const { prefix, itemId, trackIndex } = _currentPlaying;
    toggleAudioGeneric(prefix, itemId, trackIndex);
  };
  if (rewindBtn) rewindBtn.onclick = () => {
    if (!_currentPlaying) return;
    seekAudioOffset(_currentPlaying.prefix, _currentPlaying.itemId, _currentPlaying.trackIndex, -15);
    if (navigator.vibrate) navigator.vibrate(10);
  };
  if (forwardBtn) forwardBtn.onclick = () => {
    if (!_currentPlaying) return;
    seekAudioOffset(_currentPlaying.prefix, _currentPlaying.itemId, _currentPlaying.trackIndex, 15);
    if (navigator.vibrate) navigator.vibrate(10);
  };
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initMiniPlayerButtons);
} else {
  initMiniPlayerButtons();
}

// --- SYST√àME DE MOD√âRATION IA ---
let moderationQueue = [];
let moderationHistory = [];

// --- VILLES SUISSES AVEC COORDONN√âES ---
const SWISS_CITIES = [
  { name: "Z√ºrich", lat: 47.3769, lng: 8.5417, canton: "ZH", region: "Zurich" },
  { name: "Gen√®ve", lat: 46.2044, lng: 6.1432, canton: "GE", region: "Gen√®ve" },
  { name: "B√¢le", lat: 47.5596, lng: 7.5886, canton: "BS", region: "B√¢le" },
  { name: "Lausanne", lat: 46.5197, lng: 6.6323, canton: "VD", region: "Vaud" },
  { name: "Berne", lat: 46.9480, lng: 7.4474, canton: "BE", region: "Berne" },
  { name: "Winterthur", lat: 47.5001, lng: 8.7240, canton: "ZH", region: "Zurich" },
  { name: "Lucerne", lat: 47.0502, lng: 8.3093, canton: "LU", region: "Lucerne" },
  { name: "St-Gall", lat: 47.4245, lng: 9.3767, canton: "SG", region: "St-Gall" },
  { name: "Lugano", lat: 46.0037, lng: 8.9511, canton: "TI", region: "Tessin" },
  { name: "Bienne", lat: 47.1368, lng: 7.2467, canton: "BE", region: "Berne" },
  { name: "Thoune", lat: 46.7580, lng: 7.6280, canton: "BE", region: "Berne" },
  { name: "K√∂niz", lat: 46.9244, lng: 7.4128, canton: "BE", region: "Berne" },
  { name: "La Chaux-de-Fonds", lat: 47.1035, lng: 6.8296, canton: "NE", region: "Neuch√¢tel" },
  { name: "Fribourg", lat: 46.8065, lng: 7.1620, canton: "FR", region: "Fribourg" },
  { name: "Schaffhouse", lat: 47.6959, lng: 8.6350, canton: "SH", region: "Schaffhouse" },
  { name: "Coire", lat: 46.8508, lng: 9.5320, canton: "GR", region: "Grisons" },
  { name: "Neuch√¢tel", lat: 46.9920, lng: 6.9311, canton: "NE", region: "Neuch√¢tel" },
  // VALAIS - Toutes les villes principales
  { name: "Sion", lat: 46.2331, lng: 7.3606, canton: "VS", region: "Valais" },
  { name: "Sierre", lat: 46.2920, lng: 7.5350, canton: "VS", region: "Valais" },
  { name: "Visp", lat: 46.2936, lng: 7.8817, canton: "VS", region: "Valais" },
  { name: "Brig", lat: 46.3167, lng: 7.9875, canton: "VS", region: "Valais" },
  { name: "Monthey", lat: 46.2547, lng: 6.9542, canton: "VS", region: "Valais" },
  { name: "Crans-Montana", lat: 46.3108, lng: 7.4797, canton: "VS", region: "Valais" },
  { name: "Verbier", lat: 46.0967, lng: 7.2286, canton: "VS", region: "Valais" },
  { name: "Zermatt", lat: 46.0207, lng: 7.7491, canton: "VS", region: "Valais" },
  { name: "Leukerbad", lat: 46.3792, lng: 7.6283, canton: "VS", region: "Valais" },
  { name: "Saas-Fee", lat: 46.1081, lng: 7.9272, canton: "VS", region: "Valais" },
  // Autres villes
  { name: "Montreux", lat: 46.4312, lng: 6.9107, canton: "VD", region: "Vaud" },
  { name: "Yverdon", lat: 46.7785, lng: 6.6410, canton: "VD", region: "Vaud" },
  { name: "Aarau", lat: 47.3925, lng: 8.0444, canton: "AG", region: "Argovie" },
  { name: "Bellinzone", lat: 46.1955, lng: 9.0240, canton: "TI", region: "Tessin" },
  { name: "Zoug", lat: 47.1724, lng: 8.5177, canton: "ZG", region: "Zoug" },
  { name: "Nyon", lat: 46.3833, lng: 6.2396, canton: "VD", region: "Vaud" },
  { name: "Martigny", lat: 46.1028, lng: 7.0722, canton: "VS", region: "Valais" },
  { name: "Bulle", lat: 46.6198, lng: 7.0579, canton: "FR", region: "Fribourg" },
  { name: "Morges", lat: 46.5118, lng: 6.4981, canton: "VD", region: "Vaud" },
  { name: "Vevey", lat: 46.4628, lng: 6.8431, canton: "VD", region: "Vaud" },
  { name: "Locarno", lat: 46.1708, lng: 8.7994, canton: "TI", region: "Tessin" },
  { name: "Soleure", lat: 47.2088, lng: 7.5372, canton: "SO", region: "Soleure" },
  { name: "Aigle", lat: 46.3186, lng: 6.9706, canton: "VD", region: "Vaud" },
  { name: "Del√©mont", lat: 47.3656, lng: 7.3436, canton: "JU", region: "Jura" },
  { name: "Davos", lat: 46.8027, lng: 9.8360, canton: "GR", region: "Grisons" },
  { name: "Interlaken", lat: 46.6863, lng: 7.8632, canton: "BE", region: "Berne" },
  { name: "Grindelwald", lat: 46.6244, lng: 8.0413, canton: "BE", region: "Berne" },
  { name: "Ascona", lat: 46.1569, lng: 8.7700, canton: "TI", region: "Tessin" }
];

// --- VILLES FRAN√áAISES AVEC COORDONN√âES ---
const FRENCH_CITIES = [
  { name: "Paris", lat: 48.8566, lng: 2.3522, region: "IDF" },
  { name: "Lyon", lat: 45.7640, lng: 4.8357, region: "ARA" },
  { name: "Marseille", lat: 43.2965, lng: 5.3698, region: "PACA" },
  { name: "Toulouse", lat: 43.6047, lng: 1.4442, region: "OCC" },
  { name: "Nice", lat: 43.7102, lng: 7.2620, region: "PACA" },
  { name: "Nantes", lat: 47.2184, lng: -1.5536, region: "PDL" },
  { name: "Montpellier", lat: 43.6108, lng: 3.8767, region: "OCC" },
  { name: "Strasbourg", lat: 48.5734, lng: 7.7521, region: "GE" },
  { name: "Bordeaux", lat: 44.8378, lng: -0.5792, region: "NAQ" },
  { name: "Lille", lat: 50.6292, lng: 3.0573, region: "HDF" },
  { name: "Rennes", lat: 48.1173, lng: -1.6778, region: "BRE" },
  { name: "Reims", lat: 49.2583, lng: 4.0317, region: "GE" },
  { name: "Toulon", lat: 43.1242, lng: 5.9280, region: "PACA" },
  { name: "Saint-√âtienne", lat: 45.4397, lng: 4.3872, region: "ARA" },
  { name: "Le Havre", lat: 49.4944, lng: 0.1079, region: "NOR" },
  { name: "Grenoble", lat: 45.1885, lng: 5.7245, region: "ARA" },
  { name: "Dijon", lat: 47.3220, lng: 5.0415, region: "BFC" },
  { name: "Angers", lat: 47.4784, lng: -0.5632, region: "PDL" },
  { name: "N√Æmes", lat: 43.8367, lng: 4.3601, region: "OCC" },
  { name: "Clermont-Ferrand", lat: 45.7772, lng: 3.0870, region: "ARA" },
  { name: "Aix-en-Provence", lat: 43.5297, lng: 5.4474, region: "PACA" },
  { name: "Brest", lat: 48.3904, lng: -4.4861, region: "BRE" },
  { name: "Tours", lat: 47.3941, lng: 0.6848, region: "CVL" },
  { name: "Amiens", lat: 49.8941, lng: 2.2958, region: "HDF" },
  { name: "Limoges", lat: 45.8336, lng: 1.2611, region: "NAQ" },
  { name: "Annecy", lat: 45.8992, lng: 6.1294, region: "ARA" },
  { name: "Perpignan", lat: 42.6887, lng: 2.8948, region: "OCC" },
  { name: "Besan√ßon", lat: 47.2378, lng: 6.0241, region: "BFC" },
  { name: "Orl√©ans", lat: 47.9029, lng: 1.9039, region: "CVL" },
  { name: "Rouen", lat: 49.4432, lng: 1.0993, region: "NOR" },
  { name: "Mulhouse", lat: 47.7508, lng: 7.3359, region: "GE" },
  { name: "Caen", lat: 49.1829, lng: -0.3707, region: "NOR" },
  { name: "Nancy", lat: 48.6921, lng: 6.1844, region: "GE" },
  { name: "Avignon", lat: 43.9493, lng: 4.8055, region: "PACA" },
  { name: "Cannes", lat: 43.5528, lng: 7.0174, region: "PACA" }
];

// Liste combin√©e pour la g√©n√©ration d'√©v√©nements
const ALL_CITIES = [...SWISS_CITIES, ...FRENCH_CITIES];

// --- CAT√âGORIES AVEC EMOJIS ---
const CATEGORY_EMOJIS = {
  // Music Electronic
  "techno": "üéß", "house": "üè†", "trance": "üåÄ", "drum & bass": "ü•Å", "dnb": "ü•Å",
  "dubstep": "üí•", "hardstyle": "‚ö°", "ambient": "üåô", "electronic": "üîä",
  // Music Urban
  "rap": "üé§", "hip-hop": "üé§", "trap": "üî•", "rnb": "üíú", "drill": "üî´",
  "afrobeats": "üåç", "dancehall": "üáØüá≤", "reggaeton": "üíÉ",
  // Music Other
  "rock": "üé∏", "metal": "ü§ò", "jazz": "üé∑", "blues": "üé∫", "folk": "ü™ï",
  "pop": "‚≠ê", "classique": "üéª", "reggae": "üü¢",
  // Culture
  "cin√©ma": "üé¨", "th√©√¢tre": "üé≠", "exposition": "üñºÔ∏è", "conf√©rence": "üéì",
  "workshop": "üîß", "danse": "üíÉ",
  // Food
  "brunch": "ü•ê", "bbq": "üçñ", "d√©gustation": "üç∑", "food truck": "üöö",
  "march√©": "üõí", "gastronomie": "üë®‚Äçüç≥",
  // Sport
  "course": "üèÉ", "trail": "üèîÔ∏è", "cyclisme": "üö¥", "natation": "üèä",
  "ski": "‚õ∑Ô∏è", "fitness": "üí™", "yoga": "üßò",
  // Festivals
  "festival": "üé™", "open air": "üå≤", "carnaval": "üé≠", "f√™te": "üéâ",
  // Services
  "son": "üîä", "lumi√®re": "üí°", "s√©curit√©": "üõ°Ô∏è", "d√©coration": "üé®",
  "traiteur": "üçΩÔ∏è", "transport": "üöê", "photo": "üì∏", "vid√©o": "üé•"
};

// ============================================
// TH√àMES UI
// ============================================
const UI_THEMES = [
  {
    name: "Dark Neon",
    bodyBg: "#020617",
    topbarBg: "#020617",
    cardBg: "#020617",
    cardBorder: "rgba(148,163,184,0.6)",
    textMain: "#e5e7eb",
    textMuted: "#9ca3af",
    btnMainBg: "linear-gradient(135deg,#22c55e 0%,#4ade80 100%)",
    btnMainText: "#022c22",
    btnMainShadow: "0 8px 22px rgba(34,197,94,0.75)",
    btnAltBg: "rgba(15,23,42,0.9)",
    btnAltText: "#e5e7eb",
    pillBorder: "rgba(148,163,184,0.6)",
    logoColor: "#ffffff",
    taglineColor: "#e5e7eb",
    markerAccent: "#22c55e",
    markerBorder: "#4ade80"
  },
  {
    name: "Light Pro",
    bodyBg: "#f4f4f5",
    topbarBg: "#ffffff",
    cardBg: "#ffffff",
    cardBorder: "rgba(148,163,184,0.6)",
    textMain: "#020617",
    textMuted: "#6b7280",
    btnMainBg: "linear-gradient(135deg,#22c55e 0%,#16a34a 100%)",
    btnMainText: "#022c22",
    btnMainShadow: "0 8px 22px rgba(22,163,74,0.6)",
    btnAltBg: "#f9fafb",
    btnAltText: "#111827",
    pillBorder: "rgba(148,163,184,0.7)",
    logoColor: "#020617",
    taglineColor: "#4b5563",
    markerAccent: "#16a34a",
    markerBorder: "#15803d"
  },
  {
    name: "Purple Cyberpunk",
    bodyBg: "#020617",
    topbarBg: "#020617",
    cardBg: "linear-gradient(180deg,#4c1d95 0%,#020617 100%)",
    cardBorder: "rgba(192,132,252,0.8)",
    textMain: "#f9fafb",
    textMuted: "#a5b4fc",
    btnMainBg: "linear-gradient(135deg,#a855f7 0%,#ec4899 100%)",
    btnMainText: "#fdf2ff",
    btnMainShadow: "0 10px 24px rgba(168,85,247,0.8)",
    btnAltBg: "rgba(15,23,42,0.9)",
    btnAltText: "#e5e7eb",
    pillBorder: "rgba(192,132,252,0.7)",
    logoColor: "#ffffff",
    taglineColor: "#e5e7eb",
    markerAccent: "#a855f7",
    markerBorder: "#c084fc"
  },
  {
    name: "Miami Sunset",
    bodyBg: "linear-gradient(180deg,#f97316 0%,#1d1b67 100%)",
    topbarBg: "rgba(15,23,42,0.9)",
    cardBg: "rgba(15,23,42,0.9)",
    cardBorder: "rgba(251,146,60,0.7)",
    textMain: "#fefce8",
    textMuted: "#fed7aa",
    btnMainBg: "linear-gradient(135deg,#fb923c 0%,#ec4899 100%)",
    btnMainText: "#111827",
    btnMainShadow: "0 10px 24px rgba(248,113,113,0.7)",
    btnAltBg: "rgba(15,23,42,0.9)",
    btnAltText: "#fefce8",
    pillBorder: "rgba(250,204,21,0.7)",
    logoColor: "#fefce8",
    taglineColor: "#fed7aa",
    markerAccent: "#f97316",
    markerBorder: "#fbbf24"
  },
  {
    name: "Blue Ice",
    bodyBg: "#020617",
    topbarBg: "#020617",
    cardBg: "linear-gradient(135deg,#0f172a 0%,#0b1120 100%)",
    cardBorder: "rgba(148,163,184,0.8)",
    textMain: "#e5e7eb",
    textMuted: "#94a3b8",
    btnMainBg: "linear-gradient(135deg,#0ea5e9 0%,#22c55e 100%)",
    btnMainText: "#022c22",
    btnMainShadow: "0 10px 24px rgba(56,189,248,0.7)",
    btnAltBg: "rgba(15,23,42,0.9)",
    btnAltText: "#e5e7eb",
    pillBorder: "rgba(148,163,184,0.7)",
    logoColor: "#d1fae5",
    taglineColor: "#bbf7d0",
    markerAccent: "#0ea5e9",
    markerBorder: "#38bdf8"
  }
];

// Couleurs des marqueurs/clusters selon le th√®me UI actuel (bordure incluse)
// Priorit√©: customThemeConfig > th√®me UI actuel > d√©faut
function getThemeMarkerColors() {
  const cfg = window.customThemeConfig;
  if (cfg && cfg.markerColors && cfg.markerColors.length > 0) {
    return {
      accent: cfg.markerColors[0],
      border: cfg.markerBorder || 'rgba(255,255,255,0.5)',
      gradient: cfg.markerColors.length > 1 ? cfg.markerColors : null
    };
  }
  const t = UI_THEMES[typeof uiThemeIndex !== "undefined" ? uiThemeIndex : 0];
  return {
    accent: t && t.markerAccent ? t.markerAccent : "#667eea",
    border: t && t.markerBorder ? t.markerBorder : (t && t.pillBorder ? t.pillBorder : "rgba(148,163,184,0.8)"),
    gradient: null
  };
}

// Construire un CSS gradient a partir d'un tableau de couleurs (1-3)
function buildMarkerGradient(colors, angle) {
  if (!colors || colors.length === 0) return null;
  if (colors.length === 1) return colors[0];
  const a = angle || 135;
  if (colors.length === 2) return `linear-gradient(${a}deg, ${colors[0]} 0%, ${colors[1]} 100%)`;
  return `linear-gradient(${a}deg, ${colors[0]} 0%, ${colors[1]} 50%, ${colors[2]} 100%)`;
}

// ===============================
// TH√àMES MAP
// ===============================
const MAP_THEMES = [
  {
    name: "OSM Clair",
    url: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    maxZoom: 19,
    attribution: "¬© OpenStreetMap"
  },
  {
    name: "Carto Dark Matter",
    url: "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
    maxZoom: 19,
    attribution: "¬© Carto"
  },
  {
    name: "Carto Light",
    url: "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
    maxZoom: 19,
    attribution: "¬© Carto"
  }
];

// ============================================
// DONN√âES DE D√âMO
// ============================================
const demoEventBase = [
  {
    id: 1,
    type: "event",
    title: "Soir√©e Techno Test",
    description:
      "√âv√©nement de test local pour valider l‚Äôaffichage avec un descriptif un peu plus long pour tester la hauteur de la fen√™tre.",
    status: "OK",
    startDate: "2025-12-01T22:00:00",
    endDate: "2025-12-02T06:00:00",
    city: "Lausanne",
    address: "Centre-ville, Lausanne",
    lat: 46.5197,
    lng: 6.6323,
    categories: ["Techno"],
    mainCategory: "Techno",
    categoryImage: null,
    boost: "gold",
    imageUrl: null,
    sourceUrl: "https://example.com",
    isAI: false,
    pricingMode: "Entr√©e payante"
  }
];

const demoBookingBase = [];

const demoServiceBase = [];

// ============================================
// INIT
// ============================================
// G√©rer le retour de Stripe apr√®s paiement
async function handleStripeReturn() {
  console.log('[STRIPE RETURN] üîÑ handleStripeReturn() appel√©e');
  
  const urlParams = new URLSearchParams(window.location.search);
  const paymentStatus = urlParams.get('payment');
  const sessionId = urlParams.get('session_id');
  
  console.log('[STRIPE RETURN] üìä Param√®tres URL - payment:', paymentStatus, 'session_id:', sessionId);
  
  if (paymentStatus === 'success' && sessionId) {
    console.log('[STRIPE RETURN] ‚úÖ Paiement success d√©tect√©, v√©rification...');
    
    // ‚ö†Ô∏è PRIORIT√â : V√©rifier d'abord si on a des donn√©es de publication en attente
    const pendingData = localStorage.getItem('pendingPublishData');
    console.log('[STRIPE RETURN] üì¶ pendingPublishData dans localStorage:', !!pendingData);
    
    if (pendingData) {
      console.log('[STRIPE RETURN] ‚úÖ Donn√©es de publication trouv√©es - Finalisation directe...');
      try {
        const data = JSON.parse(pendingData);
        console.log('[STRIPE RETURN] üì¶ Mode:', data.mode, 'Titre:', data.newItem?.title);
        localStorage.removeItem('pendingPublishData');
        window.pendingPublishData = data;
        await finalizePublish();
        playPaymentSound();
        window.history.replaceState({}, document.title, window.location.pathname);
        return;
      } catch (e) {
        console.error('[STRIPE RETURN] ‚ùå Erreur parsing pendingPublishData:', e);
      }
    }
    
    // Sinon, essayer de v√©rifier via l'API (pour autres types de paiement)
    try {
      console.log('[STRIPE RETURN] üîç Appel API verify-session...');
      // V√©rifier le statut du paiement
      const response = await fetch(`${window.API_BASE_URL}/payments/verify-session?session_id=${sessionId}`);
      console.log('[STRIPE RETURN] üì• R√©ponse API:', response.status);
      const data = await response.json();
      console.log('[STRIPE RETURN] üì• Donn√©es API:', JSON.stringify(data));
      
      if (data.success) {
        const paymentType = data.paymentType;
        const items = data.items || [];
        console.log('[STRIPE RETURN] ‚úÖ paymentType:', paymentType, 'items:', items.length);
        
        if (paymentType === 'contact' || paymentType === 'cart') {
          // D√©bloquer les contacts
          items.forEach(item => {
            const key = `${item.type}:${item.id}`;
            if (!paidContacts.includes(key)) {
              paidContacts.push(key);
            }
            if (!currentUser.agenda.includes(key)) {
              currentUser.agenda.push(key);
            }
          });
          
          playPaymentSound();
          showNotification(`‚úÖ Paiement r√©ussi ! ${items.length} contact(s) d√©bloqu√©(s).`, "success");
          
          // Rafra√Æchir l'affichage
          refreshMarkers();
        } else if (paymentType === 'subscription') {
          // Charger le nouvel abonnement
          await loadUserSubscription();
          playPaymentSound();
          showNotification("‚úÖ Abonnement activ√© !", "success");
        } else if (paymentType === 'publication') {
          // Publication d'√©v√©nement pay√©e
          await finalizePublishAfterPayment(sessionId);
        }
        
        // Nettoyer l'URL
        window.history.replaceState({}, document.title, window.location.pathname);
      } else {
        showNotification("‚ö†Ô∏è Paiement en attente...", "warning");
      }
    } catch (error) {
      console.error('Erreur v√©rification paiement:', error);
      
      const pendingData = localStorage.getItem('pendingPublishData');
      if (pendingData && !window._publishFinalized) {
        try {
          const data = JSON.parse(pendingData);
          localStorage.removeItem('pendingPublishData');
          window.pendingPublishData = data;
          await finalizePublish();
          showNotification("‚úÖ Paiement re√ßu ! Publication effectu√©e.", "success");
        } catch (e) {
          console.error('Erreur finalisation publication:', e);
        }
      } else {
        showNotification("‚ö†Ô∏è Erreur lors de la v√©rification du paiement", "error");
      }
    }
  } else if (paymentStatus === 'cancelled' || paymentStatus === 'canceled') {
    showNotification("‚ùå Paiement annul√©", "info");
    // Supprimer les donn√©es de publication en attente
    localStorage.removeItem('pendingPublishData');
    // Nettoyer l'URL
    window.history.replaceState({}, document.title, window.location.pathname);
  }
  
  // ‚ö†Ô∏è V√©rifier aussi au chargement s'il y a des donn√©es de publication en attente avec succ√®s
  if (!paymentStatus) {
    const pendingData = localStorage.getItem('pendingPublishData');
    if (pendingData) {
      // Il y a des donn√©es mais pas de statut de paiement - nettoyer apr√®s 30 min
      const data = JSON.parse(pendingData);
      const age = Date.now() - (data.timestamp || 0);
      if (age > 30 * 60 * 1000) {
        localStorage.removeItem('pendingPublishData');
      }
    }
  }
}

// Finaliser la publication apr√®s retour de Stripe
async function finalizePublishAfterPayment(sessionId) {
  console.log('[PUBLISH] üîÑ Retour de Stripe d√©tect√©, session:', sessionId);
  console.log('[PUBLISH] üì¶ Contenu localStorage:', Object.keys(localStorage).join(', '));
  
  const pendingData = localStorage.getItem('pendingPublishData');
  console.log('[PUBLISH] üì¶ pendingPublishData existe:', !!pendingData);
  
  if (!pendingData) {
    console.error('[PUBLISH] ‚ùå DONN√âES PERDUES - pendingPublishData introuvable dans localStorage');
    console.error('[PUBLISH] ‚ùå Cl√©s disponibles:', Object.keys(localStorage));
    showNotification("‚ùå Donn√©es de publication perdues. Le paiement a √©t√© effectu√© mais l'√©v√©nement n'a pas pu √™tre cr√©√©. Contactez le support.", "error");
    return;
  }
  
  try {
    const data = JSON.parse(pendingData);
    console.log('[PUBLISH] ‚úÖ Donn√©es r√©cup√©r√©es:', data.mode, data.newItem?.title);
    
    window.pendingPublishData = data;
    await finalizePublish();
    localStorage.removeItem('pendingPublishData');
    
    playPaymentSound();
  } catch (error) {
    console.error('[PUBLISH] ‚ùå Erreur finalisation:', error);
    showNotification("‚ùå Erreur lors de la publication: " + error.message, "error");
  }
}

// Charger le statut de l'abonnement depuis le backend
async function loadUserSubscription() {
  if (!currentUser || !currentUser.isLoggedIn) return;
  
  try {
    const response = await fetch(`${window.API_BASE_URL}/payments/subscription-status?userId=${currentUser.id}`);
    if (response.ok) {
      const data = await response.json();
      if (data.subscription) {
        currentUser.subscription = data.subscription.plan;
        currentUser.agendaLimit = getAgendaLimit();
        currentUser.alertLimit = getAlertLimit();
        updateSubscriptionBadge();
      }
    }
  } catch (error) {
    console.error('Erreur chargement abonnement:', error);
  }
}

// ============================================
// DEEP LINKING - Ouvrir un event/booking/service depuis l'URL
// ============================================
function handleDeepLink() {
  const urlParams = new URLSearchParams(window.location.search);
  
  // V√©rifier si on a un param√®tre event, booking ou service
  const eventId = urlParams.get('event');
  const bookingId = urlParams.get('booking');
  const serviceId = urlParams.get('service');
  
  // Fonction pour nettoyer l'URL apr√®s l'ouverture (mais garder les param√®tres pour les m√©tadonn√©es)
  function cleanUrl() {
    // NE PAS nettoyer l'URL imm√©diatement - garder les param√®tres pour que les m√©tadonn√©es restent visibles
    // On nettoiera seulement apr√®s que la popup soit ouverte et que les m√©tadonn√©es soient mises √† jour
    // Les param√®tres restent dans l'URL pour que les scrapers des r√©seaux sociaux puissent les lire
  }
  
  // Fonction pour ouvrir la popup apr√®s que les donn√©es soient charg√©es
  function tryOpenPopup(type, id, maxAttempts = 10) {
    let attempts = 0;
    const checkInterval = setInterval(() => {
      attempts++;
      let item = null;
      
      if (type === 'event') {
        item = eventsData.find(e => e.id === parseInt(id) || e.id === id);
      } else if (type === 'booking') {
        item = bookingsData.find(b => b.id === parseInt(id) || b.id === id);
      } else if (type === 'service') {
        item = servicesData.find(s => s.id === parseInt(id) || s.id === id);
      }
      
      if (item) {
        clearInterval(checkInterval);
        
        // Mettre √† jour les m√©tadonn√©es Open Graph AVANT d'ouvrir la popup
        updateOpenGraphMetadata(type, parseInt(id), item);
        
        // Attendre un peu pour que les m√©tadonn√©es soient mises √† jour
        setTimeout(() => {
          if (type === 'event') {
            openEventPopupFromDeepLink(item);
          } else if (type === 'booking') {
            currentMode = "booking";
            refreshMarkers();
            openBookingPopupFromDeepLink(item);
          } else if (type === 'service') {
            currentMode = "service";
            refreshMarkers();
            openServicePopupFromDeepLink(item);
          }
        }, 500);
      } else if (attempts >= maxAttempts) {
        clearInterval(checkInterval);
        console.warn(`‚ö†Ô∏è ${type} ${id} non trouv√© apr√®s ${maxAttempts} tentatives`);
        showNotification(`L'√©l√©ment demand√© n'a pas √©t√© trouv√©`, "warning");
      }
    }, 500); // V√©rifier toutes les 500ms
  }
  
  if (eventId) {
    console.log(`üîó Deep link d√©tect√©: event=${eventId}`);
    // Mettre √† jour les m√©tadonn√©es imm√©diatement si possible
    const event = eventsData.find(e => e.id === parseInt(eventId) || e.id === eventId);
    if (event) {
      updateOpenGraphMetadata('event', parseInt(eventId), event);
    }
    // Essayer d'ouvrir la popup
    tryOpenPopup('event', eventId);
    return true;
  }
  
  if (bookingId) {
    console.log(`üîó Deep link d√©tect√©: booking=${bookingId}`);
    const booking = bookingsData.find(b => b.id === parseInt(bookingId) || b.id === bookingId);
    if (booking) {
      updateOpenGraphMetadata('booking', parseInt(bookingId), booking);
    }
    tryOpenPopup('booking', bookingId);
    return true;
  }
  
  if (serviceId) {
    console.log(`üîó Deep link d√©tect√©: service=${serviceId}`);
    const service = servicesData.find(s => s.id === parseInt(serviceId) || s.id === serviceId);
    if (service) {
      updateOpenGraphMetadata('service', parseInt(serviceId), service);
    }
    tryOpenPopup('service', serviceId);
    return true;
  }
  
  return false;
}

function openEventPopupFromDeepLink(event) {
  // Centrer la map sur l'event
  if (map && event.lat && event.lng) {
    map.setView([event.lat, event.lng], 14);
  }
  
  // Ouvrir la popup dans un modal
  const popupContent = buildEventPopup(event);
  openPopupModal(popupContent, event);
}

function openBookingPopupFromDeepLink(booking) {
  if (map && booking.lat && booking.lng) {
    map.setView([booking.lat, booking.lng], 14);
  }
  const popupContent = buildBookingPopup(booking);
  openPopupModal(popupContent, booking);
}

function openServicePopupFromDeepLink(service) {
  if (map && service.lat && service.lng) {
    map.setView([service.lat, service.lng], 14);
  }
  const popupContent = buildServicePopup(service);
  openPopupModal(popupContent, service);
}

// Variable pour stocker le marqueur actuel
let currentPopupMarker = null;

// ============================================================================
// üìñ NAVIGATION "LIVRE" - Events √† la m√™me adresse
// Quand 2+ events partagent les m√™mes coordonn√©es, on affiche des fl√®ches
// pour naviguer de l'un √† l'autre sans fermer la popup
// ============================================================================
let sameLocationMap = {};  // cl√© "lat,lng" ‚Üí [item1, item2, ...]
let currentLocationGroup = null; // items au m√™me endroit que l'item actuel
let currentLocationIndex = 0;    // position dans le groupe

function buildSameLocationMap(items) {
  sameLocationMap = {};
  for (const item of items) {
    if (!item || typeof item.lat !== 'number' || typeof item.lng !== 'number') continue;
    // Arrondir √† 4 d√©cimales (‚âà 11m) pour grouper les events vraiment √† la m√™me adresse
    const key = `${item.lat.toFixed(4)},${item.lng.toFixed(4)}`;
    if (!sameLocationMap[key]) sameLocationMap[key] = [];
    sameLocationMap[key].push(item);
  }
  // Trier chaque groupe par date croissante (le plus proche dans le temps en premier)
  const now = new Date();
  for (const key in sameLocationMap) {
    if (sameLocationMap[key].length > 1) {
      sameLocationMap[key].sort((a, b) => {
        const da = a.date ? new Date(a.date) : new Date('2099-12-31');
        const db = b.date ? new Date(b.date) : new Date('2099-12-31');
        // Les events futurs les plus proches d'abord
        const diffA = Math.abs(da - now);
        const diffB = Math.abs(db - now);
        return diffA - diffB;
      });
    }
  }
}

function getSameLocationItems(item) {
  if (!item || typeof item.lat !== 'number') return [item];
  const key = `${item.lat.toFixed(4)},${item.lng.toFixed(4)}`;
  return sameLocationMap[key] || [item];
}

function navigateSameLocation(direction) {
  if (!currentLocationGroup || currentLocationGroup.length <= 1) return;
  currentLocationIndex += direction;
  if (currentLocationIndex < 0) currentLocationIndex = currentLocationGroup.length - 1;
  if (currentLocationIndex >= currentLocationGroup.length) currentLocationIndex = 0;
  
  const item = currentLocationGroup[currentLocationIndex];
  const popupContent = buildPopupHtml(item);
  
  // Mettre √† jour le contenu de la popup SANS fermer/rouvrir le modal
  const scrollContainer = document.getElementById('popup-scroll-container');
  if (scrollContainer) {
    scrollContainer.innerHTML = popupContent;
    scrollContainer.scrollTop = 0;
  }
  
  // Mettre √† jour le compteur de navigation
  updateLocationNavCounter();
}

function updateLocationNavCounter() {
  const counter = document.getElementById('location-nav-counter');
  if (counter && currentLocationGroup) {
    counter.textContent = `${currentLocationIndex + 1} / ${currentLocationGroup.length}`;
  }
}

function buildLocationNavHtml(group, index) {
  if (!group || group.length <= 1) return '';
  const total = group.length;
  const isMob = window.innerWidth <= 768;
  const btnSize = isMob ? '48px' : '40px';
  const fontSize = isMob ? '26px' : '22px';
  return `
    <div id="location-nav-bar" style="
      display:flex; align-items:center; justify-content:space-between;
      padding:${isMob ? '12px 20px 16px' : '10px 16px'}; background:rgba(15,23,42,0.92); backdrop-filter:blur(10px);
      border-top:1px solid rgba(255,255,255,0.08);
      user-select:none; flex-shrink:0;
    ">
      <button onclick="navigateSameLocation(-1)" style="
        width:${btnSize}; height:${btnSize}; min-width:${btnSize}; border-radius:50%; border:none;
        background:rgba(255,255,255,0.1); color:#fff; cursor:pointer; font-size:${fontSize};
        display:flex; align-items:center; justify-content:center;
        transition:all 0.15s; flex-shrink:0; -webkit-tap-highlight-color:transparent;
      " onmouseover="this.style.background='rgba(0,255,195,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">&lsaquo;</button>
      <div style="display:flex; flex-direction:column; align-items:center; gap:2px;">
        <span id="location-nav-counter" style="
          color:#fff; font-size:${isMob ? '15px' : '14px'}; font-weight:700; letter-spacing:0.5px;
        ">${index + 1} / ${total}</span>
        <span style="color:rgba(148,163,184,0.8); font-size:${isMob ? '12px' : '11px'};">${total} events ici</span>
      </div>
      <button onclick="navigateSameLocation(1)" style="
        width:${btnSize}; height:${btnSize}; min-width:${btnSize}; border-radius:50%; border:none;
        background:rgba(255,255,255,0.1); color:#fff; cursor:pointer; font-size:${fontSize};
        display:flex; align-items:center; justify-content:center;
        transition:all 0.15s; flex-shrink:0; -webkit-tap-highlight-color:transparent;
      " onmouseover="this.style.background='rgba(0,255,195,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">&rsaquo;</button>
    </div>`;
}

window.navigateSameLocation = navigateSameLocation;

function openPopupModal(content, item) {
  // Enregistrer la vue popup (analytics organisateurs + promo)
  if (item && item.id != null) {
    const t = item.type || (typeof currentMode !== 'undefined' ? currentMode : 'event');
    const api = (typeof window !== 'undefined' && window.API_BASE_URL) ? window.API_BASE_URL : '';
    if (api && t) {
      fetch(api + '/analytics/popup-view', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: t, id: item.id })
      }).catch(function() {});
    }
  }
  // Pr√©server l'audio en cours - NE JAMAIS couper le son √† l'ouverture d'une popup
  // Le son ne s'arr√™te QUE quand l'utilisateur clique sur un NOUVEAU bouton play
  let persistentContainer = document.getElementById("audio-persistent-container");
  if (!persistentContainer) {
    persistentContainer = document.createElement("div");
    persistentContainer.id = "audio-persistent-container";
    persistentContainer.style.cssText = "position:fixed;bottom:70px;left:10px;width:1px;height:1px;overflow:hidden;pointer-events:none;opacity:0.01;z-index:99998;";
    document.body.insertBefore(persistentContainer, document.body.firstChild);
  }
  let backdrop = document.getElementById("popup-modal-backdrop");
  const scope = backdrop || document;
  const playingAudios = [];
  scope.querySelectorAll('audio[id^="booking-audio-"], audio[id^="event-audio-"]').forEach(a => {
    if (!a.paused && a.readyState >= 2) {
      playingAudios.push(a);
    }
  });
  playingAudios.forEach(a => {
    try {
      persistentContainer.appendChild(a);
    } catch (_) {}
  });

  // Supprimer un modal existant
  const existingModal = document.getElementById("popup-modal");
  if (existingModal) existingModal.remove();
  
  // Trouver et stocker le marqueur correspondant √† cet item
  if (item && item.lat && item.lng) {
    const key = `${item.type}:${item.id}`;
    currentPopupMarker = markerMap[key] || null;
  }
  
  // üìñ D√©terminer si cet item fait partie d'un groupe au m√™me emplacement
  let locationNavHtml = '';
  if (item && typeof item.lat === 'number') {
    currentLocationGroup = getSameLocationItems(item);
    if (currentLocationGroup.length > 1) {
      currentLocationIndex = currentLocationGroup.findIndex(i => i.id === item.id && i.type === item.type);
      if (currentLocationIndex < 0) currentLocationIndex = 0;
      locationNavHtml = buildLocationNavHtml(currentLocationGroup, currentLocationIndex);
    } else {
      currentLocationGroup = null;
      currentLocationIndex = 0;
    }
  }
  
  const isMobile = window.innerWidth <= 768;
  const dragHandleHtml = isMobile ? '<div class="popup-drag-handle" style="width:40px;height:4px;background:rgba(148,163,184,0.5);border-radius:2px;margin:8px auto 4px;cursor:grab;"></div>' : '';
  const bottomSheetStyle = isMobile ? 'position:fixed;bottom:0;left:0;right:0;width:100%!important;max-width:100%!important;max-height:90vh!important;margin:0!important;border-radius:20px 20px 0 0!important;align-self:flex-end!important;' : '';
  const backdropAlign = isMobile ? 'align-items:flex-end;justify-content:center;padding:0!important;' : 'align-items:center;justify-content:center;';
  const modalHtml = `
    <div id="popup-modal-content" style="position:relative;width:380px;max-height:85vh;overflow:hidden;background:var(--ui-card-bg);border-radius:16px;border:1px solid var(--ui-card-border);margin:20px;box-shadow:0 20px 60px rgba(0,0,0,0.5);display:flex;flex-direction:column;padding:0;box-sizing:border-box;${bottomSheetStyle}">
      ${dragHandleHtml}
      <button onclick="closePopupModal()" style="position:absolute;top:12px;right:12px;width:36px;height:36px;border-radius:50%;border:none;background:rgba(0,0,0,0.6);color:#fff;cursor:pointer;font-size:20px;z-index:1001;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.8)'" onmouseout="this.style.background='rgba(0,0,0,0.6)'">‚úï</button>
      <div id="popup-scroll-container" style="flex:1;overflow-y:auto;overflow-x:hidden;scrollbar-width:none;-webkit-overflow-scrolling:touch;width:100%;margin:0;padding:0;box-sizing:border-box;touch-action:pan-y;overscroll-behavior:contain;pointer-events:auto;position:relative;">
        ${content}
      </div>
      ${locationNavHtml}
    </div>
  `;
  
  if (!backdrop) {
    backdrop = document.createElement("div");
    backdrop.id = "popup-modal-backdrop";
    backdrop.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(2px);pointer-events:auto;padding-top:40px;padding-bottom:40px;box-sizing:border-box;";
    backdrop.onclick = (e) => {
      if (e.target === backdrop) closePopupModal();
    };
    document.body.appendChild(backdrop);
  }
  
  backdrop.innerHTML = modalHtml;
  backdrop.style.display = "flex";
  if (isMobile) {
    backdrop.style.alignItems = "flex-end";
    backdrop.style.justifyContent = "center";
    backdrop.style.padding = "0";
  } else {
    backdrop.style.alignItems = "center";
    backdrop.style.justifyContent = "center";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
  }
  
  // Emp√™cher le scroll du body quand la popup est ouverte
  document.body.style.overflow = 'hidden';
  
  // D√©sactiver COMPL√àTEMENT Leaflet - approche plus agressive
  if (map) {
    try {
      map.scrollWheelZoom.disable();
      map.dragging.disable();
      map.touchZoom.disable();
      map.doubleClickZoom.disable();
      // Bloquer les √©v√©nements au niveau du conteneur de la map
      const mapContainer = map.getContainer();
      if (mapContainer) {
        mapContainer.style.pointerEvents = 'none';
      }
    } catch(e) {
      console.warn('Erreur d√©sactivation Leaflet:', e);
    }
  }
  
  // FORCER LE SCROLL - Ajouter un gestionnaire wheel explicite apr√®s un court d√©lai
  setTimeout(() => {
    const scrollContainer = document.getElementById('popup-scroll-container');
    const modalContent = document.getElementById('popup-modal-content');
    
    if (scrollContainer) {
      // Emp√™cher Leaflet de capturer les √©v√©nements
      const stopPropagation = (e) => {
        e.stopPropagation();
        e.stopImmediatePropagation();
      };
      
      ['wheel', 'mousedown', 'mousemove', 'mouseup'].forEach(eventType => {
        scrollContainer.addEventListener(eventType, stopPropagation, { capture: true, passive: false });
        if (modalContent) {
          modalContent.addEventListener(eventType, stopPropagation, { capture: true, passive: false });
        }
      });
      ['touchstart', 'touchmove', 'touchend'].forEach(eventType => {
        scrollContainer.addEventListener(eventType, (e) => { e.stopPropagation(); }, { capture: true, passive: true });
        if (modalContent) {
          modalContent.addEventListener(eventType, (e) => { e.stopPropagation(); }, { capture: true, passive: true });
        }
      });
      
      // Gestionnaire wheel qui force le scroll
      const handleWheel = (e) => {
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        const scrollHeight = scrollContainer.scrollHeight;
        const clientHeight = scrollContainer.clientHeight;
        const maxScroll = scrollHeight - clientHeight;
        
        if (maxScroll > 0) {
          const delta = e.deltaY || e.detail || (e.wheelDelta ? -e.wheelDelta / 3 : 0);
          // Multiplier par 12 pour un scroll ultra rapide
          const scrollSpeed = delta * 12;
          const currentScroll = scrollContainer.scrollTop;
          const newScroll = Math.max(0, Math.min(maxScroll, currentScroll + scrollSpeed));
          
          scrollContainer.scrollTop = newScroll;
          e.preventDefault();
          return false;
        }
      };
      
      scrollContainer.addEventListener('wheel', handleWheel, { passive: false, capture: true });
      scrollContainer.addEventListener('mousewheel', handleWheel, { passive: false, capture: true });
      scrollContainer.addEventListener('DOMMouseScroll', handleWheel, { passive: false, capture: true });
    }
    // Bottom sheet: swipe down to close (mobile) - comme Google Maps, suit le doigt
    if (isMobile && modalContent) {
      let touchStartY = 0;
      let dragging = false;
      let didClose = false;
      const dragHandle = modalContent.querySelector('.popup-drag-handle');
      const startDrag = (e) => {
        if (scrollContainer && scrollContainer.scrollTop > 0) return;
        touchStartY = e.touches[0].clientY;
        dragging = true;
        didClose = false;
      };
      const onMove = (e) => {
        if (!dragging || didClose) return;
        if (scrollContainer && scrollContainer.scrollTop > 0) { dragging = false; return; }
        const dy = e.touches[0].clientY - touchStartY;
        if (dy > 0) modalContent.style.transform = `translateY(${Math.min(dy, 150)}px)`;
      };
      const onEnd = (e) => {
        if (!dragging) return;
        const dy = e.changedTouches[0].clientY - touchStartY;
        modalContent.style.transition = '';
        if (dy > 80 && scrollContainer && scrollContainer.scrollTop <= 0) {
          didClose = true;
          closePopupModal();
        } else {
          modalContent.style.transform = '';
        }
        dragging = false;
      };
      const h = dragHandle || modalContent;
      h.addEventListener('touchstart', startDrag, { passive: true });
      document.addEventListener('touchmove', onMove, { passive: true });
      document.addEventListener('touchend', onEnd, { passive: true });
      const cleanup = () => {
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend', onEnd);
        window._popupBottomSheetCleanup = null;
      };
      window._popupBottomSheetCleanup = cleanup;
    }
    
    // üìñ Navigation clavier gauche/droite pour les events m√™me adresse
    if (currentLocationGroup && currentLocationGroup.length > 1) {
      const keyHandler = (e) => {
        if (e.key === 'ArrowLeft') { navigateSameLocation(-1); e.preventDefault(); }
        if (e.key === 'ArrowRight') { navigateSameLocation(1); e.preventDefault(); }
        if (e.key === 'Escape') { closePopupModal(); e.preventDefault(); }
      };
      document.addEventListener('keydown', keyHandler);
      // Nettoyer √† la fermeture
      const origCleanup = window._popupBottomSheetCleanup;
      window._popupBottomSheetCleanup = () => {
        document.removeEventListener('keydown', keyHandler);
        if (origCleanup) origCleanup();
      };
      
      // üì± Swipe gauche/droite sur mobile pour naviguer
      const navBar = document.getElementById('location-nav-bar');
      const scrollCont = document.getElementById('popup-scroll-container');
      if (scrollCont) {
        let swipeStartX = 0;
        let swipeStartY = 0;
        let swiping = false;
        scrollCont.addEventListener('touchstart', (e) => {
          swipeStartX = e.touches[0].clientX;
          swipeStartY = e.touches[0].clientY;
          swiping = true;
        }, { passive: true });
        scrollCont.addEventListener('touchend', (e) => {
          if (!swiping) return;
          swiping = false;
          const dx = e.changedTouches[0].clientX - swipeStartX;
          const dy = e.changedTouches[0].clientY - swipeStartY;
          // Seulement si le swipe horizontal est plus grand que vertical et > 60px
          if (Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy) * 1.5) {
            if (dx > 0) navigateSameLocation(-1);
            else navigateSameLocation(1);
          }
        }, { passive: true });
      }
    } else {
      // Escape pour fermer m√™me sans navigation
      const keyHandler = (e) => {
        if (e.key === 'Escape') { closePopupModal(); e.preventDefault(); }
      };
      document.addEventListener('keydown', keyHandler);
      const origCleanup = window._popupBottomSheetCleanup;
      window._popupBottomSheetCleanup = () => {
        document.removeEventListener('keydown', keyHandler);
        if (origCleanup) origCleanup();
      };
    }
  }, 100);
}

// Fonction pour mettre √† jour l'affichage des boutons auth
// D√©finie avant DOMContentLoaded pour √™tre accessible d√®s l'initialisation
function updateAuthButtons() {
  const authButtons = document.getElementById("auth-buttons");
  const accountBtn = document.getElementById("account-topbar-btn");
  
  if (!authButtons || !accountBtn) {
    console.warn('[AUTH BUTTONS] Elements introuvables, retry dans 500ms');
    setTimeout(updateAuthButtons, 500);
    return;
  }
  
  // V√©rifier aussi localStorage/sessionStorage en plus de currentUser (fallback robuste)
  let isLoggedIn = currentUser && currentUser.isLoggedIn;
  
  // Fallback : si currentUser n'est pas encore initialis√© mais on a un token valide
  if (!isLoggedIn) {
    try {
      const stored = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
      if (stored) {
        const parsed = JSON.parse(stored);
        if (parsed && parsed.isLoggedIn) {
          isLoggedIn = true;
          console.log('[AUTH BUTTONS] Fallback: utilisateur recupere depuis storage');
          // Restaurer currentUser si vide
          if (!currentUser || !currentUser.isLoggedIn) {
            if (typeof currentUser === 'undefined' || !currentUser) {
              currentUser = parsed;
            } else {
              Object.assign(currentUser, parsed);
            }
          }
        }
      }
    } catch(e) { /* ignore */ }
  }
  
  if (isLoggedIn) {
    // Utilisateur connecte : masquer les boutons auth, afficher le bouton compte
    authButtons.style.display = 'none';
    accountBtn.style.display = 'flex';
    // S'assurer que le bouton est TOUJOURS visible et cliquable (jamais cache par erreur)
    accountBtn.style.visibility = 'visible';
    accountBtn.style.opacity = '1';
    accountBtn.style.pointerEvents = 'auto';
  } else {
    // Utilisateur non connect√© : afficher les boutons auth, masquer le bouton compte
    authButtons.style.display = 'flex';
    accountBtn.style.display = 'none';
    
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : R√©attacher les event listeners au bouton "Connexion" apr√®s d√©connexion
    // Utiliser plusieurs tentatives avec d√©lais croissants pour s'assurer que auth.js est charg√©
    const initLoginButton = (attempt = 1) => {
      const loginBtn = document.getElementById('login-topbar-btn');
      if (loginBtn) {
        // V√©rifier que les fonctions sont disponibles avant d'attacher le listener
        const hasFunctions = typeof window.openLoginModal === 'function' || typeof window.openAuthModal === 'function';
        
        if (!hasFunctions && attempt < 10) {
          console.log('[AUTH BUTTONS] ‚ö†Ô∏è Fonctions non disponibles (tentative', attempt, '), nouvelle tentative dans', attempt * 100, 'ms');
          setTimeout(() => initLoginButton(attempt + 1), attempt * 100);
          return;
        }
        
        if (!hasFunctions) {
          console.error('[AUTH BUTTONS] ‚ùå Fonctions de connexion non disponibles apr√®s 10 tentatives');
          if (typeof showNotification === 'function') {
            showNotification('‚ö†Ô∏è Erreur : fonctions de connexion non disponibles. Veuillez rafra√Æchir la page.', 'error');
          }
          return;
        }
        
        console.log('[AUTH BUTTONS] ‚úÖ Bouton Connexion trouv√©, r√©attachement des listeners (tentative', attempt, ')');
        
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Supprimer l'onclick inline qui peut interf√©rer
        loginBtn.removeAttribute('onclick');
        
        // Supprimer tous les anciens listeners en clonant le bouton
        const newLoginBtn = loginBtn.cloneNode(true);
        loginBtn.parentNode.replaceChild(newLoginBtn, loginBtn);
        
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è S'assurer que le bouton est cliquable (pointer-events, cursor, etc.)
        newLoginBtn.style.pointerEvents = 'auto';
        newLoginBtn.style.cursor = 'pointer';
        newLoginBtn.style.opacity = '1';
        
        // R√©attacher le listener avec plusieurs fallbacks
        newLoginBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          console.log('[AUTH BUTTONS] ‚úÖ‚úÖ‚úÖ Bouton Connexion cliqu√© - Ouverture modal');
          
          // Essayer plusieurs m√©thodes pour ouvrir le modal de connexion
          if (typeof window.openLoginModal === 'function') {
            console.log('[AUTH BUTTONS] Utilisation window.openLoginModal');
            window.openLoginModal();
          } else if (typeof window.openAuthModal === 'function') {
            console.log('[AUTH BUTTONS] Utilisation window.openAuthModal');
            window.openAuthModal('login');
          } else if (typeof openLoginModal === 'function') {
            console.log('[AUTH BUTTONS] Utilisation openLoginModal');
            openLoginModal();
          } else if (typeof openAuthModal === 'function') {
            console.log('[AUTH BUTTONS] Utilisation openAuthModal');
            openAuthModal('login');
          } else {
            console.error('[AUTH BUTTONS] ‚ùå Aucune fonction de connexion disponible');
            if (typeof showNotification === 'function') {
              showNotification('‚ö†Ô∏è Erreur : fonctions de connexion non disponibles. Veuillez rafra√Æchir la page.', 'error');
            }
          }
        }, { capture: true });
        
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è DOUBLE V√âRIFICATION : S'assurer que le bouton est bien visible et cliquable
        console.log('[AUTH BUTTONS] ‚úÖ‚úÖ‚úÖ Event listener r√©attach√© au bouton Connexion', {
          display: window.getComputedStyle(newLoginBtn).display,
          visibility: window.getComputedStyle(newLoginBtn).visibility,
          pointerEvents: window.getComputedStyle(newLoginBtn).pointerEvents,
          cursor: window.getComputedStyle(newLoginBtn).cursor,
          opacity: window.getComputedStyle(newLoginBtn).opacity,
          hasOpenLoginModal: typeof window.openLoginModal === 'function',
          hasOpenAuthModal: typeof window.openAuthModal === 'function'
        });
      } else {
        if (attempt < 10) {
          console.log('[AUTH BUTTONS] ‚ö†Ô∏è Bouton login-topbar-btn non trouv√© (tentative', attempt, '), nouvelle tentative dans', attempt * 100, 'ms');
          setTimeout(() => initLoginButton(attempt + 1), attempt * 100);
        } else {
          console.warn('[AUTH BUTTONS] ‚ö†Ô∏è Bouton login-topbar-btn non trouv√© apr√®s 10 tentatives');
          // Essayer de trouver le bouton dans auth-buttons
          const authButtons = document.getElementById('auth-buttons');
          if (authButtons) {
            const buttons = authButtons.querySelectorAll('button');
            console.log('[AUTH BUTTONS] Boutons trouv√©s dans auth-buttons:', buttons.length);
            buttons.forEach((btn, index) => {
              if (btn.textContent && btn.textContent.includes('Connexion')) {
                console.log('[AUTH BUTTONS] Bouton Connexion trouv√© par texte:', index);
                btn.removeAttribute('onclick');
                btn.style.pointerEvents = 'auto';
                btn.style.cursor = 'pointer';
                btn.addEventListener('click', function(e) {
                  e.preventDefault();
                  e.stopPropagation();
                  if (typeof window.openLoginModal === 'function') {
                    window.openLoginModal();
                  } else if (typeof window.openAuthModal === 'function') {
                    window.openAuthModal('login');
                  }
                }, { capture: true });
              }
            });
          }
        }
      }
    };
    
    // D√©marrer l'initialisation avec plusieurs tentatives
    setTimeout(() => initLoginButton(1), 100);
  }
}

// Exposer globalement
window.updateAuthButtons = updateAuthButtons;

document.addEventListener("DOMContentLoaded", () => {
  console.log('üèóÔ∏è DOM Content Loaded - MapEvent');
  
  const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|webOS/i.test(navigator.userAgent);
  
  // Fonction pour masquer le loader (appel√©e quand la carte est VRAIMENT pr√™te)
  window._hideAppLoader = function() {
    const loader = document.getElementById('app-loader');
    if (loader && !loader.classList.contains('hide')) {
      loader.classList.add('hide');
      setTimeout(() => { if (loader.parentNode) loader.parentNode.removeChild(loader); }, 500);
      console.log('‚úÖ Loader masqu√© - carte pr√™te');
    }
  };
  
  const doInit = () => {
    initMapWithRetry();
    initUI();
    applyUITheme(typeof uiThemeIndex !== 'undefined' ? uiThemeIndex : 0);
    applyMapTheme(typeof mapThemeIndex !== 'undefined' ? mapThemeIndex : 0);
    // S√©curit√© : masquer le loader apr√®s 4s max si la carte n'a pas r√©pondu
    setTimeout(window._hideAppLoader, 4000);
  };
  // Init imm√©diat - pas de d√©lai artificiel (le loader couvre la transition)
  requestAnimationFrame(doInit);
  
  // ‚ö†Ô∏è CRITIQUE: V√©rifier le retour Stripe IMM√âDIATEMENT au chargement
  const stripeParams = new URLSearchParams(window.location.search);
  const stripePaymentStatus = stripeParams.get('payment');
  const stripeSessionId = stripeParams.get('session_id');
  
  if (stripePaymentStatus || stripeSessionId) {
    console.log('[STRIPE RETURN] üîç Param√®tres d√©tect√©s - payment:', stripePaymentStatus, 'session_id:', stripeSessionId?.substring(0, 20) + '...');
    // Appeler handleStripeReturn apr√®s un court d√©lai pour laisser l'API_BASE_URL s'initialiser
    setTimeout(() => {
      console.log('[STRIPE RETURN] üöÄ Appel de handleStripeReturn()...');
      handleStripeReturn().catch(err => {
        console.error('[STRIPE RETURN] ‚ùå Erreur:', err);
      });
    }, 500);
  }
  
  // Initialisation UI auth: v√©rifier si currentUser existe et afficher "Compte" ou "Connexion"
  const u = safeGetJSON("currentUser");
  if (u?.id) {
    window.currentUser = u;
    updateAuthButtons();
    console.log('[INIT] Utilisateur connect√© d√©tect√©:', u.id);
  } else {
    updateAuthButtons();
    console.log('[INIT] Aucun utilisateur connect√©');
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que le bouton de connexion fonctionne apr√®s rechargement
  // Utiliser plusieurs tentatives avec d√©lais croissants pour s'assurer que auth.js est charg√©
  const initLoginButtonOnLoad = (attempt = 1) => {
    const loginBtn = document.getElementById('login-topbar-btn');
    if (loginBtn) {
      // V√©rifier que les fonctions sont disponibles
      const hasFunctions = typeof window.openLoginModal === 'function' || typeof window.openAuthModal === 'function';
      
      if (!hasFunctions && attempt < 10) {
        console.log('[INIT] ‚ö†Ô∏è Fonctions non disponibles (tentative', attempt, '), nouvelle tentative dans', attempt * 100, 'ms');
        setTimeout(() => initLoginButtonOnLoad(attempt + 1), attempt * 100);
        return;
      }
      
      if (!hasFunctions) {
        console.error('[INIT] ‚ùå Fonctions de connexion non disponibles apr√®s 10 tentatives');
        return;
      }
      
      console.log('[INIT] ‚úÖ Bouton Connexion trouv√©, v√©rification des fonctions... (tentative', attempt, ')');
      
      // Supprimer l'onclick inline pour √©viter les conflits
      loginBtn.removeAttribute('onclick');
      
      // R√©attacher le listener avec plusieurs fallbacks
      loginBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        console.log('[INIT] ‚úÖ‚úÖ‚úÖ Bouton Connexion cliqu√© apr√®s rechargement');
        
        // Essayer plusieurs m√©thodes pour ouvrir le modal de connexion
        if (typeof window.openLoginModal === 'function') {
          console.log('[INIT] Utilisation window.openLoginModal');
          window.openLoginModal();
        } else if (typeof window.openAuthModal === 'function') {
          console.log('[INIT] Utilisation window.openAuthModal');
          window.openAuthModal('login');
        } else if (typeof openLoginModal === 'function') {
          console.log('[INIT] Utilisation openLoginModal');
          openLoginModal();
        } else if (typeof openAuthModal === 'function') {
          console.log('[INIT] Utilisation openAuthModal');
          openAuthModal('login');
        } else {
          console.error('[INIT] ‚ùå Aucune fonction de connexion disponible');
          if (typeof showNotification === 'function') {
            showNotification('‚ö†Ô∏è Erreur : fonctions de connexion non disponibles. Veuillez rafra√Æchir la page.', 'error');
          }
        }
      }, { capture: true });
      
      console.log('[INIT] ‚úÖ‚úÖ‚úÖ Event listener r√©attach√© au bouton Connexion apr√®s rechargement', {
        hasOpenLoginModal: typeof window.openLoginModal === 'function',
        hasOpenAuthModal: typeof window.openAuthModal === 'function'
      });
    } else {
      if (attempt < 10) {
        console.log('[INIT] ‚ö†Ô∏è Bouton login-topbar-btn non trouv√© (tentative', attempt, '), nouvelle tentative dans', attempt * 100, 'ms');
        setTimeout(() => initLoginButtonOnLoad(attempt + 1), attempt * 100);
      } else {
        console.warn('[INIT] ‚ö†Ô∏è Bouton login-topbar-btn non trouv√© apr√®s 10 tentatives');
      }
    }
  };
  
  // D√©marrer l'initialisation avec plusieurs tentatives
  setTimeout(() => initLoginButtonOnLoad(1), 200);

  // Popup d'accueil g√©r√©e par le script PWA dans mapevent.html
  // (message: "Site actif sauf abos et social √† venir" + bouton installation mobile)
  
  // FORCER "ABOS" IMM√âDIATEMENT au chargement (avant tout autre code)
  const forceABOS = () => {
    const label = document.getElementById("subscription-label");
    if (label && label.textContent !== "ABOS") {
      label.textContent = "ABOS";
      label.innerHTML = "ABOS";
    }
  };
  forceABOS();
  
  // Observer pour maintenir "ABOS" m√™me si quelque chose essaie de le changer
  const label = document.getElementById("subscription-label");
  if (label) {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'childList' || mutation.type === 'characterData') {
          if (label.textContent !== "ABOS" && label.textContent.trim() !== "ABOS") {
            label.textContent = "ABOS";
            label.innerHTML = "ABOS";
          }
        }
      });
    });
    observer.observe(label, { childList: true, characterData: true, subtree: true });
  }
  
  // Supprimer le bloc "alertes" entre panier et liste dans la topbar
  const removeAlertsButton = () => {
    const topbarCenter = document.querySelector('.topbar-center');
    if (topbarCenter) {
      // Chercher tous les boutons dans topbar-center
      const buttons = topbarCenter.querySelectorAll('button');
      buttons.forEach(btn => {
        const text = btn.textContent || btn.innerText || '';
        // Supprimer si le bouton contient "alertes" ou "üîî" et est entre les modes et Liste
        if ((text.toLowerCase().includes('alertes') || text.includes('üîî')) && 
            btn.onclick && btn.onclick.toString().includes('openAlerts')) {
          btn.remove();
        }
      });
    }
  };
  
  // Supprimer imm√©diatement et p√©riodiquement
  removeAlertsButton();
  setTimeout(removeAlertsButton, 100);
  setTimeout(removeAlertsButton, 500);
  setInterval(removeAlertsButton, 2000);
  
  // Observer les changements dans le topbar-center
  const topbarCenter = document.querySelector('.topbar-center');
  if (topbarCenter) {
    const topbarObserver = new MutationObserver(() => {
      removeAlertsButton();
    });
    topbarObserver.observe(topbarCenter, { childList: true, subtree: true });
  }
  
  // Charger l'utilisateur sauvegard√© (depuis auth.js)
  if (window.loadSavedUser) {
    window.loadSavedUser();
  }
  
  // Charger agenda+favoris d√®s le d√©part si token pr√©sent (√©vite d√©lai 500ms)
  const token = typeof getAuthToken === 'function' ? getAuthToken() : (localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken'));
  if (token) {
    loadUserDataOnLogin().catch(err => console.warn('[INIT] Chargement donn√©es utilisateur:', err));
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FLUX STANDARD : Reconnexion automatique si "rester connect√©" est activ√©
  setTimeout(async () => {
    const rememberMe = localStorage.getItem('rememberMe') === 'true';
    if (rememberMe) {
      console.log('[AUTH] ‚úÖ "Rester connect√©" activ√© - Tentative de reconnexion automatique');
      
      // V√©rifier si on a des tokens valides
      const accessToken = getAuthToken();
      if (accessToken) {
        try {
          // V√©rifier si le token est valide en appelant /api/user/me
          const apiBaseUrl = window.API_BASE_URL || "https://ctp67u5hgni2rbfr3kp4p74kxa0gxycf.lambda-url.eu-west-1.on.aws/api";
          const response = await fetch(`${apiBaseUrl}/user/me`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const userData = data.user || data; // Backend retourne { user: {...} }
            console.log('[AUTH] ‚úÖ‚úÖ‚úÖ Reconnexion automatique r√©ussie:', userData.email);
            
            // Reconnecter l'utilisateur silencieusement
            const user = {
              id: userData.id,
              email: userData.email,
              username: userData.username || userData.email?.split('@')[0] || 'Utilisateur',
              profile_photo_url: userData.profile_photo_url || null
            };
            
            const tokens = {
              access_token: accessToken,
              refresh_token: localStorage.getItem('refreshToken') || sessionStorage.getItem('refreshToken') || ''
            };
            
            // Connecter silencieusement (pas de notification)
            if (typeof window.connectUser === 'function') {
              window.connectUser(user, tokens, true);
              console.log('[AUTH] ‚úÖ‚úÖ‚úÖ Utilisateur reconnect√© automatiquement');
            } else if (typeof connectUser === 'function') {
              connectUser(user, tokens, true);
            }
          } else {
            console.log('[AUTH] ‚ö†Ô∏è Token invalide - Tokens conserv√©s (r√®gle: jamais supprimer)');
          }
        } catch (error) {
          console.error('[AUTH] ‚ùå Erreur reconnexion automatique:', error);
          // En cas d'erreur, ne pas reconnecter
        }
      } else {
        console.log('[AUTH] ‚ö†Ô∏è Pas de token disponible - Reconnexion automatique annul√©e');
      }
    } else {
      console.log('[AUTH] ‚ÑπÔ∏è "Rester connect√©" d√©sactiv√© - Pas de reconnexion automatique');
    }
  }, 500); // Attendre un peu pour que tout soit charg√©
  
  // Attacher l'event listener au bouton compte
  // LISTENER EN CAPTURE pour debug le clic sur bloc compte
  document.addEventListener('click', (e) => {
    const el = e.target.closest('#account-topbar-btn, #account-block, .account-block, [data-account-block], #account-avatar, #account-name');
    if (el) {
      console.log('[ACCOUNT CLICK CAPTURE]', {
        target: e.target,
        el: el,
        id: el.id,
        classList: el.classList.toString(),
        currentUser: currentUser ? { isLoggedIn: currentUser.isLoggedIn, email: currentUser.email } : null
      });
    }
  }, true);
  
  const accountBtn = document.getElementById("account-topbar-btn");
  if (accountBtn) {
    accountBtn.addEventListener('click', (e) => {
      if (typeof window._openAccountGrid === 'function') return;
      console.log('[ACCOUNT CLICK] fired', e);
      e.preventDefault();
      e.stopPropagation();
      
      // V√©rifier si une connexion Google est en cours
      const isGoogleLoginInProgress = window.isGoogleLoginInProgress === true || (typeof window !== 'undefined' && window.isGoogleLoginInProgress === true);
      if (isGoogleLoginInProgress) {
        console.log('[ACCOUNT CLICK] Guard: Connexion Google en cours - click bloqu√©');
        if (typeof showNotification === 'function') {
          showNotification('‚è≥ Connexion en cours... Veuillez patienter', 'info');
        }
        return;
      }
      
      // V√©rifier qu'aucun modal n'est ouvert qui pourrait bloquer
      const authModal = document.getElementById('authModal');
      const onboardingModal = document.getElementById('onboardingModal');
      if ((authModal && authModal.style.display !== 'none') || (onboardingModal && onboardingModal.style.display !== 'none')) {
        console.log('[ACCOUNT CLICK] Guard: Auth/Onboarding modal visible - click bloqu√©');
        return;
      }
      
      const isLoggedIn = (currentUser && currentUser.isLoggedIn) || (window.currentUser && window.currentUser.isLoggedIn);
      if (isLoggedIn) {
        if (window.currentUser && window.currentUser.isLoggedIn && (!currentUser || !currentUser.isLoggedIn)) {
          currentUser = { ...currentUser, ...window.currentUser };
        }
        console.log('[ACCOUNT CLICK] Ouverture modale compte');
        if (typeof window.openAccountModal === 'function') {
          window.openAccountModal();
        } else {
          console.error('[ACCOUNT CLICK] openAccountModal n\'est pas une fonction');
        }
      } else {
        // Utilisateur non connect√© : v√©rifier si "rester connect√©" √©tait activ√©
        const rememberMe = localStorage.getItem('rememberMe') === 'true';
        const savedUser = localStorage.getItem('currentUser');
        const tokens = localStorage.getItem('cognito_tokens') || sessionStorage.getItem('cognito_tokens');
        
        if (rememberMe && savedUser && tokens) {
          console.log('[ACCOUNT CLICK] "Rester connect√©" activ√© - Tentative reconnexion automatique');
          try {
            const user = JSON.parse(savedUser);
            const parsedTokens = JSON.parse(tokens);
            
            // V√©rifier que les tokens sont valides
            if (parsedTokens && parsedTokens.access_token) {
              // Reconnecter automatiquement
              if (typeof window.connectUser === 'function') {
                window.connectUser(user, parsedTokens, true);
                console.log('[ACCOUNT CLICK] Reconnexion automatique r√©ussie');
                return;
              }
            }
          } catch (e) {
            console.warn('[ACCOUNT CLICK] Erreur reconnexion automatique:', e);
          }
        }
        
        // Sinon, ouvrir le modal de connexion
        console.log('[ACCOUNT CLICK] Ouverture modale login');
        openAuthModal('login');
      }
    });
    
    // S'assurer que le bouton est cliquable
    accountBtn.style.cursor = 'pointer';
    accountBtn.style.pointerEvents = 'auto';
    accountBtn.style.zIndex = '1000';
  }
  
  // Fonction de nettoyage agressive pour supprimer "om/Œµ" et autres caract√®res ind√©sirables
  const cleanAccountText = (text) => {
    if (!text || typeof text !== 'string') return text;
    let cleaned = text;
    // Supprimer "om/" au d√©but ou dans le texte
    cleaned = cleaned.replace(/^om\/[^\s]*\s*/gi, '');
    cleaned = cleaned.replace(/om\/[^\s]*/gi, '');
    // Supprimer les patterns "xxx/xxx"
    cleaned = cleaned.replace(/^[a-z]+\/[^\s]*\s*/gi, '');
    cleaned = cleaned.replace(/^[A-Z]+\/[^\s]*\s*/g, '');
    // Supprimer les caract√®res grecs comme epsilon (Œµ)
    cleaned = cleaned.replace(/[Œ±Œ≤ŒµŒ≥Œ¥ŒµŒ∂Œ∑Œ∏ŒπŒ∫ŒªŒºŒΩŒæŒøœÄœÅœÉœÑœÖœÜœáœàœâ]/gi, '');
    // Supprimer les caract√®res sp√©ciaux ind√©sirables mais garder les accents fran√ßais
    cleaned = cleaned.replace(/[^\w\s\u00C0-\u017F\u00E0-\u00FF\u00E9\u00E8\u00EA\u00EB\u00E0\u00E2\u00E7\u00F9\u00FB\u00FC]/g, '');
    // Supprimer les slashes multiples
    cleaned = cleaned.replace(/\/+/g, '');
    // Normaliser les espaces
    cleaned = cleaned.replace(/\s+/g, ' ');
    cleaned = cleaned.trim();
    return cleaned;
  };
  
  // Fonction pour obtenir l'avatar/photo de l'utilisateur
  // Fonction pour normaliser une URL (ajouter https:// si manquant)
  // Fonction pour normaliser une URL d'image (r√©parer les URLs tronqu√©es ou malform√©es)
  const normalizeImageUrl = (raw) => {
    if (!raw || typeof raw !== 'string') return null;
    
    // 1. Trim la string
    let url = raw.trim();
    if (!url) return null;
    
    // 2. Accepter http://, https://, data:image (retourner tel quel)
    if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('data:image')) {
      return url;
    }
    
    // 3. Si commence par // ‚Üí prefixer https:
    if (url.startsWith('//')) {
      return 'https:' + url;
    }
    
    // 4. G√©rer les URLs tronqu√©es comme "om/..." (probablement ".com/..." tronqu√©)
    // Si commence par "om/" ou contient "om/" au d√©but, c'est probablement ".com/" tronqu√©
    if (url.startsWith('om/') || url.match(/^[a-z]{1,3}\//)) {
      // Essayer de reconstruire l'URL avec des domaines communs
      const commonDomains = ['googleusercontent.com', 'amazonaws.com', 'cloudfront.net', 's3.amazonaws.com'];
      for (const domain of commonDomains) {
        // Si l'URL commence par quelque chose qui ressemble √† une fin de domaine
        if (url.includes('/')) {
          const reconstructed = `https://${domain}/${url}`;
          // V√©rifier que √ßa ressemble √† une URL valide
          if (reconstructed.match(/\.(jpg|jpeg|png|gif|webp)/i)) {
            return reconstructed;
          }
        }
      }
      // Si on ne peut pas reconstruire, retourner null
      return null;
    }
    
    // 5. Si ne commence pas par http mais contient un domaine ‚Üí prefixer https://
    // D√©tecter les patterns de domaine
    const domainPatterns = [
      /\.com\//,
      /\.net\//,
      /\.org\//,
      /\.io\//,
      /\.aws/,
      /cloudfront\.net/,
      /googleusercontent\.com/,
      /amazonaws\.com/,
      /s3\./,
      /\.jpg/,
      /\.jpeg/,
      /\.png/,
      /\.gif/,
      /\.webp/
    ];
    
    const hasDomain = domainPatterns.some(pattern => pattern.test(url));
    
    if (hasDomain) {
      // Enlever les slashes en d√©but si pr√©sents
      const cleaned = url.replace(/^\/+/, '');
      return 'https://' + cleaned;
    }
    
    // 6. Sinon retourner null (pas une URL valide)
    return null;
  };
  
  const getUserAvatar = () => {
    // Permettre l'affichage de la photo m√™me pendant le formulaire d'inscription (googleValidated)
    if (!currentUser || (!currentUser.isLoggedIn && !currentUser.googleValidated)) {
      console.log('[AVATAR UI] getUserAvatar: utilisateur non connect√©, retour emoji');
      return "üë§";
    }
    
    // PRIORIT√â PROFESSIONNELLE (comme les leaders mondiaux):
    // 1. photoData (photo upload√©e lors cr√©ation - base64 ou URL)
    // 2. profile_photo_url S3 (URL S3, pas Google)
    // 3. profilePhoto (si pas Google)
    // 4. avatarUrl (si pas Google)
    // 5. avatar/Google en dernier recours
    
    let rawAvatar = null;
    
    // 1. photoData (photo upload√©e lors de la cr√©ation du profil)
    // Normaliser photoData AVANT v√©rification : convertir "null" en null r√©el
    let photoData = currentUser.photoData;
    
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Normaliser IMM√âDIATEMENT si c'est la cha√Æne "null"
    if (photoData === 'null' || photoData === 'undefined' || photoData === '') {
      photoData = null;
      // Corriger currentUser.photoData imm√©diatement pour √©viter les probl√®mes futurs
      currentUser.photoData = null;
      console.log('[AVATAR UI] ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è photoData normalis√© de "null" vers null');
    }
    
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : V√©rifier aussi dans pendingRegisterData si photoData n'existe pas dans currentUser
    if (!photoData && window.pendingRegisterData?.photoData) {
      const pendingPhoto = window.pendingRegisterData.photoData;
      // Normaliser aussi pendingPhoto
      if (pendingPhoto !== 'null' && pendingPhoto !== 'undefined' && pendingPhoto !== '' && pendingPhoto.length > 100) {
        photoData = pendingPhoto;
        console.log('[AVATAR UI] ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è photoData r√©cup√©r√© depuis pendingRegisterData (longueur:', photoData.length, ')');
        // Mettre √† jour currentUser imm√©diatement
        currentUser.photoData = photoData;
      }
    }
    
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : V√©rifier aussi dans localStorage (pendingRegisterDataForGoogle) - pour Google OAuth
    // MAIS SEULEMENT si les donn√©es correspondent √† l'utilisateur connect√© (m√™me email)
    if (!photoData) {
      try {
        const savedPendingData = localStorage.getItem('pendingRegisterDataForGoogle');
        if (savedPendingData) {
          const parsedPendingData = JSON.parse(savedPendingData);
          // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FIX BUG : V√©rifier que les donn√©es appartiennent √† l'utilisateur connect√©
          const pendingEmail = parsedPendingData.email?.toLowerCase?.() || '';
          const currentEmail = currentUser.email?.toLowerCase?.() || '';
          const emailMatches = pendingEmail && currentEmail && pendingEmail === currentEmail;
          
          if (emailMatches && parsedPendingData.photoData && parsedPendingData.photoData !== 'null' && parsedPendingData.photoData !== 'undefined' && parsedPendingData.photoData.length > 100) {
            photoData = parsedPendingData.photoData;
            console.log('[AVATAR UI] ‚úÖ photoData r√©cup√©r√© depuis pendingRegisterDataForGoogle (m√™me email)');
            currentUser.photoData = photoData;
            if (!window.pendingRegisterData) {
              window.pendingRegisterData = parsedPendingData;
            }
          } else if (parsedPendingData.photoData && !emailMatches) {
            console.log('[AVATAR UI] ‚ö†Ô∏è pendingRegisterDataForGoogle ignor√© (email diff√©rent)');
            localStorage.removeItem('pendingRegisterDataForGoogle');
          }
        }
      } catch (e) {
        console.warn('[AVATAR UI] Erreur lecture pendingRegisterDataForGoogle:', e);
      }
    }
    
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : V√©rifier aussi dans localStorage (registerFormDraft)
    // MAIS SEULEMENT si le draft correspond √† l'utilisateur connect√© (m√™me email)
    if (!photoData) {
      try {
        const draft = localStorage.getItem('registerFormDraft');
        if (draft) {
          const parsedDraft = JSON.parse(draft);
          // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FIX BUG : V√©rifier que le draft appartient √† l'utilisateur connect√©
          const draftEmail = parsedDraft.email?.toLowerCase?.() || '';
          const currentEmail = currentUser.email?.toLowerCase?.() || '';
          const emailMatches = draftEmail && currentEmail && draftEmail === currentEmail;
          
          if (emailMatches && parsedDraft.photoData && parsedDraft.photoData !== 'null' && parsedDraft.photoData !== 'undefined' && parsedDraft.photoData.length > 100) {
            photoData = parsedDraft.photoData;
            console.log('[AVATAR UI] ‚úÖ photoData r√©cup√©r√© depuis registerFormDraft (m√™me email:', currentEmail, ')');
            currentUser.photoData = photoData;
          } else if (parsedDraft.photoData && !emailMatches) {
            // Draft d'un autre compte - le supprimer pour √©viter les confusions
            console.log('[AVATAR UI] ‚ö†Ô∏è registerFormDraft ignor√© (email diff√©rent: draft=', draftEmail, 'current=', currentEmail, ')');
            // Nettoyer le draft obsol√®te
            localStorage.removeItem('registerFormDraft');
          }
        }
      } catch (e) {
        console.warn('[AVATAR UI] Erreur lecture registerFormDraft:', e);
      }
    }
    
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : V√©rifier aussi dans window.registerData
    // MAIS SEULEMENT si les donn√©es correspondent √† l'utilisateur connect√© (m√™me email)
    if (!photoData && window.registerData?.photoData) {
      const registerPhoto = window.registerData.photoData;
      const registerEmail = window.registerData.email?.toLowerCase?.() || '';
      const currentEmail = currentUser.email?.toLowerCase?.() || '';
      const emailMatches = registerEmail && currentEmail && registerEmail === currentEmail;
      
      if (emailMatches && registerPhoto !== 'null' && registerPhoto !== 'undefined' && registerPhoto !== '' && registerPhoto.length > 100) {
        photoData = registerPhoto;
        console.log('[AVATAR UI] ‚úÖ photoData r√©cup√©r√© depuis window.registerData (m√™me email)');
        currentUser.photoData = photoData;
      } else if (registerPhoto && !emailMatches) {
        console.log('[AVATAR UI] ‚ö†Ô∏è window.registerData ignor√© (email diff√©rent)');
        // Nettoyer les donn√©es obsol√®tes
        delete window.registerData;
      }
    }
    
    // V√©rifier si photoData existe et n'est pas null/undefined
    if (photoData && 
        photoData !== null && 
        photoData !== undefined &&
        typeof photoData === 'string' &&
        photoData.trim() !== '' &&
        photoData.length > 100) { // S'assurer que c'est une vraie photo (base64 ou URL)
      if (photoData.startsWith('data:image') || photoData.startsWith('http')) {
        rawAvatar = photoData;
        console.log('[AVATAR UI] ‚úÖ‚úÖ‚úÖ Utilisation photoData (photo upload√©e) - PRIORIT√â ABSOLUE');
      }
    }
    
    // 2. profile_photo_url S3 (pas Google)
    if (!rawAvatar && currentUser.profile_photo_url && 
        currentUser.profile_photo_url !== 'null' && 
        !currentUser.profile_photo_url.includes('googleusercontent.com') &&
        (currentUser.profile_photo_url.includes('amazonaws.com') || currentUser.profile_photo_url.startsWith('http'))) {
      rawAvatar = currentUser.profile_photo_url;
      console.log('[AVATAR UI] ‚úÖ Utilisation profile_photo_url (S3)');
    }
    
    // 3. profilePhoto (si pas Google)
    if (!rawAvatar && currentUser.profilePhoto && 
        currentUser.profilePhoto !== 'null' &&
        !currentUser.profilePhoto.includes('googleusercontent.com') &&
        (currentUser.profilePhoto.startsWith('http') || currentUser.profilePhoto.startsWith('data:image'))) {
      rawAvatar = currentUser.profilePhoto;
      console.log('[AVATAR UI] ‚úÖ Utilisation profilePhoto');
    }
    
    // 4. avatarUrl (si pas Google)
    if (!rawAvatar && currentUser.avatarUrl && 
        currentUser.avatarUrl !== 'null' &&
        !currentUser.avatarUrl.includes('googleusercontent.com') &&
        (currentUser.avatarUrl.startsWith('http') || currentUser.avatarUrl.startsWith('data:image'))) {
      rawAvatar = currentUser.avatarUrl;
      console.log('[AVATAR UI] ‚úÖ Utilisation avatarUrl');
    }
    
    // 5. avatar/Google en dernier recours
    if (!rawAvatar && currentUser.avatar && 
        currentUser.avatar !== 'null' &&
        (currentUser.avatar.startsWith('http') || currentUser.avatar.startsWith('data:image'))) {
      rawAvatar = currentUser.avatar;
      console.log('[AVATAR UI] ‚ö†Ô∏è Utilisation avatar (Google) - derni√®re option');
    }
    
    // Fallback: profile_photo_url m√™me si Google (mieux que rien)
    if (!rawAvatar && currentUser.profile_photo_url && 
        currentUser.profile_photo_url !== 'null' &&
        currentUser.profile_photo_url.startsWith('http')) {
      rawAvatar = currentUser.profile_photo_url;
      console.log('[AVATAR UI] ‚ö†Ô∏è Utilisation profile_photo_url (Google) - fallback');
    }
    
    // Normaliser photoData pour le log
    const photoDataForLog = currentUser.photoData === 'null' || currentUser.photoData === 'undefined' || !currentUser.photoData ? null : currentUser.photoData;
    
    console.log('[AVATAR UI] getUserAvatar - Analyse compl√®te:', {
      photoData: photoDataForLog ? (photoDataForLog.startsWith('data:') ? 'data:image...' : photoDataForLog.substring(0, 50) + '...') : 'null',
      photoDataType: typeof photoDataForLog,
      profile_photo_url: currentUser.profile_photo_url ? currentUser.profile_photo_url.substring(0, 50) + '...' : 'null',
      profile_photo_url_isS3: currentUser.profile_photo_url ? currentUser.profile_photo_url.includes('amazonaws.com') : false,
      profile_photo_url_isGoogle: currentUser.profile_photo_url ? currentUser.profile_photo_url.includes('googleusercontent.com') : false,
      profilePhoto: currentUser.profilePhoto ? currentUser.profilePhoto.substring(0, 50) + '...' : 'null',
      avatarUrl: currentUser.avatarUrl ? currentUser.avatarUrl.substring(0, 50) + '...' : 'null',
      avatar: currentUser.avatar ? currentUser.avatar.substring(0, 50) + '...' : 'null',
      resolved: rawAvatar ? (rawAvatar.startsWith('data:') ? 'data:image...' : rawAvatar.substring(0, 50) + '...') : 'null'
    });
    
    // Si pas de source, retourner emoji
    if (!rawAvatar || rawAvatar === "üë§") {
      console.log('[AVATAR UI] getUserAvatar: pas de source valide, retour emoji');
      return "üë§";
    }
    
    // Normaliser l'URL avec normalizeImageUrl
    const normalizedUrl = normalizeImageUrl(rawAvatar);
    
    // Si normalizeImageUrl retourne une URL valide, la retourner
    if (normalizedUrl) {
      console.log('[AVATAR UI] getUserAvatar retourne URL normalisee:', normalizedUrl.substring(0, 50) + '...');
      return normalizedUrl;
    }
    
    // Si ce n'est pas une URL valide (normalizeImageUrl a retourn√© null), retourner l'emoji
    // R√àGLE STRICTE : jamais de texte brut, seulement URL valide ou emoji
    console.warn('[AVATAR UI] getUserAvatar: valeur non-URL detectee, utilisation emoji:', rawAvatar.substring(0, 50));
    return "üë§";
  };
  
  // Exposer getUserAvatar globalement pour openAccountModal
  window.getUserAvatar = getUserAvatar;
  
  // Fonction pour obtenir le nom de l'utilisateur nettoy√©
  // IMPORTANT: Ne JAMAIS afficher l'email dans le header public
  // UNIQUEMENT le username choisi lors du formulaire d'inscription
  const getUserDisplayName = () => {
    // Permettre l'affichage du nom m√™me pendant le formulaire d'inscription (googleValidated)
    if (!currentUser || (!currentUser.isLoggedIn && !currentUser.googleValidated)) return "Compte";
    
    // R√àGLE STRICTE : UNIQUEMENT le nom d'utilisateur (username) choisi lors de l'inscription
    // PAS le pr√©nom Google, PAS l'email
    // Le username est obligatoire lors de la cr√©ation du compte
    
    let rawName = "Compte";
    
    // UNIQUEMENT username (seulement si ce n'est PAS un email)
    if (currentUser.username && 
        currentUser.username !== 'null' && 
        currentUser.username !== null &&
        currentUser.username !== '' &&
        currentUser.username !== 'Utilisateur' &&
        !currentUser.username.includes('@') &&
        currentUser.username !== currentUser.email) {
      rawName = currentUser.username;
    }
    
    // FORCER : Si c'est l'email ou contient @, utiliser "Compte"
    if (rawName === currentUser.email || rawName.includes('@')) {
      rawName = "Compte";
    }
    
    // Nettoyer le nom
    if (typeof cleanAccountText === 'function') {
      const cleanedName = cleanAccountText(rawName);
      return cleanedName || "Compte";
    } else {
      // Fallback : nettoyer manuellement
      return rawName.replace(/[<>]/g, '').trim() || "Compte";
    }
  };
  
  // Exposer getUserDisplayName globalement pour openAccountModal
  window.getUserDisplayName = getUserDisplayName;
  
  // PROTECTION INTELLIGENTE : MutationObserver pour afficher l'avatar/photo et le nom nettoy√©
  // mais bloquer les caract√®res ind√©sirables comme "om/Œµ"
  const protectAccountBlock = () => {
    const accountAvatar = document.getElementById("account-avatar");
    const accountName = document.getElementById("account-name");
    const accountBtn = document.getElementById("account-topbar-btn");
    
    if (accountAvatar && accountName && accountBtn) {
      // Permettre au bloc de s'agrandir si n√©cessaire
      accountBtn.style.minWidth = 'auto';
      accountBtn.style.maxWidth = 'none';
      accountBtn.style.width = 'auto';
      accountBtn.style.flexShrink = '0';
      
      // Obtenir les valeurs l√©gitimes (avatar/photo et nom nettoy√©)
      const validAvatar = getUserAvatar();
      const validName = getUserDisplayName();
      
      // V√©rifier et nettoyer l'avatar
      const currentAvatarContent = accountAvatar.textContent || accountAvatar.innerHTML || '';
      const hasImage = accountAvatar.querySelector('img');
      
      if (hasImage) {
        // Si c'est une image, v√©rifier que l'URL est valide
        const imgSrc = hasImage.src || '';
        if (!imgSrc || imgSrc === '') {
          // Pas d'image valide, afficher l'emoji
          accountAvatar.innerHTML = '';
          accountAvatar.textContent = "üë§"; // Toujours utiliser l'emoji, jamais de texte brut
        } else if (validAvatar.startsWith('http') || validAvatar.startsWith('data:image')) {
          // Mettre √† jour l'image si n√©cessaire
          if (imgSrc !== validAvatar) {
            hasImage.src = validAvatar;
            hasImage.onerror = function() {
              accountAvatar.innerHTML = '';
              accountAvatar.textContent = "üë§";
            };
          }
        }
      } else {
        // Pas d'image, v√©rifier le contenu texte
        if (validAvatar.startsWith('http') || validAvatar.startsWith('data:image')) {
          // C'est une URL d'image, cr√©er l'√©l√©ment img
          accountAvatar.innerHTML = '';
          accountAvatar.style.background = 'transparent'; // Enlever le fond pour la photo
          accountAvatar.style.border = 'none'; // Enlever la bordure pour la photo
          const img = document.createElement('img');
          img.src = validAvatar;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.borderRadius = '50%';
          img.style.objectFit = 'cover';
          img.style.display = 'block';
          img.onerror = function() {
            accountAvatar.innerHTML = '';
            accountAvatar.textContent = "üë§";
            accountAvatar.style.background = 'rgba(0, 255, 195, 0.1)';
            accountAvatar.style.border = '1px solid rgba(0, 255, 195, 0.2)';
          };
          accountAvatar.appendChild(img);
        } else {
          // C'est un emoji (pas une URL) - NE JAMAIS afficher de texte brut
          if (validAvatar === "üë§" || validAvatar.length <= 2) {
            // C'est un emoji valide
            accountAvatar.innerHTML = '';
            accountAvatar.textContent = validAvatar;
            accountAvatar.style.background = 'rgba(0, 255, 195, 0.1)';
            accountAvatar.style.border = '1px solid rgba(0, 255, 195, 0.2)';
          } else {
            // Ce n'est pas un emoji valide, forcer l'emoji par d√©faut
            console.warn('[AVATAR] Valeur non-emoji detectee dans protectAccountBlock, utilisation emoji par defaut:', validAvatar.substring(0, 50));
            accountAvatar.innerHTML = '';
            accountAvatar.textContent = "üë§";
            accountAvatar.style.background = 'rgba(0, 255, 195, 0.1)';
            accountAvatar.style.border = '1px solid rgba(0, 255, 195, 0.2)';
          }
        }
      }
      
      // V√©rifier et nettoyer le nom
      const currentNameContent = accountName.textContent || accountName.innerHTML || '';
      const cleanedName = cleanAccountText(currentNameContent);
      
      // Si le nom contient "om/" ou "Œµ" ou ne correspond pas au nom valide, le corriger
      if (currentNameContent.includes('om/') || currentNameContent.includes('Œµ') || 
          cleanedName !== currentNameContent || currentNameContent !== validName) {
        accountName.textContent = validName;
        accountName.innerHTML = validName;
      }
      
      // Observer pour emp√™cher les modifications avec caract√®res ind√©sirables
      // MAIS permettre l'affichage de la photo
      const accountObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'childList' || mutation.type === 'characterData') {
            const newAvatarContent = accountAvatar.textContent || '';
            const newNameContent = accountName.textContent || accountName.innerHTML || '';
            const hasImage = accountAvatar.querySelector('img');
            
            // V√©rifier l'avatar - seulement si ce n'est PAS une image valide
            if (!hasImage && (newAvatarContent.includes('om/') || newAvatarContent.includes('Œµ'))) {
              const validAvatar = getUserAvatar();
              if (validAvatar.startsWith('http') || validAvatar.startsWith('data:image')) {
                // C'est une URL d'image valide, forcer l'affichage
                updateAccountBlockLegitimately();
              } else {
                // C'est un emoji, afficher seulement l'emoji (jamais de texte brut)
                accountAvatar.innerHTML = '';
                accountAvatar.textContent = (validAvatar === "üë§" || validAvatar.length <= 2) ? validAvatar : "üë§";
              }
            }
            
            // V√©rifier le nom
            if (newNameContent.includes('om/') || newNameContent.includes('Œµ') || cleanAccountText(newNameContent) !== newNameContent) {
              accountName.textContent = getUserDisplayName();
              accountName.innerHTML = getUserDisplayName();
            }
          }
        });
      });
      
      // Observer les deux √©l√©ments
      accountObserver.observe(accountAvatar, { childList: true, characterData: true, subtree: true });
      accountObserver.observe(accountName, { childList: true, characterData: true, subtree: true });
    }
  };
  
  // Fonction pour mettre √† jour le bloc compte avec les valeurs l√©gitimes
  // NOTE: updateAuthButtons est d√©finie en haut du fichier (avant DOMContentLoaded)
  
  // Cache pour √©viter les appels inutiles
  let lastAccountState = {
    avatar: null,
    name: null
  };
  
  // ‚ö†Ô∏è Cache des URLs d'avatar qui ont √©chou√© (√©viter les retries infinis - NS_BINDING_ABORTED)
  const failedAvatarUrls = new Set();
  
  // FILET DE SECURITE : S'assurer que le bouton compte est TOUJOURS visible quand l'utilisateur est connecte
  function ensureAccountButtonVisible() {
    // Verifier toutes les sources possibles pour determiner si l'utilisateur est connecte
    let isLoggedIn = (currentUser && currentUser.isLoggedIn);
    if (!isLoggedIn) {
      try {
        const stored = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed && parsed.isLoggedIn) isLoggedIn = true;
        }
      } catch(e) {}
    }
    
    const btn = document.getElementById('account-topbar-btn');
    if (!btn) return;
    
    if (isLoggedIn) {
      if (btn.style.display === 'none' || btn.style.visibility === 'hidden' || getComputedStyle(btn).display === 'none') {
        console.warn('[ACCOUNT SAFETY] Bouton compte cache alors que user connecte - FORCE visible');
        btn.style.display = 'flex';
        btn.style.visibility = 'visible';
        btn.style.opacity = '1';
        btn.style.pointerEvents = 'auto';
      }
      // S'assurer que le contenu n'est pas vide
      const avatar = document.getElementById('account-avatar');
      const name = document.getElementById('account-name');
      if (avatar && !avatar.textContent && !avatar.querySelector('img')) {
        avatar.textContent = 'üë§';
      }
      if (name && (!name.textContent || name.textContent.trim() === '')) {
        name.textContent = currentUser?.username || currentUser?.name || 'Compte';
      }
    }
  }
  
  // Verifier periodiquement que le bloc compte est visible (toutes les 5s)
  setInterval(ensureAccountButtonVisible, 5000);
  
  const updateAccountBlockLegitimately = (retryCount = 0) => {
    // TOUJOURS appeler updateAuthButtons en premier - c'est ce qui montre/cache le bouton compte
    // Meme si les sous-elements ne sont pas prets, le bouton lui-meme doit etre visible
    updateAuthButtons();
    
    const accountAvatar = document.getElementById("account-avatar");
    const accountName = document.getElementById("account-name");
    
    if (!accountAvatar || !accountName) {
      // Retry automatique si DOM pas encore pret (max 10 tentatives, plus de marge)
      if (retryCount < 10) {
        setTimeout(() => updateAccountBlockLegitimately(retryCount + 1), 300);
      } else {
        console.warn('[ACCOUNT] account-avatar ou account-name non trouve apres 10 tentatives');
      }
      return;
    }
    
    const validAvatar = getUserAvatar();
    const validName = getUserDisplayName();
    
    // Verifier si quelque chose a change
    if (lastAccountState.avatar === validAvatar && lastAccountState.name === validName) {
      // Rien n'a change - mais s'assurer que le bouton est visible si connecte
      ensureAccountButtonVisible();
      return;
    }
    
    // Mettre √† jour le cache
    lastAccountState.avatar = validAvatar;
    lastAccountState.name = validName;
    
    console.log('[AVATAR UI] updateAccountBlockLegitimately appel√© (changement detecte):', {
      validAvatar: validAvatar.substring(0, 50),
      validName: validName,
      isImage: validAvatar.startsWith('http') || validAvatar.startsWith('data:image')
    });
    
    // Mettre √† jour l'avatar
    if (validAvatar.startsWith('http') || validAvatar.startsWith('data:image')) {
      // ‚ö†Ô∏è V√©rifier si cette URL a d√©j√† √©chou√© (√©viter retries infinis)
      // Extraire la base de l'URL (sans les param√®tres d'auth qui changent)
      const avatarBaseUrl = validAvatar.split('?')[0];
      if (failedAvatarUrls.has(avatarBaseUrl)) {
        console.log('[AVATAR UI] URL deja echouee, utilisation fallback:', avatarBaseUrl.substring(0, 50));
        accountAvatar.innerHTML = '';
        accountAvatar.textContent = "üë§";
        accountAvatar.style.background = 'rgba(0, 255, 195, 0.1)';
        accountAvatar.style.border = '1px solid rgba(0, 255, 195, 0.2)';
        // CRITIQUE: Mettre a jour le nom AVANT de sortir, et s'assurer que le bouton est visible
        if (accountName) accountName.textContent = validName;
        ensureAccountButtonVisible();
        return;
      }
      
      // C'est une URL d'image - FORCER l'affichage avec <img>
      // IMPORTANT: Log non ambigu AVANT d'assigner img.src pour v√©rifier l'URL compl√®te
      console.log('[AVATAR] using src length=', validAvatar.length, 'src=', validAvatar);
      console.log('[AVATAR] URL contient .amazonaws.com/avatars/:', validAvatar.includes('.amazonaws.com/avatars/'));
      
      const existingImg = accountAvatar.querySelector('img');
      if (!existingImg) {
        console.log('[AVATAR UI] Creation element img avec URL (log tronque):', validAvatar.substring(0, 50) + '...');
        accountAvatar.innerHTML = '';
        accountAvatar.style.background = 'transparent';
        accountAvatar.style.border = 'none';
        const img = document.createElement('img');
        // IMPORTANT: Utiliser l'URL compl√®te, JAMAIS tronqu√©e
        img.src = validAvatar;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.borderRadius = '50%';
        img.style.objectFit = 'cover';
        img.style.display = 'block';
        img.onerror = function() {
          console.error('[AVATAR UI] Erreur chargement image:', validAvatar.substring(0, 80));
          failedAvatarUrls.add(avatarBaseUrl);
          accountAvatar.innerHTML = '';
          accountAvatar.textContent = "üë§";
          accountAvatar.style.background = 'rgba(0, 255, 195, 0.1)';
          accountAvatar.style.border = '1px solid rgba(0, 255, 195, 0.2)';
          // CRITIQUE: S'assurer que le bouton compte reste visible malgre l'erreur avatar
          ensureAccountButtonVisible();
        };
        img.onload = function() {
          console.log('[AVATAR UI] ‚úÖ Image charg√©e avec succ√®s (URL compl√®te):', validAvatar);
          // ‚ö†Ô∏è Si l'image r√©ussit, la retirer du cache des √©checs (au cas o√π)
          failedAvatarUrls.delete(avatarBaseUrl);
        };
        accountAvatar.appendChild(img);
        console.log('[AVATAR UI] appliedToElement:', accountAvatar);
      } else if (existingImg.src !== validAvatar) {
        console.log('[AVATAR UI] Mise a jour image existante (URL compl√®te):', validAvatar);
        // IMPORTANT: Utiliser l'URL compl√®te, JAMAIS tronqu√©e
        existingImg.src = validAvatar;
        accountAvatar.style.background = 'transparent';
        accountAvatar.style.border = 'none';
        existingImg.onerror = function() {
          console.error('[AVATAR UI] Erreur chargement image maj:', validAvatar.substring(0, 80));
          failedAvatarUrls.add(avatarBaseUrl);
          accountAvatar.innerHTML = '';
          accountAvatar.textContent = "üë§";
          accountAvatar.style.background = 'rgba(0, 255, 195, 0.1)';
          accountAvatar.style.border = '1px solid rgba(0, 255, 195, 0.2)';
          // CRITIQUE: S'assurer que le bouton compte reste visible malgre l'erreur avatar
          ensureAccountButtonVisible();
        };
        existingImg.onload = function() {
          console.log('[AVATAR UI] ‚úÖ Image mise √† jour charg√©e avec succ√®s (URL compl√®te):', validAvatar);
          // ‚ö†Ô∏è Si l'image r√©ussit, la retirer du cache des √©checs
          failedAvatarUrls.delete(avatarBaseUrl);
        };
      } else {
        // Image d√©j√† pr√©sente et correcte, s'assurer que les styles sont bons
        accountAvatar.style.background = 'transparent';
        accountAvatar.style.border = 'none';
        // S'assurer qu'il n'y a pas de texte en plus de l'image
        if (accountAvatar.textContent && accountAvatar.textContent.trim() !== '') {
          accountAvatar.textContent = '';
        }
        console.log('[AVATAR UI] ‚úÖ Image d√©j√† pr√©sente et correcte');
      }
      } else {
        // C'est un emoji (pas une URL) - NE JAMAIS afficher de texte brut
        if (validAvatar === "üë§" || validAvatar.length <= 2) {
          // C'est un emoji valide
          console.log('[INFO] Affichage emoji:', validAvatar);
          accountAvatar.innerHTML = '';
          accountAvatar.textContent = validAvatar;
          accountAvatar.style.background = 'rgba(0, 255, 195, 0.1)';
          accountAvatar.style.border = '1px solid rgba(0, 255, 195, 0.2)';
        } else {
          // Ce n'est pas un emoji valide, forcer l'emoji par d√©faut
          console.warn('[AVATAR] Valeur non-emoji detectee dans updateAccountBlockLegitimately, utilisation emoji par defaut:', validAvatar.substring(0, 50));
          accountAvatar.innerHTML = '';
          accountAvatar.textContent = "üë§";
          accountAvatar.style.background = 'rgba(0, 255, 195, 0.1)';
          accountAvatar.style.border = '1px solid rgba(0, 255, 195, 0.2)';
        }
      }
    
    // Mettre √† jour le nom
    accountName.textContent = validName;
    accountName.innerHTML = validName;
  };
  
  // ‚úÖ Exposer globalement pour que auth.js puisse l'appeler apr√®s connexion
  window.updateAccountBlockLegitimately = updateAccountBlockLegitimately;
  
  // Prot√©ger imm√©diatement et p√©riodiquement
  protectAccountBlock();
  updateAccountBlockLegitimately();
  updateAuthButtons(); // Mettre √† jour les boutons auth au chargement
  setTimeout(() => {
    protectAccountBlock();
    updateAccountBlockLegitimately();
    updateAuthButtons();
  }, 100);
  setTimeout(() => {
    protectAccountBlock();
    updateAccountBlockLegitimately();
    updateAuthButtons();
  }, 500);
  // R√©duire la fr√©quence de v√©rification : toutes les 5 secondes au lieu de 1 seconde
  // updateAccountBlockLegitimately v√©rifie maintenant si quelque chose a chang√© avant de mettre √† jour
  setInterval(() => {
    protectAccountBlock();
    updateAccountBlockLegitimately(); // Ne mettra √† jour que si quelque chose a chang√©
    updateAuthButtons();
  }, 5000); // 5 secondes au lieu de 1 seconde
  
  // Mettre √† jour le bloc compte quand l'utilisateur se connecte
  const originalSetItem = localStorage.setItem;
  localStorage.setItem = function(key, value) {
    originalSetItem.apply(this, arguments);
    if (key === 'currentUser') {
      try {
        const user = JSON.parse(value);
        if (user && user.isLoggedIn) {
          // Mettre √† jour imm√©diatement et plusieurs fois pour √™tre s√ªr
          setTimeout(() => {
            updateAccountBlockLegitimately();
            protectAccountBlock();
          }, 50);
          setTimeout(() => {
            updateAccountBlockLegitimately();
            protectAccountBlock();
          }, 200);
          setTimeout(() => {
            updateAccountBlockLegitimately();
            protectAccountBlock();
          }, 500);
        }
      } catch (e) {
        // Ignorer les erreurs de parsing
      }
    }
  };
  
  // Exposer la fonction globalement pour debug
  window.updateAccountBlock = updateAccountBlockLegitimately;
  
  // D√©tecter les param√®tres URL pour mettre √† jour les m√©tadonn√©es Open Graph IMM√âDIATEMENT
  // Cela doit √™tre fait AVANT que les scrapers des r√©seaux sociaux ne lisent la page
  const urlParams = new URLSearchParams(window.location.search);
  const eventId = urlParams.get('event');
  const bookingId = urlParams.get('booking');
  const serviceId = urlParams.get('service');
  
  if (eventId || bookingId || serviceId) {
    // Mettre √† jour les m√©tadonn√©es d√®s que possible
    checkUrlParamsAndUpdateMetadata();
  }
  
  // CRITIQUE : G√©rer le callback OAuth Google IMM√âDIATEMENT au chargement
  console.log('üîç V√©rification callback OAuth Google...');
  const oauthCode = urlParams.get('code');
  const oauthState = urlParams.get('state');
  
  if (oauthCode && oauthState) {
    console.log('‚úÖ Callback OAuth d√©tect√© dans l\'URL - Traitement...');
    console.log('üîç Code:', oauthCode.substring(0, 20) + '...');
    console.log('üîç State:', oauthState);
    
    // Appeler la fonction de gestion du callback
    handleCognitoCallbackIfPresent().catch(error => {
      console.error('‚ùå Erreur lors du traitement du callback OAuth:', error);
      showNotification('‚ùå Erreur lors de la connexion Google', 'error');
    });
  } else {
    console.log('‚ÑπÔ∏è Pas de callback OAuth dans l\'URL');
  }
  
  // initMap/initUI d√©j√† appel√©s en t√™te pour affichage instantan√©
  // Initialiser les alertes de proximit√©
  if (currentUser && currentUser.isLoggedIn) {
    checkProximityAlerts();
    updateProximityAlertsBadge();
    // V√©rifier les alertes toutes les 30 secondes
    setInterval(checkProximityAlerts, 30000);
  }

  // ============================================
  // INITIALISATION MODE EVENT PAR D√âFAUT
  // ============================================
  // FORCER le mode EVENT d√®s le chargement (sans clic n√©cessaire)
  currentMode = "event";
  
  // Initialiser les donn√©es de base - G√âN√âRATION IMM√âDIATE
  eventsData = [];
  bookingsData = [...demoBookingBase];
  servicesData = [...demoServiceBase];
  
  // Mettre √† jour les r√©f√©rences globales
  window.eventsData = eventsData;
  window.bookingsData = bookingsData;
  window.servicesData = servicesData;
  
  // G√©n√©ration de donn√©es IMM√âDIATE (pas d'attente)
  ensureDemoPoints();
  
  // Si toujours vide, g√©n√©ration d'urgence
  if (eventsData.length === 0) {
    console.warn(`‚ö†Ô∏è G√©n√©ration d'urgence imm√©diate...`);
    generateEmergencyEvents();
  }

  // FORCER l'affichage de TOUS les points IMM√âDIATEMENT
  filteredData = null;
  selectedCategories = [];
  timeFilter = null;
  dateRangeStart = null;
  dateRangeEnd = null;
  selectedDates = [];
  
  // CRITIQUE: Initialiser la langue AVANT tout le reste pour que window.translations soit disponible
  // S'assurer que window.translations est compl√®tement initialis√© AVANT initLanguage()
  if (typeof window !== 'undefined') {
    if (!window.translations || typeof window.translations !== 'object') {
      window.translations = { fr: {}, en: {}, es: {}, zh: {}, hi: {} };
    }
    // S'assurer que toutes les langues existent
    ['fr', 'en', 'es', 'zh', 'hi'].forEach(lang => {
      if (!window.translations[lang] || typeof window.translations[lang] !== 'object') {
        window.translations[lang] = window.translations[lang] || {};
      }
    });
  }
  initLanguage();
  
  // ‚ö†Ô∏è CRITIQUE: Restaurer la session (user + agenda) si token pr√©sent
  if (typeof getAuthToken === 'function' && getAuthToken()) {
    loadUserDataOnLogin().catch(err => {
      console.warn('[INIT] ‚ö†Ô∏è Restauration session (non bloquant):', err);
    });
  }
  
  // ‚ö†Ô∏è CHARGEMENT PROGRESSIF: Les events sont charg√©s via le viewport handler (onViewportChange)
  // PAS de chargement massif de tous les events au d√©marrage
  // loadEventsFromBackend() n'est plus appel√© ici - le viewport handler g√®re tout
  console.log('[INIT] üåç Mode viewport progressif activ√© - events charg√©s au zoom');
  
  // Charger les bookings r√©els depuis la base de donn√©es
  loadBookingsFromBackend().then(() => {
    console.log('[INIT] ‚úÖ Bookings r√©els charg√©s depuis la base de donn√©es');
  }).catch(err => {
    console.warn('[INIT] ‚ö†Ô∏è Erreur chargement bookings backend (non bloquant):', err);
  });
  
  // Charger les services r√©els depuis la base de donn√©es
  loadServicesFromBackend().then(() => {
    console.log('[INIT] ‚úÖ Services r√©els charg√©s depuis la base de donn√©es');
  }).catch(err => {
    console.warn('[INIT] ‚ö†Ô∏è Erreur chargement services backend (non bloquant):', err);
  });
  
  // G√©rer le deep linking (ouvrir un event depuis l'URL)
  const hasDeepLink = handleDeepLink();
  
  // NOTE: La v√©rification du profil Google se fait UNIQUEMENT dans handleCognitoCallbackIfPresent()
  // apr√®s le callback OAuth. On ne v√©rifie PAS automatiquement au chargement de la page.
  
  // NOTE: La v√©rification du profil Google se fait UNIQUEMENT dans handleCognitoCallbackIfPresent()
  // apr√®s le callback OAuth. On ne v√©rifie PAS automatiquement au chargement de la page.
  
  // Mettre √† jour l'UI pour refl√©ter le mode event actif IMM√âDIATEMENT
  setTimeout(() => {
    document.querySelectorAll(".mode-btn").forEach(btn => {
      const txt = btn.textContent.trim().toLowerCase();
      const key =
        txt.includes("event") ? "event" :
        txt.includes("booking") ? "booking" :
        txt.includes("service") ? "service" : "";
      btn.classList.toggle("active", key === "event");
    });
    
    // FORCER l'affichage de TOUS les points - CRITIQUE !
    filteredData = null; // null = afficher TOUS les points
    selectedCategories = []; // Aucune cat√©gorie s√©lectionn√©e
    timeFilter = null;
    dateRangeStart = null;
    dateRangeEnd = null;
    selectedDates = [];
    
    // G√©n√©rer les points de base AVANT d'afficher
    ensureDemoPoints();
    
    // MODE VIEWPORT: pas besoin de donn√©es demo, le viewport progressif g√®re le chargement
    // Le premier loadViewportData() a d√©j√† √©t√© d√©clench√© dans initMap()
    console.log(`üöÄ Affichage initial via viewport progressif (eventsData sera rempli au zoom)`);
  }, 300); // D√©lai pour laisser le temps √† la map de s'initialiser

  // Charger les arbres de cat√©gories
  loadCategoryTrees().then(() => {
    // MODE VIEWPORT: pas de g√©n√©ration de donn√©es demo
    // Les events r√©els sont charg√©s progressivement via loadViewportData()
    console.log('[INIT] üåç Arbres de cat√©gories charg√©s - events via viewport progressif');
    
    // R√©initialiser les filtres
    filteredData = null;
    selectedCategories = [];
    timeFilter = null;
    dateRangeStart = null;
    dateRangeEnd = null;
    selectedDates = [];
    
    // Initialiser l'historique des statuts pour les alertes
    initEventStatusHistory();
    
    // V√©rifier les changements d'√©v√©nements toutes les 30 secondes
    setInterval(checkEventChanges, 30000);
    
    // Mettre √† jour le badge abonnement et le panier
    setTimeout(() => {
      updateSubscriptionBadge();
      updateCartCount();
    }, 100);
  });
  
  // left panel ferm√© par d√©faut
});

// ============================================
// CHARGEMENT DES ARBRES (pour IMAGES uniquement)
// ============================================
function loadCategoryTrees() {
  // Essayer plusieurs chemins possibles selon la configuration du d√©ploiement
  const tryLoadTree = (filename, setter) => {
    const paths = [
      "trees/" + filename,
      "/trees/" + filename
    ];
    
    return Promise.race(
      paths.map(path => 
        fetch(path)
          .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          })
          .then(j => {
            console.log(`‚úÖ Charg√©: ${path}`);
            setter(j);
            return true;
          })
          .catch(() => null)
      )
    ).catch(() => {
      console.warn(`‚ö†Ô∏è Impossible de charger ${filename}`);
      return null;
    });
  };
  
  return Promise.all([
    tryLoadTree("events_tree.json", (j) => {
      EVENTS_TREE = j.Events || j;
    }),
    tryLoadTree("booking_tree.json", (j) => {
      BOOKING_TREE = j.Booking || j;
    }),
    tryLoadTree("service_tree.json", (j) => {
      SERVICE_TREE = j.Service || j;
    })
  ]).then(() => {
    // Une fois tous les arbres charg√©s, r√©g√©n√©rer les points avec les bonnes cat√©gories
    ensureDemoPoints();
    
    // FORCER l'affichage de TOUS les points (pas de filtre par d√©faut)
    filteredData = null;
    selectedCategories = [];
    timeFilter = null;
    dateRangeStart = null;
    dateRangeEnd = null;
    selectedDates = [];
    
    refreshMarkers();
    refreshListView();
    
    console.log(`üó∫Ô∏è Tous les points affich√©s : ${getCurrentData().length} ${currentMode}(s)`);
  });
}

// ============================================
// MAP
// ============================================
function initMapWithRetry(attempt) {
  attempt = attempt || 0;
  const el = document.getElementById("map");
  if (!el) {
    if (attempt < 8) setTimeout(() => initMapWithRetry(attempt + 1), 50 * (attempt + 1));
    return;
  }
  if (typeof L === "undefined") {
    if (attempt < 8) setTimeout(() => initMapWithRetry(attempt + 1), 50 * (attempt + 1));
    return;
  }
  try {
    initMap();
  } catch (e) {
    console.warn("[MAP] initMap √©chec tentative", attempt + 1, e);
    if (attempt < 5) setTimeout(() => initMapWithRetry(attempt + 1), 100 * (attempt + 1));
  }
}

function initMap() {
  map = L.map("map", { zoomControl: false }).setView([46.8182, 8.2275], 8);

  const theme = MAP_THEMES[mapThemeIndex];
  tileLayer = L.tileLayer(theme.url, {
    maxZoom: theme.maxZoom,
    attribution: theme.attribution
  });
  tileLayer.addTo(map);

  // ‚úÖ Masquer le loader d√®s que les premi√®res tuiles sont charg√©es
  tileLayer.once('load', function() {
    if (typeof window._hideAppLoader === 'function') window._hideAppLoader();
  });
  // Fallback : aussi sur 'tileload' (premi√®re tuile visible)
  tileLayer.once('tileload', function() {
    setTimeout(function() {
      if (typeof window._hideAppLoader === 'function') window._hideAppLoader();
    }, 200);
  });

  // ‚≠ê CLUSTERING PRO - Regroupement intelligent des marqueurs
  // Quand on zoom arri√®re, les marqueurs proches se regroupent automatiquement
  // Quand on clique sur un cluster √† zoom max, les marqueurs s'ouvrent en √©toile (spiderfy)
  markersLayer = L.markerClusterGroup({
    animate: false,
    animateAddingMarkers: false,
    
    // Distance de regroupement (en pixels) - augment√© pour garder les clusters group√©s plus longtemps
    maxClusterRadius: 100,
    
    // Afficher la zone couverte au survol du cluster
    showCoverageOnHover: false,
    chunkedLoading: true,
    chunkInterval: 50,
    chunkDelay: 100,
    
    // Zoom au clic sur le cluster (zoom d'abord, puis spiderfy si m√™me endroit)
    zoomToBoundsOnClick: true,
    
    // ‚≠ê SPIDERFY : quand des marqueurs sont empil√©s au m√™me endroit,
    // un clic les d√©ploie en cercle/spirale pour pouvoir cliquer sur chacun
    spiderfyOnMaxZoom: true,
    spiderfyDistanceMultiplier: 1.8, // √âcartement plus grand entre les marqueurs d√©pli√©s
    
    // Ne PAS d√©sactiver le clustering trop t√¥t - garder actif jusqu'au zoom max
    // Comme √ßa les marqueurs au m√™me endroit restent group√©s et se "spiderfient" au clic
    disableClusteringAtZoom: null, // null = ne jamais d√©sactiver, toujours spiderfy
    
    // Personnalisation de l'ic√¥ne du cluster - d√©grad√© th√®me UI (accent + bordure)
    iconCreateFunction: function(cluster) {
      const count = cluster.getChildCount();
      let size = 'small';
      
      if (count < 10) {
        size = 'small';
      } else if (count < 100) {
        size = 'medium';
      } else {
        size = 'large';
      }
      
      const theme = getThemeMarkerColors();
      const t = UI_THEMES[typeof uiThemeIndex !== "undefined" ? uiThemeIndex : 0];
      const clusterGrad = t && t.clusterGradient;
      const bgColor = theme.accent;
      const borderColor = theme.border;
      const sizePx = size === 'small' ? 32 : size === 'medium' ? 38 : 46;
      // Priorite: gradient custom > gradient theme > fallback
      const customGrad = theme.gradient ? buildMarkerGradient(theme.gradient, 135) : null;
      const clusterBg = customGrad || clusterGrad || `linear-gradient(135deg,${bgColor} 0%,${borderColor} 100%)`;
      const borderW = size === 'small' ? 1 : 1.5;
      
      const totalSize = sizePx + 4;
      return L.divIcon({
        html: `<div style="
          background: ${clusterBg};
          border-radius: 50%;
          width: ${sizePx}px;
          height: ${sizePx}px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          font-size: ${size === 'small' ? 11 : size === 'medium' ? 13 : 15}px;
          color: #fff;
          text-shadow: 0 1px 2px rgba(0,0,0,0.5);
          box-shadow: 0 2px 10px rgba(0,0,0,0.3);
          border: ${borderW}px solid ${borderColor};
          position: relative;
        "><span style="position:relative;z-index:1;">${count}</span></div>`,
        className: 'custom-cluster-icon',
        iconSize: L.point(totalSize, totalSize),
        // Ancrer le cluster bien plus haut pour d√©gager les noms de villes
        iconAnchor: L.point(totalSize / 2, totalSize + 10)
      });
    }
  });
  // NE PAS ajouter markersLayer √† la carte tout de suite - il sera ajout√© quand zoom >= 10
  // markersLayer.addTo(map) sera fait dans loadViewportData quand on passe en mode events
  
  // üåç LAYER CERCLES G√âO - pour les agr√©gats aux faibles zooms
  geoCirclesLayer = L.layerGroup().addTo(map);
  
  // üîÑ VIEWPORT HANDLER - chargement progressif au d√©placement/zoom
  map.on('moveend', onViewportChange);
  map.on('zoomend', onViewportChange);
  
  // Charger les donn√©es initiales pour le viewport actuel
  setTimeout(() => loadViewportData(), 500);
  
  // ‚ö†Ô∏è CRITIQUE ouverture mobile : forcer le rendu d√®s que possible (√©vite √©cran blanc/noir)
  function ensureMapVisible() {
    if (!map) return;
    map.invalidateSize();
  }
  requestAnimationFrame(ensureMapVisible);
  if (document.readyState === 'complete') {
    ensureMapVisible();
  } else {
    window.addEventListener('load', ensureMapVisible);
  }
  const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|webOS/i.test(navigator.userAgent);
  setTimeout(ensureMapVisible, 100);
  setTimeout(ensureMapVisible, 400);
  setTimeout(ensureMapVisible, 800);
  if (isMobile) {
    setTimeout(ensureMapVisible, 1200);
    setTimeout(ensureMapVisible, 1800);
  }
  window.addEventListener('pageshow', (e) => {
    if (e.persisted) ensureMapVisible();
    setTimeout(ensureMapVisible, 0);
  });
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && map) {
      ensureMapVisible();
      setTimeout(ensureMapVisible, 50);
      setTimeout(ensureMapVisible, 200);
    }
  });
  window.addEventListener('resize', () => {
    if (map) ensureMapVisible();
  });
  if (isMobile) {
    window.addEventListener('orientationchange', () => {
      setTimeout(ensureMapVisible, 100);
      setTimeout(ensureMapVisible, 400);
    });
  }
}

function getCurrentData() {
  let data = [];
  const now = new Date();
  
  if (currentMode === "event") {
    // ‚ö†Ô∏è CRITIQUE : Filtrer les √©v√©nements termin√©s (date pass√©e) de l'affichage sur la carte
    // Ils restent dans eventsData pour "Mes annonces" mais ne s'affichent plus sur la carte
    data = eventsData.filter(item => {
      if (!item || item.type !== "event") return false;
      
      // D√©terminer la date de fin de l'√©v√©nement
      let endDate = null;
      if (item.endDate) {
        endDate = new Date(item.endDate);
      } else if (item.end_date) {
        const endDateStr = item.end_date + (item.end_time ? 'T' + item.end_time : 'T23:59:59');
        endDate = new Date(endDateStr);
      } else if (item.startDate) {
        // Si pas de date de fin, utiliser la date de d√©but
        endDate = new Date(item.startDate);
      } else if (item.date) {
        const dateStr = item.date + (item.time ? 'T' + item.time : 'T23:59:59');
        endDate = new Date(dateStr);
      }
      
      // Si pas de date ou date invalide, garder l'√©v√©nement (donn√©es incompl√®tes)
      if (!endDate || isNaN(endDate.getTime())) return true;
      
      // Exclure les √©v√©nements dont la date de fin est pass√©e
      return endDate >= now;
    });
  } else if (currentMode === "booking") {
    data = bookingsData.filter(item => item && item.type === "booking");
  } else if (currentMode === "service") {
    data = servicesData.filter(item => item && item.type === "service");
  }
  console.log(`üìä getCurrentData() - Mode: ${currentMode}, ${data.length} items (eventsData: ${eventsData.length}, bookingsData: ${bookingsData.length}, servicesData: ${servicesData.length})`);
  return data;
}

function getActiveData() {
  // Si filteredData est null, retourner TOUS les points (pas de filtre actif)
  // Si filteredData est un tableau, retourner les points filtr√©s
  if (filteredData === null) {
    return getCurrentData(); // TOUS les points
  }
  return filteredData; // Points filtr√©s
}

// Protection contre les appels r√©cursifs multiples
let isRefreshingMarkers = false;
let lastRefreshTime = 0;
const REFRESH_COOLDOWN = 1000; // 1 seconde entre chaque refresh

function refreshMarkers() {
  // Protection contre les appels multiples trop rapides
  const now = Date.now();
  if (now - lastRefreshTime < REFRESH_COOLDOWN && isRefreshingMarkers) {
    // Ignorer silencieusement pour √©viter les milliers de messages
    return;
  }
  
  // Protection contre les appels r√©cursifs multiples
  if (isRefreshingMarkers) {
    return; // Ignorer silencieusement
  }
  
  lastRefreshTime = now;
  
  if (!markersLayer) {
    console.warn("‚ö†Ô∏è markersLayer n'est pas initialis√©");
    return;
  }
  
  if (!map) {
    console.warn("‚ö†Ô∏è map n'est pas initialis√©");
    return;
  }
  
  // S'assurer que window.t() est disponible avant de continuer
  if (typeof window.t !== 'function') {
    console.warn("‚ö†Ô∏è window.t() n'est pas disponible, attente...");
    // Protection contre les boucles infinies - limiter √† 10 tentatives
    if (!window._refreshMarkersAttempts) {
      window._refreshMarkersAttempts = 0;
    }
    if (window._refreshMarkersAttempts < 10) {
      window._refreshMarkersAttempts++;
      setTimeout(() => {
        isRefreshingMarkers = false; // R√©initialiser le flag avant la nouvelle tentative
        refreshMarkers();
      }, 100);
    } else {
      console.error("‚ùå Trop de tentatives pour refreshMarkers(), arr√™t");
      window._refreshMarkersAttempts = 0;
      isRefreshingMarkers = false;
    }
    return;
  }
  
  // R√©initialiser le compteur si window.t() est disponible
  window._refreshMarkersAttempts = 0;
  
  isRefreshingMarkers = true;
  
  // SUPPRIMER TOUS LES MARQUEURS AVANT D'AJOUTER LES NOUVEAUX
  markersLayer.clearLayers();
  markerMap = {};
  console.log(`üóëÔ∏è Tous les marqueurs supprim√©s avant rafra√Æchissement`);

  // FORCER l'affichage de TOUS les points si aucun filtre actif
  const data = getActiveData();
  
  console.log(`üìä Donn√©es pour mode ${currentMode}: ${data.length} items (eventsData: ${eventsData.length}, bookingsData: ${bookingsData.length}, servicesData: ${servicesData.length})`);
  
  if (!data || data.length === 0) {
    console.warn(`‚ö†Ô∏è Aucune donn√©e disponible pour le mode ${currentMode}`);
    console.log(`üí° Tentative de r√©g√©n√©ration des points...`);
    
    // Forcer la g√©n√©ration de donn√©es
    ensureDemoPoints();
    
    // Attendre un peu pour que les donn√©es soient g√©n√©r√©es
    setTimeout(() => {
      const dataAfter = getActiveData();
      console.log(`üìä Apr√®s ensureDemoPoints() - Mode: ${currentMode}, ${dataAfter.length} items (eventsData: ${eventsData.length}, bookingsData: ${bookingsData.length}, servicesData: ${servicesData.length})`);
      
      if (dataAfter && dataAfter.length > 0) {
        console.log(`‚úÖ ${dataAfter.length} points g√©n√©r√©s apr√®s ensureDemoPoints()`);
        // R√©essayer avec les nouvelles donn√©es (seulement si pas d√©j√† en cours)
        if (!isRefreshingMarkers) {
          isRefreshingMarkers = false; // R√©initialiser le flag avant l'appel r√©cursif
          refreshMarkers();
          refreshListView();
        }
      } else {
        console.error(`‚ùå Toujours aucune donn√©e apr√®s ensureDemoPoints() pour le mode ${currentMode}`);
        // G√©n√©rer au moins quelques points de base en urgence
        if (currentMode === "event" && eventsData.length === 0) {
          console.log(`üö® G√©n√©ration d'urgence de points de base...`);
          generateEmergencyEvents();
          if (!isRefreshingMarkers) {
            isRefreshingMarkers = false; // R√©initialiser le flag avant l'appel r√©cursif
            refreshMarkers();
            refreshListView();
          }
        }
      }
      // R√©initialiser le flag apr√®s la tentative
      isRefreshingMarkers = false;
    }, 50);
    return;
  }
  
  // Ne pas logger √† chaque refresh pour √©viter les milliers de messages
  // console.log(`üîÑ Refresh markers: ${data.length} points (filteredData: ${filteredData ? 'filtr√©' : 'null = tous les points'}) - Mode: ${currentMode}`);
  
  let added = 0;
  let skipped = 0;
  let errors = 0;
  
  // ‚ö° MOBILE PERF: Cr√©er les marqueurs par lots pour ne pas bloquer le thread
  const BATCH_SIZE = window.innerWidth <= 768 ? 150 : 500;
  const validItems = [];
  
  // Phase 1: filtrer les items valides (rapide)
  for (let i = 0; i < data.length; i++) {
    const item = data[i];
    if (!item || item.type !== currentMode) { skipped++; continue; }
    if (typeof item.lat !== "number" || typeof item.lng !== "number" || isNaN(item.lat) || isNaN(item.lng)) { skipped++; continue; }
    validItems.push(item);
  }
  
  // Phase 1b: construire la map des items au m√™me emplacement (pour navigation "livre")
  buildSameLocationMap(validItems);
  
  // Phase 2: cr√©er les marqueurs par lots
  function processBatch(startIdx) {
    const endIdx = Math.min(startIdx + BATCH_SIZE, validItems.length);
    for (let i = startIdx; i < endIdx; i++) {
      const item = validItems[i];
    try {
    const icon = buildMarkerIcon(item);
    const marker = L.marker([item.lat, item.lng], { icon });
        
        // ‚ö° PERF: NE PAS appeler buildPopupHtml ici - c'est fait dans le handler click
        // La popup Leaflet est imm√©diatement ferm√©e et remplac√©e par notre modal
        marker.bindPopup('', { maxWidth: 360 });
    
    // Intercepter l'ouverture de la popup Leaflet et la remplacer par notre modal avec scroll
    marker.on('popupopen', function() {
      marker.closePopup();
      currentPopupMarker = marker;
      const popupContent = buildPopupHtml(item);
      openPopupModal(popupContent, item);
    });
    
    markersLayer.addLayer(marker);
    const key = `${item.type}:${item.id}`;
    markerMap[key] = marker;
      added++;
    } catch (err) {
      errors++;
      if (errors === 1) {
          console.error(`‚ùå Premi√®re erreur marqueur:`, err.message || err);
        }
      }
    }
    
    if (endIdx < validItems.length) {
      // Encore des marqueurs √† cr√©er - yield au browser puis continuer
      requestAnimationFrame(() => processBatch(endIdx));
    } else {
      // Tous les marqueurs cr√©√©s - finaliser
      finalizeBatch();
    }
  }
  
  function finalizeBatch() {
  if (errors > 0 || added === 0) {
    console.log(`‚úÖ ${added} marqueurs affich√©s (mode: ${currentMode})${skipped > 0 ? `, ${skipped} ignor√©s` : ''}${errors > 0 ? `, ${errors} erreurs` : ''}`);
  }
  
  if (currentUser && currentUser.isLoggedIn) {
    checkProximityAlerts();
  }
  
  cleanExpiredEvents();
  
    // fitBounds seulement au premier chargement (pas quand on rafra√Æchit les couleurs)
    if (added > 0 && !window._mapInitialFitDone && markersLayer && typeof markersLayer.getBounds === 'function') {
    try {
      const bounds = markersLayer.getBounds();
      if (bounds && bounds.isValid && bounds.isValid()) {
        map.fitBounds(bounds.pad(0.1));
          window._mapInitialFitDone = true;
      }
      } catch (e) {}
  }
  
    setTimeout(() => { isRefreshingMarkers = false; }, 100);
  
  refreshDiscoveryCarousel();
  }
  
  // Lancer le traitement par lots
  if (validItems.length > 0) {
    processBatch(0);
  } else {
    finalizeBatch();
  }
}

// Mode d√©couverte par swipe - cartes horizontales en bas (mobile)
function refreshDiscoveryCarousel() {
  const container = document.getElementById("discovery-carousel");
  const inner = document.getElementById("discovery-carousel-inner");
  if (!container || !inner) return;
  const isMobile = window.innerWidth <= 768;
  if (!isMobile) {
    container.classList.remove("has-items");
    return;
  }
  const data = getActiveData();
  const items = data.slice(0, 20);
  if (items.length === 0) {
    container.classList.remove("has-items");
    inner.innerHTML = "";
    return;
  }
  container.classList.add("has-items");
  const getEmoji = (it) => {
    if (!it) return "üìå";
    const c = (it.categories || [])[0] || "";
    if (c.includes("Musique") || c.includes("Music")) return "üéµ";
    if (c.includes("Sport")) return "‚öΩ";
    if (c.includes("Culture")) return "üé≠";
    return "üìå";
  };
  inner.innerHTML = items.map(item => {
    const type = item.type || currentMode;
    const id = item.id;
    const title = escapeHtml((item.title || item.name || "‚Äî").substring(0, 40));
    const sub = item.city || item.address || "";
    const dateStr = item.startDate ? new Date(item.startDate).toLocaleDateString("fr-FR", { day: "numeric", month: "short" }) : "";
    return `
      <div class="discovery-card" data-type="${type}" data-id="${id}" data-lat="${item.lat}" data-lng="${item.lng}">
        <div style="display:flex;align-items:center;gap:12px;padding:12px;height:100%;">
          <span style="font-size:28px;">${getEmoji(item)}</span>
          <div style="flex:1;min-width:0;">
            <div style="font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${title}</div>
            <div style="font-size:11px;color:var(--ui-text-muted);">${dateStr ? "üìÖ " + dateStr : ""} ${sub ? "üìç " + escapeHtml(sub).substring(0, 25) : ""}</div>
          </div>
        </div>
      </div>
    `;
  }).join("");
  inner.querySelectorAll(".discovery-card").forEach(card => {
    card.addEventListener("click", () => {
      if (navigator.vibrate) navigator.vibrate(10);
      const type = card.dataset.type;
      const id = card.dataset.id;
      const lat = parseFloat(card.dataset.lat);
      const lng = parseFloat(card.dataset.lng);
      if (map && !isNaN(lat) && !isNaN(lng)) {
        map.setView([lat, lng], Math.max(map.getZoom(), 15), { animate: true });
      }
      openPopupFromList(type, id);
    });
  });
}

// ============================================
// LOGIQUE IMAGES ‚Äì AUCUN √âCRAN NOIR
// ============================================

// Liste compl√®te des fichiers images disponibles par mode
const AVAILABLE_IMAGES = {
  event: [
    "afro", "afrobeats", "arts vivants", "atelier", "auto", "balkan", "BassMusic", "blind test",
    "brocante", "buiseness & communaut√©", "Carnaval", "Chillambient", "cin√©ma", "cirque", "Conduite",
    "conf√©rence", "conte", "course √† pied", "culture g√©n√©rale", "danse", "d√©bat", "d√©fil√©", 
    "d√©gustation bi√®re", "d√©gustation gastronomie", "d√©gustation spiritueux", "d√©gustation vin",
    "Drum&Bass", "Dub", "electronic", "eventdefault", "exposition", "festival & grandes f√™tes", "foire",
    "folk", "foodanddrink", "HardMusic", "hardrock", "hiphop", "house", "indie",
    "jazzsoulfunk", "jeux-lottos", "karaoke", "latin", "live musique", "loisirs & animations",
    "lotto", "march√©", "marrionnette", "metal", "music", "networking", "open air", "op√©ra",
    "oriental", "parade", "peinture", "photographie", "PopVari√©t√©", "Pride", "punkrock",
    "quiz", "rallye", "rap", "reggae", "rencontre associative", "rencontre c√©libaire", "RnB",
    "rock", "salon", "sculpture", "ska", "Soir√©e jeux", "sportaquatique", "sportdeglisse",
    "sports", "sportsa√©riens", "Sportsterrestre", "street artjpg", "streetparade",
    "techno", "th√©√¢tre", "tournoi", "Trance", "trap", "urban", "vid√©o art", "world"
  ],
  booking: ["artistesDJs", "bookingdefault", "LiveActs", "performers", "VJ"],
  service: ["d√©corationart", "location de mat√©riel", "performers", "s√©curit√©etlogistique", "servicedefault", "technique", "VJ"]
};

// Extensions possibles
const IMAGE_EXTENSIONS = ["jpg", "jpeg", "png", "webp"];

// Trouve le meilleur fichier image correspondant √† une cat√©gorie
function findBestImageMatch(categoryName, mode) {
  if (!categoryName || !mode) return null;
  
  const availableImages = AVAILABLE_IMAGES[mode] || [];
  const searchName = categoryName.toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, ""); // Sans accents pour la recherche
  
  // 1. Recherche exacte (insensible √† la casse)
  for (const img of availableImages) {
    const imgLower = img.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    if (imgLower === searchName) {
      return img;
    }
  }
  
  // 2. Recherche par inclusion
  for (const img of availableImages) {
    const imgLower = img.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    if (imgLower.includes(searchName) || searchName.includes(imgLower)) {
      return img;
    }
  }
  
  // 3. Mappings personnalis√©s cat√©gorie ‚Üí image
  const categoryMappings = {
    // Electronic
    "techno": "techno", "acid techno": "techno", "minimal techno": "techno",
    "hard techno": "techno", "industrial techno": "techno", "melodic techno": "techno",
    "house": "house", "deep house": "house", "tech house": "house", "progressive house": "house",
    "trance": "Trance", "psytrance": "Trance", "goa": "Trance", "uplifting trance": "Trance",
    "progressive psy": "Trance", "dark psy": "Trance", "full on": "Trance", "forest": "Trance",
    "hi-tech": "Trance", "fullon": "Trance", "darkpsy": "Trance", "progressivepsy": "Trance",
    "drum & bass": "Drum&Bass", "dnb": "Drum&Bass", "neurofunk": "Drum&Bass", "jungle": "Drum&Bass",
    "liquid dnb": "Drum&Bass", "jump up": "Drum&Bass", "liquiddnb": "Drum&Bass", "jumpup": "Drum&Bass",
    "dubstep": "BassMusic", "bass music": "BassMusic", "riddim": "BassMusic",
    "hardstyle": "HardMusic", "hardcore": "HardMusic", "gabber": "HardMusic",
    "ambient": "Chillambient", "chillout": "Chillambient", "lofi": "Chillambient",
    "electronic": "electronic",
    
    // Urban
    "rap": "rap", "hip-hop": "hiphop", "hiphop": "hiphop", "trap": "trap",
    "rnb": "RnB", "r&b": "RnB", "afrobeats": "afrobeats", "afro": "afro",
    "dancehall": "reggae", "reggaeton": "latin",
    
    // Rock/Metal
    "rock": "rock", "indie rock": "indie", "punk": "punkrock", "punk rock": "punkrock",
    "punkrock": "punkrock", "metal": "metal", "hard rock": "hardrock",
    "alternative rock": "rock", "indie": "indie", "thrash metal": "metal", "metalcore": "metal",
    
    // Jazz/Soul
    "jazz": "jazzsoulfunk", "soul": "jazzsoulfunk", "funk": "jazzsoulfunk",
    "blues": "jazzsoulfunk", "swing": "jazzsoulfunk",
    
    // World
    "reggae": "reggae", "dub": "Dub", "ska": "ska", "latin": "latin",
    "balkan": "balkan", "oriental": "oriental", "world": "world", "folk": "folk",
    
    // Pop
    "pop": "PopVari√©t√©", "vari√©t√©": "PopVari√©t√©", "chanson fran√ßaise": "PopVari√©t√©",
    
    // Culture
    "cin√©ma": "cin√©ma", "cinema": "cin√©ma", "film": "cin√©ma",
    "th√©√¢tre": "th√©√¢tre", "theatre": "th√©√¢tre", "stand-up": "th√©√¢tre",
    "exposition": "exposition", "expo": "exposition", "galerie": "exposition",
    "conf√©rence": "conf√©rence", "d√©bat": "d√©bat", "workshop": "atelier", "atelier": "atelier",
    "danse": "danse",
    
    // Food
    "brunch": "d√©gustation gastronomie", "bbq": "d√©gustation gastronomie",
    "d√©gustation": "d√©gustation vin", "food": "d√©gustation gastronomie",
    "gastronomie": "d√©gustation gastronomie",
    
    // Loisirs
    "march√©": "march√©", "brocante": "brocante", "foire": "foire",
    "quiz": "quiz", "blind test": "blind test", "karaoke": "karaoke",
    "jeux": "Soir√©e jeux", "festival": "festival & grandes f√™tes", "open air": "open air",
    "festival musique": "festival & grandes f√™tes", "festivalmusique": "festival & grandes f√™tes",
    "carnaval": "Carnaval", "parade": "parade", "pride": "Pride",
    
    // Sport - formats "Sport > X" (cat√©gories scrap√©es)
    "sport > terrestre": "Sportsterrestre", "sport > course a pied": "Sportsterrestre",
    "sport > course √† pied": "Sportsterrestre", "sport > trail": "Sportsterrestre",
    "sport > marathon": "Sportsterrestre", "sport > triathlon": "Sportsterrestre",
    "sport > randonnee": "Sportsterrestre", "sport > randonn√©e": "Sportsterrestre",
    "sport > glisse": "sportdeglisse", "sport > ski": "sportdeglisse",
    "sport > aquatique": "sportaquatique", "sport > natation": "sportaquatique",
    "sport > aerien": "sportsa√©riens", "sport > a√©rien": "sportsa√©riens",
    "terrestre": "Sportsterrestre",
    // Sport - noms simples
    "sport": "sports", "course": "Sportsterrestre", "course a pied": "Sportsterrestre",
    "course √† pied": "Sportsterrestre",
    "trail": "Sportsterrestre", "cyclisme": "Sportsterrestre", "fitness": "Sportsterrestre",
    "marathon": "Sportsterrestre", "triathlon": "Sportsterrestre",
    "randonnee": "Sportsterrestre", "randonn√©e": "Sportsterrestre",
    "drill": "hiphop",
    "natation": "sportaquatique", "ski": "sportdeglisse", "snowboard": "sportdeglisse",
    
    // Booking
    "dj": "artistesDJs", "djs": "artistesDJs", "producteur": "artistesDJs",
    "live": "LiveActs", "live act": "LiveActs", "performer": "performers",
    "vj": "VJ", "mapping": "VJ",
    
    // Service
    "son": "technique", "lumi√®re": "technique", "technique": "technique",
    "d√©coration": "d√©corationart", "s√©curit√©": "s√©curit√©etlogistique",
    "location": "location de mat√©riel"
  };
  
  const mapping = categoryMappings[searchName];
  if (mapping) {
    return mapping;
  }
  
  // 4. Recherche par mots-cl√©s
  const words = searchName.split(/[\s\-\/&]+/).filter(Boolean);
  for (const word of words) {
    if (word.length < 3) continue;
    for (const img of availableImages) {
      const imgLower = img.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      if (imgLower.includes(word)) {
        return img;
      }
    }
  }
  
  return null;
}

// G√©n√®re diff√©rentes variantes possibles d'un nom de cat√©gorie
function generateCategoryNameVariants(name) {
  if (!name) return [];

  const original = String(name);
  const variants = new Set();
  
  // Utiliser le syst√®me de matching intelligent
  const mode = currentMode || "event";
  const bestMatch = findBestImageMatch(original, mode);
  
  if (bestMatch) {
    variants.add(bestMatch);
  }
  
  // Ajouter aussi les variantes classiques au cas o√π
  const base = original.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
  variants.add(original);
  variants.add(original.toLowerCase());
  variants.add(base);
  variants.add(base.replace(/\s+/g, ""));
  variants.add(base.charAt(0).toUpperCase() + base.slice(1));

  return Array.from(variants);
}

function getModeFolderForItem(item) {
  if (!item || !item.type) return null;
  const key = item.type.toLowerCase();
  return MODE_IMAGE_FOLDERS[key] || null;
}

// Retourne une liste de noms de cat√©gories de la plus sp√©cifique √† la plus g√©n√©rale
// PRIORIT√â : Cat√©gories sp√©cifiques d'abord, cat√©gories g√©n√©riques (Culture, Sport...) en dernier
function getCategoryLineageForItem(item) {
  const specific = [];
  const generic = [];
  
  // Cat√©gories trop g√©n√©riques qu'on met en fin de liste
  const GENERIC_SET = new Set([
    "culture", "culture g√©n√©rale", "sport", "sports", "musique", "music",
    "art", "loisirs", "divertissement", "√©v√©nement", "event"
  ]);
  
  // 1. Trier les cat√©gories : sp√©cifiques d'abord, g√©n√©riques en dernier
  if (item.categories && Array.isArray(item.categories)) {
    item.categories.forEach(cat => {
      if (!cat) return;
      const catLower = cat.toString().toLowerCase().trim();
      
      // Extraire la partie la plus sp√©cifique pour tester si g√©n√©rique
      const basePart = catLower.includes(" > ") ? catLower.split(" > ").pop().trim() : catLower;
      
      if (GENERIC_SET.has(basePart)) {
        if (!generic.includes(cat)) generic.push(cat);
      } else {
        if (!specific.includes(cat)) specific.push(cat);
        
        // Si format "X > Y", ajouter aussi Y seul en priorit√© (plus sp√©cifique)
        if (cat.includes(" > ")) {
          const parts = cat.split(" > ").map(p => p.trim());
          for (let i = parts.length - 1; i >= 0; i--) {
            if (!GENERIC_SET.has(parts[i].toLowerCase()) && !specific.includes(parts[i])) {
              specific.push(parts[i]);
            }
          }
        }
      }
    });
  }
  
  // 2. MainCategory - ajouter si pas d√©j√† inclus
  if (item.mainCategory) {
    const mc = item.mainCategory.toString().trim();
    const mcLower = mc.toLowerCase();
    if (GENERIC_SET.has(mcLower)) {
      if (!generic.includes(mc)) generic.push(mc);
    } else {
      if (!specific.includes(mc)) specific.push(mc);
    }
  }
  
  // 3. Analyse du titre pour trouver des mots-cl√©s de cat√©gorie
  const title = (item.title || '').toLowerCase();
  const titleMatches = [
    'exposition', 'concert', 'festival', 'th√©√¢tre', 'cin√©ma', 'danse', 'cirque', 'op√©ra',
    'jazz', 'rock', 'techno', 'house', 'electro', 'rap', 'hip hop', 'reggae', 'blues', 'folk', 'pop', 'metal',
    'ski', 'trail', 'randonn√©e', 'hockey', 'football', 'tennis', 'basketball', 'natation',
    'march√©', 'brocante', 'foire', 'carnaval', 'parade',
    'd√©gustation', 'vin', 'bi√®re', 'gastronomie',
    'conf√©rence', 'atelier', 'photo', 'peinture', 'sculpture'
  ];
  for (const kw of titleMatches) {
    if (title.includes(kw) && !specific.includes(kw) && !specific.some(s => s.toLowerCase().includes(kw))) {
      specific.push(kw);
    }
  }
  
  // 4. Combiner : sp√©cifiques d'abord, g√©n√©riques en dernier
  const result = [...specific, ...generic];
  
  // 5. Si aucune cat√©gorie trouv√©e, fallback
  if (result.length === 0) {
    const fallback = item.category || item.type || "";
    if (fallback) result.push(fallback);
  }
  
  return result;
}

// Construit la liste compl√®te des chemins d‚Äôimages possibles pour un item
function getImageCandidatesForItem(item) {
  const modeFolder = getModeFolderForItem(item);
  const candidates = [];

  if (!modeFolder) {
    candidates.push(OVERLAY_IMAGES.DEFAULT);
    return candidates;
  }

  // üî• PRIORIT√â N¬∞1 : Photo upload√©e par l'utilisateur (image_url depuis S3)
  // Cette image prend le dessus sur TOUT (cat√©gorie, IA, fallback)
  const userImage = item.image_url || item.imageUrl;
  if (userImage && userImage.startsWith('http')) {
    candidates.push(userImage);
  }

  // 0a) BOOKING : imageUrl (cover Audius) ou image par cat√©gorie
  if (item.type === "booking") {
    if (item.imageUrl && item.imageUrl.startsWith('http') && item.imageUrl !== userImage) {
      candidates.push(item.imageUrl);
    }
    const bookingImg = getCategoryImage(item);
    if (bookingImg) candidates.push(bookingImg);
  }

  // 0) Cat√©gorie image (fallback si pas de photo upload√©e)
  if (item.type === "event" || !item.type) {
    const bestImg = getCategoryImage(item);
    if (bestImg && !bestImg.includes('eventdefault')) {
      candidates.push(bestImg);
    }
  }

  // 1) si le back-end / IA fournit d√©j√† un nom de fichier
  if (item.categoryImage) {
    const forcedName = String(item.categoryImage);
    if (/\.(jpg|jpeg|png|webp)$/i.test(forcedName)) {
      candidates.push(
        `${ASSETS_BASE}/${CAT_IMG_DIR}/${modeFolder}/${forcedName}`
      );
    } else {
      ["jpg", "jpeg", "png", "webp"].forEach(ext => {
        candidates.push(
          `${ASSETS_BASE}/${CAT_IMG_DIR}/${modeFolder}/${forcedName}.${ext}`
        );
      });
    }
  }

  // 2) √† partir des noms de cat√©gories (cat√©gorie + parents)
  const lineage = getCategoryLineageForItem(item);
  const exts = ["jpg", "jpeg", "png", "webp"];

  lineage.forEach(name => {
    const variants = generateCategoryNameVariants(name);
    variants.forEach(v => {
      exts.forEach(ext => {
        candidates.push(
          `${ASSETS_BASE}/${CAT_IMG_DIR}/${modeFolder}/${v}.${ext}`
        );
      });
    });
  });

  // 3) fallback g√©n√©rique par mode (noms de fichiers r√©els)
  if (item.type === "booking") {
    candidates.push(
      `${ASSETS_BASE}/${CAT_IMG_DIR}/${modeFolder}/bookingdefault.jpg`
    );
  } else if (item.type === "service") {
    candidates.push(
      `${ASSETS_BASE}/${CAT_IMG_DIR}/${modeFolder}/servicedefault.jpg`
    );
  } else if (item.type === "event") {
    candidates.push(
      `${ASSETS_BASE}/${CAT_IMG_DIR}/${modeFolder}/eventdefault.jpg`
    );
  }

  // 4) fallback overlay global
  candidates.push(OVERLAY_IMAGES.DEFAULT);

  const unique = Array.from(new Set(candidates));
  return unique;
}

// Handler global image fallback
window.__mapEventImageFallback = function (img) {
  if (!img || !img.dataset) {
    // Si pas de fallback, afficher le gradient
    if (img) {
      img.style.display = "block";
      img.style.background = "linear-gradient(135deg,#3b82f6,#8b5cf6)";
      img.style.width = "100%";
      img.style.height = "200px";
    }
    return;
  }
  const list = (img.dataset.fallback || "").split("|").filter(Boolean);
  if (!list.length) {
    img.onerror = null;
    // Afficher le gradient si pas d'image par d√©faut
    img.style.display = "block";
    img.style.background = "linear-gradient(135deg,#3b82f6,#8b5cf6)";
    img.style.width = "100%";
    img.style.height = "200px";
    img.src = OVERLAY_IMAGES.DEFAULT;
    return;
  }
  const next = list.shift();
  img.dataset.fallback = list.join("|");
  img.src = next;
};

// Renvoie la balise <img> compl√®te
function buildMainImageTag(item, altText) {
  const candidates = getImageCandidatesForItem(item);
  const primary = candidates[0] || OVERLAY_IMAGES.DEFAULT;
  const fallbacks = candidates.slice(1).join("|");
  const altSafe = escapeHtml(altText || "");

  return `
    <img 
      src="${primary}"
      alt="${altSafe}"
      style="width:100%;min-height:280px;max-height:400px;object-fit:cover;display:block;margin:0;padding:0;border:none;box-sizing:border-box;background:linear-gradient(135deg,#3b82f6,#8b5cf6);vertical-align:top;"
      data-fallback="${escapeHtml(fallbacks)}"
      onerror="(function(img){try{if(window.__mapEventImageFallback){window.__mapEventImageFallback(img);}else{img.style.display='block';img.style.background='linear-gradient(135deg,#3b82f6,#8b5cf6)';img.style.width='100%';img.style.minHeight='280px';img.style.maxHeight='400px';img.style.objectFit='cover';img.style.verticalAlign='top';}}catch(e){console.warn('Image fallback error:',e);}})(this)"
      onload="this.style.background='transparent';this.style.display='block';"
      loading="eager"
    >
  `;
}

// ============================================
// ICONES & POPUPS ‚Äì BOOST & CAT
// ============================================
function getBoostColor(boost) {
  const colors = {
    bronze: "#cd7f32",
    silver: "#c0c0c0",
    gold: "#ffd700",
    platinum: "#ef4444" // Rouge pour platinum
  };
  if (!boost || boost === "basic") return "var(--ui-card-border)";
  return colors[boost] || "#a855f7";
}

// ============================================
// SYST√àME D'ENCH√àRES PLATINUM TOP 10 PAR R√âGION
// ============================================

// D√©finir les r√©gions (par canton en Suisse, par d√©partement en France, etc.)
function getRegionFromCoords(lat, lng) {
  // Suisse - par canton approximatif
  if (lat >= 45.8 && lat <= 47.9 && lng >= 5.9 && lng <= 10.5) {
    if (lng < 7.0) return "region_geneve";
    if (lng < 7.5 && lat < 46.8) return "region_lausanne";
    if (lng < 8.0) return "region_berne_ouest";
    if (lng < 8.6) return "region_berne_zurich";
    if (lat > 47.2) return "region_zurich_nord";
    return "region_zurich_sud";
  }
  // France
  if (lat >= 41.0 && lat <= 51.5 && lng >= -5.5 && lng <= 10.0) {
    if (lat > 48.5 && lng > 1.5 && lng < 3.5) return "region_paris";
    if (lat > 43.0 && lat < 44.5 && lng > 3.0 && lng < 8.0) return "region_sud_est";
    if (lat < 44.0 && lng < 0.5) return "region_sud_ouest";
    return "region_france_autre";
  }
  return "region_internationale";
}

// Calculer les rangs Platinum pour tous les √©v√©nements
function calculatePlatinumRanks() {
  // Grouper les √©v√©nements platinum par r√©gion
  const platinumByRegion = {};
  
  eventsData.forEach(ev => {
    if (ev.boost === "platinum") {
      const region = getRegionFromCoords(ev.lat, ev.lng);
      if (!platinumByRegion[region]) {
        platinumByRegion[region] = [];
      }
      platinumByRegion[region].push(ev);
    }
  });
  
  // Pour chaque r√©gion, trier par montant d'ench√®re et assigner les rangs
  Object.keys(platinumByRegion).forEach(region => {
    const events = platinumByRegion[region];
    
    // Trier par platinumBid d√©croissant (plus on paie, plus on est haut)
    events.sort((a, b) => (b.platinumBid || 15) - (a.platinumBid || 15));
    
    // Assigner les rangs (1 = Top 1, 10 = Top 10)
    events.forEach((ev, index) => {
      // Maximum Top 10, les autres restent √† 10
      ev.platinumRank = Math.min(index + 1, 10);
      ev.platinumRegion = region;
    });
  });
  
  // Aussi pour bookings et services
  bookingsData.forEach(b => {
    if (b.boost === "platinum") {
      const region = getRegionFromCoords(b.lat, b.lng);
      b.platinumRank = b.platinumRank || Math.floor(Math.random() * 10) + 1;
      b.platinumRegion = region;
    }
  });
  
  servicesData.forEach(s => {
    if (s.boost === "platinum") {
      const region = getRegionFromCoords(s.lat, s.lng);
      s.platinumRank = s.platinumRank || Math.floor(Math.random() * 10) + 1;
      s.platinumRegion = region;
    }
  });
}

// Obtenir le prix minimum pour atteindre un rang dans une r√©gion
function getMinBidForRank(region, targetRank) {
  const platinumInRegion = eventsData.filter(ev => 
    ev.boost === "platinum" && getRegionFromCoords(ev.lat, ev.lng) === region
  );
  
  if (platinumInRegion.length === 0) {
    // Personne dans la r√©gion = 15.- pour √™tre Top 1
    return 15;
  }
  
  // Trier par ench√®re d√©croissante
  platinumInRegion.sort((a, b) => (b.platinumBid || 15) - (a.platinumBid || 15));
  
  if (targetRank > platinumInRegion.length) {
    // Pas assez de personnes pour ce rang = 15.- minimum
    return 15;
  }
  
  // Pour √™tre √† ce rang, il faut payer plus que celui qui est actuellement √† ce rang
  const currentAtRank = platinumInRegion[targetRank - 1];
  return (currentAtRank?.platinumBid || 15) + 1;
}

// Mapping des cat√©gories vers leurs IMAGES
// Utilise les vraies images de cat√©gories au lieu des emojis
const CATEGORY_IMAGE_MAP = {
  // === MUSIQUE √âLECTRONIQUE ===
  "techno": "techno.jpg",
  "acid techno": "techno.jpg",
  "tech house": "house.jpg",
  "deep house": "house.jpg",
  "house": "house.jpg",
  "minimal": "electronic.jpg",
  "progressive house": "house.jpg",
  "trance": "Trance.jpeg",
  "psytrance": "Trance.jpeg",
  "progressive psy": "Trance.jpeg",
  "goa": "Trance.jpeg",
  "hardstyle": "HardMusic.jpg",
  "hardcore": "HardMusic.jpg",
  "gabber": "HardMusic.jpg",
  "drum and bass": "Drum&Bass.jpg",
  "dnb": "Drum&Bass.jpg",
  "jungle": "Drum&Bass.jpg",
  "dubstep": "BassMusic.jpg",
  "bass music": "BassMusic.jpg",
  "breakbeat": "electronic.jpg",
  "electro": "electronic.jpg",
  "electronic": "electronic.jpg",
  "edm": "electronic.jpg",
  "ambient": "Chillambient.jpg",
  "chill": "Chillambient.jpg",
  "downtempo": "Chillambient.jpg",
  "lounge": "Chillambient.jpg",
  "dub": "Dub.jpg",
  
  // === MUSIQUE URBAINE ===
  "rap": "rap.jpg",
  "hip hop": "hiphop.jpg",
  "hip-hop": "hiphop.jpg",
  "hiphop": "hiphop.jpg",
  "trap": "trap.jpg",
  "drill": "trap.jpg",
  "r&b": "RnB.jpg",
  "rnb": "RnB.jpg",
  "urban": "urban.jpg",
  
  // === MUSIQUE TRADITIONNELLE ===
  "rock": "rock.jpg",
  "rock alternatif": "rock.jpg",
  "indie rock": "indie.jpg",
  "indie": "indie.jpg",
  "punk": "punkrock.jpg",
  "punk rock": "punkrock.jpg",
  "metal": "metal.jpg",
  "heavy metal": "metal.jpg",
  "hard rock": "hardrock.jpg",
  "folk": "folk.jpg",
  "country": "folk.jpg",
  "jazz": "jazzsoulfunk.jpg",
  "soul": "jazzsoulfunk.jpg",
  "funk": "jazzsoulfunk.jpg",
  "blues": "jazzsoulfunk.jpg",
  "pop": "PopVari√©t√©.jpg",
  "vari√©t√©": "PopVari√©t√©.jpg",
  "chanson fran√ßaise": "PopVari√©t√©.jpg",
  "ska": "ska.jpg",
  "reggae": "reggae.jpg",
  "afro": "afro.jpg",
  "afrobeat": "afrobeats.jpg",
  "afrobeats": "afrobeats.jpg",
  "latin": "latin.jpg",
  "latino": "latin.jpg",
  "salsa": "latin.jpg",
  "bachata": "latin.jpg",
  "reggaeton": "latin.jpg",
  "balkan": "balkan.jpg",
  "oriental": "oriental.jpg",
  "world": "world.jpg",
  "op√©ra": "op√©ra.jpg",
  "classique": "op√©ra.jpg",
  "live": "live musique.jpg",
  "live musique": "live musique.jpg",
  "concert": "live musique.jpg",
  "music": "music.jpg",
  "musique": "music.jpg",
  
  // === √âV√âNEMENTS CULTURELS ===
  "culture": "culture g√©n√©rale.jpg",
  "culture g√©n√©rale": "culture g√©n√©rale.jpg",
  "festival": "festival & grandes f√™tes.jpg",
  "open air": "open air.jpg",
  "th√©√¢tre": "th√©√¢tre.jpg",
  "spectacle": "arts vivants.jpg",
  "arts vivants": "arts vivants.jpg",
  "danse": "danse.jpg",
  "ballet": "danse.jpg",
  "cirque": "cirque.jpg",
  "magie": "cirque.jpg",
  "cabaret": "arts vivants.jpg",
  "conte": "conte.jpg",
  "marionnette": "marrionnette.jpg",
  
  // === CIN√âMA & ART ===
  "cin√©ma": "cin√©ma.jpg",
  "film": "cin√©ma.jpg",
  "projection": "cin√©ma.jpg",
  "exposition": "exposition.jpg",
  "expo": "exposition.jpg",
  "mus√©e": "exposition.jpg",
  "galerie": "exposition.jpg",
  "photographie": "photographie.jpg",
  "photo": "photographie.jpg",
  "peinture": "peinture.jpg",
  "sculpture": "sculpture.jpg",
  "street art": "street artjpg.jpg",
  "vid√©o art": "vid√©o art.jpg",
  
  // === SPORTS ===
  "sport": "sports.jpg",
  "sports": "sports.jpg",
  // Cat√©gories scrap√©es au format "Sport > X"
  "sport > terrestre": "Sportsterrestre.jpg",
  "sport > glisse": "sportdeglisse.jpg",
  "sport > aquatique": "sportaquatique.png",
  "sport > a√©rien": "sportsa√©riens.jpg",
  "terrestre": "Sportsterrestre.jpg",
  // Sports terrestres sp√©cifiques
  "football": "Sportsterrestre.jpg",
  "tennis": "Sportsterrestre.jpg",
  "basketball": "Sportsterrestre.jpg",
  "hockey": "hockey sur glace.jpg",
  "hockey sur glace": "hockey sur glace.jpg",
  "match de hockey": "hockey sur glace.jpg",
  "course √† pied": "Sportsterrestre.jpg",
  "running": "Sportsterrestre.jpg",
  "marathon": "Sportsterrestre.jpg",
  "trail": "Sportsterrestre.jpg",
  "randonn√©e": "Sportsterrestre.jpg",
  "randonn√©e guid√©e": "Sportsterrestre.jpg",
  // Sports de glisse
  "ski": "sportdeglisse.jpg",
  "snowboard": "sportdeglisse.jpg",
  "glisse": "sportdeglisse.jpg",
  "patinage": "sportdeglisse.jpg",
  // Sports aquatiques
  "natation": "sportaquatique.png",
  "piscine": "sportaquatique.png",
  "aquatique": "sportaquatique.png",
  // Sports a√©riens
  "a√©rien": "sportsa√©riens.jpg",
  "parachute": "sportsa√©riens.jpg",
  "parapente": "sportsa√©riens.jpg",
  "auto": "auto.jpg",
  "rallye": "rallye.jpg",
  "conduite": "Conduite.jpg",
  "tournoi": "tournoi.jpg",
  
  // === GASTRONOMIE ===
  "food": "foodanddrink.jpg",
  "gastronomie": "d√©gustation gastronomie.jpg",
  "brunch": "foodanddrink.jpg",
  "d√©gustation vin": "d√©gustation vin.jpg",
  "vin": "d√©gustation vin.jpg",
  "d√©gustation bi√®re": "d√©gustation bi√®re.jpg",
  "bi√®re": "d√©gustation bi√®re.jpg",
  "d√©gustation spiritueux": "d√©gustation spiritueux.jpg",
  "cocktail": "d√©gustation spiritueux.jpg",
  
  // === MARCH√âS & FOIRES ===
  "march√©": "march√©.jpg",
  "brocante": "brocante.jpg",
  "vide-grenier": "brocante.jpg",
  "foire": "foire.jpg",
  "salon": "salon.jpg",
  "carnaval": "Carnaval.jpg",
  "parade": "parade.jpg",
  "street parade": "streetparade.jpg",
  "pride": "Pride.jpg",
  "d√©fil√©": "d√©fil√©.jpg",
  
  // === JEUX & ANIMATIONS ===
  "quiz": "quiz.jpg",
  "blind test": "blind test.jpg",
  "karaoke": "karaoke.jpg",
  "karaok√©": "karaoke.jpg",
  "jeux": "jeux-lottos.jpg",
  "soir√©e jeux": "Soir√©e jeux.jpg",
  "lotto": "lotto.jpg",
  "loterie": "lotto.jpg",
  "loisirs": "loisirs & animations.jpg",
  "animation": "loisirs & animations.jpg",
  
  // === BUSINESS & COMMUNAUT√â ===
  "conf√©rence": "conf√©rence.jpg",
  "s√©minaire": "conf√©rence.jpg",
  "networking": "networking.jpg",
  "business": "buiseness & communaut√©.jpg",
  "atelier": "atelier.jpg",
  "workshop": "atelier.jpg",
  "d√©bat": "d√©bat.jpg",
  "rencontre": "rencontre associative.jpg",
  "associatif": "rencontre associative.jpg",
  "c√©libataire": "rencontre c√©libaire.jpg"
};

// Mapping pour les SERVICES (mode service)
const SERVICE_IMAGE_MAP = {
  "dj": "booking/artistesDJs.jpg",
  "artiste": "booking/artistesDJs.jpg",
  "live": "booking/LiveActs.jpg",
  "live act": "booking/LiveActs.jpg",
  "d√©coration": "service/d√©corationart.jpg",
  "d√©cor": "service/d√©corationart.jpg",
  "art": "service/d√©corationart.jpg",
  "location": "service/location de mat√©riel.jpg",
  "mat√©riel": "service/location de mat√©riel.jpg",
  "performer": "service/performers.jpg",
  "danseur": "service/performers.jpg",
  "s√©curit√©": "service/s√©curit√©etlogistique.jpg",
  "logistique": "service/s√©curit√©etlogistique.jpg",
  "technique": "service/technique.jpg",
  "son": "service/technique.jpg",
  "lumi√®re": "service/technique.jpg",
  "vj": "service/VJ.jpg",
  "vid√©o": "service/VJ.jpg"
};

// Fonction pour obtenir l'image de cat√©gorie
function getCategoryImage(item) {
  const categories = item.categories || [];
  const type = item.type || "event";
  
  // Cat√©gories TROP G√âN√âRIQUES - on les utilise seulement en dernier recours
  // pour √©viter que "Culture" √©crase "Concert", "Musique", "Exposition" etc.
  const GENERIC_CATS = new Set([
    "culture", "culture g√©n√©rale", "sport", "sports", "musique", "music",
    "art", "loisirs", "divertissement", "√©v√©nement", "event"
  ]);
  
  // Helper pour chercher une image pour un mot-cl√©
  function findImageForKeyword(keyword) {
    const kw = keyword.toString().toLowerCase().trim();
    
    // 1. Correspondance exacte
    if (CATEGORY_IMAGE_MAP[kw]) {
      return `assets/category_images/event/${CATEGORY_IMAGE_MAP[kw]}`;
    }
    
    // 2. Recherche partielle (le mot-cl√© est dans une cl√© du mapping)
    for (const [key, img] of Object.entries(CATEGORY_IMAGE_MAP)) {
      // √âviter les correspondances trop larges (ex: "sport" matchant tout)
      if (kw.length > 3 && key.includes(kw)) {
        return `assets/category_images/event/${img}`;
      }
    }
    
    return null;
  }
  
  // Helper pour chercher dans une cat√©gorie (g√®re le format "X > Y > Z")
  function findImageForCategory(cat) {
    // 1. D'abord essayer la cat√©gorie compl√®te (ex: "sport > glisse")
    let img = findImageForKeyword(cat);
    if (img) return img;
    
    // 2. Si cat√©gorie au format "X > Y > Z", extraire les parties (plus sp√©cifique d'abord)
    if (cat.includes(" > ")) {
      const parts = cat.split(" > ").map(p => p.trim());
      for (let j = parts.length - 1; j >= 0; j--) {
        img = findImageForKeyword(parts[j]);
        if (img) return img;
      }
    }
    return null;
  }
  
  // === PASSE 1 : Chercher dans les cat√©gories SP√âCIFIQUES (ignorer les g√©n√©riques) ===
  let genericFallback = null;
  
  for (let i = 0; i < categories.length; i++) {
    const cat = categories[i].toString().toLowerCase().trim();
    
    // Services
    if (type === "service" && SERVICE_IMAGE_MAP[cat]) {
      return `assets/category_images/${SERVICE_IMAGE_MAP[cat]}`;
    }
    
    // Extraire le mot-cl√© le plus bas pour v√©rifier si c'est g√©n√©rique
    const baseCat = cat.includes(" > ") ? cat.split(" > ").pop().trim() : cat;
    
    if (GENERIC_CATS.has(baseCat)) {
      // Stocker comme fallback mais continuer √† chercher du plus sp√©cifique
      if (!genericFallback) {
        genericFallback = findImageForCategory(cat);
      }
      continue; // Passer aux cat√©gories suivantes
    }
    
    // Cat√©gorie sp√©cifique : la prendre en priorit√© !
    let img = findImageForCategory(cat);
    if (img) return img;
  }
  
  // === PASSE 2 : Essayer aussi dans le titre pour affiner ===
  const title = (item.title || '').toLowerCase();
  const titleKeywords = [
    'concert', 'festival', 'exposition', 'expo', 'th√©√¢tre', 'cin√©ma', 'film',
    'danse', 'cirque', 'op√©ra', 'spectacle', 'march√©', 'brocante', 'foire',
    'conf√©rence', 'atelier', 'workshop', 'carnaval', 'parade',
    'techno', 'house', 'jazz', 'rock', 'rap', 'electro', 'hip hop', 'reggae',
    'blues', 'folk', 'pop', 'metal', 'punk', 'salsa', 'latin',
    'ski', 'trail', 'randonn√©e', 'hockey', 'football', 'tennis', 'basketball',
    'rugby', 'golf', 'natation', 'triathlon', 'marathon', 'course',
    'd√©gustation', 'vin', 'bi√®re', 'brunch', 'gastronomie', 'food',
    'quiz', 'karaoke', 'karaok√©', 'lotto', 'blind test',
    'photo', 'peinture', 'sculpture'
  ];
  for (const kw of titleKeywords) {
    if (title.includes(kw)) {
      const img = findImageForKeyword(kw);
      if (img) return img;
    }
  }
  
  // === PASSE 3 : Fallback sur la cat√©gorie g√©n√©rique si trouv√©e ===
  if (genericFallback) return genericFallback;
  
  // Essayer avec mainCategory
  if (item.mainCategory) {
    const mainCat = item.mainCategory.toString().toLowerCase().trim();
    let img = findImageForKeyword(mainCat);
    if (img) return img;
  }
  
  // Image par d√©faut selon le type
  if (type === "booking") return "assets/category_images/booking/bookingdefault.jpg";
  if (type === "service") return "assets/category_images/service/servicedefault.jpg";
  return "assets/category_images/event/eventdefault.jpg";
}

function getCategoryEmoji(item) {
  // Concat√©ner TOUTES les cat√©gories + le titre pour un matching plus intelligent
  const categories = item.categories || [];
  const allCats = categories.map(c => c.toString().toLowerCase()).join(' ');
  const title = (item.title || '').toLowerCase();
  const combined = allCats + ' ' + title;

  // V√©rifier du plus sp√©cifique au plus g√©n√©rique
  // Musique √©lectronique
  if (combined.includes("techno") || combined.includes("house") || 
      combined.includes("trance") || combined.includes("electro") ||
      combined.includes("drum") || combined.includes("dubstep"))
    return "üéß";
  // Musique urbaine
  if (combined.includes("rap") || combined.includes("hip hop") || combined.includes("hip-hop") || combined.includes("trap"))
    return "üé§";
  // Rock/Metal
  if (combined.includes("rock") || combined.includes("metal") || combined.includes("punk"))
    return "üé∏";
  // Jazz/Soul/Funk/Blues
  if (combined.includes("jazz") || combined.includes("soul") || combined.includes("funk") || combined.includes("blues"))
    return "üé∑";
  // Reggae/World
  if (combined.includes("reggae") || combined.includes("afro") || combined.includes("world") || combined.includes("latin"))
    return "üé∂";
  // Concert/Musique live (apr√®s les genres sp√©cifiques)
  if (combined.includes("concert") || combined.includes("live musique") || combined.includes("musique > "))
    return "üéµ";
  // Festival
  if (combined.includes("festival") || combined.includes("open air"))
    return "üé™";
  // Cin√©ma
  if (combined.includes("cin√©") || combined.includes("film") || combined.includes("projection"))
    return "üé¨";
  // Th√©√¢tre/Spectacle
  if (combined.includes("th√©√¢tre") || combined.includes("spectacle") || combined.includes("cabaret") || combined.includes("cirque"))
    return "üé≠";
  // Danse
  if (combined.includes("danse") || combined.includes("ballet"))
    return "üíÉ";
  // Exposition/Mus√©e
  if (combined.includes("exposition") || combined.includes("expo") || combined.includes("mus√©e") || combined.includes("galerie"))
    return "üñºÔ∏è";
  // Photo/Art
  if (combined.includes("photo") || combined.includes("peinture") || combined.includes("sculpture") || combined.includes("street art"))
    return "üé®";
  // Sports sp√©cifiques
  if (combined.includes("ski") || combined.includes("snowboard") || combined.includes("glisse") || combined.includes("patinage"))
    return "‚õ∑Ô∏è";
  if (combined.includes("hockey"))
    return "üèí";
  if (combined.includes("football") || combined.includes("foot"))
    return "‚öΩ";
  if (combined.includes("tennis"))
    return "üéæ";
  if (combined.includes("basketball") || combined.includes("basket"))
    return "üèÄ";
  if (combined.includes("randonn√©e") || combined.includes("trail") || combined.includes("marche"))
    return "ü•æ";
  if (combined.includes("natation") || combined.includes("aquatique") || combined.includes("piscine"))
    return "üèä";
  if (combined.includes("v√©lo") || combined.includes("cyclisme") || combined.includes("vtt"))
    return "üö¥";
  // Sport g√©n√©ral (apr√®s les sp√©cifiques)
  if (combined.includes("sport") || combined.includes("course") || combined.includes("marathon") || combined.includes("triathlon"))
    return "üèÖ";
  // Gastronomie
  if (combined.includes("d√©gustation") || combined.includes("vin") || combined.includes("cave") || combined.includes("vigneron"))
    return "üç∑";
  if (combined.includes("food") || combined.includes("brunch") || combined.includes("bbq") || combined.includes("gastronomie") || combined.includes("culinaire"))
    return "üçΩÔ∏è";
  if (combined.includes("bi√®re") || combined.includes("beer"))
    return "üç∫";
  // March√©s
  if (combined.includes("march√©") || combined.includes("brocante") || combined.includes("foire"))
    return "üõí";
  // Business/Conf√©rence
  if (combined.includes("conf√©rence") || combined.includes("s√©minaire") || combined.includes("networking"))
    return "üéôÔ∏è";
  if (combined.includes("atelier") || combined.includes("workshop"))
    return "üîß";
  // Carnaval/F√™te
  if (combined.includes("carnaval") || combined.includes("parade") || combined.includes("f√™te"))
    return "üéâ";
  // Conte/Lecture
  if (combined.includes("conte") || combined.includes("lecture") || combined.includes("litt√©ra"))
    return "üìñ";
  // Musique g√©n√©rique (si on a "musique" mais pas de genre pr√©cis)
  if (combined.includes("musique") || combined.includes("music") || combined.includes("concert"))
    return "üéµ";
  // Services
  if (combined.includes("lumi√®re")) return "üí°";
  if (combined.includes("dj")) return "üîä";
  if (combined.includes("s√©curit√©")) return "üõ°Ô∏è";

  return "üìç";
}

function getCategoryColor(item) {
  const cat = (
    item.mainCategory ||
    (item.categories && item.categories[0]) ||
    ""
  )
    .toString()
    .toLowerCase();

  if (
    cat.includes("techno") ||
    cat.includes("electro") ||
    cat.includes("trance")
  )
    return "#0f172a";
  if (cat.includes("rap") || cat.includes("trap")) return "#111827";
  if (cat.includes("rock") || cat.includes("metal")) return "#1f2937";
  if (cat.includes("festival") || cat.includes("open air")) return "#7c2d12";
  if (cat.includes("march√©") || cat.includes("food")) return "#78350f";
  if (cat.includes("sport")) return "#14532d";
  if (cat.includes("lumi√®re") || cat.includes("visuel")) return "#312e81";

  return "#020617";
}

function buildMarkerIcon(item) {
  const boost = item.boost || "basic";
  const platinumRank = item.platinumRank || 10; // Rang dans le Top 10 (1 = Top 1, 10 = Top 10)
  const isAI = item.isAI || item.aiGenerated || false;
  const emoji = getCategoryEmoji(item);
  const categoryImg = getCategoryImage(item);
  
  // ============================================
  // MARQUEUR ROND ORANGE POUR √âV√âNEMENTS SCRAP√âS
  // ============================================
  // Scrap√© = a une source_url ET (validation auto_validated/pending OU creator est system_scraper OU pas de creator_id)
  const isScraped = item.source_url && (
    item.validation_status === 'auto_validated' || 
    item.validation_status === 'pending' ||
    item.creator_id === 'system_scraper' ||
    !item.creator_id
  );
  
  if (isScraped) {
    const isMobile = typeof window !== 'undefined' && window.innerWidth <= 768;
    const sizePx = isMobile ? 44 : 40;
    const pinHeight = 12;
    
    // Couleur orange pour tous les scrap√©s
    const scrapedBorder = '#f59e0b';
    
    const scrapedHtml = `
      <div class="marker-scraped" style="position:relative;">
        <div style="
          background:linear-gradient(145deg, #f59e0b, #d97706);
          border:2.5px solid ${scrapedBorder};
          box-shadow:0 3px 10px rgba(245,158,11,0.4);
          width:${sizePx}px;
          height:${sizePx}px;
          border-radius:50%;
          color:#fff;
          font-size:18px;
          display:flex;
          align-items:center;
          justify-content:center;
          position:relative;
          z-index:2;
        ">
          <span style="filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3));line-height:1;">${emoji}</span>
        </div>
        <div style="
          width:0;height:0;
          border-left:8px solid transparent;
          border-right:8px solid transparent;
          border-top:${pinHeight}px solid ${scrapedBorder};
          margin:0 auto;
          position:relative;
          z-index:2;
        "></div>
      </div>
    `;
    
    const totalH = sizePx + pinHeight;
    return L.divIcon({
      html: scrapedHtml,
      className: 'marker-scraped',
      iconSize: [sizePx, totalH],
      iconAnchor: [sizePx / 2, totalH],
      popupAnchor: [0, -sizePx + 6]
    });
  }
  
  // ============================================
  // MARQUEUR STANDARD (CERCLE) POUR LES AUTRES
  // ============================================
  
  // Effets selon le niveau de boost - marqueurs en rond 100% (cercle) + pin en dessous
  let markerClass = "";
  let extraStyles = "";
  const isMobile = typeof window !== 'undefined' && window.innerWidth <= 768;
  let sizePx = isMobile ? 44 : 40; // 44px sur mobile pour meilleure zone tactile
  let borderWidth = 2;
  let fontSize = 18;
  
  // Bordure par d√©faut - utiliser la couleur custom si d√©finie
  let borderColor;
  const _customBorder = window.customThemeConfig && window.customThemeConfig.markerBorder ? window.customThemeConfig.markerBorder : null;
  const _isPremiumBoost = boost === "platinum" || boost === "gold" || boost === "silver" || boost === "bronze";
  if (isAI) {
    borderColor = "#000000";
  } else if (_isPremiumBoost) {
    // Les boosts premium gardent leurs couleurs sp√©cifiques (rouge, or, argent, bronze)
    borderColor = getBoostColor(boost);
  } else {
    // Tous les marqueurs standard/basic/sans boost : utiliser la couleur custom ou d√©faut
    borderColor = _customBorder || "var(--ui-card-border)";
  }
  
  const boostBorderColors = {
    platinum: "#ef4444",
    gold: "#ffd700",
    silver: "#b8b8b8",
    bronze: "#cd853f",
    basic: borderColor
  };
  
  const borderColorBoost = boostBorderColors[boost] || borderColor;
  
  let showHalo = false;
  let showCrown = false;
  
  switch(boost) {
    case "platinum":
      markerClass = `marker-platinum marker-platinum-rank-${platinumRank}`;
      if (platinumRank === 1) {
        sizePx = 52;
        borderWidth = 4;
        fontSize = 24;
        showHalo = true;
        showCrown = true;
      } else if (platinumRank === 2) {
        sizePx = 48;
        borderWidth = 3.5;
        fontSize = 22;
        showHalo = true;
      } else if (platinumRank === 3) {
        sizePx = 46;
        borderWidth = 3;
        fontSize = 21;
        showHalo = true;
      } else if (platinumRank <= 5) {
        sizePx = 44;
        borderWidth = 2.5;
        fontSize = 20;
      } else {
        sizePx = 42;
        borderWidth = 2;
        fontSize = 19;
      }
      extraStyles = `
        background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
        border: ${borderWidth}px solid ${borderColorBoost};
        box-shadow: 0 4px 12px rgba(239,68,68,0.4);
      `;
      break;
      
    case "gold":
      markerClass = "marker-gold";
      extraStyles = `
        background: linear-gradient(145deg, #1a1a1a, #252525);
        border: 2.5px solid ${borderColorBoost};
        box-shadow: 0 3px 10px rgba(255,215,0,0.3);
      `;
      sizePx = 42;
      fontSize = 19;
      break;
      
    case "silver":
      markerClass = "marker-silver";
      extraStyles = `
        background: #1a1a1a;
        border: 2px solid ${borderColorBoost};
        box-shadow: 0 2px 8px rgba(184,184,184,0.25);
      `;
      sizePx = 40;
      break;
      
    case "bronze":
      markerClass = "marker-bronze";
      extraStyles = `
        background: #1a1a1a;
        border: 2.5px solid ${borderColorBoost};
        box-shadow: 0 2px 8px rgba(205,133,63,0.3);
      `;
      sizePx = 41;
      break;
      
    default:
      extraStyles = `
        background: #1a1a1a;
        border: 3.5px solid #1a3fc7;
        box-shadow: 0 2px 8px rgba(26,63,199,0.4);
      `;
      sizePx = 42;
  }

  // Halo d√©coratif uniquement pour Top 1, 2, 3
  let haloHtml = "";
  if (boost === "platinum" && showHalo) {
    const haloSize1 = sizePx + (platinumRank === 1 ? 24 : platinumRank === 2 ? 18 : 14);
    const haloSize2 = sizePx + (platinumRank === 1 ? 32 : platinumRank === 2 ? 24 : 18);
    const haloOpacity1 = platinumRank === 1 ? 0.9 : platinumRank === 2 ? 0.7 : 0.5;
    const haloOpacity2 = platinumRank === 1 ? 0.6 : platinumRank === 2 ? 0.4 : 0.3;
    
    haloHtml = `
      <div class="halo-ring-platinum" style="
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%,-50%);
        width:${haloSize1}px;
        height:${haloSize1}px;
        border:${platinumRank === 1 ? 3 : 2}px solid rgba(239,68,68,${haloOpacity1});
        border-radius:50%;
        pointer-events:none;
        animation: pulse-halo-${platinumRank} 2s ease-in-out infinite;
      "></div>
      ${platinumRank <= 2 ? `
        <div class="halo-ring-platinum-2" style="
          position:absolute;
          top:50%;
          left:50%;
          transform:translate(-50%,-50%);
          width:${haloSize2}px;
          height:${haloSize2}px;
          border:2px solid rgba(239,68,68,${haloOpacity2});
          border-radius:50%;
          pointer-events:none;
          animation: pulse-halo-${platinumRank} 2.5s ease-in-out infinite 0.3s;
        "></div>
      ` : ''}
    `;
  }

  const crownHtml = showCrown ? `
    <div style="
      position:absolute;
      top:-18px;
      left:50%;
      transform:translateX(-50%);
      font-size:20px;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));
      z-index:10;
    ">üëë</div>
  ` : "";

  // Pin triangulaire sous le marqueur (important pour la lisibilit√©)
  const pinSize = boost === "platinum" && platinumRank <= 3 ? 10 : 8;
  const pinHeight = boost === "platinum" && platinumRank <= 3 ? 14 : 12;
  const pinHtml = `
    <div style="
      width:0;height:0;
      border-left:${pinSize}px solid transparent;
      border-right:${pinSize}px solid transparent;
      border-top:${pinHeight}px solid ${borderColorBoost};
      margin:0 auto;
      position:relative;
      z-index:2;
    "></div>
  `;

  // Marqueur : cercle 100% rond avec emoji de cat√©gorie + pin en dessous
  const html = `
    <div class="${markerClass}" style="position:relative;">
      ${haloHtml}
      ${crownHtml}
      <div style="
        ${extraStyles}
        width:${sizePx}px;
        height:${sizePx}px;
        border-radius:50%;
        color:#fff;
        font-size:${fontSize}px;
        display:flex;
        align-items:center;
        justify-content:center;
        position:relative;
        z-index:2;
      ">
        <span style="filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3));line-height:1;">${emoji}</span>
      </div>
      ${pinHtml}
    </div>
  `;

  const totalH = sizePx + pinHeight + (showCrown ? 18 : 0);
  const iconAnchorX = sizePx / 2;
  const iconAnchorY = totalH;

  return L.divIcon({
    html,
    className: markerClass,
    iconSize: [sizePx, totalH],
    iconAnchor: [iconAnchorX, iconAnchorY],
    popupAnchor: [0, -sizePx + 6],
    tooltipAnchor: [iconAnchorX, 0]
  });
}

// ============================================
// POPUPS (Event / Booking / Service)
// ============================================

// Fonction pour masquer le num√©ro d'adresse (booking/service)
function maskAddressNumber(address) {
  if (!address) return "";
  
  // Enlever le num√©ro au d√©but mais garder la rue compl√®te
  // Ex: "12 Rue du Centre, Lausanne" ‚Üí "Rue du Centre, Lausanne"
  // Ex: "45 Avenue de la Gare, Gen√®ve" ‚Üí "Avenue de la Gare, Gen√®ve"
  // Patterns: "12 ", "12,", "12-", "No 12", "N¬∞12", etc.
  let masked = address
    .replace(/^\d+[\s,-]+/, '') // Enl√®ve num√©ro au d√©but suivi d'un espace/virgule/tiret
    .replace(/^[Nn]¬∞?\s*\d+[\s,-]+/, '') // Enl√®ve "N¬∞12 " ou "No 12 " suivi d'un espace
    .replace(/^[Nn]um√©ro\s+\d+[\s,-]+/i, '') // Enl√®ve "Num√©ro 12 " suivi d'un espace
    .trim();
  
  // Si le r√©sultat est vide ou ne contient que la ville, essayer de garder au moins la rue
  if (!masked || masked.split(',').length <= 1) {
    // Si l'adresse contient une virgule, essayer de garder la partie avant la virgule (la rue)
    const parts = address.split(',');
    if (parts.length > 1) {
      const streetPart = parts[0].replace(/^\d+[\s,-]+/, '').trim();
      if (streetPart) {
        masked = streetPart + ',' + parts.slice(1).join(',');
      } else {
        masked = address; // Si on ne peut pas extraire la rue, retourner l'adresse originale
      }
    } else {
      masked = address; // Pas de virgule, retourner l'adresse originale
    }
  }
  
  return masked;
}

function buildPopupHtml(item) {
  // Protection contre les erreurs TDZ - s'assurer que window.t() est disponible
  // NE PAS logger d'avertissement ici car cela g√©n√®re des milliers de messages
  if (typeof window.t !== 'function') {
    window.t = function(key) { return key; };
  }
  
  // Protection contre les erreurs - s'assurer que window.translations est disponible
  // NE PAS logger d'avertissement ici car cela g√©n√®re des milliers de messages
  if (!window.translations || typeof window.translations !== 'object') {
    window.translations = window.translations || { fr: {}, en: {}, es: {}, zh: {}, hi: {} };
  }
  
  try {
    if (item.type === "event") return buildEventPopup(item);
    if (item.type === "booking") return buildBookingPopup(item);
    if (item.type === "service") return buildServicePopup(item);
    return "<div>Type inconnu</div>";
  } catch (err) {
    // Ne pas logger l'erreur compl√®te pour √©viter les milliers de messages
    // Retourner un popup minimal au lieu de g√©n√©rer une erreur
    return `<div style="padding:10px;"><strong>${item.title || '√âv√©nement'}</strong><br>Erreur d'affichage</div>`;
  }
}

function buildStatusOverlay(status) {
  // ‚ö†Ô∏è Ne pas afficher de badge pour le statut "active" (c'est le statut par d√©faut)
  // Seulement afficher les statuts importants : annul√©, report√©, complet
  if (!status || status === "OK" || status === "active" || status === "upcoming") {
    return "";
  }

  let label = status;
  let bg = "rgba(239,68,68,0.9)";
  let textColor = "#111827";

  if (status === "COMPLET" || status === "SOLDOUT" || status === "completed") {
    label = "COMPLET";
    bg = "rgba(234,179,8,0.9)";
  } else if (status === "ANNULE" || status === "ANNUL√â" || status === "cancelled") {
    label = "ANNUL√â";
    bg = "rgba(239,68,68,0.9)";
  } else if (status === "REPORTE" || status === "REPORT√â" || status === "postponed") {
    label = "REPORT√â";
    bg = "rgba(59,130,246,0.9)";
  }

  return `
    <div style="
      position:absolute;
      top:10px;
      left:10px;
      background:${bg};
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      color:${textColor};
    ">
      ${label}
    </div>
  `;
}

// POPUP EVENT - Design Premium 2025
function buildEventPopup(ev) {
  // Protection CRITIQUE contre les erreurs TDZ - DOIT √™tre la premi√®re chose dans la fonction
  // S'assurer que window.translations existe AVANT toute utilisation
  if (typeof window === 'undefined') {
    return '<div>Erreur: window non disponible</div>';
  }
  
  // Initialiser window.translations de mani√®re s√ªre
  if (!window.translations || typeof window.translations !== 'object') {
    window.translations = { fr: {}, en: {}, es: {}, zh: {}, hi: {} };
  }
  
  // S'assurer que toutes les langues existent
  ['fr', 'en', 'es', 'zh', 'hi'].forEach(lang => {
    if (!window.translations[lang] || typeof window.translations[lang] !== 'object') {
      window.translations[lang] = window.translations[lang] || {};
    }
  });
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que currentLanguage est d√©fini
  if (typeof currentLanguage === 'undefined' || !currentLanguage) {
    currentLanguage = 'fr';
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que currentUser est d√©fini et a les propri√©t√©s n√©cessaires
  if (typeof currentUser === 'undefined' || !currentUser) {
    currentUser = {
      isLoggedIn: false,
      favorites: [],
      agenda: [],
      participating: [],
      subscription: 'free'
    };
  }
  
  // S'assurer que les propri√©t√©s n√©cessaires existent
  if (!Array.isArray(currentUser.favorites)) {
    currentUser.favorites = [];
  }
  if (!Array.isArray(currentUser.agenda)) {
    currentUser.agenda = [];
  }
  if (!Array.isArray(currentUser.participating)) {
    currentUser.participating = [];
  }
  if (!Array.isArray(currentUser.likes)) {
    currentUser.likes = [];
  }
  if (!currentUser.subscription) {
    currentUser.subscription = 'free';
  }
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que reviews est un objet (pas undefined)
  if (!currentUser.reviews || typeof currentUser.reviews !== 'object') {
    currentUser.reviews = {};
  }
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que reviews est un objet (pas undefined)
  if (!currentUser.reviews || typeof currentUser.reviews !== 'object') {
    currentUser.reviews = {};
  }
  
  // NE PAS red√©finir window.t ici pour √©viter les erreurs TDZ
  // Utiliser directement du texte en dur au lieu d'appeler window.t()
  
  // TRADUCTION AUTOMATIQUE du contenu de l'√©v√©nement
  const evTranslated = getTranslatedItemSync(ev, currentLanguage);
  
  const statusOverlay = buildStatusOverlay(ev.status);
  const borderColor = getBoostColor(ev.boost);
  const cats = (evTranslated.categories || ev.categories || []).join(" ‚Ä¢ ");
  
  // ‚ö†Ô∏è CRITIQUE : Utiliser l'image de statut si le statut n'est pas "active"
  // Les images de statut remplacent compl√®tement l'image de l'√©v√©nement
  const statusImages = {
    'cancelled': '/assets/event_overlays/Event canceled.jpeg',
    'postponed': '/assets/event_overlays/postponed.jpeg',
    'completed': '/assets/event_overlays/completed.jpeg',
    'ANNULE': '/assets/event_overlays/Event canceled.jpeg',
    'ANNUL√â': '/assets/event_overlays/Event canceled.jpeg',
    'REPORTE': '/assets/event_overlays/postponed.jpeg',
    'REPORT√â': '/assets/event_overlays/postponed.jpeg',
    'COMPLET': '/assets/event_overlays/completed.jpeg',
    'SOLDOUT': '/assets/event_overlays/completed.jpeg'
  };
  
  let imgTag;
  const statusImage = statusImages[ev.status];
  if (statusImage) {
    // Si statut sp√©cial : utiliser l'image de statut en plein √©cran
    imgTag = `
      <img 
        src="${statusImage}"
        alt="${escapeHtml(evTranslated.title || ev.title || '')}"
        style="width:100%;min-height:280px;max-height:400px;object-fit:cover;display:block;margin:0;padding:0;border:none;box-sizing:border-box;background:linear-gradient(135deg,#3b82f6,#8b5cf6);vertical-align:top;"
        onerror="this.src='/assets/event_overlays/eventdefault.jpg';"
        loading="eager"
      >
    `;
    console.log('[POPUP] Image de statut utilis√©e:', ev.status, statusImage);
  } else {
    // Statut normal (active) : utiliser l'image de l'√©v√©nement
    imgTag = buildMainImageTag(ev, evTranslated.title || ev.title || "");
  }
  
  const emoji = getCategoryEmoji(ev);
  
  // Calcul du temps restant
  const now = new Date();
  // ‚ö†Ô∏è Support des deux formats : startDate/endDate (frontend) ou date+time/end_date+end_time (backend)
  let startDate = null;
  let endDate = null;
  
  if (ev.startDate) {
    startDate = new Date(ev.startDate);
  } else if (ev.date) {
    // Format backend : date (2026-02-05) + time (14:00:00)
    const dateStr = ev.date + (ev.time ? 'T' + ev.time : 'T00:00:00');
    startDate = new Date(dateStr);
  }
  
  if (ev.endDate) {
    endDate = new Date(ev.endDate);
  } else if (ev.end_date) {
    // Format backend : end_date + end_time
    const endDateStr = ev.end_date + (ev.end_time ? 'T' + ev.end_time : 'T23:59:59');
    endDate = new Date(endDateStr);
  }
  
  const daysUntil = (startDate && !isNaN(startDate.getTime())) ? Math.ceil((startDate - now) / (1000 * 60 * 60 * 24)) : null;
  const timeLabel = daysUntil !== null ? (
    daysUntil < 0 ? "Termin√©" :
    daysUntil === 0 ? "Aujourd'hui !" :
    daysUntil === 1 ? "Demain" :
    daysUntil <= 7 ? `Dans ${daysUntil} jours` :
    daysUntil <= 30 ? `Dans ${Math.ceil(daysUntil/7)} sem.` :
    `Dans ${Math.ceil(daysUntil/30)} mois`
  ) : "";
  const timeLabelColor = daysUntil !== null ? (
    daysUntil < 0 ? "#6b7280" :
    daysUntil === 0 ? "#ef4444" :
    daysUntil <= 3 ? "#f59e0b" :
    "#22c55e"
  ) : "#22c55e";
  
  // Badge boost avec animation et syst√®me Top 10 Platinum
  const platinumRank = ev.platinumRank || 10;
  let boostBadge = "";
  
  if (ev.boost && ev.boost !== "basic") {
    let badgeStyle = "";
    let badgeText = "";
    
    if (ev.boost === "platinum") {
      // Syst√®me Top 10 avec ench√®res
      if (platinumRank === 1) {
        badgeStyle = "background:linear-gradient(135deg,#ffd700,#ff8c00);color:#1f2937;box-shadow:0 0 25px rgba(255,215,0,0.7);";
        badgeText = "üëë TOP 1";
      } else if (platinumRank === 2) {
        badgeStyle = "background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;box-shadow:0 0 20px rgba(239,68,68,0.6);";
        badgeText = "üî• TOP 2";
      } else if (platinumRank === 3) {
        badgeStyle = "background:linear-gradient(135deg,#f97316,#ea580c);color:#fff;box-shadow:0 0 15px rgba(249,115,22,0.5);";
        badgeText = "‚ö° TOP 3";
      } else {
        badgeStyle = "background:linear-gradient(135deg,#ef4444,#b91c1c);color:#fff;box-shadow:0 0 10px rgba(239,68,68,0.4);";
        badgeText = `üèÜ TOP ${platinumRank}`;
      }
    } else if (ev.boost === "gold") {
      badgeStyle = "background:linear-gradient(135deg,rgba(255,215,0,0.9),rgba(218,165,32,0.9));color:#1f2937;";
      badgeText = "ü•á Gold";
    } else if (ev.boost === "silver") {
      badgeStyle = "background:linear-gradient(135deg,rgba(192,192,192,0.9),rgba(169,169,169,0.9));color:#1f2937;";
      badgeText = "ü•à Silver";
    } else {
      badgeStyle = "background:linear-gradient(135deg,rgba(205,127,50,0.9),rgba(184,115,51,0.9));color:#fff;";
      badgeText = "ü•â Bronze";
    }
    
    boostBadge = `
      <div style="position:absolute;top:12px;right:12px;padding:6px 12px;border-radius:999px;font-size:11px;font-weight:700;display:flex;align-items:center;gap:4px;backdrop-filter:blur(8px);${badgeStyle}">
        ${badgeText}
      </div>
    `;
  }

  // Badge v√©rifi√© am√©lior√©
  const verifiedBadge = ev.verified ? `
    <span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:999px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:#fff;font-size:10px;font-weight:600;box-shadow:0 2px 8px rgba(59,130,246,0.4);">
      ‚úì V√©rifi√©
    </span>
  ` : "";
  
  // Badge de validation organisateur (pour √©v√©nements scrap√©s)
  let validationBadge = "";
  if (ev.validation_status === 'validated') {
    validationBadge = `
      <div style="margin:8px 0;padding:8px 14px;background:linear-gradient(135deg,rgba(34,197,94,0.12),rgba(22,163,74,0.08));border:1px solid rgba(34,197,94,0.4);border-radius:10px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:16px;">‚úÖ</span>
        <span style="font-size:11px;font-weight:700;color:#22c55e;line-height:1.3;">Informations valid√©es par l'organisateur</span>
      </div>
    `;
  } else if (ev.validation_status === 'pending') {
    validationBadge = `
      <span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:999px;background:rgba(245,158,11,0.2);border:1px solid rgba(245,158,11,0.5);color:#f59e0b;font-size:10px;font-weight:600;">
        En attente de validation
      </span>
    `;
  }
  
  // Lien vers la source originale (pour √©v√©nements scrap√©s)
  const evSourceUrl = ev.source_url || ev.sourceUrl;
  const sourceLink = evSourceUrl ? `
    <a href="${escapeHtml(evSourceUrl)}" target="_blank" rel="noopener noreferrer" style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:999px;background:rgba(148,163,184,0.1);border:1px solid rgba(148,163,184,0.3);color:#94a3b8;font-size:10px;font-weight:500;text-decoration:none;transition:all 0.2s;" onmouseover="this.style.background='rgba(148,163,184,0.2)'" onmouseout="this.style.background='rgba(148,163,184,0.1)'">
      üîó Source
    </a>
  ` : "";
  
  // Indicateur publication MapEvent
  const aiIndicator = ev.isAI ? `
    <div style="margin-top:8px;padding:8px 12px;background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(139,92,246,0.1));border:1px solid rgba(59,130,246,0.3);border-radius:10px;font-size:11px;color:#94a3b8;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <span style="font-size:14px;">üì¢</span>
      <span>Publi√© par <strong style="color:#60a5fa;">MapEvent</strong> : il peut y avoir des erreurs, merci de <a href="${escapeHtml(evSourceUrl || '#')}" target="_blank" style="color:#60a5fa;text-decoration:underline;font-weight:600;">v√©rifier la source</a></span>
    </div>
  ` : "";

  // Stats avec ic√¥nes anim√©es
  const isLiked = currentUser.likes.includes('event:'+ev.id);
  const isFavorite = currentUser.favorites.some(f => f.id === ev.id.toString() && f.mode === 'event');
  const isParticipating = currentUser.participating.includes('event:'+ev.id);
  const inAgenda = currentUser.agenda.includes('event:'+ev.id);
  
  // Trouver les amis qui participent √† cet √©v√©nement
  const friendsParticipating = getFriendsParticipatingToEvent(ev.id);
  const friendsSection = friendsParticipating.length > 0 ? `
    <div style="padding:10px 12px;background:linear-gradient(135deg,rgba(0,255,195,0.1),rgba(59,130,246,0.1));border:1px solid rgba(0,255,195,0.3);border-radius:10px;margin-bottom:10px;">
      <div style="font-size:11px;font-weight:600;color:#00ffc3;margin-bottom:8px;display:flex;align-items:center;gap:6px;">
        <span>üë•</span> ${friendsParticipating.length} ami${friendsParticipating.length > 1 ? 's' : ''} y ${friendsParticipating.length > 1 ? 'vont' : 'va'} !
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        ${friendsParticipating.slice(0, 5).map(f => `
          <div style="display:flex;align-items:center;gap:4px;padding:4px 8px;background:rgba(0,0,0,0.3);border-radius:999px;">
            <span style="font-size:14px;">${f.avatar}</span>
            <span style="font-size:11px;color:#fff;font-weight:500;">${f.name.split('_')[0]}</span>
          </div>
        `).join('')}
        ${friendsParticipating.length > 5 ? `<span style="font-size:11px;color:var(--ui-text-muted);">+${friendsParticipating.length - 5} autres</span>` : ''}
      </div>
    </div>
  ` : (currentUser.isLoggedIn && currentUser.friends?.length > 0 ? `
    <div style="padding:8px 12px;background:rgba(148,163,184,0.1);border-radius:10px;margin-bottom:10px;font-size:11px;color:var(--ui-text-muted);text-align:center;">
      üë• Aucun de vos amis ne participe encore. <span style="color:#00ffc3;cursor:pointer;" onclick="onAction('share', 'event', ${ev.id})">Invitez-les !</span>
    </div>
  ` : '');
  
  const statsRow = `
    <div style="display:flex;gap:16px;padding:10px 0;border-top:1px solid rgba(148,163,184,0.2);border-bottom:1px solid rgba(148,163,184,0.2);margin:10px 0;">
      <div style="display:flex;align-items:center;gap:6px;cursor:pointer;transition:transform 0.2s;" onclick="onAction('like', 'event', ${ev.id})">
        <span style="font-size:18px;${isLiked ? 'animation:bounce-in 0.3s;' : ''}">${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
        <span style="font-size:13px;font-weight:600;color:${isLiked ? '#ef4444' : 'var(--ui-text-muted)'};">${ev.likes || 0}</span>
      </div>
      <div style="display:flex;align-items:center;gap:6px;">
        <span style="font-size:18px;">üí¨</span>
        <span style="font-size:13px;font-weight:600;color:var(--ui-text-muted);">${ev.comments || 0}</span>
      </div>
      <div style="display:flex;align-items:center;gap:6px;">
        <span style="font-size:18px;">üë•</span>
        <span style="font-size:13px;font-weight:600;color:var(--ui-text-muted);">${ev.participants || 0}</span>
      </div>
      <div style="margin-left:auto;display:flex;align-items:center;gap:6px;cursor:pointer;" onclick="onAction('favorite', 'event', ${ev.id})">
        <span style="font-size:18px;${isFavorite ? 'animation:bounce-in 0.3s;' : ''}">${isFavorite ? '‚≠ê' : '‚òÜ'}</span>
      </div>
    </div>
    ${friendsSection}
  `;

  // V√©rifier les alarmes existantes pour cet √©v√©nement
  const eventAlarms = (currentUser.eventAlarms || []).filter(a => a.eventId === ev.id.toString());
  const hasAlarms = eventAlarms.length > 0;
  const canAddAlarm = eventAlarms.length < 2 && inAgenda;
  
  // Actions avec design moderne (barre fixe en bas au scroll)
  const actionsRow = `
    <div class="popup-actions-sticky" style="position:sticky;bottom:0;background:var(--ui-card-bg);z-index:10;padding:12px 0 8px;margin-top:12px;border-top:1px solid var(--ui-card-border);">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:0;">
      <button onclick="onAction('participate', 'event', ${ev.id})" style="padding:12px;border-radius:12px;border:none;font-weight:700;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s;
        ${isParticipating ? 
          'background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;box-shadow:0 4px 12px rgba(34,197,94,0.4);' : 
          'background:linear-gradient(135deg,#00ffc3,#10b981);color:#022c22;box-shadow:0 4px 12px rgba(0,255,195,0.4);'}">
        ${isParticipating ? '‚úÖ Inscrit' : 'üéüÔ∏è Participer'}
      </button>
      <button onclick="onAction('agenda', 'event', ${ev.id})" style="padding:12px;border-radius:12px;border:1px solid rgba(59,130,246,0.5);background:${inAgenda ? 'rgba(59,130,246,0.2)' : 'transparent'};color:${inAgenda ? '#3b82f6' : 'var(--ui-text-main)'};font-weight:600;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s;">
        ${inAgenda ? 'üìÖ Dans agenda' : 'üìÖ Ajouter'}
      </button>
    </div>
    ${inAgenda && currentUser.isLoggedIn ? `
      <div style="margin-top:8px;">
        ${canAddAlarm ? `
          <button onclick="openAddAlarmModal('event', ${ev.id})" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(245,158,11,0.5);background:rgba(245,158,11,0.1);color:#f59e0b;font-weight:600;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;">
            ‚è∞ Ajouter alarme (${eventAlarms.length}/2)
          </button>
        ` : hasAlarms ? `
          <div style="padding:10px;border-radius:10px;border:1px solid rgba(245,158,11,0.3);background:rgba(245,158,11,0.1);color:#f59e0b;font-size:12px;text-align:center;">
            ‚è∞ ${eventAlarms.length} alarme${eventAlarms.length > 1 ? 's' : ''} configur√©e${eventAlarms.length > 1 ? 's' : ''}
          </div>
        ` : ''}
      </div>
    ` : ''}
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px;">
      ${currentUser.isLoggedIn ? `
        <button onclick="(function(){try{if(window.openEventDiscussion){window.openEventDiscussion('event',${ev.id});}else if(window.openDiscussionModal){window.openDiscussionModal('event',${ev.id});}else{console.warn('Discussion non disponible');}}catch(e){console.error('Erreur ouverture discussion:',e);}})();" style="padding:10px;border-radius:10px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;" title="Canal de discussion">
          üí¨ Discussion
        </button>
        <button onclick="window.viewEventAttendees && window.viewEventAttendees('event', ${ev.id})" style="padding:10px;border-radius:10px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;" title="Voir qui participe">
          üë• Participants
        </button>
        <button onclick="inviteFriendsToEvent('event', ${ev.id})" style="padding:10px;border-radius:10px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;" title="Inviter des amis">
          ‚ûï Inviter
        </button>
      ` : ''}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-top:8px;">
      ${currentUser.isLoggedIn ? `
        <button onclick="onAction('route', 'event', ${ev.id})" style="padding:10px;border-radius:10px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;">
          üó∫Ô∏è Y aller
        </button>
      ` : `
        <button onclick="onAction('route', 'event', ${ev.id})" style="padding:10px;border-radius:10px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;">
          üó∫Ô∏è Y aller
        </button>
      `}
      <button onclick="window.sharePopup('event', ${ev.id})" style="padding:10px;border-radius:10px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;" title="Partager le lien">
        üîó Partager
      </button>
      <button onclick="onAction('avis', 'event', ${ev.id})" style="padding:10px;border-radius:10px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;">
        ‚≠ê Avis
      </button>
      <button onclick="onAction('report', 'event', ${ev.id})" style="padding:10px;border-radius:10px;border:1px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.1);color:#ef4444;font-size:12px;cursor:pointer;transition:all 0.2s;" title="Signaler">
        üö®
      </button>
    </div>
    </div>
  `;

  // Reviews compactes
  const reviewsSection = (() => {
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que currentUser.reviews existe
    if (!currentUser.reviews || typeof currentUser.reviews !== 'object') {
      currentUser.reviews = {};
    }
    const key = `event:${ev.id}`;
    const reviews = currentUser.reviews[key] || [];
    if (reviews.length === 0 && !ev.rating) return '';
    
    const ratingStars = ev.rating ? `
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
        <div style="display:flex;gap:2px;">
          ${[1,2,3,4,5].map(i => `<span style="font-size:14px;${i <= Math.floor(parseFloat(ev.rating)) ? '' : 'opacity:0.3;'}"}>‚≠ê</span>`).join('')}
        </div>
        <span style="font-size:14px;font-weight:700;color:#fbbf24;">${ev.rating}</span>
        <span style="font-size:11px;color:var(--ui-text-muted);">(${reviews.length} avis)</span>
      </div>
    ` : '';
    
    const latestReview = reviews.length > 0 ? `
      <div style="padding:10px;background:rgba(15,23,42,0.5);border-radius:10px;border:1px solid var(--ui-card-border);">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
          <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,${reviews[0].avatarColor || '#00ffc3'},${reviews[0].avatarColor2 || '#3b82f6'});display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;">
            ${reviews[0].avatar || reviews[0].userName.charAt(0).toUpperCase()}
          </div>
          <div style="flex:1;">
            <div style="font-weight:600;font-size:12px;color:var(--ui-text-main);">${escapeHtml(reviews[0].userName)}</div>
            ${reviews[0].rating ? `<div style="font-size:10px;color:#fbbf24;">${'‚≠ê'.repeat(reviews[0].rating)}</div>` : ''}
          </div>
        </div>
        <div style="font-size:12px;color:var(--ui-text-main);line-height:1.4;">"${escapeHtml(reviews[0].text.length > 100 ? reviews[0].text.substring(0, 100) + '...' : reviews[0].text)}"</div>
        ${reviews.length > 1 ? `
          <button onclick="onAction('avis', 'event', ${ev.id})" style="margin-top:8px;padding:6px 12px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-muted);font-size:11px;cursor:pointer;width:100%;">
            Voir les ${reviews.length} avis ‚Üí
          </button>
        ` : ''}
      </div>
    ` : '';
    
    return ratingStars + latestReview;
  })();

  return `
    <div style="width:100%;max-height:none;overflow:visible;font-family:system-ui,sans-serif;color:var(--ui-text-main);margin:0;padding:0;box-sizing:border-box;">
      <!-- Image principale avec overlay - ALIGN√âE PARFAITEMENT avec la bordure de la modal -->
      <div style="position:relative;border-radius:16px 16px 0 0;overflow:hidden;margin:0;padding:0;width:100%;left:0;right:0;box-sizing:border-box;min-height:280px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);">
        <div style="position:relative;width:100%;margin:0;padding:0;box-sizing:border-box;min-height:280px;display:flex;align-items:stretch;">
          ${imgTag}
          ${statusOverlay}
          ${boostBadge}
          <!-- Gradient overlay -->
          <div style="position:absolute;bottom:0;left:0;right:0;height:80px;background:linear-gradient(to top,rgba(15,23,42,0.95),transparent);pointer-events:none;"></div>
          <!-- Time badge -->
          ${timeLabel ? `
            <div style="position:absolute;bottom:12px;left:12px;padding:6px 12px;border-radius:999px;background:${timeLabelColor};color:#fff;font-size:11px;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,0.3);">
              ${daysUntil === 0 ? 'üî•' : daysUntil === 1 ? '‚è∞' : 'üìÖ'} ${timeLabel}
            </div>
          ` : ''}
        </div>
      </div>
      
      <!-- Content - ALIGN√â AVEC L'IMAGE -->
      <div style="padding:16px 12px 12px;margin:0;width:100%;box-sizing:border-box;">
        <!-- Category & Verified -->
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
          <span style="font-size:28px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2));">${emoji}</span>
          <span style="font-size:12px;color:var(--ui-text-muted);padding:4px 10px;background:rgba(148,163,184,0.1);border-radius:999px;">${cats}</span>
          ${verifiedBadge}
          ${sourceLink}
        </div>
        
        <!-- Title -->
        <h3 style="margin:0 0 10px;font-size:20px;font-weight:800;line-height:1.3;color:var(--ui-text-main);">${escapeHtml(evTranslated.title || ev.title || "")}</h3>
        
        <!-- Validation organisateur (bloc visible sous le titre) -->
        ${validationBadge}
        
        <!-- Date & Location Cards -->
        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:linear-gradient(135deg,rgba(0,255,195,0.1),rgba(16,185,129,0.05));border:1px solid rgba(0,255,195,0.2);border-radius:10px;">
            <span style="font-size:20px;">üìÖ</span>
            <div>
              <div style="font-size:13px;font-weight:600;color:#00ffc3;">${formatEventDateRange(startDate, endDate, !!ev.source_url)}</div>
              ${ev.source_url ? `<div style="font-size:11px;color:#f59e0b;margin-top:4px;">‚ö†Ô∏è Pour l'heure exacte, voir la publication originale</div>` : ''}
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:10px;">
            <span style="font-size:20px;">üìç</span>
            <div style="font-size:13px;font-weight:500;color:var(--ui-text-main);flex:1;">${escapeHtml(ev.address || ev.city || ev.location || "")}</div>
          </div>
          ${(ev.source_url || ev.sourceUrl) ? `
            <a href="${escapeHtml(ev.source_url || ev.sourceUrl || '#')}" target="_blank" rel="noopener noreferrer" style="display:flex;align-items:center;gap:10px;padding:12px;background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(234,88,12,0.1));border:2px solid rgba(245,158,11,0.5);border-radius:10px;text-decoration:none;transition:all 0.2s;" onmouseover="this.style.background='linear-gradient(135deg,rgba(245,158,11,0.25),rgba(234,88,12,0.2))';this.style.transform='scale(1.01)'" onmouseout="this.style.background='linear-gradient(135deg,rgba(245,158,11,0.15),rgba(234,88,12,0.1))';this.style.transform='scale(1)'">
              <span style="font-size:24px;">üîó</span>
              <div style="flex:1;">
                <div style="font-size:13px;font-weight:700;color:#f59e0b;">VOIR LA PUBLICATION ORIGINALE</div>
                <div style="font-size:11px;color:#94a3b8;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml((ev.source_url || ev.sourceUrl || '').substring(0, 50))}...</div>
              </div>
              <span style="font-size:18px;color:#f59e0b;">‚Üí</span>
            </a>
            <div style="margin-top:8px;padding:8px 12px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.25);border-radius:8px;font-size:11px;color:#f87171;text-align:center;">
              ‚ö†Ô∏è Publi√© par MapEvent ‚Äì peut contenir des erreurs
            </div>
          ` : ''}
        </div>
        
        <!-- Description -->
        ${ev.description ? `
          <div style="font-size:14px;color:#ffffff;line-height:1.7;margin-bottom:12px;padding:12px;background:transparent;border-radius:8px;">
            ${escapeHtml(evTranslated.description || ev.description)}
          </div>
        ` : ""}
        
        <!-- Audio Player (si liens audio disponibles) -->
        ${(ev.audioLinks && ev.audioLinks.length > 0) || (ev.soundLinks && ev.soundLinks.length > 0) ? (() => {
          const evAudioLinks = [...(ev.soundLinks || []), ...(ev.audioLinks || [])].filter(Boolean);
          const evTitle = (ev.title || ev.name || '').replace(/"/g, '&quot;');
          return `
          <div style="margin:8px 0 12px;padding:12px;background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(59,130,246,0.1));border-radius:12px;border:1px solid rgba(139,92,246,0.3);">
            <div style="font-size:12px;color:#a78bfa;margin-bottom:10px;font-weight:600;">üéµ √âcouter directement</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              ${evAudioLinks.slice(0, 5).map((link, i) => {
                const safeUrl = (link || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const trackLabel = 'Piste ' + (i + 1) + (link.includes('audius') ? ' ‚Ä¢ Audius' : link.includes('soundcloud') ? ' ‚Ä¢ SoundCloud' : link.includes('spotify') ? ' ‚Ä¢ Spotify' : '');
                return `
                <div data-audio-track data-item-title="${evTitle}" data-track-label="${trackLabel}" style="display:flex;flex-direction:column;gap:6px;padding:10px 12px;background:rgba(0,0,0,0.3);border-radius:10px;">
                  <audio id="event-audio-${ev.id}-${i}" src="${safeUrl}" data-original-src="${safeUrl}" preload="metadata" style="display:none;"></audio>
                  <div style="display:flex;align-items:center;gap:10px;">
                    <button onclick="event.stopPropagation();toggleEventAudio('${ev.id}',${i})" id="btn-event-${ev.id}-${i}" style="width:36px;height:36px;border-radius:50%;border:none;background:linear-gradient(135deg,#a78bfa,#8b5cf6);color:white;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">‚ñ∂</button>
                    <div style="flex:1;min-width:0;">
                      <div style="font-size:12px;color:#e5e7eb;font-weight:500;">Piste ${i + 1}</div>
                      <div style="font-size:10px;color:var(--ui-text-muted);">${link.includes('audius') ? 'üéµ Audius' : link.includes('soundcloud') ? '‚òÅÔ∏è SoundCloud' : link.includes('spotify') ? 'üü¢ Spotify' : link.includes('youtube') ? '‚ñ∂Ô∏è YouTube' : 'üéµ Audio'}</div>
                    </div>
                    <button onclick="event.stopPropagation();seekAudioOffset('event','${ev.id}',${i},-15)" style="width:32px;height:32px;border-radius:50%;border:1px solid rgba(167,139,250,0.5);background:transparent;color:#a78bfa;cursor:pointer;font-size:12px;flex-shrink:0;display:flex;align-items:center;justify-content:center;">‚è™</button>
                    <button onclick="event.stopPropagation();seekAudioOffset('event','${ev.id}',${i},15)" style="width:32px;height:32px;border-radius:50%;border:1px solid rgba(167,139,250,0.5);background:transparent;color:#a78bfa;cursor:pointer;font-size:12px;flex-shrink:0;display:flex;align-items:center;justify-content:center;">‚è©</button>
                    <span id="time-event-${ev.id}-${i}" style="font-size:10px;color:#a78bfa;font-variant-numeric:tabular-nums;min-width:70px;text-align:right;flex-shrink:0;">0:00</span>
                  </div>
                  <div id="seekbar-event-${ev.id}-${i}" onmousedown="event.stopPropagation();startAudioDrag('event','${ev.id}',${i},event)" ontouchstart="event.stopPropagation();event.preventDefault();startAudioDrag('event','${ev.id}',${i},event)" onclick="event.stopPropagation();seekEventAudio('${ev.id}',${i},event)" style="width:100%;height:14px;padding:12px 0;margin:-12px 0;cursor:pointer;position:relative;touch-action:none;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;" title="Cliquer pour aller √† la position dans le son">
                    <div style="height:14px;background:rgba(255,255,255,0.15);border-radius:7px;overflow:hidden;position:relative;">
                      <div id="progress-event-${ev.id}-${i}" style="width:0%;height:100%;background:linear-gradient(90deg,#a78bfa,#8b5cf6);border-radius:7px;transition:width 0.05s;pointer-events:none;"></div>
                    </div>
                  </div>
                </div>`;
              }).join('')}
            </div>
          </div>`;
        })() : ''}
        
        <!-- Stats -->
        ${statsRow}
        
        <!-- Reviews -->
        ${reviewsSection}
        
        <!-- AI Indicator -->
        ${aiIndicator}
        
        <!-- Actions - barre fixe en bas quand scroll -->
        <div class="popup-actions-sticky" style="position:sticky;bottom:0;background:var(--ui-card-bg);margin:12px -12px -12px -12px;padding:12px 12px 12px 12px;z-index:10;border-top:1px solid rgba(148,163,184,0.2);">
          ${actionsRow}
        </div>
      </div>
    </div>
  `;
}

// POPUP BOOKING
function buildBookingPopup(b) {
  // Protection contre les erreurs TDZ
  if (typeof window.t !== 'function') {
    window.t = function(key) { return key; };
  }
  if (!window.translations || typeof window.translations !== 'object') {
    window.translations = window.translations || { fr: {}, en: {}, es: {}, zh: {}, hi: {} };
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que currentUser est d√©fini et a les propri√©t√©s n√©cessaires
  if (typeof currentUser === 'undefined' || !currentUser) {
    currentUser = {
      isLoggedIn: false,
      favorites: [],
      agenda: [],
      participating: [],
      subscription: 'free'
    };
  }
  
  // S'assurer que les propri√©t√©s n√©cessaires existent
  if (!Array.isArray(currentUser.favorites)) {
    currentUser.favorites = [];
  }
  if (!Array.isArray(currentUser.agenda)) {
    currentUser.agenda = [];
  }
  if (!currentUser.subscription) {
    currentUser.subscription = 'free';
  }
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que reviews est un objet (pas undefined)
  if (!currentUser.reviews || typeof currentUser.reviews !== 'object') {
    currentUser.reviews = {};
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que paidContacts est d√©fini
  if (typeof paidContacts === 'undefined' || !Array.isArray(paidContacts)) {
    paidContacts = [];
  }
  
  const borderColor = getBoostColor(b.boost);
  const imgTag = buildMainImageTag(b, b.name || "");
  const cats = (b.categories || []).join(" ‚Ä¢ ");
  const emoji = getCategoryEmoji(b);

  // Badge niveau
  const levelColors = {
    "D√©butant": "#9ca3af",
    "Semi-pro": "#3b82f6",
    "Pro": "#8b5cf6",
    "Headliner": "#f59e0b",
    "International": "#ef4444",
    "Non d√©tect√©": "#6b7280"
  };
  const levelBadge = b.level ? `
    <span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;font-size:10px;font-weight:600;background:${levelColors[b.level] || '#6b7280'};color:white;">
      ${b.level === "Headliner" ? "üåü" : b.level === "International" ? "üåç" : "üéµ"} ${b.level}
    </span>
  ` : "";

  // Badge v√©rifi√©
  const verifiedBadge = b.verified ? `<span class="verified-badge">‚úì V√©rifi√©</span>` : "";

  // Liens sons - Player int√©gr√© sans acc√®s au site
  // ‚ö†Ô∏è GRATUIT : Coordonn√©es toujours affich√©es (plus de paiement requis)
  const hasPaidContact = true;
  
  // Fusionner soundLinks (scraping) et audioLinks (publication utilisateur)
  const allSoundLinks = [...(b.soundLinks || []), ...(b.audioLinks || [])].filter(Boolean);
  
  const soundsSection = allSoundLinks.length > 0 ? `
    <div style="margin:8px 0;padding:12px;background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(59,130,246,0.1));border-radius:12px;border:1px solid rgba(139,92,246,0.3);">
      <div style="font-size:12px;color:#a78bfa;margin-bottom:10px;font-weight:600;">üéµ √âcouter directement</div>
      
      <div style="display:flex;flex-direction:column;gap:8px;">
        ${allSoundLinks.slice(0, 12).map((link, i) => {
          const safeUrl = (link || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
          const safeTitle = (b.name || '').replace(/"/g, '&quot;');
          const trackLabel = 'Piste ' + (i + 1) + (link.includes('audius') ? ' ‚Ä¢ Audius' : link.includes('soundcloud') ? ' ‚Ä¢ SoundCloud' : link.includes('spotify') ? ' ‚Ä¢ Spotify' : '');
          return `
          <div data-audio-track data-item-title="${safeTitle}" data-track-label="${trackLabel}" style="display:flex;flex-direction:column;gap:6px;padding:10px 12px;background:rgba(0,0,0,0.3);border-radius:10px;">
            <audio id="booking-audio-${b.id}-${i}" src="${safeUrl}" data-original-src="${safeUrl}" preload="metadata" style="display:none;"></audio>
            <div style="display:flex;align-items:center;gap:10px;">
              <button onclick="event.stopPropagation();toggleBookingAudio('${b.id}',${i})" id="btn-booking-${b.id}-${i}" style="width:36px;height:36px;border-radius:50%;border:none;background:linear-gradient(135deg,#a78bfa,#8b5cf6);color:white;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">‚ñ∂</button>
              <div style="flex:1;min-width:0;">
                <div style="font-size:12px;color:#e5e7eb;font-weight:500;">Piste ${i + 1}</div>
                <div style="font-size:10px;color:var(--ui-text-muted);">${link.includes('audius') ? 'üéµ Audius' : link.includes('soundcloud') ? '‚òÅÔ∏è SoundCloud' : link.includes('spotify') ? 'üü¢ Spotify' : link.includes('youtube') ? '‚ñ∂Ô∏è YouTube' : 'üéµ Audio'}</div>
              </div>
              <button onclick="event.stopPropagation();seekAudioOffset('booking','${b.id}',${i},-15)" style="width:32px;height:32px;border-radius:50%;border:1px solid rgba(167,139,250,0.5);background:transparent;color:#a78bfa;cursor:pointer;font-size:12px;flex-shrink:0;display:flex;align-items:center;justify-content:center;">‚è™</button>
              <button onclick="event.stopPropagation();seekAudioOffset('booking','${b.id}',${i},15)" style="width:32px;height:32px;border-radius:50%;border:1px solid rgba(167,139,250,0.5);background:transparent;color:#a78bfa;cursor:pointer;font-size:12px;flex-shrink:0;display:flex;align-items:center;justify-content:center;">‚è©</button>
              <span id="time-booking-${b.id}-${i}" style="font-size:10px;color:#a78bfa;font-variant-numeric:tabular-nums;min-width:70px;text-align:right;flex-shrink:0;">0:00</span>
            </div>
            <div id="seekbar-booking-${b.id}-${i}" onmousedown="event.stopPropagation();startAudioDrag('booking','${b.id}',${i},event)" ontouchstart="event.stopPropagation();event.preventDefault();startAudioDrag('booking','${b.id}',${i},event)" onclick="event.stopPropagation();seekBookingAudio('${b.id}',${i},event)"  style="width:100%;height:14px;padding:12px 0;margin:-12px 0;cursor:pointer;position:relative;touch-action:none;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;" title="Cliquer pour aller √† la position dans le son">
              <div style="height:14px;background:rgba(255,255,255,0.15);border-radius:7px;overflow:hidden;position:relative;">
                <div id="progress-booking-${b.id}-${i}" style="width:0%;height:100%;background:linear-gradient(90deg,#a78bfa,#8b5cf6);border-radius:7px;transition:width 0.05s;pointer-events:none;"></div>
              </div>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>
  ` : '';

  // Rating
  const ratingStars = b.rating ? `
    <div style="display:flex;align-items:center;gap:4px;margin-bottom:6px;">
      ${'‚≠ê'.repeat(Math.floor(parseFloat(b.rating)))}
      <span style="font-size:12px;color:var(--ui-text-muted);">${b.rating}/5</span>
      <span style="font-size:11px;color:var(--ui-text-muted);">(${b.likes || 0} avis)</span>
    </div>
  ` : "";

  // Lien publication originale (si disponible)
  const sourceUrl = b.sourceUrl || b.source_url;
  const sourceLinkBlock = sourceUrl ? `
    <a href="${escapeHtml(sourceUrl)}" target="_blank" rel="noopener noreferrer" style="display:flex;align-items:center;gap:10px;padding:10px 12px;margin:8px 0;background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(234,88,12,0.1));border:2px solid rgba(245,158,11,0.5);border-radius:10px;text-decoration:none;transition:all 0.2s;" onmouseover="this.style.background='linear-gradient(135deg,rgba(245,158,11,0.25),rgba(234,88,12,0.2))';this.style.transform='scale(1.01)'" onmouseout="this.style.background='linear-gradient(135deg,rgba(245,158,11,0.15),rgba(234,88,12,0.1))';this.style.transform='scale(1)'">
      <span style="font-size:20px;">üîó</span>
      <div style="flex:1;">
        <div style="font-size:12px;font-weight:700;color:#f59e0b;">VOIR LA PUBLICATION ORIGINALE</div>
        <div style="font-size:10px;color:#94a3b8;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(sourceUrl.substring(0, 45))}...</div>
      </div>
      <span style="font-size:16px;color:#f59e0b;">‚Üí</span>
    </a>
  ` : "";

  // Indicateur publication MapEvent
  const aiIndicator = b.isAI ? `
    <div style="margin:6px 0;padding:6px 10px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px;font-size:11px;color:#94a3b8;">
      üì¢ Publi√© par <strong style="color:#60a5fa;">MapEvent</strong> : il peut y avoir des erreurs, merci de <a href="${sourceUrl || '#'}" target="_blank" style="color:#60a5fa;text-decoration:underline;">v√©rifier la source</a>
    </div>
  ` : "";

  const actionsRow = `
    <div class="popup-actions-sticky" style="position:sticky;bottom:0;background:var(--ui-card-bg);z-index:10;padding:12px 0 8px;margin-top:12px;border-top:1px solid var(--ui-card-border);">
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:0;">
      <button onclick="onAction('like', 'booking', ${b.id})" class="pill small" style="flex:1;">
        ${currentUser.likes.includes('booking:'+b.id) ? 'üëç' : 'üëç'} Like
      </button>
      <button onclick="onAction('favorite', 'booking', ${b.id})" class="pill small" style="flex:1;">
        ${currentUser.favorites.some(f => f.id === b.id.toString() && f.mode === 'booking') ? '‚≠ê' : '‚òÜ'} Favoris
      </button>
      <button onclick="window.sharePopup('booking', ${b.id})" class="pill small" style="flex:1;">üì§ Partager</button>
      ${currentUser.isLoggedIn ? `
        <button onclick="inviteFriendsToEvent('booking', ${b.id})" class="pill small" style="flex:1;">‚ûï Inviter</button>
      ` : ''}
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;">
      <button onclick="onAction('agenda', 'booking', ${b.id})" class="pill small" style="flex:1;">
        ${currentUser.agenda.includes('booking:'+b.id) ? 'üìÖ ' + ((typeof window.t === 'function' ? window.t("in_agenda") : null) || "Dans agenda") : 'üìÖ ' + (typeof window.t === 'function' ? window.t("agenda") : "Agenda")}
      </button>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;">
      <button onclick="onAction('avis', 'booking', ${b.id})" class="pill small" style="flex:1;">‚≠ê Avis</button>
      <button onclick="onAction('discussion', 'booking', ${b.id})" class="pill small" style="flex:1;">üí¨ Contact</button>
      <button onclick="onAction('report', 'booking', ${b.id})" class="pill small" style="color:#ef4444;">üö®</button>
    </div>
    </div>
  `;

  return `
    <div style="width:100%;max-height:none;overflow:visible;font-family:system-ui,sans-serif;color:var(--ui-text-main);margin:0;padding:0;box-sizing:border-box;">
      <!-- Image principale avec overlay - ALIGN√âE PARFAITEMENT avec la bordure de la modal -->
      <div style="position:relative;border-radius:16px 16px 0 0;overflow:hidden;margin:0;padding:0;width:100%;left:0;right:0;box-sizing:border-box;min-height:280px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);">
        <div style="position:relative;width:100%;margin:0;padding:0;box-sizing:border-box;min-height:280px;display:flex;align-items:stretch;">
          ${imgTag}
        </div>
      </div>
      
      <!-- Content - ALIGN√â AVEC L'IMAGE -->
      <div style="padding:16px 12px 12px;margin:0;width:100%;box-sizing:border-box;">
        <!-- Category & Verified -->
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
          <span style="font-size:28px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2));">${emoji}</span>
          <span style="font-size:12px;color:var(--ui-text-muted);padding:4px 10px;background:rgba(148,163,184,0.1);border-radius:999px;">${cats}</span>
          ${levelBadge}
          ${verifiedBadge}
        </div>
        
        <!-- Title -->
        <h3 style="margin:0 0 10px;font-size:20px;font-weight:800;line-height:1.3;color:var(--ui-text-main);">${escapeHtml(b.name || "")}</h3>
        ${ratingStars ? `
          <div style="display:flex;align-items:center;gap:4px;margin-bottom:6px;">
            ${'‚≠ê'.repeat(Math.floor(parseFloat(b.rating)))}
            <span style="font-size:13px;color:#facc15;font-weight:600;">${b.rating}/5</span>
            <span style="font-size:11px;color:var(--ui-text-muted);">(${b.likes || 0} avis)</span>
        </div>
        ` : ''}
        <div style="font-size:13px;color:#1f2937;background:rgba(255,255,255,0.95);padding:6px 8px;border-radius:8px;margin-bottom:6px;font-weight:500;">
          üìç ${hasPaidContact ? escapeHtml(b.address || b.city || "") : escapeHtml(maskAddressNumber(b.address || b.city || ""))}
        </div>
        ${b.description ? `<div style="font-size:14px;color:#ffffff;margin-bottom:12px;line-height:1.7;padding:12px;background:transparent;border-radius:8px;">${escapeHtml(stripPhoneNumbers(b.description))}</div>` : ""}
        ${soundsSection}
        ${sourceLinkBlock}
        ${aiIndicator}
        ${hasPaidContact ? `
          <div style="margin:8px 0;padding:12px;background:linear-gradient(135deg,rgba(0,255,195,0.15),rgba(34,197,94,0.1));border:1px solid rgba(0,255,195,0.3);border-radius:10px;">
            <div style="font-size:12px;color:#00ffc3;font-weight:600;margin-bottom:8px;">‚úÖ Contact</div>
            <div style="font-size:13px;color:#e5e7eb;">üìß ${b.email || 'contact@artiste.ch'}</div>
            <div style="font-size:10px;color:var(--ui-text-muted);margin-top:6px;">üìÖ Ajout√© √† votre agenda permanent</div>
        </div>
        ` : `
          <div style="font-size:11px;color:#6b7280;margin:8px 0;padding:8px;background:rgba(107,114,128,0.1);border-radius:8px;">
            üîí Coordonn√©es masqu√©es ‚Ä¢ Email disponible apr√®s paiement
          </div>
        `}
        <div class="popup-actions-sticky" style="position:sticky;bottom:0;background:var(--ui-card-bg);margin:12px -12px -12px -12px;padding:12px;z-index:10;border-top:1px solid rgba(148,163,184,0.2);">
          ${actionsRow}
        </div>
        ${!hasPaidContact ? `
          <button onclick="onBuyContact('booking', ${b.id})" style="margin-top:10px;width:100%;padding:12px;border-radius:999px;border:none;cursor:pointer;font-size:14px;font-weight:700;background:var(--btn-main-bg);color:var(--btn-main-text);box-shadow:var(--btn-main-shadow);">
            üí≥ D√©bloquer contact + sons ‚Äì CHF 1.‚Äì
        </button>
        ` : ''}
      </div>
    </div>
  `;
}

// POPUP SERVICE
function buildServicePopup(s) {
  // Protection contre les erreurs TDZ
  if (typeof window.t !== 'function') {
    window.t = function(key) { return key; };
  }
  if (!window.translations || typeof window.translations !== 'object') {
    window.translations = window.translations || { fr: {}, en: {}, es: {}, zh: {}, hi: {} };
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que currentUser est d√©fini et a les propri√©t√©s n√©cessaires
  if (typeof currentUser === 'undefined' || !currentUser) {
    currentUser = {
      isLoggedIn: false,
      favorites: [],
      agenda: [],
      participating: [],
      subscription: 'free'
    };
  }
  
  // S'assurer que les propri√©t√©s n√©cessaires existent
  if (!currentUser.subscription) {
    currentUser.subscription = 'free';
  }
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que reviews est un objet (pas undefined)
  if (!currentUser.reviews || typeof currentUser.reviews !== 'object') {
    currentUser.reviews = {};
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que paidContacts est d√©fini
  if (typeof paidContacts === 'undefined' || !Array.isArray(paidContacts)) {
    paidContacts = [];
  }
  
  const borderColor = getBoostColor(s.boost);
  const imgTag = buildMainImageTag(s, s.name || "");
  const cats = (s.categories || []).join(" ‚Ä¢ ");
  const emoji = getCategoryEmoji(s);
  // ‚ö†Ô∏è GRATUIT : Coordonn√©es toujours affich√©es (plus de paiement requis)
  const hasPaidContact = true;

  // Badge v√©rifi√©
  const verifiedBadge = s.verified ? `<span class="verified-badge">‚úì V√©rifi√©</span>` : "";

  // Rating
  const ratingStars = s.rating ? `
    <div style="display:flex;align-items:center;gap:4px;margin-bottom:6px;">
      ${'‚≠ê'.repeat(Math.floor(parseFloat(s.rating)))}
      <span style="font-size:12px;color:var(--ui-text-muted);">${s.rating}/5</span>
      <span style="font-size:11px;color:var(--ui-text-muted);">(${s.likes || 0} avis)</span>
    </div>
  ` : "";

  // Indicateur publication MapEvent
  const aiIndicator = s.isAI ? `
    <div style="margin:6px 0;padding:6px 10px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px;font-size:11px;color:#94a3b8;">
      üì¢ Publi√© par <strong style="color:#60a5fa;">MapEvent</strong> : il peut y avoir des erreurs, merci de <a href="${s.sourceUrl || '#'}" target="_blank" style="color:#60a5fa;text-decoration:underline;">v√©rifier la source</a>
    </div>
  ` : "";

  const actionsRow = `
    <div class="popup-actions-sticky" style="position:sticky;bottom:0;background:var(--ui-card-bg);z-index:10;padding:12px 0 8px;margin-top:12px;border-top:1px solid var(--ui-card-border);">
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:0;">
      <button onclick="onAction('like', 'service', ${s.id})" class="pill small" style="flex:1;">
        ${currentUser.likes.includes('service:'+s.id) ? 'üëç' : 'üëç'} Like
      </button>
      <button onclick="onAction('favorite', 'service', ${s.id})" class="pill small" style="flex:1;">
        ${currentUser.favorites.some(f => f.id === s.id.toString() && f.mode === 'service') ? '‚≠ê' : '‚òÜ'} Favoris
      </button>
      <button onclick="window.sharePopup('service', ${s.id})" class="pill small" style="flex:1;">üì§ Partager</button>
      ${currentUser.isLoggedIn ? `
        <button onclick="inviteFriendsToEvent('service', ${s.id})" class="pill small" style="flex:1;">‚ûï Inviter</button>
      ` : ''}
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;">
      <button onclick="onAction('agenda', 'service', ${s.id})" class="pill small" style="flex:1;">
        ${currentUser.agenda.includes('service:'+s.id) ? 'üìÖ ' + ((typeof window.t === 'function' ? window.t("in_agenda") : null) || "Dans agenda") : 'üìÖ ' + (typeof window.t === 'function' ? window.t("agenda") : "Agenda")}
      </button>
      <button onclick="onAction('route', 'service', ${s.id})" class="pill small" style="flex:1;">üó∫Ô∏è ${(typeof window.t === 'function' ? window.t("route") : null) || "Itin√©raire"}</button>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;">
      <button onclick="onAction('avis', 'service', ${s.id})" class="pill small" style="flex:1;">‚≠ê Avis</button>
      <button onclick="onAction('discussion', 'service', ${s.id})" class="pill small" style="flex:1;">üí¨ Contact</button>
      <button onclick="onAction('report', 'service', ${s.id})" class="pill small" style="color:#ef4444;">üö®</button>
    </div>
    </div>
  `;

  return `
    <div style="width:100%;max-height:none;overflow:visible;font-family:system-ui,sans-serif;color:var(--ui-text-main);margin:0;padding:0;box-sizing:border-box;">
      <!-- Image principale avec overlay - ALIGN√âE PARFAITEMENT avec la bordure de la modal -->
      <div style="position:relative;border-radius:16px 16px 0 0;overflow:hidden;margin:0;padding:0;width:100%;left:0;right:0;box-sizing:border-box;min-height:280px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);">
        <div style="position:relative;width:100%;margin:0;padding:0;box-sizing:border-box;min-height:280px;display:flex;align-items:stretch;">
          ${imgTag}
        </div>
      </div>
      
      <!-- Content - ALIGN√â AVEC L'IMAGE -->
      <div style="padding:16px 12px 12px;margin:0;width:100%;box-sizing:border-box;">
        <!-- Category & Verified -->
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
          <span style="font-size:28px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2));">${emoji}</span>
          <span style="font-size:12px;color:var(--ui-text-muted);padding:4px 10px;background:rgba(148,163,184,0.1);border-radius:999px;">${cats}</span>
          ${verifiedBadge}
        </div>
        
        <!-- Title -->
        <h3 style="margin:0 0 10px;font-size:20px;font-weight:800;line-height:1.3;color:var(--ui-text-main);">${escapeHtml(s.name || "")}</h3>
        ${ratingStars ? `
          <div style="display:flex;align-items:center;gap:4px;margin-bottom:6px;">
            ${'‚≠ê'.repeat(Math.floor(parseFloat(s.rating)))}
            <span style="font-size:13px;color:#facc15;font-weight:600;">${s.rating}/5</span>
            <span style="font-size:11px;color:var(--ui-text-muted);">(${s.likes || 0} avis)</span>
        </div>
        ` : ''}
        <div style="font-size:13px;color:#1f2937;background:rgba(255,255,255,0.95);padding:6px 8px;border-radius:8px;margin-bottom:6px;font-weight:500;">
          üìç ${escapeHtml(s.address || s.city || "")}, Suisse
        </div>
        ${s.description ? `<div style="font-size:14px;color:#ffffff;margin-bottom:12px;line-height:1.7;padding:12px;background:transparent;border-radius:8px;">${escapeHtml(stripPhoneNumbers(s.description))}</div>` : ""}
        ${aiIndicator}
        ${hasPaidContact ? `
          <div style="margin:8px 0;padding:12px;background:linear-gradient(135deg,rgba(0,255,195,0.15),rgba(34,197,94,0.1));border:1px solid rgba(0,255,195,0.3);border-radius:10px;">
            <div style="font-size:12px;color:#00ffc3;font-weight:600;margin-bottom:8px;">‚úÖ Contact</div>
            <div style="font-size:13px;color:#e5e7eb;">üìß ${s.email || 'contact@service.ch'}</div>
            ${s.website ? `<a href="${s.website}" target="_blank" style="display:inline-flex;align-items:center;gap:4px;font-size:12px;color:#3b82f6;margin-top:4px;">üåê ${s.website}</a>` : ''}
            <div style="font-size:10px;color:var(--ui-text-muted);margin-top:6px;">üìÖ Ajout√© √† votre agenda permanent</div>
        </div>
        ` : `
          <div style="font-size:11px;color:#6b7280;margin:8px 0;padding:10px;background:rgba(107,114,128,0.1);border-radius:8px;">
            üîí <strong>Masqu√© :</strong> Email, site web<br>
            <span style="font-size:10px;">D√©bloquez pour acc√©der aux coordonn√©es compl√®tes</span>
          </div>
        `}
        <div class="popup-actions-sticky" style="position:sticky;bottom:0;background:var(--ui-card-bg);margin:12px -12px -12px -12px;padding:12px;z-index:10;border-top:1px solid rgba(148,163,184,0.2);">
          ${actionsRow}
        </div>
        ${!hasPaidContact ? `
          <button onclick="onBuyContact('service', ${s.id})" style="margin-top:10px;width:100%;padding:12px;border-radius:999px;border:none;cursor:pointer;font-size:14px;font-weight:700;background:var(--btn-main-bg);color:var(--btn-main-text);box-shadow:var(--btn-main-shadow);">
            üí≥ D√©bloquer contact + site ‚Äì CHF 1.‚Äì
        </button>
        ` : ''}
      </div>
    </div>
  `;
}

// ============================================
// CALCUL DE DISTANCE (formule de Haversine)
// ============================================
function calculateDistance(lat1, lng1, lat2, lng2) {
  // Formule de Haversine pour calculer la distance entre deux points GPS
  const R = 6371; // Rayon de la Terre en km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLng / 2) * Math.sin(dLng / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const distance = R * c; // Distance en km
  
  // V√©rification de s√©curit√©
  if (isNaN(distance) || !isFinite(distance) || distance < 0) {
    console.warn(`Distance invalide calcul√©e: ${distance} pour (${lat1},${lng1}) -> (${lat2},${lng2})`);
    return Infinity; // Retourner Infinity plut√¥t que null pour le tri
  }
  
  return distance;
}

// ============================================
// VUE LISTE (fullscreen) ‚Äì tri
// ============================================
function refreshListView() {
  const listView = document.getElementById("list-view");
  if (!listView) return;

  if (!listViewOpen) {
    listView.style.display = "none";
    return;
  }

  const base = getActiveData();
  
  // ============================================
  // LOGIQUE DE TRI SIMPLE ET CLAIRE
  // ============================================
  
  let data;
  
  // V√©rifier que selectedCityForSorting existe et a des coordonn√©es valides
  const hasValidCity = selectedCityForSorting && 
                       selectedCityForSorting.lat !== null && 
                       selectedCityForSorting.lat !== undefined &&
                       selectedCityForSorting.lng !== null && 
                       selectedCityForSorting.lng !== undefined &&
                       !isNaN(parseFloat(selectedCityForSorting.lat)) &&
                       !isNaN(parseFloat(selectedCityForSorting.lng));
  
  // LOG TR√àS VISIBLE POUR D√âBOGUER
  console.log(`\n\n\n========================================`);
  console.log(`üöÄ REFRESH LIST VIEW - TRI PAR DISTANCE`);
  console.log(`========================================`);
  console.log(`Ville s√©lectionn√©e: ${selectedCityForSorting ? selectedCityForSorting.name : 'AUCUNE'}`);
  console.log(`hasValidCity: ${hasValidCity}`);
  console.log(`Nombre d'items √† trier: ${base.length}`);
  console.log(`========================================\n\n\n`);
  
  if (hasValidCity) {
    // ============================================
    // MODE 1 : VILLE S√âLECTIONN√âE ‚Üí TRIER PAR DISTANCE + CAT√âGORIES + BOOSTS
    // Ordre de priorit√© : 1) DISTANCE (priorit√© absolue), 2) Cat√©gories, 3) Boost, 4) Platinum rank
    // ============================================
    
    console.log(`\nüéØ ===== TRI PAR DISTANCE (PRIORIT√â ABSOLUE) + CAT√âGORIES + BOOSTS =====`);
    console.log(`Ville: ${selectedCityForSorting.name}`);
    console.log(`Coordonn√©es: lat=${selectedCityForSorting.lat}, lng=${selectedCityForSorting.lng}`);
    console.log(`Total items √† trier: ${base.length}`);
    
    const boostOrder = { platinum: 1, gold: 2, silver: 3, bronze: 4, basic: 5 };
    
    // √âTAPE 1 : Calculer la distance pour CHAQUE item
    const cityLat = parseFloat(selectedCityForSorting.lat);
    const cityLng = parseFloat(selectedCityForSorting.lng);
    
    console.log(`üîç V√©rification coordonn√©es: lat=${cityLat}, lng=${cityLng}, isNaN(lat)=${isNaN(cityLat)}, isNaN(lng)=${isNaN(cityLng)}`);
    console.log(`üîç Type de lat: ${typeof selectedCityForSorting.lat}, Type de lng: ${typeof selectedCityForSorting.lng}`);
    
    if (isNaN(cityLat) || isNaN(cityLng)) {
      console.error(`‚ùå Coordonn√©es ville invalides ! selectedCityForSorting:`, selectedCityForSorting);
      console.error(`‚ùå Valeurs brutes: lat="${selectedCityForSorting.lat}", lng="${selectedCityForSorting.lng}"`);
      data = base.slice(0, 200);
    } else {
      // Calculer la distance pour tous les items
      // IMPORTANT: S'assurer que chaque item a un champ 'type' pour l'affichage
      const itemsWithDistance = base.map((item) => {
        let distance = Infinity;
        
        if (item.lat && item.lng) {
          const itemLat = parseFloat(item.lat);
          const itemLng = parseFloat(item.lng);
          
          if (!isNaN(itemLat) && !isNaN(itemLng)) {
            const calculatedDistance = calculateDistance(cityLat, cityLng, itemLat, itemLng);
            if (!isNaN(calculatedDistance) && isFinite(calculatedDistance) && calculatedDistance >= 0) {
              distance = calculatedDistance;
            }
          }
        }
        
        // S'assurer que l'item a un champ 'type' pour l'affichage
        // D√©terminer le type bas√© sur les propri√©t√©s de l'item
        let itemType = item.type;
        if (!itemType) {
          if (item.title && item.date) {
            itemType = 'event';
          } else if (item.name && (item.soundLinks || item.audioLinks)) {
            itemType = 'booking';
          } else if (item.name) {
            itemType = 'service';
          }
        }
        
        return { ...item, _distance: distance, type: itemType || item.type || 'event' };
      });
      
      // √âTAPE 2 : S√©parer les items avec distance valide de ceux sans distance
      // PRIORIT√â ABSOLUE : 1) DISTANCE, 2) Cat√©gories, 3) Boost, 4) Platinum rank
      console.log(`üîÑ D√©but du tri de ${itemsWithDistance.length} items...`);
      
      // V√©rifier quelques distances calcul√©es
      const sampleDistances = itemsWithDistance.slice(0, 5).map(item => ({
        city: item.city || item.title || item.name || 'N/A',
        distance: item._distance !== undefined && isFinite(item._distance) ? item._distance.toFixed(2) : 'Infinity',
        lat: item.lat,
        lng: item.lng
      }));
      console.log(`üìä EXEMPLE DE DISTANCES CALCUL√âES (5 premiers):`, sampleDistances);
      
      // S√âPARER : Items avec distance valide vs items sans distance
      const itemsWithValidDistance = itemsWithDistance.filter(item => isFinite(item._distance));
      const itemsWithoutDistance = itemsWithDistance.filter(item => !isFinite(item._distance));
      
      console.log(`‚úÖ ${itemsWithValidDistance.length} items avec distance valide`);
      console.log(`‚ö†Ô∏è ${itemsWithoutDistance.length} items sans distance`);
      
      // V√©rifier que les items avec distance valide ont bien des distances diff√©rentes
      if (itemsWithValidDistance.length >= 2) {
        const distances = itemsWithValidDistance.map(item => item._distance).sort((a, b) => a - b);
        console.log(`üìä DISTANCES MIN/MAX: ${distances[0].toFixed(2)}km (min) √† ${distances[distances.length - 1].toFixed(2)}km (max)`);
      }
      
      // V√©rifier quelques distances avant le tri
      const sampleDistancesBeforeSort = itemsWithValidDistance.slice(0, 5).map(item => ({
        city: item.city || 'N/A',
        distance: item._distance.toFixed(2),
        boost: item.boost || 'basic'
      }));
      console.log(`üìä AVANT TRI - 5 premiers avec distance:`, sampleDistancesBeforeSort);
      
      // V√âRIFICATION SP√âCIFIQUE : Monthey vs Gen√®ve pour Sierre
      const monthey = itemsWithValidDistance.find(item => item.city && item.city.toLowerCase().includes('monthey'));
      const geneve = itemsWithValidDistance.find(item => item.city && item.city.toLowerCase().includes('gen√®ve'));
      if (monthey && geneve) {
        console.log(`\nüîç V√âRIFICATION DISTANCES:`);
        console.log(`   Monthey: ${monthey._distance.toFixed(2)}km (lat:${monthey.lat}, lng:${monthey.lng})`);
        console.log(`   Gen√®ve: ${geneve._distance.toFixed(2)}km (lat:${geneve.lat}, lng:${geneve.lng})`);
        console.log(`   Ville s√©lectionn√©e: ${selectedCityForSorting.name} (lat:${cityLat}, lng:${cityLng})`);
        if (monthey._distance > geneve._distance) {
          console.error(`   ‚ùå PROBL√àME: Monthey (${monthey._distance.toFixed(2)}km) est PLUS LOIN que Gen√®ve (${geneve._distance.toFixed(2)}km) !`);
        } else {
          console.log(`   ‚úÖ CORRECT: Monthey (${monthey._distance.toFixed(2)}km) est plus proche que Gen√®ve (${geneve._distance.toFixed(2)}km)`);
        }
      }
      
      // V√âRIFICATION SP√âCIFIQUE : Sion vs Zurich pour Sierre
      const sion = itemsWithValidDistance.find(item => item.city && item.city.toLowerCase().includes('sion'));
      const zurich = itemsWithValidDistance.find(item => item.city && item.city.toLowerCase().includes('zurich'));
      if (sion && zurich) {
        console.log(`\nüîç V√âRIFICATION DISTANCES SION vs ZURICH:`);
        console.log(`   Sion: ${sion._distance.toFixed(2)}km (lat:${sion.lat}, lng:${sion.lng})`);
        console.log(`   Zurich: ${zurich._distance.toFixed(2)}km (lat:${zurich.lat}, lng:${zurich.lng})`);
        console.log(`   Ville s√©lectionn√©e: ${selectedCityForSorting.name} (lat:${cityLat}, lng:${cityLng})`);
        if (sion._distance > zurich._distance) {
          console.error(`   ‚ùå PROBL√àME CRITIQUE: Sion (${sion._distance.toFixed(2)}km) est PLUS LOIN que Zurich (${zurich._distance.toFixed(2)}km) !`);
          console.error(`   Cela ne devrait JAMAIS arriver car Sion est √† ~10km de Sierre et Zurich √† ~200km !`);
        } else {
          console.log(`   ‚úÖ CORRECT: Sion (${sion._distance.toFixed(2)}km) est plus proche que Zurich (${zurich._distance.toFixed(2)}km)`);
        }
      }
      
      // TRIER UNIQUEMENT les items avec distance valide
      // PRIORIT√â ABSOLUE : DISTANCE d'abord, puis cat√©gories, puis boost
      console.log(`üîç ORDRE DE PRIORIT√â: 1) DISTANCE (absolue), 2) CAT√âGORIES, 3) BOOST`);
      
      // TRI SIMPLIFI√â : DISTANCE UNIQUEMENT - PRIORIT√â ABSOLUE
      // La distance est TOUJOURS le premier crit√®re, sans aucune exception
      itemsWithValidDistance.sort((a, b) => {
        const distA = a._distance !== undefined && isFinite(a._distance) ? a._distance : Infinity;
        const distB = b._distance !== undefined && isFinite(b._distance) ? b._distance : Infinity;
        
        // PRIORIT√â ABSOLUE : Distance uniquement
        // Si les distances sont diff√©rentes, trier par distance SEULEMENT
        if (distA !== distB) {
          return distA - distB;
        }
        
        // Seulement si les distances sont EXACTEMENT identiques (tr√®s rare), utiliser les autres crit√®res
        // 2. Cat√©gories s√©lectionn√©es (si filtre actif) - utilise getEffectiveCategoryParts + descendants pour coh√©rence avec le filtre
        if (selectedCategories.length > 0 && explorerTree) {
          const allowed = new Set(selectedCategories.map(sc => sc.toLowerCase()));
          selectedCategories.forEach(sc => {
            (findCategoryDescendants(sc.toLowerCase(), explorerTree) || []).forEach(d => allowed.add(d));
          });
          const matchA = Array.from(getEffectiveCategoryParts(a)).some(p => allowed.has(p));
          const matchB = Array.from(getEffectiveCategoryParts(b)).some(p => allowed.has(p));
          if (matchA && !matchB) return -1;
          if (!matchA && matchB) return 1;
        }
        
        // 3. Boost (platinum > gold > silver > bronze > basic)
        const boostA = boostOrder[a.boost || "basic"] || 99;
        const boostB = boostOrder[b.boost || "basic"] || 99;
        if (boostA !== boostB) return boostA - boostB;
        
        // 4. Platinum rank
        if (a.boost === "platinum" && b.boost === "platinum") {
          const rankA = a.platinumRank || 10;
          const rankB = b.platinumRank || 10;
          if (rankA !== rankB) return rankA - rankB;
        }
        
        return 0;
      });
      
      // RECONSTITUER : Items avec distance tri√©s + items sans distance √† la fin
      const sortedItems = [...itemsWithValidDistance, ...itemsWithoutDistance];
      
      // V√©rifier quelques distances apr√®s le tri
      const sampleDistancesAfterSort = sortedItems.slice(0, 5).map(item => ({
        city: item.city || 'N/A',
        distance: isFinite(item._distance) ? item._distance.toFixed(2) : 'Infinity',
        boost: item.boost || 'basic'
      }));
      console.log(`üìä APR√àS TRI - 5 premiers:`, sampleDistancesAfterSort);
      
      // V√âRIFICATION SP√âCIFIQUE APR√àS TRI : Monthey vs Gen√®ve
      const montheyAfter = sortedItems.find(item => item.city && item.city.toLowerCase().includes('monthey'));
      const geneveAfter = sortedItems.find(item => item.city && item.city.toLowerCase().includes('gen√®ve'));
      if (montheyAfter && geneveAfter) {
        const montheyIndex = sortedItems.indexOf(montheyAfter);
        const geneveIndex = sortedItems.indexOf(geneveAfter);
        console.log(`\nüîç V√âRIFICATION APR√àS TRI:`);
        console.log(`   Monthey: position ${montheyIndex + 1}, distance ${montheyAfter._distance.toFixed(2)}km`);
        console.log(`   Gen√®ve: position ${geneveIndex + 1}, distance ${geneveAfter._distance.toFixed(2)}km`);
        if (montheyIndex > geneveIndex && montheyAfter._distance < geneveAfter._distance) {
          console.error(`   ‚ùå ERREUR DE TRI: Monthey (${montheyAfter._distance.toFixed(2)}km) est APR√àS Gen√®ve (${geneveAfter._distance.toFixed(2)}km) alors qu'il devrait √™tre AVANT !`);
        } else if (montheyIndex < geneveIndex) {
          console.log(`   ‚úÖ CORRECT: Monthey est AVANT Gen√®ve dans le tri`);
        }
      }
      
      // V√âRIFICATION SP√âCIFIQUE APR√àS TRI : Sion vs Zurich
      const sionAfter = sortedItems.find(item => item.city && item.city.toLowerCase().includes('sion'));
      const zurichAfter = sortedItems.find(item => item.city && item.city.toLowerCase().includes('zurich'));
      if (sionAfter && zurichAfter) {
        const sionIndex = sortedItems.indexOf(sionAfter);
        const zurichIndex = sortedItems.indexOf(zurichAfter);
        console.log(`\nüîç V√âRIFICATION APR√àS TRI SION vs ZURICH:`);
        console.log(`   Sion: position ${sionIndex + 1}, distance ${sionAfter._distance.toFixed(2)}km`);
        console.log(`   Zurich: position ${zurichIndex + 1}, distance ${zurichAfter._distance.toFixed(2)}km`);
        if (sionIndex > zurichIndex && sionAfter._distance < zurichAfter._distance) {
          console.error(`   ‚ùå ERREUR CRITIQUE DE TRI: Sion (${sionAfter._distance.toFixed(2)}km) est APR√àS Zurich (${zurichAfter._distance.toFixed(2)}km) alors qu'il devrait √™tre AVANT !`);
          console.error(`   Le tri ne fonctionne PAS correctement !`);
        } else if (sionIndex < zurichIndex) {
          console.log(`   ‚úÖ CORRECT: Sion est AVANT Zurich dans le tri`);
        }
      }
      
      console.log(`‚úÖ Tri termin√© - ${sortedItems.length} items tri√©s`);
      
      // V√âRIFICATION : S'assurer que le tri par distance est correct dans itemsWithValidDistance
      if (itemsWithValidDistance.length >= 2) {
        let triCorrect = true;
        for (let i = 0; i < itemsWithValidDistance.length - 1; i++) {
          const current = itemsWithValidDistance[i];
          const next = itemsWithValidDistance[i + 1];
          if (current._distance > next._distance) {
            triCorrect = false;
            console.error(`‚ùå ERREUR DE TRI: Item ${i} (${current._distance.toFixed(2)}km) est APR√àS item ${i+1} (${next._distance.toFixed(2)}km) !`);
            console.error(`   Item ${i}: ${current.city || current.title} - ${current._distance.toFixed(2)}km`);
            console.error(`   Item ${i+1}: ${next.city || next.title} - ${next._distance.toFixed(2)}km`);
            break;
          }
        }
        if (triCorrect) {
          console.log(`‚úÖ V√âRIFICATION: Le tri par distance est CORRECT - tous les items sont tri√©s par distance croissante`);
        }
      }
      
      // UTILISER DIRECTEMENT sortedItems (qui contient itemsWithValidDistance tri√© + itemsWithoutDistance)
      // FORCER LE TRI PAR DISTANCE UNIQUEMENT - PRIORIT√â ABSOLUE
      data = sortedItems.slice(0, 200);
      
      // FORCER LE TRI PAR DISTANCE - PRIORIT√â ABSOLUE (aucune exception)
      console.log(`\nüîß FORCER TRI PAR DISTANCE (PRIORIT√â ABSOLUE) sur data - ${data.length} items`);
      data.sort((a, b) => {
        const distA = a._distance !== undefined && isFinite(a._distance) ? a._distance : Infinity;
        const distB = b._distance !== undefined && isFinite(b._distance) ? b._distance : Infinity;
        // DISTANCE UNIQUEMENT - AUCUN AUTRE CRIT√àRE
        return distA - distB;
      });
      
      // V√âRIFICATION CRITIQUE : S'assurer que data est bien tri√© AVANT l'affichage
      console.log(`\nüéØ V√âRIFICATION APR√àS TRI FORC√â - data contient ${data.length} items`);
      if (data.length >= 5) {
        console.log(`üîç 5 PREMIERS ITEMS DANS data APR√àS TRI FORC√â:`);
        for (let i = 0; i < 5; i++) {
          const item = data[i];
          const dist = item._distance !== undefined && isFinite(item._distance) ? item._distance.toFixed(2) : 'Infinity';
          console.log(`   ${i + 1}. ${item.city || item.title || item.name || 'N/A'} - ${dist}km`);
        }
        
        // V√©rifier que le tri est correct
        let triCorrect = true;
        for (let i = 0; i < Math.min(10, data.length - 1); i++) {
          const current = data[i];
          const next = data[i + 1];
          const distCurrent = current._distance !== undefined && isFinite(current._distance) ? current._distance : Infinity;
          const distNext = next._distance !== undefined && isFinite(next._distance) ? next._distance : Infinity;
          if (distCurrent > distNext) {
            triCorrect = false;
            console.error(`   ‚ùå ERREUR: Item ${i} (${distCurrent.toFixed(2)}km) est APR√àS item ${i+1} (${distNext.toFixed(2)}km) !`);
            break;
          }
        }
        if (triCorrect) {
          console.log(`   ‚úÖ data est correctement tri√© par distance (PRIORIT√â ABSOLUE)`);
        } else {
          console.error(`   ‚ùå ERREUR CRITIQUE: Le tri ne fonctionne PAS !`);
        }
      }
      
      // V√âRIFICATION FINALE : V√©rifier que data contient bien les donn√©es tri√©es
      console.log(`\nüéØ V√âRIFICATION FINALE - data contient ${data.length} items`);
      const montheyInData = data.find(item => item.city && item.city.toLowerCase().includes('monthey'));
      const geneveInData = data.find(item => item.city && item.city.toLowerCase().includes('gen√®ve'));
      if (montheyInData && geneveInData) {
        const montheyPosInData = data.indexOf(montheyInData) + 1;
        const genevePosInData = data.indexOf(geneveInData) + 1;
        console.log(`   Monthey dans data: position ${montheyPosInData}, distance ${montheyInData._distance.toFixed(2)}km`);
        console.log(`   Gen√®ve dans data: position ${genevePosInData}, distance ${geneveInData._distance.toFixed(2)}km`);
        if (montheyPosInData > genevePosInData && montheyInData._distance < geneveInData._distance) {
          console.error(`   ‚ùå ERREUR CRITIQUE: Monthey est APR√àS Gen√®ve dans data alors qu'il devrait √™tre AVANT !`);
        } else {
          console.log(`   ‚úÖ data est correctement tri√©`);
        }
      }
      
      // V√âRIFICATION FINALE : Sion vs Zurich dans data
      const sionInData = data.find(item => item.city && item.city.toLowerCase().includes('sion'));
      const zurichInData = data.find(item => item.city && item.city.toLowerCase().includes('zurich'));
      if (sionInData && zurichInData) {
        const sionPosInData = data.indexOf(sionInData) + 1;
        const zurichPosInData = data.indexOf(zurichInData) + 1;
        console.log(`\nüéØ V√âRIFICATION FINALE SION vs ZURICH dans data:`);
        const sionDist = sionInData._distance !== undefined && isFinite(sionInData._distance) ? sionInData._distance : Infinity;
        const zurichDist = zurichInData._distance !== undefined && isFinite(zurichInData._distance) ? zurichInData._distance : Infinity;
        console.log(`   Sion dans data: position ${sionPosInData}, distance ${sionDist.toFixed(2)}km`);
        console.log(`   Zurich dans data: position ${zurichPosInData}, distance ${zurichDist.toFixed(2)}km`);
        if (sionPosInData > zurichPosInData && sionDist < zurichDist) {
          console.error(`   ‚ùå ERREUR CRITIQUE: Sion est APR√àS Zurich dans data alors qu'il devrait √™tre AVANT !`);
          console.error(`   Le probl√®me est dans la variable data utilis√©e pour l'affichage !`);
          console.error(`   FORCER LE TRI MANUEL IMM√âDIATEMENT`);
          // FORCER le tri manuel
          data.sort((a, b) => {
            const distA = a._distance !== undefined && isFinite(a._distance) ? a._distance : Infinity;
            const distB = b._distance !== undefined && isFinite(b._distance) ? b._distance : Infinity;
            return distA - distB;
          });
          console.log(`   ‚úÖ Tri manuel appliqu√© - ${data.length} items tri√©s`);
        } else if (sionPosInData < zurichPosInData) {
          console.log(`   ‚úÖ CORRECT: Sion est AVANT Zurich dans data`);
        }
      }
      
      // V√âRIFICATION CRITIQUE FINALE : V√©rifier que les 5 premiers items sont bien tri√©s par distance
      if (data.length >= 5) {
        console.log(`\nüîç V√âRIFICATION FINALE DES 5 PREMIERS ITEMS:`);
        let triCorrect = true;
        for (let i = 0; i < Math.min(5, data.length); i++) {
          const item = data[i];
          const dist = item._distance !== undefined && isFinite(item._distance) ? item._distance : Infinity;
          console.log(`   ${i + 1}. ${item.city || item.title || item.name || 'N/A'} - ${dist !== Infinity ? dist.toFixed(2) + 'km' : 'Infinity'}`);
          
          // V√©rifier que l'item suivant n'est pas plus proche
          if (i < data.length - 1) {
            const next = data[i + 1];
            const nextDist = next._distance !== undefined && isFinite(next._distance) ? next._distance : Infinity;
            if (dist > nextDist) {
              triCorrect = false;
              console.error(`   ‚ùå ERREUR: Item ${i} (${dist.toFixed(2)}km) est APR√àS item ${i+1} (${nextDist.toFixed(2)}km) !`);
            }
          }
        }
        
        if (!triCorrect) {
          console.error(`   ‚ùå LE TRI EST INCORRECT - FORCER LE TRI MANUEL AVANT AFFICHAGE`);
          data.sort((a, b) => {
            const distA = a._distance !== undefined && isFinite(a._distance) ? a._distance : Infinity;
            const distB = b._distance !== undefined && isFinite(b._distance) ? b._distance : Infinity;
            return distA - distB;
          });
          console.log(`   ‚úÖ Tri manuel appliqu√© AVANT AFFICHAGE - ${data.length} items tri√©s`);
          
          // R√©afficher les 5 premiers apr√®s le tri
          console.log(`\nüîç APR√àS TRI MANUEL - 5 PREMIERS:`);
          for (let i = 0; i < Math.min(5, data.length); i++) {
            const item = data[i];
            const dist = item._distance !== undefined && isFinite(item._distance) ? item._distance : Infinity;
            console.log(`   ${i + 1}. ${item.city || item.title || item.name || 'N/A'} - ${dist !== Infinity ? dist.toFixed(2) + 'km' : 'Infinity'}`);
          }
        } else {
          console.log(`   ‚úÖ Le tri est CORRECT - tous les items sont tri√©s par distance croissante`);
        }
      }
    
      // Logs d√©taill√©s
      console.log(`‚úÖ ${itemsWithValidDistance.length} items avec distance calcul√©e`);
      console.log(`‚ö†Ô∏è ${itemsWithDistance.length - itemsWithValidDistance.length} items sans distance`);
      
      if (itemsWithValidDistance.length > 0) {
        console.log(`\nüìã TOP 20 (tri: DISTANCE ‚Üí CAT√âGORIES ‚Üí BOOSTS) :`);
        data.slice(0, 20).forEach((item, index) => {
          const cityName = (item.city || 'N/A').padEnd(20);
          const distance = isFinite(item._distance) ? item._distance.toFixed(2).padStart(8) : 'N/A'.padStart(8);
          const boost = (item.boost || 'basic').padEnd(10);
          const title = (item.title || item.name || 'N/A').substring(0, 30);
          console.log(`   ${(index + 1).toString().padStart(2)}. ${cityName} ${distance}km  ${boost}  "${title}"`);
        });
        
        // V√©rification sp√©cifique pour Sion et Zurich si on cherche Sierre
        if (selectedCityForSorting.name.toLowerCase().includes('sierre') || selectedCityForSorting.name.toLowerCase().includes('sion')) {
          const sion = itemsWithDistance.find(d => d.city && d.city.toLowerCase().includes('sion'));
          const zurich = itemsWithDistance.find(d => d.city && d.city.toLowerCase().includes('zurich'));
          
          console.log(`\nüîç V√âRIFICATION SP√âCIFIQUE:`);
          if (sion) {
            const sionPos = itemsWithDistance.indexOf(sion) + 1;
            console.log(`   ‚úÖ SION: ${sion._distance.toFixed(2)}km (position ${sionPos})`);
          }
          if (zurich) {
            const zurichPos = itemsWithDistance.indexOf(zurich) + 1;
            console.log(`   ‚úÖ ZURICH: ${zurich._distance.toFixed(2)}km (position ${zurichPos})`);
          }
          
          if (sion && zurich) {
            if (sion._distance < zurich._distance) {
              console.log(`   ‚úÖ TRI CORRECT: Sion (${sion._distance.toFixed(2)}km) est AVANT Zurich (${zurich._distance.toFixed(2)}km)`);
            } else {
              console.error(`   ‚ùå ERREUR: Sion (${sion._distance.toFixed(2)}km) est APR√àS Zurich (${zurich._distance.toFixed(2)}km) !`);
            }
          }
        }
      }
      
      console.log(`\nüìä Liste finale: ${data.length} items`);
      
      // V√©rification finale : Afficher les 5 premiers avec leurs distances
      console.log(`\nüîç V√âRIFICATION FINALE - 5 PREMIERS ITEMS:`);
      data.slice(0, 5).forEach((item, index) => {
        const dist = isFinite(item._distance) ? item._distance.toFixed(2) : 'Infinity';
        console.log(`   ${index + 1}. ${item.city || 'N/A'} - ${dist}km - boost:${item.boost || 'basic'}`);
      });
    }
  } else {
    // ============================================
    // MODE 2 : AUCUNE VILLE S√âLECTIONN√âE ‚Üí TRIER PAR BOOST ET CAT√âGORIES
    // ============================================
    
    const boostOrder = { platinum: 1, gold: 2, silver: 3, bronze: 4, basic: 5 };
    
    data = base
      .slice()
      .sort((a, b) => {
        // 1. Cat√©gories s√©lectionn√©es (si filtre actif) - utilise getEffectiveCategoryParts + descendants pour coh√©rence avec le filtre
        if (selectedCategories.length > 0 && explorerTree) {
          const allowed2 = new Set(selectedCategories.map(sc => sc.toLowerCase()));
          selectedCategories.forEach(sc => {
            (findCategoryDescendants(sc.toLowerCase(), explorerTree) || []).forEach(d => allowed2.add(d));
          });
          const matchA = Array.from(getEffectiveCategoryParts(a)).some(p => allowed2.has(p));
          const matchB = Array.from(getEffectiveCategoryParts(b)).some(p => allowed2.has(p));
          if (matchA && !matchB) return -1;
          if (!matchA && matchB) return 1;
        }
        
        // 2. Boost (platinum > gold > silver > bronze > basic)
        const boostA = boostOrder[a.boost || "basic"] || 99;
        const boostB = boostOrder[b.boost || "basic"] || 99;
        if (boostA !== boostB) return boostA - boostB;
        
        // 3. Platinum rank (si les deux sont platinum)
        if (a.boost === "platinum" && b.boost === "platinum") {
          const rankA = a.platinumRank || 10;
          const rankB = b.platinumRank || 10;
          if (rankA !== rankB) return rankA - rankB;
        }
        
        return 0;
      })
      .slice(0, 200);
  }

  // Le tri est d√©j√† fait dans le bloc ci-dessus, pas besoin de v√©rification suppl√©mentaire

  // Valeur actuelle de la recherche
  const currentSearchValue = listSearchCity || "";

  listView.style.display = "block";
  listView.innerHTML = `
    <div class="list-header" style="display:flex;flex-direction:column;gap:12px;padding:16px;background:var(--ui-card-bg);border-bottom:1px solid var(--ui-card-border);">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
        <div style="flex:1;">
          <div style="font-size:16px;font-weight:700;margin-bottom:4px;">üìã R√©sultats (${data.length}/${Math.min(base.length, 200)}${base.length > 200 ? ' (limite: 200 max)' : ''}) ‚Äì ${currentMode.toUpperCase()}</div>
          <div style="font-size:12px;color:var(--ui-text-muted);">Cliquer sur un √©l√©ment pour ouvrir la popup compl√®te.${base.length > 200 ? ' Affichage limit√© √† 200 r√©sultats maximum.' : ''}</div>
        </div>
        <button onclick="toggleListView()" style="padding:8px 12px;border-radius:8px;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.4);color:#ef4444;font-size:12px;cursor:pointer;">‚úï Fermer</button>
      </div>
      
      <!-- Barre de recherche ville/r√©gion -->
      <div style="position:relative;">
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="flex:1;position:relative;">
            <input type="text" 
                   id="city-search-input"
                   placeholder="üîç Rechercher une ville ou r√©gion..."
                   value="${escapeHtml(currentSearchValue)}"
                   oninput="onCitySearchInput(this.value)"
                   onfocus="showCitySuggestions()"
                   style="width:100%;padding:12px 16px;padding-right:40px;border-radius:12px;border:2px solid var(--ui-card-border);background:rgba(0,0,0,0.3);color:var(--ui-text-main);font-size:14px;outline:none;transition:all 0.2s;"
                   onfocus="this.style.borderColor='#00ffc3'"
                   onblur="setTimeout(() => { this.style.borderColor='var(--ui-card-border)'; hideCitySuggestions(); }, 200)">
            ${currentSearchValue ? `
              <button onclick="clearCitySearch()" 
                      style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--ui-text-muted);font-size:18px;cursor:pointer;padding:4px;"
                      title="Effacer">‚úï</button>
            ` : ''}
          </div>
        </div>
        <div id="city-suggestions" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--ui-card-bg);border:1px solid var(--ui-card-border);border-radius:12px;margin-top:4px;max-height:250px;overflow-y:auto;z-index:100;box-shadow:0 10px 30px rgba(0,0,0,0.4);"></div>
      </div>
      
      ${selectedCityForSorting ? `
        <div style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:linear-gradient(135deg,rgba(0,255,195,0.2),rgba(34,197,94,0.15));border:2px solid rgba(0,255,195,0.4);border-radius:10px;">
          <span style="font-size:18px;">üìç</span>
          <div style="flex:1;">
            <div style="font-size:13px;color:var(--ui-text-muted);margin-bottom:2px;">Tri par proximit√© activ√©</div>
            <div style="font-size:15px;font-weight:700;color:#00ffc3;">
              ${escapeHtml(selectedCityForSorting.fullName || selectedCityForSorting.name)}
              ${selectedCityForSorting.countryCode ? getFlagEmoji(selectedCityForSorting.countryCode) : ''}
            </div>
          </div>
          <button onclick="clearCitySearch()" style="padding:6px 12px;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.4);border-radius:6px;color:#ef4444;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.3)'" onmouseout="this.style.background='rgba(239,68,68,0.2)'">‚úï R√©initialiser</button>
        </div>
      ` : ''}
    </div>

    <div class="list-grid" style="display:grid;grid-template-columns: repeat(auto-fill,minmax(280px,1fr));gap:12px;padding:16px;max-height:calc(100vh - 200px);overflow-y:auto;">
      ${
        (() => {
          // FORCER LE TRI PAR DISTANCE AVANT L'AFFICHAGE si une ville est s√©lectionn√©e
          // PRIORIT√â ABSOLUE : Distance uniquement - AUCUNE EXCEPTION
          if (selectedCityForSorting && selectedCityForSorting.lat && selectedCityForSorting.lng) {
            console.log(`\n\n\n========================================`);
            console.log(`üîß FORCER TRI PAR DISTANCE (PRIORIT√â ABSOLUE)`);
            console.log(`========================================`);
            console.log(`Nombre d'items: ${data.length}`);
            console.log(`Ville s√©lectionn√©e: ${selectedCityForSorting.name}`);
            console.log(`Coordonn√©es: lat=${selectedCityForSorting.lat}, lng=${selectedCityForSorting.lng}`);
            
            // V√©rifier que les items ont bien des distances calcul√©es
            const itemsWithDist = data.filter(item => item._distance !== undefined && isFinite(item._distance));
            const itemsWithoutDist = data.filter(item => !item._distance || !isFinite(item._distance));
            console.log(`   Items avec distance: ${itemsWithDist.length}, sans distance: ${itemsWithoutDist.length}`);
            
            // Cr√©er une copie et trier UNIQUEMENT par distance
            const sortedData = [...data].sort((a, b) => {
              const distA = a._distance !== undefined && isFinite(a._distance) ? a._distance : Infinity;
              const distB = b._distance !== undefined && isFinite(b._distance) ? b._distance : Infinity;
              // Distance est la PRIORIT√â ABSOLUE - pas d'autre crit√®re
              const result = distA - distB;
              return result;
            });
            
            // V√©rifier les 10 premiers pour confirmer le tri
            console.log(`\nüîç 10 PREMIERS APR√àS TRI PAR DISTANCE (PRIORIT√â ABSOLUE):`);
            for (let i = 0; i < Math.min(10, sortedData.length); i++) {
              const item = sortedData[i];
              const dist = item._distance !== undefined && isFinite(item._distance) ? item._distance.toFixed(2) : 'Infinity';
              const city = item.city || item.title || item.name || 'N/A';
              console.log(`   ${i + 1}. ${city} - ${dist}km`);
            }
            
            // V√©rification finale : s'assurer que le tri est correct
            let triCorrect = true;
            for (let i = 0; i < Math.min(10, sortedData.length - 1); i++) {
              const current = sortedData[i];
              const next = sortedData[i + 1];
              const distCurrent = current._distance !== undefined && isFinite(current._distance) ? current._distance : Infinity;
              const distNext = next._distance !== undefined && isFinite(next._distance) ? next._distance : Infinity;
              if (distCurrent > distNext) {
                triCorrect = false;
                console.error(`\n‚ùå ERREUR CRITIQUE: Item ${i} (${distCurrent.toFixed(2)}km) est APR√àS item ${i+1} (${distNext.toFixed(2)}km) !`);
                console.error(`   Item ${i}: ${current.city || current.title || current.name}`);
                console.error(`   Item ${i+1}: ${next.city || next.title || next.name}`);
              }
            }
            if (triCorrect) {
              console.log(`\n‚úÖ TRI CORRECT - Les items sont tri√©s par distance croissante`);
              console.log(`========================================\n\n\n`);
            } else {
              console.error(`\n‚ùå ERREUR CRITIQUE: Le tri ne fonctionne PAS !`);
              console.error(`========================================\n\n\n`);
            }
            
            return sortedData;
          }
          return data;
        })().map(item => {
            if (item.type === "event") {
              return buildEventCard(item, item._distance);
            }
            if (item.type === "booking") {
              return buildBookingCard(item, item._distance);
            }
            if (item.type === "service") {
              return buildServiceCard(item, item._distance);
            }
            return "";
          })
          .join("") ||
        "<div style='color:var(--ui-text-muted);padding:20px;text-align:center;'>Aucun r√©sultat</div>"
      }
    </div>
  `;

  listView.querySelectorAll("[data-type][data-id]").forEach(card => {
    card.addEventListener("click", () => {
      const type = card.dataset.type;
      const id = card.dataset.id;
      openPopupFromList(type, id);
    });
  });
  
  // V√©rifier les alertes de proximit√© apr√®s le rafra√Æchissement de la liste
  if (currentUser && currentUser.isLoggedIn) {
    checkProximityAlerts();
  }
  
  // Nettoyer les √©v√©nements pass√©s (sauf organisateurs)
  cleanExpiredEvents();
  
  // Mode d√©couverte
  refreshDiscoveryCarousel();
}

// Cartes style Airbnb pour la liste
function buildEventCard(ev, distance = null) {
  const imgTag = buildMainImageTag(ev, ev.title || "");
  const borderColor = getBoostColor(ev.boost);
  const emoji = getCategoryEmoji(ev);
  const isLiked = currentUser.likes.includes(`event:${ev.id}`);
  
  // Badge boost
  const boostBadge = ev.boost && ev.boost !== "basic" ? `
    <div style="position:absolute;top:8px;right:8px;padding:4px 8px;border-radius:999px;font-size:10px;font-weight:700;z-index:6;
      ${ev.boost === 'platinum' ? 'background:linear-gradient(135deg,#e5e4e2,#fff);color:#1f2937;' : ''}
      ${ev.boost === 'gold' ? 'background:linear-gradient(135deg,#ffd700,#ffed4a);color:#1f2937;' : ''}
      ${ev.boost === 'silver' ? 'background:linear-gradient(135deg,#c0c0c0,#e5e5e5);color:#1f2937;' : ''}
      ${ev.boost === 'bronze' ? 'background:linear-gradient(135deg,#cd7f32,#daa06d);color:#fff;' : ''}
    ">
      ${ev.boost === 'platinum' ? 'üëë TOP' : ev.boost === 'gold' ? 'ü•á' : ev.boost === 'silver' ? 'ü•à' : 'ü•â'}
    </div>
  ` : '';
  
  // Badge distance (afficher seulement si distance valide)
  const distanceBadge = (distance !== null && distance !== undefined && isFinite(distance) && distance !== Infinity) ? `
    <div style="position:absolute;top:8px;left:8px;padding:4px 8px;border-radius:999px;font-size:10px;font-weight:600;background:rgba(0,0,0,0.7);color:#fff;backdrop-filter:blur(4px);z-index:5;">
      üìç ${distance < 1 ? Math.round(distance * 1000) + 'm' : distance.toFixed(1) + 'km'}
    </div>
  ` : '';

  return `
    <div data-type="event" data-id="${ev.id}" class="event-card" onclick="openPopupFromList('event', ${ev.id})" style="
      border:3px solid ${borderColor};
      border-radius:16px;
      background:var(--ui-card-bg);
      overflow:hidden;
      cursor:pointer;
      transition:all 0.2s ease;
      box-shadow:0 4px 20px rgba(0,0,0,0.2);
      position:relative;
    ">
      <div style="position:relative;height:160px;overflow:hidden;">
        ${imgTag}
        ${distanceBadge}
        ${boostBadge}
        <button onclick="event.stopPropagation();onAction('like','event',${ev.id})" style="position:absolute;top:8px;${distanceBadge ? 'left:50px;' : 'left:8px;'}width:32px;height:32px;border-radius:50%;border:none;background:rgba(0,0,0,0.5);color:${isLiked ? '#ef4444' : '#fff'};cursor:pointer;font-size:16px;z-index:7;">
          ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}
        </button>
        ${ev.status && ev.status !== 'OK' ? `<div style="position:absolute;bottom:0;left:0;right:0;padding:6px;background:${ev.status === 'COMPLET' ? 'rgba(234,179,8,0.9)' : 'rgba(239,68,68,0.9)'};color:#fff;font-size:11px;font-weight:700;text-align:center;">${ev.status}</div>` : ''}
      </div>
      <div style="padding:12px;">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
          <span style="font-size:18px;">${emoji}</span>
          <span style="font-size:11px;color:var(--ui-text-muted);">${(ev.categories || []).join(" ‚Ä¢ ")}</span>
          ${ev.verified ? '<span style="font-size:10px;color:#3b82f6;">‚úì</span>' : ''}
        </div>
        <div style="font-size:15px;font-weight:700;margin-bottom:4px;line-height:1.3;">${escapeHtml(ev.title || "")}</div>
        <div style="font-size:12px;color:#00ffc3;margin-bottom:4px;">
          üìÖ ${formatEventDateRange(ev.startDate, ev.endDate)}
        </div>
        <div style="font-size:11px;color:var(--ui-text-muted);margin-bottom:8px;">
          üìç ${escapeHtml(ev.city || "")}
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--ui-text-muted);">
          <span>‚ù§Ô∏è ${ev.likes || 0} ‚Ä¢ üë• ${ev.participants || 0}</span>
          ${ev.isAI ? '<span style="color:#facc15;">ü§ñ IA</span>' : ''}
        </div>
      </div>
    </div>
  `;
}

function buildBookingCard(b, distance = null) {
  const imgTag = buildMainImageTag(b, b.name || "");
  const borderColor = getBoostColor(b.boost);
  const emoji = getCategoryEmoji(b);
  const isLiked = currentUser.likes.includes(`booking:${b.id}`);
  
  // Badge distance (afficher seulement si distance valide)
  const distanceBadge = (distance !== null && distance !== undefined && isFinite(distance) && distance !== Infinity) ? `
    <div style="position:absolute;top:8px;left:8px;padding:4px 8px;border-radius:999px;font-size:10px;font-weight:600;background:rgba(0,0,0,0.7);color:#fff;backdrop-filter:blur(4px);z-index:5;">
      üìç ${distance < 1 ? Math.round(distance * 1000) + 'm' : distance.toFixed(1) + 'km'}
    </div>
  ` : '';

  return `
    <div data-type="booking" data-id="${b.id}" class="event-card" onclick="openPopupFromList('booking', ${b.id})" style="
      border:3px solid ${borderColor};
      border-radius:16px;
      background:var(--ui-card-bg);
      overflow:hidden;
      cursor:pointer;
      transition:all 0.2s ease;
      box-shadow:0 4px 20px rgba(0,0,0,0.2);
      position:relative;
    ">
      <div style="position:relative;height:160px;overflow:hidden;">
        ${imgTag}
        ${distanceBadge}
        <button onclick="event.stopPropagation();onAction('like','booking',${b.id})" style="position:absolute;top:8px;${distanceBadge ? 'left:50px;' : 'left:8px;'}width:32px;height:32px;border-radius:50%;border:none;background:rgba(0,0,0,0.5);color:${isLiked ? '#ef4444' : '#fff'};cursor:pointer;font-size:16px;z-index:7;">
          ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}
        </button>
        ${b.level && b.level !== 'Non d√©tect√©' ? `<div style="position:absolute;bottom:8px;right:8px;padding:4px 10px;border-radius:999px;font-size:10px;font-weight:600;background:rgba(139,92,246,0.9);color:#fff;">${b.level}</div>` : ''}
      </div>
      <div style="padding:12px;">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
          <span style="font-size:18px;">${emoji}</span>
          <span style="font-size:11px;color:var(--ui-text-muted);">${(b.categories || []).join(" ‚Ä¢ ")}</span>
          ${b.verified ? '<span style="font-size:10px;color:#3b82f6;">‚úì</span>' : ''}
        </div>
        <div style="font-size:15px;font-weight:700;margin-bottom:4px;">${escapeHtml(b.name || "")}</div>
        <div style="font-size:11px;color:var(--ui-text-muted);margin-bottom:4px;">
          üìç ${escapeHtml(b.city || "")}
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;">
          <span style="color:var(--ui-text-muted);">‚≠ê ${b.rating || '‚Äî'}/5</span>
          ${(b.soundLinks && b.soundLinks.length > 0) || (b.audioLinks && b.audioLinks.length > 0) ? '<span style="color:#a78bfa;">üéµ Audio</span>' : '<span style="color:#ef4444;">‚ö†Ô∏è Pas d\'audio</span>'}
        </div>
      </div>
    </div>
  `;
}

function buildServiceCard(s, distance = null) {
  const imgTag = buildMainImageTag(s, s.name || "");
  const borderColor = getBoostColor(s.boost);
  const emoji = getCategoryEmoji(s);
  const isLiked = currentUser.likes.includes(`service:${s.id}`);
  
  // Badge distance (afficher seulement si distance valide)
  const distanceBadge = (distance !== null && distance !== undefined && isFinite(distance) && distance !== Infinity) ? `
    <div style="position:absolute;top:8px;left:8px;padding:4px 8px;border-radius:999px;font-size:10px;font-weight:600;background:rgba(0,0,0,0.7);color:#fff;backdrop-filter:blur(4px);z-index:5;">
      üìç ${distance < 1 ? Math.round(distance * 1000) + 'm' : distance.toFixed(1) + 'km'}
    </div>
  ` : '';

  return `
    <div data-type="service" data-id="${s.id}" class="event-card" onclick="openPopupFromList('service', ${s.id})" style="
      border:3px solid ${borderColor};
      border-radius:16px;
      background:var(--ui-card-bg);
      overflow:hidden;
      cursor:pointer;
      transition:all 0.2s ease;
      box-shadow:0 4px 20px rgba(0,0,0,0.2);
      position:relative;
    ">
      <div style="position:relative;height:160px;overflow:hidden;">
        ${imgTag}
        ${distanceBadge}
        <button onclick="event.stopPropagation();onAction('like','service',${s.id})" style="position:absolute;top:8px;${distanceBadge ? 'left:50px;' : 'left:8px;'}width:32px;height:32px;border-radius:50%;border:none;background:rgba(0,0,0,0.5);color:${isLiked ? '#ef4444' : '#fff'};cursor:pointer;font-size:16px;z-index:7;">
          ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}
        </button>
      </div>
      <div style="padding:12px;">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
          <span style="font-size:18px;">${emoji}</span>
          <span style="font-size:11px;color:var(--ui-text-muted);">${(s.categories || []).join(" ‚Ä¢ ")}</span>
          ${s.verified ? '<span style="font-size:10px;color:#3b82f6;">‚úì</span>' : ''}
        </div>
        <div style="font-size:15px;font-weight:700;margin-bottom:4px;">${escapeHtml(s.name || "")}</div>
        <div style="font-size:11px;color:var(--ui-text-muted);margin-bottom:4px;">
          üìç ${escapeHtml(s.city || "")}, Suisse
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;">
          <span style="color:var(--ui-text-muted);">‚≠ê ${s.rating || '‚Äî'}/5</span>
          <span style="color:var(--ui-text-muted);">‚ù§Ô∏è ${s.likes || 0}</span>
        </div>
      </div>
    </div>
  `;
}

function openPopupFromList(type, id) {
  const item = getItemById(type, id);
  if (!item) {
    showNotification("‚ö†Ô∏è Item introuvable", "error");
    return;
  }
  
  // Pr√©server l'audio en cours - ne couper le son que quand on clique sur un autre play
  let persistentContainer = document.getElementById("audio-persistent-container");
  if (!persistentContainer) {
    persistentContainer = document.createElement("div");
    persistentContainer.id = "audio-persistent-container";
    persistentContainer.style.cssText = "position:fixed;bottom:70px;left:10px;width:1px;height:1px;overflow:hidden;pointer-events:none;opacity:0.01;z-index:99998;";
    document.body.insertBefore(persistentContainer, document.body.firstChild);
  }
  let backdrop = document.getElementById("popup-modal-backdrop");
  const scope = backdrop || document;
  Array.from(scope.querySelectorAll('audio[id^="booking-audio-"], audio[id^="event-audio-"]')).forEach(a => {
    if (!a.paused && a.readyState >= 2) {
      try { persistentContainer.appendChild(a); } catch (_) {}
    }
  });
  
  // Construire le HTML de la popup
  let popupHtml = "";
  if (type === "event") {
    popupHtml = buildEventPopup(item);
  } else if (type === "booking") {
    popupHtml = buildBookingPopup(item);
  } else if (type === "service") {
    popupHtml = buildServicePopup(item);
  }
  
  // Afficher dans une modal avec overlay - EN MODE LISTE, m√™me taille que sur la map (380px exactement)
  // La popup doit √™tre exactement la m√™me que sur la map, avec toutes les actions
  // IMPORTANT: La bordure doit s'aligner PARFAITEMENT avec l'image - PAS DE PADDING, PAS DE MARGIN
  const modalHtml = `
    <div style="position:relative;width:380px;max-height:85vh;overflow:hidden;background:var(--ui-card-bg);border-radius:16px;border:1px solid var(--ui-card-border);margin:20px;box-shadow:0 20px 60px rgba(0,0,0,0.5);display:flex;flex-direction:column;padding:0;box-sizing:border-box;">
      <button onclick="closePopupModal()" style="position:absolute;top:12px;right:12px;width:36px;height:36px;border-radius:50%;border:none;background:rgba(0,0,0,0.6);color:#fff;cursor:pointer;font-size:20px;z-index:1001;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.8)'" onmouseout="this.style.background='rgba(0,0,0,0.6)'">‚úï</button>
      <div style="flex:1;overflow-y:auto;scrollbar-width:none;width:100%;margin:0;padding:0;box-sizing:border-box;">
        ${popupHtml}
      </div>
    </div>
  `;
  
  // Cr√©er ou r√©utiliser le backdrop - EN MODE LISTE, devant la liste (z-index √©lev√©)
  if (!backdrop) {
    backdrop = document.createElement("div");
    backdrop.id = "popup-modal-backdrop";
    // z-index tr√®s √©lev√© pour √™tre devant la liste (qui est √† z-index normal)
    backdrop.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(2px);padding-top:40px;padding-bottom:40px;box-sizing:border-box;";
    backdrop.onclick = (e) => {
      if (e.target === backdrop) closePopupModal();
    };
    document.body.appendChild(backdrop);
  }
  
  backdrop.innerHTML = modalHtml;
  backdrop.style.display = "flex";
  
  // Marquer qu'on est en mode liste pour le retour
  backdrop.dataset.fromList = "true";
  
  // Centrer la map sur l'item si possible
  if (map && item.lat && item.lng) {
    map.setView([item.lat, item.lng], Math.max(map.getZoom(), 13));
  }
}

function closePopupModal() {
  if (window._popupBottomSheetCleanup) {
    window._popupBottomSheetCleanup();
    window._popupBottomSheetCleanup = null;
  }
  // R√©initialiser la navigation par emplacement
  currentLocationGroup = null;
  currentLocationIndex = 0;
  document.body.style.overflow = '';
  const modal = document.getElementById("popup-modal");
  if (modal) {
    modal.remove();
  }
  const backdrop = document.getElementById("popup-modal-backdrop");
  if (backdrop) {
    backdrop.style.display = "none";
    // Si on √©tait en mode liste, s'assurer que la liste reste ouverte
    if (backdrop.dataset.fromList === "true" && listViewOpen) {
      // La liste reste ouverte automatiquement car listViewOpen est toujours true
      backdrop.dataset.fromList = "false";
    }
  }
  
  // Recentrer la map sur le marqueur qu'on venait de consulter
  if (currentPopupMarker && map) {
    try {
      const latlng = currentPopupMarker.getLatLng();
      // Zoomer assez proche pour voir le point imm√©diatement
      map.setView(latlng, Math.max(map.getZoom(), 16), { animate: true, duration: 0.3 });
    } catch(e) {
      console.warn('Erreur recentrage map:', e);
    }
    currentPopupMarker = null;
  }
  
  // R√©activer COMPL√àTEMENT les √©v√©nements Leaflet
  if (map) {
    try {
      map.scrollWheelZoom.enable();
      map.dragging.enable();
      map.touchZoom.enable();
      map.doubleClickZoom.enable();
      // R√©activer les √©v√©nements au niveau du conteneur de la map
      const mapContainer = map.getContainer();
      if (mapContainer) {
        mapContainer.style.pointerEvents = 'auto';
      }
    } catch(e) {
      console.warn('Erreur r√©activation Leaflet:', e);
    }
  }
}

// Variable pour stocker la recherche de ville
let listSearchCity = "";

// S√©lectionner une ville pour le tri par distance
function selectCityForSorting(cityName) {
  if (!cityName || cityName === "") {
    selectedCityForSorting = null;
    listSearchCity = "";
  } else {
    const allCities = [...SWISS_CITIES, ...FRENCH_CITIES];
    selectedCityForSorting = allCities.find(c => c.name === cityName) || null;
    if (selectedCityForSorting) {
      listSearchCity = selectedCityForSorting.name;
    }
  }
  
  // Rafra√Æchir la liste avec le nouveau tri
  if (listViewOpen) {
    refreshListView();
  }
  
  // Rafra√Æchir aussi les marqueurs sur la map
  refreshMarkers();
}

// Recherche de ville avec autocompl√©tion - MONDIALE via Nominatim API
let searchTimeout = null;

function onCitySearchInput(value) {
  listSearchCity = value;
  
  const suggestionsDiv = document.getElementById("city-suggestions");
  if (!suggestionsDiv) return;
  
  if (!value || value.length < 2) {
    suggestionsDiv.style.display = "none";
    if (!value) {
      selectedCityForSorting = null;
      refreshListView();
    }
    return;
  }
  
  // Annuler la recherche pr√©c√©dente
  if (searchTimeout) clearTimeout(searchTimeout);
  
  // Afficher un loading
  suggestionsDiv.innerHTML = `
    <div style="padding:16px;text-align:center;color:var(--ui-text-muted);">
      <span style="animation:pulse-subtle 1s infinite;">üîç Recherche...</span>
    </div>
  `;
  suggestionsDiv.style.display = "block";
  
  // Attendre 300ms avant de lancer la recherche (debounce)
  searchTimeout = setTimeout(() => {
    searchCityGlobal(value);
  }, 300);
}

// Recherche mondiale via Nominatim (OpenStreetMap)
async function searchCityGlobal(query) {
  const suggestionsDiv = document.getElementById("city-suggestions");
  if (!suggestionsDiv) return;
  
  // D'abord chercher dans les villes locales (Suisse/France) - tri√©es par pertinence
  const allLocalCities = [...SWISS_CITIES, ...FRENCH_CITIES];
  const searchLower = query.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  const localMatches = allLocalCities
    .filter(city => {
      const n = city.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      const r = (city.region || "").toLowerCase();
      return n.includes(searchLower) || r.includes(searchLower);
    })
    .sort((a, b) => {
      const na = a.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      const nb = b.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      // Match exact en premier
      if (na === searchLower && nb !== searchLower) return -1;
      if (nb === searchLower && na !== searchLower) return 1;
      // Puis startsWith
      if (na.startsWith(searchLower) && !nb.startsWith(searchLower)) return -1;
      if (nb.startsWith(searchLower) && !na.startsWith(searchLower)) return 1;
      return na.localeCompare(nb);
    })
    .slice(0, 5);
  
  // Ensuite chercher via API Nominatim pour le reste du monde
  let globalMatches = [];
  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=8&addressdetails=1&featuretype=city`,
      { headers: { 'Accept-Language': 'fr' } }
    );
    const results = await response.json();
    
    globalMatches = results
      .filter(r => r.type === 'city' || r.type === 'town' || r.type === 'village' || r.class === 'place')
      .map(r => ({
        name: r.address?.city || r.address?.town || r.address?.village || r.name,
        lat: parseFloat(r.lat),
        lng: parseFloat(r.lon),
        region: r.address?.state || r.address?.county || '',
        country: r.address?.country || '',
        countryCode: r.address?.country_code?.toUpperCase() || ''
      }))
      .filter(c => c.name); // Filtrer les r√©sultats sans nom
  } catch (error) {
    console.warn('Erreur recherche Nominatim:', error);
  }
  
  // Combiner les r√©sultats (locaux en premier)
  // Marquer les villes locales pour les distinguer
  const localMatchesMarked = localMatches.map(c => ({ ...c, isLocal: true, country: c.country || 'Suisse', countryCode: c.countryCode || 'CH' }));
  const globalMatchesMarked = globalMatches.map(c => ({ ...c, isLocal: false }));
  const allMatches = [...localMatchesMarked, ...globalMatchesMarked].slice(0, 10);
  
  if (allMatches.length === 0) {
    suggestionsDiv.innerHTML = `
      <div style="padding:16px;color:var(--ui-text-muted);text-align:center;">
        <div style="font-size:24px;margin-bottom:8px;">üåç</div>
        <div style="font-size:13px;">Aucune ville trouv√©e pour "<strong>${escapeHtml(query)}</strong>"</div>
        <div style="font-size:11px;margin-top:4px;">Essayez un autre nom ou une orthographe diff√©rente</div>
      </div>
    `;
    suggestionsDiv.style.display = "block";
    return;
  }
  
  // Afficher les suggestions avec pays/r√©gion bien visible
  suggestionsDiv.innerHTML = allMatches.map((city, index) => {
    const locationText = city.isLocal 
      ? `${city.region || city.canton || ''}${city.region && city.canton ? ' (' + city.canton + ')' : city.canton ? ' (' + city.canton + ')' : ''}, ${city.country || 'Suisse'}`
      : `${city.region ? escapeHtml(city.region) + ', ' : ''}${escapeHtml(city.country || '')}`;
    
    return `
    <div onclick="selectCityFromSearch(${index})" 
         data-city-index="${index}"
         style="padding:14px 16px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all 0.15s;border-bottom:1px solid var(--ui-card-border);"
         onmouseover="this.style.background='rgba(0,255,195,0.15)';this.style.borderLeft='3px solid #00ffc3'"
         onmouseout="this.style.background='transparent';this.style.borderLeft='none'">
      <span style="font-size:20px;">üìç</span>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:700;color:var(--ui-text-main);font-size:15px;margin-bottom:4px;">${escapeHtml(city.name)}</div>
        <div style="font-size:12px;color:var(--ui-text-muted);display:flex;align-items:center;gap:6px;">
          <span>${locationText}</span>
          ${city.isLocal ? '<span style="padding:2px 6px;background:rgba(0,255,195,0.2);border-radius:4px;font-size:10px;color:#00ffc3;">Local</span>' : ''}
        </div>
      </div>
      <span style="font-size:20px;flex-shrink:0;">${getFlagEmoji(city.countryCode || (city.isLocal ? 'CH' : ''))}</span>
    </div>
  `;
  }).join('');
  
  // Stocker les r√©sultats pour la s√©lection
  window._citySearchResults = allMatches;
  suggestionsDiv.style.display = "block";
}

// Obtenir le drapeau emoji d'un pays
function getFlagEmoji(countryCode) {
  if (!countryCode || countryCode.length !== 2) return 'üåç';
  const codePoints = countryCode
    .toUpperCase()
    .split('')
    .map(char => 127397 + char.charCodeAt(0));
  return String.fromCodePoint(...codePoints);
}

window.getFlagEmoji = getFlagEmoji;

// S√©lectionner une ville depuis les r√©sultats de recherche
function selectCityFromSearch(index) {
  const city = window._citySearchResults?.[index];
  if (!city) {
    console.warn('Aucune ville trouv√©e √† l\'index', index);
    return;
  }
  
  // Construire le nom complet avec pays/r√©gion pour l'affichage
  const fullName = city.isLocal 
    ? `${city.name}, ${city.region || city.canton || ''}, ${city.country || 'Suisse'}`
    : `${city.name}, ${city.region ? city.region + ', ' : ''}${city.country || ''}`;
  
  // V√©rifier que la ville a bien des coordonn√©es
  if (!city.lat || !city.lng || isNaN(city.lat) || isNaN(city.lng)) {
    console.error(`‚ùå ERREUR: La ville "${city.name}" n'a pas de coordonn√©es valides!`, city);
    showNotification(`‚ùå Erreur: Coordonn√©es manquantes pour ${city.name}`, 'error');
    return;
  }
  
  // Stocker la ville s√©lectionn√©e avec toutes ses infos
  selectedCityForSorting = {
    name: city.name,
    lat: parseFloat(city.lat),
    lng: parseFloat(city.lng),
    region: city.region || city.canton || '',
    country: city.country || (city.isLocal ? 'Suisse' : ''),
    countryCode: city.countryCode || (city.isLocal ? 'CH' : ''),
    fullName: fullName
  };
  
  // V√©rifier que les coordonn√©es sont valides apr√®s conversion
  if (isNaN(selectedCityForSorting.lat) || isNaN(selectedCityForSorting.lng)) {
    console.error(`‚ùå ERREUR: Coordonn√©es invalides apr√®s conversion!`, selectedCityForSorting);
    showNotification(`‚ùå Erreur: Coordonn√©es invalides pour ${city.name}`, 'error');
    return;
  }
  
  // Mettre √† jour le texte de recherche avec le nom complet
  listSearchCity = fullName;
  
  // Cacher les suggestions
  const suggestionsDiv = document.getElementById("city-suggestions");
  if (suggestionsDiv) suggestionsDiv.style.display = "none";
  
  // Mettre √† jour l'input avec le nom complet
  const input = document.getElementById("city-search-input");
  if (input) input.value = fullName;
  
  console.log(`‚úÖ Ville s√©lectionn√©e pour tri: ${city.name}`);
  console.log(`   Coordonn√©es: lat=${selectedCityForSorting.lat}, lng=${selectedCityForSorting.lng}`);
  console.log(`   Objet complet:`, selectedCityForSorting);
  
  console.log(`‚úÖ Ville s√©lectionn√©e pour tri: ${city.name}`);
  console.log(`   Coordonn√©es: lat=${selectedCityForSorting.lat}, lng=${selectedCityForSorting.lng}`);
  console.log(`   Objet complet:`, selectedCityForSorting);
  console.log(`   listViewOpen: ${listViewOpen}`);
  
  // FORCER le rafra√Æchissement de la liste avec le nouveau tri (m√™me si la liste n'est pas encore ouverte)
  // La liste sera tri√©e correctement quand elle s'ouvrira
  if (listViewOpen) {
    console.log(`üîÑ Rafra√Æchissement de la liste avec tri par distance...`);
    refreshListView();
  } else {
    console.log(`‚ÑπÔ∏è Liste non ouverte, le tri sera appliqu√© √† l'ouverture`);
  }
  
  // Rafra√Æchir aussi les marqueurs sur la map
  refreshMarkers();
  
  // Centrer la map sur la ville s√©lectionn√©e
  if (map && selectedCityForSorting.lat && selectedCityForSorting.lng) {
    map.setView([selectedCityForSorting.lat, selectedCityForSorting.lng], 10);
    showNotification(`üìç Tri par proximit√©: ${city.name}`, 'success');
  }
}

window.selectCityFromSearch = selectCityFromSearch;

window.searchCityGlobal = searchCityGlobal;
window.selectCityFromSearch = selectCityFromSearch;

function selectCityFromSuggestion(cityName) {
  const allCities = [...SWISS_CITIES, ...FRENCH_CITIES];
  const city = allCities.find(c => c.name === cityName);
  
  if (city) {
    selectedCityForSorting = city;
    listSearchCity = city.name;
    
    // Cacher les suggestions
    const suggestionsDiv = document.getElementById("city-suggestions");
    if (suggestionsDiv) suggestionsDiv.style.display = "none";
    
    // Mettre √† jour l'input
    const input = document.getElementById("city-search-input");
    if (input) input.value = city.name;
    
    // Rafra√Æchir la liste
    refreshListView();
  }
}

function showCitySuggestions() {
  const input = document.getElementById("city-search-input");
  if (input && input.value.length >= 2) {
    onCitySearchInput(input.value);
  }
}

function hideCitySuggestions() {
  const suggestionsDiv = document.getElementById("city-suggestions");
  if (suggestionsDiv) {
    setTimeout(() => { suggestionsDiv.style.display = "none"; }, 200);
  }
}

function clearCitySearch() {
  listSearchCity = "";
  selectedCityForSorting = null;
  
  const input = document.getElementById("city-search-input");
  if (input) input.value = "";
  
  const suggestionsDiv = document.getElementById("city-suggestions");
  if (suggestionsDiv) suggestionsDiv.style.display = "none";
  
  refreshListView();
}

// Exposer les nouvelles fonctions
window.onCitySearchInput = onCitySearchInput;
window.selectCityFromSuggestion = selectCityFromSuggestion;
window.showCitySuggestions = showCitySuggestions;
window.hideCitySuggestions = hideCitySuggestions;
window.clearCitySearch = clearCitySearch;

// ============================================
// FILTRE EXPLORATEUR "LEADER ONE" ‚Äì MULTI-COLONNES + DATES
// ============================================
let explorerOpen = false;
let explorerPath = [];
let selectedCategories = [];
let explorerTree = null;

// filtres dates (mode event)
let timeFilter = null; // null | 'range' (les boutons rapides ajoutent maintenant √† selectedDates)
let dateRangeStart = null;
let dateRangeEnd = null;
let selectedDates = []; // Pour cumuler : ['today', 'tomorrow', 'weekend', etc.]

// surcharge toggleLeftPanel
function toggleLeftPanel() {
  explorerOpen = !explorerOpen;
  const panel = document.getElementById("left-panel");
  if (!explorerOpen) {
    panel.style.display = "none";
    return;
  }
  // Ouvrir le panneau et charger l'arbre correspondant au mode actuel
  panel.style.display = "block";
  console.log(`üîç Ouverture du filtre pour le mode: ${currentMode}`);
  loadExplorerTree(); // Charge automatiquement le bon arbre selon currentMode
}

// charger l'arbre depuis /trees/*.json
function loadExplorerTree() {
  let file = "";
  if (currentMode === "event") file = "trees/events_tree.json";
  if (currentMode === "booking") file = "trees/booking_tree.json";
  if (currentMode === "service") file = "trees/service_tree.json";

  console.log(`üîç Chargement de l'arbre depuis : ${file}`);
  fetch(file)
    .then(r => {
      console.log(`üì° R√©ponse fetch : ${r.status} ${r.statusText} pour ${file}`);
      if (!r.ok) {
        throw new Error(`HTTP ${r.status} - ${r.statusText}`);
      }
      return r.json();
    })
    .then(json => {
      console.log(`‚úÖ Arbre charg√© avec succ√®s :`, Object.keys(json));
      // Normaliser la structure selon le mode
      if (json.Events) {
        // events_tree.json : { "Events": { "Music": {...}, ... } }
        explorerTree = json.Events;
      } else if (json.categories && json.categories.children) {
        // booking_tree.json / service_tree.json : { "categories": { "name": "...", "children": [...] } }
        // Convertir en structure compatible { "NomCategorie": {...}, ... }
        explorerTree = normalizeTreeFromChildren(json.categories.children);
      } else if (json.categories) {
        explorerTree = json.categories;
      } else {
        explorerTree = json;
      }

      explorerPath = [];
      buildCategoryMappingFromTree(explorerTree);
      renderExplorer();
      renderCategoryChips();
    })
    .catch(err => {
      console.error("‚ùå Erreur chargement arbre :", err);
      console.error("   Fichier tent√© :", file);
      const panel = document.getElementById("left-panel");
      panel.innerHTML = `
        <div style='padding:20px;font-size:13px;color:#f87171;text-align:center;'>
          <div style='font-size:48px;margin-bottom:12px;'>‚ö†Ô∏è</div>
          <div style='font-weight:600;margin-bottom:8px;'>Impossible de charger les cat√©gories</div>
          <div style='font-size:11px;color:var(--ui-text-muted);margin-bottom:12px;'>
            Fichier : ${file}<br>
            Erreur : ${err.message}
          </div>
          <button onclick="loadExplorerTree()" style='padding:8px 16px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:12px;'>
            üîÑ R√©essayer
          </button>
        </div>
      `;
    });
}

// Convertit un tableau de { name, children } en objet { name: children_ou_liste }
function normalizeTreeFromChildren(children) {
  if (!Array.isArray(children)) return children;
  
  const result = {};
  children.forEach(item => {
    if (typeof item === "string") {
      // C'est une feuille
      return;
    }
    if (item.name) {
      if (item.children && item.children.length > 0) {
        // V√©rifier si les enfants sont des objets ou des strings
        const firstChild = item.children[0];
        if (typeof firstChild === "string" || (firstChild && !firstChild.children)) {
          // Les enfants sont des feuilles (strings ou objets sans children)
          result[item.name] = item.children.map(c => typeof c === "string" ? c : c.name);
        } else {
          // Les enfants ont eux-m√™mes des enfants
          result[item.name] = normalizeTreeFromChildren(item.children);
        }
      } else {
        // Pas d'enfants, c'est une cat√©gorie finale
        result[item.name] = [];
      }
    }
  });
  return result;
}

function renderExplorer() {
  const panel = document.getElementById("left-panel");
  panel.style.width = "480px";
  panel.style.maxHeight = "calc(100vh - 100px)";
  panel.style.overflow = "hidden";
  panel.style.display = "block";

  const dateControls =
    currentMode === "event"
      ? `
      <div style="margin-bottom:10px;font-size:11px;color:var(--ui-text-muted);">
        üìÖ Filtrer par date (cumulable) :
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;">
        <label class="date-checkbox-label ${selectedDates.includes('today') ? 'active' : ''}">
          <input type="checkbox" ${selectedDates.includes('today') ? 'checked' : ''} onchange="toggleDateFilter('today')">
          Aujourd'hui
        </label>
        <label class="date-checkbox-label ${selectedDates.includes('tomorrow') ? 'active' : ''}">
          <input type="checkbox" ${selectedDates.includes('tomorrow') ? 'checked' : ''} onchange="toggleDateFilter('tomorrow')">
          Demain
        </label>
        <label class="date-checkbox-label ${selectedDates.includes('weekend') ? 'active' : ''}">
          <input type="checkbox" ${selectedDates.includes('weekend') ? 'checked' : ''} onchange="toggleDateFilter('weekend')">
          Ce week-end
        </label>
        <label class="date-checkbox-label ${selectedDates.includes('week') ? 'active' : ''}">
          <input type="checkbox" ${selectedDates.includes('week') ? 'checked' : ''} onchange="toggleDateFilter('week')">
          Cette semaine
        </label>
        <label class="date-checkbox-label ${selectedDates.includes('month') ? 'active' : ''}">
          <input type="checkbox" ${selectedDates.includes('month') ? 'checked' : ''} onchange="toggleDateFilter('month')">
          Ce mois
        </label>
      </div>
      
      <div style="margin-bottom:12px;padding:10px;background:rgba(0,255,195,0.03);border-radius:10px;">
        <div style="font-size:11px;color:var(--ui-text-muted);margin-bottom:8px;">üìÜ Ou s√©lectionner une p√©riode :</div>
        <div style="display:flex;gap:10px;align-items:center;">
          <div style="flex:1;">
            <label style="font-size:10px;color:var(--ui-text-muted);">Du</label>
            <input type="date" id="date-range-start" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:12px;cursor:pointer;">
          </div>
          <div style="color:var(--ui-text-muted);font-size:16px;">‚Üí</div>
          <div style="flex:1;">
            <label style="font-size:10px;color:var(--ui-text-muted);">Au</label>
            <input type="date" id="date-range-end" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:12px;cursor:pointer;">
          </div>
        </div>
        <div id="date-range-display" style="font-size:11px;color:#00ffc3;text-align:center;min-height:16px;margin-top:6px;"></div>
      </div>
    `
      : "";

  panel.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <div style="font-size:15px;font-weight:700;">Filtrer ‚Äì ${currentMode}</div>
      <button onclick="closeLeftPanel()" style="background:none;border:none;color:var(--ui-text-muted);font-size:20px;cursor:pointer;padding:4px 8px;border-radius:6px;transition:all 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.1)';this.style.color='#fff'" onmouseout="this.style.background='none';this.style.color='var(--ui-text-muted)'">‚úï</button>
    </div>
    <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:10px;">Choisissez les cat√©gories √† filtrer. Le filtre affiche uniquement les events correspondant √† ces cat√©gories.</div>

    ${dateControls}

    <div id="explorer-selected" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;"></div>

    <div id="explorer-columns"
      style="
        display:flex;
        gap:12px;
        overflow-x:auto;
        padding-bottom:6px;
        margin-bottom:8px;
        max-height:300px;
      ">
    </div>

    <button onclick="resetExplorerFilter()" class="pill small" style="margin-top:6px;">
      üîÑ R√©initialiser tout
    </button>
  `;

  renderSelectedTags();
  buildExplorerColumns();

  if (currentMode === "event") {
    setupDateRangePicker();
  }
}

// Fermer le panneau filtre
function closeLeftPanel() {
  explorerOpen = false;
  const panel = document.getElementById("left-panel");
  if (panel) panel.style.display = "none";
}

// Toggle un filtre de date (cumulable)
function toggleDateFilter(dateType) {
  if (selectedDates.includes(dateType)) {
    selectedDates = selectedDates.filter(d => d !== dateType);
        } else {
    selectedDates.push(dateType);
  }
  // Rafra√Æchir l'affichage des checkboxes
  renderExplorer();
  applyExplorerFilter();
}

// Gestion du s√©lecteur de plage de dates
function setupDateRangePicker() {
  const startInput = document.getElementById("date-range-start");
  const endInput = document.getElementById("date-range-end");
  const display = document.getElementById("date-range-display");
  
  if (!startInput || !endInput) return;
  
  // Initialiser avec les valeurs existantes
  if (dateRangeStart) startInput.value = dateRangeStart;
  if (dateRangeEnd) endInput.value = dateRangeEnd;
  
  updateDateRangeDisplay();
  
  startInput.addEventListener("change", () => {
    dateRangeStart = startInput.value || null;
    // Si pas de date de fin, mettre la m√™me que le d√©but
    if (dateRangeStart && !dateRangeEnd) {
      dateRangeEnd = dateRangeStart;
      endInput.value = dateRangeEnd;
    }
    // Si date d√©but > date fin, ajuster
    if (dateRangeStart && dateRangeEnd && dateRangeStart > dateRangeEnd) {
      dateRangeEnd = dateRangeStart;
      endInput.value = dateRangeEnd;
    }
    timeFilter = (dateRangeStart || dateRangeEnd) ? "range" : null;
    updateDateRangeDisplay();
        applyExplorerFilter();
      });
  
  endInput.addEventListener("change", () => {
    dateRangeEnd = endInput.value || null;
    // Si pas de date de d√©but, mettre la m√™me que la fin
    if (dateRangeEnd && !dateRangeStart) {
      dateRangeStart = dateRangeEnd;
      startInput.value = dateRangeStart;
    }
    // Si date fin < date d√©but, ajuster
    if (dateRangeStart && dateRangeEnd && dateRangeEnd < dateRangeStart) {
      dateRangeStart = dateRangeEnd;
      startInput.value = dateRangeStart;
    }
    timeFilter = (dateRangeStart || dateRangeEnd) ? "range" : null;
    updateDateRangeDisplay();
    applyExplorerFilter();
  });
}

function updateDateRangeDisplay() {
  const display = document.getElementById("date-range-display");
  if (!display) return;
  
  if (dateRangeStart && dateRangeEnd) {
    const start = new Date(dateRangeStart);
    const end = new Date(dateRangeEnd);
    const days = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
    
    const formatDate = (d) => d.toLocaleDateString("fr-CH", { day: "2-digit", month: "short" });
    
    if (dateRangeStart === dateRangeEnd) {
      display.textContent = `üìç ${formatDate(start)} (1 jour)`;
    } else {
      display.textContent = `üìç ${formatDate(start)} ‚Üí ${formatDate(end)} (${days} jours)`;
    }
  } else {
    display.textContent = "";
  }
}

function renderSelectedTags() {
  const box = document.getElementById("explorer-selected");
  if (!box) return;
  box.innerHTML = selectedCategories.length > 0 ? `<span style="font-size:11px;color:var(--ui-text-muted);align-self:center;margin-right:6px;">${selectedCategories.length}</span>` : "";

  selectedCategories.forEach(cat => {
    const safe = escapeHtml(cat);
    box.innerHTML += `
      <div style="
        background:#00ffc3;
        color:#000;
        padding:4px 10px;
        border-radius:999px;
        font-size:12px;
        display:flex;
        align-items:center;
        gap:6px;
      ">
        ${safe}
        <span style="cursor:pointer;font-weight:700;" onclick="removeSelectedCategory('${safe}')">√ó</span>
      </div>
    `;
  });
}

function removeSelectedCategory(cat) {
  selectedCategories = selectedCategories.filter(c => c !== cat);
  
  // Synchroniser avec les checkboxes dans l'explorateur
  renderExplorer(); // Re-render pour d√©cocher les cases
  renderSelectedTags(); // Mettre √† jour les tags
  
  applyExplorerFilter();
  renderCategoryChips();
}

function resetExplorerFilter() {
  selectedCategories = [];
  explorerPath = [];
  timeFilter = null;
  dateRangeStart = null;
  dateRangeEnd = null;
  selectedDates = [];
  filteredData = null; // null = afficher TOUS les points
  renderExplorer();
  renderCategoryChips();
  // IMPORTANT : refreshMarkers et refreshListView utilisent getActiveData() qui retourne filteredData || getCurrentData()
  // Donc si filteredData est null, tous les points sont affich√©s
  refreshMarkers();
  refreshListView();
  showNotification("üîÑ Filtres r√©initialis√©s - Tous les points affich√©s", "info");
}

function buildExplorerColumns() {
  const colBox = document.getElementById("explorer-columns");
  if (!colBox || !explorerTree) return;
  colBox.innerHTML = "";

  let node = explorerTree;
  buildColumn(colBox, node, 0);

  explorerPath.forEach((step, i) => {
    node = findNode(node, step);
    if (node) buildColumn(colBox, node, i + 1);
  });
}

function findNode(obj, name) {
  if (!obj) return null;
  if (Array.isArray(obj)) return null;

  for (const key in obj) {
    if (key === name) return obj[key];
  }
  return null;
}

function buildColumn(colBox, node, level) {
  const isMob = window.innerWidth <= 768;
  const div = document.createElement("div");
  div.style.minWidth = "200px";
  div.style.maxWidth = "200px";
  div.style.background = "rgba(2,6,23,0.85)";
  div.style.border = "1px solid rgba(0,255,195,0.25)";
  div.style.borderRadius = "10px";
  div.style.padding = "8px";
  div.style.color = "var(--ui-text-main)";
  div.style.fontSize = isMob ? "14px" : "13px";
  div.style.maxHeight = "280px";
  div.style.overflowY = "auto";

  let html = "";

  if (Array.isArray(node)) {
    // Feuilles (cat√©gories finales)
    node.forEach(item => {
      const safe = escapeHtml(item);
      const isChecked = selectedCategories.includes(item);
      html += `
        <label style="display:flex;align-items:center;gap:8px;padding:${isMob ? '7px' : '6px'};cursor:pointer;border-radius:6px;transition:background 0.15s;"
             onmouseover="this.style.background='rgba(0,255,195,0.12)'"
               onmouseout="this.style.background='transparent'"
               onclick="event.stopPropagation()">
          <input type="checkbox" 
                 ${isChecked ? 'checked' : ''} 
                 onchange="toggleCategory('${safe}', event); event.stopPropagation();"
                 onclick="event.stopPropagation()"
                 style="width:${isMob ? '18' : '16'}px;height:${isMob ? '18' : '16'}px;accent-color:#00ffc3;cursor:pointer;">
          <span style="flex:1;font-size:${isMob ? '14' : '12'}px;">${safe}</span>
        </label>
      `;
    });
  } else {
    // Dossiers (cat√©gories avec sous-cat√©gories)
    for (const key in node) {
      const safeKey = escapeHtml(key);
      const isChecked = selectedCategories.includes(key);
      const hasChildren = node[key] && (Array.isArray(node[key]) ? node[key].length > 0 : Object.keys(node[key]).length > 0);
      
      html += `
        <div style="display:flex;align-items:center;gap:6px;padding:${isMob ? '7px' : '6px'};border-radius:6px;transition:background 0.15s;"
             onmouseover="this.style.background='rgba(0,255,195,0.12)'"
             onmouseout="this.style.background='transparent'"
             onclick="event.stopPropagation()">
          <input type="checkbox" 
                 ${isChecked ? 'checked' : ''} 
                 onchange="toggleCategory('${safeKey}', event); event.stopPropagation();"
                 onclick="event.stopPropagation()"
                 style="width:${isMob ? '18' : '16'}px;height:${isMob ? '18' : '16'}px;accent-color:#00ffc3;cursor:pointer;">
          <div style="flex:1;display:flex;align-items:center;justify-content:space-between;cursor:pointer;"
             onclick="openNextLevel('${safeKey}', ${level})">
            <span style="font-size:${isMob ? '14' : '12'}px;font-weight:500;">üìÅ ${safeKey}</span>
            ${hasChildren ? '<span style="color:#00ffc3;font-size:14px;">‚Ä∫</span>' : ''}
          </div>
        </div>
      `;
    }
  }

  div.innerHTML = html;
  colBox.appendChild(div);
}

// Chips cat√©gories scrollables (mobile)
function renderCategoryChips() {
  const container = document.getElementById("category-chips-inner");
  if (!container) return;
  const topCats = explorerTree ? Object.keys(explorerTree) : [];
  if (topCats.length === 0) return;
  const emoji = (c) => c.includes("Musique") || c.includes("Music") ? "üéµ" : c.includes("Sport") ? "‚öΩ" : c.includes("Culture") ? "üé≠" : c.includes("DJ") ? "üéß" : c.includes("Live") ? "üé§" : "üìå";
  container.innerHTML = topCats.map(cat => {
    const isActive = selectedCategories.includes(cat);
    return `<button type="button" class="category-chip" data-cat="${cat.replace(/"/g, '&quot;')}" onclick="event.stopPropagation();toggleCategory('${cat.replace(/'/g, "\\'")}', event);renderCategoryChips();if(navigator.vibrate)navigator.vibrate(10);" style="flex-shrink:0;padding:6px 14px;border-radius:999px;border:1.5px solid ${isActive ? '#22c55e' : 'rgba(148,163,184,0.25)'};background:${isActive ? 'rgba(34,197,94,0.2)' : 'rgba(255,255,255,0.06)'};color:${isActive ? '#22c55e' : '#cbd5e1'};font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;scroll-snap-align:start;transition:all .2s;">${emoji(cat)} ${cat}</button>`;
  }).join("");
}
window.renderCategoryChips = renderCategoryChips;

// Toggle une cat√©gorie (cocher/d√©cocher)
function toggleCategory(cat, event) {
  console.log('[CATEGORY] toggleCategory appel√© avec:', cat);
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è EMP√äCHER la propagation pour ne pas fermer le modal
  if (event) {
    event.stopPropagation();
    event.stopImmediatePropagation();
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Si le modal Publier est ouvert, remplir le champ cat√©gorie au lieu de filtrer
  const publishModal = document.getElementById("publish-modal-backdrop");
  const categoryInput = document.getElementById("pub-main-category");
  
  console.log('[CATEGORY] publishModal:', !!publishModal);
  console.log('[CATEGORY] categoryInput:', !!categoryInput);
  
  // V√©rifier si le modal est visible (via style ou computed style)
  const styleDisplay = publishModal?.style?.display;
  const computedDisplay = publishModal ? getComputedStyle(publishModal).display : 'none';
  const attrStyle = publishModal?.getAttribute('style');
  
  console.log('[CATEGORY] styleDisplay:', styleDisplay);
  console.log('[CATEGORY] computedDisplay:', computedDisplay);
  console.log('[CATEGORY] attrStyle includes flex:', attrStyle?.includes('display: flex'));
  
  const isModalVisible = publishModal && (
    styleDisplay === "flex" || 
    computedDisplay === "flex" ||
    attrStyle?.includes('display: flex')
  );
  
  console.log('[CATEGORY] isModalVisible:', isModalVisible);
  
  if (isModalVisible && categoryInput) {
    selectCategoryForPublish(cat);
    return;
  }
  
  // Mode normal : toggle le filtre (illimit√©)
  if (selectedCategories.includes(cat)) {
    selectedCategories = selectedCategories.filter(c => c !== cat);
  } else {
    selectedCategories.push(cat);
  }
  renderSelectedTags();
  applyExplorerFilter();
  renderCategoryChips();
}

function openNextLevel(key, level) {
  explorerPath = explorerPath.slice(0, level);
  explorerPath.push(key);
  renderExplorer();
  
  // Scroll automatique vers la droite pour suivre la navigation
  setTimeout(() => {
    const colBox = document.getElementById("explorer-columns");
    if (colBox) {
      colBox.scrollTo({
        left: colBox.scrollWidth,
        behavior: 'smooth'
      });
    }
  }, 100);
}

function selectLeafCategory(cat, event) {
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è EMP√äCHER la propagation pour ne pas fermer le modal
  if (event) {
    event.stopPropagation();
    event.stopImmediatePropagation();
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Si le modal Publier est ouvert, remplir le champ cat√©gorie au lieu de filtrer
  const publishModal = document.getElementById("publish-modal-backdrop");
  const categoryInput = document.getElementById("pub-main-category");
  
  // V√©rifier si le modal est visible
  const isModalVisible = publishModal && (
    publishModal.style.display === "flex" || 
    getComputedStyle(publishModal).display === "flex" ||
    publishModal.getAttribute('style')?.includes('display: flex')
  );
  
  if (isModalVisible && categoryInput) {
    selectCategoryForPublish(cat);
    return;
  }
  
  // Mode normal
  if (!selectedCategories.includes(cat)) {
    selectedCategories.push(cat);
  }
  applyExplorerFilter();
}

function setTimeFilter(mode) {
  // Cette fonction est gard√©e pour compatibilit√© mais on utilise maintenant toggleDateFilter
  timeFilter = mode;
  applyExplorerFilter();
}

// Alias scrapers ‚Üí termes arbre (variations de nom, langues, formats utilis√©s par les scrapers)
const SCRAPER_ALIASES = {
  // Music
  "musique": "music", "electro": "electronic", "electro / dj": "electronic",
  "music > electro": "electronic", "musique > electro": "electronic", "musique > electronic": "electronic",
  "concert": "music", "spectacle musical": "music",
  "rock / pop": "rock", "jazz / blues": "jazz", "classique / baroque": "classique", "punk": "punk rock",
  "hip hop": "hip-hop", "afrobeats": "afro / afrobeats",
  "rave": "electronic", "open air": "festival musique", "soir√©e": "electronic",
  // Culture
  "art et culture": "culture", "art": "culture", "arts": "culture",
  "exposition": "expositions", "expo": "expositions",
  "conf√©rence": "conf√©rences & rencontres", "conf√©rences": "conf√©rences & rencontres",
  "visite": "visites & patrimoine", "patrimoine": "visites & patrimoine",
  "histoire": "visites & patrimoine", "visite guid√©e": "visites & patrimoine", "mus√©e": "visites & patrimoine",
  "litt√©rature": "litt√©rature & conte", "conte": "litt√©rature & conte", "lecture": "litt√©rature & conte",
  "cin√©ma": "cin√©ma & projections", "cinema": "cin√©ma & projections", "film": "cin√©ma & projections",
  // Ateliers (ex-Workshops)
  "atelier": "ateliers", "workshop": "ateliers", "workshops": "ateliers", "stage": "ateliers",
  "culture > workshops": "culture > ateliers",
  // Arts vivants
  "spectacle": "th√©√¢tre", "th√©atre": "th√©√¢tre", "theatre": "th√©√¢tre", "spectacles": "th√©√¢tre",
  "humour": "humour", "improvisation": "th√©√¢tre", "stand-up": "humour",
  "danse": "danse", "ballet": "danse classique / ballet",
  // Food
  "d√©gustation": "d√©gustations", "gastronomie": "d√©gustations",
  "vin": "d√©gustation vin", "bi√®re": "d√©gustation bi√®re",
  "food and drinks": "food & drinks", "food": "food & drinks",
  // Festivals
  "festival": "festivals & grandes f√™tes", "foire": "festivals & grandes f√™tes", "salon": "festivals & grandes f√™tes",
  // Loisirs
  "loisirs": "loisirs & animation", "animation": "loisirs & animation",
  "brocante": "d√©fil√©s & f√™tes", "march√©": "d√©fil√©s & f√™tes", "carnaval": "d√©fil√©s & f√™tes",
  "f√™te": "d√©fil√©s & f√™tes", "f√™tes": "d√©fil√©s & f√™tes",
  // Nature
  "nature": "nature & plein air", "plein air": "nature & plein air", "balade": "nature & plein air",
  "randonn√©e": "nature & plein air",
  // Famille
  "famille": "famille & enfants", "enfants": "famille & enfants", "enfant": "famille & enfants",
  // Bien-√™tre
  "yoga": "bien-√™tre", "m√©ditation": "bien-√™tre", "sophrologie": "bien-√™tre",
  "yoga & bien-√™tre": "bien-√™tre", "wellness": "bien-√™tre",
  // Business
  "networking": "business & communaut√©", "business": "business & communaut√©",
  "business & networking": "business & communaut√©",
  // √âv√©nement g√©n√©rique
  "√©v√©nement": "culture", "divers": "culture"
};

// Construit le mapping complet depuis l'arbre : chaque terme ‚Üí [lui-m√™me, parent, grand-parent, ...]
let categoryMappingCache = {};
function buildCategoryMappingFromTree(tree, parentPath = []) {
  if (!tree) return;
  const out = {};
  function walk(node, path) {
    if (!node) return;
    if (Array.isArray(node)) {
      node.forEach(item => {
        const name = (typeof item === 'string' ? item : item.name || '').toLowerCase();
        if (!name) return;
        const fullPath = [...path, name];
        if (!out[name]) out[name] = new Set();
        fullPath.forEach(p => out[name].add(p));
      });
      return;
    }
    for (const key in node) {
      const keyLower = key.toLowerCase();
      const fullPath = [...path, keyLower];
      if (!out[keyLower]) out[keyLower] = new Set();
      fullPath.forEach(p => out[keyLower].add(p));
      walk(node[key], fullPath);
    }
  }
  walk(tree, []);
  categoryMappingCache = {};
  for (const k in out) {
    categoryMappingCache[k] = Array.from(out[k]);
  }
}

// Retourne les parties de cat√©gories effectives pour le matching filtre
// Utilise l'arbre (hi√©rarchie) + alias scrapers pour TOUTES les cat√©gories
function getEffectiveCategoryParts(item) {
  const itemCats = (item.categories || []).map(c => c.toLowerCase());
  const itemMainCat = (item.mainCategory || "").toLowerCase();
  const parts = new Set();
  
  function addPart(p) { if (p && p.length > 0) parts.add(p.trim()); }
  
  itemCats.forEach(cat => {
    addPart(cat);
    cat.split(/\s*>\s*/).forEach(part => addPart(part));
    cat.split('>').forEach(part => addPart(part));
  });
  addPart(itemMainCat);
  
  const toAdd = new Set();
  parts.forEach(p => {
    const resolved = SCRAPER_ALIASES[p] || p;
    if (categoryMappingCache[resolved]) {
      categoryMappingCache[resolved].forEach(e => toAdd.add(e.toLowerCase()));
    } else if (categoryMappingCache[p]) {
      categoryMappingCache[p].forEach(e => toAdd.add(e.toLowerCase()));
    } else {
      toAdd.add(resolved);
      toAdd.add(p);
    }
  });
  toAdd.forEach(x => parts.add(x));
  return parts;
}

let applyExplorerFilterRaf = 0;
let _allEventsLoaded = false;
let _allEventsLoading = false;

// Charger TOUS les events pour que le filtre fonctionne √† n'importe quel zoom
async function loadAllEventsForFilter() {
  if (_allEventsLoaded || _allEventsLoading) return;
  _allEventsLoading = true;
  console.log('[FILTER] Chargement de TOUS les events pour le filtre...');
  
  try {
    const r = await fetch(`${window.API_BASE_URL}/events/viewport?zoom=10&south=-90&north=90&west=-180&east=180`);
    if (!r.ok) { _allEventsLoading = false; return; }
    const data = await r.json();
    if (data.type !== 'events' || !data.k || !data.d) { _allEventsLoading = false; return; }
    
    const keys = data.k;
    let newCount = 0;
    data.d.forEach(row => {
      const obj = {};
      for (let i = 0; i < keys.length; i++) {
        if (row[i] !== null && row[i] !== undefined) obj[keys[i]] = row[i];
      }
      if (loadedEventIds.has(obj.id)) return;
      loadedEventIds.add(obj.id);
      
      const event = {
        ...obj, type: 'event',
        lat: obj.latitude, lng: obj.longitude,
        startDate: obj.date ? new Date(obj.date + (obj.time ? 'T' + obj.time : '')) : null,
        endDate: obj.end_date ? new Date(obj.end_date) : null,
        address: obj.location || '', boost: '1.-', likes: 0, favorites: 0, participations: 0
      };
      if (typeof event.lat !== 'number' || typeof event.lng !== 'number' || isNaN(event.lat) || isNaN(event.lng)) return;
      eventsData.push(event);
      newCount++;
    });
    
    if (newCount > 0) {
      window.eventsData = eventsData;
      console.log(`[FILTER] +${newCount} events charg√©s (total: ${eventsData.length})`);
    }
    _allEventsLoaded = true;
  } catch (e) {
    console.warn('[FILTER] Erreur chargement complet:', e);
  }
  _allEventsLoading = false;
}

const FILTER_ALIASES = {
  // Music
  "electronic": ["electro"], "electro": ["electronic"], "music": ["musique"], "musique": ["music", "concert"],
  "concert": ["musique", "music"],
  // Culture
  "th√©√¢tre": ["spectacle", "th√©atre", "theatre", "spectacles"], "spectacle": ["th√©√¢tre", "theatre", "spectacles"],
  "theatre": ["th√©√¢tre", "spectacle"],
  "expositions": ["exposition", "expo", "galerie", "vernissage"], "exposition": ["expositions"],
  "culture": ["conf√©rence", "conf√©rences & rencontres", "arts vivants", "exposition", "expositions", "cin√©ma", "litt√©rature", "atelier", "ateliers"],
  "conf√©rences & rencontres": ["conf√©rence", "conf√©rences", "d√©bat", "s√©minaire"], "conf√©rence": ["conf√©rences & rencontres"],
  "cin√©ma & projections": ["cin√©ma", "cinema", "film", "projection"], "cin√©ma": ["cin√©ma & projections"],
  "litt√©rature & conte": ["litt√©rature", "conte", "lecture"], "litt√©rature": ["litt√©rature & conte"],
  "visites & patrimoine": ["visite", "patrimoine", "mus√©e", "histoire"], "visite": ["visites & patrimoine"],
  "humour": ["stand-up", "one-man show", "sketch", "improvisation comique"],
  // Ateliers (ex-Workshops)
  "ateliers": ["atelier", "workshops", "workshop", "stage"], "atelier": ["ateliers", "workshops"],
  "workshops": ["ateliers", "atelier"],
  // Sport
  "terrestre": ["sport terrestre", "sport"], "sport terrestre": ["terrestre"],
  "aquatique": ["sport aquatique"], "sport aquatique": ["aquatique"],
  "glisse": ["ski", "snowboard", "patinage", "hockey", "luge"],
  // Food
  "food & drinks": ["d√©gustation", "d√©gustations", "restauration", "gastronomie", "food"],
  "d√©gustations": ["d√©gustation", "gastronomie"], "gastronomie": ["d√©gustations", "food & drinks"],
  // Loisirs
  "d√©fil√©s & f√™tes": ["f√™te", "f√™tes", "brocante", "march√©", "carnaval", "d√©fil√©"],
  "f√™te": ["d√©fil√©s & f√™tes"], "march√©": ["d√©fil√©s & f√™tes", "brocante"],
  "brocante": ["march√© & brocante", "d√©fil√©s & f√™tes", "march√©"],
  // Festivals
  "festivals & grandes f√™tes": ["festival", "festivals", "foire", "salon"],
  "festival": ["festivals & grandes f√™tes"], "foire": ["festivals & grandes f√™tes"],
  // Famille
  "famille & enfants": ["famille", "enfants", "enfant"],
  "famille": ["famille & enfants"], "enfants": ["famille & enfants"],
  // Nature
  "nature & plein air": ["nature", "plein air", "randonn√©e", "balade"],
  "nature": ["nature & plein air"],
  // Bien-√™tre
  "bien-√™tre": ["yoga", "m√©ditation", "sophrologie", "spa", "yoga & bien-√™tre"],
  "yoga": ["bien-√™tre", "yoga & bien-√™tre"], "yoga & bien-√™tre": ["bien-√™tre", "yoga"],
  // Business
  "business & communaut√©": ["business", "networking", "business & networking"],
  "business & networking": ["business & communaut√©"],
  // √âv√©nement g√©n√©rique ‚Üí tout
  "√©v√©nement": []
};

function applyExplorerFilter() {
  renderSelectedTags();
  if (applyExplorerFilterRaf) cancelAnimationFrame(applyExplorerFilterRaf);

  // CRITIQUE : quand un filtre est activ√©, basculer de geoCircles vers markersLayer
  if (typeof geoCirclesLayer !== 'undefined' && geoCirclesLayer) {
    geoCirclesLayer.clearLayers();
  }
  if (markersLayer && map && !map.hasLayer(markersLayer)) {
    markersLayer.addTo(map);
  }

  const lowerCats = selectedCategories.map(c => c.toLowerCase());

  if (lowerCats.length === 0 && !timeFilter && !dateRangeStart && !dateRangeEnd && selectedDates.length === 0) {
    filteredData = null;
    isRefreshingMarkers = false;
    refreshMarkers();
    refreshListView();
    return;
  }

  // Si un filtre cat√©gorie est actif, charger TOUS les events (pour voir de loin)
  if (lowerCats.length > 0 && !_allEventsLoaded) {
    loadAllEventsForFilter().then(() => {
      _applyFilterCore(lowerCats);
    });
    // En attendant, appliquer sur ce qu'on a d√©j√†
    _applyFilterCore(lowerCats);
    return;
  }

  _applyFilterCore(lowerCats);
}

function _applyFilterCore(lowerCats) {
  const base = getCurrentData();
  console.log(`[FILTER] ${lowerCats.length} cat√©gories, base: ${base.length} items`);

  let allowedCategories = new Set();
  
  if (lowerCats.length > 0 && explorerTree) {
    lowerCats.forEach(selectedCat => {
      allowedCategories.add(selectedCat);
      const descendants = findCategoryDescendants(selectedCat, explorerTree);
      descendants.forEach(d => allowedCategories.add(d));
      (FILTER_ALIASES[selectedCat] || []).forEach(a => {
        allowedCategories.add(a);
        const aliasDesc = findCategoryDescendants(a, explorerTree);
        aliasDesc.forEach(d => allowedCategories.add(d));
      });
    });
  }

  filteredData = base.filter(item => {
    let catOk = true;
    if (lowerCats.length > 0) {
      const itemCatParts = getEffectiveCategoryParts(item);
      catOk = Array.from(itemCatParts).some(cat => allowedCategories.has(cat));
    }
    let dateOk = true;
    if (item.type === "event") {
      dateOk = eventMatchesTimeFilter(item);
    }
    return catOk && dateOk;
  });

  console.log(`[FILTER] R√©sultat: ${filteredData.length}/${base.length} passent le filtre`);

  isRefreshingMarkers = false;
  refreshMarkers();
  refreshListView();
}

// Trouve la cat√©gorie cible + tous ses descendants dans l'arbre (hi√©rarchie stricte)
// Electronic ‚Üí techno, house, trance, acid techno, etc. | Techno ‚Üí acid techno, detroit techno, etc. | Reggae ‚Üí reggae seul
function findCategoryDescendants(targetCat, tree) {
  const results = new Set();
  
  function searchNode(node, found = false) {
    if (!node) return;
    
    if (Array.isArray(node)) {
      if (found) {
        node.forEach(item => {
          const name = (typeof item === 'string' ? item : item.name || '').toLowerCase();
          if (name) results.add(name);
        });
      } else {
        // Cible peut √™tre une feuille dans un array (ex: "Reggae" dans ["Reggae","Dub","Ska"])
        const idx = node.findIndex(item => {
          const name = (typeof item === 'string' ? item : item.name || '').toLowerCase();
          return name === targetCat;
        });
        if (idx >= 0) {
          const name = (typeof node[idx] === 'string' ? node[idx] : node[idx].name || '').toLowerCase();
          results.add(name); // feuille = pas de descendants, juste elle-m√™me
        }
      }
      return;
    }
    
    for (const key in node) {
      const keyLower = key.toLowerCase();
      if (keyLower === targetCat || found) {
        results.add(keyLower);
        searchNode(node[key], true);
      } else {
        searchNode(node[key], false);
      }
    }
  }
  
  searchNode(tree);
  return results;
}

function eventMatchesTimeFilter(ev) {
  // Si aucun filtre de date actif, tout passe
  if (selectedDates.length === 0 && !dateRangeStart && !dateRangeEnd) return true;
  if (!ev.startDate) return true;

  const evStart = new Date(ev.startDate);
  if (isNaN(evStart.getTime())) return true;

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // Filtre par plage de dates personnalis√©e
  if (dateRangeStart || dateRangeEnd) {
    const evDate = new Date(ev.startDate);
    evDate.setHours(0, 0, 0, 0);
    
    if (dateRangeStart && dateRangeEnd) {
      const rangeStart = new Date(dateRangeStart + "T00:00:00");
      const rangeEnd = new Date(dateRangeEnd + "T23:59:59");
      if (evDate >= rangeStart && evDate <= rangeEnd) return true;
    } else if (dateRangeStart) {
      const rangeStart = new Date(dateRangeStart + "T00:00:00");
      if (evDate >= rangeStart) return true;
    } else if (dateRangeEnd) {
      const rangeEnd = new Date(dateRangeEnd + "T23:59:59");
      if (evDate <= rangeEnd) return true;
    }
    // Si seulement plage active et pas de match, retourner false
    if (selectedDates.length === 0) return false;
  }

  // V√©rifier les filtres de dates cumul√©s (OR entre eux)
  if (selectedDates.length > 0) {
    return selectedDates.some(filter => matchesDateFilter(evStart, filter, today));
  }

  return true;
}

// V√©rifie si une date correspond √† un filtre sp√©cifique
function matchesDateFilter(evStart, filter, today) {
  if (filter === "today") {
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    return evStart >= today && evStart < tomorrow;
  }

  if (filter === "tomorrow") {
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    const after = new Date(tomorrow);
    after.setDate(tomorrow.getDate() + 1);
    return evStart >= tomorrow && evStart < after;
  }

  if (filter === "weekend") {
    const wd = today.getDay();
    const sat = new Date(today);
    sat.setDate(today.getDate() + ((6 - wd + 7) % 7));
    sat.setHours(0, 0, 0, 0);
    const mon = new Date(sat);
    mon.setDate(sat.getDate() + 2);
    mon.setHours(0, 0, 0, 0);
    return evStart >= sat && evStart < mon;
  }

  if (filter === "week") {
    const js = today.getDay() || 7;
    const monday = new Date(today);
    monday.setDate(today.getDate() - (js - 1));
    monday.setHours(0, 0, 0, 0);
    const nextMonday = new Date(monday);
    nextMonday.setDate(monday.getDate() + 7);
    return evStart >= monday && evStart < nextMonday;
  }

  if (filter === "month") {
    const m0 = new Date(today.getFullYear(), today.getMonth(), 1);
    const m1 = new Date(today.getFullYear(), today.getMonth() + 1, 1);
    return evStart >= m0 && evStart < m1;
  }

  return false;
}

// ============================================
// UI : Recherche ville, changement mode, th√®me
// ============================================

// Variables pour l'autocompl√©tion
let autocompleteTimeout = null;
let currentSuggestions = [];
let selectedSuggestionIndex = -1;

// Fonction pour cr√©er le dropdown d'autocompl√©tion
function createAutocompleteDropdown() {
  const container = document.getElementById("map-search-container");
  if (!container) return null;
  
  let dropdown = document.getElementById("city-autocomplete-dropdown");
  if (!dropdown) {
    dropdown = document.createElement("div");
    dropdown.id = "city-autocomplete-dropdown";
    dropdown.style.cssText = `
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid var(--ui-card-border);
      border-radius: 12px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      display: none;
    `;
    container.style.position = "relative";
    container.appendChild(dropdown);
  }
  return dropdown;
}

// Fonction pour rechercher des suggestions de villes
async function searchCitySuggestions(query) {
  if (!query || query.length < 2) {
    const dropdown = document.getElementById("city-autocomplete-dropdown");
    if (dropdown) dropdown.style.display = "none";
    return;
  }
  
  try {
    const encodedQuery = encodeURIComponent(query);
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?q=${encodedQuery}&format=json&limit=8&addressdetails=1&accept-language=${currentLanguage}`,
      {
        headers: {
          'User-Agent': 'MapEventAI/1.0'
        }
      }
    );
    
    if (!response.ok) throw new Error("Erreur API");
    
    const data = await response.json();
    currentSuggestions = data;
    displaySuggestions(data);
  } catch (error) {
    console.error("Erreur autocompl√©tion:", error);
    const dropdown = document.getElementById("city-autocomplete-dropdown");
    if (dropdown) dropdown.style.display = "none";
  }
}

// Fonction pour afficher les suggestions
function displaySuggestions(suggestions) {
  const dropdown = createAutocompleteDropdown();
  if (!dropdown) return;
  
  if (suggestions.length === 0) {
    dropdown.style.display = "none";
    return;
  }
  
  dropdown.innerHTML = suggestions.map((suggestion, index) => {
    const displayName = suggestion.display_name.split(',').slice(0, 3).join(','); // Limiter √† 3 parties
    return `
      <div 
        class="suggestion-item" 
        data-index="${index}"
        onclick="selectSuggestion(${index})"
        onmouseover="highlightSuggestion(${index})"
        style="
          padding: 12px 16px;
          cursor: pointer;
          border-bottom: 1px solid rgba(255,255,255,0.05);
          transition: all 0.2s;
          ${index === selectedSuggestionIndex ? 'background: rgba(0,255,195,0.15);' : ''}
        "
        onmouseenter="this.style.background='rgba(0,255,195,0.1)'"
        onmouseleave="this.style.background='${index === selectedSuggestionIndex ? 'rgba(0,255,195,0.15)' : 'transparent'}'"
      >
        <div style="font-size: 14px; color: #fff; font-weight: 500; margin-bottom: 4px;">
          ${escapeHtml(displayName)}
        </div>
        <div style="font-size: 11px; color: var(--ui-text-muted);">
          ${suggestion.address?.country || ''} ${suggestion.address?.state ? '‚Ä¢ ' + suggestion.address.state : ''}
        </div>
      </div>
    `;
  }).join('');
  
  dropdown.style.display = "block";
  selectedSuggestionIndex = -1;
}

// Fonction pour s√©lectionner une suggestion
function selectSuggestion(index) {
  if (index < 0 || index >= currentSuggestions.length) return;
  
  const suggestion = currentSuggestions[index];
  const searchInput = document.getElementById("map-search-input");
  const displayName = suggestion.display_name.split(',')[0];
  
  if (searchInput) {
    searchInput.value = displayName;
  }
  
  const dropdown = document.getElementById("city-autocomplete-dropdown");
  if (dropdown) dropdown.style.display = "none";
  
  // Utiliser directement les coordonn√©es Nominatim (pas de re-recherche)
  const lat = parseFloat(suggestion.lat);
  const lng = parseFloat(suggestion.lon);
  if (!isNaN(lat) && !isNaN(lng)) {
    map.setView([lat, lng], 12);
    showNotification(`üìç ${displayName} ${window.t("city_found")}`, "success");
  } else {
    onSearchCity(displayName);
  }
}

// Fonction pour mettre en surbrillance une suggestion (navigation clavier)
function highlightSuggestion(index) {
  selectedSuggestionIndex = index;
  const items = document.querySelectorAll('.suggestion-item');
  items.forEach((item, i) => {
    item.style.background = i === index ? 'rgba(0,255,195,0.15)' : 'transparent';
  });
}

function initUI() {
  const search = document.getElementById("map-search-input");
  if (search) {
    // Autocompl√©tion lors de la saisie
    search.addEventListener("input", e => {
      const query = e.target.value.trim();
      
      // Annuler le timeout pr√©c√©dent
      if (autocompleteTimeout) {
        clearTimeout(autocompleteTimeout);
      }
      
      // Attendre 300ms avant de rechercher (debounce)
      autocompleteTimeout = setTimeout(() => {
        searchCitySuggestions(query);
      }, 300);
    });
    
    // Navigation clavier dans les suggestions
    search.addEventListener("keydown", e => {
      const dropdown = document.getElementById("city-autocomplete-dropdown");
      const isVisible = dropdown && dropdown.style.display !== "none";
      
      if (e.key === "ArrowDown" && isVisible) {
        e.preventDefault();
        selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, currentSuggestions.length - 1);
        highlightSuggestion(selectedSuggestionIndex);
        const items = dropdown.querySelectorAll('.suggestion-item');
        if (items[selectedSuggestionIndex]) {
          items[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
        }
      } else if (e.key === "ArrowUp" && isVisible) {
        e.preventDefault();
        selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
        if (selectedSuggestionIndex >= 0) {
          highlightSuggestion(selectedSuggestionIndex);
          const items = dropdown.querySelectorAll('.suggestion-item');
          if (items[selectedSuggestionIndex]) {
            items[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
          }
        }
      } else if (e.key === "Enter") {
        if (isVisible && selectedSuggestionIndex >= 0) {
          e.preventDefault();
          selectSuggestion(selectedSuggestionIndex);
        } else {
          onSearchCity(search.value);
        }
      } else if (e.key === "Escape") {
        if (dropdown) dropdown.style.display = "none";
      }
    });
    
    // Fermer le dropdown si on clique ailleurs
    document.addEventListener("click", (e) => {
      const dropdown = document.getElementById("city-autocomplete-dropdown");
      const container = document.getElementById("map-search-container");
      if (dropdown && container && !container.contains(e.target)) {
        dropdown.style.display = "none";
      }
    });
  }
}

function switchMode(mode) {
  if (!["event", "booking", "service"].includes(mode)) return;
  
  console.log(`üîÑ Changement de mode : ${currentMode} ‚Üí ${mode}`);
  
  // FERMER LE FILTRE SI OUVERT (l'utilisateur devra le rouvrir)
  const panel = document.getElementById("left-panel");
  if (panel && panel.style.display === "block") {
    panel.style.display = "none";
    explorerOpen = false;
    console.log(`üîí Filtre ferm√© automatiquement lors du changement de mode`);
  }
  
  // SUPPRIMER TOUS LES MARQUEURS ET CLUSTERS AVANT DE CHANGER DE MODE
  if (markersLayer) {
    markersLayer.clearLayers();
    markerMap = {};
    console.log(`üóëÔ∏è Tous les marqueurs supprim√©s`);
  }
  // Supprimer aussi les cercles de clusters g√©ographiques (events zoom faible)
  if (typeof geoCirclesLayer !== 'undefined' && geoCirclesLayer) {
    geoCirclesLayer.clearLayers();
    console.log(`üóëÔ∏è Cercles de clusters supprim√©s`);
  }
  // Reset le viewport key pour forcer un reload quand on revient en mode event
  lastViewportKey = '';
  
  // R√©-ajouter markersLayer √† la map si absent (loadViewportData le retire en mode clusters)
  if (markersLayer && map && !map.hasLayer(markersLayer)) {
    markersLayer.addTo(map);
  }
  
  currentMode = mode;
  
  
  // FORCER l'affichage de TOUS les points (pas de filtre) - CRITIQUE !
  filteredData = null;
  selectedCategories = [];
  timeFilter = null;
  exactDateStr = null;
  dateRangeStart = null;
  dateRangeEnd = null;
  selectedDates = [];

  document.querySelectorAll(".mode-btn").forEach(btn => {
    const txt = btn.textContent.trim().toLowerCase();
    const key =
      txt.includes("event") ? "event" :
      txt.includes("booking") ? "booking" :
      txt.includes("service") ? "service" : "";
    btn.classList.toggle("active", key === mode);
  });

  // S'assurer que les points sont g√©n√©r√©s pour le nouveau mode
  ensureDemoPoints();
  
  // FORCER l'affichage imm√©diat - PAS DE FILTRE
  filteredData = null; // S'assurer qu'on affiche TOUS les points
  selectedCategories = []; // R√©initialiser les cat√©gories
  
  // Afficher imm√©diatement - pas de d√©lai
  refreshMarkers();
  refreshListView();
}

function toggleListView() {
  listViewOpen = !listViewOpen;
  console.log(`üìã Liste ${listViewOpen ? 'ouverte' : 'ferm√©e'}`);
  if (selectedCityForSorting) {
    console.log(`üìç Ville s√©lectionn√©e pour tri: ${selectedCityForSorting.name} (lat:${selectedCityForSorting.lat}, lng:${selectedCityForSorting.lng})`);
  }
  refreshListView();
}

async function onSearchCity(query) {
  if (!query) return;
  const queryLower = query.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
  
  showNotification(`${window.t("searching")} "${query}"...`, "info");
  
  // 1. Chercher dans TOUTES les villes locales (Suisse + France) - match exact d'abord
  const allLocalCities = [...SWISS_CITIES, ...FRENCH_CITIES];
  
  // Priorit√© 1 : match exact du nom
  let cityMatch = allLocalCities.find(city => {
    const cityName = city.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    return cityName === queryLower;
  });
  
  // Priorit√© 2 : le nom de la ville commence par la requ√™te
  if (!cityMatch) {
    cityMatch = allLocalCities.find(city => {
      const cityName = city.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      return cityName.startsWith(queryLower);
    });
  }
  
  // Priorit√© 3 : le nom contient la requ√™te (mais requ√™te >= 3 chars)
  if (!cityMatch && queryLower.length >= 3) {
    cityMatch = allLocalCities.find(city => {
      const cityName = city.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      return cityName.includes(queryLower);
    });
  }
  
  if (cityMatch) {
    map.setView([cityMatch.lat, cityMatch.lng], 12);
    showNotification(`üìç ${cityMatch.name} ${window.t("city_found")}`, "success");
    return;
  }
  
  // 2. Chercher dans les donn√©es actuelles (events) - match exact ou startsWith
  const all = [...eventsData, ...bookingsData, ...servicesData];
  const found = all.find(it => {
    const cityName = (it.city || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    return cityName === queryLower || cityName.startsWith(queryLower);
  });
  
  if (found) {
    map.setView([found.lat, found.lng], 12);
    showNotification(`üìç ${found.city} ${window.t("city_found")}`, "success");
    return;
  }
  
  // 3. Recherche mondiale via Nominatim
  try {
    const encodedQuery = encodeURIComponent(query);
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?q=${encodedQuery}&format=json&limit=1&addressdetails=1`,
      { headers: { 'User-Agent': 'MapEventAI/1.0' } }
    );
    
    if (!response.ok) throw new Error("Erreur API");
    
    const data = await response.json();
    
    if (data && data.length > 0) {
      const result = data[0];
      const lat = parseFloat(result.lat);
      const lng = parseFloat(result.lon);
      const displayName = result.display_name.split(',')[0];
      
      map.setView([lat, lng], 12);
      showNotification(`üìç ${displayName} ${window.t("city_found")}`, "success");
    } else {
      showNotification(`‚ö†Ô∏è ${window.t("city_not_found")} "${query}". ${window.t("try_again")}`, "warning");
    }
  } catch (error) {
    console.error("Erreur recherche ville:", error);
    showNotification(`‚ö†Ô∏è ${window.t("error")} ${window.t("try_again")}`, "error");
  }
}

// ============================================
// FORMULAIRE PUBLIER (inchang√©)
// ============================================
function buildPublishFormHtml() {
  // Utiliser window.t() pour √©viter les erreurs TDZ
  // NE JAMAIS cr√©er de variable locale 't' - utiliser directement window.t() pour √©viter toute TDZ
  const modeLabel = currentMode.charAt(0).toUpperCase() + currentMode.slice(1);
  const hasDates = currentMode === "event";

  const categoriesBlock = `
    <div style="margin-bottom:10px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
        <label style="font-size:12px;font-weight:600;color:#e2e8f0;">${window.t("main_category")} *</label>
        <button type="button" id="pub-open-filter-btn" onclick="openFilterForPublish()" style="padding:4px 10px;border-radius:6px;border:1px solid rgba(0,255,195,0.5);background:rgba(0,255,195,0.1);color:#00ffc3;font-size:11px;cursor:pointer;font-weight:600;transition:all 0.2s;" onmouseover="this.style.background='rgba(0,255,195,0.2)';this.style.borderColor='rgba(0,255,195,0.8)'" onmouseout="this.style.background='rgba(0,255,195,0.1)';this.style.borderColor='rgba(0,255,195,0.5)'">üîç Ouvrir filtre</button>
      </div>
      <input id="pub-main-category" placeholder="1√®re cat√©gorie (obligatoire)"
               style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid #334155;background:#0f172a;color:#fff;font-size:13px;">
      <input id="pub-main-category-2" placeholder="2√®me cat√©gorie (optionnel)"
               style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid #334155;background:#0f172a;color:#fff;font-size:13px;margin-top:6px;">
      <div id="pub-category-suggestions" style="display:none;margin-top:4px;max-height:150px;overflow-y:auto;border:1px solid #334155;border-radius:8px;background:#0f172a;padding:4px;position:relative;z-index:1000;"></div>
    </div>
  `;

  const datesBlock = hasDates
    ? `
      <div style="display:flex;gap:8px;margin-bottom:10px;">
        <div style="flex:1;">
          <label id="pub-start-label" style="font-size:12px;font-weight:600;color:#e2e8f0;">${window.t("start")} <span id="pub-start-star" style="color:#ff4444;">*</span></label>
          <input type="datetime-local" id="pub-start" required onchange="validateEventDates()" style="width:100%;padding:8px;border-radius:8px;border:2px solid #334155;background:#0f172a;color:#fff;color-scheme:dark;">
          <div id="pub-start-error" style="display:none;font-size:10px;color:#ff4444;margin-top:2px;">‚ö†Ô∏è Date/heure invalide</div>
        </div>
        <div style="flex:1;">
          <label id="pub-end-label" style="font-size:12px;font-weight:600;color:#e2e8f0;">${window.t("end")} <span id="pub-end-star" style="color:#ff4444;">*</span></label>
          <input type="datetime-local" id="pub-end" required onchange="validateEventDates()" style="width:100%;padding:8px;border-radius:8px;border:2px solid #334155;background:#0f172a;color:#fff;color-scheme:dark;">
          <div id="pub-end-error" style="display:none;font-size:10px;color:#ff4444;margin-top:2px;">‚ö†Ô∏è Date/heure invalide</div>
        </div>
      </div>
      
      <!-- R√âP√âTITIONS D'√âV√âNEMENTS - Hebdomadaire ou Mensuel uniquement -->
      <div style="margin-bottom:12px;padding:10px;background:rgba(0,255,195,0.05);border:1px solid rgba(0,255,195,0.2);border-radius:10px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <div style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="pub-repeat-enabled" onchange="toggleRepeatOptions()" style="width:18px;height:18px;accent-color:#00ffc3;cursor:pointer;">
            <label for="pub-repeat-enabled" style="font-size:12px;font-weight:600;color:#00ffc3;cursor:pointer;">üîÑ R√©p√©ter cet √©v√©nement</label>
          </div>
          <span id="pub-repeat-price-badge" style="display:none;padding:3px 8px;background:rgba(255,200,0,0.2);border:1px solid rgba(255,200,0,0.5);border-radius:12px;font-size:10px;color:#ffc800;font-weight:600;">+0.-</span>
        </div>
        
        <div id="pub-repeat-options" style="display:none;margin-top:10px;">
          <div style="margin-bottom:8px;">
            <label style="font-size:11px;font-weight:600;color:var(--ui-text-muted);margin-bottom:4px;display:block;">Fr√©quence</label>
            <select id="pub-repeat-frequency" onchange="onRepeatFrequencyChange()" style="width:100%;padding:6px;border-radius:8px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:12px;cursor:pointer;">
              <option value="weekly">üìÖ Hebdomadaire (+15.- CHF)</option>
              <option value="monthly">üìÜ Mensuel (+4.- CHF)</option>
            </select>
          </div>

          <!-- Jours de la semaine (hebdo) -->
          <div id="pub-repeat-weekdays-box" style="margin-bottom:10px;">
            <label style="font-size:11px;font-weight:600;color:var(--ui-text-muted);margin-bottom:6px;display:block;">Jour(s) de la semaine</label>
            <div style="display:flex;gap:4px;flex-wrap:wrap;">
              ${['Lu','Ma','Me','Je','Ve','Sa','Di'].map((d,i) =>
                "<label style=\"display:flex;align-items:center;justify-content:center;width:38px;height:34px;border-radius:8px;border:1.5px solid #334155;background:rgba(15,23,42,0.9);cursor:pointer;transition:all .2s;position:relative;\">" +
                "<input type=\"checkbox\" class=\"repeat-weekday\" value=\"" + i + "\" onchange=\"updateRepeatPreview()\" style=\"position:absolute;opacity:0;width:0;height:0;\">" +
                "<span style=\"font-size:12px;font-weight:600;color:#94a3b8;pointer-events:none;\">" + d + "</span></label>"
              ).join('')}
            </div>
          </div>

          <!-- Jour du mois (mensuel) -->
          <div id="pub-repeat-monthday-box" style="display:none;margin-bottom:10px;">
            <label style="font-size:11px;font-weight:600;color:var(--ui-text-muted);margin-bottom:6px;display:block;">Jour du mois</label>
            <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;">
              ${Array.from({length:31},(_, i) => i+1).map(d =>
                '<button type="button" class="repeat-monthday-btn" data-day="' + d + '" onclick="selectMonthDay(this,' + d + ')" style="padding:5px 0;border-radius:6px;border:1.5px solid #334155;background:rgba(15,23,42,0.9);color:#94a3b8;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;">' + d + '</button>'
              ).join('')}
            </div>
            <input type="hidden" id="pub-repeat-monthday" value="">
          </div>
          
          <div style="display:flex;gap:8px;margin-bottom:8px;">
            <div style="flex:1;">
              <label style="font-size:11px;font-weight:600;color:var(--ui-text-muted);margin-bottom:4px;display:block;">R√©p√©ter jusqu'au</label>
              <input type="date" id="pub-repeat-until" onchange="updateRepeatPricing()" style="width:100%;padding:6px;border-radius:8px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:12px;">
            </div>
          </div>
          
          <div id="pub-repeat-preview" style="padding:8px;background:rgba(0,255,195,0.1);border-radius:6px;font-size:11px;color:#00ffc3;min-height:20px;">
            <span>üí° S√©lectionnez les jours de r√©p√©tition ci-dessus.</span>
          </div>
        </div>
      </div>
    `
    : "";

  const audioBlock =
    currentMode === "booking" || currentMode === "service"
      ? `
      <div style="margin-bottom:10px;">
        <label style="font-size:12px;font-weight:600;">üéµ Liens Sons (√©coute directe)</label>
        <div style="display:flex;gap:8px;margin-bottom:6px;">
          <textarea id="pub-audio" rows="3" placeholder="SoundCloud, Spotify, Mixcloud, Audius... (un lien par ligne, plusieurs pistes possibles)"
                    oninput="updateAudioPreview()" style="flex:1;padding:6px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);font-size:13px;"></textarea>
          <button type="button" onclick="pasteAudioLinks()" style="height:40px;padding:0 14px;border-radius:8px;border:1px solid var(--ui-card-border);background:rgba(139,92,246,0.2);color:#a78bfa;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;flex-shrink:0;" title="Coller depuis le presse-papiers">üìã Coller</button>
        </div>
        <div style="font-size:10px;color:var(--ui-text-muted);margin-top:2px;">üí° Les visiteurs pourront √©couter directement depuis la fiche</div>
        <div id="pub-audio-preview" style="margin-top:10px;display:none;"></div>
      </div>
    `
      : "";

  const bookingLevel =
    currentMode === "booking"
      ? `
      <div style="margin-bottom:10px;">
        <label style="font-size:12px;font-weight:600;">${window.t("level")}</label>
        <input id="pub-level" placeholder="${window.t("level")}"
               style="width:100%;padding:6px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);">
      </div>

      <div style="margin-bottom:10px;">
        <label style="font-size:12px;font-weight:600;">${window.t("price_estimate")}</label>
        <input id="pub-price-estimate" placeholder="${window.t("price_example")}"
               style="width:100%;padding:6px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);">
        <div style="font-size:11px;color:var(--ui-text-muted);margin-top:3px;">
          ${window.t("price_not_detected")}
        </div>
      </div>
    `
      : "";

  const paymentBlock = `
    <div style="margin-top:6px;padding:10px;border-radius:10px;border:1px dashed var(--ui-card-border);font-size:12px;color:var(--ui-text-muted);">
      <div style="font-weight:600;margin-bottom:6px;">${window.t("visibility_choice")}</div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        <label style="display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='rgba(0,255,195,0.05)'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="pub-boost" value="standard" checked onchange="updateTotalPrice()" style="accent-color:#00ffc3;">
          <span><b>Standard</b> - Point basique (inclus)</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='rgba(205,127,50,0.1)'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="pub-boost" value="bronze" onchange="updateTotalPrice()" style="accent-color:#cd7f32;">
          <span><b style="color:#cd7f32;">ü•â Bronze</b> - +5.- CHF (l√©g√®re mise en avant)</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='rgba(192,192,192,0.1)'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="pub-boost" value="silver" onchange="updateTotalPrice()" style="accent-color:#c0c0c0;">
          <span><b style="color:#c0c0c0;">ü•à Silver</b> - +10.- CHF (bonne visibilit√©)</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='rgba(139,92,246,0.1)'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="pub-boost" value="platinum" onchange="updateTotalPrice(); openPlatinumAuctionModal()" style="accent-color:#8b5cf6;">
          <span><b style="color:#8b5cf6;">üíé Platinum (Top 10)</b> - Ench√®res (voir prix actuels)</span>
        </label>
      </div>
    </div>
    
    <!-- AFFICHAGE PRIX TOTAL -->
    <div id="pub-total-price-block" style="margin-top:12px;padding:12px;background:linear-gradient(135deg,rgba(0,255,195,0.1),rgba(59,130,246,0.05));border:2px solid rgba(0,255,195,0.4);border-radius:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-size:11px;color:#e2e8f0;margin-bottom:2px;">Prix de publication</div>
          <div style="font-size:10px;color:#94a3b8;" id="pub-price-details">Base: 1.-</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:22px;font-weight:700;color:#00ffc3;" id="pub-total-price">1.- CHF</div>
        </div>
      </div>
    </div>
    
    <!-- PLACEHOLDER ENCH√àRE PLATINUM -->
    <div id="pub-platinum-bid-info" style="display:none;margin-top:8px;padding:10px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.3);border-radius:8px;">
      <div style="font-size:11px;color:#a78bfa;font-weight:600;">üíé Votre ench√®re Platinum</div>
      <div style="font-size:14px;color:#fff;font-weight:700;" id="pub-platinum-bid-amount">-</div>
    </div>
  `;

  return `
    <form onsubmit="return onSubmitPublishForm(event)" style="display:flex;flex-direction:column;min-height:100%;">
      <div style="flex:1;overflow-y:auto;padding-bottom:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h2 style="margin:0;font-size:16px;">${window.t("publish_mode")} ${modeLabel}</h2>
        <div style="display:flex;gap:8px;align-items:center;">
          <button type="button" onclick="resetPublishForm()" style="padding:4px 10px;border-radius:6px;border:1px solid #475569;background:transparent;color:#94a3b8;font-size:11px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,100,100,0.1)';this.style.borderColor='#ff4444';this.style.color='#ff4444'" onmouseout="this.style.background='transparent';this.style.borderColor='#475569';this.style.color='#94a3b8'" title="Effacer toutes les donn√©es">üîÑ R√©initialiser</button>
          <button type="button" onclick="closePublishModal(event)" style="background:none;border:none;color:var(--ui-text-muted);font-size:24px;cursor:pointer;padding:4px 8px;border-radius:6px;transition:all 0.15s;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.background='rgba(255,255,255,0.1)';this.style.color='#fff'" onmouseout="this.style.background='none';this.style.color='var(--ui-text-muted)'" title="Fermer (donn√©es conserv√©es)">‚úï</button>
        </div>
      </div>

      <div style="margin-bottom:10px;">
        <label style="font-size:12px;font-weight:600;color:#e2e8f0;display:block;margin-bottom:4px;">${window.t("title_name")}</label>
        <input id="pub-title" required
               style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid #334155;background:#0f172a;color:#fff;font-size:13px;">
      </div>

      ${categoriesBlock}
      ${datesBlock}

      <div style="margin-bottom:10px;position:relative;">
        <label id="pub-address-label" style="font-size:12px;font-weight:600;color:#e2e8f0;">${window.t("full_address")} <span id="pub-address-star" style="color:#ff4444;">*</span></label>
        <textarea id="pub-address" name="pub-location-search-${Date.now()}" required oninput="debounceAddressSearch()" onblur="validateAddress()"
               placeholder="Ex: 15 Rue de la Paix, Paris"
               rows="2"
               autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" data-lpignore="true" data-form-type="other"
               style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid #334155;background:#0f172a;color:#fff;font-size:13px;resize:none;font-family:inherit;"></textarea>
        <div id="pub-address-suggestions" style="display:none;position:absolute;top:100%;left:0;right:0;z-index:1001;max-height:200px;overflow-y:auto;border:1px solid #334155;border-radius:8px;background:#0f172a;margin-top:2px;box-shadow:0 4px 12px rgba(0,0,0,0.3);"></div>
        <div id="pub-address-status" style="display:none;font-size:10px;margin-top:2px;"></div>
        <input type="hidden" id="pub-address-lat">
        <input type="hidden" id="pub-address-lng">
      </div>

      <div style="display:flex;gap:8px;margin-bottom:10px;">
        ${currentMode !== "booking" && currentMode !== "service" ? `
        <div style="flex:1;">
          <label style="font-size:12px;font-weight:600;">${window.t("phone")}</label>
          <input id="pub-phone"
                 style="width:100%;padding:6px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);font-size:13px;">
        </div>
        ` : ''}
        <div style="flex:1;">
          <label style="font-size:12px;font-weight:600;">${window.t("email")} *</label>
          <input id="pub-email" type="email" required
                 style="width:100%;padding:6px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);font-size:13px;">
        </div>
      </div>

      <div style="margin-bottom:10px;">
        <label style="font-size:12px;font-weight:600;">${window.t("full_description")} *</label>
        <textarea id="pub-description" rows="4" required
                  style="width:100%;padding:6px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);"></textarea>
      </div>

      <div style="margin-bottom:10px;">
        <label style="font-size:12px;font-weight:600;">${window.t("main_photo")} *</label>
        <input id="pub-image" type="file" accept="image/*" required
               style="width:100%;font-size:12px;color:var(--ui-text-muted);">
      </div>

      ${
        currentMode === "event"
          ? `
        <div style="margin-bottom:10px;">
          <label style="font-size:12px;font-weight:600;">${window.t("ticketing")}</label>
          <input id="pub-ticket" placeholder="${window.t("ticket_link")}"
                 style="width:100%;padding:6px;border-radius:8px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:#fff;">
        </div>
        
        <!-- LIENS SONS - SoundCloud, Spotify, etc. (√©v√©nements) -->
        <div style="margin-bottom:10px;">
          <label style="font-size:12px;font-weight:600;">üéµ Liens Sons (√©coute directe)</label>
          <textarea id="pub-audio-links" rows="3" placeholder="SoundCloud, Spotify, Mixcloud, Audius... (un lien par ligne, plusieurs pistes possibles)"
                    style="width:100%;padding:6px;border-radius:8px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:#fff;font-size:12px;"></textarea>
          <div style="font-size:10px;color:var(--ui-text-muted);margin-top:2px;">
            üí° Les visiteurs pourront √©couter directement depuis la fiche √©v√©nement
          </div>
        </div>
      `
          : ""
      }

      <div style="margin-bottom:10px;">
        <label style="font-size:12px;font-weight:600;">${window.t("social_links")}</label>
        <textarea id="pub-social" rows="2" placeholder="Facebook, Instagram‚Ä¶"
                  style="width:100%;padding:6px;border-radius:8px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:#fff;"></textarea>
      </div>

      <div style="margin-bottom:10px;">
        <label style="font-size:12px;font-weight:600;">${window.t("video_links")}</label>
        <textarea id="pub-videos" rows="2" placeholder="YouTube, Vimeo‚Ä¶"
                  style="width:100%;padding:6px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);"></textarea>
      </div>

      ${audioBlock}
      ${bookingLevel}
      ${paymentBlock}
      
      <div style="margin-top:16px;padding:12px;background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(59,130,246,0.1));border:2px solid rgba(139,92,246,0.4);border-radius:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div>
            <div style="font-weight:700;font-size:14px;color:#a78bfa;margin-bottom:4px;">üíé ${window.t("subscription_recommended")}</div>
            <div style="font-size:11px;color:var(--ui-text-muted);">
              ${currentMode === 'event' ? window.t("save_on_events") : window.t("unlimited_contacts")}
            </div>
          </div>
          <button type="button" onclick="openSubscriptionModal()" style="padding:8px 16px;border-radius:999px;border:2px solid #a78bfa;background:rgba(139,92,246,0.2);color:#a78bfa;font-weight:600;cursor:pointer;font-size:12px;">
            ${window.t("view_subs")}
          </button>
        </div>
        <div style="font-size:10px;color:var(--ui-text-muted);text-align:center;margin-top:6px;">
          ${currentMode === 'event' ? 'Events Explorer: 5.‚Äì/mois ‚Ä¢ Events Alertes Pro: 10.‚Äì/mois' : 'Booking/Service Pro: 10.‚Äì/mois ‚Ä¢ Ultra: 18.‚Äì/mois'}
        </div>
      </div>

      </div>
      <div id="publish-form-footer" style="flex-shrink:0;padding:12px 0;border-top:1px solid var(--ui-card-border);margin-top:auto;background:var(--ui-card-bg);">
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" onclick="closePublishModal()" style="
            padding:10px 20px;border-radius:999px;background:transparent;border:1px solid var(--ui-card-border);color:var(--ui-text-main);cursor:pointer;">
            ${window.t("cancel")}
          </button>
          <button type="submit" style="
            padding:10px 24px;border-radius:999px;border:none;
            background:var(--btn-main-bg);color:var(--btn-main-text);font-weight:700;cursor:pointer;">
            ${window.t("publish_and_pay")}
          </button>
        </div>
      </div>
    </form>
  `;
}

function openPublishModal() {
  console.log('[PUBLISH] üîç openPublishModal appel√© - currentUser:', currentUser);
  console.log('[PUBLISH] üîç isLoggedIn:', currentUser?.isLoggedIn);
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è V√âRIFIER SI L'UTILISATEUR EST CONNECT√â
  if (!currentUser || !currentUser.isLoggedIn) {
    console.log('[PUBLISH] ‚ùå Utilisateur non connect√© - Ouverture modal connexion');
    // Afficher le modal de connexion avec callback pour ouvrir le formulaire apr√®s
    if (typeof window.openAuthModal === 'function') {
      window.openAuthModal('login');
    } else if (typeof openAuthModal === 'function') {
      openAuthModal('login');
    } else {
      showNotification('‚ùå Veuillez vous connecter pour publier', 'error');
    }
    return;
  }
  
  console.log('[PUBLISH] ‚úÖ Utilisateur connect√© - Ouverture formulaire publication');
  
  try {
    const backdrop = document.getElementById("publish-modal-backdrop");
    const inner = document.getElementById("publish-modal-inner");
    console.log('[PUBLISH] üîç backdrop:', !!backdrop, 'inner:', !!inner);
    
    if (!backdrop || !inner) {
      console.error('[PUBLISH] ‚ùå √âl√©ments DOM non trouv√©s:', { backdrop: !!backdrop, inner: !!inner });
      return;
    }
    
    console.log('[PUBLISH] üîç Appel buildPublishFormHtml...');
    const formHtml = buildPublishFormHtml();
    console.log('[PUBLISH] üîç HTML g√©n√©r√©, longueur:', formHtml?.length || 0);
    
    inner.innerHTML = formHtml;
    console.log('[PUBLISH] üîç innerHTML assign√©');
    
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FORCER l'affichage avec !important pour √©craser les styles de closeAuthModal
    backdrop.setAttribute('style', 'display: flex !important; visibility: visible !important; opacity: 1 !important; z-index: 100 !important; position: fixed !important; inset: 0 !important; background: rgba(0,0,0,0.3) !important; align-items: flex-start !important; justify-content: flex-end !important;');
    
    // Forcer aussi les styles du modal et inner
    const modal = document.getElementById('publish-modal');
    if (modal) {
      modal.style.display = 'block';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
      modal.style.height = 'auto';
      modal.style.minHeight = '400px';
    }
    inner.style.display = 'block';
    inner.style.visibility = 'visible';
    inner.style.opacity = '1';
    inner.style.height = 'auto';
    
    console.log('[PUBLISH] ‚úÖ Modal affich√© avec display:flex (forc√© avec !important)');
  } catch (error) {
    console.error('[PUBLISH] ‚ùå ERREUR:', error);
  }
  
  // Ouvrir automatiquement le filtre pour aider √† choisir la cat√©gorie
  if (!explorerOpen) {
    explorerOpen = true;
    const panel = document.getElementById("left-panel");
    if (panel) {
      panel.style.display = "block";
      // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è IMPORTANT: Donner un z-index plus √©lev√© au panneau pour qu'il soit au-dessus du backdrop
      panel.style.zIndex = "150";
      panel.style.position = "relative";
      loadExplorerTree();
      console.log('[PUBLISH] ‚úÖ Filtre ouvert pour aide cat√©gorie (z-index: 150)');
    }
  } else {
    // M√™me si le filtre est d√©j√† ouvert, s'assurer qu'il a le bon z-index
    const panel = document.getElementById("left-panel");
    if (panel) {
      panel.style.zIndex = "150";
      panel.style.position = "relative";
    }
  }
  
  // Initialiser les gestionnaires d'√©v√©nements pour les r√©p√©titions
  if (currentMode === "event") {
    setTimeout(() => {
      initRepeatHandlers();
      initMultipleImagesHandler();
    }, 100);
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è NOUVEAU : Configurer le champ cat√©gorie avec autocompl√©tion
  setTimeout(() => {
    setupCategoryInputWithFilter();
  }, 200);
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è RESTAURER les donn√©es du formulaire si elles existent
  setTimeout(() => {
    restorePublishFormData();
  }, 300);
}

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è NOUVEAU : Fonction pour ouvrir le filtre depuis le bouton Publier
function openFilterForPublish() {
  if (!explorerOpen) {
    explorerOpen = true;
    const panel = document.getElementById("left-panel");
    if (panel) {
      panel.style.display = "block";
      loadExplorerTree();
    }
  }
}

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è NOUVEAU : Configuration du champ cat√©gorie avec autocompl√©tion et recherche
function setupCategoryInputWithFilter() {
  const categoryInput = document.getElementById("pub-main-category");
  const suggestionsDiv = document.getElementById("pub-category-suggestions");
  
  if (!categoryInput || !suggestionsDiv) return;
  
  // Fonction pour obtenir toutes les cat√©gories de l'arbre
  function getAllCategories(tree, prefix = "") {
    const categories = [];
    if (!tree) return categories;
    
    if (Array.isArray(tree)) {
      // Feuilles
      tree.forEach(cat => {
        categories.push(prefix ? `${prefix} > ${cat}` : cat);
      });
    } else {
      // Dossiers
      for (const key in tree) {
        const fullPath = prefix ? `${prefix} > ${key}` : key;
        categories.push(fullPath);
        
        if (tree[key] && !Array.isArray(tree[key])) {
          // Sous-cat√©gories
          categories.push(...getAllCategories(tree[key], fullPath));
        } else if (Array.isArray(tree[key])) {
          // Feuilles dans ce dossier
          tree[key].forEach(cat => {
            categories.push(`${fullPath} > ${cat}`);
          });
        }
      }
    }
    return categories;
  }
  
  // Fonction pour filtrer les cat√©gories selon la recherche
  function filterCategories(query) {
    if (!query || query.length < 2) return [];
    
    const allCats = getAllCategories(explorerTree || EVENTS_TREE || BOOKING_TREE || SERVICE_TREE);
    const lowerQuery = query.toLowerCase();
    
    return allCats.filter(cat => 
      cat.toLowerCase().includes(lowerQuery)
    ).slice(0, 10); // Limiter √† 10 r√©sultats
  }
  
  // Fonction pour afficher les suggestions
  function showSuggestions(matches) {
    if (!matches || matches.length === 0) {
      suggestionsDiv.style.display = "none";
      return;
    }
    
    suggestionsDiv.innerHTML = matches.map(cat => {
      const safe = escapeHtml(cat);
      return `
        <div onclick="event.stopPropagation(); selectCategoryForPublish('${safe}')" 
             style="padding:8px;cursor:pointer;border-radius:4px;transition:background 0.15s;font-size:12px;color:var(--ui-text-main);background:transparent;"
             onmouseover="this.style.background='rgba(0,255,195,0.2)';this.style.color='#00ffc3'"
             onmouseout="this.style.background='transparent';this.style.color='var(--ui-text-main)'">
          ${safe}
        </div>
      `;
    }).join("");
    suggestionsDiv.style.display = "block";
  }
  
  const categoryInput2 = document.getElementById("pub-main-category-2");
  const onInput = function(e) {
    const query = e.target.value.trim();
    if (query.length >= 2) {
      if (!explorerOpen) openFilterForPublish();
      showSuggestions(filterCategories(query));
    } else {
      suggestionsDiv.style.display = "none";
    }
  };
  categoryInput.addEventListener("input", onInput);
  if (categoryInput2) categoryInput2.addEventListener("input", onInput);
  
  document.addEventListener("click", function(e) {
    const inCat1 = categoryInput && categoryInput.contains(e.target);
    const inCat2 = categoryInput2 && categoryInput2.contains(e.target);
    if (!inCat1 && !inCat2 && !suggestionsDiv.contains(e.target)) {
      suggestionsDiv.style.display = "none";
    }
  });
  
  if (categoryInput) categoryInput.focus();
}

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è NOUVEAU : S√©lectionner une cat√©gorie depuis les suggestions (1√®re ou 2√®me)
function selectCategoryForPublish(category) {
  const cat1 = document.getElementById("pub-main-category");
  const cat2 = document.getElementById("pub-main-category-2");
  const suggestionsDiv = document.getElementById("pub-category-suggestions");
  
  const finalCategory = (category || "").trim();
  let targetInput = null;
  
  if (cat1 && !cat1.value.trim()) {
    targetInput = cat1;
  } else if (cat2 && !cat2.value.trim()) {
    targetInput = cat2;
  } else if (cat2) {
    targetInput = cat2;
  } else {
    targetInput = cat1;
  }
  
  if (targetInput) {
    targetInput.value = finalCategory;
    targetInput.style.background = 'rgba(0, 255, 195, 0.15)';
    targetInput.style.borderColor = '#00ffc3';
    setTimeout(() => {
      targetInput.style.background = '#0f172a';
      targetInput.style.borderColor = '#334155';
      targetInput.style.color = '#fff';
    }, 500);
  }
  
  if (suggestionsDiv) suggestionsDiv.style.display = "none";
}

// Fonction pour g√©rer les r√©p√©titions
function toggleRepeatOptions() {
  const checkbox = document.getElementById("pub-repeat-enabled");
  const options = document.getElementById("pub-repeat-options");
  const priceBadge = document.getElementById("pub-repeat-price-badge");
  
  if (checkbox && options) {
    options.style.display = checkbox.checked ? "block" : "none";
    if (priceBadge) {
      priceBadge.style.display = checkbox.checked ? "inline-block" : "none";
    }
    if (checkbox.checked) {
      onRepeatFrequencyChange();
      updateRepeatPricing();
      initWeekdayCheckboxStyles();
    } else {
      updateTotalPrice();
    }
  }
}

function onRepeatFrequencyChange() {
  const freq = document.getElementById("pub-repeat-frequency")?.value || "weekly";
  const weekBox = document.getElementById("pub-repeat-weekdays-box");
  const monthBox = document.getElementById("pub-repeat-monthday-box");
  if (weekBox) weekBox.style.display = freq === "weekly" ? "block" : "none";
  if (monthBox) monthBox.style.display = freq === "monthly" ? "block" : "none";
  updateRepeatPricing();
  updateRepeatPreview();
}

function initWeekdayCheckboxStyles() {
  document.querySelectorAll(".repeat-weekday").forEach(cb => {
    cb.addEventListener("change", function() {
      const label = this.closest("label");
      const span = label?.querySelector("span");
      if (this.checked) {
        label.style.borderColor = "#00ffc3";
        label.style.background = "rgba(0,255,195,0.2)";
        if (span) span.style.color = "#00ffc3";
      } else {
        label.style.borderColor = "#334155";
        label.style.background = "rgba(15,23,42,0.9)";
        if (span) span.style.color = "#94a3b8";
      }
      updateRepeatPreview();
    });
  });
}

function selectMonthDay(btn, day) {
  document.querySelectorAll(".repeat-monthday-btn").forEach(b => {
    b.style.borderColor = "#334155";
    b.style.background = "rgba(15,23,42,0.9)";
    b.style.color = "#94a3b8";
  });
  btn.style.borderColor = "#00ffc3";
  btn.style.background = "rgba(0,255,195,0.2)";
  btn.style.color = "#00ffc3";
  const hidden = document.getElementById("pub-repeat-monthday");
  if (hidden) hidden.value = day;
  updateRepeatPreview();
}

function updateRepeatPreview() {
  const preview = document.getElementById("pub-repeat-preview");
  if (!preview) return;
  const freq = document.getElementById("pub-repeat-frequency")?.value || "weekly";
  const dayNames = ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];

  if (freq === "weekly") {
    const checked = Array.from(document.querySelectorAll(".repeat-weekday:checked")).map(cb => dayNames[parseInt(cb.value)]);
    if (checked.length > 0) {
      preview.innerHTML = 'üìÖ Chaque <b>' + checked.join(', ') + '</b>';
    } else {
      preview.innerHTML = 'üí° S√©lectionnez un ou plusieurs jours de la semaine.';
    }
  } else {
    const day = document.getElementById("pub-repeat-monthday")?.value;
    if (day) {
      preview.innerHTML = 'üìÜ Le <b>' + day + '</b> de chaque mois';
    } else {
      preview.innerHTML = 'üí° S√©lectionnez le jour du mois.';
    }
  }
}

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è VALIDATION DES DATES - Refuser les dates pass√©es
function validateEventDates() {
  const startInput = document.getElementById("pub-start");
  const endInput = document.getElementById("pub-end");
  const startError = document.getElementById("pub-start-error");
  const endError = document.getElementById("pub-end-error");
  const startStar = document.getElementById("pub-start-star");
  const endStar = document.getElementById("pub-end-star");
  
  const now = new Date();
  let isValid = true;
  
  // Valider la date de d√©but
  if (startInput && startInput.value) {
    const startDate = new Date(startInput.value);
    if (startDate < now) {
      // Date dans le pass√© - invalide
      startInput.style.borderColor = "#ff4444";
      startInput.style.background = "rgba(255,68,68,0.1)";
      if (startError) startError.style.display = "block";
      if (startStar) startStar.style.color = "#ff4444";
      isValid = false;
    } else {
      // Date valide
      startInput.style.borderColor = "var(--ui-card-border)";
      startInput.style.background = "rgba(15,23,42,0.9)";
      if (startError) startError.style.display = "none";
      if (startStar) startStar.style.color = "inherit";
    }
  }
  
  // Valider la date de fin
  if (endInput && endInput.value) {
    const endDate = new Date(endInput.value);
    const startDate = startInput?.value ? new Date(startInput.value) : now;
    
    if (endDate < now) {
      // Date dans le pass√© - invalide
      endInput.style.borderColor = "#ff4444";
      endInput.style.background = "rgba(255,68,68,0.1)";
      if (endError) {
        endError.textContent = "‚ö†Ô∏è Date invalide (pass√©e)";
        endError.style.display = "block";
      }
      if (endStar) endStar.style.color = "#ff4444";
      isValid = false;
    } else if (endDate < startDate) {
      // Fin avant d√©but - invalide
      endInput.style.borderColor = "#ff4444";
      endInput.style.background = "rgba(255,68,68,0.1)";
      if (endError) {
        endError.textContent = "‚ö†Ô∏è Fin avant d√©but";
        endError.style.display = "block";
      }
      if (endStar) endStar.style.color = "#ff4444";
      isValid = false;
    } else {
      // Date valide
      endInput.style.borderColor = "var(--ui-card-border)";
      endInput.style.background = "rgba(15,23,42,0.9)";
      if (endError) endError.style.display = "none";
      if (endStar) endStar.style.color = "inherit";
    }
  }
  
  return isValid;
}

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CALCUL DU PRIX DE R√âP√âTITION
function updateRepeatPricing() {
  const frequency = document.getElementById("pub-repeat-frequency")?.value || "weekly";
  const priceBadge = document.getElementById("pub-repeat-price-badge");
  const preview = document.getElementById("pub-repeat-preview");
  const until = document.getElementById("pub-repeat-until")?.value;
  
  // Prix selon la fr√©quence
  const repeatPrice = frequency === "weekly" ? 15 : 4;
  
  if (priceBadge) {
    priceBadge.textContent = `+${repeatPrice}.- CHF`;
    priceBadge.style.display = "inline-block";
  }
  
  // Aper√ßu
  if (preview) {
    const freqText = frequency === "weekly" ? "chaque semaine" : "chaque mois";
    let previewText = `üí° Le point r√©appara√Ætra automatiquement ${freqText}`;
    if (until) {
      const untilDate = new Date(until);
      previewText += ` jusqu'au ${untilDate.toLocaleDateString("fr-FR")}`;
    }
    preview.innerHTML = `<span style="color:#00ffc3;">${previewText}</span>`;
  }
  
  updateTotalPrice();
}

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CALCUL DU PRIX TOTAL
// Variable globale pour stocker le montant de l'ench√®re Platinum
let currentPlatinumBid = 0;

function updateTotalPrice() {
  const basePrice = 1;
  let totalPrice = basePrice;
  let details = ["Base: 1.-"];
  
  // Prix de r√©p√©tition
  const repeatEnabled = document.getElementById("pub-repeat-enabled")?.checked;
  if (repeatEnabled) {
    const frequency = document.getElementById("pub-repeat-frequency")?.value || "weekly";
    const repeatPrice = frequency === "weekly" ? 15 : 4;
    totalPrice += repeatPrice;
    details.push(`R√©p√©tition ${frequency === "weekly" ? "hebdo" : "mensuelle"}: +${repeatPrice}.-`);
  }
  
  // Prix du boost
  const boostRadio = document.querySelector('input[name="pub-boost"]:checked');
  if (boostRadio) {
    if (boostRadio.value === 'platinum' && currentPlatinumBid > 0) {
      // Platinum avec ench√®re
      totalPrice += currentPlatinumBid;
      details.push(`Ench√®re Platinum: +${currentPlatinumBid}.-`);
      
      // Afficher l'info de l'ench√®re
      const bidInfo = document.getElementById("pub-platinum-bid-info");
      const bidAmount = document.getElementById("pub-platinum-bid-amount");
      if (bidInfo) bidInfo.style.display = "block";
      if (bidAmount) bidAmount.textContent = `${currentPlatinumBid}.- CHF`;
    } else {
      // Boost standard (Bronze, Silver)
      const boostPrices = { standard: 0, bronze: 5, silver: 10 };
      const boostPrice = boostPrices[boostRadio.value] || 0;
      if (boostPrice > 0) {
        totalPrice += boostPrice;
        details.push(`Boost ${boostRadio.value}: +${boostPrice}.-`);
      }
      
      // Cacher l'info de l'ench√®re
      const bidInfo = document.getElementById("pub-platinum-bid-info");
      if (bidInfo) bidInfo.style.display = "none";
    }
  }
  
  // Afficher le prix total
  const totalDisplay = document.getElementById("pub-total-price");
  const detailsDisplay = document.getElementById("pub-price-details");
  
  if (totalDisplay) {
    totalDisplay.textContent = `${totalPrice}.- CHF`;
  }
  if (detailsDisplay) {
    detailsDisplay.textContent = details.join(" ‚Ä¢ ");
  }
  
  // Stocker le prix total pour le paiement
  window.currentPublishPrice = totalPrice;
}

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è MODAL ENCH√àRES PLATINUM (TOP 10)
function openPlatinumAuctionModal() {
  // Fermer d'abord le modal de publication temporairement
  const publishBackdrop = document.getElementById("publish-modal-backdrop");
  
  // Cr√©er le modal d'ench√®res
  const auctionHtml = `
    <div id="platinum-auction-modal" style="position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;padding:20px;">
      <div style="background:linear-gradient(135deg,#1e1b4b,#0f172a);border:2px solid #8b5cf6;border-radius:16px;max-width:450px;width:100%;max-height:80vh;overflow-y:auto;box-shadow:0 0 50px rgba(139,92,246,0.3);">
        <div style="padding:20px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h2 style="margin:0;font-size:18px;color:#a78bfa;">üíé Ench√®res Platinum - Top 10</h2>
            <button onclick="closePlatinumAuctionModal()" style="background:none;border:none;color:#94a3b8;font-size:20px;cursor:pointer;">‚úï</button>
          </div>
          
          <p style="font-size:12px;color:#94a3b8;margin-bottom:16px;">
            Les 10 √©v√©nements avec les ench√®res les plus √©lev√©es apparaissent en premi√®re position sur la carte.
          </p>
          
          <!-- TOP 10 ACTUEL -->
          <div style="margin-bottom:16px;">
            <div style="font-size:11px;font-weight:600;color:#e2e8f0;margin-bottom:8px;">üìä Ench√®res actuelles (Top 10)</div>
            <div id="platinum-top-10-list" style="background:rgba(0,0,0,0.3);border-radius:8px;padding:8px;max-height:200px;overflow-y:auto;">
              ${generateTop10List()}
            </div>
          </div>
          
          <!-- PLACER UNE ENCH√àRE -->
          <div style="background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.3);border-radius:10px;padding:12px;">
            <div style="font-size:11px;font-weight:600;color:#a78bfa;margin-bottom:8px;">üí∞ Placer votre ench√®re</div>
            <div style="font-size:10px;color:#94a3b8;margin-bottom:8px;">
              Minimum: <b style="color:#00ffc3;">25.- CHF</b> pour entrer dans le Top 10
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="number" id="platinum-bid-input" min="25" step="1" value="25" 
                     style="flex:1;padding:8px;border-radius:8px;border:1px solid #8b5cf6;background:#1e1b4b;color:#fff;font-size:14px;font-weight:600;text-align:center;">
              <span style="color:#e2e8f0;font-weight:600;">CHF</span>
            </div>
            
            <button onclick="confirmPlatinumBid()" style="width:100%;margin-top:12px;padding:10px;border-radius:8px;border:none;background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff;font-weight:700;cursor:pointer;font-size:13px;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
              ‚úÖ Confirmer l'ench√®re
            </button>
          </div>
          
          <button onclick="cancelPlatinumBid()" style="width:100%;margin-top:10px;padding:8px;border-radius:8px;border:1px solid #475569;background:transparent;color:#94a3b8;cursor:pointer;font-size:12px;">
            Annuler (choisir un autre boost)
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', auctionHtml);
}

function generateTop10List() {
  // Simuler des ench√®res actuelles (√† remplacer par des donn√©es r√©elles du backend)
  const mockAuctions = [
    { position: 1, title: "Festival √âlectro Gen√®ve", bid: 85 },
    { position: 2, title: "Concert Jazz Lausanne", bid: 72 },
    { position: 3, title: "Soir√©e Techno Zurich", bid: 65 },
    { position: 4, title: "Exposition Art Basel", bid: 58 },
    { position: 5, title: "Open Air Montreux", bid: 52 },
    { position: 6, title: "Club Night Bern", bid: 45 },
    { position: 7, title: "Vernissage Fribourg", bid: 38 },
    { position: 8, title: "Rave Underground", bid: 32 },
    { position: 9, title: "Ap√©ro Concert Neuch√¢tel", bid: 28 },
    { position: 10, title: "DJ Set Sion", bid: 25 }
  ];
  
  return mockAuctions.map(a => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:11px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="color:#8b5cf6;font-weight:700;width:20px;">#${a.position}</span>
        <span style="color:#e2e8f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px;">${a.title}</span>
      </div>
      <span style="color:#00ffc3;font-weight:600;">${a.bid}.-</span>
    </div>
  `).join('');
}

function closePlatinumAuctionModal() {
  const modal = document.getElementById("platinum-auction-modal");
  if (modal) modal.remove();
}

function confirmPlatinumBid() {
  const bidInput = document.getElementById("platinum-bid-input");
  const bid = parseInt(bidInput?.value) || 25;
  
  if (bid < 25) {
    showNotification("‚ö†Ô∏è L'ench√®re minimum est de 25.- CHF", "warning");
    return;
  }
  
  currentPlatinumBid = bid;
  closePlatinumAuctionModal();
  updateTotalPrice();
  showNotification(`üíé Ench√®re de ${bid}.- CHF confirm√©e!`, "success");
}

function cancelPlatinumBid() {
  currentPlatinumBid = 0;
  closePlatinumAuctionModal();
  
  // Revenir au standard
  const standardRadio = document.querySelector('input[name="pub-boost"][value="standard"]');
  if (standardRadio) standardRadio.checked = true;
  
  updateTotalPrice();
}

function updateRepeatPreview() {
  // Appeler la nouvelle fonction de pricing
  updateRepeatPricing();
}

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è SAUVEGARDE ET RESTAURATION DES DONN√âES DU FORMULAIRE
function savePublishFormData() {
  try {
    const titleEl = document.getElementById("pub-title");
    if (!titleEl) {
      console.log('[FORM] ‚è≠Ô∏è Formulaire absent du DOM, sauvegarde ignor√©e');
      return;
    }

    const title = titleEl.value || "";
    const mainCategory = document.getElementById("pub-main-category")?.value || "";
    const address = document.getElementById("pub-address")?.value || "";
    const description = document.getElementById("pub-description")?.value || "";

    if (!title && !mainCategory && !address && !description) {
      console.log('[FORM] ‚è≠Ô∏è Formulaire vide, sauvegarde ignor√©e');
      return;
    }

    const formData = {
      mode: currentMode,
      title: title,
      mainCategory: mainCategory,
      mainCategory2: document.getElementById("pub-main-category-2")?.value || "",
      address: address,
      addressLat: document.getElementById("pub-address-lat")?.value || "",
      addressLng: document.getElementById("pub-address-lng")?.value || "",
      email: document.getElementById("pub-email")?.value || "",
      description: description,
      startDate: document.getElementById("pub-start")?.value || "",
      endDate: document.getElementById("pub-end")?.value || "",
      repeatEnabled: document.getElementById("pub-repeat-enabled")?.checked || false,
      repeatFrequency: document.getElementById("pub-repeat-frequency")?.value || "weekly",
      repeatUntil: document.getElementById("pub-repeat-until")?.value || "",
      repeatWeekdays: Array.from(document.querySelectorAll(".repeat-weekday:checked")).map(cb => parseInt(cb.value)),
      repeatMonthday: document.getElementById("pub-repeat-monthday")?.value || "",
      capacity: document.getElementById("pub-capacity")?.value || "",
      price: document.getElementById("pub-price")?.value || "",
      eventType: document.getElementById("pub-event-type")?.value || "",
      ticketLink: document.getElementById("pub-ticket-link")?.value || "",
      audioLinks: document.getElementById("pub-audio-links")?.value || "",
      audio: document.getElementById("pub-audio")?.value || "",
      socialLinks: document.getElementById("pub-social-links")?.value || "",
      website: document.getElementById("pub-website")?.value || "",
      tags: document.getElementById("pub-tags")?.value || "",
      boost: document.querySelector('input[name="pub-boost"]:checked')?.value || "standard",
      platinumBid: currentPlatinumBid || 0,
      timestamp: Date.now()
    };
    
    localStorage.setItem("publishFormData", JSON.stringify(formData));
    console.log('[FORM] ‚úÖ Donn√©es du formulaire sauvegard√©es:', title || mainCategory || address);
  } catch (error) {
    console.error('[FORM] Erreur sauvegarde:', error);
  }
}

async function pasteAudioLinks() {
  try {
    const text = await navigator.clipboard.readText();
    const ta = document.getElementById("pub-audio");
    if (ta) {
      ta.value = ta.value ? ta.value.trim() + "\n" + text.trim() : text.trim();
      updateAudioPreview();
      if (typeof showNotification === 'function') showNotification('‚úÖ Liens coll√©s', 'success');
    }
  } catch (e) {
    if (typeof showNotification === 'function') showNotification('‚ùå Acc√®s presse-papiers refus√©', 'error');
  }
}

function updateAudioPreview() {
  const ta = document.getElementById("pub-audio");
  const preview = document.getElementById("pub-audio-preview");
  if (!ta || !preview) return;
  const links = ta.value.split('\n').map(l => l.trim()).filter(l => l && (l.startsWith('http://') || l.startsWith('https://')));
  if (links.length === 0) {
    preview.style.display = 'none';
    preview.innerHTML = '';
    return;
  }
  preview.style.display = 'block';
  preview.innerHTML = `
    <div style="font-size:11px;color:#a78bfa;font-weight:600;margin-bottom:8px;">üéß Aper√ßu (${links.length} piste${links.length > 1 ? 's' : ''})</div>
    <div style="display:flex;flex-direction:column;gap:6px;max-height:120px;overflow-y:auto;">
      ${links.slice(0, 5).map((url, i) => {
        const safe = (url || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return `
        <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(0,0,0,0.3);border-radius:8px;">
          <audio id="preview-audio-${i}" src="${safe}" preload="none" style="display:none;"></audio>
          <button type="button" onclick="event.stopPropagation();var a=document.getElementById('preview-audio-${i}');a.paused?a.play():a.pause();this.innerHTML=a.paused?'‚ñ∂':'‚è∏';" style="width:28px;height:28px;border-radius:50%;border:none;background:#a78bfa;color:white;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;">‚ñ∂</button>
          <span style="font-size:11px;color:var(--ui-text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">Piste ${i + 1} ‚Ä¢ ${url.includes('audius') ? 'Audius' : url.includes('soundcloud') ? 'SoundCloud' : url.includes('spotify') ? 'Spotify' : 'Audio'}</span>
        </div>`;
      }).join('')}
    </div>
  `;
}

window.pasteAudioLinks = pasteAudioLinks;
window.updateAudioPreview = updateAudioPreview;

function restorePublishFormData() {
  try {
    const savedData = localStorage.getItem("publishFormData");
    if (!savedData) {
      console.log('[FORM] Pas de donn√©es sauvegard√©es √† restaurer');
      return;
    }
    
    const formData = JSON.parse(savedData);
    console.log('[FORM] Donn√©es trouv√©es:', formData.title || '(vide)', formData.mainCategory || '(vide)');
    
    // V√©rifier si les donn√©es ne sont pas trop vieilles (24h max)
    if (formData.timestamp && Date.now() - formData.timestamp > 24 * 60 * 60 * 1000) {
      localStorage.removeItem("publishFormData");
      console.log('[FORM] Donn√©es expir√©es (>24h), supprim√©es');
      return;
    }
    
    // Restaurer les valeurs
    setTimeout(() => {
      const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el && val !== undefined && val !== null && val !== "") el.value = val;
      };
      
      setVal("pub-title", formData.title);
      setVal("pub-main-category", formData.mainCategory);
      setVal("pub-main-category-2", formData.mainCategory2 || "");
      setVal("pub-address", formData.address);
      setVal("pub-address-lat", formData.addressLat);
      setVal("pub-address-lng", formData.addressLng);
      setVal("pub-email", formData.email);
      setVal("pub-description", formData.description);
      setVal("pub-start", formData.startDate);
      setVal("pub-end", formData.endDate);
      setVal("pub-repeat-frequency", formData.repeatFrequency);
      setVal("pub-repeat-until", formData.repeatUntil);
      setVal("pub-capacity", formData.capacity);
      setVal("pub-price", formData.price);
      setVal("pub-event-type", formData.eventType);
      setVal("pub-ticket-link", formData.ticketLink);
      setVal("pub-audio-links", formData.audioLinks);
      setVal("pub-audio", formData.audio || "");
      setVal("pub-social-links", formData.socialLinks);
      setVal("pub-website", formData.website);
      setVal("pub-tags", formData.tags);
      
      // Checkbox r√©p√©tition
      const repeatCheckbox = document.getElementById("pub-repeat-enabled");
      if (repeatCheckbox && formData.repeatEnabled) {
        repeatCheckbox.checked = true;
        toggleRepeatOptions();
        // Restaurer les jours coch√©s (hebdo)
        if (formData.repeatWeekdays && formData.repeatWeekdays.length > 0) {
          formData.repeatWeekdays.forEach(day => {
            const cb = document.querySelector(`.repeat-weekday[value="${day}"]`);
            if (cb) { cb.checked = true; cb.dispatchEvent(new Event('change')); }
          });
        }
        // Restaurer le jour du mois (mensuel)
        if (formData.repeatMonthday) {
          const btn = document.querySelector(`.repeat-monthday-btn[data-day="${formData.repeatMonthday}"]`);
          if (btn) selectMonthDay(btn, parseInt(formData.repeatMonthday));
        }
        updateRepeatPreview();
      }
      
      // Boost s√©lectionn√©
      const boostRadio = document.querySelector(`input[name="pub-boost"][value="${formData.boost}"]`);
      if (boostRadio) boostRadio.checked = true;
      
      // Ench√®re Platinum
      if (formData.platinumBid) {
        currentPlatinumBid = formData.platinumBid;
      }
      
      if (formData.audio && typeof updateAudioPreview === 'function') updateAudioPreview();
      
      // Style pour la cat√©gorie (coh√©rent avec les autres champs)
      const catInput = document.getElementById("pub-main-category");
      if (catInput && formData.mainCategory) {
        catInput.style.background = '#0f172a';
        catInput.style.color = '#fff';
      }
      
      updateTotalPrice();
      console.log('[FORM] ‚úÖ Donn√©es du formulaire restaur√©es');
    }, 100);
    
  } catch (error) {
    console.error('[FORM] Erreur restauration:', error);
  }
}

function resetPublishForm() {
  if (!confirm("‚ö†Ô∏è Voulez-vous vraiment effacer toutes les donn√©es du formulaire ?")) {
    return;
  }
  
  // Effacer le localStorage
  localStorage.removeItem("publishFormData");
  currentPlatinumBid = 0;
  
  // R√©initialiser tous les champs
  const fields = [
    "pub-title", "pub-main-category", "pub-main-category-2", "pub-address", "pub-address-lat", "pub-address-lng",
    "pub-email", "pub-description", "pub-start", "pub-end", "pub-repeat-frequency",
    "pub-repeat-until", "pub-capacity", "pub-price", "pub-event-type", "pub-ticket-link",
    "pub-audio-links", "pub-social-links", "pub-website", "pub-tags"
  ];
  
  fields.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });
  
  // D√©cocher la r√©p√©tition
  const repeatCheckbox = document.getElementById("pub-repeat-enabled");
  if (repeatCheckbox) {
    repeatCheckbox.checked = false;
    toggleRepeatOptions();
  }
  // R√©initialiser les jours de la semaine
  document.querySelectorAll(".repeat-weekday").forEach(cb => {
    cb.checked = false;
    const label = cb.closest("label");
    const span = label?.querySelector("span");
    if (label) { label.style.borderColor = "#334155"; label.style.background = "rgba(15,23,42,0.9)"; }
    if (span) span.style.color = "#94a3b8";
  });
  // R√©initialiser le jour du mois
  document.querySelectorAll(".repeat-monthday-btn").forEach(b => {
    b.style.borderColor = "#334155"; b.style.background = "rgba(15,23,42,0.9)"; b.style.color = "#94a3b8";
  });
  const monthdayInput = document.getElementById("pub-repeat-monthday");
  if (monthdayInput) monthdayInput.value = "";
  
  // Boost standard
  const standardRadio = document.querySelector('input[name="pub-boost"][value="standard"]');
  if (standardRadio) standardRadio.checked = true;
  
  // R√©initialiser le style de la cat√©gorie
  const catInput = document.getElementById("pub-main-category");
  if (catInput) {
    catInput.style.borderColor = '#334155';
  }
  
  updateTotalPrice();
  showNotification("üîÑ Formulaire r√©initialis√©", "info");
  console.log('[FORM] üîÑ Formulaire r√©initialis√©');
}

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è VALIDATION ET RECHERCHE D'ADRESSE MONDIALE
let addressSearchTimeout = null;

function debounceAddressSearch() {
  clearTimeout(addressSearchTimeout);
  addressSearchTimeout = setTimeout(() => {
    searchAddress();
  }, 400);
}

async function searchAddress() {
  const input = document.getElementById("pub-address");
  const suggestionsDiv = document.getElementById("pub-address-suggestions");
  
  if (!input || !suggestionsDiv) return;
  
  const query = input.value.trim();
  if (query.length < 3) {
    suggestionsDiv.style.display = "none";
    return;
  }
  
  try {
    // Utiliser Nominatim (OpenStreetMap) pour la recherche mondiale
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`,
      {
        headers: {
          'Accept-Language': 'fr',
          'User-Agent': 'MapEvent/1.0'
        }
      }
    );
    
    if (!response.ok) return;
    
    const results = await response.json();
    
    if (results.length === 0) {
      suggestionsDiv.innerHTML = '<div style="padding:8px;color:var(--ui-text-muted);font-size:11px;">Aucune adresse trouv√©e</div>';
      suggestionsDiv.style.display = "block";
      return;
    }
    
    // Afficher les suggestions avec data attributes (√©vite les probl√®mes d'apostrophes)
    suggestionsDiv.innerHTML = results.map((r, index) => `
      <div class="address-suggestion" data-index="${index}" data-lat="${r.lat}" data-lng="${r.lon}"
           style="padding:8px 10px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.1);font-size:12px;color:#fff;transition:background 0.15s;"
           onmouseover="this.style.background='rgba(0,255,195,0.15)'"
           onmouseout="this.style.background='transparent'">
        üìç ${escapeHtml(r.display_name)}
      </div>
    `).join('');
    
    // Stocker les r√©sultats et ajouter les listeners
    window._addressResults = results;
    suggestionsDiv.querySelectorAll('.address-suggestion').forEach(div => {
      div.addEventListener('click', function() {
        const idx = parseInt(this.dataset.index);
        const result = window._addressResults[idx];
        if (result) {
          selectAddress(result.display_name, parseFloat(result.lat), parseFloat(result.lon));
        }
      });
    });
    
    suggestionsDiv.style.display = "block";
    
  } catch (error) {
    console.log('[ADDRESS] Erreur recherche:', error);
  }
}

function selectAddress(displayName, lat, lng) {
  console.log('[ADDRESS] üîÑ selectAddress appel√©e avec:', displayName, lat, lng);
  
  const input = document.getElementById("pub-address");
  const latInput = document.getElementById("pub-address-lat");
  const lngInput = document.getElementById("pub-address-lng");
  const suggestionsDiv = document.getElementById("pub-address-suggestions");
  const statusDiv = document.getElementById("pub-address-status");
  
  console.log('[ADDRESS] üì¶ √âl√©ments trouv√©s - input:', !!input, 'latInput:', !!latInput, 'lngInput:', !!lngInput);
  
  if (input) {
    input.value = displayName;
    console.log('[ADDRESS] ‚úÖ Adresse √©crite dans input:', input.value);
  } else {
    console.error('[ADDRESS] ‚ùå Element pub-address introuvable!');
  }
  
  if (latInput) latInput.value = lat;
  if (lngInput) lngInput.value = lng;
  if (suggestionsDiv) suggestionsDiv.style.display = "none";
  
  // Afficher le statut de validation
  if (statusDiv) {
    statusDiv.innerHTML = '<span style="color:#00ffc3;">‚úÖ Adresse valid√©e - Coordonn√©es: ' + lat.toFixed(4) + ', ' + lng.toFixed(4) + '</span>';
    statusDiv.style.display = "block";
  }
  
  // Mettre √† jour le style du champ
  if (input) {
    input.style.borderColor = "rgba(0,255,195,0.5)";
    input.style.background = "rgba(0,255,195,0.05)";
  }
  
  console.log('[ADDRESS] ‚úÖ Adresse s√©lectionn√©e:', displayName, 'Coords:', lat, lng);
}

async function validateAddress() {
  const input = document.getElementById("pub-address");
  const latInput = document.getElementById("pub-address-lat");
  const lngInput = document.getElementById("pub-address-lng");
  const statusDiv = document.getElementById("pub-address-status");
  const starSpan = document.getElementById("pub-address-star");
  const suggestionsDiv = document.getElementById("pub-address-suggestions");
  
  // Fermer les suggestions
  if (suggestionsDiv) suggestionsDiv.style.display = "none";
  
  if (!input || !input.value.trim()) return false;
  
  const addressValue = input.value.trim();
  
  // V√©rifier qu'il y a un num√©ro de rue (obligatoire)
  const hasStreetNumber = /\d+/.test(addressValue);
  if (!hasStreetNumber) {
    if (statusDiv) {
      statusDiv.innerHTML = '<span style="color:#ff4444;">‚ö†Ô∏è Num√©ro de rue obligatoire (ex: 15 Rue de la Paix)</span>';
      statusDiv.style.display = "block";
    }
    input.style.borderColor = "#ff4444";
    input.style.background = "rgba(255,68,68,0.1)";
    if (starSpan) starSpan.style.color = "#ff4444";
    return false;
  }
  
  // Si d√©j√† valid√©e (coordonn√©es pr√©sentes), c'est bon
  if (latInput?.value && lngInput?.value) {
    return true;
  }
  
  // Sinon, essayer de g√©ocoder l'adresse
  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input.value)}&limit=1`,
      {
        headers: {
          'Accept-Language': 'fr',
          'User-Agent': 'MapEvent/1.0'
        }
      }
    );
    
    if (!response.ok) throw new Error('Erreur r√©seau');
    
    const results = await response.json();
    
    if (results.length > 0) {
      const r = results[0];
      if (latInput) latInput.value = r.lat;
      if (lngInput) lngInput.value = r.lon;
      
      if (statusDiv) {
        statusDiv.innerHTML = '<span style="color:#00ffc3;">‚úÖ Adresse valid√©e automatiquement</span>';
        statusDiv.style.display = "block";
      }
      
      input.style.borderColor = "rgba(0,255,195,0.5)";
      input.style.background = "rgba(0,255,195,0.05)";
      if (starSpan) starSpan.style.color = "inherit";
      
      return true;
    } else {
      // Adresse non trouv√©e
      if (statusDiv) {
        statusDiv.innerHTML = '<span style="color:#ff4444;">‚ö†Ô∏è Adresse non reconnue - Le pointeur ne pourra pas √™tre plac√© correctement</span>';
        statusDiv.style.display = "block";
      }
      
      input.style.borderColor = "#ff4444";
      input.style.background = "rgba(255,68,68,0.1)";
      if (starSpan) starSpan.style.color = "#ff4444";
      
      return false;
    }
    
  } catch (error) {
    console.log('[ADDRESS] Erreur validation:', error);
    return false;
  }
}

// Fermer les suggestions quand on clique ailleurs
document.addEventListener('click', function(e) {
  const suggestionsDiv = document.getElementById("pub-address-suggestions");
  const input = document.getElementById("pub-address");
  if (suggestionsDiv && input && !input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
    suggestionsDiv.style.display = "none";
  }
});

function toggleAdvancedOptions() {
  const checkbox = document.getElementById("pub-advanced-options");
  const content = document.getElementById("pub-advanced-options-content");
  if (checkbox && content) {
    content.style.display = checkbox.checked ? "block" : "none";
  }
}

function initRepeatHandlers() {
  initWeekdayCheckboxStyles();
  onRepeatFrequencyChange();
}

function initMultipleImagesHandler() {
  const input = document.getElementById("pub-images-multiple");
  const preview = document.getElementById("pub-images-preview");
  
  if (input && preview) {
    input.addEventListener("change", function(e) {
      preview.innerHTML = "";
      const files = Array.from(e.target.files);
      files.forEach((file, index) => {
        if (file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.style.width = "100%";
            img.style.height = "80px";
            img.style.objectFit = "cover";
            img.style.borderRadius = "6px";
            img.style.border = "1px solid var(--ui-card-border)";
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });
    });
  }
}

// closeAuthModal() est maintenant dans auth.js et expos√© via window.closeAuthModal

// Fonction GLOBALE ultra-simple pour le bouton Annuler (accessible depuis onclick inline)
window.fermerModalAuth = function() {
  console.log('[FERMER] fermerModalAuth appel√©');
  if (typeof closeAuthModal === 'function') {
    closeAuthModal();
  } else {
    const b = document.getElementById('publish-modal-backdrop');
    const m = document.getElementById('publish-modal-inner');
    const a = document.getElementById('authModal');
    if (b) {
      b.style.display = 'none';
      b.style.visibility = 'hidden';
      b.style.opacity = '0';
    }
    if (m) {
      m.innerHTML = '';
      m.style.display = 'none';
    }
    if (a) {
      a.remove();
    }
    console.log('[FERMER] Modal ferm√© directement');
  }
};

function showModalWithContent(html, maxWidth) {
  maxWidth = maxWidth || '600px';
  var bd = document.getElementById('publish-modal-backdrop');
  var pm = document.getElementById('publish-modal');
  var md = document.getElementById('publish-modal-inner');
  if (!bd) { bd = document.createElement('div'); bd.id = 'publish-modal-backdrop'; document.body.appendChild(bd); }
  if (!pm) { pm = document.createElement('div'); pm.id = 'publish-modal'; bd.appendChild(pm); }
  if (!md) { md = document.createElement('div'); md.id = 'publish-modal-inner'; pm.appendChild(md); }
  md.innerHTML = html;
  bd.setAttribute('style', 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:99999;display:flex;align-items:center;justify-content:center;padding:40px 20px;box-sizing:border-box;');
  bd.onclick = function(ev) { if (ev.target === bd && typeof closePublishModal === 'function') closePublishModal(); };
  pm.setAttribute('style', 'display:block;visibility:visible;opacity:1;position:relative;max-width:' + maxWidth + ';width:100%;max-height:90vh;overflow-y:auto;');
  md.setAttribute('style', 'display:block;visibility:visible;opacity:1;background:#1e293b;border-radius:20px;');
}
window.showModalWithContent = showModalWithContent;

function closePublishModal(e) {
  console.log('üö™ closePublishModal called', e?.type || 'direct call', e?.target?.id || 'no target');
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è PROTECTION COORDONN√âES : V√©rifier si le clic est dans la zone du panneau gauche
  if (e && e.clientX !== undefined) {
    const leftPanel = document.getElementById("left-panel");
    if (leftPanel && leftPanel.offsetParent !== null) {
      const panelRect = leftPanel.getBoundingClientRect();
      // Si le clic est dans la zone du panneau gauche (avec une marge de 20px)
      if (e.clientX >= panelRect.left - 20 && 
          e.clientX <= panelRect.right + 20 && 
          e.clientY >= panelRect.top - 20 && 
          e.clientY <= panelRect.bottom + 20) {
        console.log('üö™ [GUARD] Clic dans la zone du left-panel (coordonn√©es) - IGNOR√â (pas de fermeture)', 
          { clickX: e.clientX, clickY: e.clientY, panelRect: { left: panelRect.left, right: panelRect.right, top: panelRect.top, bottom: panelRect.bottom } });
        return;
      }
    }
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è PROTECTION FILTRE : Ne jamais fermer si le clic vient du left-panel (filtre de cat√©gories)
  if (e && e.target) {
    const isInLeftPanel = e.target.closest('#left-panel') || 
                         e.target.closest('.explorer-col') ||
                         e.target.closest('[onclick*="toggleCategory"]') ||
                         e.target.closest('[onclick*="selectLeafCategory"]') ||
                         e.target.closest('[onclick*="openNextLevel"]') ||
                         e.target.closest('[onchange*="toggleCategory"]');
    if (isInLeftPanel) {
      console.log('üö™ [GUARD] Clic dans le left-panel (filtre) - IGNOR√â (pas de fermeture)');
      return;
    }
    
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è PROTECTION FORMULAIRE PUBLICATION : Ne jamais fermer si clic sur √©l√©ments du formulaire
    const isPublishFormElement = e.target.closest('#publish-modal') ||
                                  e.target.closest('#publish-modal-inner') ||
                                  e.target.closest('#pub-category-suggestions') ||
                                  e.target.id?.startsWith('pub-') ||
                                  e.target.closest('[id^="pub-"]') ||
                                  e.target.closest('[onclick*="selectCategoryForPublish"]') ||
                                  e.target.tagName === 'INPUT' ||
                                  e.target.tagName === 'TEXTAREA' ||
                                  e.target.tagName === 'SELECT' ||
                                  e.target.tagName === 'LABEL';
    
    // Mais permettre la fermeture si c'est le vrai bouton croix
    const isCloseButton = (e.target.textContent?.trim() === '‚úï' || e.target.textContent?.trim() === '√ó') &&
                          (e.target.tagName === 'BUTTON' || e.target.tagName === 'SPAN') &&
                          !e.target.id?.startsWith('pub-');
    
    if (isPublishFormElement && !isCloseButton) {
      console.log('üö™ [GUARD] Clic sur √©l√©ment du formulaire publication - IGNOR√â (pas de fermeture)', e.target.id || e.target.tagName);
      return;
    }
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Si c'est un clic sur le VRAI bouton de fermeture (croix), fermer directement
  if (e && e.target) {
    const isActualCloseButton = (e.target.textContent?.trim() === '‚úï' || e.target.textContent?.trim() === '√ó') &&
                                 (e.target.tagName === 'BUTTON' || e.target.tagName === 'SPAN') &&
                                 !e.target.id?.startsWith('pub-');
    
    if (isActualCloseButton) {
      e.stopPropagation();
      // ‚ö†Ô∏è SAUVEGARDER les donn√©es avant de fermer
      savePublishFormData();
      const backdrop = document.getElementById("publish-modal-backdrop");
      if (backdrop) {
        backdrop.style.display = "none";
        console.log('üö™ Modal ferm√© via bouton croix (donn√©es sauvegard√©es)');
        return;
      }
    }
  }
  
  // GUARD: Ne jamais fermer le modal d'auth (register/login) SAUF si c'est explicitement demand√©
  // Permettre la fermeture si on clique sur le backdrop ou sur les boutons de fermeture
  const authModal = document.getElementById("authModal");
  const backdrop = document.getElementById("publish-modal-backdrop");
  const modalInner = document.getElementById("publish-modal-inner");
  
  // V√©rifier si le modal d'auth est visible (backdrop visible OU modalInner contient du contenu auth)
  const isAuthModalVisible = (backdrop && backdrop.offsetParent !== null && backdrop.style.display !== 'none') ||
                             (modalInner && modalInner.innerHTML.includes('auth-cancel-btn')) ||
                             (authModal && authModal.offsetParent !== null);
  
  if (isAuthModalVisible) {
    // Si c'est un clic sur le backdrop (l'√©l√©ment backdrop lui-m√™me, pas ses enfants)
    if (e && (e.target?.id === 'publish-modal-backdrop' || e.target === backdrop)) {
      console.log('üö™ [AUTH] Fermeture autorisee via backdrop');
      closeAuthModal();
      return;
    }
    
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è IMPORTANT : Ne PAS fermer si on clique sur des √©l√©ments du formulaire
    if (e && e.target) {
      const target = e.target;
      
      // Ignorer les clics sur les √©l√©ments de photo
      const isPhotoElement = target.closest('.pro-register-photo-upload') ||
                            target.closest('#pro-photo-input') ||
                            target.closest('#pro-photo-preview') ||
                            target.closest('.pro-register-photo-placeholder') ||
                            target.id === 'pro-photo-input' ||
                            target.id === 'pro-photo-preview' ||
                            target.classList?.contains('pro-register-photo-upload') ||
                            target.classList?.contains('pro-register-photo-input');
      
      if (isPhotoElement) {
        console.log('üö™ [GUARD] Clic sur √©l√©ment de photo - IGNOR√â (pas de fermeture)');
        return;
      }
      
      // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è IMPORTANT : Ignorer TOUS les √©l√©ments du formulaire d'inscription
      // V√©rifier si on clique sur n'importe quel √©l√©ment du formulaire
      const isFormElement = target.closest('.pro-register-container') ||
                           target.closest('.pro-register-form') ||
                           target.closest('#publish-modal-inner') ||
                           target.closest('#authModal') ||
                           target.closest('form') ||
                           target.closest('.pro-register-field') ||
                           target.closest('.pro-register-input') ||
                           target.closest('.pro-register-photo-upload') ||
                           target.closest('.pro-register-password-container') ||
                           target.closest('.pro-register-password-toggle') ||
                           target.closest('.pro-register-label') ||
                           target.id === 'pro-photo-input' ||
                           target.id === 'pro-photo-preview' ||
                           target.classList?.contains('pro-register-photo-upload') ||
                           target.classList?.contains('pro-register-photo-input') ||
                           target.classList?.contains('pro-register-password-toggle') ||
                           target.classList?.contains('pro-register-password-container') ||
                           target.classList?.contains('pro-register-field') ||
                           target.classList?.contains('pro-register-input') ||
                           target.classList?.contains('pro-register-form') ||
                           (target.tagName === 'INPUT' && target.closest('.pro-register-form')) ||
                           (target.tagName === 'BUTTON' && target.closest('.pro-register-form')) ||
                           (target.tagName === 'LABEL' && target.closest('.pro-register-form'));
      
      if (isFormElement) {
        console.log('üö™ [GUARD] Clic sur √©l√©ment du formulaire - IGNOR√â (pas de fermeture)', target.id || target.className || target.tagName);
        return;
      }
      
      // Ignorer les boutons d'affichage/masquage du mot de passe (double v√©rification)
      const isPasswordToggle = target.classList?.contains('pro-register-password-toggle') ||
                              target.closest('.pro-register-password-toggle') ||
                              target.closest('.pro-register-password-container') ||
                              (target.tagName === 'BUTTON' && target.onclick && target.onclick.toString().includes('toggleProPasswordVisibility'));
      
      if (isPasswordToggle) {
        console.log('üö™ [GUARD] Clic sur bouton toggle mot de passe - IGNOR√â (pas de fermeture)');
        return;
      }
      
      // Ignorer le bouton de soumission du formulaire d'inscription
      const isSubmitButton = target.id === 'pro-submit-btn' ||
                            target.closest('#pro-submit-btn') ||
                            (target.tagName === 'BUTTON' && target.type === 'submit' && target.closest('.pro-register-form')) ||
                            (target.tagName === 'BUTTON' && target.form && target.form.classList.contains('pro-register-form'));
      
      if (isSubmitButton) {
        console.log('üö™ [AUTH] Bouton de soumission detecte - laisser passer');
        // Ne pas bloquer, laisser le formulaire se soumettre normalement
        return;
      }
    }
    
      // Si c'est un bouton de fermeture (X, Annuler, etc.), permettre la fermeture
      // V√©rifier par ID, par onclick, ou par classe
      if (e && e.target) {
        const target = e.target;
        const isCancelButton = target.id === 'auth-cancel-btn' ||
                              target.id === 'auth-cancel-btn-pro' ||
                              target.closest('#auth-cancel-btn') ||
                              target.closest('#auth-cancel-btn-pro') ||
                              (target.tagName === 'BUTTON' && target.textContent.trim() === 'Annuler') ||
                              target.closest('button[onclick*="closeAuthModal"]') ||
                              target.closest('button[onclick*="fermerModalAuth"]') ||
                              target.closest('button[onclick*="closePublishModal"]') ||
                              target.closest('button[aria-label*="fermer" i]') ||
                              target.closest('button[aria-label*="close" i]') ||
                              target.closest('button[title*="Fermer" i]') ||
                              target.closest('button[title*="Close" i]');
      
      if (isCancelButton) {
        console.log('üö™ [AUTH] Fermeture autorisee via bouton Annuler/fermeture - ID:', target.id || 'pas d\'ID', 'text:', target.textContent?.trim() || 'pas de texte');
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        closeAuthModal();
        return false;
      }
    }
    
    // Si c'est un appel direct √† closeAuthModal (sans event), permettre
    if (!e) {
      console.log('üö™ [AUTH] Fermeture autorisee via appel direct closeAuthModal');
      closeAuthModal();
      return;
    }
    
    // Sinon, bloquer la fermeture automatique
    console.log('üö™ [GUARD] Auth modal visible - closePublishModal bloque');
    return;
  }
  
  // V√©rifier aussi si le modal d'onboarding est visible
  const onboardingModal = document.getElementById("onboardingModal");
  if (onboardingModal && onboardingModal.offsetParent !== null) {
    console.log('üö™ [GUARD] Onboarding modal visible - closePublishModal bloque');
    return;
  }
  
  if (e && e.target && e.target.id !== "publish-modal-backdrop") {
    const modal = document.getElementById("publish-modal");
    const modalInner = document.getElementById("publish-modal-inner");
    // Ne ferme pas si on clique sur un √©l√©ment dans la modal ou le modal inner
    if ((modal && modal.contains(e.target)) || (modalInner && modalInner.contains(e.target))) return;
  }
  
  // Sauvegarder les donn√©es du formulaire avant fermeture
  savePublishFormData();
  
  // R√©utiliser la variable backdrop d√©j√† d√©clar√©e plus haut
  if (backdrop) {
    backdrop.style.display = "none";
    console.log('üö™ Modal closed - backdrop display set to none (donn√©es sauvegard√©es)');
    
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è R√©initialiser le z-index du panneau gauche
    const leftPanel = document.getElementById("left-panel");
    if (leftPanel) {
      leftPanel.style.zIndex = "";
    }
    
    // ‚ö†Ô∏è Nettoyer le mode √©dition si on ferme le modal
    if (window.editingItem) {
      window.editingItem = null;
      console.log('üö™ Mode √©dition annul√©');
    }
  }
}

async function onSubmitPublishForm(e) {
  e.preventDefault();
  
  // V√©rifier que l'utilisateur est connect√©
  if (!currentUser || !currentUser.isLoggedIn) {
    showNotification("‚ö†Ô∏è Vous devez √™tre connect√© pour publier", "warning");
    openLoginModal();
    return false;
  }
  
  // ‚ö†Ô∏è MODE √âDITION - Modification d'une annonce existante
  if (window.editingItem) {
    return await handleEditSubmit(e);
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è VALIDATION DES DATES (pour les events)
  if (currentMode === "event") {
    if (!validateEventDates()) {
      showNotification("‚ö†Ô∏è Les dates de l'√©v√©nement sont invalides (date pass√©e ou fin avant d√©but)", "error");
      return false;
    }
  }
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è VALIDATION DE L'ADRESSE
  const addressLat = document.getElementById("pub-address-lat")?.value;
  const addressLng = document.getElementById("pub-address-lng")?.value;
  
  if (!addressLat || !addressLng) {
    // Essayer de valider l'adresse une derni√®re fois
    const addressValid = await validateAddress();
    if (!addressValid) {
      showNotification("‚ö†Ô∏è L'adresse n'est pas valide. Veuillez s√©lectionner une adresse dans les suggestions.", "error");
      return false;
    }
  }
  
  // R√©cup√©rer les donn√©es du formulaire
  const title = document.getElementById("pub-title")?.value.trim();
  const mainCategory = document.getElementById("pub-main-category")?.value.trim();
  const mainCategory2 = document.getElementById("pub-main-category-2")?.value.trim();
  const address = document.getElementById("pub-address")?.value.trim();
  const phone = document.getElementById("pub-phone")?.value.trim();
  const email = document.getElementById("pub-email")?.value.trim();
  const description = document.getElementById("pub-description")?.value.trim();
  const ticketUrl = document.getElementById("pub-ticket")?.value.trim();
  const socialLinks = document.getElementById("pub-social")?.value.trim();
  const videoLinks = document.getElementById("pub-videos")?.value.trim();
  const audioEventLinks = document.getElementById("pub-audio-links")?.value.trim(); // Liens sons pour events
  
  // Pour les events : dates
  const startDate = document.getElementById("pub-start")?.value;
  const endDate = document.getElementById("pub-end")?.value;
  
  // R√âP√âTITIONS (pour les events)
  const repeatEnabled = document.getElementById("pub-repeat-enabled")?.checked || false;
  const repeatFrequency = document.getElementById("pub-repeat-frequency")?.value || "weekly";
  const repeatUntil = document.getElementById("pub-repeat-until")?.value || null;
  const repeatCount = document.getElementById("pub-repeat-count")?.value || null;
  const repeatWeekdays = Array.from(document.querySelectorAll(".repeat-weekday:checked")).map(cb => parseInt(cb.value));
  const repeatMonthday = document.getElementById("pub-repeat-monthday")?.value ? parseInt(document.getElementById("pub-repeat-monthday").value) : null;
  
  // OPTIONS AVANC√âES (pour les events)
  const capacity = document.getElementById("pub-capacity")?.value || null;
  const price = document.getElementById("pub-price")?.value || null;
  const eventType = document.getElementById("pub-event-type")?.value || "public";
  const wheelchair = document.getElementById("pub-wheelchair")?.checked || false;
  const parking = document.getElementById("pub-parking")?.checked || false;
  const transport = document.getElementById("pub-transport")?.checked || false;
  const languages = Array.from(document.querySelectorAll(".pub-language:checked")).map(cb => cb.value);
  const tags = document.getElementById("pub-tags")?.value?.split(",").map(t => t.trim()).filter(t => t) || [];
  
  // PHOTOS MULTIPLES
  const mainImageFile = document.getElementById("pub-image")?.files[0];
  const additionalImages = Array.from(document.getElementById("pub-images-multiple")?.files || []);
  
  // Convertir l'image principale en base64 pour envoi au backend
  let mainImageBase64 = null;
  if (mainImageFile) {
    try {
      mainImageBase64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          // Redimensionner l'image pour optimiser la taille (max 1200px)
          const img = new window.Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const maxSize = 1200;
            let w = img.width, h = img.height;
            if (w > maxSize || h > maxSize) {
              const ratio = Math.min(maxSize / w, maxSize / h);
              w = Math.round(w * ratio);
              h = Math.round(h * ratio);
            }
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', 0.82));
          };
          img.onerror = () => resolve(reader.result); // fallback: base64 brut
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(mainImageFile);
      });
      console.log('[PUBLISH] ‚úÖ Image convertie en base64:', mainImageBase64?.substring(0, 50) + '...');
    } catch (imgError) {
      console.warn('[PUBLISH] ‚ö†Ô∏è Erreur conversion image:', imgError);
    }
  }
  
  // Pour les bookings : audio et niveau
  const audioLinks = document.getElementById("pub-audio")?.value.trim();
  const level = document.getElementById("pub-level")?.value.trim();
  const priceEstimate = document.getElementById("pub-price-estimate")?.value.trim();
  
  // Boost s√©lectionn√©
  const boostRadio = document.querySelector('input[name="pub-boost"]:checked');
  const boost = boostRadio?.value || 'basic';
  
  // Validation
  if (!title || !mainCategory || !address || !email || !description) {
    showNotification("‚ö†Ô∏è Veuillez remplir tous les champs obligatoires (*)", "warning");
    return false;
  }
  
  if (currentMode === "event" && (!startDate || !endDate)) {
    showNotification("‚ö†Ô∏è Veuillez indiquer les dates de l'√©v√©nement", "warning");
    return false;
  }
  
  // Utiliser les coordonn√©es pr√©-valid√©es si disponibles
  let lat = null, lng = null, city = "";
  const preValidatedLat = document.getElementById("pub-address-lat")?.value;
  const preValidatedLng = document.getElementById("pub-address-lng")?.value;
  
  if (preValidatedLat && preValidatedLng) {
    lat = parseFloat(preValidatedLat);
    lng = parseFloat(preValidatedLng);
    city = address.split(',')[0];
    showNotification("‚úÖ Adresse valid√©e", "success");
  } else {
    // G√©ocoder l'adresse
    showNotification("üîç Recherche de l'adresse...", "info");
    
    try {
      const geoResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`, {
        headers: { 'User-Agent': 'MapEventAI/1.0' }
      });
      const geoData = await geoResponse.json();
      
      if (geoData.length > 0) {
        lat = parseFloat(geoData[0].lat);
        lng = parseFloat(geoData[0].lon);
        city = geoData[0].display_name.split(',')[0];
      } else {
        showNotification("‚ö†Ô∏è Adresse introuvable. V√©rifiez et r√©essayez.", "warning");
        return false;
      }
    } catch (error) {
      console.error('Erreur g√©ocodage:', error);
      showNotification("‚ùå Erreur de g√©ocodage. R√©essayez.", "error");
      return false;
    }
  }
  
  // Cr√©er l'objet selon le mode
  const newId = Date.now();
  const now = new Date().toISOString();
  
  const categoriesArr = [mainCategory, mainCategory2].filter(Boolean);
  let newItem = {
    id: newId,
    title: title,
    name: title,
    categories: categoriesArr,
    mainCategory: categoriesArr[0] || mainCategory,
    address: address,
    location: address, // Backend attend "location"
    city: city,
    lat: lat,
    lng: lng,
    latitude: lat,   // Backend attend "latitude"
    longitude: lng,  // Backend attend "longitude"
    description: description,
    imageData: mainImageBase64, // Photo upload√©e par l'utilisateur (base64 -> S3)
    email: email,
    phone: phone,
    socialLinks: socialLinks ? socialLinks.split('\n').filter(l => l.trim()) : [],
    videoLinks: videoLinks ? videoLinks.split('\n').filter(l => l.trim()) : [],
    boost: boost,
    verified: false,
    likes: 0,
    comments: 0,
    rating: "4.5",
    createdBy: currentUser.id,
    createdByName: currentUser.name,
    createdAt: now,
    type: currentMode
  };
  
  if (currentMode === "event") {
    newItem.startDate = startDate;
    newItem.endDate = endDate;
    newItem.ticketUrl = ticketUrl;
    newItem.participants = 0;
    newItem.status = "upcoming";
    
    // LIENS AUDIO (SoundCloud, Spotify, etc.)
    if (audioEventLinks) {
      newItem.audioLinks = audioEventLinks.split('\n').filter(l => l.trim());
    }
    
    // R√âP√âTITIONS (hebdomadaire ou mensuel uniquement)
    if (repeatEnabled) {
      const repeatPrice = repeatFrequency === "weekly" ? 15 : 4;
      newItem.repeat = {
        enabled: true,
        frequency: repeatFrequency,
        until: repeatUntil,
        weekdays: repeatFrequency === "weekly" ? repeatWeekdays : [],
        monthday: repeatFrequency === "monthly" ? repeatMonthday : null,
        price: repeatPrice,
        nextOccurrence: null,
        autoReappear: true
      };
    }
    
    // OPTIONS AVANC√âES
    newItem.advancedOptions = {
      capacity: capacity ? parseInt(capacity) : null,
      price: price ? parseFloat(price) : null,
      eventType: eventType,
      accessibility: {
        wheelchair: wheelchair,
        parking: parking,
        publicTransport: transport
      },
      languages: languages.length > 0 ? languages : ["fr"],
      tags: tags.length > 0 ? tags : []
    };
    
    // PHOTOS MULTIPLES
    if (additionalImages.length > 0) {
      newItem.additionalImages = additionalImages.map((file, index) => ({
        index: index,
        filename: file.name,
        type: file.type,
        size: file.size
        // Note: Les fichiers seront upload√©s s√©par√©ment
      }));
    }
    
    // event-specific data already set above
  } else if (currentMode === "booking") {
    newItem.audioLinks = audioLinks ? audioLinks.split('\n').filter(l => l.trim()) : [];
    newItem.level = level;
    newItem.priceEstimate = priceEstimate;
  } else if (currentMode === "service") {
    newItem.priceEstimate = priceEstimate;
  }
  
  // Calculer le prix final
  const finalPrice = window.currentPublishPrice || 1;
  
  // Stocker les donn√©es pour apr√®s le paiement
  window.pendingPublishData = {
    newItem: newItem,
    mode: currentMode,
    lat: lat,
    lng: lng,
    boost: boost,
    price: finalPrice
  };
  
  // Ouvrir le modal de paiement Stripe
  openStripePaymentModal(finalPrice, boost);
  
  return false;
}

// ‚ö†Ô∏è GESTION DE LA MODIFICATION D'UNE ANNONCE EXISTANTE
async function handleEditSubmit(e) {
  e.preventDefault();
  
  const editingItem = window.editingItem;
  const itemId = editingItem.id;
  const itemType = editingItem.mode || editingItem.type || 'event';
  
  // R√©cup√©rer les donn√©es du formulaire
  const title = document.getElementById("pub-title")?.value.trim();
  const mainCategory = document.getElementById("pub-main-category")?.value.trim();
  const mainCategory2 = document.getElementById("pub-main-category-2")?.value.trim();
  const address = document.getElementById("pub-address")?.value.trim();
  const phone = document.getElementById("pub-phone")?.value.trim();
  const email = document.getElementById("pub-email")?.value.trim();
  const description = document.getElementById("pub-description")?.value.trim();
  
  const lat = parseFloat(document.getElementById("pub-address-lat")?.value) || editingItem.lat;
  const lng = parseFloat(document.getElementById("pub-address-lng")?.value) || editingItem.lng;
  
  const startDate = document.getElementById("pub-start")?.value;
  const endDate = document.getElementById("pub-end")?.value;
  
  if (!title || !address) {
    showNotification("‚ö†Ô∏è Veuillez remplir les champs obligatoires", "warning");
    return false;
  }
  
  const categoriesArr = [mainCategory, mainCategory2].filter(Boolean);
  const updateData = {
    title: title,
    description: description,
    location: address,
    address: address,
    latitude: lat,
    longitude: lng,
    email: email,
    phone: phone,
    categories: categoriesArr.length > 0 ? categoriesArr : editingItem.categories
  };
  
  if (itemType === 'event') {
    if (startDate) updateData.date = startDate.split('T')[0];
    if (startDate) updateData.time = startDate.split('T')[1];
    if (endDate) updateData.end_date = endDate.split('T')[0];
    if (endDate) updateData.end_time = endDate.split('T')[1];
  }
  
  // Afficher un loader
  showNotification("‚è≥ Enregistrement des modifications...", "info");
  
  try {
    const token = typeof getAuthToken === 'function' ? getAuthToken() : localStorage.getItem('accessToken');
    const endpoint = itemType === 'event' ? 'events' : itemType === 'booking' ? 'bookings' : 'services';
    
    const response = await fetch(`${window.API_BASE_URL}/${endpoint}/${itemId}`, {
      method: 'PUT',
      headers: { 
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json' 
      },
      body: JSON.stringify(updateData)
    });
    
    if (response.ok) {
      // Mettre √† jour localement
      const dataArray = itemType === 'event' ? eventsData : itemType === 'booking' ? bookingsData : servicesData;
      const index = dataArray.findIndex(i => i.id === itemId);
      if (index !== -1) {
        dataArray[index] = { ...dataArray[index], ...updateData, title: title, name: title };
      }
      
      // Nettoyer
      window.editingItem = null;
      closePublishModal();
      refreshMarkers();
      
      showNotification("‚úÖ Modifications enregistr√©es !", "success");
      
      // Revenir √† Mes Annonces apr√®s un court d√©lai
      setTimeout(() => showMesAnnoncesModal(), 500);
    } else {
      const err = await response.json();
      showNotification("‚ùå Erreur: " + (err.error || "Impossible de modifier"), "error");
    }
  } catch (error) {
    console.error('Erreur modification:', error);
    showNotification("‚ùå Erreur de connexion", "error");
  }
  
  return false;
}

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è MODAL PAIEMENT STRIPE (MODE R√âEL)
function openStripePaymentModal(amount, boost) {
  const boostLabels = {
    standard: 'Standard',
    bronze: 'ü•â Bronze',
    silver: 'ü•à Silver',
    platinum: 'üíé Platinum'
  };
  
  const paymentHtml = `
    <div id="stripe-payment-modal" style="position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;padding:20px;">
      <div style="background:linear-gradient(135deg,#0f172a,#1e293b);border:2px solid #00ffc3;border-radius:16px;max-width:400px;width:100%;box-shadow:0 0 50px rgba(0,255,195,0.2);">
        <div style="padding:24px;">
          <div style="text-align:center;margin-bottom:20px;">
            <div style="font-size:40px;margin-bottom:8px;">üí≥</div>
            <h2 style="margin:0;font-size:20px;color:#00ffc3;">Paiement s√©curis√©</h2>
            <p style="font-size:12px;color:#94a3b8;margin-top:4px;">Powered by Stripe</p>
            <div style="margin-top:8px;padding:4px 10px;background:rgba(0,255,195,0.1);border-radius:20px;display:inline-block;">
              <span style="color:#00ffc3;font-size:10px;font-weight:600;">üîí MODE LIVE - PAIEMENT R√âEL</span>
            </div>
          </div>
          
          <!-- R√âSUM√â -->
          <div style="background:rgba(0,0,0,0.3);border-radius:10px;padding:12px;margin-bottom:16px;">
            <div style="font-size:11px;color:#94a3b8;margin-bottom:8px;">R√©capitulatif</div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="color:#e2e8f0;font-size:13px;">Publication ${currentMode}</span>
              <span style="color:#00ffc3;font-weight:600;">1.- CHF</span>
            </div>
            ${boost !== 'standard' ? `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="color:#e2e8f0;font-size:13px;">Boost ${boostLabels[boost] || boost}</span>
              <span style="color:#a78bfa;font-weight:600;">+${boost === 'platinum' ? currentPlatinumBid : (boost === 'bronze' ? 5 : boost === 'silver' ? 10 : 0)}.- CHF</span>
            </div>
            ` : ''}
            ${document.getElementById("pub-repeat-enabled")?.checked ? `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="color:#e2e8f0;font-size:13px;">R√©p√©tition</span>
              <span style="color:#ffc800;font-weight:600;">+${document.getElementById("pub-repeat-frequency")?.value === 'weekly' ? 15 : 4}.- CHF</span>
            </div>
            ` : ''}
            <div style="border-top:1px solid #334155;margin-top:8px;padding-top:8px;display:flex;justify-content:space-between;align-items:center;">
              <span style="color:#fff;font-weight:700;font-size:14px;">TOTAL</span>
              <span style="color:#00ffc3;font-weight:700;font-size:20px;">${amount}.- CHF</span>
            </div>
          </div>
          
          <!-- FORMULAIRE STRIPE -->
          <div id="stripe-card-element" style="background:#1e293b;border:1px solid #334155;border-radius:8px;padding:12px;margin-bottom:16px;">
            <!-- Stripe Elements sera inject√© ici -->
            <div style="color:#94a3b8;font-size:12px;text-align:center;">
              Chargement du formulaire de paiement...
            </div>
          </div>
          
          <div id="stripe-card-errors" style="display:none;color:#ff4444;font-size:11px;margin-bottom:12px;"></div>
          
          <button id="stripe-submit-btn" onclick="processStripePayment(${amount})" style="width:100%;padding:14px;border-radius:10px;border:none;background:linear-gradient(135deg,#00ffc3,#00d4a4);color:#0f172a;font-weight:700;cursor:pointer;font-size:14px;transition:transform 0.2s,box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='0 4px 20px rgba(0,255,195,0.4)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none'">
            üí≥ Payer ${amount}.- CHF
          </button>
          
          <button onclick="closeStripePaymentModal()" style="width:100%;margin-top:10px;padding:10px;border-radius:8px;border:1px solid #475569;background:transparent;color:#94a3b8;cursor:pointer;font-size:12px;">
            Annuler
          </button>
          
          <div style="text-align:center;margin-top:12px;">
            <img src="https://stripe.com/img/v3/home/social.png" alt="Stripe" style="height:20px;opacity:0.6;">
            <div style="font-size:9px;color:#64748b;margin-top:4px;">Paiement 100% s√©curis√© ‚Ä¢ Donn√©es chiffr√©es</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', paymentHtml);
  
  // Initialiser Stripe Elements
  initStripeCardElement();
}

function closeStripePaymentModal() {
  const modal = document.getElementById("stripe-payment-modal");
  if (modal) modal.remove();
}

// Initialiser Stripe Card Element (pas utilis√© pour Checkout)
async function initStripeCardElement() {
  const cardElement = document.getElementById("stripe-card-element");
  
  // Afficher un message indiquant la redirection vers Stripe
  if (cardElement) {
    cardElement.innerHTML = `
      <div style="text-align:center;">
        <div style="color:#00ffc3;font-size:13px;font-weight:600;margin-bottom:8px;">üí≥ Paiement s√©curis√© Stripe</div>
        <div style="color:#94a3b8;font-size:11px;">Vous serez redirig√© vers la page de paiement Stripe</div>
        <div style="color:#e2e8f0;font-size:10px;margin-top:6px;">Carte bancaire ‚Ä¢ TWINT ‚Ä¢ Apple Pay ‚Ä¢ Google Pay</div>
      </div>
    `;
  }
}

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è VRAI PAIEMENT STRIPE CHECKOUT
async function processStripePayment(amount) {
  const submitBtn = document.getElementById("stripe-submit-btn");
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Redirection vers Stripe...';
  }
  
  try {
    const data = window.pendingPublishData;
    if (!data) {
      throw new Error('Donn√©es de publication manquantes');
    }
    
    // G√©n√©rer un userId si l'utilisateur n'en a pas
    const userId = currentUser?.id || currentUser?.email || `guest_${Date.now()}`;
    
    console.log('[STRIPE] Cr√©ation session Checkout pour', amount, 'CHF, userId:', userId);
    
    // Appeler le backend pour cr√©er une session Stripe Checkout
    // ‚ö†Ô∏è Champs requis par le backend: userId, paymentType, amount
    const response = await fetch(`${window.API_BASE_URL}/payments/create-checkout-session`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': localStorage.getItem('id_token') ? `Bearer ${localStorage.getItem('id_token')}` : ''
      },
      body: JSON.stringify({
        userId: userId,
        paymentType: 'publication',
        amount: amount * 100, // Convertir en centimes pour Stripe
        currency: 'chf',
        email: currentUser?.email || data.newItem?.email || '',
        product_name: `Publication ${data.mode}: ${data.newItem?.title || '√âv√©nement'}`,
        description: `Boost: ${data.boost}${data.newItem?.repeat?.enabled ? ' + R√©p√©tition' : ''}`,
        metadata: {
          eventId: String(data.newItem?.id || ''),
          mode: data.mode || 'event',
          boost: data.boost || 'standard',
          repeatEnabled: String(data.newItem?.repeat?.enabled || false),
          title: data.newItem?.title || ''
        }
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || `Erreur serveur: ${response.status}`);
    }
    
    const result = await response.json();
    
    if (!result.sessionId && !result.url) {
      throw new Error('Session Stripe non cr√©√©e');
    }
    
    // Sauvegarder les donn√©es en localStorage pour apr√®s le paiement
    localStorage.setItem('pendingPublishData', JSON.stringify(data));
    
    // Rediriger vers Stripe Checkout
    if (result.url) {
      // Redirection directe vers l'URL de checkout
      window.location.href = result.url;
    } else if (result.sessionId) {
      // Charger Stripe.js si pas encore charg√©
      if (typeof Stripe === 'undefined' && typeof window.loadStripe === 'function') {
        await window.loadStripe();
      }
      // Utiliser Stripe.js pour rediriger
      if (typeof Stripe !== 'undefined') {
        const stripeInstance = Stripe(result.publicKey || 'pk_live_51Sfg8g2YO5zMBO7yRz2yRw9SZMJhYY8bfxLYT7v6VgQ77lFFwaUOGa5WYD1h7SDUgNkyABKnGFu3KN5p4PwT1Eqr00CisIZv67');
        const { error } = await stripeInstance.redirectToCheckout({ sessionId: result.sessionId });
        if (error) {
          throw new Error(error.message);
        }
      } else {
        throw new Error('Stripe.js non charg√©');
      }
    }
    
  } catch (error) {
    console.error('[STRIPE] Erreur:', error);
    showNotification(`‚ùå Erreur: ${error.message}`, "error");
    
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = `üí≥ Payer ${amount}.- CHF`;
    }
  }
}

// Finaliser la publication apr√®s paiement
async function finalizePublish() {
  if (window._publishFinalized) {
    console.log('[PUBLISH] ‚è≠Ô∏è Publication d√©j√† finalis√©e, ignor√©');
    return;
  }

  const data = window.pendingPublishData;
  if (!data) {
    console.error('[PUBLISH] ‚ùå Donn√©es de publication perdues - pendingPublishData est null');
    showNotification("‚ùå Erreur: Donn√©es de publication perdues. Veuillez r√©essayer.", "error");
    return;
  }
  
  window._publishFinalized = true;
  console.log('[PUBLISH] üîÑ Tentative de cr√©ation avec donn√©es:', JSON.stringify(data.newItem, null, 2));
  
  // Sauvegarder dans le backend D'ABORD
  let backendSuccess = false;
  try {
    const token = typeof getAuthToken === 'function' ? getAuthToken() : localStorage.getItem('accessToken');
    const headers = { 'Content-Type': 'application/json' };
    if (token) headers['Authorization'] = 'Bearer ' + token;
    
    // Pr√©parer les donn√©es avec les bons noms de champs pour le backend
    const backendData = {
      ...data.newItem,
      // Mapper les champs frontend -> backend
      location: data.newItem.address || data.newItem.location,
      latitude: data.newItem.lat || data.newItem.latitude,
      longitude: data.newItem.lng || data.newItem.longitude,
      userId: currentUser?.id,
      creator_id: currentUser?.id,
      paymentStatus: 'paid',
      paymentAmount: data.price
    };
    
    console.log('[PUBLISH] üì§ Envoi au backend:', window.API_BASE_URL + '/' + data.mode + 's');
    console.log('[PUBLISH] üì§ Donn√©es envoy√©es:', JSON.stringify(backendData, null, 2));
    
    const response = await fetch(`${window.API_BASE_URL}/${data.mode}s`, {
      method: 'POST',
      headers: headers,
      body: JSON.stringify(backendData)
    });
    
    const responseText = await response.text();
    console.log('[PUBLISH] üì• R√©ponse backend:', response.status, responseText);
    
    if (response.ok) {
      backendSuccess = true;
      // R√©cup√©rer l'ID g√©n√©r√© par le backend
      try {
        const result = JSON.parse(responseText);
        if (result.id) {
          console.log('[PUBLISH] ‚úÖ ID backend re√ßu:', result.id);
          data.newItem.id = result.id; // Utiliser l'ID du backend !
        }
        if (result.creator_id) {
          console.log('[PUBLISH] ‚úÖ creator_id confirm√©:', result.creator_id);
        }
        // R√©cup√©rer l'URL de l'image upload√©e vers S3
        if (result.image_url) {
          data.newItem.image_url = result.image_url;
          data.newItem.imageUrl = result.image_url;
          console.log('[PUBLISH] ‚úÖ Image URL S3 re√ßue:', result.image_url.substring(0, 80) + '...');
        }
      } catch (e) {
        console.warn('[PUBLISH] Impossible de parser la r√©ponse:', e);
      }
      console.log('[PUBLISH] ‚úÖ √âv√©nement cr√©√© avec succ√®s dans le backend');
    } else {
      console.error('[PUBLISH] ‚ùå Erreur backend:', response.status, responseText);
      showNotification(`‚ùå Erreur serveur (${response.status}): ${responseText}`, "error");
    }
  } catch (error) {
    console.error('[PUBLISH] ‚ùå Erreur r√©seau:', error);
    showNotification("‚ùå Erreur r√©seau lors de la publication. V√©rifiez votre connexion.", "error");
  }
  
  // Ajouter aux donn√©es locales SEULEMENT si backend OK
  if (backendSuccess) {
    const itemId = data.newItem.id;
    if (data.mode === "event") {
      if (!eventsData.some(e => e.id === itemId)) {
        eventsData.push(data.newItem);
      }
      if (typeof loadedEventIds !== 'undefined') loadedEventIds.add(itemId);
    } else if (data.mode === "booking") {
      bookingsData.push(data.newItem);
    } else if (data.mode === "service") {
      servicesData.push(data.newItem);
    }
    
    // Fermer le modal et rafra√Æchir
    closePublishModal();
    refreshMarkers();
    refreshListView();
    
    // Centrer la carte sur le nouveau point
    if (map && data.lat && data.lng) {
      map.setView([data.lat, data.lng], 14);
    }
    
    // Message de succ√®s
    showNotification(`‚úÖ Paiement re√ßu ! ${data.mode === 'event' ? '√âv√©nement' : data.mode === 'booking' ? 'Booking' : 'Service'} publi√© avec succ√®s !`, "success");
  }
  
  window.pendingPublishData = null;
  setTimeout(() => { window._publishFinalized = false; }, 5000);
}

// ============================================
// TH√àMES UI + MAP
// ============================================
// VERROUILL√â: Le fond reste TOUJOURS noir. Seuls les pointeurs, le bouton Publier et le halo du logo changent.
function cycleUITheme() {
  // Ne fait plus rien - le fond reste noir, les couleurs se changent via le color picker
  openColorPickerModal();
}

function applyUITheme(i) {
  // VERROUILL√â: on ne change PLUS les variables CSS globales (fond, cartes, popups, filtres = toujours noir)
  // Seul applyCustomColors() modifie les √©l√©ments autoris√©s
  applyCustomColors();
}

// Appliquer les couleurs custom UNIQUEMENT sur : pointeurs regroup√©s, bouton Publier, halo logo
// JAMAIS sur : fond, popups, filtres, blocs int√©rieurs, topbar, textes
function applyCustomColors() {
  const cfg = window.customThemeConfig;
  if (!cfg) return;
  
  // 1. Bouton Publier - seulement le fond du bouton
  if (cfg.markerColors && cfg.markerColors.length > 0) {
    const publishBtn = document.getElementById('map-publish-btn');
    if (publishBtn) {
      const grad = cfg.markerColors.length > 1
        ? `linear-gradient(135deg, ${cfg.markerColors.join(', ')})`
        : cfg.markerColors[0];
      publishBtn.style.background = grad;
    }
  }
  
  // 2. Halo du logo - suit la couleur accent du marqueur
  if (cfg.markerColors && cfg.markerColors.length > 0) {
    const haloColor = cfg.markerColors[0];
    const halo1 = document.getElementById('logo-halo-1');
    const halo2 = document.getElementById('logo-halo-2');
    if (halo1) halo1.setAttribute('stroke', haloColor);
    if (halo2) halo2.setAttribute('stroke', haloColor);
    // Gradient du logo SVG
    const stop0 = document.querySelector('#logoGrad stop:first-child');
    const stop1 = document.querySelector('#logoGrad stop:last-child');
    if (stop0) stop0.setAttribute('stop-color', cfg.markerColors[0]);
    if (stop1) stop1.setAttribute('stop-color', cfg.markerColors[cfg.markerColors.length > 1 ? 1 : 0]);
  }
  
  // 3. Les pointeurs regroup√©s (clusters + geo-clusters) sont g√©r√©s par getThemeMarkerColors() + iconCreateFunction + showGeoClusters
  // Pas besoin de code ici - ils lisent window.customThemeConfig directement
}

// ============================================
// COLOR PICKER PRO - HSV + Modal
// ============================================

// Conversion HSV -> RGB -> Hex
function hsvToRgb(h, s, v) {
  let r, g, b;
  const i = Math.floor(h / 60) % 6;
  const f = h / 60 - Math.floor(h / 60);
  const p = v * (1 - s);
  const q = v * (1 - f * s);
  const t = v * (1 - (1 - f) * s);
  switch (i) {
    case 0: r = v; g = t; b = p; break;
    case 1: r = q; g = v; b = p; break;
    case 2: r = p; g = v; b = t; break;
    case 3: r = p; g = q; b = v; break;
    case 4: r = t; g = p; b = v; break;
    case 5: r = v; g = p; b = q; break;
  }
  return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
}

function rgbToHex(r, g, b) {
  return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
}

function hexToRgb(hex) {
  hex = hex.replace('#', '');
  if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
  return [parseInt(hex.slice(0,2),16), parseInt(hex.slice(2,4),16), parseInt(hex.slice(4,6),16)];
}

function rgbToHsv(r, g, b) {
  r /= 255; g /= 255; b /= 255;
  const max = Math.max(r, g, b), min = Math.min(r, g, b);
  const d = max - min;
  let h = 0, s = max === 0 ? 0 : d / max, v = max;
  if (d !== 0) {
    switch (max) {
      case r: h = ((g - b) / d + (g < b ? 6 : 0)) * 60; break;
      case g: h = ((b - r) / d + 2) * 60; break;
      case b: h = ((r - g) / d + 4) * 60; break;
    }
  }
  return [h, s, v];
}

// Dessiner le carre SV sur un canvas
function drawSVCanvas(canvas, hue) {
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  for (let x = 0; x < w; x++) {
    for (let y = 0; y < h; y++) {
      const s = x / w;
      const v = 1 - y / h;
      const [r, g, b] = hsvToRgb(hue, s, v);
      ctx.fillStyle = `rgb(${r},${g},${b})`;
      ctx.fillRect(x, y, 1, 1);
    }
  }
}

// Dessiner le slider Hue (vertical arc-en-ciel)
function drawHueSlider(canvas) {
  const ctx = canvas.getContext('2d');
  const h = canvas.height;
  for (let y = 0; y < h; y++) {
    const hue = (y / h) * 360;
    const [r, g, b] = hsvToRgb(hue, 1, 1);
    ctx.fillStyle = `rgb(${r},${g},${b})`;
    ctx.fillRect(0, y, canvas.width, 1);
  }
}

// Variable globale du color picker
let _cpState = { hue: 0, sat: 1, val: 1, callback: null };

function openColorPickerModal() {
  // Fermer le settings modal si ouvert
  const settingsModal = document.getElementById('modal-overlay');
  if (settingsModal) settingsModal.style.display = 'none';
  
  // Config actuelle ou defaut
  const cfg = window.customThemeConfig || {
    markerColors: ['#00ffc3'],
    markerBorder: '#ffffff'
  };
  
  // Copie de travail (seulement marqueur)
  const draft = {
    markerColors: cfg.markerColors ? [...cfg.markerColors] : ['#00ffc3'],
    markerBorder: cfg.markerBorder || '#ffffff'
  };
  
  let existingModal = document.getElementById('color-picker-modal');
  if (existingModal) existingModal.remove();
  
  // Quel slot est actif pour le HSV picker
  let activeSlotType = null; // 'interior-0', 'interior-1', 'interior-2', 'border'
  
  const modal = document.createElement('div');
  modal.id = 'color-picker-modal';
  modal.style.cssText = 'position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);';
  
  modal.innerHTML = `
    <div style="background:#0f172a;border-radius:18px;border:1px solid rgba(255,255,255,0.08);width:360px;max-width:92vw;max-height:88vh;overflow-y:auto;padding:20px;color:#e2e8f0;font-family:system-ui,-apple-system,sans-serif;">
      
      <!-- Header -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <span style="font-size:15px;font-weight:700;">Personnaliser le pointeur</span>
        <button id="cp-close" style="background:none;border:none;color:#64748b;font-size:20px;cursor:pointer;padding:2px 6px;line-height:1;">&times;</button>
      </div>
      
      <!-- PREVIEW LIVE du marqueur - cliquable pour voir le resultat -->
      <div style="text-align:center;margin-bottom:18px;padding:20px 16px;background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:14px;border:1px solid rgba(255,255,255,0.05);">
        <div id="cp-preview" style="display:flex;align-items:flex-end;justify-content:center;gap:20px;min-height:70px;"></div>
      </div>
      
      <!-- INTERIEUR DU MARQUEUR : 1-3 couleurs pour le degrade -->
      <div style="margin-bottom:16px;">
        <div style="font-size:11px;color:#94a3b8;margin-bottom:8px;font-weight:600;letter-spacing:0.3px;">COULEURS INTERIEUR <span style="color:#475569;font-weight:400;">(cliquer pour changer, + pour ajouter)</span></div>
        <div id="cp-interior-slots" style="display:flex;gap:8px;align-items:center;"></div>
      </div>
      
      <!-- BORDURE DU MARQUEUR -->
      <div style="margin-bottom:16px;">
        <div style="font-size:11px;color:#94a3b8;margin-bottom:8px;font-weight:600;letter-spacing:0.3px;">COULEUR BORDURE</div>
        <div id="cp-border-slot" style="display:flex;gap:8px;align-items:center;"></div>
      </div>
      
      <!-- HSV PICKER (apparait quand on clique sur un slot) -->
      <div id="cp-hsv-area" style="display:none;margin-bottom:16px;padding:14px;background:#1e293b;border-radius:12px;">
        <div style="display:flex;gap:10px;">
          <canvas id="cp-sv-canvas" width="200" height="200" style="border-radius:8px;cursor:crosshair;flex-shrink:0;"></canvas>
          <canvas id="cp-hue-slider" width="28" height="200" style="border-radius:8px;cursor:pointer;flex-shrink:0;"></canvas>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:10px;">
          <div id="cp-swatch" style="width:30px;height:30px;border-radius:8px;border:2px solid rgba(255,255,255,0.2);flex-shrink:0;"></div>
          <input id="cp-hex" type="text" maxlength="7" style="background:#0f172a;border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#e2e8f0;padding:6px 10px;font-size:13px;font-family:monospace;width:85px;" placeholder="#00ffc3">
          <button id="cp-hex-ok" style="background:#334155;border:none;color:#e2e8f0;padding:6px 12px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:600;">OK</button>
        </div>
      </div>
      
      <!-- BOUTONS -->
      <div style="display:flex;gap:10px;margin-top:4px;">
        <button id="cp-validate" style="flex:1;padding:11px;border-radius:12px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-weight:700;font-size:13px;cursor:pointer;transition:transform 0.15s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">Valider</button>
        <button id="cp-reset" style="padding:11px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:#64748b;font-size:12px;cursor:pointer;">Reset</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // --- HSV picker setup ---
  const svCanvas = document.getElementById('cp-sv-canvas');
  const hueSlider = document.getElementById('cp-hue-slider');
  const hexInput = document.getElementById('cp-hex');
  const swatch = document.getElementById('cp-swatch');
  const hsvArea = document.getElementById('cp-hsv-area');
  
  drawHueSlider(hueSlider);
  drawSVCanvas(svCanvas, _cpState.hue);
  
  function updatePickerUI() {
    const [r, g, b] = hsvToRgb(_cpState.hue, _cpState.sat, _cpState.val);
    const hex = rgbToHex(r, g, b);
    hexInput.value = hex;
    swatch.style.background = hex;
    if (_cpState.callback) _cpState.callback(hex);
  }
  
  // SV canvas drag
  function handleSV(e) {
    const rect = svCanvas.getBoundingClientRect();
    _cpState.sat = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    _cpState.val = 1 - Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height));
    updatePickerUI();
  }
  let svDrag = false;
  svCanvas.addEventListener('mousedown', e => { svDrag = true; handleSV(e); });
  svCanvas.addEventListener('touchstart', e => { svDrag = true; handleSV(e.touches[0]); e.preventDefault(); }, {passive:false});
  document.addEventListener('mousemove', e => { if (svDrag) handleSV(e); });
  document.addEventListener('touchmove', e => { if (svDrag) handleSV(e.touches[0]); }, {passive:false});
  document.addEventListener('mouseup', () => svDrag = false);
  document.addEventListener('touchend', () => svDrag = false);
  
  // Hue slider drag
  function handleHue(e) {
    const rect = hueSlider.getBoundingClientRect();
    _cpState.hue = Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height)) * 360;
    drawSVCanvas(svCanvas, _cpState.hue);
    updatePickerUI();
  }
  let hueDrag = false;
  hueSlider.addEventListener('mousedown', e => { hueDrag = true; handleHue(e); });
  hueSlider.addEventListener('touchstart', e => { hueDrag = true; handleHue(e.touches[0]); e.preventDefault(); }, {passive:false});
  document.addEventListener('mousemove', e => { if (hueDrag) handleHue(e); });
  document.addEventListener('touchmove', e => { if (hueDrag) handleHue(e.touches[0]); }, {passive:false});
  document.addEventListener('mouseup', () => hueDrag = false);
  document.addEventListener('touchend', () => hueDrag = false);
  
  // Hex manual input
  document.getElementById('cp-hex-ok').addEventListener('click', () => {
    const hex = hexInput.value.trim();
    if (/^#[0-9a-fA-F]{6}$/.test(hex)) {
      const [r, g, b] = hexToRgb(hex);
      const [h, s, v] = rgbToHsv(r, g, b);
      _cpState.hue = h; _cpState.sat = s; _cpState.val = v;
      drawSVCanvas(svCanvas, _cpState.hue);
      updatePickerUI();
    }
  });
  
  // --- Preview du marqueur live ---
  function updatePreview() {
    const preview = document.getElementById('cp-preview');
    if (!preview) return;
    const grad = buildMarkerGradient(draft.markerColors, 135);
    const bg = grad || draft.markerColors[0];
    const border = draft.markerBorder;
    preview.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;">
        <div style="width:42px;height:42px;border-radius:50%;background:${bg};border:3px solid ${border};box-shadow:0 3px 12px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-size:16px;">üéµ</div>
        <div style="width:0;height:0;border-left:7px solid transparent;border-right:7px solid transparent;border-top:10px solid ${border};margin-top:-2px;"></div>
        <div style="font-size:9px;color:#64748b;margin-top:6px;">Marqueur</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;">
        <div style="width:48px;height:48px;border-radius:50%;background:${bg};border:2.5px solid ${border};box-shadow:0 3px 12px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,0.6);">247</div>
        <div style="font-size:9px;color:#64748b;margin-top:6px;">Cluster</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;">
        <div style="position:relative;width:32px;height:32px;">
          <svg width="32" height="32" viewBox="0 0 42 42">
            <circle cx="21" cy="21" r="18" fill="none" stroke="${draft.markerColors[0]}" stroke-width="2" opacity="0.5">
              <animate attributeName="r" values="16;19;16" dur="2s" repeatCount="indefinite"/>
              <animate attributeName="opacity" values="0.3;0.6;0.3" dur="2s" repeatCount="indefinite"/>
            </circle>
            <circle cx="21" cy="21" r="10" fill="url(#logoGrad)" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
            <text x="21" y="25" text-anchor="middle" font-weight="900" font-size="12" fill="#fff">M</text>
          </svg>
        </div>
        <div style="font-size:9px;color:#64748b;margin-top:6px;">Halo</div>
      </div>
    `;
  }
  
  // --- Ouvrir le HSV pour un slot ---
  function activatePickerFor(color, onChange) {
    hsvArea.style.display = 'block';
    const [r, g, b] = hexToRgb(color);
    const [h, s, v] = rgbToHsv(r, g, b);
    _cpState.hue = h; _cpState.sat = s; _cpState.val = v;
    _cpState.callback = onChange;
    drawSVCanvas(svCanvas, _cpState.hue);
    updatePickerUI();
  }
  
  // --- Rendre les slots interieurs ---
  function renderInteriorSlots() {
    const c = document.getElementById('cp-interior-slots');
    c.innerHTML = '';
    draft.markerColors.forEach((color, i) => {
      const slot = document.createElement('div');
      slot.style.cssText = `width:36px;height:36px;border-radius:10px;background:${color};border:2px solid rgba(255,255,255,0.25);cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;position:relative;`;
      slot.addEventListener('mouseenter', () => { slot.style.transform = 'scale(1.12)'; slot.style.boxShadow = '0 0 14px rgba(255,255,255,0.3)'; });
      slot.addEventListener('mouseleave', () => { slot.style.transform = 'scale(1)'; slot.style.boxShadow = 'none'; });
      slot.addEventListener('click', () => {
        activeSlotType = 'interior-' + i;
        // Highlight active slot
        c.querySelectorAll('div[data-slot]').forEach(s => s.style.outline = 'none');
        slot.style.outline = '2px solid #00ffc3';
        slot.style.outlineOffset = '2px';
        activatePickerFor(color, (hex) => {
          draft.markerColors[i] = hex;
          slot.style.background = hex;
          updatePreview();
        });
      });
      slot.setAttribute('data-slot', 'interior');
      // Bouton supprimer (si >1 couleur)
      if (draft.markerColors.length > 1) {
        const rm = document.createElement('div');
        rm.style.cssText = 'position:absolute;top:-6px;right:-6px;width:16px;height:16px;border-radius:50%;background:#ef4444;color:#fff;font-size:10px;font-weight:bold;display:flex;align-items:center;justify-content:center;cursor:pointer;line-height:1;';
        rm.textContent = 'x';
        rm.addEventListener('click', e => { e.stopPropagation(); draft.markerColors.splice(i, 1); renderInteriorSlots(); updatePreview(); });
        slot.appendChild(rm);
      }
      c.appendChild(slot);
    });
    // Bouton + (si <3 couleurs)
    if (draft.markerColors.length < 3) {
      const addBtn = document.createElement('div');
      addBtn.style.cssText = 'width:36px;height:36px;border-radius:10px;border:2px dashed rgba(255,255,255,0.15);cursor:pointer;display:flex;align-items:center;justify-content:center;color:#475569;font-size:20px;transition:border-color 0.2s;';
      addBtn.textContent = '+';
      addBtn.addEventListener('mouseenter', () => addBtn.style.borderColor = 'rgba(255,255,255,0.4)');
      addBtn.addEventListener('mouseleave', () => addBtn.style.borderColor = 'rgba(255,255,255,0.15)');
      addBtn.addEventListener('click', () => { draft.markerColors.push('#ffffff'); renderInteriorSlots(); updatePreview(); });
      c.appendChild(addBtn);
    }
  }
  
  // --- Rendre le slot bordure ---
  function renderBorderSlot() {
    const c = document.getElementById('cp-border-slot');
    c.innerHTML = '';
    const slot = document.createElement('div');
    slot.style.cssText = `width:36px;height:36px;border-radius:10px;background:${draft.markerBorder};border:2px solid rgba(255,255,255,0.25);cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;`;
    slot.setAttribute('data-slot', 'border');
    slot.addEventListener('mouseenter', () => { slot.style.transform = 'scale(1.12)'; slot.style.boxShadow = '0 0 14px rgba(255,255,255,0.3)'; });
    slot.addEventListener('mouseleave', () => { slot.style.transform = 'scale(1)'; slot.style.boxShadow = 'none'; });
    slot.addEventListener('click', () => {
      activeSlotType = 'border';
      document.querySelectorAll('[data-slot]').forEach(s => s.style.outline = 'none');
      slot.style.outline = '2px solid #00ffc3';
      slot.style.outlineOffset = '2px';
      activatePickerFor(draft.markerBorder, (hex) => {
        draft.markerBorder = hex;
        slot.style.background = hex;
        hexLabel.textContent = hex;
        updatePreview();
      });
    });
    c.appendChild(slot);
    const hexLabel = document.createElement('span');
    hexLabel.style.cssText = 'font-size:11px;color:#475569;font-family:monospace;';
    hexLabel.textContent = draft.markerBorder;
    c.appendChild(hexLabel);
  }
  
  // Init
  renderInteriorSlots();
  renderBorderSlot();
  updatePreview();
  
  // --- Fermer ---
  document.getElementById('cp-close').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  
  // --- VALIDER ---
  document.getElementById('cp-validate').addEventListener('click', async () => {
    window.customThemeConfig = { markerColors: [...draft.markerColors], markerBorder: draft.markerBorder };
    localStorage.setItem('customThemeConfig', JSON.stringify(window.customThemeConfig));
    applyCustomColors();
    
    // IMPORTANT: Vider TOUS les marqueurs existants pour les recr√©er avec les nouvelles couleurs
    // Sans cela, loadedEventIds emp√™che la recr√©ation des marqueurs (bug couleur bordure ignor√©e)
    if (markersLayer) markersLayer.clearLayers();
    markerMap = {};
    loadedEventIds.clear();
    eventsData = [];
    window.eventsData = eventsData;
    
    // Rafraichir geo-clusters et clusters Leaflet SANS bouger la map
    lastViewportKey = '';
    if (typeof loadViewportData === 'function' && map) loadViewportData();
    
    // Sauvegarder en BDD si connecte
    try {
      const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
      if (token) {
        await fetch(`${window.API_BASE_URL}/user/theme`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(window.customThemeConfig)
        });
        showNotification('Couleurs sauvegardees !', 'success');
      } else {
        showNotification('Connectez-vous pour sauvegarder vos couleurs', 'info');
      }
    } catch (e) {
      console.warn('[THEME] Erreur sauvegarde:', e);
    }
    modal.remove();
  });
  
  // --- RESET ---
  document.getElementById('cp-reset').addEventListener('click', () => {
    window.customThemeConfig = null;
    localStorage.removeItem('customThemeConfig');
    // Reset halo logo aux couleurs par defaut
    const halo1 = document.getElementById('logo-halo-1');
    const halo2 = document.getElementById('logo-halo-2');
    if (halo1) halo1.setAttribute('stroke', '#00ffc3');
    if (halo2) halo2.setAttribute('stroke', '#00ffc3');
    // Reset bouton publier
    const pubBtn = document.getElementById('map-publish-btn');
    if (pubBtn) pubBtn.style.background = '';
    // IMPORTANT: Vider TOUS les marqueurs pour les recr√©er avec les couleurs par d√©faut
    if (markersLayer) markersLayer.clearLayers();
    markerMap = {};
    loadedEventIds.clear();
    eventsData = [];
    window.eventsData = eventsData;
    // Rafraichir
    lastViewportKey = '';
    if (typeof loadViewportData === 'function' && map) loadViewportData();
    // Supprimer en BDD si connecte
    try {
      const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
      if (token) {
        fetch(`${window.API_BASE_URL}/user/theme`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(null)
        });
      }
    } catch(e) {}
    showNotification('Couleurs par defaut restaurees', 'success');
    modal.remove();
  });
}

function cycleMapTheme() {
  mapThemeIndex = (mapThemeIndex + 1) % MAP_THEMES.length;
  applyMapTheme(mapThemeIndex);
}

function applyMapTheme(i) {
  const theme = MAP_THEMES[i];
  if (tileLayer) map.removeLayer(tileLayer);
  tileLayer = L.tileLayer(theme.url, {
    maxZoom: theme.maxZoom,
    attribution: theme.attribution
  });
  tileLayer.addTo(map);
}

// ============================================
// D√âMO AUTOMATIQUE ‚Äì 400 √âV√âNEMENTS VARI√âS
// ============================================

const EVENT_TITLES = {
  "Techno": ["Rave Underground", "Techno Warehouse", "Dark Room", "Industrial Night", "Bunker Session", "Acid Night", "Minimal Monday", "Peak Time", "Detroit Calling", "Berghain Vibes"],
  "House": ["Deep House Sunday", "Funky Groove", "Soulful Sessions", "Beach House Party", "Disco Revival", "Tech House Fiesta", "Progressive Journey", "Tribal Gathering"],
  "Trance": ["Psytrance Forest", "Goa Experience", "Uplifting Night", "Full Moon Party", "Spiritual Journey", "Hi-Tech Madness", "Progressive Paradise"],
  "Rap": ["Hip-Hop Night", "Freestyle Battle", "Urban Beats", "Trap House", "Drill Session", "Boom Bap Revival", "Old School vs New"],
  "Rock": ["Rock the Night", "Metal Fest", "Punk Rebellion", "Indie Showcase", "Alternative Scene", "Grunge Night", "Classic Rock Party"],
  "Jazz": ["Jazz Club Night", "Smooth Sessions", "Swing Dance", "Blues Caf√©", "Fusion Night", "New Orleans Style"],
  "Festival": ["Summer Festival", "Music Days", "Urban Fest", "Lake Festival", "Mountain Sounds", "City Beats Festival"],
  "March√©": ["March√© de No√´l", "Brocante du Dimanche", "March√© artisanal", "Foire aux vins", "March√© bio", "Antiquit√©s"],
  "Cin√©ma": ["Cin√© en plein air", "Avant-premi√®re", "Nuit du cin√©ma", "Court-m√©trage Festival", "Cin√©-concert"],
  "Th√©√¢tre": ["Com√©die moderne", "Drame classique", "Stand-up Comedy", "Improvisation", "One Man Show"],
  "Sport": ["Marathon urbain", "Trail des Alpes", "Tournoi de foot", "CrossFit Challenge", "Yoga au parc", "Course nocturne"],
  "Food": ["Street Food Festival", "Wine & Dine", "Brunch Party", "BBQ g√©ant", "D√©gustation", "Food Truck Rally"],
  "Expo": ["Art contemporain", "Photographie", "Vernissage", "Installation interactive", "Street Art Show"]
};

const VENUES = [
  "D! Club", "Usine", "Moods", "Kaufleuten", "Hive", "Supermarket", "MAD", "Folklor",
  "Les Docks", "L'Usine", "Espace culturel", "Salle communale", "Centre ville",
  "Parc des Bastions", "Plaine de Plainpalais", "Jardin Anglais", "Place F√©d√©rale",
  "Vieille ville", "Bord du lac", "Zone industrielle", "Ancien hangar"
];

const DESCRIPTIONS = [
  "Une soir√©e exceptionnelle avec les meilleurs artistes locaux et internationaux.",
  "Rejoignez-nous pour une exp√©rience unique dans un cadre incomparable.",
  "L'√©v√©nement incontournable de la saison, ne manquez pas √ßa !",
  "Ambiance garantie, sound system de qualit√©, dancefloor enflamm√©.",
  "Une programmation √©clectique pour tous les go√ªts.",
  "Venez d√©couvrir les talents √©mergents de la sc√®ne suisse.",
  "Un moment de partage et de convivialit√© entre passionn√©s.",
  "Production visuelle et sonore de haute qualit√©.",
  "L'endroit parfait pour passer une soir√©e m√©morable.",
  "√âv√©nement organis√© par des professionnels de l'√©v√©nementiel."
];

function generateRandomDate(daysFromNow, hoursVariation = 0) {
  const date = new Date();
  date.setDate(date.getDate() + daysFromNow);
  date.setHours(20 + Math.floor(Math.random() * 4) + hoursVariation);
  date.setMinutes(Math.random() > 0.5 ? 0 : 30);
  return date.toISOString().slice(0, 16);
}

// Extrait toutes les sous-cat√©gories les plus profondes d'un arbre
function extractDeepestCategories(tree, result = [], visited = new WeakSet(), depth = 0) {
  // Protection contre r√©cursion infinie
  if (depth > 50) {
    console.warn('‚ö†Ô∏è extractDeepestCategories: profondeur maximale atteinte');
    return result;
  }
  
  if (!tree) return result;
  
  // Protection contre r√©f√©rences circulaires
  if (typeof tree === 'object' && tree !== null) {
    if (visited.has(tree)) {
      return result; // D√©j√† visit√©, √©viter la boucle
    }
    visited.add(tree);
  }
  
  if (Array.isArray(tree)) {
    // C'est une liste de feuilles - les plus profondes !
    tree.forEach(item => {
      const name = typeof item === 'string' ? item : (item && item.name ? item.name : '');
      if (name && !result.includes(name)) {
        result.push(name);
      }
    });
    return result;
  }
  
  // Parcourir r√©cursivement seulement si c'est un objet
  if (typeof tree === 'object' && tree !== null) {
    for (const key in tree) {
      if (tree.hasOwnProperty(key)) {
        extractDeepestCategories(tree[key], result, visited, depth + 1);
      }
    }
  }
  
  return result;
}

// Fonction d√©sactiv√©e - les events viennent du backend uniquement
function generateEmergencyEvents() {
  console.log('Events charg√©s depuis le backend uniquement - pas de g√©n√©ration de faux events');
}

function ensureDemoPoints() {
  // Events et bookings viennent du backend uniquement - PAS de g√©n√©ration de faux data
  console.log(`ensureDemoPoints() - ${eventsData.length} events, ${bookingsData.length} bookings du backend`);
  calculatePlatinumRanks();
}

// Appeler le calcul des rangs Platinum apr√®s la g√©n√©ration des donn√©es
function finalizeDataGeneration() {
  // Assigner des rangs Platinum al√©atoires aux √©v√©nements platinum (pour la d√©mo)
  eventsData.forEach(ev => {
    if (ev.boost === "platinum" && !ev.platinumBid) {
      // Ench√®re al√©atoire entre 15 et 50 pour la d√©mo
      ev.platinumBid = 15 + Math.floor(Math.random() * 36);
    }
  });
  
  // Calculer les rangs par r√©gion
  calculatePlatinumRanks();
}

// ============================================
// BACKEND BRIDGE
// ============================================
window.updateBackendData = function (mode, data) {
  if (!Array.isArray(data)) data = [];
  if (mode === "event") eventsData = data;
  if (mode === "booking") bookingsData = data;
  if (mode === "service") servicesData = data;

  ensureDemoPoints();
  finalizeDataGeneration();
  filteredData = null;
  refreshMarkers();
  refreshListView();
};

// ============================================
// ACTIONS UTILISATEUR - LIKE / PARTAGER / AGENDA
// ============================================
function onBuyContact(type, id) {
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  openPaymentModal(type, id, "contact");
}

function onAction(action, type, id) {
  if (!currentUser.isLoggedIn && action !== "share") {
    openLoginModal();
    return;
  }

  switch(action) {
    case "like":
      toggleLike(type, id);
      break;
    case "favorite":
      toggleFavorite(type, id);
      break;
    case "participate":
      toggleParticipation(type, id);
      break;
    case "agenda":
      toggleAgenda(type, id);
      break;
    case "route":
      openRoute(type, id);
      break;
    case "avis":
      openReviewModal(type, id);
      break;
    case "share":
      shareItem(type, id);
      break;
    case "discussion":
      openDiscussionModal(type, id);
      break;
    case "report":
      openReportModal(type, id);
      break;
    default:
      console.log("Action non g√©r√©e:", action);
  }
}

// Toggle Like (juste le compteur, pas de sauvegarde)
async function toggleLike(type, id) {
  if (navigator.vibrate) navigator.vibrate(10);
  const key = `${type}:${id}`;
  const index = currentUser.likes.indexOf(key);
  
  const action = index > -1 ? 'remove' : 'add';
  
  // Appeler le backend
  try {
    const response = await fetch(`${window.API_BASE_URL}/user/likes`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id.toString(),
        itemId: id,
        itemMode: type,
        action: action
      })
    });
    
    if (response.ok) {
      if (action === 'add') {
        currentUser.likes.push(key);
        showNotification("üëç Like ajout√©", "success");
      } else {
        currentUser.likes.splice(index, 1);
        showNotification("üëé Like retir√©", "info");
      }
    }
  } catch (error) {
    console.error('Erreur toggleLike:', error);
    // Fallback local
    if (index > -1) {
      currentUser.likes.splice(index, 1);
      showNotification("üëé Like retir√©", "info");
    } else {
      currentUser.likes.push(key);
      showNotification("üëç Like ajout√©", "success");
    }
  }
  
  // Mettre √† jour l'affichage
  updateItemLikes(type, id, action === 'add' ? 1 : -1);
  refreshMarkers();
  
  // Rafra√Æchir la popup si elle est ouverte
  const backdrop = document.getElementById("popup-modal-backdrop");
  if (backdrop && backdrop.style.display !== "none") {
    const data = type === "event" ? eventsData : type === "booking" ? bookingsData : servicesData;
    const item = data.find(i => i.id === parseInt(id));
    if (item) {
      let popupHtml = "";
      if (type === "event") {
        popupHtml = buildEventPopup(item);
      } else if (type === "booking") {
        popupHtml = buildBookingPopup(item);
      } else if (type === "service") {
        popupHtml = buildServicePopup(item);
      }
      if (popupHtml) {
        const scrollContainer = document.getElementById("popup-scroll-container");
        if (scrollContainer) {
          const scrollTop = scrollContainer.scrollTop; // Sauvegarder la position
          scrollContainer.innerHTML = popupHtml;
          scrollContainer.scrollTop = scrollTop; // Restaurer la position
        }
      }
    }
  }
}

// Toggle Favorite (sauvegarde dans "Mes favoris", pas dans l'agenda)
async function toggleFavorite(type, id) {
  if (navigator.vibrate) navigator.vibrate(10);
  const key = `${type}:${id}`;
  
  // Trouver l'item pour obtenir son nom
  const data = type === 'event' ? eventsData : type === 'booking' ? bookingsData : servicesData;
  const item = data.find(i => i.id === id);
  if (!item) return;
  
  const favoriteName = item.title || item.name;
  const favoriteMode = type;
  
  // V√©rifier si d√©j√† en favoris
  const existingFavorite = currentUser.favorites.find(f => 
    f.id === id.toString() && f.mode === type
  );
  
  const action = existingFavorite ? 'remove' : 'add';
  
  // Appeler le backend
  try {
    const response = await fetch(`${window.API_BASE_URL}/user/favorites`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id.toString(),
        itemId: id,
        itemMode: type,
        action: action
      })
    });
    
    if (response.ok) {
      if (action === 'add') {
        // Ajouter aux favoris avec les infos n√©cessaires pour les alertes
        const favorite = {
          id: id.toString(),
          name: favoriteName,
          mode: favoriteMode,
          type: favoriteMode,
          lat: item.lat,
          lng: item.lng
        };
        currentUser.favorites.push(favorite);
        showNotification("‚≠ê Ajout√© aux favoris !", "success");
      } else {
        // Retirer des favoris
        const index = currentUser.favorites.findIndex(f => 
          f.id === id.toString() && f.mode === type
        );
        if (index > -1) {
          currentUser.favorites.splice(index, 1);
        }
        showNotification("üíî Retir√© des favoris", "info");
      }
      
      // Sauvegarder dans localStorage
      try {
        safeSetItem('currentUser', JSON.stringify(currentUser));
      } catch (e) {
        console.error('Erreur sauvegarde favoris:', e);
      }
    }
  } catch (error) {
    console.error('Erreur toggleFavorite:', error);
    // Fallback local
    if (existingFavorite) {
      const index = currentUser.favorites.findIndex(f => 
        f.id === id.toString() && f.mode === type
      );
      if (index > -1) {
        currentUser.favorites.splice(index, 1);
      }
      showNotification("üíî Retir√© des favoris", "info");
    } else {
      const favorite = {
        id: id.toString(),
        name: favoriteName,
        mode: favoriteMode,
        type: favoriteMode,
        lat: item.lat,
        lng: item.lng
      };
      currentUser.favorites.push(favorite);
      showNotification("‚≠ê Ajout√© aux favoris !", "success");
    }
  }
  
  refreshMarkers();
  
  // Rafra√Æchir la popup si elle est ouverte
  const backdrop = document.getElementById("popup-modal-backdrop");
  if (backdrop && backdrop.style.display !== "none") {
    if (item) {
      let popupHtml = "";
      if (type === "event") {
        popupHtml = buildEventPopup(item);
      } else if (type === "booking") {
        popupHtml = buildBookingPopup(item);
      } else if (type === "service") {
        popupHtml = buildServicePopup(item);
      }
      if (popupHtml) {
        const scrollContainer = document.getElementById("popup-scroll-container");
        if (scrollContainer) {
          const scrollTop = scrollContainer.scrollTop;
          scrollContainer.innerHTML = popupHtml;
          scrollContainer.scrollTop = scrollTop;
        }
      }
    }
  }
}

// Toggle Participation
function toggleParticipation(type, id) {
  // V√©rifier si l'utilisateur est connect√©
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  const key = `${type}:${id}`;
  const index = currentUser.participating.indexOf(key);
  
  // Trouver l'item pour mettre √† jour le compteur
  const data = type === "event" ? eventsData : type === "booking" ? bookingsData : servicesData;
  const item = data.find(i => i.id === parseInt(id));
  
  if (index > -1) {
    currentUser.participating.splice(index, 1);
    if (item) item.participants = Math.max(0, (item.participants || 0) - 1);
    showNotification("üö´ Participation annul√©e", "info");
  } else {
    currentUser.participating.push(key);
    if (item) item.participants = (item.participants || 0) + 1;
    // Ajouter aussi √† l'agenda automatiquement
    if (!currentUser.agenda.includes(key)) {
      currentUser.agenda.push(key);
    }
    showNotification("‚úÖ Participation confirm√©e ! Ajout√© √† votre agenda.", "success");
  }
  
  refreshMarkers();
  
  // Rafra√Æchir la popup si elle est ouverte
  const backdrop = document.getElementById("popup-modal-backdrop");
  if (backdrop && backdrop.style.display !== "none") {
    if (item) {
      let popupHtml = "";
      if (type === "event") {
        popupHtml = buildEventPopup(item);
      } else if (type === "booking") {
        popupHtml = buildBookingPopup(item);
      } else if (type === "service") {
        popupHtml = buildServicePopup(item);
      }
      if (popupHtml) {
        const scrollContainer = document.getElementById("popup-scroll-container");
        if (scrollContainer) {
          const scrollTop = scrollContainer.scrollTop; // Sauvegarder la position
          scrollContainer.innerHTML = popupHtml;
          scrollContainer.scrollTop = scrollTop; // Restaurer la position
        }
      }
    }
  }
  
  // Reconstruire la popup pour mettre √† jour le compteur
  if (item) {
    const marker = markersLayer.getLayers().find(m => m.options.itemId === id && m.options.itemType === type);
    if (marker) {
      marker.bindPopup(buildPopupHtml(item), { maxWidth: 400 });
      // R√©ajouter le gestionnaire pour intercepter l'ouverture
      marker.off('popupopen'); // Retirer l'ancien gestionnaire s'il existe
      marker.on('popupopen', function() {
        marker.closePopup();
        // Stocker le marqueur pour le recentrage √† la fermeture
        currentPopupMarker = marker;
        const popupContent = buildPopupHtml(item);
        openPopupModal(popupContent, item);
      });
    }
  }
}

// Toggle Agenda avec limite selon abonnement - PERSISTANT EN BASE DE DONN√âES
async function toggleAgenda(type, id) {
  // V√©rifier si l'utilisateur est connect√©
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  const key = `${type}:${id}`;
  const index = currentUser.agenda.indexOf(key);
  const action = index > -1 ? 'remove' : 'add';
  
  // V√©rifier limite AVANT d'appeler l'API (pour add)
  if (action === 'add') {
    const maxAgenda = getAgendaLimit();
    if (currentUser.agenda.length >= maxAgenda) {
      showNotification(`‚ö†Ô∏è Limite d'agenda atteinte (${maxAgenda} places). Retirez un √©v√©nement ou passez √† un abonnement sup√©rieur pour plus de places !`, "warning");
      openSubscriptionModal();
      return;
    }
  }
  
  // Appeler l'API pour persister en base
  try {
    const response = await fetch(`${window.API_BASE_URL}/user/agenda`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id.toString(),
        itemId: id,
        itemMode: type,
        action: action
      })
    });
    
    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error || 'Erreur API');
    }
  } catch (error) {
    console.error('[AGENDA] Erreur persistance:', error);
    showNotification("‚ùå Impossible de sauvegarder l'agenda. R√©essayez.", "error");
    return;
  }
  
  if (index > -1) {
    currentUser.agenda.splice(index, 1);
    if (typeof saveUserData === 'function') saveUserData();
    try { localStorage.setItem('user_agenda_backup', JSON.stringify(currentUser.agenda)); } catch(e) {}
    showNotification("üìÖ Retir√© de l'agenda", "info");
    refreshMarkers();
    refreshListView();
    if (agendaMiniWindowOpen) {
      showAgendaMiniWindow();
    }

    // Mettre √† jour le bouton agenda dans la popup sans tout reconstruire
    const backdrop = document.getElementById("popup-modal-backdrop");
    if (backdrop && backdrop.style.display !== "none") {
      const scrollContainer = document.getElementById("popup-scroll-container");
      if (scrollContainer) {
        const agendaBtns = scrollContainer.querySelectorAll('button');
        agendaBtns.forEach(btn => {
          if (btn.textContent.includes('agenda') || btn.textContent.includes('Agenda')) {
            if (btn.onclick && btn.onclick.toString().includes('agenda')) {
              btn.innerHTML = 'üìÖ ' + ((typeof window.t === 'function' ? window.t("agenda") : null) || "Agenda");
              btn.style.background = 'transparent';
              btn.style.color = 'var(--ui-text-main)';
              btn.style.borderColor = 'rgba(59,130,246,0.5)';
            }
          }
        });
      }
    }
  } else {
    currentUser.agenda.push(key);
    if (typeof saveUserData === 'function') saveUserData();
    try { localStorage.setItem('user_agenda_backup', JSON.stringify(currentUser.agenda)); } catch(e) {}
    refreshMarkers();
    refreshListView();

    // Mettre √† jour le bouton agenda dans la popup sans tout reconstruire
    const backdrop = document.getElementById("popup-modal-backdrop");
    if (backdrop && backdrop.style.display !== "none") {
      const scrollContainer = document.getElementById("popup-scroll-container");
      if (scrollContainer) {
        const agendaBtns = scrollContainer.querySelectorAll('button');
        agendaBtns.forEach(btn => {
          if (btn.textContent.includes('Agenda') && btn.onclick && btn.onclick.toString().includes('agenda')) {
            btn.innerHTML = 'üìÖ ' + ((typeof window.t === 'function' ? window.t("in_agenda") : null) || "Dans agenda");
            btn.style.background = 'rgba(59,130,246,0.2)';
            btn.style.color = '#3b82f6';
            btn.style.borderColor = 'rgba(59,130,246,0.5)';
          }
        });
      }
    }

    // Toast de confirmation en haut √† droite
    showAgendaConfirmToast();
  }
}

// Toast de confirmation d'ajout √† l'agenda (appara√Æt en haut √† droite)
function showAgendaConfirmToast() {
  const existing = document.getElementById('agenda-confirm-toast');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.id = 'agenda-confirm-toast';
  toast.innerHTML = `
    <div style="display:flex;align-items:flex-start;gap:12px;">
      <div style="font-size:28px;line-height:1;">‚úÖ</div>
      <div style="flex:1;">
        <div style="font-weight:700;font-size:15px;margin-bottom:4px;color:#fff;">Ajout√© √† votre agenda !</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.85);line-height:1.4;">Consultez vos √©v√©nements sauvegard√©s dans votre compte.</div>
        <button onclick="document.getElementById('agenda-confirm-toast').remove();if(typeof openAgendaModal==='function')openAgendaModal();" style="margin-top:8px;padding:6px 14px;border-radius:8px;border:none;background:rgba(255,255,255,0.2);color:#fff;font-size:12px;font-weight:600;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.35)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">üìÖ Voir mon agenda</button>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:rgba(255,255,255,0.6);font-size:18px;cursor:pointer;padding:0;line-height:1;">‚úï</button>
    </div>
  `;
  toast.style.cssText = `
    position:fixed;top:20px;right:20px;
    background:linear-gradient(135deg,#059669,#10b981);
    color:#fff;padding:16px 20px;border-radius:14px;
    font-size:14px;z-index:2147483647;
    box-shadow:0 8px 32px rgba(0,0,0,0.4);
    max-width:340px;min-width:280px;
    animation:slideInRight 0.35s ease;
    pointer-events:auto;
  `;

  if (!document.getElementById('agenda-toast-keyframes')) {
    const style = document.createElement('style');
    style.id = 'agenda-toast-keyframes';
    style.textContent = '@keyframes slideInRight{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes slideOutRight{from{transform:translateX(0);opacity:1}to{transform:translateX(120%);opacity:0}}';
    document.head.appendChild(style);
  }

  document.body.appendChild(toast);
  setTimeout(() => {
    if (toast.parentElement) {
      toast.style.animation = 'slideOutRight 0.35s ease forwards';
      setTimeout(() => toast.remove(), 350);
    }
  }, 5000);
}

// Obtenir la limite d'agenda selon l'abonnement
function getAgendaLimit() {
  const sub = currentUser.subscription || "free";
  switch(sub) {
    case "events-explorer": return 50;
    case "events-alerts-pro": return 200;
    case "service-pro": return 100;
    case "service-ultra": return 200;
    case "full-premium": return 250;
    default: return 20; // Gratuit
  }
}

// Obtenir la limite d'alertes selon l'abonnement
function getAlertLimit() {
  const sub = currentUser.subscription || "free";
  switch(sub) {
    case "events-explorer": return Infinity; // Illimit√© avec abo
    case "events-alerts-pro": return 200; // Jusqu'√† 200 alertes
    case "service-pro": return 0; // Pas d'alertes
    case "service-ultra": return 0; // Pas d'alertes
    case "full-premium": return Infinity; // Illimit√©
    default: return 2; // Gratuit = 2 alertes max
  }
}

// Obtenir la limite de SMS selon l'abonnement
function getSMSLimit() {
  const sub = currentUser.subscription || "free";
  switch(sub) {
    case "full-premium": return Infinity; // Illimit√© pour premium 25.-
    case "events-alerts-pro": return 10; // 10 SMS/mois
    case "events-explorer": return 10; // 10 SMS/mois
    default: return 0; // Gratuit = pas de SMS
  }
}

// V√©rifier si l'utilisateur peut recevoir des SMS
function canSendSMS() {
  const limit = getSMSLimit();
  if (limit === 0) return false;
  if (limit === Infinity) return true;
  return currentUser.smsNotifications < limit;
}

// V√©rifier les changements d'√©v√©nements et envoyer des alertes
// ‚ö†Ô∏è LES ALERTES DE STATUT (annul√©, complet, report√©) SONT TOUJOURS GRATUITES ET ILLIMIT√âES
function checkEventChanges() {
  if (!isLoggedIn()) return;
  
  // Les alertes de statut sont GRATUITES pour TOUS - pas de limite !
  // C'est vital pour l'utilisateur de savoir si un event est annul√©/complet/report√©
  
  // Initialiser les propri√©t√©s si elles sont undefined
  if (!currentUser.agenda) currentUser.agenda = [];
  if (!currentUser.participating) currentUser.participating = [];
  if (!currentUser.eventStatusHistory) currentUser.eventStatusHistory = {};
  
  // V√©rifier tous les √©v√©nements dans l'agenda ET dans participating de l'utilisateur
  const eventKeys = [...new Set([...currentUser.agenda, ...currentUser.participating])];
  
  eventKeys.forEach(key => {
    if (!key.startsWith('event:')) return;
    
    const eventId = parseInt(key.split(':')[1]);
    const event = eventsData.find(e => e.id === eventId);
    if (!event) return;
    
    const previousStatus = currentUser.eventStatusHistory[eventId] || event.status || 'OK';
    const currentStatus = event.status || 'OK';
    
    // D√©tecter un changement de statut
    if (previousStatus !== currentStatus) {
      // Mettre √† jour l'historique
      currentUser.eventStatusHistory[eventId] = currentStatus;
      
      // V√©rifier si c'est un changement important (report√©, annul√©, etc.)
      const importantStatuses = ['REPORT√â', 'REPORTE', 'ANNULE', 'ANNUL√â', 'COMPLET', 'SOLDOUT'];
      if (importantStatuses.includes(currentStatus)) {
        const statusText = currentStatus === 'REPORT√â' || currentStatus === 'REPORTE' ? 'report√©' :
                          currentStatus === 'ANNULE' || currentStatus === 'ANNUL√â' ? 'annul√©' :
                          currentStatus === 'COMPLET' || currentStatus === 'SOLDOUT' ? 'complet' : currentStatus;
        
        // Si l'utilisateur a particip√© √† cet √©v√©nement, stocker la notification pour l'afficher au login
        const hasParticipated = currentUser.participating.includes(key);
        if (hasParticipated) {
          // V√©rifier si cette notification n'existe pas d√©j√†
          const existingNotification = currentUser.pendingStatusNotifications.find(n => n.eventId === eventId);
          if (!existingNotification) {
            currentUser.pendingStatusNotifications.push({
              eventId: eventId,
              eventTitle: event.title,
              status: currentStatus,
              statusText: statusText,
              timestamp: new Date().toISOString()
            });
            saveUser();
          }
        }
        
        // Afficher une notification imm√©diate si l'utilisateur est connect√©
        if (currentUser && currentUser.isLoggedIn) {
          showNotification(`üîî Changement d'√©v√©nement : "${event.title}" a √©t√© ${statusText}`, "warning");
        }
        
        // Si l'utilisateur a un abonnement avec notifications push/email, on pourrait aussi envoyer une notification push/email ici
        if (currentUser.subscription === 'events-alerts-pro' || currentUser.subscription === 'full-premium') {
          // Logique pour notifications push/email (√† impl√©menter avec le backend)
          console.log(`üìß Notification push/email pour changement d'√©v√©nement: ${event.title} - ${statusText}`);
        }
      }
    } else {
      // Initialiser l'historique si c'est la premi√®re fois qu'on v√©rifie cet √©v√©nement
      if (!currentUser.eventStatusHistory[eventId]) {
        currentUser.eventStatusHistory[eventId] = currentStatus;
      }
    }
  });
}

// Initialiser l'historique des statuts au chargement
function initEventStatusHistory() {
  eventsData.forEach(ev => {
    if (!currentUser.eventStatusHistory[ev.id]) {
      currentUser.eventStatusHistory[ev.id] = ev.status || 'OK';
    }
  });
}

// Mettre √† jour les likes d'un item
function updateItemLikes(type, id, delta) {
  let data = type === "event" ? eventsData : type === "booking" ? bookingsData : servicesData;
  const item = data.find(i => i.id === parseInt(id));
  if (item) {
    item.likes = (item.likes || 0) + delta;
  }
}

// R√©cup√©rer un item par son type et ID
function getItemById(type, id) {
  if (type === "event") {
    return eventsData.find(e => e.id === id);
  } else if (type === "booking") {
    return bookingsData.find(b => b.id === id);
  } else if (type === "service") {
    return servicesData.find(s => s.id === id);
  }
  return null;
}

// Inviter des amis √† un √©v√©nement/booking/service
function inviteFriendsToEvent(type, id) {
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  const item = getItemById(type, id);
  if (!item) return;
  
  // Utiliser le nouveau syst√®me d'invitation par API
  openInviteFriendsModal(type, id, item.title || item.name || '√âv√©nement');
  return;
  
  // --- Ancien code local ci-dessous (d√©sactiv√©) ---
  const friendsList = currentUser.friends || [];
  if (friendsList.length === 0) {
    showNotification("üë• Vous n'avez pas encore d'amis. Ajoutez-en depuis le menu Amis !", "info");
    openFriendsModal();
    return;
  }
  
  initDemoUsers();
  const friendsInfo = friendsList.map(friendId => {
    return allUsers.find(u => u.id === friendId) || { id: friendId, name: 'Ami', avatar: 'üë§' };
  });
  
  const itemTitle = item.title || item.name || '√âl√©ment';
  const itemTypeLabel = type === 'event' ? '√©v√©nement' : type === 'booking' ? 'artiste' : 'service';
  
  const html = `
    <div style="padding:20px;max-width:550px;margin:0 auto;max-height:85vh;overflow-y:auto;">
      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:40px;margin-bottom:8px;">‚ûï</div>
        <h2 style="margin:0;font-size:22px;font-weight:700;color:#fff;">Inviter des amis</h2>
        <p style="color:var(--ui-text-muted);margin-top:6px;font-size:13px;">${escapeHtml(itemTitle)}</p>
      </div>
      
      <div style="margin-bottom:16px;">
        <label style="display:block;font-size:13px;font-weight:600;color:#fff;margin-bottom:8px;">üîç Rechercher un ami</label>
        <input type="text" id="invite-search-friends" placeholder="Nom d'ami..." 
               onkeyup="filterInviteFriends(this.value)"
               style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:14px;">
      </div>
      
      <div id="invite-friends-list" style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;">
        ${friendsInfo.map(friend => `
          <div id="invite-friend-${friend.id}" style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(15,23,42,0.5);border-radius:12px;border:1px solid var(--ui-card-border);">
            <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:24px;">${friend.avatar}</div>
            <div style="flex:1;">
              <div style="font-weight:600;font-size:14px;color:#fff;">${escapeHtml(friend.name)}</div>
              <div style="font-size:11px;color:var(--ui-text-muted);">${friend.isOnline ? 'üü¢ En ligne' : '‚ö´ Hors ligne'}</div>
            </div>
            <button onclick="sendInvitationToFriend('${friend.id}', '${escapeHtml(friend.name)}', '${friend.avatar}', '${type}', ${id})" 
                    style="padding:8px 14px;border-radius:8px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-size:12px;font-weight:600;cursor:pointer;">
              Inviter
            </button>
          </div>
        `).join('')}
      </div>
      
      <button onclick="closePublishModal()" style="width:100%;padding:12px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-weight:600;">
        Fermer
      </button>
    </div>
  `;
  
  showModalWithContent(html);
}

// Filtrer les amis lors de l'invitation
function filterInviteFriends(query) {
  const friendsList = currentUser.friends || [];
  initDemoUsers();
  
  const filtered = friendsList
    .map(friendId => allUsers.find(u => u.id === friendId))
    .filter(friend => {
      if (!friend) return false;
      if (!query || query.trim() === '') return true;
      return friend.name.toLowerCase().includes(query.toLowerCase());
    });
  
  const container = document.getElementById("invite-friends-list");
  if (!container) return;
  
  container.innerHTML = filtered.map(friend => `
    <div id="invite-friend-${friend.id}" style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(15,23,42,0.5);border-radius:12px;border:1px solid var(--ui-card-border);">
      <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:24px;">${friend.avatar}</div>
      <div style="flex:1;">
        <div style="font-weight:600;font-size:14px;color:#fff;">${escapeHtml(friend.name)}</div>
        <div style="font-size:11px;color:var(--ui-text-muted);">${friend.isOnline ? 'üü¢ En ligne' : '‚ö´ Hors ligne'}</div>
      </div>
      <button onclick="sendInvitationToFriend('${friend.id}', '${escapeHtml(friend.name)}', '${friend.avatar}', 'event', 0)" 
              style="padding:8px 14px;border-radius:8px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-size:12px;font-weight:600;cursor:pointer;">
        Inviter
      </button>
    </div>
  `).join('');
}

// Envoyer une invitation √† un ami
function sendInvitationToFriend(friendId, friendName, friendAvatar, type, id) {
  const item = getItemById(type, id);
  if (!item) return;
  
  const itemTitle = item.title || item.name || '√âl√©ment';
  const itemTypeLabel = type === 'event' ? '√©v√©nement' : type === 'booking' ? 'artiste' : 'service';
  
  // Cr√©er une alerte sociale pour l'ami
  if (!window.userAlerts) window.userAlerts = {};
  if (!window.userAlerts[friendId]) window.userAlerts[friendId] = [];
  
  window.userAlerts[friendId].push({
    type: 'event_invitation',
    fromUserId: currentUser.id,
    fromUserName: currentUser.name,
    fromUserAvatar: currentUser.avatar,
    eventType: type,
    eventId: id,
    eventTitle: itemTitle,
    message: `${currentUser.name} vous invite √† d√©couvrir cet ${itemTypeLabel}`,
    date: new Date().toISOString(),
    read: false,
    icon: 'üéâ'
  });
  
  showNotification(`‚úÖ Invitation envoy√©e √† ${friendName} !`, "success");
  
  // Mettre √† jour le bouton
  const button = document.querySelector(`#invite-friend-${friendId} button`);
  if (button) {
    button.textContent = '‚úÖ Invit√©';
    button.style.background = '#22c55e';
    button.disabled = true;
  }
}

// Ouvrir le profil utilisateur complet
function openUserProfile(userId = null) {
  if (!currentUser.isLoggedIn && !userId) {
    openLoginModal();
    return;
  }
  
  const targetUserId = userId || currentUser.id;
  const isOwnProfile = targetUserId === currentUser.id;
  
  initDemoUsers();
  const targetUser = allUsers.find(u => u.id === targetUserId) || currentUser;
  
  const profilePhotos = targetUser.profilePhotos || [];
  const profileVideos = targetUser.profileVideos || [];
  const bio = targetUser.bio || '';
  const friendsCount = targetUser.friends?.length || 0;
  const eventsCount = targetUser.participating?.filter(p => p.startsWith('event:')).length || 0;
  
  const html = `
    <div style="padding:20px;max-width:700px;margin:0 auto;max-height:85vh;overflow-y:auto;">
      <!-- Header du profil -->
      <div style="text-align:center;margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid var(--ui-card-border);">
        <div style="width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:60px;margin:0 auto 16px;border:4px solid rgba(0,255,195,0.3);overflow:hidden;position:relative;">
          ${(() => {
            const avatarUrl = targetUser.profile_photo_url || targetUser.profilePhoto || targetUser.avatarUrl || targetUser.avatar;
            if (avatarUrl && (avatarUrl.startsWith('http') || avatarUrl.startsWith('data:image'))) {
              return `<img src="${avatarUrl}" style="width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;" onerror="this.style.display='none';this.parentElement.innerHTML='${targetUser.avatar || 'üë§'}';this.parentElement.style.fontSize='60px';" />`;
            }
            return targetUser.avatar || 'üë§';
          })()}
        </div>
        <h2 style="margin:0 0 8px;font-size:28px;font-weight:700;color:#fff;">${escapeHtml(targetUser.name)}</h2>
        ${targetUser.firstName && targetUser.lastName ? `
          <div style="font-size:14px;color:var(--ui-text-muted);margin-bottom:12px;">
            ${escapeHtml(targetUser.firstName)} ${escapeHtml(targetUser.lastName)}
          </div>
        ` : ''}
        ${bio ? `<div style="font-size:14px;color:var(--ui-text-main);line-height:1.6;max-width:500px;margin:0 auto;">${escapeHtml(bio)}</div>` : ''}
        
        ${isOwnProfile ? `
          <button onclick="editProfile()" style="margin-top:16px;padding:10px 20px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);font-weight:600;cursor:pointer;">
            ‚úèÔ∏è Modifier le profil
          </button>
        ` : `
          <div style="display:flex;gap:8px;justify-content:center;margin-top:16px;">
            ${currentUser.friends?.includes(targetUserId) ? `
              <button onclick="openChatWith('${targetUserId}')" style="padding:10px 20px;border-radius:999px;border:none;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-weight:600;cursor:pointer;">
                üí¨ Message
              </button>
            ` : `
              <button onclick="sendFriendRequest('${targetUserId}', '${escapeHtml(targetUser.name)}', '${targetUser.avatar}')" style="padding:10px 20px;border-radius:999px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-weight:600;cursor:pointer;">
                ‚ûï Ajouter comme ami
              </button>
            `}
          </div>
        `}
      </div>
      
      <!-- Stats -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;">
        <div style="text-align:center;padding:16px;background:rgba(15,23,42,0.5);border-radius:12px;border:1px solid var(--ui-card-border);">
          <div style="font-size:24px;font-weight:700;color:#00ffc3;">${friendsCount}</div>
          <div style="font-size:12px;color:var(--ui-text-muted);margin-top:4px;">Amis</div>
        </div>
        <div style="text-align:center;padding:16px;background:rgba(15,23,42,0.5);border-radius:12px;border:1px solid var(--ui-card-border);">
          <div style="font-size:24px;font-weight:700;color:#3b82f6;">${eventsCount}</div>
          <div style="font-size:12px;color:var(--ui-text-muted);margin-top:4px;">√âv√©nements</div>
        </div>
        <div style="text-align:center;padding:16px;background:rgba(15,23,42,0.5);border-radius:12px;border:1px solid var(--ui-card-border);">
          <div style="font-size:24px;font-weight:700;color:#f59e0b;">${(targetUser.likes || []).length}</div>
          <div style="font-size:12px;color:var(--ui-text-muted);margin-top:4px;">Likes</div>
        </div>
      </div>
      
      <!-- Photos -->
      ${profilePhotos.length > 0 ? `
        <div style="margin-bottom:24px;">
          <h3 style="margin:0 0 12px 0;font-size:18px;font-weight:600;color:#fff;">üì∏ Photos</h3>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
            ${profilePhotos.slice(0, 9).map(photo => `
              <div style="aspect-ratio:1;border-radius:12px;overflow:hidden;background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);cursor:pointer;"
                   onclick="viewPhoto('${photo}')">
                <img src="${photo}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      <!-- Vid√©os -->
      ${profileVideos.length > 0 ? `
        <div style="margin-bottom:24px;">
          <h3 style="margin:0 0 12px 0;font-size:18px;font-weight:600;color:#fff;">üé• Vid√©os</h3>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
            ${profileVideos.slice(0, 4).map(video => `
              <div style="aspect-ratio:16/9;border-radius:12px;overflow:hidden;background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);cursor:pointer;position:relative;"
                   onclick="viewVideo('${video}')">
                <img src="${video.thumbnail || ''}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">
                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:48px;height:48px;border-radius:50%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;font-size:24px;">‚ñ∂Ô∏è</div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      <button onclick="closePublishModal()" style="width:100%;padding:12px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-weight:600;">
        Fermer
      </button>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
}

// Modifier le profil
function editProfile() {
  const html = `
    <div style="padding:24px;max-width:500px;margin:0 auto;max-height:85vh;overflow-y:auto;">
      <h2 style="margin:0 0 20px 0;font-size:22px;font-weight:700;color:#fff;">Modifier le profil</h2>
      
      <div style="margin-bottom:16px;">
        <label style="display:block;font-size:14px;font-weight:600;color:#fff;margin-bottom:8px;">Bio</label>
        <textarea id="edit-profile-bio" placeholder="D√©crivez-vous..." rows="4"
                  style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:14px;resize:none;">${currentUser.bio || ''}</textarea>
      </div>
      
      <div style="margin-bottom:20px;">
        <label style="display:block;font-size:14px;font-weight:600;color:#fff;margin-bottom:8px;">Photos (URLs, une par ligne)</label>
        <textarea id="edit-profile-photos" placeholder="https://exemple.com/photo1.jpg&#10;https://exemple.com/photo2.jpg" rows="3"
                  style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:14px;resize:none;">${(currentUser.profilePhotos || []).join('\\n')}</textarea>
      </div>
      
      <div style="display:flex;gap:12px;">
        <button onclick="openUserProfile()" style="flex:1;padding:12px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-weight:600;">
          Annuler
        </button>
        <button onclick="saveProfile()" style="flex:1;padding:12px;border-radius:999px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-weight:700;cursor:pointer;">
          Enregistrer
        </button>
      </div>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
}

// G√©rer l'upload de photo dans le formulaire de modification
window.handleEditProfilePhotoUpload = function(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (file.size > 5 * 1024 * 1024) {
    showNotification('‚ö†Ô∏è La photo doit faire moins de 5MB', 'warning');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const previewContainer = document.getElementById('edit-profile-photo-preview-container');
    const previewImg = document.getElementById('edit-profile-photo-preview');
    
    if (previewImg) {
      previewImg.src = e.target.result;
    }
    if (previewContainer) {
      previewContainer.style.display = 'block';
    }
    
    // Stocker temporairement la photo pour l'upload
    window.editProfilePhotoFile = file;
  };
  reader.readAsDataURL(file);
};

// Configurer l'autocomplete d'adresse pour le formulaire de modification
function setupEditProfileAddressAutocomplete(inputElement) {
  let timeout;
  const suggestionsContainer = document.getElementById('edit-profile-address-suggestions');
  const selectedDisplay = document.getElementById('edit-profile-selected-address-display');
  const selectedLabel = document.getElementById('edit-profile-selected-address-label');
  const selectedDetails = document.getElementById('edit-profile-selected-address-details');
  
  inputElement.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    clearTimeout(timeout);
    
    if (query.length < 3) {
      if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
      }
      return;
    }
    
    timeout = setTimeout(async () => {
      try {
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è RECHERCHE MONDIALE - Pas de restriction de pays, support multilingue
        const langCode = (navigator.language || 'fr').split('-')[0];
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&addressdetails=1&accept-language=${langCode},en&dedupe=1`, {
          headers: {
            'User-Agent': 'MapEventAI/1.0',
            'Accept-Language': `${langCode},en,fr`
          }
        });
        
        if (!response.ok) {
          if (suggestionsContainer) {
            suggestionsContainer.style.display = 'none';
          }
          return;
        }
        
        const text = await response.text();
        let results;
        try {
          results = JSON.parse(text);
        } catch (parseError) {
          if (suggestionsContainer) {
            suggestionsContainer.style.display = 'none';
          }
          return;
        }
        
        if (suggestionsContainer && results.length > 0) {
          const sortedResults = results.sort((a, b) => {
            const aHasFullAddress = a.address?.road && (a.address?.house_number || a.address?.house);
            const bHasFullAddress = b.address?.road && (b.address?.house_number || b.address?.house);
            if (aHasFullAddress && !bHasFullAddress) return -1;
            if (!aHasFullAddress && bHasFullAddress) return 1;
            return 0;
          });
          
          suggestionsContainer.innerHTML = sortedResults.map(result => {
            const hasFullAddress = result.address?.road && (result.address?.house_number || result.address?.house);
            const addressQuality = hasFullAddress ? '‚úÖ' : 'üìç';
            return `
            <div class="edit-profile-address-suggestion" style="padding:12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.1);transition:background 0.2s;" 
                 onmouseover="this.style.background='rgba(0,255,195,0.1)'" 
                 onmouseout="this.style.background='transparent'"
                 data-lat="${result.lat}" 
                 data-lng="${result.lon}"
                 data-label="${result.display_name}"
                 data-country="${result.address?.country_code?.toUpperCase() || ''}"
                 data-city="${result.address?.city || result.address?.town || result.address?.village || ''}"
                 data-postcode="${result.address?.postcode || ''}"
                 data-street="${result.address?.road || ''}">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <span style="font-size:14px;">${addressQuality}</span>
                <div style="font-weight:600;color:var(--ui-text-main);font-size:13px;flex:1;">${result.display_name}</div>
              </div>
              <div style="font-size:11px;color:var(--ui-text-muted);padding-left:22px;">${result.address?.country || ''}${result.address?.postcode ? ' ‚Ä¢ ' + result.address.postcode : ''}</div>
            </div>
          `;
          }).join('');
          
          suggestionsContainer.style.display = 'block';
          
          suggestionsContainer.querySelectorAll('.edit-profile-address-suggestion').forEach(suggestion => {
            suggestion.addEventListener('click', function() {
              const addressData = {
                lat: parseFloat(this.dataset.lat),
                lng: parseFloat(this.dataset.lng),
                label: this.dataset.label,
                country_code: this.dataset.country,
                city: this.dataset.city,
                postcode: this.dataset.postcode,
                street: this.dataset.street
              };
              
              window.editProfileSelectedAddress = addressData;
              
              if (inputElement) {
                inputElement.value = addressData.label;
              }
              if (suggestionsContainer) {
                suggestionsContainer.style.display = 'none';
              }
              if (selectedDisplay) {
                selectedDisplay.style.display = 'block';
              }
              if (selectedLabel) {
                selectedLabel.textContent = addressData.label;
              }
              if (selectedDetails) {
                selectedDetails.textContent = `${addressData.city || ''} ${addressData.postcode || ''} ${addressData.country_code || ''}`.trim();
              }
            });
          });
        } else if (suggestionsContainer) {
          suggestionsContainer.style.display = 'none';
        }
      } catch (error) {
        console.error('[EDIT PROFILE] Erreur autocomplete adresse:', error);
      }
    }, 300);
  });
}

// Sauvegarder le profil
async function saveProfile() {
  const username = document.getElementById("edit-profile-username")?.value.trim() || '';
  const bio = document.getElementById("edit-profile-bio")?.value.trim() || '';
  const photosText = document.getElementById("edit-profile-photos")?.value.trim() || '';
  const photos = photosText.split('\n').filter(url => url.trim() && url.startsWith('http'));
  
  // Upload de la nouvelle photo si pr√©sente
  if (window.editProfilePhotoFile) {
    try {
      await uploadProfilePhoto(window.editProfilePhotoFile);
      showNotification("‚úÖ Photo de profil mise √† jour !", "success");
    } catch (error) {
      console.error('[EDIT PROFILE] Erreur upload photo:', error);
      showNotification("‚ö†Ô∏è Erreur lors de l'upload de la photo", "error");
    }
  }
  
  // Sauvegarder l'adresse si modifi√©e
  if (window.editProfileSelectedAddress) {
    try {
      await saveUserAddress(window.editProfileSelectedAddress);
    } catch (error) {
      console.error('[EDIT PROFILE] Erreur sauvegarde adresse:', error);
      showNotification("‚ö†Ô∏è Erreur lors de la sauvegarde de l'adresse", "error");
    }
  }
  
  // Mettre √† jour le nom d'utilisateur si modifi√©
  if (username && username !== currentUser.username) {
    try {
      const response = await fetch(`${window.API_BASE_URL}/user/profile-settings`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getAuthToken()}`
        },
        body: JSON.stringify({ username })
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.user) {
          currentUser.username = data.user.username;
        }
      } else {
        const errorData = await response.json();
        if (errorData.error && errorData.error.includes('d√©j√† pris')) {
          showNotification("‚ö†Ô∏è Ce nom d'utilisateur est d√©j√† pris", "error");
          return;
        }
      }
    } catch (error) {
      console.error('[EDIT PROFILE] Erreur mise √† jour username:', error);
    }
  }
  
  // V√©rifier l'√¢ge des photos (simulation - en production, utiliser une API de mod√©ration)
  const photosFiltered = photos.filter(photo => {
    return true; // Pour l'instant, on accepte tout
  });
  
  currentUser.bio = bio;
  currentUser.profilePhotos = photosFiltered;
  
  // Recharger les donn√©es utilisateur depuis l'API
  await loadCurrentUserFromAPI();
  
  saveUserData();
  showNotification("‚úÖ Profil mis √† jour !", "success");
  openUserProfile();
}

// Voir une photo en grand
function viewPhoto(photoUrl) {
  const html = `
    <div style="padding:20px;text-align:center;">
      <img src="${photoUrl}" style="max-width:100%;max-height:70vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
      <button onclick="closePublishModal()" style="margin-top:20px;padding:12px 24px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-weight:600;">
        Fermer
      </button>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
}

// Voir une vid√©o
function viewVideo(videoUrl) {
  const html = `
    <div style="padding:20px;text-align:center;">
      <video controls style="max-width:100%;max-height:70vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
        <source src="${videoUrl}" type="video/mp4">
        Votre navigateur ne supporte pas la lecture de vid√©os.
      </video>
      <button onclick="closePublishModal()" style="margin-top:20px;padding:12px 24px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-weight:600;">
        Fermer
      </button>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
}

// Itin√©raire direct
function openRoute(type, id) {
  const item = getItemById(type, id);
  if (!item) return;
  
  const address = item.address || `${item.lat},${item.lng}`;
  const encodedAddress = encodeURIComponent(address);
  
  // Ouvrir Google Maps avec l'itin√©raire
  const url = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
  window.open(url, '_blank');
  
  showNotification("üó∫Ô∏è Itin√©raire ouvert dans Google Maps", "success");
}

// Partager
function shareItem(type, id) {
  // R√©cup√©rer les infos de l'item
  // Cette fonction fonctionne pour TOUS les types d'√©v√©nements :
  // - √âv√©nements de test
  // - √âv√©nements r√©els
  // - √âv√©nements g√©n√©r√©s par IA
  // - Bookings
  // - Services
  let item = null;
  let title = "D√©couvrez cet √©v√©nement sur MapEvent !";
  
  if (type === "event") {
    item = eventsData.find(e => e.id === id);
    if (item) {
      // Utiliser le titre de l'√©v√©nement (fonctionne pour test, r√©el, AI)
      title = item.title || item.name || title;
    }
  } else if (type === "booking") {
    item = bookingsData.find(b => b.id === id);
    if (item) title = item.title || item.name || title;
  } else if (type === "service") {
    item = servicesData.find(s => s.id === id);
    if (item) title = item.title || item.name || title;
  }
  
  // Mettre √† jour les m√©tadonn√©es Open Graph pour le partage
  // Ces m√©tadonn√©es seront utilis√©es par Facebook, Twitter, LinkedIn, etc.
  if (item) {
    updateOpenGraphMetadata(type, id, item);
    console.log(`‚úÖ Partage de ${type} ${id}: "${title}"`);
  } else {
    console.warn(`‚ö†Ô∏è ${type} ${id} non trouv√© pour le partage`);
  }
  
  shareItemModal(type, id, item, title);
}

// Mettre √† jour les m√©tadonn√©es Open Graph pour le partage social
function updateOpenGraphMetadata(type, id, item) {
  const baseUrl = window.location.origin + window.location.pathname;
  const shareUrl = `${baseUrl}?${type}=${id}`;
  
  // Obtenir l'image de l'√©v√©nement
  const imageCandidates = getImageCandidatesForItem(item);
  let imageUrl = imageCandidates[0] || OVERLAY_IMAGES.DEFAULT;
  
  // S'assurer que l'URL de l'image est absolue et compl√®te
  if (!imageUrl.startsWith('http')) {
    // Si l'URL est relative, la rendre absolue
    if (imageUrl.startsWith('/')) {
      imageUrl = window.location.origin + imageUrl;
    } else {
      imageUrl = window.location.origin + '/' + imageUrl;
    }
  }
  
  // Obtenir la description optimis√©e pour les r√©seaux sociaux
  let description = '';
  if (item.description) {
    description = item.description.length > 200 
      ? item.description.substring(0, 197) + '...' 
      : item.description;
  } else {
    const dateStr = item.startDate 
      ? new Date(item.startDate).toLocaleDateString('fr-FR', { 
          weekday: 'long', 
          day: 'numeric', 
          month: 'long',
          year: 'numeric'
        })
      : '';
    const locationStr = item.city || item.address || 'Suisse';
    description = `${dateStr ? dateStr + ' - ' : ''}${locationStr} | D√©couvrez cet √©v√©nement sur MapEvent`;
  }
  
  // Cr√©er un titre optimis√© avec le titre de l'√©v√©nement en premier
  // Fonctionne pour TOUS les types d'√©v√©nements : test, r√©el, AI, etc.
  const eventTitle = item.title || item.name || '√âv√©nement';
  // Le titre doit √™tre le titre de l'√©v√©nement uniquement (sans suffixe)
  // Cela fonctionne pour les √©v√©nements de test ET les vrais √©v√©nements
  const title = eventTitle.trim(); // Titre principal = titre de l'√©v√©nement uniquement
  
  // Description enrichie avec date et lieu pour plus de contexte
  let enrichedDescription = description;
  if (item.startDate) {
    const dateStr = new Date(item.startDate).toLocaleDateString('fr-FR', { 
      weekday: 'long', 
      day: 'numeric', 
      month: 'long',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    const locationStr = item.city || item.address || '';
    if (locationStr) {
      enrichedDescription = `${dateStr} - ${locationStr}${description ? ' | ' + description : ''}`;
    } else {
      enrichedDescription = `${dateStr}${description ? ' | ' + description : ''}`;
    }
  }
  
  // Mettre √† jour les m√©tadonn√©es Open Graph (Facebook, LinkedIn, etc.)
  // IMPORTANT: Ces m√©tadonn√©es fonctionnent pour TOUS les types d'√©v√©nements
  // (test, r√©el, AI, etc.) car elles utilisent les propri√©t√©s standard (title, description, etc.)
  updateMetaTag('og:url', shareUrl);
  updateMetaTag('og:title', title);
  updateMetaTag('og:description', enrichedDescription);
  updateMetaTag('og:image', imageUrl);
  updateMetaTag('og:image:width', '1200');
  updateMetaTag('og:image:height', '630');
  updateMetaTag('og:image:type', 'image/jpeg');
  updateMetaTag('og:type', 'website');
  updateMetaTag('og:site_name', 'MapEvent');
  updateMetaTag('og:locale', 'fr_FR');
  
  // Log pour debug (peut √™tre retir√© en production)
  console.log(`üì± M√©tadonn√©es Open Graph mises √† jour:`, {
    title: title,
    description: enrichedDescription.substring(0, 50) + '...',
    image: imageUrl.substring(0, 50) + '...',
    url: shareUrl
  });
  
  // Mettre √† jour les m√©tadonn√©es Twitter Card
  updateMetaTag('twitter:url', shareUrl);
  updateMetaTag('twitter:title', title);
  updateMetaTag('twitter:description', enrichedDescription);
  updateMetaTag('twitter:image', imageUrl);
  updateMetaTag('twitter:card', 'summary_large_image');
  updateMetaTag('twitter:site', '@mapevent');
  
  // Mettre √† jour la meta description standard
  updateMetaTag('description', enrichedDescription, 'name');
  
  // Mettre √† jour le titre de la page avec le titre de l'√©v√©nement
  document.title = title;
  
  // Ajouter aussi un meta title pour certains r√©seaux sociaux
  updateMetaTag('title', title, 'name');
  
  // Ajouter un lien canonique pour √©viter les doublons
  let canonical = document.querySelector('link[rel="canonical"]');
  if (!canonical) {
    canonical = document.createElement('link');
    canonical.setAttribute('rel', 'canonical');
    document.head.appendChild(canonical);
  }
  canonical.setAttribute('href', shareUrl);
}

// Fonction utilitaire pour mettre √† jour les m√©tadonn√©es
function updateMetaTag(property, content, attribute = 'property') {
  let meta = document.querySelector(`meta[${attribute}="${property}"]`);
  if (!meta) {
    meta = document.createElement('meta');
    meta.setAttribute(attribute, property);
    document.head.appendChild(meta);
  }
  meta.setAttribute('content', content);
}

// V√©rifier les param√®tres URL et mettre √† jour les m√©tadonn√©es Open Graph
function checkUrlParamsAndUpdateMetadata() {
  const urlParams = new URLSearchParams(window.location.search);
  const eventId = urlParams.get('event');
  const bookingId = urlParams.get('booking');
  const serviceId = urlParams.get('service');
  
  // Fonction pour essayer de mettre √† jour les m√©tadonn√©es
  function tryUpdateMetadata(maxAttempts = 15) {
    let attempts = 0;
    const checkInterval = setInterval(() => {
      attempts++;
      let item = null;
      let type = null;
      let id = null;
      
      if (eventId && eventsData && eventsData.length > 0) {
        item = eventsData.find(e => e.id === parseInt(eventId));
        type = 'event';
        id = parseInt(eventId);
      } else if (bookingId && bookingsData && bookingsData.length > 0) {
        item = bookingsData.find(b => b.id === parseInt(bookingId));
        type = 'booking';
        id = parseInt(bookingId);
      } else if (serviceId && servicesData && servicesData.length > 0) {
        item = servicesData.find(s => s.id === parseInt(serviceId));
        type = 'service';
        id = parseInt(serviceId);
      }
      
      if (item && type && id) {
        clearInterval(checkInterval);
        console.log(`‚úÖ Mise √† jour des m√©tadonn√©es Open Graph pour ${type} ${id}`);
        updateOpenGraphMetadata(type, id, item);
      } else if (attempts >= maxAttempts) {
        clearInterval(checkInterval);
        console.warn(`‚ö†Ô∏è Impossible de mettre √† jour les m√©tadonn√©es apr√®s ${maxAttempts} tentatives`);
      }
    }, 300); // V√©rifier toutes les 300ms
  }
  
  // Commencer imm√©diatement
  tryUpdateMetadata();
}

window.checkUrlParamsAndUpdateMetadata = checkUrlParamsAndUpdateMetadata;
window.updateOpenGraphMetadata = updateOpenGraphMetadata;
window.updateMetaTag = updateMetaTag;

// Fonction pour cr√©er le modal de partage (s√©par√©e pour r√©utilisation)
function shareItemModal(type, id, item, title) {
  
  // URL de partage via l'API pour que les crawlers sociaux (Facebook, Twitter) voient les bonnes meta OG
  const shareUrl = `${window.API_BASE_URL}/share/${type}/${id}`;
  // URL directe pour le clipboard et le navigateur
  const url = shareUrl;

  // Sur mobile, essayer l'API Web Share native (menu syst√®me du t√©l√©phone)
  const isMobile = window.innerWidth <= 768 || /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
  if (isMobile && navigator.share) {
    navigator.share({
      title: title || 'MapEvent',
      text: title + ' ‚Äî sur MapEvent',
      url: url
    }).catch(function() { /* utilisateur a annul√©, pas d'erreur */ });
    return;
  }

  const text = encodeURIComponent(title);
  const encodedUrl = encodeURIComponent(url);
  
  // Mettre √† jour les m√©tadonn√©es Open Graph avant le partage
  // IMPORTANT: Les m√©tadonn√©es doivent √™tre mises √† jour AVANT que l'utilisateur clique sur le bouton de partage
  // pour que les scrapers des r√©seaux sociaux les d√©tectent correctement
  if (item) {
    updateOpenGraphMetadata(type, id, item);
    
    // Afficher une notification pour informer l'utilisateur
    showNotification("üì± M√©tadonn√©es mises √† jour pour le partage social", "info");
  }
  
  // Cr√©er le modal de partage professionnel
  const shareModal = document.createElement('div');
  shareModal.id = 'share-modal';
  shareModal.dataset.type = type;
  shareModal.dataset.id = String(id);
  shareModal.innerHTML = `
    <div style="position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);z-index:99999;display:flex;align-items:center;justify-content:center;" onclick="closeShareModal(event)">
      <div style="background:var(--ui-card-bg, #1a1a2e);border-radius:20px;padding:24px;max-width:400px;width:90%;box-shadow:0 25px 50px rgba(0,0,0,0.5);border:1px solid var(--ui-card-border, rgba(255,255,255,0.1));" onclick="event.stopPropagation()">
        
        <div style="text-align:center;margin-bottom:20px;">
          <h3 style="margin:0 0 8px 0;font-size:20px;font-weight:700;color:var(--ui-text-main, #fff);">üîó Partager</h3>
          <p style="margin:0;font-size:13px;color:var(--ui-text-muted, #94a3b8);max-width:280px;margin:0 auto;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(title)}</p>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;margin-bottom:20px;">
          
          <!-- Facebook -->
          <a href="https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}" target="_blank" rel="noopener" 
             style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px 12px;border-radius:12px;background:rgba(24,119,242,0.15);border:1px solid rgba(24,119,242,0.3);text-decoration:none;transition:all 0.2s;"
             onmouseover="this.style.background='rgba(24,119,242,0.25)';this.style.transform='scale(1.05)'"
             onmouseout="this.style.background='rgba(24,119,242,0.15)';this.style.transform='scale(1)'">
            <span style="font-size:28px;">üìò</span>
            <span style="font-size:11px;font-weight:600;color:#1877f2;">Facebook</span>
          </a>
          
          <!-- WhatsApp -->
          <a href="https://api.whatsapp.com/send?text=${text}%20${encodedUrl}" target="_blank" rel="noopener"
             style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px 12px;border-radius:12px;background:rgba(37,211,102,0.15);border:1px solid rgba(37,211,102,0.3);text-decoration:none;transition:all 0.2s;"
             onmouseover="this.style.background='rgba(37,211,102,0.25)';this.style.transform='scale(1.05)'"
             onmouseout="this.style.background='rgba(37,211,102,0.15)';this.style.transform='scale(1)'">
            <span style="font-size:28px;">üí¨</span>
            <span style="font-size:11px;font-weight:600;color:#25d366;">WhatsApp</span>
          </a>
          
          <!-- Twitter/X -->
          <a href="https://twitter.com/intent/tweet?text=${text}&url=${encodedUrl}" target="_blank" rel="noopener"
             style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px 12px;border-radius:12px;background:rgba(29,155,240,0.15);border:1px solid rgba(29,155,240,0.3);text-decoration:none;transition:all 0.2s;"
             onmouseover="this.style.background='rgba(29,155,240,0.25)';this.style.transform='scale(1.05)'"
             onmouseout="this.style.background='rgba(29,155,240,0.15)';this.style.transform='scale(1)'">
            <span style="font-size:28px;">üê¶</span>
            <span style="font-size:11px;font-weight:600;color:#1d9bf0;">Twitter</span>
          </a>
          
          <!-- Telegram -->
          <a href="https://t.me/share/url?url=${encodedUrl}&text=${text}" target="_blank" rel="noopener"
             style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px 12px;border-radius:12px;background:rgba(0,136,204,0.15);border:1px solid rgba(0,136,204,0.3);text-decoration:none;transition:all 0.2s;"
             onmouseover="this.style.background='rgba(0,136,204,0.25)';this.style.transform='scale(1.05)'"
             onmouseout="this.style.background='rgba(0,136,204,0.15)';this.style.transform='scale(1)'">
            <span style="font-size:28px;">‚úàÔ∏è</span>
            <span style="font-size:11px;font-weight:600;color:#0088cc;">Telegram</span>
          </a>
          
          <!-- LinkedIn -->
          <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}" target="_blank" rel="noopener"
             style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px 12px;border-radius:12px;background:rgba(10,102,194,0.15);border:1px solid rgba(10,102,194,0.3);text-decoration:none;transition:all 0.2s;"
             onmouseover="this.style.background='rgba(10,102,194,0.25)';this.style.transform='scale(1.05)'"
             onmouseout="this.style.background='rgba(10,102,194,0.15)';this.style.transform='scale(1)'">
            <span style="font-size:28px;">üíº</span>
            <span style="font-size:11px;font-weight:600;color:#0a66c2;">LinkedIn</span>
          </a>
          
          <!-- Email -->
          <a href="mailto:?subject=${text}&body=${text}%20-%20${encodedUrl}" 
             style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px 12px;border-radius:12px;background:rgba(234,88,12,0.15);border:1px solid rgba(234,88,12,0.3);text-decoration:none;transition:all 0.2s;"
             onmouseover="this.style.background='rgba(234,88,12,0.25)';this.style.transform='scale(1.05)'"
             onmouseout="this.style.background='rgba(234,88,12,0.15)';this.style.transform='scale(1)'">
            <span style="font-size:28px;">üìß</span>
            <span style="font-size:11px;font-weight:600;color:#ea580c;">Email</span>
          </a>
          
        </div>
        
        <!-- Partager en Story (image 1080x1920) -->
        <button onclick="closeShareModal();generateShareStory(this.closest('#share-modal').dataset.type, this.closest('#share-modal').dataset.id);" 
                style="display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;border-radius:12px;background:linear-gradient(135deg,rgba(0,255,195,0.2),rgba(59,130,246,0.2));border:1px solid rgba(0,255,195,0.4);color:#00ffc3;font-weight:600;font-size:14px;cursor:pointer;margin-bottom:12px;transition:all 0.2s;"
                onmouseover="this.style.transform='scale(1.02)'"
                onmouseout="this.style.transform='scale(1)'">
          üì± Partager en Story (image 1080√ó1920)
        </button>
        
        <!-- Copier le lien -->
        <div style="display:flex;gap:8px;align-items:center;background:rgba(0,0,0,0.3);border-radius:12px;padding:12px;border:1px solid var(--ui-card-border, rgba(255,255,255,0.1));">
          <input type="text" value="${url}" readonly 
                 style="flex:1;background:transparent;border:none;color:var(--ui-text-main, #fff);font-size:12px;outline:none;min-width:0;">
          <button onclick="copyShareLink('${url}')" 
                  style="padding:8px 16px;border-radius:8px;background:#00ffc3;border:none;color:#000;font-weight:600;font-size:12px;cursor:pointer;white-space:nowrap;transition:all 0.2s;"
                  onmouseover="this.style.transform='scale(1.05)'"
                  onmouseout="this.style.transform='scale(1)'">
            üìã Copier
          </button>
        </div>
        
        <!-- Fermer -->
        <button onclick="closeShareModal()" 
                style="width:100%;margin-top:16px;padding:12px;border-radius:12px;background:transparent;border:1px solid var(--ui-card-border, rgba(255,255,255,0.2));color:var(--ui-text-muted, #94a3b8);font-size:13px;cursor:pointer;transition:all 0.2s;"
                onmouseover="this.style.background='rgba(255,255,255,0.05)'"
                onmouseout="this.style.background='transparent'">
          Fermer
        </button>
        
      </div>
    </div>
  `;
  
  document.body.appendChild(shareModal);
}

// G√©n√®re une image Story 1080√ó1920 pour partage Instagram/Stories
async function generateShareStory(type, id) {
  const idNum = typeof id === 'string' ? parseInt(id, 10) : id;
  let item = null;
  let title = "D√©couvrez sur MapEvent !";
  if (type === "event") {
    item = eventsData.find(e => e.id === idNum);
    if (item) title = item.title || item.name || title;
  } else if (type === "booking") {
    item = bookingsData.find(b => b.id === idNum);
    if (item) title = item.title || item.name || title;
  } else if (type === "service") {
    item = servicesData.find(s => s.id === idNum);
    if (item) title = item.title || item.name || title;
  }
  const url = `${window.location.origin}${window.location.pathname}?${type}=${idNum}`;
  const W = 1080, H = 1920;
  const canvas = document.createElement('canvas');
  canvas.width = W;
  canvas.height = H;
  const ctx = canvas.getContext('2d');
  
  // Fond gradient
  const grad = ctx.createLinearGradient(0, 0, W, H);
  grad.addColorStop(0, '#0f172a');
  grad.addColorStop(0.5, '#1e293b');
  grad.addColorStop(1, '#020617');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, W, H);
  
  // Image de l'item (si disponible)
  let imgUrl = item && typeof getImageCandidatesForItem === 'function' 
    ? (getImageCandidatesForItem(item)[0] || '') 
    : '';
  if (imgUrl && !imgUrl.startsWith('http')) {
    imgUrl = (imgUrl.startsWith('/') ? window.location.origin : '') + imgUrl;
  }
  if (imgUrl) {
    try {
      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.crossOrigin = 'anonymous';
        i.onload = () => resolve(i);
        i.onerror = reject;
        i.src = imgUrl;
      });
      const maxH = H * 0.45;
      const ratio = img.naturalWidth / img.naturalHeight;
      const drawH = Math.min(maxH, img.naturalHeight);
      const drawW = ratio * drawH;
      const sx = (W - drawW) / 2;
      ctx.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, sx, 0, drawW, drawH);
    } catch (_) {}
  }
  
  // Overlay sombre
  ctx.fillStyle = 'rgba(0,0,0,0.4)';
  ctx.fillRect(0, 0, W, H);
  
  // Zone contenu
  const pad = 60;
  ctx.fillStyle = '#ffffff';
  ctx.font = 'bold 52px system-ui, sans-serif';
  ctx.textAlign = 'center';
  const lines = (title || '').match(/.{1,28}/g) || [''];
  lines.slice(0, 3).forEach((line, i) => {
    ctx.fillText(line, W / 2, H * 0.5 + i * 60, W - pad * 2);
  });
  
  // Date/lieu
  if (item) {
    ctx.fillStyle = '#94a3b8';
    ctx.font = 'bold 32px system-ui, sans-serif';
    let sub = '';
    if (item.startDate) sub = new Date(item.startDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
    if (item.city || item.address) sub += (sub ? ' ‚Ä¢ ' : '') + (item.city || item.address || '').substring(0, 40);
    if (sub) ctx.fillText(sub, W / 2, H * 0.62, W - pad * 2);
  }
  
  // QR code (API publique)
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
  try {
    const qrImg = await new Promise((resolve, reject) => {
      const i = new Image();
      i.crossOrigin = 'anonymous';
      i.onload = () => resolve(i);
      i.onerror = reject;
      i.src = qrUrl;
    });
    ctx.fillStyle = '#fff';
    ctx.fillRect((W - 240) / 2, H - 320, 240, 240);
    ctx.drawImage(qrImg, (W - 200) / 2, H - 310, 200, 200);
  } catch (_) {}
  
  // Branding MapEvent
  ctx.fillStyle = '#00ffc3';
  ctx.font = 'bold 36px system-ui, sans-serif';
  ctx.fillText('MapEvent', W / 2, H - 50);
  
  // T√©l√©charger ou partager
  canvas.toBlob(blob => {
    const u = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = u;
    a.download = `mapevent-story-${type}-${idNum}.png`;
    a.click();
    URL.revokeObjectURL(u);
    if (typeof showNotification === 'function') showNotification('üì± Image Story t√©l√©charg√©e ! Partagez-la dans vos Stories.', 'success');
  }, 'image/png');
}
window.generateShareStory = generateShareStory;

function closeShareModal(event) {
  if (event && event.target !== event.currentTarget) return;
  const modal = document.getElementById('share-modal');
  if (modal) modal.remove();
}

function copyShareLink(url) {
  navigator.clipboard.writeText(url).then(() => {
    showNotification("üîó Lien copi√© dans le presse-papier !", "success");
    closeShareModal();
  }).catch(() => {
    // Fallback pour les navigateurs qui ne supportent pas clipboard
    const input = document.querySelector('#share-modal input');
    if (input) {
      input.select();
      document.execCommand('copy');
      showNotification("üîó Lien copi√© !", "success");
      closeShareModal();
    }
  });
}

// Exposer les fonctions
window.closeShareModal = closeShareModal;
window.copyShareLink = copyShareLink;
window.shareItem = shareItem;
// Mettre √† jour la fonction globale avec l'impl√©mentation compl√®te
// sharePopup appelle directement shareItem maintenant que shareItem est d√©fini
// Cette assignation remplace le stub d√©fini plus t√¥t
window.sharePopup = function(type, id) {
  if (typeof shareItem === 'function') {
    shareItem(type, id);
  } else {
    console.warn('sharePopup: shareItem not available');
  }
};

// ============================================
// NOTIFICATIONS
// ============================================
function showNotification(message, type = "info", options = {}) {
  const existing = document.getElementById("notification-toast");
  if (existing) existing.remove();

  const colors = {
    success: "#22c55e",
    error: "#ef4444",
    info: "#3b82f6",
    warning: "#f59e0b"
  };

  const duration = options.duration || 3000;
  const actionLabel = options.actionLabel || null;
  const onAction = options.onAction || null;
  const autoClose = options.autoClose !== false;

  const toast = document.createElement("div");
  toast.id = "notification-toast";
  
  // Construire le contenu avec action si fournie
  let content = `<div style="display:flex;align-items:center;gap:12px;">`;
  content += `<span style="flex:1;">${message}</span>`;
  if (actionLabel && onAction) {
    const actionId = `toast-action-${Date.now()}`;
    content += `<button id="${actionId}" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;white-space:nowrap;transition:background 0.2s;">${actionLabel}</button>`;
    setTimeout(() => {
      const btn = document.getElementById(actionId);
      if (btn) {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          onAction();
          toast.remove();
        });
        btn.style.pointerEvents = 'auto';
      }
    }, 10);
  }
  content += `</div>`;
  
  toast.innerHTML = content;
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${colors[type] || colors.info};
    color: white;
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 500;
    z-index: 2147483647;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    animation: slideUp 0.3s ease;
    pointer-events: ${actionLabel ? 'auto' : 'none'};
    max-width: 90%;
    min-width: 300px;
  `;

  document.body.appendChild(toast);

  if (autoClose) {
    setTimeout(() => {
      toast.style.animation = "slideDown 0.3s ease";
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }
  
  return toast;
}

/**
 * Affiche un message d'erreur contextuel avec des suggestions d'action
 * @param {string} errorCode - Code d'erreur pour identifier le type
 * @param {string} message - Message principal
 * @param {Object} context - Contexte suppl√©mentaire (field, value, etc.)
 */
function showContextualError(errorCode, message, context = {}) {
  const errorMessages = {
    'EMAIL_NOT_VERIFIED': {
      message: 'üìß Email non v√©rifi√©',
      details: 'Veuillez v√©rifier votre email avant de cr√©er le compte.',
      action: {
        label: 'V√©rifier maintenant',
        callback: () => {
          if (typeof showRegisterStep2_5 === 'function') {
            showRegisterStep2_5();
          }
        }
      }
    },
    'EMAIL_ALREADY_EXISTS': {
      message: '‚ö†Ô∏è Email d√©j√† utilis√©',
      details: `L'email "${context.email || ''}" est d√©j√† associ√© √† un compte.`,
      action: {
        label: 'Se connecter',
        callback: () => {
          if (typeof window.openAuthModal === 'function') {
            window.openAuthModal('login');
          }
        }
      }
    },
    'USERNAME_ALREADY_EXISTS': {
      message: '‚ö†Ô∏è Nom d\'utilisateur indisponible',
      details: `Le nom "${context.username || ''}" est d√©j√† pris. Choisissez-en un autre.`,
      action: {
        label: 'Modifier',
        callback: () => {
          if (typeof showRegisterStep2 === 'function') {
            showRegisterStep2();
            // Focus sur le champ username
            setTimeout(() => {
              const usernameInput = document.getElementById('register-username');
              if (usernameInput) {
                usernameInput.focus();
                usernameInput.select();
              }
            }, 100);
          }
        }
      }
    },
    'PASSWORD_TOO_WEAK': {
      message: 'üîí Mot de passe trop faible',
      details: context.details || 'Votre mot de passe ne respecte pas les crit√®res de s√©curit√©.',
      action: {
        label: 'Voir les crit√®res',
        callback: () => {
          // Scroll vers l'indicateur de force du mot de passe
          const passwordInput = document.getElementById('register-password');
          if (passwordInput) {
            passwordInput.focus();
            passwordInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      }
    },
    'RATE_LIMITED': {
      message: '‚è±Ô∏è Trop de tentatives',
      details: `Veuillez patienter ${context.retryAfter || 0} secondes avant de r√©essayer.`,
      action: null // Pas d'action pour rate limiting
    },
    'NETWORK_ERROR': {
      message: 'üåê Erreur de connexion',
      details: 'Impossible de se connecter au serveur. V√©rifiez votre connexion internet.',
      action: {
        label: 'R√©essayer',
        callback: context.retryCallback || (() => window.location.reload())
      }
    },
    'VALIDATION_ERROR': {
      message: '‚úèÔ∏è Informations manquantes',
      details: context.details || 'Veuillez compl√©ter tous les champs requis.',
      action: {
        label: 'Voir le champ',
        callback: () => {
          if (context.fieldId) {
            const field = document.getElementById(context.fieldId);
            if (field) {
              field.focus();
              field.scrollIntoView({ behavior: 'smooth', block: 'center' });
              // Ajouter une classe pour highlight
              field.style.borderColor = '#ef4444';
              field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
              setTimeout(() => {
                field.style.borderColor = '';
                field.style.boxShadow = '';
              }, 3000);
            }
          }
        }
      }
    }
  };

  const errorConfig = errorMessages[errorCode] || {
    message: '‚ùå Erreur',
    details: message,
    action: null
  };

  const fullMessage = `${errorConfig.message}\n${errorConfig.details}`;
  
  showNotification(fullMessage, 'error', {
    duration: errorCode === 'RATE_LIMITED' ? 5000 : 4000,
    actionLabel: errorConfig.action?.label || null,
    onAction: errorConfig.action?.callback || null,
    autoClose: true
  });
}

// ============================================
// openAuthModal() est maintenant dans auth.js et expos√© via window.openAuthModal
// MODALS - LOGIN / REVIEW / DISCUSSION / REPORT
// ============================================
// Modal d'authentification unifi√© (register/login)
// REMOVED: function openAuthModal() - voir auth.js (lignes 10344-11112 supprim√©es)
// Le corps de la fonction a √©t√© supprim√© - elle est maintenant dans auth.js et expos√©e via window.openAuthModal
// [Code supprim√© : lignes 10346-11111 - fonction openAuthModal compl√®te]

// ============================================
// SYST√àME D'ONBOARDING COMPLET
// ============================================
// V√©rifie si le profil est complet et lance l'onboarding si n√©cessaire

/**
 * V√©rifie si le profil utilisateur est complet
 * @returns {Object} { isComplete: boolean, missingSteps: string[] }
 */
function checkProfileCompleteness(user) {
  const missingSteps = [];
  
  // V√©rifier la photo de profil
  if (!user.profile_photo_url || user.profile_photo_url === '' || user.profile_photo_url === 'üë§') {
    missingSteps.push('photo');
  }
  
  // V√©rifier l'adresse postale (doit √™tre v√©rifi√©e)
  if (!user.address_verified || !user.address_lat || !user.address_lng) {
    missingSteps.push('address');
  }
  
  return {
    isComplete: missingSteps.length === 0,
    missingSteps: missingSteps
  };
}

/**
 * D√©marre l'onboarding si le profil est incomplet
 * @param {Object} user - L'utilisateur connect√©
 * @param {boolean} force - Forcer l'onboarding m√™me si le profil est complet
 */
function startOnboardingIfNeeded(user, force = false) {
  if (!user || !user.isLoggedIn) {
    return;
  }
  
  const profileCheck = checkProfileCompleteness(user);
  
  if (force || !profileCheck.isComplete) {
    console.log('[ONBOARDING] Profil incomplet, demarrage onboarding. Etapes manquantes:', profileCheck.missingSteps);
    openOnboardingModal(profileCheck.missingSteps);
  } else {
    console.log('[ONBOARDING] Profil complet, pas d\'onboarding necessaire');
  }
}

/**
 * Ouvre le modal d'onboarding avec les √©tapes manquantes
 * @param {string[]} missingSteps - Liste des √©tapes manquantes ['photo', 'address']
 */
function openOnboardingModal(missingSteps = []) {
  console.log('[ONBOARDING] Ouverture modal onboarding, etapes:', missingSteps);
  console.log('[ONBOARDING] missingSteps.length:', missingSteps.length);
  
  let backdrop = document.getElementById('publish-modal-backdrop');
  let modal = document.getElementById('publish-modal-inner');
  
  if (!backdrop || !modal) {
    console.warn('[ONBOARDING] Modal elements not found - creation...');
    // Cr√©er les √©l√©ments si ils n'existent pas
    if (!backdrop) {
      backdrop = document.createElement('div');
      backdrop.id = 'publish-modal-backdrop';
      backdrop.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);z-index:99998;display:flex;align-items:center;justify-content:center;';
      backdrop.onclick = function(e) {
        if (e.target === backdrop) closePublishModal();
      };
      document.body.appendChild(backdrop);
      console.log('[ONBOARDING] Backdrop cree');
    }
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'publish-modal-inner';
      modal.style.cssText = 'position:relative;max-width:90vw;max-height:90vh;overflow-y:auto;';
      if (backdrop) backdrop.appendChild(modal);
      console.log('[ONBOARDING] Modal inner cree');
    }
  }
  
  if (!backdrop || !modal) {
    console.error('[ONBOARDING] ERREUR: Impossible de creer les elements modal');
    return;
  }
  
  // D√©terminer l'√©tape actuelle
  let currentStep = 0;
  if (missingSteps.includes('photo')) {
    currentStep = 1; // √âtape photo
  } else if (missingSteps.includes('address')) {
    currentStep = 2; // √âtape adresse
  }
  
  // G√©n√©rer le HTML pour l'√©tape actuelle
  let stepHTML = '';
  let stepTitle = '';
  let stepSubtitle = '';
  
  if (currentStep === 1) {
    // √âtape photo
    stepTitle = 'üì∏ Ajoutez votre photo de profil';
    stepSubtitle = 'Votre photo vous aidera √† √™tre reconnu(e) par la communaut√© MapEvent';
    stepHTML = renderOnboardingPhotoStep();
  } else if (currentStep === 2) {
    // √âtape adresse
    stepTitle = 'üìç V√©rifiez votre adresse postale';
    stepSubtitle = 'Votre adresse nous permet de vous envoyer des alertes personnalis√©es pour les √©v√©nements pr√®s de chez vous';
    stepHTML = renderOnboardingAddressStep();
  } else {
    // Toutes les √©tapes sont compl√®tes
    stepTitle = '‚úÖ Profil compl√©t√© !';
    stepSubtitle = 'Votre profil est maintenant complet. Vous pouvez acc√©der √† toutes les fonctionnalit√©s.';
    stepHTML = renderOnboardingCompleteStep();
  }
  
  const html = `
    <div id="onboardingModal" class="onboarding-modal" data-onboarding="true" data-step="${currentStep}" data-onboarding-active="true" style="padding:40px;max-width:500px;margin:0 auto;text-align:center;">
      <!-- Indicateur de progression -->
      <div style="margin-bottom:32px;">
        <div style="display:flex;justify-content:center;gap:8px;margin-bottom:16px;">
          <div style="width:40px;height:4px;background:${currentStep >= 1 ? '#00ffc3' : 'rgba(255,255,255,0.2)'};border-radius:2px;"></div>
          <div style="width:40px;height:4px;background:${currentStep >= 2 ? '#00ffc3' : 'rgba(255,255,255,0.2)'};border-radius:2px;"></div>
        </div>
        <h2 style="margin:0 0 8px;font-size:24px;font-weight:800;color:#fff;">${stepTitle}</h2>
        <p style="margin:0;font-size:14px;color:var(--ui-text-muted);">${stepSubtitle}</p>
      </div>
      
      ${stepHTML}
    </div>
  `;
  
  modal.innerHTML = html;
  backdrop.style.display = "flex";
  
  // Attacher les event listeners apr√®s injection
  attachOnboardingEventListeners(currentStep);
}

/**
 * G√©n√®re le HTML pour l'√©tape photo
 */
function renderOnboardingPhotoStep() {
  return `
    <div style="text-align:left;">
      <!-- Zone d'upload -->
      <div id="photo-upload-zone" style="border:2px dashed rgba(0,255,195,0.5);border-radius:12px;padding:40px;text-align:center;background:rgba(0,255,195,0.05);margin-bottom:20px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.borderColor='rgba(0,255,195,0.8)';this.style.background='rgba(0,255,195,0.1)';" onmouseout="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(0,255,195,0.05)';">
        <div style="font-size:48px;margin-bottom:12px;">üì∑</div>
        <div style="color:var(--ui-text-main);margin-bottom:8px;font-weight:600;">Cliquez pour s√©lectionner une photo</div>
        <div style="color:var(--ui-text-muted);font-size:12px;">JPG, PNG ou GIF (max 5MB)</div>
        <input type="file" id="onboarding-photo-input" accept="image/*" style="display:none;" onchange="handleOnboardingPhotoUpload(event)">
      </div>
      
      <!-- Preview de la photo -->
      <div id="photo-preview-container" style="display:none;margin-bottom:20px;">
        <img id="photo-preview" src="" style="width:150px;height:150px;border-radius:50%;object-fit:cover;border:3px solid #00ffc3;margin:0 auto;display:block;">
      </div>
      
      <!-- Option "Plus tard" -->
      <div style="margin-bottom:20px;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;color:var(--ui-text-muted);font-size:13px;">
          <input type="checkbox" id="photo-later-checkbox" style="cursor:pointer;">
          <span>Ajouter ma photo plus tard</span>
        </label>
      </div>
      
      <!-- Boutons -->
      <div style="display:flex;gap:12px;">
        <button id="onboarding-skip-photo" style="flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:var(--ui-text-muted);font-weight:600;cursor:pointer;">Passer</button>
        <button id="onboarding-continue-photo" style="flex:1;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-weight:700;cursor:pointer;display:none;">Continuer</button>
      </div>
    </div>
  `;
}

/**
 * G√©n√®re le HTML pour l'√©tape adresse
 */
function renderOnboardingAddressStep() {
  return `
    <div style="text-align:left;">
      <!-- Champ adresse avec autocomplete -->
      <div style="margin-bottom:16px;">
        <label style="display:block;font-size:13px;font-weight:600;color:var(--ui-text-main);margin-bottom:8px;">üìç Adresse postale</label>
        <input type="text" id="onboarding-address-input" placeholder="Commencez √† taper votre adresse..." style="width:100%;padding:12px 16px;border-radius:10px;border:2px solid rgba(255,255,255,0.1);background:rgba(15,23,42,0.5);color:var(--ui-text-main);font-size:14px;">
        <div id="address-suggestions" style="margin-top:8px;display:none;max-height:200px;overflow-y:auto;background:rgba(15,23,42,0.9);border-radius:8px;border:1px solid rgba(255,255,255,0.1);"></div>
      </div>
      
      <!-- Adresse s√©lectionn√©e (affich√©e apr√®s s√©lection) -->
      <div id="selected-address-display" style="display:none;padding:12px;background:rgba(0,255,195,0.1);border:1px solid rgba(0,255,195,0.3);border-radius:10px;margin-bottom:16px;">
        <div style="display:flex;align-items:start;gap:8px;">
          <span style="font-size:20px;">‚úÖ</span>
          <div style="flex:1;">
            <div style="font-weight:600;color:#00ffc3;margin-bottom:4px;" id="selected-address-label"></div>
            <div style="font-size:12px;color:var(--ui-text-muted);" id="selected-address-details"></div>
          </div>
        </div>
      </div>
      
      <!-- Option "Plus tard" -->
      <div style="margin-bottom:20px;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;color:var(--ui-text-muted);font-size:13px;">
          <input type="checkbox" id="address-later-checkbox" style="cursor:pointer;">
          <span>V√©rifier mon adresse plus tard</span>
        </label>
      </div>
      
      <!-- Boutons -->
      <div style="display:flex;gap:12px;">
        <button id="onboarding-skip-address" style="flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:var(--ui-text-muted);font-weight:600;cursor:pointer;">Passer</button>
        <button id="onboarding-continue-address" style="flex:1;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-weight:700;cursor:pointer;display:none;">Continuer</button>
      </div>
    </div>
  `;
}

/**
 * G√©n√®re le HTML pour l'√©tape compl√©t√©e
 */
function renderOnboardingCompleteStep() {
  return `
    <div style="text-align:center;">
      <div style="font-size:64px;margin-bottom:16px;">üéâ</div>
      <p style="color:var(--ui-text-main);margin-bottom:24px;">Votre profil est maintenant complet !</p>
      <button id="onboarding-finish" style="width:100%;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-weight:700;cursor:pointer;">Commencer √† explorer</button>
    </div>
  `;
}

/**
 * Attache les event listeners pour l'onboarding
 */
function attachOnboardingEventListeners(step) {
  if (step === 1) {
    // √âtape photo
    const uploadZone = document.getElementById('photo-upload-zone');
    const photoInput = document.getElementById('onboarding-photo-input');
    const skipBtn = document.getElementById('onboarding-skip-photo');
    const continueBtn = document.getElementById('onboarding-continue-photo');
    const laterCheckbox = document.getElementById('photo-later-checkbox');
    
    if (uploadZone && photoInput) {
      uploadZone.addEventListener('click', () => photoInput.click());
    }
    
    if (skipBtn) {
      skipBtn.addEventListener('click', () => {
        skipOnboardingStep('photo');
      });
    }
    
    if (continueBtn) {
      continueBtn.addEventListener('click', () => {
        continueOnboardingStep('photo');
      });
    }
    
    if (laterCheckbox) {
      laterCheckbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          skipOnboardingStep('photo');
        }
      });
    }
  } else if (step === 2) {
    // √âtape adresse
    const addressInput = document.getElementById('onboarding-address-input');
    const skipBtn = document.getElementById('onboarding-skip-address');
    const continueBtn = document.getElementById('onboarding-continue-address');
    const laterCheckbox = document.getElementById('address-later-checkbox');
    
    if (addressInput) {
      // Int√©grer l'autocomplete d'adresse (OpenStreetMap/Nominatim)
      setupAddressAutocomplete(addressInput);
    }
    
    if (skipBtn) {
      skipBtn.addEventListener('click', () => {
        skipOnboardingStep('address');
      });
    }
    
    if (continueBtn) {
      continueBtn.addEventListener('click', () => {
        continueOnboardingStep('address');
      });
    }
    
    if (laterCheckbox) {
      laterCheckbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          skipOnboardingStep('address');
        }
      });
    }
  } else {
    // √âtape compl√©t√©e
    const finishBtn = document.getElementById('onboarding-finish');
    if (finishBtn) {
      finishBtn.addEventListener('click', () => {
        closePublishModal();
        showNotification('üéâ Bienvenue sur MapEvent !', 'success');
      });
    }
  }
}

/**
 * G√®re l'upload de photo dans l'onboarding
 */
window.handleOnboardingPhotoUpload = function(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (file.size > 5 * 1024 * 1024) {
    showNotification('‚ö†Ô∏è La photo doit faire moins de 5MB', 'warning');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const previewContainer = document.getElementById('photo-preview-container');
    const previewImg = document.getElementById('photo-preview');
    const continueBtn = document.getElementById('onboarding-continue-photo');
    
    if (previewImg) {
      previewImg.src = e.target.result;
    }
    if (previewContainer) {
      previewContainer.style.display = 'block';
    }
    if (continueBtn) {
      continueBtn.style.display = 'block';
    }
    
    // Stocker temporairement la photo pour l'upload
    window.onboardingPhotoData = e.target.result;
    window.onboardingPhotoFile = file;
  };
  reader.readAsDataURL(file);
};

/**
 * Passe √† l'√©tape suivante de l'onboarding
 */
function continueOnboardingStep(step) {
  if (step === 'photo') {
    // Uploader la photo
    if (window.onboardingPhotoData && window.onboardingPhotoFile) {
      uploadProfilePhoto(window.onboardingPhotoFile).then(() => {
        // Passer √† l'√©tape suivante
        const missingSteps = checkProfileCompleteness(currentUser).missingSteps;
        if (missingSteps.includes('address')) {
          openOnboardingModal(['address']);
        } else {
          openOnboardingModal([]); // Afficher l'√©tape compl√©t√©e
        }
      }).catch(error => {
        console.error('[ONBOARDING] Erreur upload photo:', error);
        showNotification('‚ö†Ô∏è Erreur lors de l\'upload de la photo', 'error');
      });
    }
  } else if (step === 'address') {
    // Sauvegarder l'adresse
    const selectedAddress = window.onboardingSelectedAddress;
    if (selectedAddress) {
      saveUserAddress(selectedAddress).then(() => {
        // Afficher l'√©tape compl√©t√©e
        openOnboardingModal([]);
      }).catch(error => {
        console.error('[ONBOARDING] Erreur sauvegarde adresse:', error);
        showNotification('‚ö†Ô∏è Erreur lors de la sauvegarde de l\'adresse', 'error');
      });
    }
  }
}

/**
 * Passe l'√©tape de l'onboarding
 */
function skipOnboardingStep(step) {
  if (step === 'photo') {
    // Marquer comme "plus tard"
    const missingSteps = checkProfileCompleteness(currentUser).missingSteps.filter(s => s !== 'photo');
    if (missingSteps.length > 0) {
      openOnboardingModal(missingSteps);
    } else {
      openOnboardingModal([]); // Afficher l'√©tape compl√©t√©e
    }
  } else if (step === 'address') {
    // Marquer comme "plus tard" (address_verified = false)
    const missingSteps = checkProfileCompleteness(currentUser).missingSteps.filter(s => s !== 'address');
    if (missingSteps.length > 0) {
      openOnboardingModal(missingSteps);
    } else {
      openOnboardingModal([]); // Afficher l'√©tape compl√©t√©e
    }
  }
}

/**
 * Upload la photo de profil vers S3
 */
async function uploadProfilePhoto(file) {
  console.log('[ONBOARDING] Upload photo vers S3...');
  
  const accessToken = getAuthToken();
  if (!accessToken) {
    throw new Error('Non authentifi√©');
  }
  
  // Convertir le fichier en base64
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = async function(e) {
      const base64Data = e.target.result;
      
      try {
        const response = await fetch(`${window.API_BASE_URL}/user/upload-photo`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({
            photo: base64Data
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
          throw new Error(errorData.error || 'Erreur upload photo');
        }
        
        const data = await response.json();
        const photoUrl = data.photo_url || data.user?.profile_photo_url;
        
        if (!photoUrl) {
          throw new Error('URL photo non retourn√©e par le serveur');
        }
        
        // Mettre √† jour currentUser
        currentUser.profile_photo_url = photoUrl;
        safeSetItem('currentUser', JSON.stringify(currentUser));
        
        console.log('[ONBOARDING] Photo upload√©e avec succ√®s:', photoUrl);
        resolve(photoUrl);
      } catch (error) {
        console.error('[ONBOARDING] Erreur upload photo:', error);
        reject(error);
      }
    };
    reader.onerror = function(error) {
      reject(new Error('Erreur lecture fichier'));
    };
    reader.readAsDataURL(file);
  });
}

/**
 * Sauvegarde l'adresse de l'utilisateur
 */
async function saveUserAddress(addressData) {
  const accessToken = getAuthToken();
  if (!accessToken) {
    throw new Error('Non authentifi√©');
  }
  
  const response = await fetch(`${window.API_BASE_URL}/user/address`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${accessToken}`
    },
    body: JSON.stringify({
      address_label: addressData.label,
      address_lat: addressData.lat,
      address_lng: addressData.lng,
      address_country_code: addressData.country_code,
      address_city: addressData.city,
      address_postcode: addressData.postcode,
      address_street: addressData.street,
      address_verified: true
    })
  });
  
  if (!response.ok) {
    const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
    throw new Error(errorData.error || 'Erreur sauvegarde adresse');
  }
  
  const data = await response.json();
  // Mettre √† jour currentUser avec les donn√©es retourn√©es
  if (data.user) {
    Object.assign(currentUser, data.user);
    safeSetItem('currentUser', JSON.stringify(currentUser));
  }
  
  console.log('[ONBOARDING] Adresse sauvegard√©e avec succ√®s');
}

/**
 * Configure l'autocomplete d'adresse avec OpenStreetMap/Nominatim
 */
function setupAddressAutocomplete(inputElement) {
  let timeout;
  const suggestionsContainer = document.getElementById('address-suggestions');
  
  inputElement.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    clearTimeout(timeout);
    
    if (query.length < 3) {
      if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
      }
      return;
    }
    
    // OPTIMISATION: Debounce r√©duit √† 300ms pour r√©activit√© am√©lior√©e
    timeout = setTimeout(async () => {
      try {
        // VALIDATION STRICTE + PERFORMANCE: Param√®tres optimis√©s pour recherche rapide et exacte
        // addressdetails=1 pour validation compl√®te, limit=5 pour rapidit√©, language=fr pour pertinence, dedupe=1 pour √©viter doublons
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è RECHERCHE MONDIALE - Pas de restriction de pays, support multilingue
        const langCode = (navigator.language || 'fr').split('-')[0];
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&addressdetails=1&accept-language=${langCode},en&dedupe=1`, {
          headers: {
            'User-Agent': 'MapEventAI/1.0',
            'Accept-Language': `${langCode},en,fr`
          }
        });
        
        // Gestion d'erreur pour Nominatim (503, timeout, etc.)
        if (!response.ok) {
          console.warn('[ONBOARDING] Nominatim erreur HTTP:', response.status, response.statusText);
          if (suggestionsContainer) {
            suggestionsContainer.style.display = 'none';
          }
          return;
        }
        
        const text = await response.text();
        let results;
        try {
          results = JSON.parse(text);
        } catch (parseError) {
          console.error('[ONBOARDING] Erreur parsing JSON Nominatim:', parseError, 'Response:', text.substring(0, 100));
          if (suggestionsContainer) {
            suggestionsContainer.style.display = 'none';
          }
          return;
        }
        
        if (suggestionsContainer && results.length > 0) {
          // TRI INTELLIGENT: Prioriser les r√©sultats avec adresse compl√®te (road + house_number)
          const sortedResults = results.sort((a, b) => {
            const aHasFullAddress = a.address?.road && (a.address?.house_number || a.address?.house);
            const bHasFullAddress = b.address?.road && (b.address?.house_number || b.address?.house);
            if (aHasFullAddress && !bHasFullAddress) return -1;
            if (!aHasFullAddress && bHasFullAddress) return 1;
            return 0;
          });
          
          suggestionsContainer.innerHTML = sortedResults.map(result => {
            const hasFullAddress = result.address?.road && (result.address?.house_number || result.address?.house);
            const addressQuality = hasFullAddress ? '‚úÖ' : 'üìç';
            return `
            <div class="address-suggestion" style="padding:12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.1);transition:background 0.2s;"
                 onmouseover="this.style.background='rgba(0,255,195,0.1)'" 
                 onmouseout="this.style.background='transparent'"
                 data-lat="${result.lat}" 
                 data-lng="${result.lon}"
                 data-label="${result.display_name}"
                 data-country="${result.address?.country_code?.toUpperCase() || ''}"
                 data-city="${result.address?.city || result.address?.town || result.address?.village || ''}"
                 data-postcode="${result.address?.postcode || ''}"
                 data-street="${result.address?.road || ''}">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <span style="font-size:14px;">${addressQuality}</span>
                <div style="font-weight:600;color:var(--ui-text-main);flex:1;">${result.display_name}</div>
              </div>
              <div style="font-size:11px;color:var(--ui-text-muted);padding-left:22px;">${result.address?.country || ''}${result.address?.postcode ? ' ‚Ä¢ ' + result.address.postcode : ''}</div>
            </div>
          `;
          }).join('');
          
          suggestionsContainer.style.display = 'block';
          
          // Attacher les event listeners aux suggestions
          suggestionsContainer.querySelectorAll('.address-suggestion').forEach(suggestion => {
            suggestion.addEventListener('click', function() {
              selectAddressSuggestion({
                lat: parseFloat(this.dataset.lat),
                lng: parseFloat(this.dataset.lng),
                label: this.dataset.label,
                country_code: this.dataset.country,
                city: this.dataset.city,
                postcode: this.dataset.postcode,
                street: this.dataset.street
              });
            });
          });
        } else if (suggestionsContainer) {
          suggestionsContainer.style.display = 'none';
        }
      } catch (error) {
        console.error('[ONBOARDING] Erreur autocomplete adresse:', error);
      }
    }, 300);
  });
}

/**
 * S√©lectionne une adresse depuis les suggestions
 */
function selectAddressSuggestion(addressData) {
  window.onboardingSelectedAddress = addressData;
  
  const input = document.getElementById('onboarding-address-input');
  const suggestionsContainer = document.getElementById('address-suggestions');
  const selectedDisplay = document.getElementById('selected-address-display');
  const selectedLabel = document.getElementById('selected-address-label');
  const selectedDetails = document.getElementById('selected-address-details');
  const continueBtn = document.getElementById('onboarding-continue-address');
  
  if (input) {
    input.value = addressData.label;
  }
  if (suggestionsContainer) {
    suggestionsContainer.style.display = 'none';
  }
  if (selectedDisplay) {
    selectedDisplay.style.display = 'block';
  }
  if (selectedLabel) {
    selectedLabel.textContent = addressData.label;
  }
  if (selectedDetails) {
    selectedDetails.textContent = `${addressData.city || ''} ${addressData.postcode || ''} - ${addressData.country_code || ''}`;
  }
  if (continueBtn) {
    continueBtn.style.display = 'block';
  }
}

// Exposer les fonctions globalement
window.handleOnboardingPhotoUpload = handleOnboardingPhotoUpload;
window.startOnboardingIfNeeded = startOnboardingIfNeeded;
window.startOnboarding = startOnboardingIfNeeded; // Alias
window.openOnboardingModal = openOnboardingModal;
window.checkProfileCompleteness = checkProfileCompleteness;

// Hook de test pour ouvrir l'onboarding directement (sans login)
// Usage: window.testOnboarding() ou window.testOnboarding(['photo']) ou window.testOnboarding(['address'])
window.testOnboarding = function(missingSteps = ['photo', 'address']) {
  console.log('[ONBOARDING] Hook de test: testOnboarding() appel√© avec missingSteps:', missingSteps);
  if (typeof openOnboardingModal === 'function') {
    return openOnboardingModal(missingSteps);
  } else {
    console.error('[ONBOARDING] openOnboardingModal n\'est pas disponible');
  }
};

// Exposer les fonctions globalement IMM√âDIATEMENT apr√®s leur d√©finition
// REMOVED: openAuthModal est maintenant dans auth.js et expos√© via window.openAuthModal

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è WRAPPER SIMPLIFI√â : D√©l√®gue directement √† window.openLoginModal de auth.js
// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Ne JAMAIS √©craser window.openLoginModal ici !
function openLoginModal() {
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è SIMPLE : Appeler directement window.openLoginModal de auth.js
  if (typeof window.openLoginModal === 'function') {
    const authFn = window.openLoginModal;
    const fnSource = authFn.toString();
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è V√âRIFICATION : Si ce n'est pas le wrapper lui-m√™me, l'appeler
    if (!fnSource.includes('openLoginModalCalling')) {
      return authFn();
    }
  }
  
  // Si auth.js n'est pas encore charg√©, attendre un peu
  setTimeout(() => {
    if (typeof window.openLoginModal === 'function') {
      const authFn = window.openLoginModal;
      const fnSource = authFn.toString();
      if (!fnSource.includes('openLoginModalCalling')) {
        return authFn();
      }
    }
    // Fallback vers openAuthModal si n√©cessaire
    if (typeof window.openAuthModal === 'function') {
      return window.openAuthModal('login');
    }
  }, 100);
}

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : NE JAMAIS faire window.openLoginModal = openLoginModal ici !
// Cela cr√©erait une r√©cursion infinie car le wrapper s'appellerait lui-m√™me
// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è SUPPRIM√â : window.openLoginModal = openLoginModal; (ligne supprim√©e pour √©viter la r√©cursion)

function openRegisterModal() {
  console.log('[AUTH] openRegisterModal (wrapper) called');
  if (typeof window.openAuthModal === 'function') {
    return window.openAuthModal('register');
  } else if (typeof window.openRegisterModal === 'function') {
    // Fallback : utiliser directement window.openRegisterModal si disponible
    return window.openRegisterModal();
  } else {
    console.error('[AUTH] ERREUR: window.openAuthModal non disponible (auth.js non charg√© ?)');
  }
}

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : NE JAMAIS √©craser window.openLoginModal ici !
// Cela cr√©erait une r√©cursion infinie car le wrapper s'appellerait lui-m√™me via window.openLoginModal()
// window.openLoginModal doit rester la fonction de auth.js uniquement !
// window.openLoginModal = openLoginModal; // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è SUPPRIM√â pour √©viter la r√©cursion infinie
window.openRegisterModal = openRegisterModal;

// REMOVED: Les wrappers openLoginModal et openRegisterModal ne doivent PAS √™tre expos√©s ici
// car ces fonctions sont d√©j√† dans auth.js et expos√©es globalement
// Ces wrappers locaux sont conserv√©s pour compatibilit√© mais ne doivent pas √©craser ceux de auth.js

// Fonction pour cr√©er un compte depuis le modal auth
// G√®re l'upload de photo dans le formulaire d'inscription
window.handleRegisterPhotoUpload = function(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (file.size > 5 * 1024 * 1024) {
    showNotification('‚ö†Ô∏è La photo doit faire moins de 5MB', 'warning');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const previewContainer = document.getElementById('register-photo-preview-container');
    const previewImg = document.getElementById('register-photo-preview');
    
    if (previewImg) {
      previewImg.src = e.target.result;
    }
    if (previewContainer) {
      previewContainer.style.display = 'block';
    }
    
    // Stocker temporairement la photo pour l'envoi
    window.registerPhotoData = e.target.result;
    window.registerPhotoFile = file;
  };
  reader.readAsDataURL(file);
};

// Configure l'autocomplete d'adresse pour le formulaire d'inscription
function setupRegisterAddressAutocomplete(inputElement) {
  let timeout;
  const suggestionsContainer = document.getElementById('register-address-suggestions');
  
  inputElement.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    clearTimeout(timeout);
    
    if (query.length < 3) {
      if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
      }
      return;
    }
    
    // OPTIMISATION: Debounce plus court (300ms) pour r√©activit√©, mais validation stricte maintenue
    timeout = setTimeout(async () => {
      try {
        // VALIDATION STRICTE + PERFORMANCE: Param√®tres optimis√©s pour recherche rapide et exacte
        // addressdetails=1 pour validation compl√®te, limit=5 pour rapidit√©, language=fr pour pertinence
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è RECHERCHE MONDIALE - Pas de restriction de pays, support multilingue
        const langCode = (navigator.language || 'fr').split('-')[0];
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&addressdetails=1&accept-language=${langCode},en&dedupe=1`, {
          headers: {
            'User-Agent': 'MapEventAI/1.0',
            'Accept-Language': `${langCode},en,fr`
          }
        });
        
        // Gestion d'erreur pour Nominatim (503, timeout, etc.)
        if (!response.ok) {
          console.warn('[REGISTER] Nominatim erreur HTTP:', response.status, response.statusText);
          if (suggestionsContainer) {
            suggestionsContainer.style.display = 'none';
          }
          return;
        }
        
        const text = await response.text();
        let results;
        try {
          results = JSON.parse(text);
        } catch (parseError) {
          console.error('[REGISTER] Erreur parsing JSON Nominatim:', parseError, 'Response:', text.substring(0, 100));
          if (suggestionsContainer) {
            suggestionsContainer.style.display = 'none';
          }
          return;
        }
        
        if (suggestionsContainer && results.length > 0) {
          // TRI INTELLIGENT: Prioriser les r√©sultats avec adresse compl√®te (road + house_number)
          const sortedResults = results.sort((a, b) => {
            const aHasFullAddress = a.address?.road && (a.address?.house_number || a.address?.house);
            const bHasFullAddress = b.address?.road && (b.address?.house_number || b.address?.house);
            if (aHasFullAddress && !bHasFullAddress) return -1;
            if (!aHasFullAddress && bHasFullAddress) return 1;
            return 0;
          });
          
          suggestionsContainer.innerHTML = sortedResults.map(result => {
            const hasFullAddress = result.address?.road && (result.address?.house_number || result.address?.house);
            const addressQuality = hasFullAddress ? '‚úÖ' : 'üìç';
            return `
            <div class="register-address-suggestion" style="padding:12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.1);transition:background 0.2s;" 
                 onmouseover="this.style.background='rgba(0,255,195,0.1)'" 
                 onmouseout="this.style.background='transparent'"
                 data-lat="${result.lat}" 
                 data-lng="${result.lon}"
                 data-label="${result.display_name}"
                 data-country="${result.address?.country_code?.toUpperCase() || ''}"
                 data-city="${result.address?.city || result.address?.town || result.address?.village || ''}"
                 data-postcode="${result.address?.postcode || ''}"
                 data-street="${result.address?.road || ''}">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <span style="font-size:14px;">${addressQuality}</span>
                <div style="font-weight:600;color:var(--ui-text-main);font-size:13px;flex:1;">${result.display_name}</div>
              </div>
              <div style="font-size:11px;color:var(--ui-text-muted);padding-left:22px;">${result.address?.country || ''}${result.address?.postcode ? ' ‚Ä¢ ' + result.address.postcode : ''}</div>
            </div>
          `;
          }).join('');
          
          suggestionsContainer.style.display = 'block';
          
          // Attacher les event listeners aux suggestions
          suggestionsContainer.querySelectorAll('.register-address-suggestion').forEach(suggestion => {
            suggestion.addEventListener('click', function() {
              selectRegisterAddressSuggestion({
                lat: parseFloat(this.dataset.lat),
                lng: parseFloat(this.dataset.lng),
                label: this.dataset.label,
                country_code: this.dataset.country,
                city: this.dataset.city,
                postcode: this.dataset.postcode,
                street: this.dataset.street
              });
            });
          });
        } else if (suggestionsContainer) {
          suggestionsContainer.style.display = 'none';
        }
      } catch (error) {
        console.error('[REGISTER] Erreur autocomplete adresse:', error);
      }
    }, 300);
  });
}

// S√©lectionne une adresse depuis les suggestions dans le formulaire d'inscription
function selectRegisterAddressSuggestion(addressData) {
  window.registerSelectedAddress = addressData;
  
  const input = document.getElementById('register-address-input');
  const suggestionsContainer = document.getElementById('register-address-suggestions');
  const selectedDisplay = document.getElementById('register-selected-address-display');
  const selectedLabel = document.getElementById('register-selected-address-label');
  const selectedDetails = document.getElementById('register-selected-address-details');
  
  if (input) {
    input.value = addressData.label;
  }
  if (suggestionsContainer) {
    suggestionsContainer.style.display = 'none';
  }
  if (selectedDisplay) {
    selectedDisplay.style.display = 'block';
  }
  if (selectedLabel) {
    selectedLabel.textContent = addressData.label;
  }
  if (selectedDetails) {
    selectedDetails.textContent = `${addressData.city || ''} ${addressData.postcode || ''} - ${addressData.country_code || ''}`;
  }
}

// Fonction pour afficher l'erreur de timeout d'inscription
function showRegisterTimeoutError(email, username) {
  const authModal = document.getElementById('authModal');
  if (!authModal) return;
  
  const html = `
    <div style="text-align:center;padding:40px 20px;position:relative;">
      <!-- Bouton X (croix) pour fermer -->
      <button onclick="closeAuthModal()" style="position:absolute;top:16px;right:16px;background:none;border:none;color:var(--ui-text-muted);font-size:24px;cursor:pointer;padding:8px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s;z-index:10;" onmouseover="this.style.background='rgba(239,68,68,0.2)';this.style.color='#ef4444';this.style.transform='scale(1.1)';" onmouseout="this.style.background='none';this.style.color='var(--ui-text-muted)';this.style.transform='scale(1)';" title="Fermer">‚úï</button>
      
      <div style="font-size:64px;margin-bottom:20px;">‚è±Ô∏è</div>
      <h2 style="margin:0 0 12px;font-size:24px;font-weight:700;color:#fff;">Quelque chose cloche...</h2>
      <p style="margin:0 0 24px;font-size:14px;color:var(--ui-text-muted);line-height:1.6;">
        L'inscription prend trop de temps (cold start probable).<br>
        Veuillez r√©essayer ou vous connecter si vous avez d√©j√† un compte.
      </p>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <button onclick="closeAuthModal(); setTimeout(() => { openAuthModal('register'); const el = document.getElementById('register-email'); if (el && '${email}') el.value = '${email}'; const el2 = document.getElementById('register-username'); if (el2 && '${username}') el2.value = '${username}'; }, 200);" style="width:100%;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-weight:700;font-size:15px;cursor:pointer;">
          üîÑ R√©essayer
        </button>
        <button onclick="closeAuthModal(); setTimeout(() => openAuthModal('login'), 200);" style="width:100%;padding:14px;border-radius:12px;border:2px solid rgba(255,255,255,0.2);background:transparent;color:#fff;font-weight:600;font-size:15px;cursor:pointer;">
          üîê Se connecter
        </button>
        <button onclick="closeAuthModal()" style="width:100%;padding:12px;border-radius:10px;border:2px solid rgba(255,255,255,0.1);background:transparent;color:var(--ui-text-muted);font-weight:600;font-size:14px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.3)';this.style.color='var(--ui-text-main)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='var(--ui-text-muted)';">
          Annuler
        </button>
      </div>
    </div>
  `;
  
  authModal.innerHTML = html;
}

// Fonction pour afficher l'erreur de conflit (409)
function showRegisterConflictError(errorData, email) {
  const authModal = document.getElementById('authModal');
  if (!authModal) return;
  
  // Message clair selon le champ en conflit
  let errorMsg = 'Un compte existe d√©j√† avec cet email.';
  let isEmailConflict = false;
  
  if (errorData.code === 'USERNAME_ALREADY_EXISTS') {
    errorMsg = 'Ce nom d\'utilisateur est d√©j√† pris.';
  } else if (errorData.code === 'EMAIL_ALREADY_EXISTS' || errorData.field === 'email') {
    errorMsg = 'Un compte existe d√©j√† avec cet email.';
    isEmailConflict = true;
  } else if (errorData.error) {
    errorMsg = errorData.error;
  }
  
  const html = `
    <div style="text-align:center;padding:40px 20px;position:relative;">
      <!-- Bouton X (croix) pour fermer -->
      <button onclick="closeAuthModal()" style="position:absolute;top:16px;right:16px;background:none;border:none;color:var(--ui-text-muted);font-size:24px;cursor:pointer;padding:8px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s;z-index:10;" onmouseover="this.style.background='rgba(239,68,68,0.2)';this.style.color='#ef4444';this.style.transform='scale(1.1)';" onmouseout="this.style.background='none';this.style.color='var(--ui-text-muted)';this.style.transform='scale(1)';" title="Fermer">‚úï</button>
      
      <div style="font-size:64px;margin-bottom:20px;">‚ö†Ô∏è</div>
      <h2 style="margin:0 0 12px;font-size:24px;font-weight:700;color:#fff;">Compte d√©j√† existant</h2>
      <p style="margin:0 0 24px;font-size:14px;color:var(--ui-text-muted);line-height:1.6;">
        ${errorMsg}<br>
        ${isEmailConflict ? 'Connecte-toi avec ton compte existant.' : 'Veuillez choisir un autre nom d\'utilisateur.'}
      </p>
      <div style="display:flex;flex-direction:column;gap:12px;">
        ${isEmailConflict ? `
          <button onclick="closeAuthModal(); setTimeout(() => { openAuthModal('login'); setTimeout(() => { const el = document.getElementById('login-email'); if (el && '${email}') el.value = '${email}'; }, 300); }, 200);" style="width:100%;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-weight:700;font-size:15px;cursor:pointer;">
            üîê Se connecter
          </button>
          <button onclick="showNotification('Fonctionnalit√© √† venir', 'info')" style="width:100%;padding:12px;border-radius:12px;border:none;background:transparent;color:var(--ui-text-muted);font-weight:500;font-size:14px;cursor:pointer;">
            üîë Mot de passe oubli√©
          </button>
        ` : `
          <button onclick="closeAuthModal(); setTimeout(() => openAuthModal('register'), 200);" style="width:100%;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-weight:700;font-size:15px;cursor:pointer;">
            üîÑ R√©essayer avec un autre nom
          </button>
        `}
        <button onclick="closeAuthModal()" style="width:100%;padding:12px;border-radius:10px;border:2px solid rgba(255,255,255,0.1);background:transparent;color:var(--ui-text-muted);font-weight:600;font-size:14px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.3)';this.style.color='var(--ui-text-main)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='var(--ui-text-muted)';">
          Annuler
        </button>
      </div>
    </div>
  `;
  
  authModal.innerHTML = html;
}

// REMOVED: performRegister() est maintenant dans auth.js et expos√© via window.performRegister
// La fonction compl√®te (~335 lignes) a √©t√© supprim√©e

// REMOVED: performLogin() est maintenant dans auth.js et expos√© via window.performLogin

// Ancien alias pour compatibilit√©
async function simulateLogin() {
  if (typeof window.performLogin === 'function') {
    await window.performLogin();
  }
}

// ============================================
// FORMULAIRE D'INSCRIPTION 3 √âTAPES
// ============================================
// NOTE: registerStep et registerData sont d√©clar√©es dans auth.js et expos√©es via window.registerStep et window.registerData
// V√©rifier que les variables globales existent
if (typeof window.registerStep === 'undefined') {
  window.registerStep = 1;
}
if (typeof window.registerData === 'undefined') {
  window.registerData = {
    email: '',
    username: '',
    password: '',
    avatarId: 1,
    avatarDescription: '',
    addresses: [],
    emailVerificationCode: null,
    emailVerified: false,
    verificationAttempts: 0,
    lastVerificationAttempt: null,
    registrationAttempts: 0,
    lastRegistrationAttempt: null
  };
}

// NOTE: openRegisterModal() est d√©j√† d√©finie plus haut (ligne 9881)
// Cette fonction est supprim√©e pour √©viter les conflits
// Utiliser openAuthModal('register') directement

// Formulaire professionnel style Facebook
function showProRegisterForm() {
  console.log('üéØ showProRegisterForm called');
  
  // Exposer globalement pour le fallback
  if (typeof window !== 'undefined') {
    window.showProRegisterForm = showProRegisterForm;
  }
  
  const backdrop = document.getElementById('publish-modal-backdrop');
  const modal = document.getElementById('publish-modal-inner');

  if (!backdrop) {
    console.error('‚ùå Backdrop not found');
    return;
  }
  
  if (!modal) {
    console.error('‚ùå Modal inner not found');
    return;
  }
  
  console.log('‚úÖ Modal elements found, displaying form...');
  
  // S'assurer que registerData est initialis√©
  if (!window.registerData) {
    window.registerData = {
      email: '',
      username: '',
      password: '',
      passwordConfirm: '',
      firstName: '', // Optionnel - pas utilis√© dans le formulaire pro
      lastName: '', // Optionnel - pas utilis√© dans le formulaire pro
      profilePhoto: '',
      photoData: '', // Initialiser photoData aussi
      postalAddress: '',
      avatarId: 1
    };
    console.log('[REGISTER] registerData initialis√© dans showProRegisterForm');
  } else {
    // S'assurer que photoData existe m√™me si registerData existe d√©j√†
    // CORRECTION: V√©rifier aussi si photoData est une cha√Æne vide
    if ((!window.registerData.photoData || window.registerData.photoData.length === 0) && 
        window.registerData.profilePhoto && window.registerData.profilePhoto.length > 0) {
      window.registerData.photoData = window.registerData.profilePhoto;
      console.log('[REGISTER] ‚úÖ photoData copi√© depuis profilePhoto dans showProRegisterForm');
    }
  }
  
  // Forcer l'affichage du modal
  backdrop.style.display = 'flex';
  backdrop.style.visibility = 'visible';
  backdrop.style.opacity = '1';
  backdrop.style.zIndex = '9999';
  modal.style.display = 'block';
  modal.style.visibility = 'visible';
  modal.style.opacity = '1';

  const html = `
    <style>
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes slideDown {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-5px); }
      }
      .pro-register-error {
        color: #ef4444;
        font-size: 12px;
        margin-top: 4px;
        display: none;
        animation: slideUp 0.3s ease;
      }
      .pro-register-success {
        color: #22c55e;
        font-size: 12px;
        margin-top: 4px;
        display: none;
        animation: slideUp 0.3s ease;
      }
      .pro-register-input.field-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
      }
      .pro-register-input.field-success {
        border-color: #22c55e !important;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1) !important;
      }
      .pro-register-password-strength-fill {
        height: 4px;
        border-radius: 2px;
        transition: all 0.3s ease;
      }
      .pro-register-password-strength-fill.weak {
        background-color: #ef4444;
      }
      .pro-register-password-strength-fill.medium {
        background-color: #f59e0b;
      }
      .pro-register-password-strength-fill.strong {
        background-color: #22c55e;
      }
    </style>
    <div class="pro-register-container" style="position:relative;">
      <!-- Bouton X (croix) pour fermer -->
      <button onclick="closeAuthModal()" style="position:absolute;top:16px;right:16px;background:none;border:none;color:var(--ui-text-muted);font-size:24px;cursor:pointer;padding:8px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s;z-index:10;" onmouseover="this.style.background='rgba(239,68,68,0.2)';this.style.color='#ef4444';this.style.transform='scale(1.1)';" onmouseout="this.style.background='none';this.style.color='var(--ui-text-muted)';this.style.transform='scale(1)';" title="Fermer">‚úï</button>
      
      <div class="pro-register-header">
        <div class="pro-register-logo">üåç</div>
        <h1 class="pro-register-title">Cr√©er un compte</h1>
        <p class="pro-register-subtitle">Rejoignez MapEvent et d√©couvrez les √©v√©nements pr√®s de chez vous</p>
      </div>
      
      <!-- Progress Indicator -->
      <div class="registration-progress" style="display:flex;justify-content:space-between;margin-bottom:24px;padding:0 8px;">
        <div class="progress-step" data-step="1" style="flex:1;text-align:center;padding:8px;border-radius:8px;background:rgba(34,197,94,0.2);color:#22c55e;font-weight:600;font-size:12px;transition:all 0.3s;">
          <div style="width:32px;height:32px;border-radius:50%;background:#22c55e;color:#fff;display:flex;align-items:center;justify-content:center;margin:0 auto 4px;font-weight:bold;">1</div>
          Informations
        </div>
        <div class="progress-step" data-step="2" style="flex:1;text-align:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.05);color:var(--ui-text-muted);font-size:12px;margin:0 8px;transition:all 0.3s;">
          <div style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.1);color:var(--ui-text-muted);display:flex;align-items:center;justify-content:center;margin:0 auto 4px;font-weight:bold;">2</div>
          V√©rification
        </div>
        <div class="progress-step" data-step="3" style="flex:1;text-align:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.05);color:var(--ui-text-muted);font-size:12px;transition:all 0.3s;">
          <div style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.1);color:var(--ui-text-muted);display:flex;align-items:center;justify-content:center;margin:0 auto 4px;font-weight:bold;">3</div>
          Confirmation
        </div>
      </div>

      <form class="pro-register-form" onsubmit="handleProRegisterSubmit(event)">
        <!-- HONEYPOT FIELD (Anti-Bot) - Invisible pour les humains -->
        <input 
          type="text" 
          name="website" 
          id="pro-website-honeypot"
          style="position:absolute;left:-9999px;opacity:0;pointer-events:none;tabindex:-1;"
          autocomplete="off"
          aria-hidden="true"
        >
        
        <!-- Email -->
        <div class="pro-register-field">
          <label class="pro-register-label">
            Email <span class="required">*</span>
          </label>
          <input 
            type="email" 
            id="pro-email" 
            class="pro-register-input" 
            placeholder="votre@email.com"
            required
            value="${window.registerData.email || ''}"
            oninput="if(window.registerData) window.registerData.email = this.value; if(typeof window.validateProField === 'function') window.validateProField('email', this.value)"
          >
          <div id="pro-email-error" class="pro-register-error"></div>
          <div id="pro-email-success" class="pro-register-success"></div>
        </div>

        <!-- Nom d'utilisateur -->
        <div class="pro-register-field">
          <label class="pro-register-label">
            Nom d'utilisateur <span class="required">*</span>
          </label>
          <input 
            type="text" 
            id="pro-username" 
            class="pro-register-input" 
            placeholder="Votre pseudo (3-20 caract√®res)"
            required
            value="${window.registerData.username || ''}"
            oninput="if(window.registerData) window.registerData.username = this.value; if(typeof window.validateProField === 'function') window.validateProField('username', this.value); if(typeof autoSaveRegistrationForm === 'function') autoSaveRegistrationForm();"
          >
          <div id="pro-username-error" class="pro-register-error"></div>
          <div id="pro-username-success" class="pro-register-success"></div>
        </div>

        <!-- Photo de profil -->
        <div class="pro-register-field">
          <label class="pro-register-label">
            Photo de profil <span class="required">*</span>
          </label>
          <div class="pro-register-photo-upload" onclick="event.stopPropagation();event.stopImmediatePropagation();const input = document.getElementById('pro-photo-input'); if(input) input.click(); return false;">
            <img id="pro-photo-preview" class="pro-register-photo-preview" src="${window.registerData.profilePhoto || ''}" alt="Preview">
            <div class="pro-register-photo-placeholder" id="pro-photo-placeholder" style="${window.registerData.profilePhoto ? 'display:none' : 'display:flex'}">
              üì∑
            </div>
            <div class="pro-register-photo-text">
              ${window.registerData.profilePhoto ? 'Cliquez pour changer la photo' : 'Cliquez pour ajouter une photo'}
            </div>
            <input 
              type="file" 
              id="pro-photo-input" 
              class="pro-register-photo-input" 
              accept="image/*"
              onchange="event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();handleProPhotoUpload(event);return false;"
            >
          </div>
          <div id="pro-photo-error" class="pro-register-error"></div>
        </div>

        <!-- Mot de passe -->
        <div class="pro-register-field">
          <label class="pro-register-label">
            Mot de passe <span class="required">*</span>
          </label>
          <div class="pro-register-password-container">
            <input 
              type="password" 
              id="pro-password" 
              class="pro-register-input" 
              placeholder="Minimum 8 caract√®res"
              required
            value="${window.registerData.password || ''}"
            oninput="if(window.registerData) window.registerData.password = this.value; if(typeof validateProPassword === 'function') validateProPassword(this.value)"
            >
            <button type="button" class="pro-register-password-toggle" onclick="event.preventDefault();event.stopPropagation();toggleProPasswordVisibility('pro-password', event);return false;">üëÅÔ∏è</button>
          </div>
          <div class="pro-register-password-strength">
            <div id="pro-password-strength-fill" class="pro-register-password-strength-fill"></div>
          </div>
          <div id="pro-password-error" class="pro-register-error"></div>
        </div>

        <!-- Confirmation mot de passe -->
        <div class="pro-register-field">
          <label class="pro-register-label">
            Confirmer le mot de passe <span class="required">*</span>
          </label>
          <div class="pro-register-password-container">
            <input 
              type="password" 
              id="pro-password-confirm" 
              class="pro-register-input" 
              placeholder="R√©p√©tez le mot de passe"
              required
              value="${window.window.window.registerData.passwordConfirm || ''}"
              oninput="window.window.registerData.passwordConfirm = this.value; validateProPasswordMatch()"
            >
            <button type="button" class="pro-register-password-toggle" onclick="event.preventDefault();event.stopPropagation();toggleProPasswordVisibility('pro-password-confirm', event);return false;">üëÅÔ∏è</button>
          </div>
          <div id="pro-password-confirm-error" class="pro-register-error"></div>
          <div id="pro-password-confirm-success" class="pro-register-success"></div>
        </div>

        <!-- Adresse postale pour les alertes (avec autocomplete OpenStreetMap) -->
        <div class="pro-register-field" style="margin-bottom: 20px;">
          <label class="pro-register-label">
            Adresse postale
            <span style="font-weight: normal; color: var(--ui-text-muted); font-size: 12px;">(pour recevoir les alertes)</span>
          </label>
          <div style="position: relative; z-index: 1;">
            <input 
              type="text" 
              id="pro-postal-address" 
              class="pro-register-input" 
              placeholder="Commencez √† taper votre adresse..."
              value="${window.window.registerData.postalAddress || ''}"
              autocomplete="off"
              oninput="if(typeof autoSaveRegistrationForm === 'function') autoSaveRegistrationForm();"
            >
            <div id="pro-address-suggestions-wrapper" style="position:absolute;top:100%;left:0;right:0;z-index:10001;margin-top:4px;display:none;">
              <div id="pro-address-suggestions" class="address-suggestions" style="display:none;position:relative;width:100%;background:#050810;background-color:#050810;border:2px solid rgba(255,255,255,0.7);border-radius:8px;max-height:120px;overflow-y:auto;opacity:1;backdrop-filter:none;isolation:isolate;mix-blend-mode:normal;box-shadow:0 8px 40px rgba(0,0,0,1), inset 0 0 0 2px rgba(0,0,0,0.5);"></div>
            </div>
            <input type="hidden" id="pro-address-lat" value="${window.registerData.addressLat || ''}">
            <input type="hidden" id="pro-address-lng" value="${window.registerData.addressLng || ''}">
            <input type="hidden" id="pro-address-country" value="${window.registerData.addressCountry || ''}">
            <input type="hidden" id="pro-address-label" value="${window.registerData.addressLabel || ''}">
          </div>
          <div id="pro-postal-address-error" class="pro-register-error"></div>
          <div id="pro-address-status" style="font-size: 12px; color: var(--ui-text-muted); margin-top: 4px;"></div>
          <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px; cursor: pointer; font-size: 13px; color: var(--ui-text-muted);">
            <input 
              type="checkbox" 
              id="pro-skip-address" 
              onchange="updatePostalAddressRequired()"
              style="cursor: pointer;"
            >
            <span>Pas pour l'instant, je v√©rifierai mon adresse plus tard</span>
          </label>
        </div>

        <!-- Consentement RGPD -->
        <div class="pro-register-field" style="margin-top: 51px; position: relative; z-index: 10002;">
          <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer; font-size: 13px; color: var(--ui-text-main);">
            <input 
              type="checkbox" 
              id="pro-consent-terms" 
              required
              style="cursor: pointer; margin-top: 2px; flex-shrink: 0;"
            >
            <span>
              J'accepte les <a href="#" onclick="event.preventDefault();event.stopPropagation();if(typeof window.showTermsModal==='function'){window.showTermsModal();}else if(typeof showTermsModal==='function'){showTermsModal();}return false;" style="color: #3b82f6; text-decoration: underline; cursor: pointer;">Conditions d'utilisation</a> <span style="color: #ef4444;">*</span>
            </span>
          </label>
        </div>
        
        <div class="pro-register-field" style="margin-top: 8px;">
          <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer; font-size: 13px; color: var(--ui-text-main);">
            <input 
              type="checkbox" 
              id="pro-consent-privacy" 
              required
              style="cursor: pointer; margin-top: 2px; flex-shrink: 0;"
            >
            <span>
              J'accepte la <a href="#" onclick="event.preventDefault();event.stopPropagation();if(typeof window.showPrivacyModal==='function'){window.showPrivacyModal();}else if(typeof showPrivacyModal==='function'){showPrivacyModal();}return false;" style="color: #3b82f6; text-decoration: underline; cursor: pointer;">Politique de confidentialit√©</a> <span style="color: #ef4444;">*</span>
            </span>
          </label>
        </div>

        <!-- Bouton de soumission -->
        <div class="pro-register-actions">
          <button type="submit" class="pro-register-btn-primary" id="pro-submit-btn">
            Cr√©er le compte
          </button>
          <button type="button" id="auth-cancel-btn-pro" class="pro-register-btn-secondary" onclick="console.log('[ANNULER PRO] Click detecte');const e=event||window.event;if(e){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();}if(typeof window.fermerModalAuth==='function'){window.fermerModalAuth();}else if(typeof closeAuthModal==='function'){closeAuthModal();}else{const b=document.getElementById('publish-modal-backdrop');const m=document.getElementById('publish-modal-inner');if(b){b.style.display='none';b.style.visibility='hidden';b.style.opacity='0';}if(m){m.innerHTML='';m.style.display='none';}}return false;" style="cursor:pointer;pointer-events:auto;z-index:10001;position:relative;">
            Annuler
          </button>
        </div>
      </form>
    </div>
  `;

  // S'assurer que le modal est visible
  modal.innerHTML = html;
  
  // Forcer l'affichage du backdrop avec tous les styles n√©cessaires
  backdrop.style.display = "flex";
  backdrop.style.visibility = "visible";
  backdrop.style.opacity = "1";
  backdrop.style.zIndex = "99999";
  backdrop.style.position = "fixed";
  backdrop.style.top = "0";
  backdrop.style.left = "0";
  backdrop.style.width = "100%";
  backdrop.style.height = "100%";
  backdrop.style.background = "rgba(0, 0, 0, 0.8)";
  backdrop.style.alignItems = "center";
  backdrop.style.justifyContent = "center";
  
  // Forcer l'affichage du modal inner
  modal.style.display = "block";
  modal.style.visibility = "visible";
  modal.style.opacity = "1";
  
  console.log('‚úÖ Formulaire professionnel affich√©');
  console.log('‚úÖ Backdrop display:', backdrop.style.display);
  console.log('‚úÖ Backdrop computed display:', window.getComputedStyle(backdrop).display);
  console.log('‚úÖ Modal inner HTML length:', modal.innerHTML.length);
  console.log('‚úÖ Modal inner first 200 chars:', modal.innerHTML.substring(0, 200));

  // SOLUTION ULTRA-ROBUSTE : Utiliser la m√™me fonction nomm√©e que dans openAuthModal
  // Supprimer l'ancien event listener si il existe d√©j√† (de openAuthModal)
  if (window._authModalCancelHandler) {
    backdrop.removeEventListener('click', window._authModalCancelHandler, true);
  }
  
  // La fonction _authModalCancelHandler est d√©j√† d√©finie dans openAuthModal
  // Si elle n'existe pas encore, la cr√©er
  if (!window._authModalCancelHandler) {
    window._authModalCancelHandler = function(e) {
      const target = e.target;
      
      // DEBUG : Logger tous les clics sur les boutons
      if (target.tagName === 'BUTTON' || target.closest('button')) {
        const btn = target.tagName === 'BUTTON' ? target : target.closest('button');
        console.log('[PRO REGISTER] üñ±Ô∏è CLIC DETECTE sur bouton:', {
          id: btn.id,
          text: btn.textContent?.trim(),
          onclick: btn.hasAttribute('onclick'),
          isCancelBtn: btn.id === 'auth-cancel-btn' || btn.id === 'auth-cancel-btn-pro'
        });
      }
      
      const isCancelButton = target.id === 'auth-cancel-btn' || 
                            target.id === 'auth-cancel-btn-pro' ||
                            target.closest('#auth-cancel-btn') ||
                            target.closest('#auth-cancel-btn-pro') ||
                            (target.tagName === 'BUTTON' && target.textContent?.trim() === 'Annuler') ||
                            (target.closest('button') && target.closest('button').textContent?.trim() === 'Annuler');
      
      if (isCancelButton) {
        console.log('[PRO REGISTER] üî•üî•üî• BOUTON ANNULER CLIQUE (via event delegation) - FERMETURE IMMEDIATE');
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        e.cancelBubble = true;
        
        const b = document.getElementById('publish-modal-backdrop');
        const m = document.getElementById('publish-modal-inner');
        const a = document.getElementById('authModal');
        const o = document.getElementById('onboardingModal');
        
        if (b) {
          b.style.display = 'none';
          b.style.visibility = 'hidden';
          b.style.opacity = '0';
          b.style.zIndex = '-1';
          b.setAttribute('style', 'display:none!important;visibility:hidden!important;opacity:0!important;z-index:-1!important;');
        }
        if (m) {
          m.innerHTML = '';
          m.style.display = 'none';
          m.setAttribute('style', 'display:none!important;');
        }
        if (a) {
          a.remove();
        }
        if (o) {
          o.remove();
        }
        
        window.pendingRegisterPhoto = null;
        window.registerSelectedAddress = null;
        window.registerPhotoData = null;
        window.registerPhotoFile = null;
        window.isGoogleLoginInProgress = false;
        
        console.log('[PRO REGISTER] ‚úÖ Modal ferme COMPLETEMENT (via event delegation)');
        return false;
      }
      
      // Si on clique directement sur le backdrop (pas sur ses enfants), fermer le modal
      // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è IMPORTANT : Ignorer TOUS les √©l√©ments du formulaire d'inscription
      const isClickOnChild = target.closest('button') || 
                            target.closest('input') || 
                            target.closest('a') || 
                            target.closest('.pro-register-container') ||
                            target.closest('#publish-modal-inner') ||
                            target.closest('#authModal') ||
                            target.closest('.pro-register-photo-upload') ||
                            target.closest('#pro-photo-input') ||
                            target.closest('#pro-photo-preview') ||
                            target.closest('.pro-register-photo-placeholder') ||
                            target.closest('.pro-register-field') ||
                            target.closest('.pro-register-input') ||
                            target.closest('.pro-register-password-container') ||
                            target.closest('.pro-register-password-toggle') ||
                            target.closest('form') ||
                            target.id === 'pro-photo-input' ||
                            target.id === 'pro-photo-preview' ||
                            target.classList?.contains('pro-register-photo-upload') ||
                            target.classList?.contains('pro-register-photo-input') ||
                            target.classList?.contains('pro-register-password-toggle') ||
                            target.classList?.contains('pro-register-password-container');
      
      if (target === backdrop && !isClickOnChild) {
        console.log('[PRO REGISTER] Backdrop click detecte - Fermeture via closeAuthModal');
        closeAuthModal();
      } else if (isClickOnChild) {
        console.log('[PRO REGISTER] Clic sur √©l√©ment du formulaire - IGNOR√â (pas de fermeture)');
      }
    };
  }
  
  // Attacher l'event listener avec useCapture=true pour s'ex√©cuter AVANT tout le monde
  backdrop.addEventListener('click', window._authModalCancelHandler, true);
  console.log('[PRO REGISTER] ‚úÖ Event delegation attachee avec useCapture=true');
  
  // VERIFIER et corriger le bouton Annuler dans showProRegisterForm
  // AUGMENTER le d√©lai pour s'assurer que le HTML est compl√®tement inject√©
  console.log('[PRO REGISTER] ‚è∞ setTimeout PROGRAMM√â pour 200ms...');
  setTimeout(() => {
    console.log('[PRO REGISTER] üîçüîçüîç setTimeout EX√âCUT√â (200ms), recherche des √©l√©ments...');
    const modalInner = document.getElementById('publish-modal-inner');
    console.log('[PRO REGISTER] Modal inner existe:', !!modalInner);
    console.log('[PRO REGISTER] Modal inner HTML length:', modalInner?.innerHTML?.length || 0);
    console.log('[PRO REGISTER] Modal inner contient "pro-photo-input":', modalInner?.innerHTML?.includes('pro-photo-input') || false);
    const cancelBtnPro = document.getElementById('auth-cancel-btn-pro');
    if (cancelBtnPro) {
      console.log('[PRO REGISTER] ‚úÖ Bouton Annuler trouve (auth-cancel-btn-pro)');
      cancelBtnPro.style.pointerEvents = 'auto';
      cancelBtnPro.style.cursor = 'pointer';
      cancelBtnPro.style.zIndex = '10001';
      
      // Ajouter un onclick direct aussi
      cancelBtnPro.onclick = function(e) {
        e = e || window.event;
        if (e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
        }
        console.log('[PRO REGISTER] üî• ONCLICK DIRECT EXECUTE - FERMETURE');
        const b = document.getElementById('publish-modal-backdrop');
        const m = document.getElementById('publish-modal-inner');
        if (b) {
          b.style.display = 'none';
          b.style.visibility = 'hidden';
          b.style.opacity = '0';
        }
        if (m) {
          m.innerHTML = '';
          m.style.display = 'none';
        }
        if (typeof closeAuthModal === 'function') {
          closeAuthModal();
        }
        return false;
      };
      console.log('[PRO REGISTER] ‚úÖ ONCLICK DIRECT attache au bouton Annuler');
    } else {
      console.warn('[PRO REGISTER] ‚ö†Ô∏è Bouton Annuler non trouve');
    }
    
    // CORRECTION: Attacher aussi un event listener programmatique pour l'input photo
    try {
      console.log('[PRO REGISTER] üî•üî•üî• AVANT recherche pro-photo-input - Code toujours actif');
      console.log('[PRO REGISTER] üîç Recherche de pro-photo-input...');
    console.log('[PRO REGISTER] document.getElementById existe:', typeof document.getElementById);
    const photoInput = document.getElementById('pro-photo-input');
    console.log('[PRO REGISTER] R√©sultat getElementById:', photoInput);
    if (photoInput) {
      console.log('[PRO REGISTER] ‚úÖ‚úÖ‚úÖ Input photo TROUV√â!', photoInput);
      console.log('[PRO REGISTER] Type:', photoInput.type, 'ID:', photoInput.id);
      console.log('[PRO REGISTER] Parent:', photoInput.parentElement?.id || 'pas de parent');
      console.log('[PRO REGISTER] Visible:', photoInput.offsetParent !== null);
      
      // V√©rifier si handleProPhotoUpload existe
      console.log('[PRO REGISTER] handleProPhotoUpload existe:', typeof handleProPhotoUpload);
      console.log('[PRO REGISTER] window.handleProPhotoUpload existe:', typeof window.handleProPhotoUpload);
      
      // Supprimer l'ancien listener s'il existe
      photoInput.removeEventListener('change', handleProPhotoUpload);
      
      // Cr√©er une fonction wrapper pour capturer l'√©v√©nement
      const photoChangeHandler = function(e) {
        console.log('[PRO REGISTER] üî•üî•üî•üî•üî• EVENT CHANGE D√âTECT√â sur pro-photo-input!', e);
        console.log('[PRO REGISTER] Fichiers s√©lectionn√©s:', e.target.files ? e.target.files.length : 0);
        e.stopPropagation(); // Emp√™cher la propagation vers closePublishModal
        
        // Appeler handleProPhotoUpload directement (elle doit √™tre d√©finie globalement)
        if (typeof window.handleProPhotoUpload === 'function') {
          console.log('[PRO REGISTER] ‚úÖ Appel de window.handleProPhotoUpload...');
          window.handleProPhotoUpload(e);
        } else {
          console.error('[PRO REGISTER] ‚ùå‚ùå‚ùå window.handleProPhotoUpload n\'est PAS une fonction!', typeof window.handleProPhotoUpload);
          // D√©finir inline si elle n'existe pas encore
          window.handleProPhotoUpload = function(event) {
            console.log('[PHOTO] üî•üî•üî• handleProPhotoUpload INLINE APPEL√âE!', event);
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) {
              showError('pro-photo-error', 'La photo est trop grande (max 5MB)');
              return;
            }
            if (!file.type.startsWith('image/')) {
              showError('pro-photo-error', 'Veuillez s√©lectionner une image');
              return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
              const base64 = e.target.result;
              if (!window.registerData) window.registerData = {};
              window.registerData.profilePhoto = base64;
              window.registerData.photoData = base64;
              console.log('[PHOTO] ‚úÖ‚úÖ‚úÖ Photo sauvegard√©e (INLINE) - photoData:', base64.length, 'chars');
              const preview = document.getElementById('pro-photo-preview');
              const placeholder = document.getElementById('pro-photo-placeholder');
              if (preview) {
                preview.src = base64;
                preview.style.display = 'block';
                preview.classList.add('show');
              }
              if (placeholder) placeholder.style.display = 'none';
              showError('pro-photo-error', '');
            };
            reader.readAsDataURL(file);
          };
          console.log('[PRO REGISTER] ‚úÖ handleProPhotoUpload d√©finie inline, appel...');
          window.handleProPhotoUpload(e);
        }
      };
      
      // Ajouter le nouveau listener avec capture pour s'assurer qu'il est appel√© AVANT closePublishModal
      photoInput.addEventListener('change', photoChangeHandler, true); // useCapture=true
      photoInput.addEventListener('input', photoChangeHandler, true); // Aussi sur 'input' au cas o√π
      console.log('[PRO REGISTER] ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ Event listeners change ET input attach√©s a pro-photo-input avec useCapture=true');
      
      // V√©rifier aussi l'attribut onchange
      if (photoInput.getAttribute('onchange')) {
        console.log('[PRO REGISTER] ‚úÖ Attribut onchange pr√©sent:', photoInput.getAttribute('onchange'));
      } else {
        console.warn('[PRO REGISTER] ‚ö†Ô∏è Attribut onchange manquant, ajout programmatique');
        photoInput.setAttribute('onchange', 'handleProPhotoUpload(event)');
      }
      
      // Emp√™cher le clic sur l'input de d√©clencher closePublishModal
      photoInput.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        if (e.cancelBubble !== undefined) {
          e.cancelBubble = true;
        }
        console.log('[PRO REGISTER] üî• Clic sur input photo, propagation stopp√©e');
        return false;
      }, true);
    } else {
      console.error('[PRO REGISTER] ‚ùå‚ùå‚ùå Input photo NON TROUV√â!');
      console.error('[PRO REGISTER] Tous les √©l√©ments avec "photo" dans l\'ID:');
      const allElements = document.querySelectorAll('[id*="photo"]');
      allElements.forEach(el => console.log('[PRO REGISTER]   -', el.id, el.tagName));
      
      // R√©essayer plusieurs fois avec des d√©lais croissants
      [300, 500, 1000].forEach((delay, index) => {
        setTimeout(() => {
          console.log(`[PRO REGISTER] üîÑ Retry ${index + 1} apr√®s ${delay}ms...`);
          const retryInput = document.getElementById('pro-photo-input');
          if (retryInput) {
            console.log(`[PRO REGISTER] ‚úÖ‚úÖ‚úÖ Input photo trouv√© au retry ${index + 1}!`);
            const photoChangeHandler = function(e) {
              console.log('[PRO REGISTER] üî• EVENT CHANGE (retry)', e);
              e.stopPropagation();
              if (typeof handleProPhotoUpload === 'function') {
                handleProPhotoUpload(e);
              } else if (typeof window.handleProPhotoUpload === 'function') {
                window.handleProPhotoUpload(e);
              }
            };
            retryInput.addEventListener('change', photoChangeHandler, true);
            retryInput.addEventListener('click', function(e) {
              e.stopPropagation();
              console.log('[PRO REGISTER] üî• Clic sur input photo (retry), propagation stopp√©e');
            }, true);
            console.log(`[PRO REGISTER] ‚úÖ Event listeners attach√©s au retry ${index + 1}`);
          } else {
            console.warn(`[PRO REGISTER] ‚ö†Ô∏è Input photo toujours non trouv√© au retry ${index + 1}`);
          }
        }, delay);
      });
    }
    } catch (error) {
      console.error('[PRO REGISTER] ‚ùå‚ùå‚ùå ERREUR lors de l\'attachement de l\'event listener photo:', error);
      console.error('[PRO REGISTER] Stack trace:', error.stack);
    }
  }, 200); // Augment√© √† 200ms pour laisser plus de temps au DOM

  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è NOUVEAU : Attacher un event listener sur la zone de photo pour ouvrir le s√©lecteur
  setTimeout(() => {
    const photoUploadArea = document.querySelector('.pro-register-photo-upload');
    const photoInput = document.getElementById('pro-photo-input');
    
    if (photoUploadArea && photoInput) {
      // Supprimer l'ancien listener s'il existe
      photoUploadArea.removeEventListener('click', window._photoUploadClickHandler);
      
      // Cr√©er un nouveau handler qui ouvre le s√©lecteur sans fermer le formulaire
      window._photoUploadClickHandler = function(e) {
        console.log('[PHOTO] Clic sur zone de photo d√©tect√©');
        e.stopPropagation();
        e.stopImmediatePropagation();
        if (e.cancelBubble !== undefined) {
          e.cancelBubble = true;
        }
        
        // Ouvrir le s√©lecteur de fichiers
        if (photoInput) {
          photoInput.click();
        }
        
        return false;
      };
      
      // Attacher le listener avec useCapture pour intercepter avant les autres
      photoUploadArea.addEventListener('click', window._photoUploadClickHandler, true);
      console.log('[PHOTO] ‚úÖ Event listener attach√© sur zone de photo');
    }
  }, 300);
  
  // Initialiser l'autocomplete d'adresse pour le formulaire pro
  setTimeout(() => {
    const addressInput = document.getElementById('pro-postal-address');
    if (addressInput) {
      setupProAddressAutocomplete(addressInput);
    } else {
      console.warn('[PRO REGISTER] ‚ö†Ô∏è Champ pro-postal-address non trouv√©');
    }
  }, 100);

  // Restaurer le formulaire depuis localStorage si un draft existe
  setTimeout(() => {
    if (typeof restoreRegistrationForm === 'function') {
      const restored = restoreRegistrationForm();
      if (restored) {
        console.log('[PRO REGISTER] ‚úÖ Formulaire restaur√© depuis localStorage');
      }
    }
  }, 200);
  
  // Focus sur le premier champ (email au lieu de firstname car firstname n'existe peut-√™tre pas)
  // Utiliser requestAnimationFrame pour s'assurer que le DOM est pr√™t
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      // Chercher dans l'ordre : email, username, password
      const firstInput = document.getElementById("pro-email") || 
                        document.getElementById("pro-username") || 
                        document.getElementById("pro-password");
      if (firstInput) {
        firstInput.focus();
        console.log('‚úÖ Focus sur le premier champ:', firstInput.id);
      } else {
        console.warn('‚ö†Ô∏è Premier champ non trouv√© (pro-email, pro-username, pro-password)');
        // Lister tous les inputs pour debug
        const modalInner = document.getElementById('publish-modal-inner');
        if (modalInner) {
          const allInputs = document.querySelectorAll('#publish-modal-inner input:not([type="hidden"]):not([id*="honeypot"])');
          console.log('[PRO REGISTER] Tous les inputs trouv√©s:', Array.from(allInputs).map(i => ({id: i.id, type: i.type, visible: i.offsetParent !== null})));
          // Essayer de focuser le premier input trouv√©
          if (allInputs.length > 0) {
            const firstFound = allInputs[0];
            firstFound.focus();
            console.log('‚úÖ Focus sur le premier input trouv√©:', firstFound.id);
          }
        }
      }
    });
  });
  
  // CORRECTION: Attacher l'event listener pour l'input photo IMM√âDIATEMENT apr√®s l'injection HTML
  // Ne pas attendre le setTimeout, mais utiliser requestAnimationFrame pour s'assurer que le DOM est pr√™t
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      console.log('[PRO REGISTER] üîçüîçüîç Recherche IMM√âDIATE de pro-photo-input (via requestAnimationFrame)');
      const photoInput = document.getElementById('pro-photo-input');
      if (photoInput) {
        console.log('[PRO REGISTER] ‚úÖ‚úÖ‚úÖ Input photo TROUV√â IMM√âDIATEMENT!');
        const photoChangeHandler = function(e) {
          console.log('[PRO REGISTER] üî•üî•üî• EVENT CHANGE D√âTECT√â sur pro-photo-input!');
          e.stopPropagation();
          if (typeof handleProPhotoUpload === 'function') {
            handleProPhotoUpload(e);
          } else if (typeof window.handleProPhotoUpload === 'function') {
            window.handleProPhotoUpload(e);
          }
        };
        photoInput.addEventListener('change', photoChangeHandler, true);
        photoInput.addEventListener('click', function(e) {
          e.stopPropagation();
          console.log('[PRO REGISTER] üî• Clic sur input photo, propagation stopp√©e');
        }, true);
        console.log('[PRO REGISTER] ‚úÖ‚úÖ‚úÖ Event listeners attach√©s IMM√âDIATEMENT');
      } else {
        console.warn('[PRO REGISTER] ‚ö†Ô∏è Input photo non trouv√© imm√©diatement, retry dans setTimeout');
      }
    });
  });
}

// Fonction d'autocomplete d'adresse pour le formulaire pro (Nominatim)
function setupProAddressAutocomplete(input) {
  if (!input) {
    console.error('[PRO ADDRESS] ‚ùå Input non fourni √† setupProAddressAutocomplete');
    return;
  }
  
  console.log('[PRO ADDRESS] ‚úÖ Initialisation autocomplete pour:', input.id);
  
  let searchTimeout = null;
  const suggestionsWrapper = document.getElementById('pro-address-suggestions-wrapper');
  const suggestionsDiv = document.getElementById('pro-address-suggestions');
  
  if (!suggestionsDiv || !suggestionsWrapper) {
    console.error('[PRO ADDRESS] ‚ùå Div suggestions ou wrapper non trouv√©');
    return;
  }
  
  // G√©rer la saisie
  input.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    // Effacer le timeout pr√©c√©dent
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }
    
    // Masquer les suggestions si vide
    if (!query || query.length < 3) {
      suggestionsWrapper.style.display = 'none';
      suggestionsDiv.style.display = 'none';
      // Supprimer l'overlay
      const overlay = document.getElementById('pro-address-suggestions-overlay');
      if (overlay) overlay.remove();
      // R√©initialiser les champs cach√©s
      const latInput = document.getElementById('pro-address-lat');
      const lngInput = document.getElementById('pro-address-lng');
      const countryInput = document.getElementById('pro-address-country');
      const labelInput = document.getElementById('pro-address-label');
      if (latInput) latInput.setAttribute('value', '');
      if (lngInput) lngInput.setAttribute('value', '');
      if (countryInput) countryInput.setAttribute('value', '');
      if (labelInput) labelInput.setAttribute('value', '');
      return;
    }
    
    // Rechercher apr√®s 500ms de pause
    searchTimeout = setTimeout(() => {
      searchAddressNominatim(query);
    }, 500);
  });
  
  // Fonction de recherche Nominatim
  async function searchAddressNominatim(query) {
    try {
      console.log('[PRO ADDRESS] üîç Recherche Nominatim pour:', query);
      
      // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Recherche MONDIALE - pas de restriction de pays
      // Nominatim supporte toutes les adresses du monde (Afrique, Asie, Am√©riques, Oc√©anie, etc.)
      // D√©tection automatique de la langue depuis le navigateur pour traduction Google
      const userLanguage = navigator.language || navigator.userLanguage || 'fr';
      const langCode = userLanguage.split('-')[0]; // 'fr', 'en', 'ar', 'sw', 'zh', etc.
      
      console.log('[PRO ADDRESS] üåç Langue d√©tect√©e:', langCode, '- Recherche MONDIALE activ√©e');
      
      // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è RECHERCHE MONDIALE - Pas de restriction de pays
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=10&addressdetails=1&accept-language=${langCode},en`,
        {
          headers: {
            'Accept-Language': `${langCode},en,fr`,
            'User-Agent': 'MapEvent/1.0'
          }
        }
      );
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const results = await response.json();
      console.log('[PRO ADDRESS] ‚úÖ R√©sultats Nominatim:', results.length, 'r√©sultats');
      
      if (results.length === 0) {
        // Afficher le wrapper et les suggestions avec fond opaque (hauteur de ~2 adresses)
        suggestionsWrapper.style.display = 'block';
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Message clair : adresse non trouv√©e (peut √™tre une adresse tr√®s recul√©e)
        const langCode = (navigator.language || navigator.userLanguage || 'fr').split('-')[0];
        const messages = {
          'fr': 'Aucune adresse trouv√©e. Essayez avec un nom de ville ou un point de rep√®re proche.',
          'en': 'No address found. Try with a city name or nearby landmark.',
          'ar': 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿπŸÜŸàÿßŸÜ. ÿ¨ÿ±ÿ® ÿßÿ≥ŸÖ ÿßŸÑŸÖÿØŸäŸÜÿ© ÿ£Ÿà ŸÖÿπŸÑŸÖ ŸÇÿ±Ÿäÿ®.',
          'sw': 'Hakuna anwani iliyopatikana. Jaribu jina la jiji au alama ya karibu.',
          'es': 'No se encontr√≥ ninguna direcci√≥n. Pruebe con un nombre de ciudad o un punto de referencia cercano.',
          'pt': 'Nenhum endere√ßo encontrado. Tente com um nome de cidade ou um ponto de refer√™ncia pr√≥ximo.',
          'zh': 'Êú™ÊâæÂà∞Âú∞ÂùÄ„ÄÇËØ∑Â∞ùËØï‰ΩøÁî®ÂüéÂ∏ÇÂêçÁß∞ÊàñÈôÑËøëÁöÑÂú∞Ê†á„ÄÇ'
        };
        const message = messages[langCode] || messages['en'];
        suggestionsDiv.innerHTML = `<div class="address-suggestion" style="padding:12px;color:#a0a0a0;background:#050810;background-color:#050810;opacity:1;mix-blend-mode:normal;">${message}</div>`;
        suggestionsDiv.style.cssText = 'display:block;position:relative;width:100%;background:#050810;background-color:#050810;border:2px solid rgba(255,255,255,0.7);border-radius:8px;max-height:120px;overflow-y:auto;opacity:1;backdrop-filter:none;isolation:isolate;mix-blend-mode:normal;box-shadow:0 8px 40px rgba(0,0,0,1), inset 0 0 0 2px rgba(0,0,0,0.5);';
        return;
      }
      
      // Afficher le wrapper avec fond opaque
      suggestionsWrapper.style.display = 'block';
      
      // Afficher les suggestions avec fond opaque
      suggestionsDiv.innerHTML = results.map((result, index) => {
        const displayName = result.display_name || '';
        const lat = parseFloat(result.lat);
        const lng = parseFloat(result.lon);
        const country = result.address?.country_code?.toUpperCase() || ''; // Pas de pays par d√©faut - mondial
        const city = result.address?.city || result.address?.town || result.address?.village || '';
        const postcode = result.address?.postcode || '';
        const street = result.address?.road || result.address?.street || '';
        
        return `
          <div class="address-suggestion" data-index="${index}" style="padding:12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2);transition:background 0.2s;background:#050810;background-color:#050810;opacity:1;backdrop-filter:none;isolation:isolate;mix-blend-mode:normal;" 
               onmouseover="this.style.background='rgba(0,255,195,0.3)';this.style.backgroundColor='rgba(0,255,195,0.3)';" 
               onmouseout="this.style.background='#050810';this.style.backgroundColor='#050810';"
               onclick="selectProAddress(${index}, '${displayName.replace(/'/g, "\\'")}', ${lat}, ${lng}, '${country}', '${city}', '${postcode}', '${street.replace(/'/g, "\\'")}')">
            <div style="font-weight:600;color:#ffffff;margin-bottom:4px;background:transparent;background-color:transparent;">${displayName}</div>
            <div style="font-size:12px;color:#a0a0a0;background:transparent;background-color:transparent;">${city}${postcode ? ' ' + postcode : ''}${country ? ', ' + country : ''}</div>
          </div>
        `;
      }).join('');
      
      // Forcer le style du conteneur avec fond opaque COMPLET (hauteur de ~2 adresses avec scroll)
      suggestionsDiv.style.cssText = 'display:block;position:relative;width:100%;background:#050810;background-color:#050810;border:2px solid rgba(255,255,255,0.7);border-radius:8px;max-height:120px;overflow-y:auto;opacity:1;backdrop-filter:none;isolation:isolate;mix-blend-mode:normal;box-shadow:0 8px 40px rgba(0,0,0,1), inset 0 0 0 2px rgba(0,0,0,0.5);';
      
    } catch (error) {
      console.error('[PRO ADDRESS] ‚ùå Erreur Nominatim:', error);
      suggestionsWrapper.style.display = 'block';
      suggestionsDiv.innerHTML = '<div class="address-suggestion" style="padding:12px;color:#ef4444;background:#050810;background-color:#050810;opacity:1;mix-blend-mode:normal;">Erreur de recherche. Veuillez r√©essayer.</div>';
      suggestionsDiv.style.cssText = 'display:block;position:relative;width:100%;background:#050810;background-color:#050810;border:2px solid rgba(255,255,255,0.7);border-radius:8px;max-height:120px;overflow-y:auto;opacity:1;backdrop-filter:none;isolation:isolate;mix-blend-mode:normal;box-shadow:0 8px 40px rgba(0,0,0,1), inset 0 0 0 2px rgba(0,0,0,0.5);';
    }
  }
  
  // Fonction de s√©lection d'adresse
  window.selectProAddress = function(index, label, lat, lng, country, city, postcode, street) {
    console.log('[PRO ADDRESS] ‚úÖ Adresse s√©lectionn√©e:', { label, lat, lng, country });
    
    // Masquer les suggestions
    const suggestionsWrapper = document.getElementById('pro-address-suggestions-wrapper');
    const suggestionsDiv = document.getElementById('pro-address-suggestions');
    if (suggestionsWrapper) suggestionsWrapper.style.display = 'none';
    if (suggestionsDiv) suggestionsDiv.style.display = 'none';
    
    // Supprimer l'overlay s'il existe
    const overlay = document.getElementById('pro-address-suggestions-overlay');
    if (overlay) overlay.remove();
    
    // Mettre √† jour le champ input
    const addressInput = document.getElementById('pro-postal-address');
    if (addressInput) addressInput.value = label;
    
    // Mettre √† jour les champs cach√©s
    const latInput = document.getElementById('pro-address-lat');
    const lngInput = document.getElementById('pro-address-lng');
    const countryInput = document.getElementById('pro-address-country');
    const labelInput = document.getElementById('pro-address-label');
    
    if (latInput) latInput.setAttribute('value', lat);
    if (lngInput) lngInput.setAttribute('value', lng);
    if (countryInput) countryInput.setAttribute('value', country);
    if (labelInput) labelInput.setAttribute('value', label);
    
    // Sauvegarder dans registerData
    if (!window.registerData) {
      window.registerData = {};
    }
    window.registerData.postalAddress = label;
    window.registerData.addressLat = lat;
    window.registerData.addressLng = lng;
    window.registerData.addressCountry = country;
    window.registerData.addressCity = city;
    window.registerData.addressPostcode = postcode;
    window.registerData.addressStreet = street;
    
    // Masquer les suggestions
    suggestionsDiv.style.display = 'none';
    
    // Valider le champ
    if (typeof window.validateProField === 'function') {
      window.validateProField('postalAddress', label);
    }
    
    console.log('[PRO ADDRESS] ‚úÖ Adresse sauvegard√©e dans registerData');
  };
  
  // Masquer les suggestions si on clique ailleurs
  document.addEventListener('click', function(e) {
    const suggestionsWrapper = document.getElementById('pro-address-suggestions-wrapper');
    if (suggestionsWrapper && !input.contains(e.target) && !suggestionsWrapper.contains(e.target)) {
      suggestionsWrapper.style.display = 'none';
      suggestionsDiv.style.display = 'none';
      // Supprimer l'overlay s'il existe
      const overlay = document.getElementById('pro-address-suggestions-overlay');
      if (overlay) overlay.remove();
    }
  });
}

// Exposer globalement
window.setupProAddressAutocomplete = setupProAddressAutocomplete;

// Gestion de l'upload de photo de profil
function handleProPhotoUpload(event) {
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Emp√™cher TOUTE propagation pour √©viter la fermeture du formulaire
  if (event) {
    event.preventDefault();
    event.stopPropagation();
    event.stopImmediatePropagation();
    if (event.cancelBubble !== undefined) {
      event.cancelBubble = true;
    }
  }
  console.log('[PHOTO] üî•üî•üî• handleProPhotoUpload APPEL√âE!', event);
  const file = event.target.files[0];
  if (!file) {
    console.log('[PHOTO] Aucun fichier s√©lectionn√©');
    return;
  }

  console.log('[PHOTO] üìÅ Fichier d√©tect√©:', { name: file.name, size: file.size, type: file.type });

  // V√©rifier la taille (max 5MB)
  if (file.size > 5 * 1024 * 1024) {
    showError('pro-photo-error', 'La photo est trop grande (max 5MB)');
    console.error('[PHOTO] Fichier trop grand:', file.size);
    return;
  }

  // V√©rifier le type
  if (!file.type.startsWith('image/')) {
    showError('pro-photo-error', 'Veuillez s√©lectionner une image');
    console.error('[PHOTO] Type de fichier invalide:', file.type);
    return;
  }

  console.log('[PHOTO] ‚úÖ Fichier valide, d√©but conversion en base64...');

  // Lire et convertir en Base64
  const reader = new FileReader();
  reader.onload = function(e) {
    const base64 = e.target.result;
    console.log('[PHOTO] ‚úÖ Photo convertie en base64, longueur:', base64.length);
    
    // S'assurer que registerData existe
    if (!window.registerData) {
      window.registerData = {};
      console.log('[PHOTO] ‚ö†Ô∏è registerData cr√©√© car n\'existait pas');
    }
    
    // Sauvegarder dans registerData.profilePhoto ET registerData.photoData
    window.registerData.profilePhoto = base64;
    window.registerData.photoData = base64; // AUSSI dans photoData pour compatibilit√©
    
    console.log('[PHOTO] ‚úÖ‚úÖ‚úÖ Photo sauvegard√©e dans registerData.profilePhoto ET registerData.photoData');
    console.log('[PHOTO] registerData.profilePhoto existe:', !!window.registerData.profilePhoto);
    console.log('[PHOTO] registerData.photoData existe:', !!window.registerData.photoData);
    console.log('[PHOTO] registerData.photoData longueur:', window.registerData.photoData ? window.registerData.photoData.length : 0);
    console.log('[PHOTO] registerData.photoData d√©but:', window.registerData.photoData ? (window.registerData.photoData.substring(0, 50) + '...') : 'null');
    
    // Afficher la preview
    const preview = document.getElementById('pro-photo-preview');
    const placeholder = document.getElementById('pro-photo-placeholder');
    const photoText = document.querySelector('.pro-register-photo-text');
    
    if (preview) {
      preview.src = base64;
      preview.style.display = 'block';
      preview.classList.add('show');
      console.log('[PHOTO] ‚úÖ Preview mise √† jour avec base64');
    } else {
      console.warn('[PHOTO] ‚ö†Ô∏è Preview non trouv√©e');
    }
    if (placeholder) {
      placeholder.style.display = 'none';
    }
    if (photoText) {
      photoText.textContent = 'Cliquez pour changer la photo';
    }
    
    // Cacher l'erreur
    showError('pro-photo-error', '');
    
    // V√©rification finale
    setTimeout(() => {
      console.log('[PHOTO] üîç V√âRIFICATION FINALE apr√®s 100ms:');
      console.log('[PHOTO] registerData existe:', !!window.registerData);
      console.log('[PHOTO] registerData.photoData:', window.registerData?.photoData ? 'PR√âSENT (' + window.registerData.photoData.length + ' chars)' : 'NULL');
      console.log('[PHOTO] registerData.profilePhoto:', window.registerData?.profilePhoto ? 'PR√âSENT (' + window.registerData.profilePhoto.length + ' chars)' : 'NULL');
    }, 100);
  };
  
  reader.onerror = function(error) {
    console.error('[PHOTO] ‚ùå Erreur lors de la lecture du fichier:', error);
    showError('pro-photo-error', 'Erreur lors de la lecture de la photo');
  };
  
  reader.readAsDataURL(file);
  console.log('[PHOTO] üìñ FileReader.readAsDataURL() appel√©');
}

// Exposer globalement
// Exposer handleProPhotoUpload globalement AVANT qu'elle soit utilis√©e
window.handleProPhotoUpload = handleProPhotoUpload;
console.log('[PHOTO] ‚úÖ handleProPhotoUpload expos√©e globalement');

// Fonctions globales pour √©viter les erreurs "is not defined" (PRIORIT√â 0)
window.handleAddressInput = function(event) {
  // Cette fonction est g√©r√©e par setupProAddressAutocomplete
  // Mais on la d√©finit globalement pour √©viter les erreurs si appel√©e inline
  const input = event.target;
  if (input && input.id === 'pro-postal-address') {
    // L'autocomplete est g√©r√© par setupProAddressAutocomplete
    return;
  }
};

window.handleAddressFocus = function(event) {
  // Fonction vide pour √©viter les erreurs - l'autocomplete g√®re le focus
};

window.handleAddressBlur = function(event) {
  // Fonction vide pour √©viter les erreurs - l'autocomplete g√®re le blur
};

// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FONCTION DUPLIQU√âE SUPPRIM√âE - La fonction setupProAddressAutocomplete est d√©j√† d√©finie ligne 12439
// Cette fonction clonait l'input et cassait l'autocomplete, elle a √©t√© supprim√©e
// Utiliser la fonction d√©finie ligne 12439 √† la place
function setupProAddressAutocomplete_DUPLICATE_REMOVED(inputElement) {
  // Cette fonction a √©t√© supprim√©e car elle clonait l'input et cassait l'autocomplete
  // Utiliser la fonction d√©finie ligne 12439 √† la place
  console.warn('[PRO ADDRESS] ‚ö†Ô∏è Fonction dupliqu√©e appel√©e - redirection vers la fonction principale');
  const mainFunction = window.setupProAddressAutocomplete;
  if (mainFunction && typeof mainFunction === 'function') {
    return mainFunction(inputElement);
  }
  return;
  
  /* CODE SUPPRIM√â - Utiliser la fonction ligne 12439
  let timeout;
  const suggestionsContainer = document.getElementById('pro-address-suggestions');
  
  if (!inputElement || !suggestionsContainer) {
    console.warn('[PRO ADDRESS] Input ou container non trouv√©');
    return;
  }
  
  // Supprimer les anciens listeners pour √©viter les doublons
  const newInput = inputElement.cloneNode(true);
  inputElement.parentNode.replaceChild(newInput, inputElement);
  
  newInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    clearTimeout(timeout);
    
    if (query.length < 3) {
      if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
      }
      return;
    }
    
    timeout = setTimeout(async () => {
      try {
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è RECHERCHE MONDIALE - Pas de restriction de pays, support multilingue
        const langCode = (navigator.language || 'fr').split('-')[0];
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&addressdetails=1&accept-language=${langCode},en&dedupe=1`, {
          headers: {
            'User-Agent': 'MapEventAI/1.0',
            'Accept-Language': `${langCode},en,fr`
          }
        });
        
        if (!response.ok) {
          console.warn('[PRO ADDRESS] Nominatim erreur HTTP:', response.status);
          if (suggestionsContainer) {
            suggestionsContainer.style.display = 'none';
          }
          return;
        }
        
        const text = await response.text();
        let results;
        try {
          results = JSON.parse(text);
        } catch (parseError) {
          console.error('[PRO ADDRESS] Erreur parsing JSON:', parseError);
          if (suggestionsContainer) {
            suggestionsContainer.style.display = 'none';
          }
          return;
        }
        
        if (suggestionsContainer && results.length > 0) {
          const sortedResults = results.sort((a, b) => {
            const aHasFullAddress = a.address?.road && (a.address?.house_number || a.address?.house);
            const bHasFullAddress = b.address?.road && (b.address?.house_number || b.address?.house);
            if (aHasFullAddress && !bHasFullAddress) return -1;
            if (!aHasFullAddress && bHasFullAddress) return 1;
            return 0;
          });
          
          suggestionsContainer.innerHTML = sortedResults.map(result => {
            const hasFullAddress = result.address?.road && (result.address?.house_number || result.address?.house);
            const addressQuality = hasFullAddress ? '‚úÖ' : 'üìç';
            return `
            <div class="pro-address-suggestion" style="padding:12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.1);transition:background 0.2s;" 
                 onmouseover="this.style.background='rgba(0,255,195,0.1)'" 
                 onmouseout="this.style.background='transparent'"
                 data-lat="${result.lat}" 
                 data-lng="${result.lon}"
                 data-label="${result.display_name}"
                 data-country="${result.address?.country_code?.toUpperCase() || ''}"
                 data-city="${result.address?.city || result.address?.town || result.address?.village || ''}"
                 data-postcode="${result.address?.postcode || ''}"
                 data-street="${result.address?.road || ''}">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <span style="font-size:14px;">${addressQuality}</span>
                <div style="font-weight:600;color:var(--ui-text-main);font-size:13px;flex:1;">${result.display_name}</div>
              </div>
              <div style="font-size:11px;color:var(--ui-text-muted);padding-left:22px;">${result.address?.country || ''}${result.address?.postcode ? ' ‚Ä¢ ' + result.address.postcode : ''}</div>
            </div>
          `;
          }).join('');
          
          suggestionsContainer.style.display = 'block';
          
          suggestionsContainer.querySelectorAll('.pro-address-suggestion').forEach(suggestion => {
            suggestion.addEventListener('click', function() {
              const addressData = {
                lat: parseFloat(this.dataset.lat),
                lng: parseFloat(this.dataset.lng),
                label: this.dataset.label,
                country_code: this.dataset.country,
                city: this.dataset.city,
                postcode: this.dataset.postcode,
                street: this.dataset.street
              };
              
              newInput.value = addressData.label;
              document.getElementById('pro-address-lat').value = addressData.lat;
              document.getElementById('pro-address-lng').value = addressData.lng;
              document.getElementById('pro-address-country').value = addressData.country_code;
              document.getElementById('pro-address-label').value = addressData.label;
              
              if (suggestionsContainer) {
                suggestionsContainer.style.display = 'none';
              }
            });
          });
        } else if (suggestionsContainer) {
          suggestionsContainer.style.display = 'none';
        }
      } catch (error) {
        console.error('[PRO ADDRESS] Erreur autocomplete:', error);
      }
    }, 300);
  });
  
  // CODE SUPPRIM√â - Cette fonction dupliqu√©e cassait l'autocomplete en clonant l'input
}

// Gestion de l'upload de photo
// D√âPLAC√â: Cette fonction est d√©j√† d√©finie plus haut (ligne ~12164)
// La d√©finition ci-dessus √©tait un doublon qui √©crasait la premi√®re version
// et ne sauvegardait pas photoData. Supprim√©e pour √©viter les conflits.

// Validation des champs
async function validateProField(fieldName, value) {
  const errorEl = document.getElementById(`pro-${fieldName}-error`);
  const successEl = document.getElementById(`pro-${fieldName}-success`);
  const inputEl = document.getElementById(`pro-${fieldName}`);
  
  if (!errorEl || !inputEl) return true;

  // R√©initialiser les √©tats visuels
  inputEl.classList.remove('field-error', 'field-success');
  inputEl.style.borderColor = '';
  inputEl.style.boxShadow = '';
  showError(`pro-${fieldName}-error`, '');
  showSuccess(`pro-${fieldName}-success`, '');

  let isValid = true;
  let errorMsg = '';
  let successMsg = '';

  switch(fieldName) {
    case 'firstname':
    case 'lastname':
      if (!value || value.trim().length < 2) {
        isValid = false;
        errorMsg = '‚ö†Ô∏è Minimum 2 caract√®res requis';
      } else if (value.length > 50) {
        isValid = false;
        errorMsg = '‚ö†Ô∏è Maximum 50 caract√®res';
      } else if (!/^[a-zA-Z√†√°√¢√§√£√•√®√©√™√´√¨√≠√Æ√Ø√≤√≥√¥√∂√µ√π√∫√ª√º√Ω√ø√±√ß√Ä√Å√Ç√Ñ√É√Ö√à√â√ä√ã√å√ç√é√è√í√ì√î√ñ√ï√ô√ö√õ√ú√ù≈∏√ë√á\s-]+$/.test(value)) {
        isValid = false;
        errorMsg = '‚ö†Ô∏è Seules les lettres sont autoris√©es';
      } else {
        successMsg = '‚úì Format valide';
      }
      break;
    
    case 'email':
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!value) {
        isValid = false;
        errorMsg = '‚ö†Ô∏è Email requis';
      } else if (!emailRegex.test(value)) {
        isValid = false;
        errorMsg = '‚ö†Ô∏è Format email invalide (ex: nom@exemple.com)';
      } else {
        // V√©rifier la disponibilit√© avec debounce
        clearTimeout(validationTimers[fieldName]);
        validationTimers[fieldName] = setTimeout(async () => {
          showLoading(`pro-${fieldName}-success`, 'V√©rification disponibilit√©...');
          
          try {
            const response = await fetch(`${window.API_BASE_URL}/user/exists?email=${encodeURIComponent(value)}`);
            
            // G√©rer les erreurs 502/503 du backend
            if (!response.ok) {
              if (response.status === 502 || response.status === 503) {
                console.warn('Backend temporairement indisponible pour v√©rification email');
                showSuccess(`pro-${fieldName}-success`, '‚úì Format valide (v√©rification indisponible)');
                return; // Ne pas bloquer l'utilisateur
              }
              throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.exists) {
              showError(`pro-${fieldName}-error`, '‚ö†Ô∏è Cet email est d√©j√† utilis√©');
              showSuccess(`pro-${fieldName}-success`, '');
              inputEl.classList.add('field-error');
            } else {
              showError(`pro-${fieldName}-error`, '');
              showSuccess(`pro-${fieldName}-success`, '‚úì Email disponible');
              inputEl.classList.add('field-success');
            }
          } catch (error) {
            console.error('Erreur v√©rification email:', error);
            // En cas d'erreur, ne pas bloquer - juste afficher format valide
            showSuccess(`pro-${fieldName}-success`, '‚úì Format valide');
          }
        }, 500);
        
        successMsg = '‚úì Format valide';
      }
      break;
    
    case 'username':
      if (!value) {
        isValid = false;
        errorMsg = '‚ö†Ô∏è Nom d\'utilisateur requis';
      } else if (value.length < 3) {
        isValid = false;
        errorMsg = '‚ö†Ô∏è Minimum 3 caract√®res';
      } else if (value.length > 20) {
        isValid = false;
        errorMsg = '‚ö†Ô∏è Maximum 20 caract√®res';
      } else if (!/^[a-zA-Z0-9_-]+$/.test(value)) {
        isValid = false;
        errorMsg = '‚ö†Ô∏è Caract√®res autoris√©s: lettres, chiffres, _ et -';
      } else {
        // V√©rifier la disponibilit√© avec debounce
        clearTimeout(validationTimers[fieldName]);
        validationTimers[fieldName] = setTimeout(async () => {
          showLoading(`pro-${fieldName}-success`, 'V√©rification disponibilit√©...');
          
          try {
            const response = await fetch(`${window.API_BASE_URL}/user/exists?username=${encodeURIComponent(value)}`);
            
            // G√©rer les erreurs 502/503 du backend
            if (!response.ok) {
              if (response.status === 502 || response.status === 503) {
                console.warn('Backend temporairement indisponible pour v√©rification username');
                showSuccess(`pro-${fieldName}-success`, '‚úì Format valide (v√©rification indisponible)');
                return; // Ne pas bloquer l'utilisateur
              }
              throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.exists) {
              showError(`pro-${fieldName}-error`, '‚ö†Ô∏è Ce nom d\'utilisateur est d√©j√† pris');
              showSuccess(`pro-${fieldName}-success`, '');
              inputEl.classList.add('field-error');
            } else {
              showError(`pro-${fieldName}-error`, '');
              showSuccess(`pro-${fieldName}-success`, '‚úì Disponible');
              inputEl.classList.add('field-success');
            }
          } catch (error) {
            console.error('Erreur v√©rification username:', error);
            // En cas d'erreur, ne pas bloquer - juste afficher format valide
            showSuccess(`pro-${fieldName}-success`, '‚úì Format valide');
          }
        }, 500);
        
        successMsg = '‚úì Format valide';
      }
      break;
    
    case 'postalAddress':
      const skipAddress = document.getElementById('pro-skip-address')?.checked;
      if (!skipAddress && (!value || value.trim().length < 5)) {
        isValid = false;
        errorMsg = '‚ö†Ô∏è Adresse compl√®te requise (minimum 5 caract√®res)';
      } else if (!skipAddress && value && value.trim().length < 5) {
        isValid = false;
        errorMsg = '‚ö†Ô∏è Adresse trop courte (minimum 5 caract√®res)';
      } else if (!skipAddress && value) {
        successMsg = '‚úì Adresse valide';
      }
      break;
  }

  if (errorMsg) {
    showError(`pro-${fieldName}-error`, errorMsg);
  } else if (successMsg && !validationTimers[fieldName]) {
    showSuccess(`pro-${fieldName}-success`, successMsg);
  }
  
  return isValid;
}

// Fonction pour v√©rifier si un mot de passe a √©t√© compromis via Have I Been Pwned
// NOTE: L'API HIBP ne supporte pas CORS depuis le navigateur, donc on d√©sactive temporairement
// La v√©rification devrait √™tre faite c√¥t√© backend pour √™tre efficace
// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è D√âFINIE DIRECTEMENT SUR window POUR √âVITER LES PROBL√àMES DE SCOPE
window.checkPasswordPwned = async function checkPasswordPwned(password) {
  // D√âSACTIV√â : CORS bloque les requ√™tes depuis le navigateur
  // TODO: Impl√©menter la v√©rification c√¥t√© backend
  console.log('[HIBP] V√©rification d√©sactiv√©e c√¥t√© frontend (CORS) - √† impl√©menter c√¥t√© backend');
  return { pwned: false, count: 0 };
  
  /* CODE D√âSACTIV√â - CORS bloque les requ√™tes
  try {
    // Cr√©er un hash SHA-1 du mot de passe
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-1', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
    
    // Utiliser k-anonymity : envoyer seulement les 5 premiers caract√®res
    const hashPrefix = hashHex.substring(0, 5);
    const hashSuffix = hashHex.substring(5);
    
    // Appeler l'API Have I Been Pwned via un proxy backend (√† impl√©menter)
    // Pour l'instant, d√©sactiv√© car CORS bloque les requ√™tes directes
    const response = await fetch(`${window.API_BASE_URL}/check-password-pwned`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ hashPrefix: hashPrefix, hashSuffix: hashSuffix })
    });
    
    if (!response.ok) {
      console.warn('Have I Been Pwned API non disponible');
      return { pwned: false, count: 0 };
    }
    
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('Erreur v√©rification Have I Been Pwned:', error);
    return { pwned: false, count: 0 };
  }
  */
};

// Validation du mot de passe avec feedback visuel am√©lior√© et v√©rification Have I Been Pwned
async function validateProPassword(password) {
  const errorEl = document.getElementById('pro-password-error');
  const strengthEl = document.getElementById('pro-password-strength-fill');
  const inputEl = document.getElementById('pro-password');
  
  if (!password) {
    if (strengthEl) {
      strengthEl.className = 'pro-register-password-strength-fill';
      strengthEl.style.width = '0%';
      strengthEl.style.transition = 'all 0.3s ease';
    }
    if (inputEl) {
      inputEl.classList.remove('field-error', 'field-success');
      inputEl.style.borderColor = '';
      inputEl.style.boxShadow = '';
    }
    showError('pro-password-error', '');
    
    // R√©initialiser le label de force
    const strengthLabelEl = document.getElementById('pro-password-strength-label');
    if (strengthLabelEl) {
      strengthLabelEl.textContent = '';
    }
    
    return false;
  }

  let strength = 0;
  let errorMsg = '';
  let strengthPercent = 0;
  let strengthLabel = '';
  let strengthColor = '';

  // V√©rifier les crit√®res avec poids
  const hasLength = password.length >= 12; // Minimum 12 caract√®res pour s√©curit√© renforc√©e
  const hasLength8 = password.length >= 8;
  const hasUpper = /[A-Z]/.test(password);
  const hasLower = /[a-z]/.test(password);
  const hasNumber = /[0-9]/.test(password);
  const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
  const hasLongLength = password.length >= 16;

  // Calcul de la force avec poids
  if (hasLength8) strength += 1;
  if (hasLength) strength += 1;
  if (hasLongLength) strength += 1;
  if (hasUpper) strength += 1;
  if (hasLower) strength += 1;
  if (hasNumber) strength += 1;
  if (hasSpecial) strength += 1;

  // Calcul du pourcentage et du label
  if (strength <= 2) {
    strengthPercent = (strength / 7) * 33;
    strengthLabel = 'Faible';
    strengthColor = '#ef4444';
  } else if (strength <= 4) {
    strengthPercent = 33 + ((strength - 2) / 5) * 33;
    strengthLabel = 'Moyen';
    strengthColor = '#f59e0b';
  } else {
    strengthPercent = 66 + ((strength - 4) / 3) * 34;
    strengthLabel = 'Fort';
    strengthColor = '#22c55e';
  }

  // Mettre √† jour la barre de force avec animation
  if (strengthEl) {
    strengthEl.className = `pro-register-password-strength-fill ${strength <= 2 ? 'weak' : strength <= 4 ? 'medium' : 'strong'}`;
    strengthEl.style.width = `${strengthPercent}%`;
    strengthEl.style.backgroundColor = strengthColor;
    strengthEl.style.transition = 'all 0.3s ease';
    
    // Ajouter un label de force si n√©cessaire
    const strengthLabelEl = document.getElementById('pro-password-strength-label');
    if (!strengthLabelEl && password.length > 0) {
      const label = document.createElement('div');
      label.id = 'pro-password-strength-label';
      label.style.cssText = 'font-size:12px;color:var(--ui-text-muted);margin-top:4px;';
      strengthEl.parentElement.appendChild(label);
    }
    if (strengthLabelEl) {
      strengthLabelEl.textContent = password.length > 0 ? `Force: ${strengthLabel}` : '';
      strengthLabelEl.style.color = strengthColor;
    }
  }

  // Messages d'erreur contextuels
  const missingCriteria = [];
  if (!hasLength8) {
    missingCriteria.push('8 caract√®res minimum');
  } else if (!hasLength) {
    missingCriteria.push('12 caract√®res recommand√©s');
  }
  if (!hasUpper) missingCriteria.push('une majuscule');
  if (!hasLower) missingCriteria.push('une minuscule');
  if (!hasNumber) missingCriteria.push('un chiffre');
  if (!hasSpecial) missingCriteria.push('un caract√®re sp√©cial');

  if (missingCriteria.length > 0 && password.length > 0) {
    errorMsg = `‚ö†Ô∏è Ajoutez: ${missingCriteria.slice(0, 3).join(', ')}${missingCriteria.length > 3 ? '...' : ''}`;
  } else if (strength >= 5 && password.length >= 12) {
    // Mot de passe fort - v√©rifier Have I Been Pwned
    // Debounce pour √©viter trop d'appels API
    clearTimeout(validationTimers['password-pwned']);
    validationTimers['password-pwned'] = setTimeout(async () => {
      // Utiliser window.checkPasswordPwned directement pour √©viter les probl√®mes de scope
      const checkFn = typeof window.checkPasswordPwned === 'function' ? window.checkPasswordPwned : null;
      if (!checkFn) {
        console.warn('[PASSWORD] checkPasswordPwned non disponible, skip v√©rification HIBP');
        return;
      }
      try {
        const pwnedCheck = await checkFn(password);
        
        if (pwnedCheck.pwned) {
          const countText = pwnedCheck.count > 0 ? ` (${pwnedCheck.count.toLocaleString()} fois)` : '';
          showError('pro-password-error', `üîí Ce mot de passe a √©t√© compromis dans une fuite de donn√©es${countText}. Veuillez en choisir un autre.`);
          if (inputEl) {
            inputEl.classList.add('field-error');
            inputEl.classList.remove('field-success');
            inputEl.style.borderColor = '#ef4444';
            inputEl.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
          }
        } else {
          // Mot de passe fort et non compromis
          if (inputEl) {
            inputEl.classList.add('field-success');
            inputEl.classList.remove('field-error');
            inputEl.style.borderColor = '#22c55e';
            inputEl.style.boxShadow = '0 0 0 3px rgba(34, 197, 94, 0.1)';
          }
          showError('pro-password-error', '');
        }
      } catch (error) {
        console.error('[PASSWORD] Erreur v√©rification HIBP:', error);
        // Ne pas bloquer l'utilisateur en cas d'erreur
      }
    }, 1000); // Attendre 1 seconde apr√®s la derni√®re saisie
    
    // Afficher temporairement un message de v√©rification
    if (password.length >= 12 && strength >= 5) {
      showError('pro-password-error', 'üîç V√©rification de s√©curit√©...');
    }
  }

  if (!errorMsg || password.length < 12 || strength < 5) {
    showError('pro-password-error', errorMsg);
  }
  
  // V√©rifier aussi la correspondance si la confirmation est remplie
  const confirmValue = document.getElementById('pro-password-confirm')?.value;
  if (confirmValue) {
    validateProPasswordMatch();
  }

  return strength >= 5 && password.length >= 12;
}

// Validation de la correspondance des mots de passe avec feedback visuel am√©lior√©
function validateProPasswordMatch() {
  const password = window.registerData.password;
  const confirm = document.getElementById('pro-password-confirm')?.value || window.window.registerData.passwordConfirm;
  const errorEl = document.getElementById('pro-password-confirm-error');
  const successEl = document.getElementById('pro-password-confirm-success');
  const inputEl = document.getElementById('pro-password-confirm');

  if (!confirm) {
    showError('pro-password-confirm-error', '');
    showSuccess('pro-password-confirm-success', '');
    if (inputEl) {
      inputEl.classList.remove('field-error', 'field-success');
      inputEl.style.borderColor = '';
      inputEl.style.boxShadow = '';
    }
    return false;
  }

  if (password !== confirm) {
    showError('pro-password-confirm-error', '‚ö†Ô∏è Les mots de passe ne correspondent pas');
    showSuccess('pro-password-confirm-success', '');
    if (inputEl) {
      inputEl.classList.add('field-error');
      inputEl.classList.remove('field-success');
      inputEl.style.borderColor = '#ef4444';
      inputEl.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
    }
    return false;
  } else {
    showError('pro-password-confirm-error', '');
    showSuccess('pro-password-confirm-success', '‚úì Les mots de passe correspondent');
    if (inputEl) {
      inputEl.classList.add('field-success');
      inputEl.classList.remove('field-error');
      inputEl.style.borderColor = '#22c55e';
      inputEl.style.boxShadow = '0 0 0 3px rgba(34, 197, 94, 0.1)';
    }
    return true;
  }
}

// Sauvegarde automatique du formulaire d'inscription dans localStorage
let autoSaveTimer = null;
function autoSaveRegistrationForm() {
  // Debounce : sauvegarder seulement apr√®s 500ms d'inactivit√©
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(() => {
    try {
      if (!window.registerData) {
        return;
      }
      
      // Collecter toutes les donn√©es du formulaire
      const formData = {
        email: document.getElementById('pro-email')?.value || window.registerData.email || '',
        username: document.getElementById('pro-username')?.value || window.registerData.username || '',
        password: document.getElementById('pro-password')?.value || window.registerData.password || '',
        passwordConfirm: document.getElementById('pro-password-confirm')?.value || window.registerData.passwordConfirm || '',
        firstName: document.getElementById('pro-firstname')?.value || window.registerData.firstName || '',
        lastName: document.getElementById('pro-lastname')?.value || window.registerData.lastName || '',
        postalAddress: document.getElementById('pro-postal-address')?.value || window.registerData.postalAddress || '',
        addressLat: document.getElementById('pro-address-lat')?.value || window.registerData.addressLat || '',
        addressLng: document.getElementById('pro-address-lng')?.value || window.registerData.addressLng || '',
        addressCountry: document.getElementById('pro-address-country')?.value || window.registerData.addressCountry || '',
        addressLabel: document.getElementById('pro-address-label')?.value || window.registerData.addressLabel || '',
        profilePhoto: window.registerData.profilePhoto || '',
        photoData: window.registerData.photoData || '',
        avatarId: window.registerData.avatarId || 1,
        avatarDescription: window.registerData.avatarDescription || '',
        timestamp: Date.now()
      };
      
      // Sauvegarder dans localStorage avec gestion de quota
      try {
        localStorage.setItem('registerFormDraft', JSON.stringify(formData));
        
        // Mettre √† jour window.registerData avec les nouvelles valeurs
        Object.assign(window.registerData, formData);
      } catch (quotaError) {
        // Si le localStorage est plein, nettoyer les donn√©es non essentielles
        if (quotaError.name === 'QuotaExceededError' || quotaError.message.includes('quota')) {
          console.warn('[AUTO-SAVE] localStorage plein - nettoyage automatique...');
          try {
            // Supprimer les donn√©es volumineuses non essentielles
            localStorage.removeItem('eventsData');
            localStorage.removeItem('bookingsData');
            localStorage.removeItem('servicesData');
            // R√©essayer
            localStorage.setItem('registerFormDraft', JSON.stringify(formData));
            Object.assign(window.registerData, formData);
            console.log('[AUTO-SAVE] ‚úÖ Sauvegarde r√©ussie apr√®s nettoyage');
          } catch (e2) {
            // Si toujours plein, continuer sans sauvegarder (les donn√©es sont dans window.registerData)
            console.warn('[AUTO-SAVE] ‚ö†Ô∏è localStorage toujours plein - continuation sans sauvegarde');
            Object.assign(window.registerData, formData); // Mettre √† jour quand m√™me en m√©moire
          }
        } else {
          throw quotaError;
        }
      }
      
    } catch (error) {
      console.warn('[AUTO-SAVE] Erreur sauvegarde:', error);
    }
  }, 500);
}

// Restaurer le formulaire depuis localStorage
function restoreRegistrationForm() {
  try {
    const saved = localStorage.getItem('registerFormDraft');
    if (!saved) {
      return false;
    }
    
    const formData = JSON.parse(saved);
    
    // V√©rifier si le draft n'est pas trop ancien (max 7 jours)
    const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 jours en millisecondes
    if (formData.timestamp && (Date.now() - formData.timestamp) > maxAge) {
      localStorage.removeItem('registerFormDraft');
      return false;
    }
    
    // Restaurer les valeurs dans les champs
    if (formData.email && document.getElementById('pro-email')) {
      document.getElementById('pro-email').value = formData.email;
      window.registerData.email = formData.email;
    }
    if (formData.username && document.getElementById('pro-username')) {
      document.getElementById('pro-username').value = formData.username;
      window.registerData.username = formData.username;
    }
    if (formData.firstName && document.getElementById('pro-firstname')) {
      document.getElementById('pro-firstname').value = formData.firstName;
      window.registerData.firstName = formData.firstName;
    }
    if (formData.lastName && document.getElementById('pro-lastname')) {
      document.getElementById('pro-lastname').value = formData.lastName;
      window.registerData.lastName = formData.lastName;
    }
    if (formData.postalAddress && document.getElementById('pro-postal-address')) {
      document.getElementById('pro-postal-address').value = formData.postalAddress;
      window.registerData.postalAddress = formData.postalAddress;
    }
    
    // Restaurer les donn√©es cach√©es
    if (formData.addressLat && document.getElementById('pro-address-lat')) {
      document.getElementById('pro-address-lat').value = formData.addressLat;
      window.registerData.addressLat = formData.addressLat;
    }
    if (formData.addressLng && document.getElementById('pro-address-lng')) {
      document.getElementById('pro-address-lng').value = formData.addressLng;
      window.registerData.addressLng = formData.addressLng;
    }
    if (formData.addressCountry && document.getElementById('pro-address-country')) {
      document.getElementById('pro-address-country').value = formData.addressCountry;
      window.registerData.addressCountry = formData.addressCountry;
    }
    if (formData.addressLabel && document.getElementById('pro-address-label')) {
      document.getElementById('pro-address-label').value = formData.addressLabel;
      window.registerData.addressLabel = formData.addressLabel;
    }
    
    // Restaurer la photo si elle existe
    console.log('[RESTORE] üîç Restauration photo depuis localStorage:');
    console.log('[RESTORE] formData.photoData:', formData.photoData ? `PR√âSENT (${formData.photoData.length} chars)` : 'NULL');
    console.log('[RESTORE] formData.profilePhoto:', formData.profilePhoto ? `PR√âSENT (${formData.profilePhoto.length} chars)` : 'NULL');
    
    if (window.registerData) {
      // Restaurer profilePhoto si pr√©sent
      if (formData.profilePhoto && formData.profilePhoto.length > 0) {
        window.registerData.profilePhoto = formData.profilePhoto;
        console.log('[RESTORE] ‚úÖ profilePhoto restaur√© depuis localStorage');
      }
      
      // Restaurer photoData si pr√©sent, sinon utiliser profilePhoto
      if (formData.photoData && formData.photoData.length > 0) {
        window.registerData.photoData = formData.photoData;
        console.log('[RESTORE] ‚úÖ photoData restaur√© depuis localStorage');
      } else if (formData.profilePhoto && formData.profilePhoto.length > 0) {
        window.registerData.photoData = formData.profilePhoto;
        console.log('[RESTORE] ‚úÖ photoData copi√© depuis profilePhoto (photoData manquant dans localStorage)');
      }
      
      const photoPreview = document.getElementById('pro-photo-preview');
      const photoPlaceholder = document.getElementById('pro-photo-placeholder');
      if (photoPreview && window.registerData.profilePhoto && window.registerData.profilePhoto.length > 0) {
        photoPreview.src = window.registerData.profilePhoto;
        photoPreview.style.display = 'block';
        photoPreview.classList.add('show');
        if (photoPlaceholder) {
          photoPlaceholder.style.display = 'none';
        }
        console.log('[RESTORE] ‚úÖ Preview mise √† jour avec photo restaur√©e');
      }
      
      console.log('[RESTORE] registerData.photoData APR√àS restauration:', window.registerData.photoData ? `PR√âSENT (${window.registerData.photoData.length} chars)` : 'NULL');
      console.log('[RESTORE] registerData.profilePhoto APR√àS restauration:', window.registerData.profilePhoto ? `PR√âSENT (${window.registerData.profilePhoto.length} chars)` : 'NULL');
    }
    
    // Mettre √† jour window.registerData avec toutes les donn√©es restaur√©es
    Object.assign(window.registerData, formData);
    
    // CORRECTION: S'assurer que photoData existe m√™me apr√®s Object.assign
    if (window.registerData && window.registerData.profilePhoto && window.registerData.profilePhoto.length > 0) {
      if (!window.registerData.photoData || window.registerData.photoData.length === 0) {
        window.registerData.photoData = window.registerData.profilePhoto;
        console.log('[RESTORE] ‚úÖ‚úÖ‚úÖ photoData FORC√â depuis profilePhoto apr√®s Object.assign');
      }
    }
    
    return true;
  } catch (error) {
    console.warn('[RESTORE] Erreur restauration:', error);
    return false;
  }
}

// Exposer les fonctions globalement
window.autoSaveRegistrationForm = autoSaveRegistrationForm;
window.restoreRegistrationForm = restoreRegistrationForm;

// Toggle visibilit√© mot de passe
function toggleProPasswordVisibility(inputId, event) {
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Emp√™cher la propagation pour √©viter la fermeture du formulaire
  if (event) {
    event.preventDefault();
    event.stopPropagation();
    event.stopImmediatePropagation();
  }
  
  const input = document.getElementById(inputId);
  if (!input) {
    console.warn('[PASSWORD TOGGLE] Input non trouv√©:', inputId);
    return false;
  }
  
  if (input.type === 'password') {
    input.type = 'text';
  } else {
    input.type = 'password';
  }
  
  return false; // Emp√™cher tout comportement par d√©faut
}

// Toggle password visibility pour les champs register (auth modal)
function toggleRegisterPasswordVisibility(inputId) {
  console.log('[PASSWORD TOGGLE] toggleRegisterPasswordVisibility appel√©:', inputId);
  const input = document.getElementById(inputId);
  if (!input) {
    console.warn('[PASSWORD TOGGLE] Input non trouv√©:', inputId);
    return;
  }
  
  if (input.type === 'password') {
    input.type = 'text';
    console.log('[PASSWORD TOGGLE] Type chang√© en text');
  } else {
    input.type = 'password';
    console.log('[PASSWORD TOGGLE] Type chang√© en password');
  }
}

// Validation du mot de passe en temps r√©el
function validateRegisterPassword(password) {
  const rulesDiv = document.getElementById('register-password-rules');
  if (!rulesDiv) return;
  
  const rules = [];
  let isValid = true;
  
  // R√®gles de validation
  if (password.length < 8) {
    rules.push('‚ùå Au moins 8 caract√®res');
    isValid = false;
  } else {
    rules.push('‚úÖ Au moins 8 caract√®res');
  }
  
  if (!/[A-Z]/.test(password)) {
    rules.push('‚ùå Au moins une majuscule');
    isValid = false;
  } else {
    rules.push('‚úÖ Au moins une majuscule');
  }
  
  if (!/[a-z]/.test(password)) {
    rules.push('‚ùå Au moins une minuscule');
    isValid = false;
  } else {
    rules.push('‚úÖ Au moins une minuscule');
  }
  
  if (!/[0-9]/.test(password)) {
    rules.push('‚ùå Au moins un chiffre');
    isValid = false;
  } else {
    rules.push('‚úÖ Au moins un chiffre');
  }
  
  if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
    rules.push('‚ùå Au moins un caract√®re sp√©cial');
    isValid = false;
  } else {
    rules.push('‚úÖ Au moins un caract√®re sp√©cial');
  }
  
  rulesDiv.innerHTML = rules.map(rule => `<div style="margin:2px 0;">${rule}</div>`).join('');
  
  // Mettre √† jour la couleur de bordure
  const passwordInput = document.getElementById('register-password');
  if (passwordInput) {
    if (isValid && password.length > 0) {
      passwordInput.style.borderColor = '#22c55e';
    } else if (password.length > 0) {
      passwordInput.style.borderColor = '#ef4444';
    } else {
      passwordInput.style.borderColor = 'rgba(255,255,255,0.1)';
    }
  }
  
  // V√©rifier aussi la correspondance si le champ de confirmation existe
  const confirmInput = document.getElementById('register-password-confirm');
  if (confirmInput && confirmInput.value) {
    validateRegisterPasswordMatch();
  }
}

// Validation de la correspondance des mots de passe
function validateRegisterPasswordMatch() {
  const password = document.getElementById('register-password')?.value || '';
  const confirm = document.getElementById('register-password-confirm')?.value || '';
  const matchDiv = document.getElementById('register-password-match');
  const confirmInput = document.getElementById('register-password-confirm');
  
  if (!matchDiv || !confirmInput) return;
  
  if (confirm.length === 0) {
    matchDiv.style.display = 'none';
    confirmInput.style.borderColor = 'rgba(255,255,255,0.1)';
    return;
  }
  
  if (password === confirm && password.length > 0) {
    matchDiv.style.display = 'block';
    matchDiv.textContent = '‚úì Les mots de passe correspondent';
    matchDiv.style.color = '#22c55e';
    confirmInput.style.borderColor = '#22c55e';
  } else {
    matchDiv.style.display = 'block';
    matchDiv.textContent = '‚ùå Les mots de passe ne correspondent pas';
    matchDiv.style.color = '#ef4444';
    confirmInput.style.borderColor = '#ef4444';
  }
}

// Exposer les fonctions globalement pour les onclick
window.toggleRegisterPasswordVisibility = toggleRegisterPasswordVisibility;
window.toggleProPasswordVisibility = toggleProPasswordVisibility;
window.validateRegisterPassword = validateRegisterPassword;
window.validateRegisterPasswordMatch = validateRegisterPasswordMatch;

// Helper pour afficher les erreurs
// Debounce timers pour √©viter trop d'appels API
const validationTimers = {};

function showError(elementId, message) {
  const el = document.getElementById(elementId);
  if (!el) return;
  
  if (message) {
    el.textContent = message;
    el.style.display = 'block';
    el.style.opacity = '0';
    el.style.transform = 'translateY(-5px)';
    
    // Animation d'apparition
    requestAnimationFrame(() => {
      el.style.transition = 'all 0.3s ease';
      el.style.opacity = '1';
      el.style.transform = 'translateY(0)';
    });
    
    // Ajouter classe d'erreur au champ parent
    const input = document.getElementById(elementId.replace('-error', ''));
    if (input) {
      input.classList.add('field-error');
      input.style.borderColor = '#ef4444';
      input.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
    }
  } else {
    el.textContent = '';
    el.style.display = 'none';
    
    // Retirer classe d'erreur du champ parent
    const input = document.getElementById(elementId.replace('-error', ''));
    if (input) {
      input.classList.remove('field-error');
      input.style.borderColor = '';
      input.style.boxShadow = '';
    }
  }
}

function showSuccess(elementId, message) {
  const el = document.getElementById(elementId);
  if (!el) return;
  
  if (message) {
    el.textContent = message;
    el.style.display = 'block';
    el.style.opacity = '0';
    el.style.transform = 'translateY(-5px)';
    
    // Animation d'apparition
    requestAnimationFrame(() => {
      el.style.transition = 'all 0.3s ease';
      el.style.opacity = '1';
      el.style.transform = 'translateY(0)';
    });
    
    // Ajouter classe de succ√®s au champ parent
    const input = document.getElementById(elementId.replace('-success', ''));
    if (input) {
      input.classList.add('field-success');
      input.style.borderColor = '#22c55e';
      input.style.boxShadow = '0 0 0 3px rgba(34, 197, 94, 0.1)';
    }
  } else {
    el.textContent = '';
    el.style.display = 'none';
    
    // Retirer classe de succ√®s du champ parent
    const input = document.getElementById(elementId.replace('-success', ''));
    if (input) {
      input.classList.remove('field-success');
      input.style.borderColor = '';
      input.style.boxShadow = '';
    }
  }
}

function showLoading(elementId, message = 'V√©rification...') {
  const el = document.getElementById(elementId);
  if (!el) return;
  
  el.innerHTML = `<span style="display:inline-flex;align-items:center;gap:6px;"><span style="display:inline-block;width:12px;height:12px;border:2px solid rgba(59,130,246,0.3);border-top-color:#3b82f6;border-radius:50%;animation:spin 0.6s linear infinite;"></span>${message}</span>`;
  el.style.display = 'block';
  el.style.opacity = '1';
}

// Fonction pour mettre √† jour l'√©tat requis de l'adresse postale
function updatePostalAddressRequired() {
  const skipAddress = document.getElementById('pro-skip-address')?.checked || false;
  const addressInput = document.getElementById('pro-postal-address');
  if (addressInput) {
    if (skipAddress) {
      addressInput.removeAttribute('required');
      addressInput.disabled = true;
      addressInput.style.opacity = '0.5';
      addressInput.style.cursor = 'not-allowed';
      window.registerData.postalAddress = '';
      showError('pro-postal-address-error', '');
    } else {
      addressInput.setAttribute('required', 'required');
      addressInput.disabled = false;
      addressInput.style.opacity = '1';
      addressInput.style.cursor = 'text';
      if (addressInput.value) {
        if (typeof window.validateProField === 'function') {
          window.validateProField('postalAddress', addressInput.value);
        }
      }
    }
  }
}

// Soumission du formulaire
// Guard contre double-submit
// NOTE: isSubmittingProRegister est d√©clar√©e dans auth.js et expos√©e via window.isSubmittingProRegister

async function handleProRegisterSubmit(event) {
  event.preventDefault();
  
  // GUARD: √âviter double-submit et double clic
  if (window.isSubmittingProRegister) {
    console.warn('‚ö†Ô∏è Soumission d√©j√† en cours - double clic ignor√©');
    return;
  }
  
  // V√âRIFICATION CRITIQUE : Si le profil est d√©j√† complet, ne pas permettre la soumission
  if (currentUser && currentUser.profileComplete === true && currentUser.isLoggedIn === true) {
    console.warn('‚ö†Ô∏è Tentative de soumission formulaire alors que le profil est d√©j√† complet');
    showNotification('‚úÖ Votre compte est d√©j√† cr√©√© et complet. Vous √™tes connect√© !', 'success');
    closePublishModal();
    return;
  }
  
  // Marquer comme en cours de soumission
  window.isSubmittingProRegister = true;
  
  // S'assurer que registerData existe et est initialis√©
  if (!window.registerData) {
    window.registerData = {};
    console.log('[REGISTER] registerData initialis√©');
  }
  
  // R√©cup√©rer toutes les valeurs
  // ‚ö†Ô∏è firstName et lastName sont OPTIONNELS (comme les leaders mondiaux : Twitter, Instagram, TikTok)
  // Seul le username est requis pour l'identification
  window.registerData.firstName = ''; // Optionnel - pas de champ dans le formulaire
  window.registerData.lastName = ''; // Optionnel - pas de champ dans le formulaire
  window.registerData.email = document.getElementById('pro-email')?.value.trim() || '';
  window.registerData.username = document.getElementById('pro-username')?.value.trim() || '';
  window.registerData.password = document.getElementById('pro-password')?.value || '';
  window.window.registerData.passwordConfirm = document.getElementById('pro-password-confirm')?.value || '';
  const skipAddress = document.getElementById('pro-skip-address')?.checked || false;
  window.registerData.postalAddress = skipAddress ? '' : (document.getElementById('pro-postal-address')?.value.trim() || '');
  
  // S'assurer que registerData existe
  if (!window.registerData) {
    window.registerData = {};
  }
  
  // R√©cup√©rer les donn√©es d'adresse v√©rifi√©e (si disponible)
  const addressLat = document.getElementById('pro-address-lat')?.value;
  const addressLng = document.getElementById('pro-address-lng')?.value;
  const addressCountry = document.getElementById('pro-address-country')?.value;
  const addressLabel = document.getElementById('pro-address-label')?.value;
  
  // Pr√©parer le tableau addresses pour le backend
  let addresses = [];
  if (!skipAddress && window.registerData.postalAddress && addressLat && addressLng && addressCountry) {
    // Adresse v√©rifi√©e via Nominatim
    addresses = [{
      label: addressLabel || window.registerData.postalAddress,
      lat: parseFloat(addressLat),
      lng: parseFloat(addressLng),
      addressDetails: {
        country_code: addressCountry,
        city: '', // Peut √™tre enrichi plus tard
        postcode: '',
        street: ''
      }
    }];
  } else if (!skipAddress && window.registerData.postalAddress && window.registerData.postalAddress.trim().length > 0) {
    // Adresse saisie mais non v√©rifi√©e - accepter quand m√™me avec une adresse basique
    console.log('[REGISTER] Adresse tap√©e directement (sans coordonn√©es) - accept√©e');
    addresses = [{
      label: window.registerData.postalAddress,
      address: window.registerData.postalAddress,
      lat: null,
      lng: null,
      addressDetails: {
        country_code: addressCountry || '', // Pas de pays par d√©faut - mondial
        city: '',
        postcode: '',
        street: ''
      }
    }];
  }

  // Validation compl√®te
  let isValid = true;
  if (typeof window.validateProField === 'function') {
    isValid = window.validateProField('email', window.registerData.email) && isValid;
    isValid = window.validateProField('username', window.registerData.username) && isValid;
  }
  isValid = validateProPassword(window.registerData.password) && isValid;
  isValid = validateProPasswordMatch() && isValid;
  // L'adresse postale est optionnelle si "Pas pour l'instant" est coch√©
  // Si elle est saisie, accepter m√™me sans coordonn√©es (l'utilisateur peut l'avoir tap√©e directement)
  if (!skipAddress && window.registerData.postalAddress && window.registerData.postalAddress.trim().length > 0) {
    // Si l'adresse a des coordonn√©es, les utiliser
    if (addressLat && addressLng && addressCountry) {
      // Adresse v√©rifi√©e avec coordonn√©es - parfait
      console.log('[REGISTER] Adresse v√©rifi√©e avec coordonn√©es');
    } else {
      // Adresse tap√©e directement sans s√©lectionner depuis les suggestions
      // Accepter quand m√™me mais logger un avertissement
      console.log('[REGISTER] Adresse tap√©e directement (sans coordonn√©es) - accept√©e');
      // Cr√©er une adresse basique avec les donn√©es disponibles
      if (!addresses || addresses.length === 0) {
        addresses = [{
          address: window.registerData.postalAddress,
          city: window.registerData.postalAddress.split(',')[0] || '',
          lat: null,
          lng: null,
          country: window.registerData.addressCountry || '', // Pas de pays par d√©faut - mondial
          isPrimary: true
        }];
      }
    }
  }

  // V√©rifier la photo - V√âRIFIER photoData, profilePhoto ET l'image preview
  const photoPreview = document.getElementById('pro-photo-preview');
  const photoPlaceholder = document.getElementById('pro-photo-placeholder');
  const hasPhotoPreview = photoPreview && photoPreview.src && !photoPreview.src.includes('placeholder') && photoPreview.style.display !== 'none';
  
  // CORRECTION CRITIQUE ABSOLUE: Copier photoData depuis profilePhoto OU preview AVANT TOUTE V√âRIFICATION
  console.log('[REGISTER] üî•üî•üî•üî•üî• CORRECTION PHOTO - AVANT V√âRIFICATION');
  console.log('[REGISTER] registerData existe:', !!window.registerData);
  console.log('[REGISTER] registerData.profilePhoto:', window.registerData?.profilePhoto ? `PR√âSENT (${window.registerData.profilePhoto.length} chars)` : 'NULL');
  console.log('[REGISTER] registerData.photoData AVANT:', window.registerData?.photoData ? `PR√âSENT (${window.registerData.photoData?.length || 0} chars)` : 'NULL');
  console.log('[REGISTER] photoPreview existe:', !!photoPreview);
  console.log('[REGISTER] photoPreview.src:', photoPreview?.src ? `PR√âSENT (${photoPreview.src.length} chars, startsWith data:image: ${photoPreview.src.startsWith('data:image')})` : 'NULL');
  
  // FORCER la copie de photoData depuis profilePhoto OU preview
  if (window.registerData) {
    let photoCopied = false;
    
    // 1. Si profilePhoto existe, l'utiliser
    if (window.registerData.profilePhoto && 
        window.registerData.profilePhoto.length > 0 &&
        (!window.registerData.photoData || 
         window.registerData.photoData === 'null' || 
         window.registerData.photoData === '' ||
         window.registerData.photoData.length === 0)) {
      window.registerData.photoData = window.registerData.profilePhoto;
      console.log('[REGISTER] ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ photoData FORC√â depuis profilePhoto!');
      photoCopied = true;
    }
    
    // 2. Si photoData est toujours vide, utiliser la preview
    if ((!window.registerData.photoData || window.registerData.photoData.length === 0) &&
        photoPreview && photoPreview.src && photoPreview.src.startsWith('data:image') && photoPreview.src.length > 100) {
      window.registerData.photoData = photoPreview.src;
      // Copier aussi dans profilePhoto si vide
      if (!window.registerData.profilePhoto || window.registerData.profilePhoto.length === 0) {
        window.registerData.profilePhoto = photoPreview.src;
        console.log('[REGISTER] ‚úÖ‚úÖ‚úÖ profilePhoto ET photoData copi√©s depuis preview.src');
      } else {
        console.log('[REGISTER] ‚úÖ‚úÖ‚úÖ photoData copi√© depuis preview.src');
      }
      photoCopied = true;
    }
    
    if (!photoCopied) {
      console.log('[REGISTER] ‚ö†Ô∏è Aucune copie effectu√©e - photoData existe d√©j√† ou aucune source disponible');
    }
  }
  
  console.log('[REGISTER] registerData.photoData APR√àS:', window.registerData?.photoData ? `PR√âSENT (${window.registerData.photoData.length} chars)` : 'NULL');
  
  const hasPhotoData = window.registerData.photoData && 
                       window.registerData.photoData !== 'null' && 
                       window.registerData.photoData !== '' &&
                       window.registerData.photoData.length > 0;
  const hasProfilePhoto = window.registerData.profilePhoto && 
                         window.registerData.profilePhoto !== 'null' && 
                         window.registerData.profilePhoto !== '' &&
                         window.registerData.profilePhoto.length > 0;
  const hasPhoto = hasPhotoData || hasProfilePhoto || hasPhotoPreview;
  
  // CORRECTION ABSOLUE FINALE: Si photoData est toujours null mais que profilePhoto ou preview existe, FORCER la copie
  if (!hasPhotoData && (hasProfilePhoto || hasPhotoPreview)) {
    console.log('[REGISTER] ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è DERNI√àRE CHANCE: photoData est null mais profilePhoto/preview existe, FORCER copie!');
    if (window.registerData.profilePhoto && window.registerData.profilePhoto.length > 0) {
      window.registerData.photoData = window.registerData.profilePhoto;
      console.log('[REGISTER] ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ photoData FORC√â depuis profilePhoto (DERNI√àRE CHANCE)!');
      hasPhotoData = true;
    } else if (hasPhotoPreview && photoPreview && photoPreview.src && photoPreview.src.startsWith('data:image') && photoPreview.src.length > 100) {
      window.registerData.photoData = photoPreview.src;
      if (!window.registerData.profilePhoto || window.registerData.profilePhoto.length === 0) {
        window.registerData.profilePhoto = photoPreview.src;
      }
      console.log('[REGISTER] ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ photoData FORC√â depuis preview.src (DERNI√àRE CHANCE)!');
      hasPhotoData = true;
    }
  }
  
  console.log('[REGISTER] V√©rification photo FINALE - photoData:', hasPhotoData ? 'pr√©sent' : 'null', 'profilePhoto:', hasProfilePhoto ? 'pr√©sent' : 'null', 'preview:', hasPhotoPreview ? 'visible' : 'non visible');
  console.log('[REGISTER] hasPhoto (validation):', hasPhoto);
  console.log('[REGISTER] registerData.photoData FINAL:', window.registerData?.photoData ? `PR√âSENT (${window.registerData.photoData.length} chars)` : 'NULL');
  
  if (!hasPhoto) {
    showError('pro-photo-error', '‚ö†Ô∏è Veuillez ajouter une photo de profil');
    isValid = false;
  } else {
    showError('pro-photo-error', ''); // Effacer l'erreur si la photo est pr√©sente
  }
  
  // V√©rifier consentement RGPD
  const consentTerms = document.getElementById('pro-consent-terms')?.checked;
  const consentPrivacy = document.getElementById('pro-consent-privacy')?.checked;
  if (!consentTerms || !consentPrivacy) {
    console.log('[REGISTER] ‚ö†Ô∏è Consentement RGPD manquant - consentTerms:', consentTerms, 'consentPrivacy:', consentPrivacy);
    showNotification('‚ö†Ô∏è Vous devez accepter les conditions d\'utilisation et la politique de confidentialit√©', 'warning');
    isValid = false;
  } else {
    console.log('[REGISTER] ‚úÖ Consentement RGPD accept√©');
  }

  if (!isValid) {
    console.log('[REGISTER] ‚ö†Ô∏è Validation √©chou√©e - formulaire non soumis');
    window.isSubmittingProRegister = false; // R√©activer le bouton
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Cr√©er le compte';
    }
    showNotification('‚ö†Ô∏è Veuillez corriger les erreurs dans le formulaire', 'warning');
    return;
  }
  
  console.log('[REGISTER] ‚úÖ‚úÖ‚úÖ Validation r√©ussie - soumission du formulaire...');
  
  // Arr√™ter l'auto-save avant soumission
  if (typeof stopAutoSave === 'function') {
    stopAutoSave();
  }
  
  // Supprimer le draft apr√®s soumission r√©ussie
  localStorage.removeItem('registration_draft');

  // D√©sactiver le bouton
  const submitBtn = document.getElementById('pro-submit-btn');
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.textContent = 'Cr√©ation du compte...';
  }

  // NOUVEAU FLUX: Apr√®s validation du formulaire, afficher le choix de v√©rification AVANT de cr√©er le compte
  try {
    // Stocker les donn√©es du formulaire pour utilisation ult√©rieure
    const selectedAddress = addresses && addresses.length > 0 ? addresses[0] : null;
    
    // CORRECTION CRITIQUE ABSOLUE: S'assurer que photoData existe avant de cr√©er pendingRegisterData
    console.log('[REGISTER] üî•üî•üî• V√âRIFICATION AVANT pendingRegisterData:');
    console.log('[REGISTER] registerData existe:', !!window.registerData);
    console.log('[REGISTER] registerData.profilePhoto:', window.registerData?.profilePhoto ? `PR√âSENT (${window.registerData.profilePhoto.length} chars)` : 'NULL');
    console.log('[REGISTER] registerData.photoData AVANT:', window.registerData?.photoData ? `PR√âSENT (${window.registerData.photoData?.length || 0} chars)` : 'NULL');
    
    // V√©rifier aussi la preview au cas o√π
    const photoPreview = document.getElementById('pro-photo-preview');
    if (photoPreview && photoPreview.src && photoPreview.src.startsWith('data:image') && photoPreview.src.length > 100) {
      console.log('[REGISTER] Preview a une source base64, longueur:', photoPreview.src.length);
      // Si profilePhoto est vide mais la preview a une image, utiliser la preview
      if (!window.registerData.profilePhoto || window.registerData.profilePhoto.length === 0) {
        window.registerData.profilePhoto = photoPreview.src;
        console.log('[REGISTER] ‚úÖ profilePhoto copi√© depuis preview.src');
      }
    }
    
    // FORCER la copie de photoData depuis profilePhoto si n√©cessaire
    if (window.registerData) {
      // Si profilePhoto existe et photoData n'existe pas ou est vide
      if (window.registerData.profilePhoto && 
          window.registerData.profilePhoto.length > 0 &&
          (!window.registerData.photoData || 
           window.registerData.photoData === 'null' || 
           window.registerData.photoData === '' ||
           window.registerData.photoData.length === 0)) {
        window.registerData.photoData = window.registerData.profilePhoto;
        console.log('[REGISTER] ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ photoData FORC√â depuis profilePhoto avant pendingRegisterData');
      }
      
      // Si photoData est toujours vide mais que la preview a une image
      if ((!window.registerData.photoData || window.registerData.photoData.length === 0) &&
          photoPreview && photoPreview.src && photoPreview.src.startsWith('data:image') && photoPreview.src.length > 100) {
        window.registerData.photoData = photoPreview.src;
        console.log('[REGISTER] ‚úÖ‚úÖ‚úÖ photoData copi√© depuis preview.src');
      }
    }
    
    console.log('[REGISTER] registerData.photoData APR√àS:', window.registerData?.photoData ? `PR√âSENT (${window.registerData.photoData.length} chars)` : 'NULL');
    
    // R√©cup√©rer photoData depuis registerData (photo upload√©e) - utiliser profilePhoto comme fallback
    const photoData = window.registerData.photoData || window.registerData.profilePhoto || null;
    console.log('[REGISTER] photoData FINAL r√©cup√©r√© pour pendingRegisterData:', photoData ? `PR√âSENT (${photoData.length} chars)` : 'NULL');
    
    // D√©tecter si c'est un utilisateur Google OAuth (connexion OAuth)
    const isGoogleUser = currentUser && (
      currentUser.provider === 'google' || 
      currentUser.googleValidated === true ||
      (currentUser.sub && currentUser.email === window.registerData.email) ||
      (currentUser.email === window.registerData.email && window.registerData.email.includes('@gmail.com'))
    );
    
    // Si c'est un utilisateur Google OAuth, cr√©er directement le compte sans v√©rification suppl√©mentaire
    if (isGoogleUser) {
      console.log('[REGISTER] Utilisateur Google OAuth d√©tect√© - cr√©ation directe du compte');
      
      // Pr√©parer le payload pour Google OAuth complete
      const payload = {
        email: window.registerData.email,
        username: window.registerData.username,
        password: window.registerData.password || '',
        firstName: window.registerData.firstName || '',
        lastName: window.registerData.lastName || '',
        profilePhoto: photoData || '',
        addresses: addresses || [],
        userId: currentUser?.id || null,
        googleSub: currentUser?.sub || null,
        sub: currentUser?.sub || null
      };
      
      // Si une adresse a √©t√© s√©lectionn√©e, l'ajouter
      if (selectedAddress) {
        payload.postalAddress = selectedAddress.label || window.registerData.postalAddress || '';
      }
      
      console.log('[REGISTER] Cr√©ation compte Google OAuth avec payload:', {
        email: payload.email,
        username: payload.username,
        hasPhoto: !!payload.profilePhoto,
        hasAddresses: addresses.length > 0
      });
      
      try {
        const response = await fetch(`${window.API_BASE_URL}/user/oauth/google/complete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('[REGISTER] Compte cr√©√© avec succ√®s:', data);
          
          // Mettre √† jour currentUser avec les donn√©es du compte cr√©√©
          if (data.user) {
            const slimUser = {
              id: data.user.id || currentUser.id,
              email: data.user.email || window.registerData.email,
              username: data.user.username || window.registerData.username,
              firstName: data.user.firstName || data.user.first_name || window.registerData.firstName,
              lastName: data.user.lastName || data.user.last_name || window.registerData.lastName,
              role: data.user.role || 'user',
              subscription: data.user.subscription || 'free',
              profile_photo_url: data.user.profile_photo_url || null,
              hasPassword: data.user.hasPassword || false,
              hasPostalAddress: data.user.hasPostalAddress || false,
              profileComplete: data.user.profileComplete !== undefined ? data.user.profileComplete : true,
              isLoggedIn: true
            };
            
            currentUser = { ...currentUser, ...slimUser };
            
            // Sauvegarder dans localStorage
            try {
              const slimJson = JSON.stringify(slimUser);
              localStorage.setItem('currentUser', slimJson);
            } catch (e) {
              try { sessionStorage.setItem('currentUser', slimJson); } catch (e2) {}
            }
            
            // Mettre √† jour l'UI
            if (typeof updateAuthUI === 'function') {
              updateAuthUI(slimUser);
            }
            
            showNotification('‚úÖ Compte cr√©√© avec succ√®s ! Vous √™tes maintenant connect√©.', 'success');
            closePublishModal();
          }
        } else {
          const errorData = await response.json().catch(() => ({ error: 'Erreur lors de la cr√©ation du compte' }));
          console.error('[REGISTER] Erreur cr√©ation compte:', errorData);
          showNotification(`‚ùå Erreur: ${errorData.error || 'Erreur lors de la cr√©ation du compte'}`, 'error');
          
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Cr√©er le compte';
          }
        }
      } catch (error) {
        console.error('[REGISTER] Erreur lors de la cr√©ation du compte:', error);
        showNotification('‚ùå Erreur de connexion. Veuillez r√©essayer.', 'error');
        
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Cr√©er le compte';
        }
      }
      
      return; // Sortir ici pour les utilisateurs Google OAuth
    }
    
    // Pour les utilisateurs normaux (non Google OAuth), utiliser le flux de v√©rification
    window.pendingRegisterData = {
      email: window.registerData.email,
      username: window.registerData.username,
      password: window.registerData.password,
      firstName: window.registerData.firstName || '',
      lastName: window.registerData.lastName || '',
      photoData: photoData, // INCLURE photoData (photo upload√©e lors de la cr√©ation)
      photoLater: false,
      addressLater: !selectedAddress,
      selectedAddress: selectedAddress,
      addresses: addresses || [],
      avatarId: window.registerData.avatarId || 1
    };
    
    console.log('[REGISTER] pendingRegisterData cr√©√© avec photoData:', window.pendingRegisterData.photoData ? (window.pendingRegisterData.photoData.substring(0, 50) + '...') : 'null');
    console.log('[REGISTER] Formulaire valid√©, affichage choix de v√©rification');
    
    // R√©activer le bouton
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Cr√©er mon compte';
    }
    
    // Afficher le choix de m√©thode de v√©rification (Google, Facebook bient√¥t, Email)
    console.log('[REGISTER] V√©rification disponibilit√© showVerificationChoice...');
    console.log('[REGISTER] typeof showVerificationChoice:', typeof showVerificationChoice);
    console.log('[REGISTER] typeof window.showVerificationChoice:', typeof window.showVerificationChoice);
    
    if (typeof showVerificationChoice === 'function') {
      console.log('[REGISTER] Appel showVerificationChoice() direct');
      showVerificationChoice();
    } else if (typeof window.showVerificationChoice === 'function') {
      console.log('[REGISTER] Appel window.showVerificationChoice()');
      window.showVerificationChoice();
    } else {
      console.error('[REGISTER] showVerificationChoice non disponible, fallback vers v√©rification email');
      showEmailVerificationModal(window.registerData.email, window.registerData.username || 'Utilisateur');
    }
    
    return; // NE PAS cr√©er le compte maintenant, attendre le choix de v√©rification
  } catch (error) {
    console.error('‚ùå Erreur lors de la pr√©paration du formulaire:', error);
    showNotification('‚ùå Erreur lors de la pr√©paration du formulaire', 'error');
    
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Cr√©er le compte';
    }
  }
  
  // ============================================
  // ANCIEN CODE D√âSACTIV√â (ne sera plus ex√©cut√©)
  // Le compte sera cr√©√© apr√®s le choix de v√©rification (Google ou Email)
  // ============================================
  /*
  try {
    // D√©tecter si c'est un utilisateur Google (connexion OAuth)
    const isGoogleUser = currentUser && (
      currentUser.provider === 'google' || 
      currentUser.googleValidated === true ||
      (currentUser.sub && currentUser.email === window.registerData.email) ||
      (currentUser.email === window.registerData.email && window.registerData.email.includes('@gmail.com'))
    );
    
    // API_BASE_URL contient d√©j√† '/api', donc pas besoin de l'ajouter √† nouveau
    const endpoint = isGoogleUser ? `${window.API_BASE_URL}/user/oauth/google/complete` : `${window.API_BASE_URL}/user/register`;
    
    // Pr√©parer le payload selon le type d'utilisateur
    const basePayload = {
      email: window.registerData.email,
      username: window.registerData.username,
      password: window.registerData.password,
      firstName: window.registerData.firstName,
      lastName: window.registerData.lastName,
      profilePhoto: window.registerData.profilePhoto,
      addresses: addresses
    };
    
    const payload = isGoogleUser ? {
      ...basePayload,
      userId: currentUser?.id || null,
      googleSub: currentUser?.sub || null,
      sub: currentUser?.sub || null
    } : {
      ...basePayload,
      avatarId: window.registerData.avatarId || 1
    };
    
    console.log(`üì§ Envoi formulaire ${isGoogleUser ? 'Google OAuth' : 'inscription standard'} vers ${endpoint}`);
    
    // Envoyer au backend
    const response = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (response.ok) {
      const data = await response.json();
      console.log('[REGISTER] R√©ponse backend re√ßue:', { ok: data.ok, hasUser: !!data.user, userKeys: data.user ? Object.keys(data.user) : [] });
      
      // PRIORITY HOTFIX: Cr√©er slimUser uniquement avec les champs essentiels
      // Ne jamais stocker la r√©ponse compl√®te du backend
      let slimUser = null;
      if (data.user) {
        slimUser = {
          id: data.user.id || currentUser?.id,
          email: data.user.email || window.registerData.email,
          username: data.user.username || window.registerData.username,
          role: data.user.role || 'user',
          subscription: data.user.subscription || 'free',
          profile_photo_url: data.user.profile_photo_url || null,
          hasPassword: data.user.hasPassword || false,
          hasPostalAddress: data.user.hasPostalAddress || false,
          profileComplete: data.user.profileComplete !== undefined ? data.user.profileComplete : true
        };
      } else {
        // Fallback minimal si pas de data.user
        slimUser = {
          id: data.user?.id || Date.now(),
          email: window.registerData.email,
          username: window.registerData.username,
          role: 'user',
          subscription: 'free',
          profileComplete: true
        };
      }
      
      // PRIORITY HOTFIX: Mettre √† jour l'UI "logged-in" IMM√âDIATEMENT AVANT toute √©criture storage
      // Cela garantit que l'UI refl√®te l'√©tat connect√© m√™me si storage √©choue
      console.log('[REGISTER] Mise √† jour UI logged-in AVANT storage...');
      updateAuthUI(slimUser);
      
      // Afficher le message de bienvenue
      const welcomeName = slimUser.username || slimUser.email?.split('@')[0] || 'Utilisateur';
      
      // Afficher le modal de v√©rification d'email au lieu de fermer directement
      showEmailVerificationModal(window.registerData.email, welcomeName);
      
      // PRIORITY HOTFIX: Sauvegarder uniquement slimUser dans localStorage
      // Fallback vers sessionStorage si localStorage plein
      try {
        const slimJson = JSON.stringify(slimUser);
        try {
          localStorage.setItem('currentUser', slimJson);
          console.log('‚úÖ User slim sauvegard√© dans localStorage');
        } catch (localStorageError) {
          if (localStorageError.name === 'QuotaExceededError' || localStorageError.message.includes('quota')) {
            console.warn('‚ö†Ô∏è localStorage plein - tentative sessionStorage...');
            try {
              sessionStorage.setItem('currentUser', slimJson);
              console.log('‚úÖ User slim sauvegard√© dans sessionStorage (fallback)');
              showNotification('‚ö†Ô∏è Donn√©es sauvegard√©es temporairement (session)', 'info');
            } catch (sessionStorageError) {
              console.warn('‚ö†Ô∏è sessionStorage aussi plein - user gard√© en m√©moire (window.currentUser)');
              // User d√©j√† en window.currentUser, UI d√©j√† mise √† jour - continuer
            }
          } else {
            throw localStorageError;
          }
        }
      } catch (storageError) {
        console.warn('‚ö†Ô∏è Erreur storage (non bloquant):', storageError);
        // User d√©j√† en window.currentUser, UI d√©j√† mise √† jour - continuer
      }
      
      // Charger les donn√©es utilisateur (optionnel, peut √©chouer sans bloquer)
      try {
        await loadUserDataOnLogin();
      } catch (loadError) {
        console.warn('‚ö†Ô∏è Erreur loadUserDataOnLogin (non bloquant):', loadError);
        // Continuer - l'utilisateur est d√©j√† connect√© et l'UI mise √† jour
      }
      
      // R√©initialiser le flag de soumission
      window.isSubmittingProRegister = false;
    } else {
      // G√©rer les erreurs HTTP
      let errorMessage = 'Impossible de cr√©er le compte';
      let errorData = null;
      
      try {
        const errorText = await response.text();
        console.error(`‚ùå Erreur serveur ${response.status}:`, errorText);
        
        try {
          errorData = JSON.parse(errorText);
          errorMessage = errorData.error || errorMessage;
        } catch (e) {
          // Si ce n'est pas du JSON, utiliser le texte brut
          if (errorText && errorText.length < 200) {
            errorMessage = errorText;
          }
        }
      } catch (e) {
        console.error('Erreur lecture r√©ponse:', e);
      }
      
      // PRIORIT√â 3 FIX: G√©rer USERNAME_ALREADY_EXISTS avec message clair
      if (errorData && errorData.code === 'USERNAME_ALREADY_EXISTS') {
        errorMessage = 'Ce nom d\'utilisateur est d√©j√† pris. Choisissez-en un autre ou contactez le support si c\'est votre compte.';
        showNotification(`‚ö†Ô∏è ${errorMessage}`, 'warning');
        
        // Focus sur le champ username pour permettre la modification
        const usernameInput = document.getElementById('pro-username') || document.getElementById('register-username');
        if (usernameInput) {
          usernameInput.focus();
          usernameInput.select();
        }
        return; // Ne pas fermer le modal, permettre la correction
      }
      
      // Messages sp√©cifiques selon le code d'erreur
      if (response.status === 502) {
        errorMessage = 'Erreur serveur (502). Le serveur est temporairement indisponible. Veuillez r√©essayer dans quelques instants.';
      } else if (response.status === 500) {
        errorMessage = 'Erreur serveur (500). Veuillez r√©essayer.';
      } else if (response.status === 400) {
        errorMessage = errorMessage || 'Donn√©es invalides. V√©rifiez vos informations.';
      } else if (response.status === 404) {
        errorMessage = 'Utilisateur non trouv√©. Veuillez d\'abord vous connecter avec Google.';
      }
      
      console.error(`‚ùå √âchec cr√©ation compte: ${response.status} - ${errorMessage}`);
      showNotification(`‚ùå ${errorMessage}`, 'error');
      
      // R√©initialiser le flag de soumission
      window.isSubmittingProRegister = false;
      
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Cr√©er le compte';
      }
    }
  } catch (error) {
    console.error('‚ùå Erreur cr√©ation compte:', error);
    console.error('D√©tails erreur:', error.message, error.stack);
    
    // R√©initialiser le flag de soumission
    isSubmittingProRegister = false;
    
    let errorMessage = 'Erreur r√©seau. Veuillez r√©essayer.';
    if (error.message && error.message.includes('Failed to fetch')) {
      errorMessage = 'Erreur de connexion. V√©rifiez votre connexion internet.';
    } else if (error.message && error.message.includes('timeout')) {
      errorMessage = 'Timeout de connexion. Le serveur met trop de temps √† r√©pondre.';
    }
    
    showNotification(`‚ùå ${errorMessage}`, 'error');
    
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Cr√©er le compte';
    }
  }
  */
}

// Fonction pour afficher le modal de v√©rification d'email apr√®s inscription
// Fonction pour afficher un formulaire photo uniquement (quand photo manquante)
function showPhotoUploadForm(userData) {
  console.log('[PHOTO UPLOAD] Affichage formulaire photo uniquement pour:', userData?.email);
  
  const backdrop = document.getElementById('publish-modal-backdrop');
  const modal = document.getElementById('publish-modal-inner');
  
  if (!backdrop || !modal) {
    console.error('[PHOTO UPLOAD] Modal elements not found');
    return;
  }
  
  let selectedPhoto = null;
  let photoPreview = null;
  
  const html = `
    <div style="padding:40px;max-width:500px;margin:0 auto;text-align:center;position:relative;">
      <!-- Bouton X (croix) pour fermer -->
      <button onclick="closeAuthModal()" style="position:absolute;top:16px;right:16px;background:none;border:none;color:var(--ui-text-muted);font-size:24px;cursor:pointer;padding:8px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s;z-index:10;" onmouseover="this.style.background='rgba(239,68,68,0.2)';this.style.color='#ef4444';this.style.transform='scale(1.1)';" onmouseout="this.style.background='none';this.style.color='var(--ui-text-muted)';this.style.transform='scale(1)';" title="Fermer">‚úï</button>
      
      <div style="font-size:64px;margin-bottom:20px;">üì∑</div>
      <h2 style="margin:0 0 12px;font-size:24px;font-weight:700;color:#fff;">Photo de profil requise</h2>
      <p style="margin:0 0 32px;font-size:14px;color:var(--ui-text-muted);line-height:1.6;">
        Une photo de profil est obligatoire pour compl√©ter votre compte.<br>
        Vous pouvez ajouter une photo maintenant ou passer cette √©tape et la configurer plus tard depuis votre profil.
      </p>
      
      <!-- Zone d'aper√ßu photo -->
      <div id="photo-preview-container" style="width:150px;height:150px;margin:0 auto 24px;border-radius:50%;background:rgba(15,23,42,0.5);border:3px solid rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;transition:all 0.3s;" onclick="document.getElementById('photo-upload-oauth-input').click();" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(15,23,42,0.8)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.2)';this.style.background='rgba(15,23,42,0.5)';">
        <div style="font-size:48px;color:var(--ui-text-muted);">üì∑</div>
      </div>
      
      <input type="file" id="photo-upload-oauth-input" accept="image/*" style="display:none;" onchange="handleOAuthPhotoUpload(event)">
      
      <div id="photo-upload-feedback" style="min-height:24px;margin-bottom:24px;font-size:13px;color:var(--ui-text-muted);"></div>
      
      <div style="display:flex;flex-direction:column;gap:12px;">
        <button onclick="uploadOAuthPhoto()" id="upload-photo-btn" disabled style="width:100%;padding:14px;border-radius:12px;border:none;background:rgba(255,255,255,0.2);color:rgba(255,255,255,0.5);font-weight:700;font-size:15px;cursor:not-allowed;transition:all 0.3s;">
          Ajouter la photo
        </button>
        <button onclick="skipPhotoUpload()" style="width:100%;padding:12px;border-radius:12px;border:2px solid rgba(255,255,255,0.2);background:transparent;color:#fff;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.4)';this.style.background='rgba(255,255,255,0.05)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.2)';this.style.background='transparent';">
          Passer cette √©tape (pour plus tard)
        </button>
        <button onclick="closeAuthModal()" style="width:100%;padding:12px;border-radius:10px;border:2px solid rgba(255,255,255,0.1);background:transparent;color:var(--ui-text-muted);font-weight:600;font-size:14px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.3)';this.style.color='var(--ui-text-main)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='var(--ui-text-muted)';">
          Annuler
        </button>
      </div>
    </div>
  `;
  
  modal.innerHTML = html;
  backdrop.style.display = 'flex';
  
  // Stocker les donn√©es utilisateur pour l'upload
  window.oauthPhotoUploadData = userData;
}

// G√©rer l'upload de photo pour OAuth
window.handleOAuthPhotoUpload = function(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // V√©rifier que c'est une image
  if (!file.type.startsWith('image/')) {
    document.getElementById('photo-upload-feedback').innerHTML = '<span style="color:var(--ui-text-error);">‚ö†Ô∏è Veuillez s√©lectionner une image</span>';
    return;
  }
  
  // V√©rifier la taille (max 5MB)
  if (file.size > 5 * 1024 * 1024) {
    document.getElementById('photo-upload-feedback').innerHTML = '<span style="color:var(--ui-text-error);">‚ö†Ô∏è L\'image est trop volumineuse (max 5MB)</span>';
    return;
  }
  
  // Afficher l'aper√ßu
  const reader = new FileReader();
  reader.onload = function(e) {
    const previewContainer = document.getElementById('photo-preview-container');
    if (previewContainer) {
      previewContainer.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" alt="Photo preview">`;
    }
    
    // Activer le bouton d'upload
    const uploadBtn = document.getElementById('upload-photo-btn');
    if (uploadBtn) {
      uploadBtn.disabled = false;
      uploadBtn.style.background = 'linear-gradient(135deg,#00ffc3,#3b82f6)';
      uploadBtn.style.color = '#000';
      uploadBtn.style.cursor = 'pointer';
    }
    
    document.getElementById('photo-upload-feedback').innerHTML = '<span style="color:var(--ui-text-success);">‚úÖ Photo s√©lectionn√©e</span>';
  };
  reader.readAsDataURL(file);
  
  // Stocker le fichier
  window.oauthPhotoFile = file;
};

// Uploader la photo pour OAuth
window.uploadOAuthPhoto = async function() {
  const file = window.oauthPhotoFile;
  const userData = window.oauthPhotoUploadData;
  
  if (!file || !userData) {
    showNotification('‚ùå Erreur: Fichier ou donn√©es utilisateur manquants', 'error');
    return;
  }
  
  const uploadBtn = document.getElementById('upload-photo-btn');
  const feedback = document.getElementById('photo-upload-feedback');
  
  if (uploadBtn) {
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Upload en cours...';
  }
  
  if (feedback) {
    feedback.innerHTML = '<span style="color:var(--ui-text-info);">‚è≥ Upload en cours...</span>';
  }
  
  try {
    // Convertir l'image en base64
    const reader = new FileReader();
    reader.onload = async function(e) {
      const base64Photo = e.target.result;
      
      // Appeler l'endpoint de compl√©tion OAuth avec la photo
      const response = await fetch(`${window.API_BASE_URL}/user/oauth/google/complete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId: userData.id,
          email: userData.email,
          username: userData.username || userData.email?.split('@')[0]?.substring(0, 20),
          firstName: userData.firstName || userData.first_name || '',
          lastName: userData.lastName || userData.last_name || '',
          profilePhoto: base64Photo
        })
      });
      
      const result = await response.json();
      
      if (response.ok && result.ok) {
        // Mettre √† jour currentUser et UI
        if (result.user) {
          const slimUser = {
            id: result.user.id || userData.id,
            email: result.user.email || userData.email,
            username: result.user.username || userData.username,
            firstName: result.user.firstName || result.user.first_name || '',
            lastName: result.user.lastName || result.user.last_name || '',
            role: result.user.role || 'user',
            subscription: result.user.subscription || 'free',
            profile_photo_url: result.user.profile_photo_url || base64Photo,
            hasPassword: result.user.hasPassword || false,
            hasPostalAddress: result.user.hasPostalAddress || false,
            profileComplete: true,
            isLoggedIn: true
          };
          
          currentUser = { ...currentUser, ...slimUser, isLoggedIn: true };
          updateAuthUI(slimUser);
          
          try {
            const slimJson = JSON.stringify(slimUser);
            localStorage.setItem('currentUser', slimJson);
          } catch (e) {
            try { sessionStorage.setItem('currentUser', slimJson); } catch (e2) {}
          }
        }
        
        closeAuthModal();
        closePublishModal();
        
        // Si besoin confirmation email, afficher le modal
        if (result.needsEmailVerification) {
          showEmailVerificationModal(userData.email, userData.username || 'Utilisateur');
        } else {
          const displayName = userData.username || userData.firstName || userData.email?.split('@')[0] || 'Utilisateur';
          showNotification(`‚úÖ Bienvenue ${displayName} ! Vous √™tes connect√©.`, 'success');
        }
        
        // Nettoyer
        delete window.oauthPhotoFile;
        delete window.oauthPhotoUploadData;
      } else {
        throw new Error(result.error || 'Erreur lors de l\'upload de la photo');
      }
    };
    reader.readAsDataURL(file);
  } catch (error) {
    console.error('‚ùå Erreur upload photo OAuth:', error);
    if (feedback) {
      feedback.innerHTML = `<span style="color:var(--ui-text-error);">‚ùå ${error.message || 'Erreur lors de l\'upload'}</span>`;
    }
    if (uploadBtn) {
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Ajouter la photo';
    }
    showNotification(`‚ùå ${error.message || 'Erreur lors de l\'upload de la photo'}`, 'error');
  }
};

// Passer l'√©tape photo (rediriger vers le formulaire complet)
window.skipPhotoUpload = function() {
  const userData = window.oauthPhotoUploadData;
  if (!userData) {
    closeAuthModal();
    return;
  }
  
  // Fermer le modal photo et afficher le formulaire complet d'inscription
  closeAuthModal();
  
  // Afficher le formulaire d'inscription complet avec les donn√©es Google pr√©-remplies
  if (typeof showProRegisterForm === 'function') {
    showProRegisterForm();
  } else if (typeof window.showProRegisterForm === 'function') {
    window.showProRegisterForm();
  }
  
  // Pr√©-remplir avec les donn√©es Google
  window.registerData = {
    email: userData.email || '',
    username: userData.username || userData.email?.split('@')[0]?.substring(0, 20) || '',
    password: '',
    passwordConfirm: '',
    firstName: userData.firstName || userData.first_name || '',
    lastName: userData.lastName || userData.last_name || '',
    profilePhoto: '', // Photo √† ajouter dans le formulaire complet
    postalAddress: '',
    avatarId: 1,
    avatarDescription: '',
    addresses: [],
    emailVerificationCode: null,
    emailVerified: false,
    verificationAttempts: 0,
    lastVerificationAttempt: null,
    registrationAttempts: 0,
    lastRegistrationAttempt: null,
    captchaAnswer: null,
    codeSentAt: null,
    codeExpiresAt: null,
    resendCountdown: 0,
    lastResendAttempt: null
  };
  
  showNotification('‚ö†Ô∏è Une photo de profil est obligatoire. Veuillez compl√©ter votre profil.', 'warning');
  
  // Nettoyer
  delete window.oauthPhotoFile;
  delete window.oauthPhotoUploadData;
};

// Exposer globalement
window.showPhotoUploadForm = showPhotoUploadForm;

function showEmailVerificationModal(email, username) {
  console.log('[EMAIL VERIFICATION] Affichage modal de v√©rification pour:', email);
  
  const backdrop = document.getElementById('publish-modal-backdrop');
  const modal = document.getElementById('publish-modal-inner');
  
  if (!backdrop || !modal) {
    console.error('[EMAIL VERIFICATION] Modal elements not found');
    return;
  }
  
  // G√©n√©rer un code √† 6 chiffres
  const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
  
  // Stocker le code temporairement (sera v√©rifi√© par le backend)
  window.pendingEmailVerification = {
    email: email,
    code: verificationCode,
    expiresAt: Date.now() + (15 * 60 * 1000) // 15 minutes
  };
  
  // Envoyer le code par email via le backend
  fetch(`${window.API_BASE_URL}/user/send-verification-code`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, code: verificationCode, username })
  }).catch(err => {
    console.warn('[EMAIL VERIFICATION] Erreur envoi code (non bloquant):', err);
    // En mode d√©veloppement, afficher le code dans la console
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      console.log(`üîê CODE DE V√âRIFICATION (DEV ONLY): ${verificationCode}`);
    }
  });
  
  // Afficher le code dans la console en d√©veloppement
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    console.log(`üîê CODE DE V√âRIFICATION (DEV ONLY): ${verificationCode}`);
  }
  
  let codeInputs = '';
  for (let i = 0; i < 6; i++) {
    codeInputs += `
      <input 
        type="text" 
        id="email-code-digit-${i}" 
        maxlength="1" 
        class="email-code-input"
        style="width:45px;height:55px;text-align:center;font-size:24px;font-weight:700;border:2px solid rgba(255,255,255,0.2);background:rgba(15,23,42,0.5);color:#fff;border-radius:10px;transition:all 0.2s;"
        oninput="handleEmailCodeInput(${i}, event)"
        onkeydown="handleEmailCodeKeydown(${i}, event)"
        onfocus="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(15,23,42,0.8)';"
        onblur="this.style.borderColor='rgba(255,255,255,0.2)';this.style.background='rgba(15,23,42,0.5)';"
      >
    `;
  }
  
  const html = `
    <div style="padding:40px;max-width:500px;margin:0 auto;text-align:center;position:relative;">
      <!-- Bouton X (croix) pour fermer -->
      <button onclick="closeAuthModal()" style="position:absolute;top:16px;right:16px;background:none;border:none;color:var(--ui-text-muted);font-size:24px;cursor:pointer;padding:8px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s;z-index:10;" onmouseover="this.style.background='rgba(239,68,68,0.2)';this.style.color='#ef4444';this.style.transform='scale(1.1)';" onmouseout="this.style.background='none';this.style.color='var(--ui-text-muted)';this.style.transform='scale(1)';" title="Fermer">‚úï</button>
      
      <div style="font-size:64px;margin-bottom:20px;">üìß</div>
      <h2 style="margin:0 0 12px;font-size:24px;font-weight:700;color:#fff;">V√©rifiez votre email</h2>
      <p style="margin:0 0 32px;font-size:14px;color:var(--ui-text-muted);line-height:1.6;">
        Nous avons envoy√© un code de v√©rification √† 6 chiffres √†<br>
        <strong style="color:#00ffc3;">${email}</strong><br><br>
        Entrez le code ci-dessous pour confirmer votre adresse email.
      </p>
      
      <div style="display:flex;justify-content:center;gap:12px;margin-bottom:24px;">
        ${codeInputs}
      </div>
      
      <div id="email-code-feedback" style="min-height:24px;margin-bottom:24px;font-size:13px;"></div>
      
      <div style="display:flex;flex-direction:column;gap:12px;">
        <button onclick="verifyEmailCode()" style="width:100%;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-weight:700;font-size:15px;cursor:pointer;">
          V√©rifier
        </button>
        <button onclick="resendEmailVerificationCode()" style="width:100%;padding:12px;border-radius:12px;border:2px solid rgba(255,255,255,0.2);background:transparent;color:#fff;font-weight:600;font-size:14px;cursor:pointer;">
          Renvoyer le code
        </button>
        <button onclick="closeAuthModal()" style="width:100%;padding:12px;border-radius:10px;border:2px solid rgba(255,255,255,0.1);background:transparent;color:var(--ui-text-muted);font-weight:600;font-size:14px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.3)';this.style.color='var(--ui-text-main)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='var(--ui-text-muted)';">
          Annuler
        </button>
      </div>
    </div>
  `;
  
  modal.innerHTML = html;
  backdrop.style.display = 'flex';
  
  // Focus sur le premier champ
  setTimeout(() => {
    const firstInput = document.getElementById('email-code-digit-0');
    if (firstInput) firstInput.focus();
  }, 100);
}

// Gestion de la saisie du code de v√©rification
window.handleEmailCodeInput = function(index, event) {
  const input = event.target;
  const value = input.value.replace(/[^0-9]/g, '');
  input.value = value;
  
  if (value && index < 5) {
    const nextInput = document.getElementById(`email-code-digit-${index + 1}`);
    if (nextInput) nextInput.focus();
  }
  
  // V√©rifier si tous les champs sont remplis
  checkEmailCodeComplete();
};

window.handleEmailCodeKeydown = function(index, event) {
  if (event.key === 'Backspace' && !event.target.value && index > 0) {
    const prevInput = document.getElementById(`email-code-digit-${index - 1}`);
    if (prevInput) prevInput.focus();
  }
};

function checkEmailCodeComplete() {
  let code = '';
  for (let i = 0; i < 6; i++) {
    const input = document.getElementById(`email-code-digit-${i}`);
    if (input) code += input.value;
  }
  
  if (code.length === 6) {
    verifyEmailCode(code);
  }
}

// V√©rifier le code d'email
async function verifyEmailCode(providedCode) {
  if (!providedCode) {
    // R√©cup√©rer le code depuis les inputs
    let code = '';
    for (let i = 0; i < 6; i++) {
      const input = document.getElementById(`email-code-digit-${i}`);
      if (input) code += input.value;
    }
    providedCode = code;
  }
  
  if (providedCode.length !== 6) {
    showNotification('‚ö†Ô∏è Veuillez entrer un code √† 6 chiffres', 'warning');
    return;
  }
  
  const feedbackEl = document.getElementById('email-code-feedback');
  if (feedbackEl) {
    feedbackEl.textContent = 'V√©rification en cours...';
    feedbackEl.style.color = 'var(--ui-text-muted)';
  }
  
  try {
    // V√©rifier le code via le backend
    const response = await fetch(`${window.API_BASE_URL}/user/verify-email`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: window.pendingEmailVerification?.email,
        code: providedCode
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      
      // Marquer l'email comme v√©rifi√©
      if (currentUser) {
        currentUser.emailVerified = true;
        safeSetItem('currentUser', JSON.stringify(currentUser));
      }
      
      // Afficher le succ√®s
      if (feedbackEl) {
        feedbackEl.textContent = '‚úÖ Email v√©rifi√© avec succ√®s !';
        feedbackEl.style.color = '#22c55e';
      }
      
      // Mettre √† jour les inputs en vert
      for (let i = 0; i < 6; i++) {
        const input = document.getElementById(`email-code-digit-${i}`);
        if (input) {
          input.style.borderColor = '#22c55e';
          input.style.background = 'rgba(34,197,94,0.1)';
        }
      }
      
      showNotification('‚úÖ Email v√©rifi√© avec succ√®s !', 'success');
      
      // Fermer le modal et mettre √† jour le bloc compte
      setTimeout(() => {
        closeAuthModal();
        if (typeof updateAccountBlockLegitimately === 'function') {
          updateAccountBlockLegitimately();
        }
      }, 1000);
    } else {
      const errorData = await response.json().catch(() => ({}));
      if (feedbackEl) {
        feedbackEl.textContent = errorData.error || 'Code incorrect';
        feedbackEl.style.color = '#ef4444';
      }
      
      // Mettre √† jour les inputs en rouge
      for (let i = 0; i < 6; i++) {
        const input = document.getElementById(`email-code-digit-${i}`);
        if (input) {
          input.style.borderColor = '#ef4444';
          input.style.background = 'rgba(239,68,68,0.1)';
        }
      }
      
      showNotification('‚ùå Code incorrect. Veuillez r√©essayer.', 'error');
    }
  } catch (error) {
    console.error('[EMAIL VERIFICATION] Erreur:', error);
    if (feedbackEl) {
      feedbackEl.textContent = 'Erreur de connexion. Veuillez r√©essayer.';
      feedbackEl.style.color = '#ef4444';
    }
    showNotification('‚ùå Erreur de connexion. Veuillez r√©essayer.', 'error');
  }
}

// Renvoyer le code de v√©rification
async function resendEmailVerificationCode() {
  if (!window.pendingEmailVerification) {
    showNotification('‚ö†Ô∏è Aucune v√©rification en cours', 'warning');
    return;
  }
  
  const { email } = window.pendingEmailVerification;
  const newCode = Math.floor(100000 + Math.random() * 900000).toString();
  
  window.pendingEmailVerification.code = newCode;
  window.pendingEmailVerification.expiresAt = Date.now() + (15 * 60 * 1000);
  
  try {
    await fetch(`${window.API_BASE_URL}/user/send-verification-code`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, code: newCode })
    });
    
    showNotification('‚úÖ Code renvoy√© ! V√©rifiez votre bo√Æte email.', 'success');
    
    // En mode d√©veloppement, afficher le code
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      console.log(`üîê NOUVEAU CODE DE V√âRIFICATION (DEV ONLY): ${newCode}`);
    }
  } catch (error) {
    console.error('[EMAIL VERIFICATION] Erreur renvoi code:', error);
    showNotification('‚ö†Ô∏è Erreur lors du renvoi du code', 'error');
  }
}

// Exposer les fonctions globalement
window.showEmailVerificationModal = showEmailVerificationModal;
window.verifyEmailCode = verifyEmailCode;
window.resendEmailVerificationCode = resendEmailVerificationCode;

function showRegisterStep1() {
  console.log('üéØ showRegisterStep1 called - REDIRECTION VERS FORMULAIRE PRO');
  // Rediriger vers le formulaire professionnel
  showProRegisterForm();
  return;
}

// Authentification sociale
function socialLogin(provider) {
  showNotification(`üîê Connexion avec ${provider}...`, "info");
  // TODO: Impl√©menter l'authentification sociale r√©elle
  // Pour l'instant, simulation
  setTimeout(() => {
    showNotification(`‚úÖ Connexion ${provider} bient√¥t disponible ! Utilisez l'inscription par email pour l'instant.`, "info");
  }, 1000);
}

function showRegisterStep2() {
  console.log('üéØ showRegisterStep2 called - starting registration step 2');
  window.registerStep = 2;
  
  // G√©n√©rer la grille d'avatars
  const avatarGrid = AVAILABLE_AVATARS.map(av => `
    <div data-avatar-id="${av.id}"
         id="avatar-option-${av.id}"
         class="register-avatar-option ${window.registerData.avatarId === av.id ? 'selected' : ''}"
         title="${av.name}">
      ${av.emoji}
    </div>
  `).join('');
  
  const selectedAvatar = AVAILABLE_AVATARS.find(av => av.id === window.registerData.avatarId) || AVAILABLE_AVATARS[0];
  
  const html = `
    <div class="register-step2-container">
      <div class="register-step2-header">
        <div class="register-avatar-preview">${selectedAvatar.emoji}</div>
        <h2 class="register-step2-title">Cr√©ez votre profil</h2>
        <p class="register-step2-subtitle">√âtape 2/3 - Informations & Avatar</p>

        <div class="register-step-indicator">
          <div class="register-step-dot active"></div>
          <div class="register-step-dot"></div>
          <div class="register-step-dot"></div>
        </div>
      </div>
      
      <!-- PR√âNOM ET NOM -->
      <div class="register-name-fields">
        <div class="register-field">
          <label class="register-field-label">
            Pr√©nom <span class="register-required">*</span>
            <span id="firstname-status" class="register-field-status"></span>
          </label>
          <input type="text" id="register-firstname" placeholder="Votre pr√©nom" required
                 value="${window.registerData.firstName}"
                 oninput="validateNameRealTime('firstname', this.value)"
                 class="register-input">
          <div id="firstname-feedback" class="register-feedback"></div>
        </div>
        <div class="register-field">
          <label class="register-field-label">
            Nom <span class="register-required">*</span>
            <span id="lastname-status" class="register-field-status"></span>
          </label>
          <input type="text" id="register-lastname" placeholder="Votre nom" required
                 value="${window.registerData.lastName}"
                 oninput="validateNameRealTime('lastname', this.value)"
                 class="register-input">
          <div id="lastname-feedback" class="register-feedback"></div>
        </div>
      </div>
      
      <!-- EMAIL AVEC VALIDATION -->
      <div class="register-field-wrapper">
        <label class="register-field-label">
          Email <span class="register-required">*</span>
          <span id="email-status" class="register-field-status"></span>
        </label>
        <input type="email" id="register-email" placeholder="votre@email.com" required
               value="${window.registerData.email}"
               oninput="validateEmailRealTime(this.value)"
               class="register-input">
        <div id="email-feedback" class="register-feedback"></div>
      </div>
      
      <!-- USERNAME AVEC VALIDATION -->
      <div class="register-field-wrapper">
        <label class="register-field-label">
          Nom d'utilisateur <span class="register-required">*</span>
          <span id="username-status" class="register-field-status"></span>
        </label>
        <input type="text" id="register-username" placeholder="Votre pseudo (3-20 caract√®res)" required
               value="${window.registerData.username}"
               oninput="validateUsernameRealTime(this.value)"
               class="register-input">
        <div id="username-feedback" class="register-feedback"></div>
      </div>
      
      <!-- MOT DE PASSE AVEC INDICATEUR DE FORCE -->
      <div class="register-field-wrapper">
        <label class="register-field-label">
          Mot de passe <span class="register-required">*</span>
          <span id="password-strength-label" class="register-field-status"></span>
        </label>
        <div class="register-password-container">
          <input type="password" id="register-password" placeholder="Minimum 8 caract√®res" required
                 value="${window.registerData.password}"
                 oninput="checkPasswordStrength(this.value)"
                 class="register-input register-password-input">
          <button type="button" onclick="togglePasswordVisibility()" class="register-password-toggle">üëÅÔ∏è</button>
        </div>
        <!-- BARRE DE FORCE DU MOT DE PASSE -->
        <div id="password-strength-bar" class="register-password-strength-bar">
          <div id="password-strength-fill" class="register-password-strength-fill"></div>
        </div>
        <div id="password-feedback" class="register-feedback"></div>
        <div id="password-requirements" class="register-password-requirements">
          <div id="req-length" class="register-password-req">‚úì Au moins 8 caract√®res</div>
          <div id="req-upper" class="register-password-req">‚úì Une majuscule</div>
          <div id="req-lower" class="register-password-req">‚úì Une minuscule</div>
          <div id="req-number" class="register-password-req">‚úì Un chiffre</div>
          <div id="req-special" class="register-password-req">‚úì Un caract√®re sp√©cial (!@#$%^&*)</div>
        </div>
      </div>
      
      <!-- CHOIX D'AVATAR -->
      <div class="register-field-wrapper">
        <label class="register-field-label">
          Choisissez votre avatar <span class="register-required">*</span>
          <span class="register-avatar-name">(${selectedAvatar.name})</span>
        </label>
        <div class="register-avatar-grid">
          ${avatarGrid}
        </div>
      </div>
      
      <!-- DESCRIPTION AVATAR (optionnel) -->
      <div class="register-field-wrapper">
        <label class="register-field-label">
          Description de votre avatar <span class="register-optional">(optionnel)</span>
        </label>
        <textarea id="register-avatar-desc" placeholder="Ex: Fan de techno, toujours partant pour les festivals !" maxlength="150"
                  oninput="document.getElementById('avatar-desc-count').textContent = this.value.length + '/150'"
                  class="register-textarea">${window.registerData.avatarDescription || ''}</textarea>
        <div class="register-textarea-counter">
          <span id="avatar-desc-count">${(window.registerData.avatarDescription || '').length}/150</span>
        </div>
      </div>
      
      <!-- ACCEPTATION CGU/RGPD -->
      <div class="register-terms-container">
        <label class="register-terms-label">
          <input type="checkbox" id="accept-terms" class="register-terms-checkbox">
          <div class="register-terms-text">
            J'accepte les <a href="#" onclick="showTermsModal();return false;" class="register-terms-link">Conditions d'utilisation</a>
            et la <a href="#" onclick="showPrivacyModal();return false;" class="register-terms-link">Politique de confidentialit√©</a> <span class="register-required">*</span>
          </div>
        </label>
      </div>
      
      <div class="register-step-buttons">
        <button onclick="showRegisterStep1()" class="register-btn-secondary">
          ‚Üê Pr√©c√©dent
        </button>
        <button onclick="validateStep2()" class="register-btn-primary">
          Suivant ‚Üí
        </button>
      </div>
    </div>
  `;
  
  console.log('üéØ showRegisterStep2 - setting HTML, length:', html.length);
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
  console.log('üéØ showRegisterStep2 - HTML set successfully and modal displayed');

  // Attacher les event listeners pour les avatars (√©viter CSP)
  AVAILABLE_AVATARS.forEach(av => {
    const avatarEl = document.getElementById(`avatar-option-${av.id}`);
    if (avatarEl) {
      avatarEl.addEventListener('click', () => selectAvatar(av.id));
      avatarEl.addEventListener('mouseover', function() {
        this.classList.add('hover');
      });
      avatarEl.addEventListener('mouseout', function() {
        this.classList.remove('hover');
      });
    }
  });

  // Attacher les event listeners pour la liaison temps r√©el avec registerData
  const firstnameInput = document.getElementById('register-firstname');
  const lastnameInput = document.getElementById('register-lastname');
  const emailInput = document.getElementById('register-email');
  const usernameInput = document.getElementById('register-username');
  const passwordInput = document.getElementById('register-password');
  const avatarDescInput = document.getElementById('register-avatar-desc');

  if (firstnameInput) firstnameInput.addEventListener('input', (e) => window.registerData.firstName = e.target.value);
  if (lastnameInput) lastnameInput.addEventListener('input', (e) => window.registerData.lastName = e.target.value);
  if (emailInput) {
    emailInput.addEventListener('input', (e) => window.registerData.email = e.target.value);
  }
  if (usernameInput) usernameInput.addEventListener('input', (e) => window.registerData.username = e.target.value);
  if (passwordInput) passwordInput.addEventListener('input', (e) => window.registerData.password = e.target.value);
  if (avatarDescInput) avatarDescInput.addEventListener('input', (e) => window.registerData.avatarDescription = e.target.value);
  
  // Initialiser les validations
  if (window.registerData.firstName) validateNameRealTime('firstname', window.registerData.firstName);
  if (window.registerData.lastName) validateNameRealTime('lastname', window.registerData.lastName);
  if (window.registerData.email) validateEmailRealTime(window.registerData.email);
  if (window.registerData.username) validateUsernameRealTime(window.registerData.username);
  if (window.registerData.password) checkPasswordStrength(window.registerData.password);

  console.log('‚úÖ showRegisterStep2 completed successfully');
}

// S√©lectionner un avatar
function selectAvatar(avatarId) {
  // IMPORTANT: Sauvegarder les valeurs actuelles du formulaire AVANT de r√©g√©n√©rer
  const currentFormValues = {
    firstName: document.getElementById('register-firstname')?.value || window.registerData.firstName || '',
    lastName: document.getElementById('register-lastname')?.value || window.registerData.lastName || '',
    email: document.getElementById('register-email')?.value || window.registerData.email || '',
    username: document.getElementById('register-username')?.value || window.registerData.username || '',
    password: document.getElementById('register-password')?.value || window.registerData.password || '',
    avatarDescription: document.getElementById('register-avatar-desc')?.value || window.registerData.avatarDescription || ''
  };

  // Mettre √† jour registerData avec les valeurs actuelles du formulaire
  window.registerData.firstName = currentFormValues.firstName;
  window.registerData.lastName = currentFormValues.lastName;
  window.registerData.email = currentFormValues.email;
  window.registerData.username = currentFormValues.username;
  window.registerData.password = currentFormValues.password;
  window.registerData.avatarDescription = currentFormValues.avatarDescription;

  // Mettre √† jour l'avatarId
  window.registerData.avatarId = avatarId;

  // Rafra√Æchir l'affichage
  showRegisterStep2();
}

// VALIDATION EN TEMPS R√âEL
function validateEmailRealTime(email) {
  const emailInput = document.getElementById("register-email");
  const statusEl = document.getElementById("email-status");
  const feedbackEl = document.getElementById("email-feedback");
  
  if (!email || email.trim() === '') {
    if (statusEl) statusEl.textContent = '';
    if (feedbackEl) feedbackEl.textContent = '';
    if (emailInput) emailInput.style.borderColor = 'var(--ui-card-border)';
    return false;
  }
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const isValid = emailRegex.test(email);
  
  if (statusEl) {
    statusEl.textContent = isValid ? '‚úÖ' : '‚ùå';
    statusEl.style.color = isValid ? '#22c55e' : '#ef4444';
  }
  
  if (feedbackEl) {
    if (isValid) {
      feedbackEl.textContent = '';
      feedbackEl.style.color = '#22c55e';
    } else {
      feedbackEl.textContent = 'Format d\'email invalide';
      feedbackEl.style.color = '#ef4444';
    }
  }
  
  if (emailInput) {
    emailInput.style.borderColor = isValid ? '#22c55e' : '#ef4444';
  }
  
  return isValid;
}

function validateUsernameRealTime(username) {
  const usernameInput = document.getElementById("register-username");
  const statusEl = document.getElementById("username-status");
  const feedbackEl = document.getElementById("username-feedback");
  
  if (!username || username.trim() === '') {
    if (statusEl) statusEl.textContent = '';
    if (feedbackEl) feedbackEl.textContent = '';
    if (usernameInput) usernameInput.style.borderColor = 'var(--ui-card-border)';
    return false;
  }
  
  const usernameRegex = /^[a-zA-Z0-9_-]{3,20}$/;
  const isValid = usernameRegex.test(username);
  
  if (statusEl) {
    statusEl.textContent = isValid ? '‚úÖ' : '‚ùå';
    statusEl.style.color = isValid ? '#22c55e' : '#ef4444';
  }
  
  if (feedbackEl) {
    if (isValid) {
      feedbackEl.textContent = '';
      feedbackEl.style.color = '#22c55e';
    } else {
      if (username.length < 3) {
        feedbackEl.textContent = 'Minimum 3 caract√®res';
      } else if (username.length > 20) {
        feedbackEl.textContent = 'Maximum 20 caract√®res';
      } else {
        feedbackEl.textContent = 'Caract√®res autoris√©s : lettres, chiffres, _ et -';
      }
      feedbackEl.style.color = '#ef4444';
    }
  }
  
  if (usernameInput) {
    usernameInput.style.borderColor = isValid ? '#22c55e' : '#ef4444';
  }
  
  return isValid;
}

function checkPasswordStrength(password) {
  const passwordInput = document.getElementById("register-password");
  const strengthBar = document.getElementById("password-strength-fill");
  const strengthLabel = document.getElementById("password-strength-label");
  const feedbackEl = document.getElementById("password-feedback");
  const requirements = {
    length: document.getElementById("req-length"),
    upper: document.getElementById("req-upper"),
    lower: document.getElementById("req-lower"),
    number: document.getElementById("req-number"),
    special: document.getElementById("req-special")
  };
  
  if (!password || password.length === 0) {
    if (strengthBar) strengthBar.style.width = '0%';
    if (strengthLabel) strengthLabel.textContent = '';
    if (feedbackEl) feedbackEl.textContent = '';
    Object.values(requirements).forEach(el => {
      if (el) el.style.color = 'var(--ui-text-muted)';
    });
    if (passwordInput) passwordInput.style.borderColor = 'var(--ui-card-border)';
    return 0;
  }
  
  // V√©rifier les crit√®res
  const hasLength = password.length >= 8;
  const hasUpper = /[A-Z]/.test(password);
  const hasLower = /[a-z]/.test(password);
  const hasNumber = /[0-9]/.test(password);
  const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
  
  // Mettre √† jour les indicateurs de crit√®res
  if (requirements.length) requirements.length.style.color = hasLength ? '#22c55e' : 'var(--ui-text-muted)';
  if (requirements.upper) requirements.upper.style.color = hasUpper ? '#22c55e' : 'var(--ui-text-muted)';
  if (requirements.lower) requirements.lower.style.color = hasLower ? '#22c55e' : 'var(--ui-text-muted)';
  if (requirements.number) requirements.number.style.color = hasNumber ? '#22c55e' : 'var(--ui-text-muted)';
  if (requirements.special) requirements.special.style.color = hasSpecial ? '#22c55e' : 'var(--ui-text-muted)';
  
  // Calculer la force (0-100)
  const criteriaMet = [hasLength, hasUpper, hasLower, hasNumber, hasSpecial].filter(Boolean).length;
  const strength = (criteriaMet / 5) * 100;
  
  // D√©terminer le niveau de force
  let strengthText = '';
  let strengthColor = '#ef4444';
  
  if (strength < 40) {
    strengthText = 'Faible';
    strengthColor = '#ef4444';
  } else if (strength < 60) {
    strengthText = 'Moyen';
    strengthColor = '#f59e0b';
  } else if (strength < 80) {
    strengthText = 'Fort';
    strengthColor = '#3b82f6';
  } else {
    strengthText = 'Tr√®s fort';
    strengthColor = '#22c55e';
  }
  
  // Mettre √† jour la barre et le label
  if (strengthBar) {
    strengthBar.style.width = strength + '%';
    strengthBar.style.background = strengthColor;
  }
  
  if (strengthLabel) {
    strengthLabel.textContent = strengthText;
    strengthLabel.style.color = strengthColor;
  }
  
  if (feedbackEl) {
    feedbackEl.textContent = `${criteriaMet}/5 crit√®res remplis`;
    feedbackEl.style.color = strengthColor;
  }
  
  if (passwordInput) {
    passwordInput.style.borderColor = strength >= 60 ? '#22c55e' : strength >= 40 ? '#f59e0b' : '#ef4444';
  }
  
  return strength;
}

function togglePasswordVisibility() {
  const passwordInput = document.getElementById("register-password");
  if (!passwordInput) return;
  
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
  } else {
    passwordInput.type = 'password';
  }
}

// Validation du nom/pr√©nom en temps r√©el
function validateNameRealTime(type, value) {
  const inputId = type === 'firstname' ? 'register-firstname' : 'register-lastname';
  const statusId = type === 'firstname' ? 'firstname-status' : 'lastname-status';
  const feedbackId = type === 'firstname' ? 'firstname-feedback' : 'lastname-feedback';
  
  const nameInput = document.getElementById(inputId);
  const statusEl = document.getElementById(statusId);
  const feedbackEl = document.getElementById(feedbackId);
  
  if (!value || value.trim() === '') {
    if (statusEl) statusEl.textContent = '';
    if (feedbackEl) feedbackEl.textContent = '';
    if (nameInput) nameInput.style.borderColor = 'var(--ui-card-border)';
    return false;
  }
  
  const trimmed = value.trim();
  
  // V√©rifier que ce n'est pas juste des caract√®res al√©atoires
  // Un nom/pr√©nom valide doit avoir au moins 2 caract√®res et contenir principalement des lettres
  const nameRegex = /^[a-zA-Z√†√°√¢√§√£√•√®√©√™√´√¨√≠√Æ√Ø√≤√≥√¥√∂√µ√π√∫√ª√º√Ω√ø√±√ß√Ä√Å√Ç√Ñ√É√Ö√à√â√ä√ã√å√ç√é√è√í√ì√î√ñ√ï√ô√ö√õ√ú√ù≈∏√ë√á\s-]{2,30}$/;
  const isValid = nameRegex.test(trimmed) && trimmed.length >= 2 && trimmed.length <= 30;
  
  // V√©rifier qu'il n'y a pas trop de caract√®res sp√©ciaux ou de chiffres
  const hasTooManyNumbers = (trimmed.match(/\d/g) || []).length > trimmed.length * 0.1; // Max 10% de chiffres
  const hasTooManySpecial = (trimmed.match(/[^a-zA-Z√†√°√¢√§√£√•√®√©√™√´√¨√≠√Æ√Ø√≤√≥√¥√∂√µ√π√∫√ª√º√Ω√ø√±√ß√Ä√Å√Ç√Ñ√É√Ö√à√â√ä√ã√å√ç√é√è√í√ì√î√ñ√ï√ô√ö√õ√ú√ù≈∏√ë√á\s-]/g) || []).length > 0;
  
  // V√©rifier qu'il y a au moins une majuscule (nom propre)
  const hasCapital = /[A-Z√Ä√Å√Ç√Ñ√É√Ö√à√â√ä√ã√å√ç√é√è√í√ì√î√ñ√ï√ô√ö√õ√ú√ù≈∏√ë√á]/.test(trimmed);
  
  // V√©rifier que c'est principalement des lettres (au moins 70%)
  const letterCount = (trimmed.match(/[a-zA-Z√†√°√¢√§√£√•√®√©√™√´√¨√≠√Æ√Ø√≤√≥√¥√∂√µ√π√∫√ª√º√Ω√ø√±√ß√Ä√Å√Ç√Ñ√É√Ö√à√â√ä√ã√å√ç√é√è√í√ì√î√ñ√ï√ô√ö√õ√ú√ù≈∏√ë√á]/g) || []).length;
  const isMostlyLetters = letterCount >= trimmed.length * 0.7;
  
  const finalValid = isValid && !hasTooManyNumbers && !hasTooManySpecial && hasCapital && isMostlyLetters;
  
  if (statusEl) {
    statusEl.textContent = finalValid ? '‚úÖ' : '‚ùå';
    statusEl.style.color = finalValid ? '#22c55e' : '#ef4444';
  }
  
  if (feedbackEl) {
    if (finalValid) {
      feedbackEl.textContent = '';
      feedbackEl.style.color = '#22c55e';
    } else {
      if (trimmed.length < 2) {
        feedbackEl.textContent = 'Minimum 2 caract√®res';
      } else if (trimmed.length > 30) {
        feedbackEl.textContent = 'Maximum 30 caract√®res';
      } else if (!hasCapital) {
        feedbackEl.textContent = 'Doit commencer par une majuscule';
      } else if (hasTooManyNumbers) {
        feedbackEl.textContent = 'Un nom ne doit pas contenir de chiffres';
      } else if (hasTooManySpecial) {
        feedbackEl.textContent = 'Caract√®res sp√©ciaux non autoris√©s';
      } else if (!isMostlyLetters) {
        feedbackEl.textContent = 'Doit contenir principalement des lettres';
      } else {
        feedbackEl.textContent = 'Format invalide';
      }
      feedbackEl.style.color = '#ef4444';
    }
  }
  
  if (nameInput) {
    nameInput.style.borderColor = finalValid ? '#22c55e' : '#ef4444';
  }
  
  return finalValid;
}

async function validateStep2() {
  const firstName = document.getElementById("register-firstname")?.value.trim();
  const lastName = document.getElementById("register-lastname")?.value.trim();
  const email = document.getElementById("register-email")?.value.trim();
  const username = document.getElementById("register-username")?.value.trim();
  const password = document.getElementById("register-password")?.value;
  const avatarDesc = document.getElementById("register-avatar-desc")?.value.trim() || '';
  const acceptTerms = document.getElementById("accept-terms")?.checked;
  
  // Validation pr√©nom
  if (!firstName || !validateNameRealTime('firstname', firstName)) {
    showNotification("‚ö†Ô∏è Veuillez entrer un pr√©nom valide (2-30 caract√®res, lettres uniquement)", "warning");
    return;
  }
  
  // Validation nom
  if (!lastName || !validateNameRealTime('lastname', lastName)) {
    showNotification("‚ö†Ô∏è Veuillez entrer un nom valide (2-30 caract√®res, lettres uniquement)", "warning");
    return;
  }
  
  // Validation email
  if (!email || !validateEmailRealTime(email)) {
    showNotification("‚ö†Ô∏è Veuillez entrer une adresse email valide", "warning");
    return;
  }
  
  // Validation username
  if (!username || !validateUsernameRealTime(username)) {
    showNotification("‚ö†Ô∏è Le nom d'utilisateur doit contenir 3-20 caract√®res (lettres, chiffres, _ et -)", "warning");
    return;
  }
  
  // Validation mot de passe
  if (!password) {
    showNotification("‚ö†Ô∏è Veuillez entrer un mot de passe", "warning");
    return;
  }
  
  const passwordStrength = checkPasswordStrength(password);
  if (passwordStrength < 40) {
    showNotification("‚ö†Ô∏è Le mot de passe est trop faible. Veuillez renforcer votre mot de passe.", "warning");
    return;
  }
  
  // Validation avatar
  if (!window.registerData.avatarId) {
    showNotification("‚ö†Ô∏è Veuillez choisir un avatar", "warning");
    return;
  }
  
  // Validation CGU
  if (!acceptTerms) {
    showNotification("‚ö†Ô∏è Vous devez accepter les Conditions d'utilisation et la Politique de confidentialit√©", "warning");
    return;
  }
  
  // V√©rifier le rate limiting
  const now = Date.now();
  if (window.registerData.lastRegistrationAttempt && (now - window.registerData.lastRegistrationAttempt) < 60000) {
    const remainingSeconds = Math.ceil((60000 - (now - window.registerData.lastRegistrationAttempt)) / 1000);
    showNotification(`‚è±Ô∏è Veuillez patienter ${remainingSeconds} secondes avant de r√©essayer`, "warning");
    return;
  }
  
  window.registerData.firstName = firstName;
  window.registerData.lastName = lastName;
  window.registerData.email = email;
  window.registerData.username = username;
  window.registerData.password = password;
  window.registerData.avatarDescription = avatarDesc;
  window.registerData.lastRegistrationAttempt = now;
  window.registerData.registrationAttempts++;
  
  // V√©rifier si l'email existe d√©j√†
  try {
    const checkResponse = await fetch(`${window.API_BASE_URL}/user/check-email`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email })
    });
    
    if (checkResponse.ok) {
      const checkData = await checkResponse.json();
      if (checkData.exists) {
        showNotification("‚ö†Ô∏è Cet email est d√©j√† utilis√©. Veuillez vous connecter ou utiliser un autre email.", "warning");
        return;
      }
    }
  } catch (error) {
    console.error('Erreur v√©rification email:', error);
    // Continuer m√™me si la v√©rification √©choue
  }
  
  // Passer √† l'√©tape de v√©rification d'email
  showRegisterStep2_5();
}

// √âTAPE 2.5 : V√âRIFICATION D'EMAIL
function showRegisterStep2_5() {
  window.registerStep = 2.5;
  
  // G√©n√©rer et envoyer le code si pas d√©j√† fait
  if (!window.window.registerData.emailVerificationCode) {
    sendVerificationCode();
  }
  
  const maskedEmail = window.registerData.email.replace(/(.{2})(.*)(@.*)/, '$1***$3');
  let countdown = window.registerData.resendCountdown || 0;
  
  const html = `
    <div style="padding:24px;max-width:550px;margin:0 auto;max-height:85vh;overflow-y:auto;animation:fadeIn 0.3s ease-in;">
      <div style="text-align:center;margin-bottom:28px;">
        <div style="font-size:64px;margin-bottom:16px;animation:scaleIn 0.4s ease-out;">üìß</div>
        <h2 style="margin:0;font-size:24px;font-weight:700;color:#fff;">V√©rifiez votre email</h2>
        <p style="color:var(--ui-text-muted);margin-top:12px;font-size:15px;line-height:1.6;">
          Nous avons envoy√© un code de v√©rification √† 6 chiffres √†<br>
          <strong style="color:#fff;">${maskedEmail}</strong>
        </p>
        <div style="display:flex;justify-content:center;gap:8px;margin-top:20px;">
          <div style="width:60px;height:4px;background:var(--ui-card-border);border-radius:2px;"></div>
          <div style="width:60px;height:4px;background:linear-gradient(135deg,#3b82f6,#2563eb);border-radius:2px;"></div>
          <div style="width:60px;height:4px;background:var(--ui-card-border);border-radius:2px;"></div>
        </div>
      </div>
      
      <!-- CAPTCHA SIMPLE -->
      <div id="captcha-container" style="margin-bottom:20px;padding:16px;background:rgba(59,130,246,0.1);border-radius:12px;border:1px solid rgba(59,130,246,0.3);">
        <div style="font-size:13px;font-weight:600;color:#3b82f6;margin-bottom:12px;">üîí V√©rification anti-spam</div>
        <div id="captcha-question" style="font-size:14px;color:var(--ui-text-main);margin-bottom:12px;"></div>
        <input type="text" id="captcha-answer" placeholder="Votre r√©ponse" 
               style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:15px;">
        <div id="captcha-feedback" style="margin-top:8px;font-size:12px;"></div>
      </div>
      
      <!-- CODE DE V√âRIFICATION -->
      <div style="margin-bottom:24px;">
        <label style="display:block;font-size:14px;font-weight:600;color:#fff;margin-bottom:12px;text-align:center;">
          Code de v√©rification <span style="color:#ef4444;">*</span>
        </label>
        <div style="display:flex;justify-content:center;gap:8px;margin-bottom:12px;">
          ${[0,1,2,3,4,5].map(i => `
            <input type="text" 
                   id="code-digit-${i}" 
                   maxlength="1" 
                   pattern="[0-9]"
                   oninput="handleCodeInput(${i}, this.value)"
                   onkeydown="handleCodeKeydown(${i}, event)"
                   style="width:50px;height:60px;text-align:center;font-size:28px;font-weight:700;border-radius:10px;border:2px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:#fff;transition:all 0.2s;"
                   onfocus="this.style.borderColor='#3b82f6';this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.2)'"
                   onblur="this.style.borderColor='var(--ui-card-border)';this.style.boxShadow='none'">
          `).join('')}
        </div>
        <div id="code-feedback" style="text-align:center;font-size:13px;margin-top:12px;"></div>
        <div id="code-attempts" style="text-align:center;font-size:12px;color:var(--ui-text-muted);margin-top:8px;"></div>
      </div>
      
      <!-- BOUTON RENVOYER -->
      <div style="text-align:center;margin-bottom:24px;">
        <button id="resend-button" onclick="resendVerificationCode()" 
                style="padding:10px 20px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:13px;transition:all 0.2s;"
                onmouseover="this.style.background='rgba(15,23,42,0.5)'" 
                onmouseout="this.style.background='transparent'">
          üì® Renvoyer le code
        </button>
        <div id="resend-countdown" style="margin-top:8px;font-size:12px;color:var(--ui-text-muted);"></div>
      </div>
      
      <!-- MESSAGE D'INFORMATION -->
      <div style="background:rgba(0,255,195,0.1);border:1px solid rgba(0,255,195,0.3);border-radius:12px;padding:16px;margin-bottom:24px;">
        <div style="font-size:12px;color:var(--ui-text-muted);line-height:1.6;">
          <strong style="color:#00ffc3;">üí° Astuce :</strong> V√©rifiez votre dossier spam si vous ne recevez pas l'email dans les 2 minutes.
          <br><br>
          Le code expire dans <strong style="color:#fff;">15 minutes</strong>.
        </div>
      </div>
      
      <div style="display:flex;gap:12px;">
        <button onclick="showRegisterStep2()" style="flex:1;padding:14px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-weight:600;transition:all 0.2s;" onmouseover="this.style.background='rgba(15,23,42,0.5)'" onmouseout="this.style.background='transparent'">
          ‚Üê Pr√©c√©dent
        </button>
        <button onclick="verifyEmailCode()" style="flex:1;padding:14px;border-radius:999px;border:none;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(34,197,94,0.4);transition:all 0.2s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(34,197,94,0.6)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 15px rgba(34,197,94,0.4)'">
          V√©rifier ‚Üí
        </button>
      </div>
    </div>
    <style>
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes scaleIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
    </style>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  
  // G√©n√©rer un CAPTCHA simple
  generateCaptcha();
  
  // Focus sur le premier champ de code
  setTimeout(() => {
    const firstInput = document.getElementById("code-digit-0");
    if (firstInput) firstInput.focus();
  }, 100);
  
  // Mettre √† jour le compteur de tentatives
  updateCodeAttemptsDisplay();
  
  // D√©marrer le countdown pour le renvoi
  if (countdown > 0) {
    startResendCountdown(countdown);
  }
}

// G√©n√©rer un CAPTCHA simple
function generateCaptcha() {
  const num1 = Math.floor(Math.random() * 10) + 1;
  const num2 = Math.floor(Math.random() * 10) + 1;
  const operators = ['+', '-', '√ó'];
  const operator = operators[Math.floor(Math.random() * operators.length)];
  
  let question = '';
  let answer = 0;
  
  if (operator === '+') {
    question = `${num1} + ${num2} = ?`;
    answer = num1 + num2;
  } else if (operator === '-') {
    question = `${num1} - ${num2} = ?`;
    answer = num1 - num2;
  } else {
    question = `${num1} √ó ${num2} = ?`;
    answer = num1 * num2;
  }
  
  window.registerData.captchaAnswer = answer;
  
  const questionEl = document.getElementById("captcha-question");
  if (questionEl) {
    questionEl.textContent = question;
  }
}

// G√©rer la saisie du code
function handleCodeInput(index, value) {
  if (!/^\d$/.test(value) && value !== '') return;
  
  const currentInput = document.getElementById(`code-digit-${index}`);
  if (currentInput && value) {
    currentInput.value = value;
    currentInput.style.borderColor = '#3b82f6';
    
    // Passer au champ suivant
    if (index < 5) {
      const nextInput = document.getElementById(`code-digit-${index + 1}`);
      if (nextInput) {
        nextInput.focus();
      }
    }
  }
  
  // V√©rifier si tous les champs sont remplis
  checkCodeComplete();
}

function handleCodeKeydown(index, event) {
  if (event.key === 'Backspace' && !event.target.value && index > 0) {
    const prevInput = document.getElementById(`code-digit-${index - 1}`);
    if (prevInput) {
      prevInput.focus();
      prevInput.value = '';
    }
  }
}

function checkCodeComplete() {
  let code = '';
  for (let i = 0; i < 6; i++) {
    const input = document.getElementById(`code-digit-${i}`);
    if (input && input.value) {
      code += input.value;
    } else {
      return false;
    }
  }
  
  // Auto-v√©rification si le code est complet
  if (code.length === 6) {
    verifyEmailCode(code);
  }
  
  return true;
}

// Envoyer le code de v√©rification
async function sendVerificationCode() {
  try {
    showNotification("üìß Envoi du code de v√©rification...", "info");
    
    // G√©n√©rer un code √† 6 chiffres
    const code = Math.floor(100000 + Math.random() * 900000).toString();
    window.window.registerData.emailVerificationCode = code;
    window.registerData.codeSentAt = Date.now();
    window.registerData.codeExpiresAt = Date.now() + (15 * 60 * 1000); // 15 minutes
    
    // Envoyer via le backend
    const response = await fetch(`${window.API_BASE_URL}/user/send-verification-code`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: window.registerData.email,
        code: code,
        username: window.registerData.username
      })
    });
    
    if (response.ok) {
      showNotification("‚úÖ Code envoy√© ! V√©rifiez votre bo√Æte email.", "success");
      
      // En mode d√©veloppement, afficher le code dans la console
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log(`üîê CODE DE V√âRIFICATION (DEV ONLY): ${code}`);
      }
    } else {
      // En cas d'erreur backend, utiliser le code g√©n√©r√© localement
      console.warn('Backend non disponible, utilisation du code local');
      showNotification("‚úÖ Code g√©n√©r√© ! (Mode d√©veloppement)", "success");
      console.log(`üîê CODE DE V√âRIFICATION (DEV ONLY): ${code}`);
    }
  } catch (error) {
    console.error('Erreur envoi code:', error);
    // En cas d'erreur, g√©n√©rer quand m√™me un code pour le d√©veloppement
    const code = Math.floor(100000 + Math.random() * 900000).toString();
    window.window.registerData.emailVerificationCode = code;
    window.registerData.codeSentAt = Date.now();
    window.registerData.codeExpiresAt = Date.now() + (15 * 60 * 1000);
    showNotification("‚úÖ Code g√©n√©r√© ! (Mode d√©veloppement - v√©rifiez la console)", "info");
    console.log(`üîê CODE DE V√âRIFICATION (DEV ONLY): ${code}`);
  }
}

// Renvoyer le code
async function resendVerificationCode() {
  const now = Date.now();
  const lastResend = window.registerData.lastResendAttempt || 0;
  
  // Rate limiting : 60 secondes entre chaque renvoi
  if (now - lastResend < 60000) {
    const remaining = Math.ceil((60000 - (now - lastResend)) / 1000);
    showNotification(`‚è±Ô∏è Veuillez patienter ${remaining} secondes avant de renvoyer`, "warning");
    return;
  }
  
  window.registerData.lastResendAttempt = now;
  window.window.registerData.emailVerificationCode = null; // R√©initialiser
  
  await sendVerificationCode();
  
  // D√©marrer le countdown
  window.registerData.resendCountdown = 60;
  startResendCountdown(60);
}

function startResendCountdown(seconds) {
  const resendButton = document.getElementById("resend-button");
  const countdownEl = document.getElementById("resend-countdown");
  
  if (!resendButton || !countdownEl) return;
  
  resendButton.disabled = true;
  resendButton.style.opacity = '0.5';
  resendButton.style.cursor = 'not-allowed';
  
  let remaining = seconds;
  
  const interval = setInterval(() => {
    remaining--;
    window.registerData.resendCountdown = remaining;
    
    if (countdownEl) {
      countdownEl.textContent = `Vous pourrez renvoyer dans ${remaining} secondes`;
    }
    
    if (remaining <= 0) {
      clearInterval(interval);
      resendButton.disabled = false;
      resendButton.style.opacity = '1';
      resendButton.style.cursor = 'pointer';
      if (countdownEl) countdownEl.textContent = '';
      window.registerData.resendCountdown = 0;
    }
  }, 1000);
}

// V√©rifier le code
async function verifyEmailCode(providedCode) {
  // V√©rifier le CAPTCHA d'abord
  const captchaInput = document.getElementById("captcha-answer");
  const captchaFeedback = document.getElementById("captcha-feedback");
  
  if (!captchaInput || !captchaInput.value) {
    if (captchaFeedback) {
      captchaFeedback.textContent = "‚ö†Ô∏è Veuillez r√©pondre au CAPTCHA";
      captchaFeedback.style.color = "#ef4444";
    }
    return;
  }
  
  const captchaAnswer = parseInt(captchaInput.value.trim());
  if (captchaAnswer !== window.registerData.captchaAnswer) {
    if (captchaFeedback) {
      captchaFeedback.textContent = "‚ùå R√©ponse incorrecte";
      captchaFeedback.style.color = "#ef4444";
    }
    generateCaptcha(); // R√©g√©n√©rer le CAPTCHA
    captchaInput.value = '';
    return;
  }
  
  if (captchaFeedback) {
    captchaFeedback.textContent = "‚úÖ CAPTCHA correct";
    captchaFeedback.style.color = "#22c55e";
  }
  
  // R√©cup√©rer le code saisi
  if (!providedCode) {
    providedCode = '';
    for (let i = 0; i < 6; i++) {
      const input = document.getElementById(`code-digit-${i}`);
      if (input) {
        providedCode += input.value || '';
      }
    }
  }
  
  if (providedCode.length !== 6) {
    const feedbackEl = document.getElementById("code-feedback");
    if (feedbackEl) {
      feedbackEl.textContent = "‚ö†Ô∏è Veuillez entrer les 6 chiffres";
      feedbackEl.style.color = "#ef4444";
    }
    return;
  }
  
  // V√©rifier le rate limiting
  const now = Date.now();
  if (window.registerData.lastVerificationAttempt) {
    const timeSinceLastAttempt = now - window.registerData.lastVerificationAttempt;
    if (timeSinceLastAttempt < 2000) { // 2 secondes entre chaque tentative
      showNotification("‚è±Ô∏è Veuillez patienter avant de r√©essayer", "warning");
      return;
    }
  }
  
  window.registerData.lastVerificationAttempt = now;
  window.registerData.verificationAttempts++;
  
  // V√©rifier si le code a expir√©
  if (window.registerData.codeExpiresAt && now > window.registerData.codeExpiresAt) {
    showNotification("‚è∞ Le code a expir√©. Veuillez en demander un nouveau.", "warning");
    window.window.registerData.emailVerificationCode = null;
    return;
  }
  
  // V√©rifier le code
  if (providedCode === window.window.registerData.emailVerificationCode) {
    window.window.registerData.emailVerified = true;
    
    // Mettre √† jour l'affichage
    for (let i = 0; i < 6; i++) {
      const input = document.getElementById(`code-digit-${i}`);
      if (input) {
        input.style.borderColor = '#22c55e';
        input.style.background = 'rgba(34,197,94,0.1)';
      }
    }
    
    const feedbackEl = document.getElementById("code-feedback");
    if (feedbackEl) {
      feedbackEl.textContent = "‚úÖ Code v√©rifi√© avec succ√®s !";
      feedbackEl.style.color = "#22c55e";
    }
    
    showNotification("‚úÖ Email v√©rifi√© !", "success");
    
    // Passer √† l'√©tape suivante apr√®s un court d√©lai
    setTimeout(() => {
      showRegisterStep3();
    }, 1000);
  } else {
    // Code incorrect
    window.registerData.verificationAttempts++;
    
    // Bloquer apr√®s 5 tentatives
    if (window.registerData.verificationAttempts >= 5) {
      showNotification("üö´ Trop de tentatives √©chou√©es. Veuillez renvoyer un nouveau code.", "error");
      window.window.registerData.emailVerificationCode = null;
      window.registerData.verificationAttempts = 0;
      showRegisterStep2_5();
      return;
    }
    
    // Afficher l'erreur
    const feedbackEl = document.getElementById("code-feedback");
    if (feedbackEl) {
      feedbackEl.textContent = `‚ùå Code incorrect (${window.registerData.verificationAttempts}/5 tentatives)`;
      feedbackEl.style.color = "#ef4444";
    }
    
    // Effacer les champs
    for (let i = 0; i < 6; i++) {
      const input = document.getElementById(`code-digit-${i}`);
      if (input) {
        input.value = '';
        input.style.borderColor = '#ef4444';
        setTimeout(() => {
          input.style.borderColor = 'var(--ui-card-border)';
        }, 1000);
      }
    }
    
    // Focus sur le premier champ
    const firstInput = document.getElementById("code-digit-0");
    if (firstInput) firstInput.focus();
    
    updateCodeAttemptsDisplay();
  }
}

function updateCodeAttemptsDisplay() {
  const attemptsEl = document.getElementById("code-attempts");
  if (attemptsEl && window.registerData.verificationAttempts > 0) {
    attemptsEl.textContent = `${window.registerData.verificationAttempts}/5 tentatives utilis√©es`;
    attemptsEl.style.color = window.registerData.verificationAttempts >= 3 ? "#ef4444" : "var(--ui-text-muted)";
  }
}

function showRegisterStep3() {
  window.registerStep = 3;
  const addressCount = window.window.registerData.addresses.length || 1;
  
  // S'assurer qu'il y a au moins un champ d'adresse
  if (window.registerData.addresses.length === 0) {
    window.registerData.addresses = [{ address: '', city: '', lat: null, lng: null, isPrimary: true }];
  }
  
  const html = `
    <div style="padding:20px;max-width:600px;margin:0 auto;max-height:80vh;overflow-y:auto;">
      <div style="text-align:center;margin-bottom:24px;">
        <div style="font-size:32px;margin-bottom:8px;">üìç</div>
        <h2 style="margin:0;font-size:22px;font-weight:700;color:#fff;">Vos adresses</h2>
        <p style="color:var(--ui-text-muted);margin-top:8px;font-size:13px;">√âtape 3/3 - Au moins 1 adresse requise (max 2)</p>
        <div style="display:flex;justify-content:center;gap:8px;margin-top:16px;">
          <div style="width:60px;height:4px;background:var(--ui-card-border);border-radius:2px;"></div>
          <div style="width:60px;height:4px;background:var(--ui-card-border);border-radius:2px;"></div>
          <div style="width:60px;height:4px;background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:2px;"></div>
        </div>
      </div>
      
      <div style="background:rgba(0,255,195,0.1);border:1px solid rgba(0,255,195,0.3);border-radius:12px;padding:16px;margin-bottom:20px;">
        <div style="font-size:13px;font-weight:600;color:#00ffc3;margin-bottom:8px;">üí° √Ä quoi servent vos adresses ?</div>
        <div style="font-size:12px;color:var(--ui-text-muted);line-height:1.6;">
          Nous utilisons vos adresses pour vous envoyer des <strong style="color:#00ffc3;">alertes de proximit√©</strong> dans le bloc "Alertes" de la barre de titre.
          <br><br>
          Vous recevrez une notification si un <strong>booking, service, organisateur ou √©v√©nement</strong> que vous avez <strong>lik√©</strong> se trouve dans un rayon de <strong style="color:#00ffc3;">70 km</strong> de l'une de vos adresses.
          <br><br>
          Vos donn√©es sont s√©curis√©es et ne sont utilis√©es que pour ce service.
        </div>
      </div>
      
      <div id="addresses-container">
        ${window.registerData.addresses.map((addr, index) => `
          <div id="address-field-${index}" style="background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);border-radius:12px;padding:16px;margin-bottom:12px;">
            ${index === 0 ? '<div style="font-size:11px;color:#00ffc3;margin-bottom:8px;font-weight:600;">üìç Adresse principale</div>' : ''}
            <div style="margin-bottom:12px;">
              <label style="display:block;font-size:12px;font-weight:600;color:#fff;margin-bottom:6px;">Adresse compl√®te *</label>
              <input type="text" id="address-${index}" placeholder="Rue, num√©ro, ville" required
                     value="${addr.address}"
                     onchange="window.registerData.addresses[${index}].address = this.value"
                     style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:14px;">
            </div>
            <div style="display:flex;gap:8px;align-items:end;">
              <div style="flex:1;">
                <label style="display:block;font-size:12px;font-weight:600;color:#fff;margin-bottom:6px;">Ville *</label>
                <input type="text" id="city-${index}" placeholder="Ville" required
                       value="${addr.city}"
                       onchange="window.registerData.addresses[${index}].city = this.value"
                       style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:14px;">
              </div>
              <button onclick="geocodeAddress(${index})" style="padding:10px 16px;border-radius:8px;border:none;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-weight:600;cursor:pointer;font-size:13px;white-space:nowrap;">
                üîç G√©ocoder
              </button>
            </div>
            ${addr.lat && addr.lng ? `
              <div style="margin-top:8px;font-size:11px;color:#22c55e;">
                ‚úÖ Coordonn√©es : ${addr.lat.toFixed(6)}, ${addr.lng.toFixed(6)}
              </div>
            ` : `
              <div style="margin-top:8px;font-size:11px;color:var(--ui-text-muted);">
                ‚ö†Ô∏è Cliquez sur "G√©ocoder" pour obtenir les coordonn√©es
              </div>
            `}
            ${index > 0 ? `
              <button onclick="removeAddressField(${index})" style="margin-top:8px;padding:6px 12px;border-radius:6px;border:1px solid rgba(239,68,68,0.5);background:rgba(239,68,68,0.1);color:#ef4444;cursor:pointer;font-size:12px;">
                üóëÔ∏è Supprimer
              </button>
            ` : ''}
          </div>
        `).join('')}
      </div>
      
      ${window.registerData.addresses.length < 2 ? `
        <button onclick="addAddressField()" style="width:100%;padding:10px;border-radius:8px;border:1px dashed var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:13px;margin-bottom:20px;">
          + Ajouter une adresse (${window.registerData.addresses.length}/2)
        </button>
      ` : ''}
      
      <div style="display:flex;gap:12px;">
        <button onclick="showRegisterStep2()" style="flex:1;padding:12px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-weight:600;">
          Pr√©c√©dent
        </button>
        <button onclick="completeRegistration()" style="flex:1;padding:12px;border-radius:999px;border:none;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;font-weight:700;cursor:pointer;">
          Cr√©er mon compte
        </button>
      </div>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
}

function addAddressField() {
  if (window.registerData.addresses.length >= 2) {
    showNotification("‚ö†Ô∏è Maximum 2 adresses autoris√©es", "warning");
    return;
  }
  
  window.registerData.addresses.push({ address: '', city: '', lat: null, lng: null, isPrimary: false });
  showRegisterStep3();
}

function removeAddressField(index) {
  if (window.registerData.addresses.length <= 1) {
    showNotification("‚ö†Ô∏è Au moins une adresse est requise", "warning");
    return;
  }
  
  window.registerData.addresses.splice(index, 1);
  showRegisterStep3();
}

async function geocodeAddress(addressIndex) {
  const addressInput = document.getElementById(`address-${addressIndex}`);
  const cityInput = document.getElementById(`city-${addressIndex}`);
  
  if (!addressInput || !cityInput) return;
  
  const address = addressInput.value.trim();
  const city = cityInput.value.trim();
  
  if (!address || !city) {
    showNotification("‚ö†Ô∏è Veuillez remplir l'adresse et la ville", "warning");
    return;
  }
  
  const fullAddress = `${address}, ${city}, Switzerland`;
  
  try {
    showNotification("üîç V√©rification de l'adresse...", "info");
    
    // Utiliser Nominatim avec plus de d√©tails pour v√©rifier que l'adresse est r√©elle
    // VALIDATION STRICTE + PERFORMANCE: Param√®tres optimis√©s pour recherche rapide et exacte
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è RECHERCHE MONDIALE - Pas de restriction de pays, support multilingue
    const langCode = (navigator.language || 'fr').split('-')[0];
    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=10&addressdetails=1&extratags=1&accept-language=${langCode},en&dedupe=1`, {
      headers: {
        'User-Agent': 'MapEventAI/1.0',
        'Accept-Language': `${langCode},en,fr`
      }
    });
    
    if (!response.ok) {
      throw new Error('Erreur de g√©ocodage');
    }
    
    const data = await response.json();
    
    if (data.length === 0) {
      showNotification("‚ö†Ô∏è Adresse introuvable. Veuillez v√©rifier que l'adresse existe r√©ellement.", "warning");
      return;
    }
    
    // Prendre le r√©sultat le plus pertinent (g√©n√©ralement le premier)
    const result = data[0];
    
    // V√©rifier que le r√©sultat correspond bien √† une adresse r√©elle
    const resultType = result.type || '';
    const resultClass = result.class || '';
    const addressDetails = result.address || {};
    
    // V√©rifier que c'est bien une adresse (pas juste une ville ou un pays)
    const isValidAddress = resultType === 'house' || 
                          resultType === 'building' || 
                          resultType === 'residential' ||
                          resultClass === 'place' ||
                          (addressDetails.house_number && addressDetails.road);
    
    if (!isValidAddress && data.length > 1) {
      // Chercher un r√©sultat plus pr√©cis
      const betterResult = data.find(r => 
        r.type === 'house' || 
        r.type === 'building' || 
        (r.address && r.address.house_number)
      );
      if (betterResult) {
        Object.assign(result, betterResult);
      }
    }
    
    const lat = parseFloat(result.lat);
    const lng = parseFloat(result.lon);
    
    // V√©rifier que les coordonn√©es sont valides
    if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
      showNotification("‚ö†Ô∏è Coordonn√©es invalides. L'adresse semble incorrecte.", "warning");
      return;
    }
    
    // V√©rifier que l'adresse est en Suisse (ou pays autoris√©)
    const country = addressDetails.country_code?.toUpperCase() || '';
    if (country && country !== 'CH' && country !== 'FR' && country !== 'DE' && country !== 'IT' && country !== 'AT') {
      showNotification(`‚ö†Ô∏è L'adresse doit √™tre en Suisse ou dans un pays voisin (actuellement: ${country}).`, "warning");
      return;
    }
    
    // D√©tecter le pays pour l'enregistrement (utiliser la premi√®re adresse)
    if (!registerData.registeredCountry && country) {
      registerData.registeredCountry = country;
    }
    
    // Stocker les informations compl√®tes pour v√©rification backend
    window.registerData.addresses[addressIndex].lat = lat;
    window.registerData.addresses[addressIndex].lng = lng;
    window.registerData.addresses[addressIndex].address = address;
    window.registerData.addresses[addressIndex].city = city;
    window.registerData.addresses[addressIndex].verified = true;
    window.registerData.addresses[addressIndex].addressDetails = {
      house_number: addressDetails.house_number || '',
      road: addressDetails.road || '',
      postcode: addressDetails.postcode || '',
      country: addressDetails.country || '',
      country_code: country
    };
    
    showNotification("‚úÖ Adresse v√©rifi√©e et valid√©e !", "success");
    showRegisterStep3(); // Rafra√Æchir pour afficher les coordonn√©es
  } catch (error) {
    console.error('Erreur g√©ocodage:', error);
    showNotification("‚ùå Erreur lors de la v√©rification. R√©essayez plus tard.", "error");
  }
}

async function completeRegistration() {
  // V√©rifier que l'email est v√©rifi√©
  if (!window.window.registerData.emailVerified) {
    showContextualError('EMAIL_NOT_VERIFIED', 'Email non v√©rifi√©');
    return;
  }
  
  // V√©rifier qu'au moins une adresse a des coordonn√©es
  const validAddresses = window.registerData.addresses.filter(addr => 
    addr.address && addr.city && addr.lat && addr.lng
  );
  
  if (validAddresses.length === 0) {
    showContextualError('VALIDATION_ERROR', 'Adresse postale requise', {
      details: 'Veuillez ajouter et g√©ocoder au moins une adresse postale.',
      fieldId: 'pro-postal-address'
    });
    return;
  }
  
  // V√©rifier le rate limiting final
  const now = Date.now();
  if (window.registerData.lastRegistrationAttempt && (now - window.registerData.lastRegistrationAttempt) < 30000) {
    const remainingSeconds = Math.ceil((30000 - (now - window.registerData.lastRegistrationAttempt)) / 1000);
    showContextualError('RATE_LIMITED', 'Trop de tentatives', { retryAfter: remainingSeconds });
    return;
  }
  
  // R√©cup√©rer l'avatar s√©lectionn√©
  const selectedAvatar = AVAILABLE_AVATARS.find(av => av.id === window.registerData.avatarId) || AVAILABLE_AVATARS[0];
  
  // Cr√©er l'utilisateur
  const userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  const createdAt = new Date().toISOString();
  
  currentUser = {
    id: userId,
    name: window.registerData.username,
    firstName: window.registerData.firstName,
    lastName: window.registerData.lastName,
    email: window.registerData.email,
    avatar: selectedAvatar.emoji,
    avatarId: selectedAvatar.id,
    avatarName: selectedAvatar.name,
    avatarDescription: window.registerData.avatarDescription || '',
    bio: '',
    isLoggedIn: true,
    favorites: [],
    agenda: [],
    likes: [],
    participating: [],
    alerts: [],
    reviews: {},
    subscription: "free",
    agendaLimit: 20,
    alertLimit: 2,
    eventStatusHistory: {},
    addresses: validAddresses.map((addr, index) => ({
      address: addr.address,
      city: addr.city,
      lat: addr.lat,
      lng: addr.lng,
      isPrimary: index === 0
    })),
    registeredCountry: registerData.registeredCountry || 'CH',
    registeredCountry: registerData.registeredCountry || 'CH',
    smsNotifications: 0,
    smsLimit: 0,
    emailNotifications: 0,
    notificationPreferences: {
      email: true,
      sms: false
    },
    // Nouvelles propri√©t√©s sociales
    friends: [],
    friendRequests: [],
    sentRequests: [],
    blockedUsers: [],
    conversations: [],
    groups: [],
    lastSeen: createdAt,
    profileLinks: [],
    profilePhotos: [],
    createdAt: createdAt,
    lastLoginAt: createdAt
  };
  
  // Initialiser historique et photos si inexistants
  if (!currentUser.history) currentUser.history = [];
  if (!currentUser.photos) currentUser.photos = [];
  
  // Ajouter l'√©v√©nement de cr√©ation de compte √† l'historique
  currentUser.history.unshift({
    action: "Compte cr√©√©",
    icon: "üéâ",
    timestamp: createdAt
  });
  
  // Sauvegarder dans localStorage
  try {
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
  } catch (e) {
    console.error('Erreur sauvegarde utilisateur:', e);
  }
  
  // INTERDICTION : Ne pas modifier le bloc compte - fonctions supprim√©es
  
  // Sauvegarder dans le backend (OBLIGATOIRE - v√©rification c√¥t√© serveur)
  try {
    const response = await fetch(`${window.API_BASE_URL}/user/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: window.registerData.email,
        username: window.registerData.username,
        password: window.registerData.password, // Le backend hash le mot de passe
        firstName: window.registerData.firstName,
        lastName: window.registerData.lastName,
        avatarId: selectedAvatar.id,
        avatarEmoji: selectedAvatar.emoji,
        avatarDescription: window.registerData.avatarDescription || '',
        addresses: currentUser.addresses.map(addr => ({
          ...addr,
          addressDetails: window.registerData.addresses.find(a => a.address === addr.address && a.city === addr.city)?.addressDetails || {}
        })),
        verificationCode: window.window.registerData.emailVerificationCode // Envoyer le code pour double v√©rification
      })
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      // Erreur c√¥t√© backend - utiliser messages contextuels
      if (result.code === 'EMAIL_NOT_VERIFIED') {
        showContextualError('EMAIL_NOT_VERIFIED', result.error || 'Email non v√©rifi√©');
        return;
      } else if (result.code === 'EMAIL_ALREADY_EXISTS' || result.error?.includes('email') || result.error?.includes('Email')) {
        showContextualError('EMAIL_ALREADY_EXISTS', result.error || 'Email d√©j√† utilis√©', { email: window.registerData.email });
        return;
      } else if (result.code === 'USERNAME_ALREADY_EXISTS' || result.error?.includes('username') || result.error?.includes('nom d\'utilisateur')) {
        showContextualError('USERNAME_ALREADY_EXISTS', result.error || 'Nom d\'utilisateur d√©j√† pris', { username: window.registerData.username });
        return;
      } else if (result.rate_limited) {
        showContextualError('RATE_LIMITED', result.error || 'Trop de tentatives', { retryAfter: result.retry_after || 300 });
        return;
      } else if (result.error?.includes('mot de passe') || result.error?.includes('password')) {
        showContextualError('PASSWORD_TOO_WEAK', result.error || 'Mot de passe invalide', { details: result.error });
        return;
      } else {
        // Erreur g√©n√©rique avec suggestion de r√©essayer
        showContextualError('NETWORK_ERROR', result.error || 'Erreur lors de la cr√©ation du compte', {
          retryCallback: () => completeRegistration()
        });
        return;
      }
    }
    
    // Utiliser l'ID utilisateur retourn√© par le backend
    if (result.userId) {
      currentUser.id = result.userId;
    }
    
    console.log('‚úÖ Compte cr√©√© avec succ√®s dans le backend:', result);
  } catch (error) {
    console.error('Erreur enregistrement backend:', error);
    showContextualError('NETWORK_ERROR', 'Erreur de connexion au serveur', {
      retryCallback: () => completeRegistration()
    });
    return; // Ne pas continuer si le backend √©choue
  }
  
  showNotification("‚úÖ Compte cr√©√© avec succ√®s !", "success");
  closePublishModal();
  // INTERDICTION : Ne pas modifier le bloc compte - fonctions supprim√©es
  
  // Charger les donn√©es utilisateur
  await loadUserDataOnLogin();
}

// Alias pour compatibilit√©
function showRegisterForm() {
  openRegisterModal();
}

// Modales CGU/RGPD
function showTermsModal() {
  console.log('[MODAL] showTermsModal appel√©e');
  
  // Ouvrir le modal d'abord
  const backdrop = document.getElementById('publish-modal-backdrop');
  const modal = document.getElementById('publish-modal-inner');
  
  if (!backdrop || !modal) {
    console.error('[MODAL] √âl√©ments modal non trouv√©s');
    return false;
  }
  
  const html = `
    <div style="padding:24px;max-width:700px;margin:0 auto;max-height:85vh;overflow-y:auto;">
      <h2 style="margin:0 0 20px;font-size:24px;font-weight:700;color:#fff;">Conditions d'utilisation</h2>
      <div style="color:var(--ui-text-main);line-height:1.8;font-size:14px;">
        <p><strong>Derni√®re mise √† jour :</strong> ${new Date().toLocaleDateString('fr-FR')}</p>
        <p>En utilisant MapEventAI, vous acceptez les pr√©sentes conditions d'utilisation.</p>
        <h3 style="color:#fff;margin-top:24px;margin-bottom:12px;">1. Acceptation des conditions</h3>
        <p>En acc√©dant et en utilisant cette plateforme, vous acceptez d'√™tre li√© par ces conditions d'utilisation.</p>
        <h3 style="color:#fff;margin-top:24px;margin-bottom:12px;">2. Utilisation du service</h3>
        <p>Vous vous engagez √† utiliser MapEventAI de mani√®re l√©gale et conforme √† ces conditions. Toute utilisation abusive est interdite.</p>
        <h3 style="color:#fff;margin-top:24px;margin-bottom:12px;">3. Propri√©t√© intellectuelle</h3>
        <p>Tous les contenus de la plateforme sont prot√©g√©s par les droits de propri√©t√© intellectuelle.</p>
        <h3 style="color:#fff;margin-top:24px;margin-bottom:12px;">4. Limitation de responsabilit√©</h3>
        <p>MapEventAI ne peut √™tre tenu responsable des dommages r√©sultant de l'utilisation de la plateforme.</p>
      </div>
      <button onclick="if(typeof window.showProRegisterForm==='function'){window.showProRegisterForm();}else if(typeof showProRegisterForm==='function'){showProRegisterForm();}return false;" style="width:100%;padding:14px;border-radius:999px;border:none;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-weight:700;cursor:pointer;margin-top:24px;">
        Fermer et revenir au formulaire
      </button>
    </div>
  `;
  
  backdrop.style.display = 'flex';
  modal.style.display = 'block';
  modal.innerHTML = html;
  console.log('[MODAL] Modal Conditions d\'utilisation affich√©');
  return false;
}

function showPrivacyModal() {
  console.log('[MODAL] ‚úÖ showPrivacyModal appel√©e');
  
  // Ouvrir le modal d'abord
  const backdrop = document.getElementById('publish-modal-backdrop');
  const modal = document.getElementById('publish-modal-inner');
  
  if (!backdrop || !modal) {
    console.error('[MODAL] ‚ùå √âl√©ments modal non trouv√©s pour showPrivacyModal');
    return false;
  }
  
  console.log('[MODAL] ‚úÖ √âl√©ments trouv√©s, ouverture du modal');
  
  const html = `
    <div style="padding:24px;max-width:700px;margin:0 auto;max-height:85vh;overflow-y:auto;">
      <h2 style="margin:0 0 20px;font-size:24px;font-weight:700;color:#fff;">Politique de confidentialit√©</h2>
      <div style="color:var(--ui-text-main);line-height:1.8;font-size:14px;">
        <p><strong>Derni√®re mise √† jour :</strong> ${new Date().toLocaleDateString('fr-FR')}</p>
        <p>MapEventAI s'engage √† prot√©ger votre vie priv√©e et vos donn√©es personnelles.</p>
        <h3 style="color:#fff;margin-top:24px;margin-bottom:12px;">1. Donn√©es collect√©es</h3>
        <p>Nous collectons les donn√©es n√©cessaires au fonctionnement du service : email, nom d'utilisateur, adresses (pour les alertes de proximit√©), et pr√©f√©rences.</p>
        <h3 style="color:#fff;margin-top:24px;margin-bottom:12px;">2. Utilisation des donn√©es</h3>
        <p>Vos donn√©es sont utilis√©es uniquement pour :</p>
        <ul style="padding-left:24px;margin:12px 0;">
          <li>Fournir les services de la plateforme</li>
          <li>Envoyer des alertes de proximit√© (rayon de 70km)</li>
          <li>Am√©liorer nos services</li>
        </ul>
        <h3 style="color:#fff;margin-top:24px;margin-bottom:12px;">3. S√©curit√©</h3>
        <p>Nous mettons en ≈ìuvre des mesures de s√©curit√© appropri√©es pour prot√©ger vos donn√©es contre tout acc√®s non autoris√©.</p>
        <h3 style="color:#fff;margin-top:24px;margin-bottom:12px;">4. Vos droits</h3>
        <p>Conform√©ment au RGPD, vous disposez d'un droit d'acc√®s, de rectification, de suppression et de portabilit√© de vos donn√©es.</p>
      </div>
      <button onclick="if(typeof window.showProRegisterForm==='function'){window.showProRegisterForm();}else if(typeof showProRegisterForm==='function'){showProRegisterForm();}return false;" style="width:100%;padding:14px;border-radius:999px;border:none;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-weight:700;cursor:pointer;margin-top:24px;">
        Fermer et revenir au formulaire
      </button>
    </div>
  `;
  
  backdrop.style.display = 'flex';
  modal.style.display = 'block';
  modal.innerHTML = html;
  console.log('[MODAL] Modal Politique de confidentialit√© affich√©');
  return false;
}

function openReviewModal(type, id) {
  const key = `${type}:${id}`;
  const reviews = currentUser.reviews[key] || [];
  const reviewsPerPage = 10;
  let currentPage = 1;
  
  // Initialiser si n√©cessaire
  if (!currentUser.reviews[key]) {
    currentUser.reviews[key] = [];
  }
  
  function renderReviews(page = 1) {
    const start = (page - 1) * reviewsPerPage;
    const end = start + reviewsPerPage;
    const pageReviews = reviews.slice(start, end);
    const totalPages = Math.ceil(reviews.length / reviewsPerPage);
    
    const reviewsHtml = pageReviews.length === 0 ? `
      <div style="text-align:center;padding:40px;color:var(--ui-text-muted);">
        <div style="font-size:48px;margin-bottom:16px;">üí¨</div>
        <p>Aucun avis pour le moment</p>
        <p style="font-size:12px;margin-top:8px;">Soyez le premier √† laisser un avis !</p>
      </div>
    ` : pageReviews.map(review => {
      const repliesHtml = (review.replies || []).map(reply => `
        <div style="margin-left:40px;margin-top:8px;padding:8px;background:rgba(15,23,42,0.5);border-radius:8px;border-left:3px solid #3b82f6;">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
            <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,${reply.avatarColor || '#3b82f6'},${reply.avatarColor2 || '#8b5cf6'});display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;">
              ${reply.avatar || reply.userName.charAt(0).toUpperCase()}
            </div>
            <span style="font-weight:600;font-size:12px;">${escapeHtml(reply.userName)}</span>
            <span style="font-size:10px;color:var(--ui-text-muted);">${formatDate(reply.date)}</span>
          </div>
          <div style="font-size:13px;color:var(--ui-text-main);">${escapeHtml(reply.text)}</div>
        </div>
      `).join('');
      
      return `
        <div style="padding:12px;background:rgba(15,23,42,0.5);border-radius:12px;margin-bottom:12px;border:1px solid var(--ui-card-border);">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
            <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,${review.avatarColor || '#00ffc3'},${review.avatarColor2 || '#3b82f6'});display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;">
              ${review.avatar || review.userName.charAt(0).toUpperCase()}
            </div>
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-weight:600;font-size:14px;">${escapeHtml(review.userName)}</span>
                ${review.rating ? `<span style="font-size:12px;color:#facc15;">${'‚≠ê'.repeat(review.rating)}</span>` : ''}
              </div>
              <div style="font-size:11px;color:var(--ui-text-muted);">${formatDate(review.date)}</div>
            </div>
          </div>
          <div style="font-size:14px;color:var(--ui-text-main);line-height:1.5;margin-bottom:8px;">${escapeHtml(review.text)}</div>
          ${repliesHtml}
          <button onclick="showReplyForm('${review.id}', '${type}', ${id})" style="margin-top:8px;padding:4px 12px;border-radius:6px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:12px;">
            üí¨ R√©pondre
          </button>
        </div>
      `;
    }).join('');
    
    const paginationHtml = totalPages > 1 ? `
      <div style="display:flex;justify-content:center;align-items:center;gap:8px;margin-top:16px;">
        <button onclick="loadReviewPage(${Math.max(1, page - 1)})" ${page === 1 ? 'disabled' : ''} style="padding:6px 12px;border-radius:6px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:12px;${page === 1 ? 'opacity:0.5;cursor:not-allowed;' : ''}">
          ‚Üê Pr√©c√©dent
        </button>
        <span style="font-size:12px;color:var(--ui-text-muted);">Page ${page}/${totalPages}</span>
        <button onclick="loadReviewPage(${Math.min(totalPages, page + 1)})" ${page === totalPages ? 'disabled' : ''} style="padding:6px 12px;border-radius:6px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:12px;${page === totalPages ? 'opacity:0.5;cursor:not-allowed;' : ''}">
          Suivant ‚Üí
        </button>
      </div>
    ` : '';
    
    const container = document.getElementById('reviews-list-container');
    if (container) {
      container.innerHTML = reviewsHtml + paginationHtml;
    }
  }
  
  const html = `
    <div style="padding:10px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 style="margin:0;font-size:18px;">‚≠ê Avis et Discussions (${reviews.length})</h2>
        <button onclick="closePublishModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--ui-text-muted);">‚úï</button>
      </div>
      
      <!-- Liste des avis avec pagination -->
      <div id="reviews-list-container" style="max-height:calc(80vh - 250px);overflow-y:auto;margin-bottom:16px;padding-right:8px;">
        ${reviews.length === 0 ? `
          <div style="text-align:center;padding:40px;color:var(--ui-text-muted);">
            <div style="font-size:48px;margin-bottom:16px;">üí¨</div>
            <p>Aucun avis pour le moment</p>
            <p style="font-size:12px;margin-top:8px;">Soyez le premier √† laisser un avis !</p>
          </div>
        ` : reviews.slice(0, reviewsPerPage).map(review => {
          const repliesHtml = (review.replies || []).map(reply => `
            <div style="margin-left:40px;margin-top:8px;padding:8px;background:rgba(15,23,42,0.5);border-radius:8px;border-left:3px solid #3b82f6;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,${reply.avatarColor || '#3b82f6'},${reply.avatarColor2 || '#8b5cf6'});display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;">
                  ${reply.avatar || reply.userName.charAt(0).toUpperCase()}
                </div>
                <span style="font-weight:600;font-size:12px;">${escapeHtml(reply.userName)}</span>
                <span style="font-size:10px;color:var(--ui-text-muted);">${formatDate(reply.date)}</span>
              </div>
              <div style="font-size:13px;color:var(--ui-text-main);">${escapeHtml(reply.text)}</div>
            </div>
          `).join('');
          
          return `
            <div style="padding:12px;background:rgba(15,23,42,0.5);border-radius:12px;margin-bottom:12px;border:1px solid var(--ui-card-border);">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,${review.avatarColor || '#00ffc3'},${review.avatarColor2 || '#3b82f6'});display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;">
                  ${review.avatar || review.userName.charAt(0).toUpperCase()}
                </div>
                <div style="flex:1;">
                  <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-weight:600;font-size:14px;">${escapeHtml(review.userName)}</span>
                    ${review.rating ? `<span style="font-size:12px;color:#facc15;">${'‚≠ê'.repeat(review.rating)}</span>` : ''}
                  </div>
                  <div style="font-size:11px;color:var(--ui-text-muted);">${formatDate(review.date)}</div>
                </div>
              </div>
              <div style="font-size:14px;color:var(--ui-text-main);line-height:1.5;margin-bottom:8px;">${escapeHtml(review.text)}</div>
              ${repliesHtml}
              <button onclick="showReplyForm('${review.id}', '${type}', ${id})" style="margin-top:8px;padding:4px 12px;border-radius:6px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:12px;">
                üí¨ R√©pondre
              </button>
            </div>
          `;
        }).join('')}
      </div>
      ${reviews.length > reviewsPerPage ? `
        <div style="display:flex;justify-content:center;align-items:center;gap:8px;margin-bottom:16px;">
          <button onclick="loadReviewPage(1)" style="padding:6px 12px;border-radius:6px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:12px;">
            ‚Üê Pr√©c√©dent
          </button>
          <span style="font-size:12px;color:var(--ui-text-muted);">Page 1/${Math.ceil(reviews.length / reviewsPerPage)}</span>
          <button onclick="loadReviewPage(2)" style="padding:6px 12px;border-radius:6px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:12px;">
            Suivant ‚Üí
          </button>
        </div>
      ` : ''}
      
      <!-- Formulaire pour laisser un avis -->
      <div style="padding:12px;background:rgba(15,23,42,0.5);border-radius:12px;border:1px solid var(--ui-card-border);margin-top:16px;">
        <h3 style="margin:0 0 12px;font-size:14px;">Laisser un avis</h3>
        <div style="display:flex;gap:8px;margin-bottom:12px;justify-content:center;">
          ${[1,2,3,4,5].map(n => `
            <button onclick="setRating(${n})" class="rating-star" data-rating="${n}" style="font-size:24px;background:none;border:none;cursor:pointer;transition:transform 0.1s;">‚≠ê</button>
          `).join('')}
        </div>
        <textarea id="review-text" rows="3" placeholder="Partagez votre exp√©rience..." style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);resize:none;font-size:13px;"></textarea>
        <button onclick="submitReview('${type}', ${id})" style="width:100%;margin-top:8px;padding:10px;border-radius:999px;border:none;background:var(--btn-main-bg);color:var(--btn-main-text);font-weight:600;cursor:pointer;font-size:13px;">
          Publier l'avis
        </button>
      </div>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
  
  // Stocker les donn√©es pour la pagination
  window.reviewsData = { key, reviews, currentPage: 1, reviewsPerPage };
  window.renderReviews = renderReviews;
}

function loadReviewPage(page) {
  if (!window.reviewsData) return;
  const { key, reviews, reviewsPerPage } = window.reviewsData;
  window.reviewsData.currentPage = page;
  window.renderReviews(page);
}

function showReplyForm(reviewId, type, id) {
  const replyFormHtml = `
    <div id="reply-form-${reviewId}" style="margin-top:8px;padding:8px;background:rgba(15,23,42,0.7);border-radius:8px;border:1px solid var(--ui-card-border);">
      <textarea id="reply-text-${reviewId}" rows="2" placeholder="Votre r√©ponse..." style="width:100%;padding:8px;border-radius:6px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);resize:none;font-size:12px;margin-bottom:6px;"></textarea>
      <div style="display:flex;gap:6px;">
        <button onclick="submitReply('${reviewId}', '${type}', ${id})" style="flex:1;padding:6px;border-radius:6px;border:none;background:var(--btn-main-bg);color:var(--btn-main-text);font-weight:600;cursor:pointer;font-size:12px;">
          Envoyer
        </button>
        <button onclick="document.getElementById('reply-form-${reviewId}').remove()" style="padding:6px 12px;border-radius:6px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:12px;">
          Annuler
        </button>
      </div>
    </div>
  `;
  
  const existingForm = document.getElementById(`reply-form-${reviewId}`);
  if (existingForm) {
    existingForm.remove();
  } else {
    const reviewElement = document.querySelector(`[data-review-id="${reviewId}"]`);
    if (reviewElement) {
      reviewElement.insertAdjacentHTML('beforeend', replyFormHtml);
    }
  }
}

function submitReply(reviewId, type, id) {
  const text = document.getElementById(`reply-text-${reviewId}`)?.value;
  if (!text || !text.trim()) {
    showNotification("‚ö†Ô∏è Veuillez √©crire une r√©ponse", "warning");
    return;
  }
  
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  const key = `${type}:${id}`;
  const reviews = currentUser.reviews[key] || [];
  const review = reviews.find(r => r.id === reviewId);
  
  if (!review) return;
  
  if (!review.replies) review.replies = [];
  
  const avatarColors = ['#00ffc3', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#22c55e'];
  const avatarColors2 = ['#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#22c55e', '#00ffc3'];
  const colorIndex = Math.floor(Math.random() * avatarColors.length);
  
  review.replies.push({
    id: Date.now(),
    userId: currentUser.id,
    userName: currentUser.name,
    avatar: currentUser.avatar,
    avatarColor: avatarColors[colorIndex],
    avatarColor2: avatarColors2[colorIndex],
    text: text.trim(),
    date: new Date().toISOString()
  });
  
  showNotification("‚úÖ R√©ponse publi√©e !", "success");
  openReviewModal(type, id); // Rafra√Æchir
}

let currentRating = 0;
function setRating(n) {
  currentRating = n;
  document.querySelectorAll(".rating-star").forEach((star, i) => {
    star.style.transform = i < n ? "scale(1.2)" : "scale(1)";
    star.style.filter = i < n ? "none" : "grayscale(1)";
  });
}

function submitReview(type, id) {
  const text = document.getElementById("review-text")?.value;
  if (!text || !text.trim() || currentRating === 0) {
    showNotification("‚ö†Ô∏è Veuillez donner une note et √©crire un avis", "warning");
    return;
  }
  
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  const key = `${type}:${id}`;
  if (!currentUser.reviews[key]) {
    currentUser.reviews[key] = [];
  }
  
  const avatarColors = ['#00ffc3', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#22c55e'];
  const avatarColors2 = ['#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#22c55e', '#00ffc3'];
  const colorIndex = Math.floor(Math.random() * avatarColors.length);
  
  const review = {
    id: Date.now(),
    userId: currentUser.id,
    userName: currentUser.name,
    avatar: currentUser.avatar,
    avatarColor: avatarColors[colorIndex],
    avatarColor2: avatarColors2[colorIndex],
    rating: currentRating,
    text: text.trim(),
    date: new Date().toISOString(),
    replies: []
  };
  
  currentUser.reviews[key].unshift(review); // Ajouter au d√©but
  
  // Mettre √† jour le rating moyen de l'item
  const data = type === "event" ? eventsData : type === "booking" ? bookingsData : servicesData;
  const item = data.find(i => i.id === parseInt(id));
  if (item) {
    const allRatings = currentUser.reviews[key].map(r => r.rating).filter(r => r > 0);
    if (allRatings.length > 0) {
      item.rating = (allRatings.reduce((a, b) => a + b, 0) / allRatings.length).toFixed(1);
    }
  }
  
  showNotification("‚úÖ Avis publi√© avec succ√®s !", "success");
  currentRating = 0;
  openReviewModal(type, id); // Rafra√Æchir pour afficher le nouvel avis
}

async function openDiscussionModal(type, id) {
  // √âchappement HTML s√ªr (au cas o√π escapeHtml n'est pas encore d√©fini)
  const esc = (typeof escapeHtml === 'function') ? escapeHtml : function(s) {
    if (s == null || s === undefined) return '';
    const t = String(s);
    return t.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  };
  
  let item = null;
  if (type === 'event') item = eventsData.find(e => e.id === id);
  else if (type === 'booking') item = bookingsData.find(b => b.id === id);
  else if (type === 'service') item = servicesData.find(s => s.id === id);
  
  const itemTitle = item?.title || item?.name || '√âv√©nement';
  
  // Charger depuis l'API backend (persistant) avec fallback localStorage pour migration
  const postsKey = `discussion_${type}_${id}`;
  let posts = [];
  
  // Charger les posts de mani√®re asynchrone mais afficher un loading
  window._discussionLoadingType = type;
  window._discussionLoadingId = id;
  
  // Tentative de chargement depuis l'API
  try {
    const resp = await fetch(`${window.API_BASE_URL}/discussions/${type}/${id}`);
    if (resp.ok) {
      const data = await resp.json();
      if (data.posts && Array.isArray(data.posts) && data.posts.length > 0) {
        posts = data.posts;
        console.log(`[Discussion] ${posts.length} posts charges depuis API`);
      } else {
        // Fallback : migrer depuis localStorage si existe
        const localPosts = JSON.parse(localStorage.getItem(postsKey) || '[]');
        if (localPosts.length > 0) {
          posts = localPosts;
          // Migrer vers le backend
          fetch(`${window.API_BASE_URL}/discussions/${type}/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ posts: localPosts })
          }).then(() => {
            localStorage.removeItem(postsKey);
            console.log('[Discussion] Migration localStorage -> API OK');
          }).catch(e => console.warn('[Discussion] Migration echouee:', e));
        }
      }
    }
  } catch(e) {
    console.warn('[Discussion] API indisponible, fallback localStorage:', e);
    posts = JSON.parse(localStorage.getItem(postsKey) || '[]');
  }
  
  // PROTECTION : Filtrer les posts corrompus
  const isPostCorrupted = (post) => {
    if (!post || !post.text) return true;
    const text = post.text;
    if (text.length > 5000) return true;
    if (/[A-Za-z0-9+/=]{100,}/.test(text)) return true;
    if (/function\s*\(|const\s+\w+\s*=|window\.|document\./.test(text)) return true;
    return false;
  };
  
  const originalLength = posts.length;
  posts = posts.filter(p => !isPostCorrupted(p));
  if (posts.length !== originalLength) {
    console.log(`[Discussion] ${originalLength - posts.length} posts corrompus supprimes`);
  }
  
  // Fonction pour formater le temps
  const formatTime = (timestamp) => {
    const now = Date.now();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return '√Ä l\'instant';
    if (minutes < 60) return `Il y a ${minutes} min`;
    if (hours < 24) return `Il y a ${hours}h`;
    if (days < 7) return `Il y a ${days}j`;
    return new Date(timestamp).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
  };
  
  // Fonction pour compter toutes les r√©ponses r√©cursives
  const countAllReplies = (replies) => {
    if (!replies || replies.length === 0) return 0;
    let count = replies.length;
    replies.forEach(reply => {
      if (reply.replies && reply.replies.length > 0) {
        count += countAllReplies(reply.replies);
      }
    });
    return count;
  };
  
  // Fonction r√©cursive pour rendre une r√©ponse (style Facebook authentique - compact et professionnel)
  const renderReply = (reply, postId, parentPath = '', depth = 0, showAllNested = false) => {
    const replyPath = parentPath ? `${parentPath}-${reply.id}` : reply.id;
    const avatarSize = 32; // Taille fixe pour toutes les r√©ponses (plus petit que le post)
    const nestedReplies = reply.replies || [];
    
    // Trier les r√©ponses imbriqu√©es par timestamp (plus anciennes en premier)
    const sortedNested = [...nestedReplies].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
    const maxVisibleNested = 2; // Afficher seulement 2 r√©ponses imbriqu√©es par d√©faut
    const visibleNested = showAllNested ? sortedNested : sortedNested.slice(0, maxVisibleNested);
    const hiddenNestedCount = sortedNested.length - maxVisibleNested;
    
    return `
      <div style="margin-bottom:4px;min-width:0;overflow:hidden;">
        <div style="display:flex;gap:8px;min-width:0;">
          <div style="width:${avatarSize}px;height:${avatarSize}px;border-radius:50%;background:linear-gradient(135deg,#1877f2,#42a5f5);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;font-weight:700;color:#fff;">
            ${reply.avatar || 'üë§'}
          </div>
          <div style="flex:1;min-width:0;overflow:hidden;">
            <div style="background:rgba(30,41,59,0.6);border-radius:18px;padding:8px 12px;max-width:100%;word-wrap:break-word;overflow-wrap:break-word;">
              <div style="font-weight:600;font-size:13px;color:#e4e6eb;margin-bottom:2px;">${esc(reply.author || 'Utilisateur')}</div>
              <div style="font-size:13px;color:#e4e6eb;line-height:1.4;white-space:pre-wrap;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word;">${esc(reply.text)}</div>
            </div>
            <div style="display:flex;align-items:center;gap:12px;margin-top:4px;margin-left:12px;">
              <span style="font-size:12px;color:#b0b3b8;font-weight:600;cursor:pointer;" onclick="toggleReplyLike('${type}', '${id}', '${postId}', '${replyPath}')">J'aime</span>
              <button onclick="showReplyForm('${postId}', '${replyPath}')" style="background:none;border:none;color:#b0b3b8;font-size:12px;font-weight:600;cursor:pointer;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
                R√©pondre
              </button>
              <span style="font-size:12px;color:#b0b3b8;">${formatTime(reply.timestamp || Date.now())}</span>
            </div>
          </div>
        </div>
        <!-- Formulaire de r√©ponse -->
        <div id="reply-form-${postId}-${replyPath}" style="display:none;margin-left:${avatarSize + 8}px;margin-top:6px;">
          <div style="display:flex;gap:8px;align-items:flex-start;">
            <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#1877f2,#42a5f5);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;font-weight:700;color:#fff;">
              ${currentUser?.avatar || 'üë§'}
            </div>
            <div style="flex:1;position:relative;">
              <textarea id="reply-input-${postId}-${replyPath}" placeholder="R√©pondre √† ${esc(reply.author || 'Utilisateur')}..." style="width:100%;min-height:36px;max-height:100px;padding:8px 12px;border-radius:20px;border:none;background:rgba(15,23,42,0.8);color:#e4e6eb;font-size:13px;resize:none;line-height:1.33;box-sizing:border-box;display:block;" onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); submitReply('${type}', '${id}', '${postId}', '${replyPath}'); }" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px';"></textarea>
            </div>
          </div>
        </div>
        <!-- R√©ponses imbriqu√©es (r√©cursif) - style Facebook compact -->
        ${sortedNested.length > 0 ? `
          <div style="margin-left:${avatarSize + 8}px;margin-top:4px;" data-post-id="${postId}" data-parent-path="${replyPath}">
            ${visibleNested.map(nestedReply => {
              // V√©rifier si les r√©ponses imbriqu√©es de niveau 2 doivent √™tre affich√©es
              const nested2ShowAllKey = `showAllNestedReplies_${type}_${id}_${postId}_${replyPath}-${nestedReply.id}`;
              const nested2ShowAll = sessionStorage.getItem(nested2ShowAllKey) === 'true';
              return renderReply(nestedReply, postId, replyPath, depth + 1, nested2ShowAll);
            }).join('')}
            ${hiddenNestedCount > 0 && !showAllNested ? `
              <button onclick="showAllNestedReplies('${postId}', '${replyPath}')" style="background:none;border:none;color:#1877f2;font-size:12px;font-weight:600;cursor:pointer;padding:4px 0;margin-top:4px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
                Voir ${hiddenNestedCount} r√©ponse${hiddenNestedCount > 1 ? 's' : ''} suppl√©mentaire${hiddenNestedCount > 1 ? 's' : ''}
              </button>
            ` : ''}
          </div>
        ` : ''}
      </div>
    `;
  };
  
  // Fonction pour rendre un post (style Facebook authentique)
  const renderPost = (post) => {
    const isLiked = (post.likes || []).includes(currentUser?.id || currentUser?.username);
    const likesCount = post.likes ? post.likes.length : 0;
    const repliesCount = post.replies ? post.replies.length : 0;
    
    return `
      <div style="background:rgba(30,41,59,0.8);border-radius:8px;padding:12px;margin-bottom:12px;min-width:0;overflow-wrap:break-word;word-break:break-word;border:1px solid rgba(255,255,255,0.06);">
        <!-- En-t√™te du post -->
        <div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:8px;min-width:0;">
          <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#1877f2,#42a5f5);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;font-weight:700;color:#fff;">
            ${post.avatar || 'üë§'}
          </div>
          <div style="flex:1;min-width:0;">
            <div style="font-weight:600;font-size:14px;color:#e4e6eb;line-height:1.2;overflow-wrap:break-word;word-break:break-word;">${escapeHtml(post.author || 'Utilisateur')}</div>
            <div style="font-size:12px;color:#b0b3b8;line-height:1.2;">${formatTime(post.timestamp || Date.now())}</div>
          </div>
        </div>
        
        <!-- Contenu du post -->
        <div style="font-size:14px;color:#e4e6eb;line-height:1.5;margin-bottom:8px;white-space:pre-wrap;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word;min-width:0;">
          ${escapeHtml(post.text)}
        </div>
        
        <!-- Compteurs (likes, commentaires) -->
        ${(likesCount > 0 || repliesCount > 0) ? `
          <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:4px;">
            ${likesCount > 0 ? `
              <div style="display:flex;align-items:center;gap:4px;font-size:13px;color:#b0b3b8;">
                <span style="font-size:16px;">üëç</span>
                <span>${likesCount}</span>
              </div>
            ` : '<div></div>'}
            ${repliesCount > 0 ? `
              <div style="font-size:13px;color:#b0b3b8;cursor:pointer;" onclick="document.getElementById('reply-form-${post.id}').style.display='block';document.getElementById('reply-input-${post.id}').focus();">
                ${repliesCount} commentaire${repliesCount > 1 ? 's' : ''}
              </div>
            ` : '<div></div>'}
          </div>
        ` : ''}
        
        <!-- Actions du post (Like, Commenter) style Facebook -->
        <div style="display:flex;align-items:center;gap:4px;padding:4px 0;border-top:1px solid rgba(255,255,255,0.1);">
          <button onclick="togglePostLike('${type}', '${id}', '${post.id}')" style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;background:none;border:none;color:${isLiked ? '#1877f2' : '#b0b3b8'};font-size:14px;font-weight:600;cursor:pointer;padding:6px;border-radius:4px;transition:all 0.15s;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">
            <span style="font-size:18px;">${isLiked ? 'üëç' : 'üëç'}</span>
            <span>J'aime</span>
          </button>
          <button onclick="showReplyForm('${post.id}')" style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;background:none;border:none;color:#b0b3b8;font-size:14px;font-weight:600;cursor:pointer;padding:6px;border-radius:4px;transition:all 0.15s;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">
            <span style="font-size:18px;">üí¨</span>
            <span>Commenter</span>
          </button>
        </div>
        
        <!-- Formulaire de r√©ponse (cach√© par d√©faut) style Facebook -->
        <div id="reply-form-${post.id}" style="display:none;margin-top:8px;padding-top:8px;">
          <div style="display:flex;gap:8px;align-items:flex-start;">
            <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#1877f2,#42a5f5);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;font-weight:700;color:#fff;">
              ${currentUser?.avatar || 'üë§'}
            </div>
            <div style="flex:1;position:relative;">
              <textarea id="reply-input-${post.id}" placeholder="√âcrivez un commentaire..." style="width:100%;min-height:36px;max-height:100px;padding:8px 12px;border-radius:20px;border:none;background:rgba(15,23,42,0.8);color:#e4e6eb;font-size:13px;resize:none;line-height:1.33;box-sizing:border-box;display:block;" onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); submitReply('${type}', '${id}', '${post.id}'); }" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px';"></textarea>
            </div>
          </div>
        </div>
        
        <!-- R√©ponses au post (style Facebook - tri√©es chronologiquement) -->
        ${post.replies && post.replies.length > 0 ? `
          <div style="margin-top:8px;">
            ${(() => {
              // Trier les r√©ponses par timestamp (plus anciennes en premier, comme Facebook)
              const sortedReplies = [...post.replies].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
              const totalReplies = countAllReplies(sortedReplies);
              const maxVisible = 3; // Afficher seulement 3 r√©ponses par d√©faut
              const visibleReplies = sortedReplies.slice(0, maxVisible);
              const hiddenCount = sortedReplies.length - maxVisible;
              
              // V√©rifier si on doit afficher toutes les r√©ponses
              const showAllKey = `showAllReplies_${type}_${id}_${post.id}_`;
              const showAll = sessionStorage.getItem(showAllKey) === 'true';
              const finalVisibleReplies = showAll ? sortedReplies : visibleReplies;
              const finalHiddenCount = showAll ? 0 : hiddenCount;
              
              return `
                ${finalVisibleReplies.map(reply => {
                  // V√©rifier si les r√©ponses imbriqu√©es doivent √™tre affich√©es
                  const nestedShowAllKey = `showAllNestedReplies_${type}_${id}_${post.id}_${reply.id}`;
                  const nestedShowAll = sessionStorage.getItem(nestedShowAllKey) === 'true';
                  return renderReply(reply, post.id, '', 0, nestedShowAll);
                }).join('')}
                ${finalHiddenCount > 0 ? `
                  <button onclick="showAllReplies('${post.id}', '')" style="background:none;border:none;color:#1877f2;font-size:13px;font-weight:600;cursor:pointer;padding:4px 0;margin-top:4px;margin-left:48px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
                    Voir ${finalHiddenCount} r√©ponse${finalHiddenCount > 1 ? 's' : ''} suppl√©mentaire${finalHiddenCount > 1 ? 's' : ''}
                  </button>
                ` : ''}
              `;
            })()}
          </div>
        ` : ''}
      </div>
    `;
  };
  
  // Stocker le type et id pour pouvoir revenir √† la popup
  window.currentDiscussionType = type;
  window.currentDiscussionId = id;
  
  const html = `
    <div style="display:flex;flex-direction:column;height:100%;max-height:85vh;min-height:0;overflow:hidden;">
      <!-- En-t√™te -->
      <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.1);background:var(--ui-card-bg, #0f172a);flex-shrink:0;">
        <button onclick="closeDiscussionAndReturnToPopup()" style="background:none;border:none;color:#b0b3b8;font-size:20px;cursor:pointer;padding:4px;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;transition:all 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.1)';this.style.color='#fff'" onmouseout="this.style.background='none';this.style.color='#b0b3b8'">‚Üê</button>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:600;font-size:15px;color:#e4e6eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Discussion</div>
          <div style="font-size:12px;color:#b0b3b8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(itemTitle)}</div>
        </div>
        <button onclick="closeDiscussionAndReturnToPopup()" style="background:none;border:none;color:#b0b3b8;font-size:18px;cursor:pointer;padding:4px;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;transition:all 0.15s;" onmouseover="this.style.background='rgba(239,68,68,0.2)';this.style.color='#ef4444'" onmouseout="this.style.background='none';this.style.color='#b0b3b8'">‚úï</button>
      </div>
      
      <!-- Zone de scroll avec posts -->
      <div id="discussion-posts-container" style="flex:1;overflow-y:auto;overflow-x:hidden;padding:12px;background:var(--ui-card-bg, #020617);min-height:0;">
        ${posts.length > 0 ? posts.map(p => renderPost(p)).join('') : `
          <div style="text-align:center;padding:60px 16px;color:#b0b3b8;font-size:14px;">
            <div style="font-size:48px;margin-bottom:12px;opacity:0.5;">üí¨</div>
            <div style="font-weight:600;margin-bottom:6px;color:#e4e6eb;font-size:15px;">Aucune publication</div>
            <div style="font-size:13px;color:#b0b3b8;">Soyez le premier √† partager quelque chose !</div>
          </div>
        `}
      </div>
      
      <!-- Zone de cr√©ation de post (fixe en bas) -->
      <div style="padding:10px 12px;border-top:1px solid rgba(255,255,255,0.1);background:var(--ui-card-bg);flex-shrink:0;">
        ${currentUser?.isLoggedIn ? `
        <div style="display:flex;gap:8px;align-items:flex-end;">
          <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#1877f2,#42a5f5);display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;font-weight:700;color:#fff;">
            ${currentUser?.avatar || 'üë§'}
          </div>
          <div style="flex:1;min-width:0;">
            <textarea id="discussion-input" placeholder="√âcrivez un commentaire..." style="width:100%;min-height:36px;max-height:100px;padding:8px 12px;border-radius:18px;border:1px solid rgba(255,255,255,0.1);background:rgba(15,23,42,0.8);color:#e4e6eb;font-size:14px;resize:none;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;line-height:1.33;box-sizing:border-box;display:block;" onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); submitDiscussionComment('${type}', '${id}'); }" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px';"></textarea>
          </div>
          <button id="discussion-submit-btn" onclick="submitDiscussionComment('${type}', '${id}')" style="padding:8px 14px;border-radius:18px;border:none;background:#1877f2;color:#fff;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;flex-shrink:0;white-space:nowrap;" onmouseover="this.style.background='#166fe5'" onmouseout="this.style.background='#1877f2'">
            Publier
          </button>
        </div>
        ` : `
        <div style="text-align:center;padding:8px;">
          <button onclick="openLoginModal()" style="padding:10px 20px;border-radius:10px;border:none;background:#1877f2;color:#fff;cursor:pointer;font-size:13px;font-weight:600;">Connectez-vous pour participer</button>
        </div>
        `}
      </div>
    </div>
  `;
  
  // Ouvrir la discussion : dans la popup si ouverte, sinon modal central visible
  const popupBackdrop = document.getElementById("popup-modal-backdrop");
  const popupContent = document.getElementById("popup-modal-content");
  const publishInner = document.getElementById("publish-modal-inner");
  const publishBackdrop = document.getElementById("publish-modal-backdrop");
  
  const popupIsOpen = popupBackdrop && popupContent && (popupBackdrop.style.display === "flex" || popupBackdrop.contains(popupContent));
  
  if (popupBackdrop && popupContent && popupIsOpen) {
    window.discussionOpenedInPopup = true;
    // Injecter le HTML de la discussion directement dans popup-modal-content
    // (pas dans popup-scroll-container, sinon le scroll interne de la discussion est cass√©)
    popupContent.innerHTML = html;
    popupContent.style.maxHeight = "85vh";
    popupContent.style.overflow = "hidden";
    popupContent.style.display = "flex";
    popupContent.style.flexDirection = "column";
    popupContent.style.padding = "0";
    popupContent.style.visibility = "visible";
    popupContent.style.opacity = "1";
    popupBackdrop.style.display = "flex";
    popupBackdrop.style.visibility = "visible";
    popupBackdrop.style.opacity = "1";
    popupBackdrop.style.zIndex = "99999";
    popupBackdrop.style.pointerEvents = "auto";
  } else if (publishInner && publishBackdrop) {
    window.discussionOpenedInPopup = false;
    publishInner.innerHTML = html;
    publishBackdrop.setAttribute('data-auth-modal', 'true');
    publishBackdrop.style.display = "flex";
    publishBackdrop.style.visibility = "visible";
    publishBackdrop.style.opacity = "1";
    publishBackdrop.style.zIndex = "99999";
    publishBackdrop.style.pointerEvents = "auto";
    publishBackdrop.style.paddingTop = "40px";
    publishBackdrop.style.paddingBottom = "40px";
    publishBackdrop.style.boxSizing = "border-box";
    const publishModal = document.getElementById("publish-modal");
    if (publishModal) {
      publishModal.style.display = "block";
      publishModal.style.visibility = "visible";
      publishModal.style.opacity = "1";
    }
  }
  
  setTimeout(() => {
    const input = document.getElementById("discussion-input");
    if (input) input.focus();
  }, 100);
}

// Fermer la discussion et retourner √† la popup de l'√©v√©nement
function closeDiscussionAndReturnToPopup() {
  const type = window.currentDiscussionType;
  const id = window.currentDiscussionId;
  const openedInPopup = window.discussionOpenedInPopup;
  
  if (type && id) {
    const item = getItemById(type, id);
    if (item) {
      let popupHtml = "";
      if (type === "event") popupHtml = buildEventPopup(item);
      else if (type === "booking") popupHtml = buildBookingPopup(item);
      else if (type === "service") popupHtml = buildServicePopup(item);
      
      if (popupHtml) openPopupModal(popupHtml, item);
    }
  }
  
  if (!openedInPopup && typeof closePublishModal === "function") closePublishModal();
}

window.closeDiscussionAndReturnToPopup = closeDiscussionAndReturnToPopup;

// Helper : Sauvegarder les posts de discussion en API (avec fallback localStorage)
async function saveDiscussionToAPI(type, id, posts) {
  try {
    const resp = await fetch(`${window.API_BASE_URL}/discussions/${type}/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ posts })
    });
    if (resp.ok) {
      console.log('[Discussion] Sauvegarde API OK');
      // Nettoyer localStorage si migration OK
      try { localStorage.removeItem(`discussion_${type}_${id}`); } catch(e) {}
      return true;
    }
  } catch(e) {
    console.warn('[Discussion] API save failed, fallback localStorage:', e);
  }
  // Fallback localStorage
  try { localStorage.setItem(`discussion_${type}_${id}`, JSON.stringify(posts)); } catch(e) {}
  return false;
}

// Fonction pour soumettre un post - reste dans la discussion
window.submitDiscussionComment = async function(type, id) {
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }

  const input = document.getElementById("discussion-input");
  if (!input || !input.value.trim()) return;

  const submitBtn = document.getElementById("discussion-submit-btn");
  const originalText = submitBtn ? submitBtn.textContent : '';
  
  // Loading state
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.textContent = '...';
    submitBtn.style.opacity = '0.6';
  }
  input.disabled = true;

  const post = {
    id: Date.now().toString(),
    author: currentUser?.name || currentUser?.username || 'Utilisateur',
    avatar: currentUser?.avatar || 'üë§',
    text: input.value.trim(),
    timestamp: Date.now(),
    likes: [],
    replies: []
  };
  
  try {
    let posts = [];
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);
    
    try {
      const resp = await fetch(`${window.API_BASE_URL}/discussions/${type}/${id}`, { signal: controller.signal });
      clearTimeout(timeoutId);
      if (resp.ok) {
        const data = await resp.json();
        posts = data.posts || [];
      }
    } catch(e) {
      clearTimeout(timeoutId);
      posts = JSON.parse(localStorage.getItem(`discussion_${type}_${id}`) || '[]');
    }
    
    posts.unshift(post);
    await saveDiscussionToAPI(type, id, posts);
    
    input.value = '';
    input.style.height = 'auto';
    
    openDiscussionModal(type, id);
  } catch(e) {
    console.error('[Discussion] Erreur submit:', e);
    showNotification("Erreur lors de la publication. R√©essayez.", "error");
    // Restaurer le bouton
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText.trim() || 'Publier';
      submitBtn.style.opacity = '1';
    }
    input.disabled = false;
    input.focus();
  }
};

// Fonction pour afficher/masquer le formulaire de r√©ponse (avec support pour chemins)
window.showReplyForm = function(postId, replyPath = null) {
  const formId = replyPath ? `reply-form-${postId}-${replyPath}` : `reply-form-${postId}`;
  const form = document.getElementById(formId);
  if (form) {
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
    if (form.style.display === 'block') {
      const textareaId = replyPath ? `reply-input-${postId}-${replyPath}` : `reply-input-${postId}`;
      const textarea = document.getElementById(textareaId);
      if (textarea) setTimeout(() => textarea.focus(), 100);
    }
  }
};

// Fonction pour afficher toutes les r√©ponses d'un post (style Facebook)
window.showAllReplies = function(postId, parentPath = '') {
  const type = window.currentDiscussionType;
  const id = window.currentDiscussionId;
  
  if (!type || !id) return;
  
  // Stocker l'√©tat "showAll" dans sessionStorage pour persister apr√®s rechargement
  const key = `showAllReplies_${type}_${id}_${postId}_${parentPath}`;
  sessionStorage.setItem(key, 'true');
  
  // Recharger la discussion pour afficher toutes les r√©ponses
  openDiscussionModal(type, id);
};

// Fonction pour afficher toutes les r√©ponses imbriqu√©es
window.showAllNestedReplies = function(postId, parentPath) {
  const type = window.currentDiscussionType;
  const id = window.currentDiscussionId;
  
  if (!type || !id) return;
  
  // Stocker l'√©tat "showAll" dans sessionStorage pour persister apr√®s rechargement
  const key = `showAllNestedReplies_${type}_${id}_${postId}_${parentPath}`;
  sessionStorage.setItem(key, 'true');
  
  // Recharger la discussion pour afficher toutes les r√©ponses imbriqu√©es
  openDiscussionModal(type, id);
};

// Fonction pour afficher toutes les r√©ponses imbriqu√©es
window.showAllNestedReplies = function(postId, parentPath) {
  const type = window.currentDiscussionType;
  const id = window.currentDiscussionId;
  
  if (!type || !id) return;
  
  // Trouver le conteneur des r√©ponses imbriqu√©es
  const nestedContainer = document.querySelector(`[data-post-id="${postId}"][data-parent-path="${parentPath}"]`);
  if (!nestedContainer) return;
  
  // Marquer comme "tout affich√©"
  nestedContainer.dataset.showAll = 'true';
  
  // Recharger la discussion pour afficher toutes les r√©ponses imbriqu√©es
  openDiscussionModal(type, id);
};

// Fonction pour masquer le formulaire de r√©ponse (avec support pour chemins)
window.hideReplyForm = function(postId, replyPath = null) {
  const formId = replyPath ? `reply-form-${postId}-${replyPath}` : `reply-form-${postId}`;
  const form = document.getElementById(formId);
  if (form) {
    form.style.display = 'none';
    const textareaId = replyPath ? `reply-input-${postId}-${replyPath}` : `reply-input-${postId}`;
    const textarea = document.getElementById(textareaId);
    if (textarea) textarea.value = '';
  }
};

// Fonction r√©cursive pour trouver une r√©ponse par son chemin (ex: "reply1-reply2-reply3")
function findReplyByPath(replies, pathArray, currentIndex = 0) {
  if (!replies || currentIndex >= pathArray.length) return null;
  
  const replyId = pathArray[currentIndex];
  const reply = replies.find(r => r.id === replyId);
  
  if (!reply) return null;
  
  if (currentIndex === pathArray.length - 1) {
    return reply; // On a trouv√© la r√©ponse cible
  }
  
  // Continuer la recherche dans les r√©ponses de cette r√©ponse
  return findReplyByPath(reply.replies || [], pathArray, currentIndex + 1);
}

// Fonction pour soumettre une r√©ponse √† un post (avec support pour chemins imbriqu√©s)
window.submitReply = async function(type, id, postId, replyPath = null) {
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }

  const inputId = replyPath ? `reply-input-${postId}-${replyPath}` : `reply-input-${postId}`;
  const input = document.getElementById(inputId);
  if (!input || !input.value.trim()) return;
  
  input.disabled = true;

  const reply = {
    id: Date.now().toString(),
    author: currentUser?.name || currentUser?.username || 'Utilisateur',
    avatar: currentUser?.avatar || 'üë§',
    text: input.value.trim(),
    timestamp: Date.now(),
    replies: []
  };
  
  try {
    let posts = [];
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);
    
    try {
      const resp = await fetch(`${window.API_BASE_URL}/discussions/${type}/${id}`, { signal: controller.signal });
      clearTimeout(timeoutId);
      if (resp.ok) {
        const data = await resp.json();
        posts = data.posts || [];
      }
    } catch(e) {
      clearTimeout(timeoutId);
      posts = JSON.parse(localStorage.getItem(`discussion_${type}_${id}`) || '[]');
    }
    
    const post = posts.find(p => p.id === postId);
    
    if (post) {
      if (replyPath) {
        const pathArray = replyPath.split('-');
        const parentReply = findReplyByPath(post.replies || [], pathArray);
        if (parentReply) {
          if (!parentReply.replies) parentReply.replies = [];
          parentReply.replies.push(reply);
        }
      } else {
        if (!post.replies) post.replies = [];
        post.replies.push(reply);
      }
      
      await saveDiscussionToAPI(type, id, posts);
      openDiscussionModal(type, id);
    }
  } catch(e) {
    console.error('[Discussion] Erreur reply:', e);
    showNotification("Erreur lors de l'envoi. R√©essayez.", "error");
    input.disabled = false;
    input.focus();
  }
};

// Fonction pour liker/unliker un post
window.togglePostLike = async function(type, id, postId) {
  // Charger posts depuis API
  let posts = [];
  try {
    const resp = await fetch(`${window.API_BASE_URL}/discussions/${type}/${id}`);
    if (resp.ok) {
      const data = await resp.json();
      posts = data.posts || [];
    }
  } catch(e) {
    posts = JSON.parse(localStorage.getItem(`discussion_${type}_${id}`) || '[]');
  }
  
  const post = posts.find(p => p.id === postId);
  
  if (post) {
    if (!post.likes) post.likes = [];
    const userId = currentUser?.id || currentUser?.username;
    const index = post.likes.indexOf(userId);
    
    if (index > -1) {
      post.likes.splice(index, 1);
    } else {
      post.likes.push(userId);
    }
    
    await saveDiscussionToAPI(type, id, posts);
    
    // R√©ouvrir le modal pour afficher le changement
    openDiscussionModal(type, id);
  }
};

// ============================================
// SYST√àME D'AMIS - UI COMPL√àTE
// ============================================

function openFriendsModal() {
  const esc = (typeof escapeHtml === 'function') ? escapeHtml : (s) => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  
  if (!currentUser || !currentUser.isLoggedIn) {
    openAuthModal('login');
    return;
  }
  
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  const authHeaders = token ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
  
  let backdrop = document.getElementById('popup-modal-backdrop');
  if (!backdrop) {
    backdrop = document.createElement('div');
    backdrop.id = 'popup-modal-backdrop';
    backdrop.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(2px);';
    document.body.appendChild(backdrop);
  }
  
  backdrop.style.display = 'flex';
  backdrop.innerHTML = `
    <div id="popup-modal-content" style="background:#1e293b;border-radius:20px;width:90%;max-width:500px;max-height:85vh;overflow-y:auto;position:relative;">
      <div style="padding:20px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
          <h2 style="margin:0;font-size:20px;font-weight:700;color:#fff;">üë• Mes Amis</h2>
          <button onclick="document.getElementById('popup-modal-backdrop').style.display='none'" style="background:none;border:none;color:#64748b;font-size:22px;cursor:pointer;">‚úï</button>
        </div>
        
        <!-- Recherche d'amis -->
        <div style="margin-bottom:20px;">
            <div style="display:flex;gap:8px;">
            <input id="friend-search-input" type="text" placeholder="Rechercher par nom ou email..." 
              style="flex:1;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:#0f172a;color:#e2e8f0;font-size:14px;"
              oninput="searchFriends(this.value)" />
          </div>
          <div id="friend-search-results" style="margin-top:8px;"></div>
        </div>
        
        <!-- Demandes re√ßues -->
        <div id="friend-requests-section" style="margin-bottom:20px;">
          <div style="font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px;">Demandes re√ßues</div>
          <div id="friend-requests-list" style="color:#64748b;font-size:13px;">Chargement...</div>
        </div>
        
        <!-- Liste d'amis -->
        <div>
          <div style="font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px;">Mes amis</div>
          <div id="friends-list" style="color:#64748b;font-size:13px;">Chargement...</div>
        </div>
      </div>
    </div>
  `;
  
  backdrop.onclick = (e) => { if (e.target === backdrop) backdrop.style.display = 'none'; };
  
  // Charger les donn√©es
  loadFriendRequests(authHeaders);
  loadFriendsList(authHeaders);
}

window.searchFriends = async function(query) {
  const resultsDiv = document.getElementById('friend-search-results');
  if (!resultsDiv) return;
  if (!query || query.length < 2) { resultsDiv.innerHTML = ''; return; }
  
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) { resultsDiv.innerHTML = '<div style="color:#ef4444;font-size:12px;">Connexion requise</div>'; return; }
  
  try {
    const resp = await fetch(`${window.API_BASE_URL}/friends/search?q=${encodeURIComponent(query)}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!resp.ok) throw new Error('Erreur recherche');
    const data = await resp.json();
    
    if (!data.users || data.users.length === 0) {
      resultsDiv.innerHTML = '<div style="padding:8px;color:#64748b;font-size:13px;">Aucun utilisateur trouv√©</div>';
      return;
    }
    
    resultsDiv.innerHTML = data.users.map(u => `
      <div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:rgba(15,23,42,0.5);margin-bottom:6px;">
        <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;font-weight:700;flex-shrink:0;">
          ${u.avatar ? `<img src="${u.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.outerHTML='üë§'">` : (u.username||'U').charAt(0).toUpperCase()}
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:600;font-size:14px;color:#e2e8f0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(u.username || 'Utilisateur')}</div>
        </div>
        <button onclick="sendFriendRequest('${u.id}')" style="padding:6px 14px;border-radius:8px;border:none;background:#3b82f6;color:#fff;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;">+ Ajouter</button>
      </div>
    `).join('');
  } catch(e) {
    resultsDiv.innerHTML = '<div style="color:#ef4444;font-size:12px;">Erreur de recherche</div>';
  }
};

window.sendFriendRequest = async function(toUserId) {
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) return;
  
  try {
    const resp = await fetch(`${window.API_BASE_URL}/friends/request`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ toUserId })
    });
    const data = await resp.json();
    
    if (data.status === 'accepted') {
      showNotification('Vous etes maintenant amis !', 'success');
      openFriendsModal(); // Rafraichir
    } else if (data.status === 'pending') {
      showNotification('Demande d\'ami envoyee !', 'success');
    } else if (data.error) {
      showNotification(data.error, 'warning');
    }
  } catch(e) {
    showNotification('Erreur lors de l\'envoi', 'error');
  }
};

async function loadFriendRequests(authHeaders) {
  const div = document.getElementById('friend-requests-list');
  if (!div) return;
  
  try {
    const resp = await fetch(`${window.API_BASE_URL}/friends/requests`, { headers: authHeaders });
    if (!resp.ok) throw new Error();
    const data = await resp.json();
    
    if (!data.requests || data.requests.length === 0) {
      div.innerHTML = '<div style="padding:8px;color:#64748b;font-size:13px;">Aucune demande en attente</div>';
      // Cacher la section
      const section = document.getElementById('friend-requests-section');
      if (section) section.style.display = 'none';
      return;
    }
    
    div.innerHTML = data.requests.map(r => `
      <div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);margin-bottom:6px;">
        <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;font-weight:700;flex-shrink:0;">
          ${(r.username||'U').charAt(0).toUpperCase()}
              </div>
              <div style="flex:1;">
          <div style="font-weight:600;font-size:14px;color:#e2e8f0;">${escapeHtml(r.username)}</div>
          <div style="font-size:11px;color:#64748b;">Demande d'ami</div>
                  </div>
        <button onclick="respondFriendRequest(${r.requestId},'accept')" style="padding:6px 12px;border-radius:8px;border:none;background:#22c55e;color:#fff;font-size:12px;font-weight:600;cursor:pointer;">Accepter</button>
        <button onclick="respondFriendRequest(${r.requestId},'reject')" style="padding:6px 12px;border-radius:8px;border:none;background:#ef4444;color:#fff;font-size:12px;font-weight:600;cursor:pointer;">Refuser</button>
                </div>
    `).join('');
  } catch(e) {
    div.innerHTML = '<div style="color:#ef4444;font-size:12px;">Erreur chargement</div>';
  }
}

window.respondFriendRequest = async function(requestId, action) {
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) return;
  
  try {
    await fetch(`${window.API_BASE_URL}/friends/respond`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ requestId, action })
    });
    showNotification(action === 'accept' ? 'Ami accepte !' : 'Demande refusee', action === 'accept' ? 'success' : 'info');
    openFriendsModal(); // Rafraichir
  } catch(e) {
    showNotification('Erreur', 'error');
  }
};

async function loadFriendsList(authHeaders) {
  const div = document.getElementById('friends-list');
  if (!div) return;
  
  try {
    const resp = await fetch(`${window.API_BASE_URL}/friends/list`, { headers: authHeaders });
    if (!resp.ok) throw new Error();
    const data = await resp.json();
    
    if (!data.friends || data.friends.length === 0) {
      div.innerHTML = '<div style="text-align:center;padding:30px;"><div style="font-size:48px;margin-bottom:12px;opacity:0.5;">üë•</div><div style="color:#64748b;font-size:14px;">Pas encore d\'amis</div><div style="color:#475569;font-size:12px;margin-top:4px;">Recherchez des utilisateurs ci-dessus !</div></div>';
      return;
    }
    
    // Stocker pour utiliser ailleurs (invitations)
    window._friendsList = data.friends;
    
    div.innerHTML = data.friends.map(f => `
      <div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:rgba(15,23,42,0.5);margin-bottom:6px;">
        <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff;font-weight:700;flex-shrink:0;">
          ${f.avatar ? `<img src="${f.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.outerHTML='${(f.username||'U').charAt(0).toUpperCase()}'">` : (f.username||'U').charAt(0).toUpperCase()}
              </div>
        <div style="flex:1;">
          <div style="font-weight:600;font-size:14px;color:#e2e8f0;">${escapeHtml(f.username)}</div>
          <div style="font-size:11px;color:#64748b;">Ami depuis ${f.since ? new Date(f.since).toLocaleDateString('fr-FR', {day:'numeric',month:'short',year:'numeric'}) : '...'}</div>
            </div>
        <button onclick="openPrivateChat('${f.id}','${escapeHtml(f.username)}')" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(59,130,246,0.3);background:transparent;color:#3b82f6;font-size:12px;cursor:pointer;" title="Discuter">üí¨</button>
        <button onclick="removeFriend('${f.id}')" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(239,68,68,0.3);background:transparent;color:#ef4444;font-size:12px;cursor:pointer;" title="Retirer">‚úï</button>
                </div>
    `).join('');
  } catch(e) {
    div.innerHTML = '<div style="color:#ef4444;font-size:12px;">Erreur chargement</div>';
  }
}

window.removeFriend = async function(friendId) {
  if (!confirm('Retirer cet ami ?')) return;
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) return;
  
  try {
    await fetch(`${window.API_BASE_URL}/friends/remove`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ friendId })
    });
    showNotification('Ami retire', 'info');
    openFriendsModal();
  } catch(e) {}
};

window.openPrivateChat = function(friendId, friendName) {
  showNotification('Discussion privee avec ' + friendName + ' - bientot disponible !', 'info');
};

// ============================================
// INVITER DES AMIS √Ä UN EVENT
// ============================================

function openInviteFriendsModal(itemType, itemId, itemTitle) {
  if (!currentUser || !currentUser.isLoggedIn) { openAuthModal('login'); return; }
  
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) return;
  
  // Cr√©er le modal d'invitation
  let modal = document.getElementById('invite-friends-modal');
  if (modal) modal.remove();
  
  modal = document.createElement('div');
  modal.id = 'invite-friends-modal';
  modal.style.cssText = 'position:fixed;inset:0;z-index:100001;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);';
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
  
  modal.innerHTML = `
    <div style="background:#1e293b;border-radius:18px;width:90%;max-width:420px;max-height:80vh;overflow-y:auto;padding:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div>
          <div style="font-size:16px;font-weight:700;color:#fff;">Inviter des amis</div>
          <div style="font-size:12px;color:#64748b;margin-top:2px;">${escapeHtml(itemTitle || '')}</div>
                </div>
        <button onclick="this.closest('#invite-friends-modal').remove()" style="background:none;border:none;color:#64748b;font-size:20px;cursor:pointer;">‚úï</button>
              </div>
      <input id="invite-search-input" type="text" placeholder="Chercher un ami..." 
        style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:#0f172a;color:#e2e8f0;font-size:14px;margin-bottom:12px;box-sizing:border-box;"
        oninput="filterInviteList(this.value)" />
      <div id="invite-friends-list" style="color:#64748b;">Chargement...</div>
            </div>
  `;
  document.body.appendChild(modal);
  
  // Charger la liste d'amis
  fetch(`${window.API_BASE_URL}/friends/list`, {
    headers: { 'Authorization': `Bearer ${token}` }
  }).then(r => r.json()).then(data => {
    const listDiv = document.getElementById('invite-friends-list');
    if (!listDiv) return;
    
    const friends = data.friends || [];
    if (friends.length === 0) {
      listDiv.innerHTML = '<div style="text-align:center;padding:20px;color:#64748b;">Pas encore d\'amis a inviter</div>';
      return;
    }
    
    window._inviteFriends = friends;
    renderInviteList(friends, itemType, itemId);
  }).catch(() => {
    const listDiv = document.getElementById('invite-friends-list');
    if (listDiv) listDiv.innerHTML = '<div style="color:#ef4444;">Erreur chargement</div>';
  });
}

window.filterInviteList = function(query) {
  if (!window._inviteFriends) return;
  const filtered = query.length < 1 ? window._inviteFriends : window._inviteFriends.filter(f => 
    (f.username||'').toLowerCase().includes(query.toLowerCase()) ||
    (f.email||'').toLowerCase().includes(query.toLowerCase())
  );
  const itemType = window._currentInviteType || 'event';
  const itemId = window._currentInviteId || 0;
  renderInviteList(filtered, itemType, itemId);
};

function renderInviteList(friends, itemType, itemId) {
  window._currentInviteType = itemType;
  window._currentInviteId = itemId;
  const listDiv = document.getElementById('invite-friends-list');
  if (!listDiv) return;
  
  listDiv.innerHTML = friends.map(f => `
    <div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:rgba(15,23,42,0.5);margin-bottom:6px;">
      <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;font-weight:700;flex-shrink:0;">
        ${(f.username||'U').charAt(0).toUpperCase()}
              </div>
      <div style="flex:1;font-weight:600;font-size:14px;color:#e2e8f0;">${escapeHtml(f.username)}</div>
      <button onclick="inviteFriendToEvent('${f.id}','${itemType}',${itemId})" style="padding:6px 14px;border-radius:8px;border:none;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;font-size:12px;font-weight:600;cursor:pointer;">Inviter</button>
    </div>
  `).join('');
}

window.inviteFriendToEvent = async function(friendId, itemType, itemId) {
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) return;
  
  try {
    const resp = await fetch(`${window.API_BASE_URL}/friends/invite`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ friendId, itemType, itemId })
    });
    if (resp.ok) {
      showNotification('Invitation envoyee !', 'success');
    } else {
      const data = await resp.json();
      showNotification(data.error || 'Erreur', 'error');
    }
  } catch(e) {
    showNotification('Erreur d\'envoi', 'error');
  }
};

window.openInviteFriendsModal = openInviteFriendsModal;
window.openFriendsModal = openFriendsModal;

// ============================================
// NOTIFICATIONS - UI
// ============================================

async function openNotificationsModal() {
  if (!currentUser || !currentUser.isLoggedIn) { openAuthModal('login'); return; }
  
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) return;
  
  let backdrop = document.getElementById('popup-modal-backdrop');
  if (!backdrop) {
    backdrop = document.createElement('div');
    backdrop.id = 'popup-modal-backdrop';
    backdrop.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(2px);';
    document.body.appendChild(backdrop);
  }
  backdrop.style.display = 'flex';
  backdrop.onclick = (e) => { if (e.target === backdrop) backdrop.style.display = 'none'; };
  
  backdrop.innerHTML = `
    <div id="popup-modal-content" style="background:#1e293b;border-radius:20px;width:90%;max-width:500px;max-height:85vh;overflow-y:auto;padding:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <h2 style="margin:0;font-size:20px;font-weight:700;color:#fff;">üîî Notifications</h2>
        <div style="display:flex;gap:8px;align-items:center;">
          <button onclick="markAllNotificationsRead()" style="padding:6px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:#64748b;font-size:11px;cursor:pointer;">Tout lire</button>
          <button onclick="document.getElementById('popup-modal-backdrop').style.display='none'" style="background:none;border:none;color:#64748b;font-size:22px;cursor:pointer;">‚úï</button>
        </div>
      </div>
      <div id="notifications-list" style="color:#64748b;">Chargement...</div>
          </div>
        `;
  
  try {
    const resp = await fetch(`${window.API_BASE_URL}/notifications`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!resp.ok) throw new Error();
    const data = await resp.json();
    const listDiv = document.getElementById('notifications-list');
    if (!listDiv) return;
    
    if (!data.notifications || data.notifications.length === 0) {
      listDiv.innerHTML = '<div style="text-align:center;padding:40px;"><div style="font-size:48px;margin-bottom:12px;opacity:0.5;">üîî</div><div style="color:#64748b;">Aucune notification</div></div>';
      return;
    }
    
    const typeIcons = { 'friend_request': 'üë•', 'friend_accepted': 'ü§ù', 'event_invite': 'üìÖ', 'social_like': '‚ù§Ô∏è', 'social_comment': 'üí¨' };
    const typeLabels = { 'friend_request': 'Demande d\'ami', 'friend_accepted': 'Ami accepte', 'event_invite': 'Invitation event', 'social_like': 'A aime votre post', 'social_comment': 'A commente' };
    
    listDiv.innerHTML = data.notifications.map(n => `
      <div style="display:flex;gap:12px;padding:12px;border-radius:12px;background:${n.isRead ? 'transparent' : 'rgba(59,130,246,0.08)'};border:1px solid ${n.isRead ? 'rgba(255,255,255,0.05)' : 'rgba(59,130,246,0.15)'};margin-bottom:8px;cursor:pointer;" onclick="markNotificationRead(${n.id})">
        <div style="width:40px;height:40px;border-radius:50%;background:rgba(59,130,246,0.15);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">
          ${typeIcons[n.type] || 'üîî'}
        </div>
        <div style="flex:1;">
          <div style="font-size:14px;color:#e2e8f0;"><strong>${escapeHtml(n.fromUsername)}</strong> ${typeLabels[n.type] || n.message || ''}</div>
          <div style="font-size:11px;color:#64748b;margin-top:4px;">${n.date ? new Date(n.date).toLocaleDateString('fr-FR', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}) : ''}</div>
        </div>
        ${!n.isRead ? '<div style="width:8px;height:8px;border-radius:50%;background:#3b82f6;flex-shrink:0;align-self:center;"></div>' : ''}
      </div>
    `).join('');
  } catch(e) {
    const listDiv = document.getElementById('notifications-list');
    if (listDiv) listDiv.innerHTML = '<div style="color:#ef4444;">Erreur chargement notifications</div>';
  }
}

window.markNotificationRead = async function(notifId) {
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) return;
  try {
    await fetch(`${window.API_BASE_URL}/notifications/read`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ notificationId: notifId })
    });
  } catch(e) {}
};

window.markAllNotificationsRead = async function() {
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) return;
  try {
    await fetch(`${window.API_BASE_URL}/notifications/read`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    showNotification('Toutes les notifications marquees comme lues', 'success');
    openNotificationsModal();
  } catch(e) {}
};

window.openNotificationsModal = openNotificationsModal;

// ============================================
// MAP FRIEND - FIL SOCIAL TYPE FACEBOOK
// ============================================

async function openMapFriendModal() {
  if (!currentUser || !currentUser.isLoggedIn) { openAuthModal('login'); return; }
  
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) return;
  
  let backdrop = document.getElementById('popup-modal-backdrop');
  if (!backdrop) {
    backdrop = document.createElement('div');
    backdrop.id = 'popup-modal-backdrop';
    backdrop.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(2px);';
    document.body.appendChild(backdrop);
  }
  backdrop.style.display = 'flex';
  backdrop.onclick = (e) => { if (e.target === backdrop) backdrop.style.display = 'none'; };
  
  backdrop.innerHTML = `
    <div id="popup-modal-content" style="background:var(--ui-card-bg, #0f172a);border-radius:20px;width:95%;max-width:550px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;">
      <!-- Header -->
      <div style="padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="font-size:22px;">üåê</span>
          <span style="font-size:18px;font-weight:700;color:#e4e6eb;">Map Friend</span>
        </div>
        <button onclick="document.getElementById('popup-modal-backdrop').style.display='none'" style="background:none;border:none;color:#b0b3b8;font-size:22px;cursor:pointer;">‚úï</button>
      </div>
      
      <!-- Zone de creation de post -->
      <div style="padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.1);flex-shrink:0;">
        <div style="display:flex;gap:10px;align-items:flex-start;">
          <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff;font-weight:700;flex-shrink:0;">
            ${(currentUser.username||'U').charAt(0).toUpperCase()}
              </div>
              <div style="flex:1;">
            <textarea id="social-post-input" placeholder="Quoi de neuf ? Partagez un event, un lien, un message..." 
              style="width:100%;min-height:60px;max-height:150px;padding:10px 14px;border-radius:14px;border:none;background:#3a3b3c;color:#e4e6eb;font-size:15px;resize:none;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;box-sizing:border-box;"
              oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,150)+'px';"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
              <button onclick="showShareEventPicker()" style="padding:6px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:#45bd62;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:4px;">üìÖ Event</button>
              <button onclick="addLinkToPost()" style="padding:6px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:#3b82f6;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:4px;">üîó Lien</button>
              <div style="flex:1;"></div>
              <button onclick="submitSocialPost()" style="padding:8px 20px;border-radius:10px;border:none;background:#1877f2;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Publier</button>
              </div>
            </div>
                  </div>
                  </div>
      
      <!-- Fil social -->
      <div id="social-feed" style="flex:1;overflow-y:auto;padding:12px 20px;">
        <div style="text-align:center;padding:20px;color:#b0b3b8;">Chargement du fil...</div>
              </div>
            </div>
  `;
  
  // Charger le fil social
  loadSocialFeed(token);
}

async function loadSocialFeed(token, page = 1) {
  const feedDiv = document.getElementById('social-feed');
  if (!feedDiv) return;
  
  try {
    const resp = await fetch(`${window.API_BASE_URL}/social/feed?page=${page}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!resp.ok) throw new Error();
    const data = await resp.json();
    
    if (!data.posts || data.posts.length === 0) {
      feedDiv.innerHTML = `
        <div style="text-align:center;padding:60px 20px;">
          <div style="font-size:64px;margin-bottom:16px;opacity:0.5;">üåê</div>
          <div style="font-size:18px;font-weight:700;color:#e4e6eb;margin-bottom:8px;">Bienvenue sur Map Friend !</div>
          <div style="font-size:14px;color:#b0b3b8;max-width:300px;margin:0 auto;">Ajoutez des amis et partagez vos evenements, liens et messages. Tout le monde peut voir et repondre !</div>
                </div>
      `;
      return;
    }
    
    const userId = String(currentUser.id || '');
    
    feedDiv.innerHTML = data.posts.map(p => {
      const isLiked = (p.likes || []).includes(userId);
      const likesCount = (p.likes || []).length;
      const isOwn = p.userId === userId;
      const timeStr = p.date ? formatSocialTime(p.date) : '';
      
      // Contenu de l'event partag√© si pr√©sent
      const eventCard = p.eventId && p.eventTitle ? `
        <div style="margin:8px 0;padding:12px;border-radius:12px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.15);cursor:pointer;" onclick="openEventById(${p.eventId})">
          <div style="font-size:14px;font-weight:600;color:#e4e6eb;">üìÖ ${escapeHtml(p.eventTitle)}</div>
          ${p.eventDate ? `<div style="font-size:12px;color:#b0b3b8;margin-top:4px;">${p.eventDate}${p.eventCity ? ' - ' + escapeHtml(p.eventCity) : ''}</div>` : ''}
                </div>
      ` : '';
      
      const linkCard = p.linkUrl ? `
        <div style="margin:8px 0;padding:12px;border-radius:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);">
          <a href="${p.linkUrl}" target="_blank" rel="noopener" style="color:#3b82f6;font-size:13px;word-break:break-all;">${escapeHtml(p.linkTitle || p.linkUrl)}</a>
              </div>
      ` : '';
      
      return `
        <div style="background:rgba(15,23,42,0.6);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:14px;margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff;font-weight:700;flex-shrink:0;">
              ${p.avatar ? `<img src="${p.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.outerHTML='${(p.username||'U').charAt(0).toUpperCase()}'">` : (p.username||'U').charAt(0).toUpperCase()}
            </div>
            <div style="flex:1;">
              <div style="font-weight:600;font-size:15px;color:#e4e6eb;">${escapeHtml(p.username)}</div>
              <div style="font-size:12px;color:#b0b3b8;">${timeStr}</div>
              </div>
            ${isOwn ? `<button onclick="deleteSocialPost(${p.id})" style="background:none;border:none;color:#64748b;font-size:16px;cursor:pointer;" title="Supprimer">üóëÔ∏è</button>` : ''}
          </div>
          ${p.content ? `<div style="font-size:15px;color:#e4e6eb;line-height:1.4;margin-bottom:8px;white-space:pre-wrap;word-break:break-word;">${escapeHtml(p.content)}</div>` : ''}
          ${eventCard}
          ${linkCard}
          
          <!-- Actions -->
          <div style="display:flex;align-items:center;gap:4px;padding:4px 0;margin-top:4px;border-top:1px solid rgba(255,255,255,0.08);">
            <button onclick="toggleSocialLike(${p.id})" style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;background:none;border:none;color:${isLiked ? '#1877f2' : '#b0b3b8'};font-size:14px;font-weight:600;cursor:pointer;padding:8px;border-radius:6px;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='none'">
              <span>üëç</span> <span>J'aime${likesCount > 0 ? ' (' + likesCount + ')' : ''}</span>
            </button>
            <button onclick="openSocialComments(${p.id})" style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;background:none;border:none;color:#b0b3b8;font-size:14px;font-weight:600;cursor:pointer;padding:8px;border-radius:6px;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='none'">
              <span>üí¨</span> <span>Commenter${p.commentCount > 0 ? ' (' + p.commentCount + ')' : ''}</span>
            </button>
          </div>
          
          <!-- Zone commentaires (cach√©e par d√©faut) -->
          <div id="social-comments-${p.id}" style="display:none;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.05);"></div>
          </div>
        `;
    }).join('');
  } catch(e) {
    feedDiv.innerHTML = '<div style="text-align:center;padding:20px;color:#ef4444;">Erreur de chargement du fil social</div>';
  }
}

function formatSocialTime(dateStr) {
  const date = new Date(dateStr);
  const now = new Date();
  const diff = now - date;
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'A l\'instant';
  if (mins < 60) return `Il y a ${mins} min`;
  const hours = Math.floor(diff / 3600000);
  if (hours < 24) return `Il y a ${hours}h`;
  const days = Math.floor(diff / 86400000);
  if (days < 7) return `Il y a ${days}j`;
  return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
}

window.submitSocialPost = async function() {
  const input = document.getElementById('social-post-input');
  if (!input || !input.value.trim()) { showNotification('Ecrivez quelque chose !', 'warning'); return; }
  
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) return;
  
  const content = input.value.trim();
  const eventId = window._socialPostEventId || null;
  const linkUrl = window._socialPostLinkUrl || null;
  const linkTitle = window._socialPostLinkTitle || null;
  
  try {
    const resp = await fetch(`${window.API_BASE_URL}/social/post`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ content, eventId, linkUrl, linkTitle, type: eventId ? 'event_share' : linkUrl ? 'link' : 'text' })
    });
    if (resp.ok) {
      input.value = '';
      window._socialPostEventId = null;
      window._socialPostLinkUrl = null;
      window._socialPostLinkTitle = null;
      showNotification('Publication partagee !', 'success');
      loadSocialFeed(token);
    }
  } catch(e) {
    showNotification('Erreur de publication', 'error');
  }
};

window.toggleSocialLike = async function(postId) {
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) return;
  
  try {
    await fetch(`${window.API_BASE_URL}/social/post/${postId}/like`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    loadSocialFeed(token);
  } catch(e) {}
};

window.deleteSocialPost = async function(postId) {
  if (!confirm('Supprimer cette publication ?')) return;
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) return;
  
  try {
    await fetch(`${window.API_BASE_URL}/social/post/${postId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    showNotification('Publication supprimee', 'info');
    loadSocialFeed(token);
  } catch(e) {}
};

window.openSocialComments = async function(postId) {
  const commentsDiv = document.getElementById(`social-comments-${postId}`);
  if (!commentsDiv) return;
  
  // Toggle visibilit√©
  if (commentsDiv.style.display === 'block') {
    commentsDiv.style.display = 'none';
    return;
  }
  commentsDiv.style.display = 'block';
  commentsDiv.innerHTML = '<div style="padding:8px;color:#64748b;font-size:13px;">Chargement...</div>';
  
  try {
    const resp = await fetch(`${window.API_BASE_URL}/social/post/${postId}/comments`);
    if (!resp.ok) throw new Error();
    const data = await resp.json();
    
    const comments = data.comments || [];
    const userId = String(currentUser.id || '');
    
    commentsDiv.innerHTML = `
      ${comments.map(c => `
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;font-weight:700;flex-shrink:0;">
            ${(c.username||'U').charAt(0).toUpperCase()}
          </div>
          <div style="flex:1;">
            <div style="background:#3a3b3c;border-radius:14px;padding:8px 12px;">
              <span style="font-weight:600;font-size:13px;color:#e4e6eb;">${escapeHtml(c.username)}</span>
              <span style="font-size:13px;color:#e4e6eb;"> ${escapeHtml(c.content)}</span>
            </div>
            <div style="font-size:11px;color:#b0b3b8;margin-top:2px;margin-left:12px;">${c.date ? formatSocialTime(c.date) : ''}</div>
          </div>
        </div>
      `).join('')}
      <div style="display:flex;gap:8px;margin-top:8px;">
        <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;font-weight:700;flex-shrink:0;">
          ${(currentUser.username||'U').charAt(0).toUpperCase()}
        </div>
        <div style="flex:1;">
          <textarea id="social-comment-input-${postId}" placeholder="Ecrire un commentaire..." 
            style="width:100%;min-height:32px;padding:8px 12px;border-radius:18px;border:none;background:#3a3b3c;color:#e4e6eb;font-size:13px;resize:none;box-sizing:border-box;"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();submitSocialComment(${postId});}"></textarea>
        </div>
          </div>
        `;
  } catch(e) {
    commentsDiv.innerHTML = '<div style="color:#ef4444;font-size:12px;">Erreur</div>';
  }
};

window.submitSocialComment = async function(postId) {
  const input = document.getElementById(`social-comment-input-${postId}`);
  if (!input || !input.value.trim()) return;
  
  const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
  if (!token) return;
  
  try {
    const resp = await fetch(`${window.API_BASE_URL}/social/post/${postId}/comment`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: input.value.trim() })
    });
    if (resp.ok) {
      input.value = '';
      openSocialComments(postId); // Rafraichir
    }
  } catch(e) {}
};

window.showShareEventPicker = function() {
  // Afficher un mini-picker d'events de l'agenda
  const agendaItems = (currentUser.agenda || []).map(key => {
    const [type, id] = key.split(':');
    if (type !== 'event') return null;
    const ev = eventsData.find(e => e.id === parseInt(id));
    return ev;
  }).filter(Boolean);
  
  if (agendaItems.length === 0) {
    showNotification('Ajoutez d\'abord des events a votre agenda !', 'info');
    return;
  }
  
  let picker = document.getElementById('event-share-picker');
  if (picker) { picker.remove(); return; }
  
  picker = document.createElement('div');
  picker.id = 'event-share-picker';
  picker.style.cssText = 'position:fixed;bottom:200px;left:50%;transform:translateX(-50%);width:90%;max-width:400px;max-height:250px;overflow-y:auto;background:#2d2d30;border-radius:14px;border:1px solid rgba(255,255,255,0.1);z-index:100002;padding:8px;box-shadow:0 8px 32px rgba(0,0,0,0.5);';
  
  picker.innerHTML = `
    <div style="font-size:12px;color:#94a3b8;padding:8px;font-weight:600;">Choisir un event a partager :</div>
    ${agendaItems.map(ev => `
      <div onclick="selectEventForShare(${ev.id},'${escapeHtml(ev.title||'')}')" style="padding:10px;border-radius:8px;cursor:pointer;color:#e4e6eb;font-size:13px;" onmouseover="this.style.background='rgba(59,130,246,0.1)'" onmouseout="this.style.background='none'">
        üìÖ ${escapeHtml(ev.title || 'Sans titre')} ${ev.city ? '- ' + escapeHtml(ev.city) : ''}
      </div>
    `).join('')}
  `;
  document.body.appendChild(picker);
};

window.selectEventForShare = function(eventId, title) {
  window._socialPostEventId = eventId;
  const picker = document.getElementById('event-share-picker');
  if (picker) picker.remove();
  const input = document.getElementById('social-post-input');
  if (input && !input.value.includes(title)) {
    input.value = (input.value ? input.value + '\n' : '') + 'üìÖ ' + title;
  }
  showNotification('Event ajoute au post !', 'success');
};

window.addLinkToPost = function() {
  const url = prompt('Collez votre lien :');
  if (!url) return;
  window._socialPostLinkUrl = url;
  window._socialPostLinkTitle = url;
  const input = document.getElementById('social-post-input');
  if (input && !input.value.includes(url)) {
    input.value = (input.value ? input.value + '\n' : '') + 'üîó ' + url;
  }
  showNotification('Lien ajoute !', 'success');
};

window.openEventById = function(eventId) {
  const ev = eventsData.find(e => e.id === eventId);
  if (ev) {
    const html = buildEventPopup(ev);
    openPopupModal(html, ev);
  }
};

window.openMapFriendModal = openMapFriendModal;

function openReportModal(type, id, parentType = null, parentId = null) {
  // D√©terminer le type d'affichage
  const typeLabels = {
    'event': '√©v√©nement',
    'booking': 'booking',
    'service': 'service',
    'message': 'message',
    'discussion': 'discussion',
    'review': 'avis',
    'user': 'utilisateur',
    'comment': 'commentaire'
  };
  
  const typeLabel = typeLabels[type] || type;
  
  const html = `
    <div style="padding:20px;max-width:500px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:48px;margin-bottom:8px;">üö®</div>
        <h2 style="margin:0;font-size:20px;font-weight:700;color:#fff;">Signaler un probl√®me</h2>
        <p style="color:var(--ui-text-muted);margin-top:8px;font-size:13px;">Vous signalez un ${typeLabel}</p>
      </div>
      
      <div style="margin-bottom:20px;">
        <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:12px;">Raison du signalement *</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <label style="display:flex;align-items:center;gap:10px;padding:12px;border-radius:8px;border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;background:rgba(15,23,42,0.5);" 
                 onmouseover="this.style.background='rgba(239,68,68,0.1)';this.style.borderColor='rgba(239,68,68,0.5)'" 
                 onmouseout="this.style.background='rgba(15,23,42,0.5)';this.style.borderColor='var(--ui-card-border)'">
            <input type="radio" name="report-reason" value="inappropriate" style="cursor:pointer;">
            <span style="flex:1;color:#fff;">Contenu inappropri√©</span>
          </label>
          <label style="display:flex;align-items:center;gap:10px;padding:12px;border-radius:8px;border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;background:rgba(15,23,42,0.5);" 
                 onmouseover="this.style.background='rgba(239,68,68,0.1)';this.style.borderColor='rgba(239,68,68,0.5)'" 
                 onmouseout="this.style.background='rgba(15,23,42,0.5)';this.style.borderColor='var(--ui-card-border)'">
            <input type="radio" name="report-reason" value="fake" style="cursor:pointer;">
            <span style="flex:1;color:#fff;">Information fausse / Arnaque</span>
          </label>
          <label style="display:flex;align-items:center;gap:10px;padding:12px;border-radius:8px;border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;background:rgba(15,23,42,0.5);" 
                 onmouseover="this.style.background='rgba(239,68,68,0.1)';this.style.borderColor='rgba(239,68,68,0.5)'" 
                 onmouseout="this.style.background='rgba(15,23,42,0.5)';this.style.borderColor='var(--ui-card-border)'">
            <input type="radio" name="report-reason" value="offensive" style="cursor:pointer;">
            <span style="flex:1;color:#fff;">Image offensante / Contenu -16 ans</span>
          </label>
          <label style="display:flex;align-items:center;gap:10px;padding:12px;border-radius:8px;border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;background:rgba(15,23,42,0.5);" 
                 onmouseover="this.style.background='rgba(239,68,68,0.1)';this.style.borderColor='rgba(239,68,68,0.5)'" 
                 onmouseout="this.style.background='rgba(15,23,42,0.5)';this.style.borderColor='var(--ui-card-border)'">
            <input type="radio" name="report-reason" value="spam" style="cursor:pointer;">
            <span style="flex:1;color:#fff;">Spam / Publicit√©</span>
          </label>
          <label style="display:flex;align-items:center;gap:10px;padding:12px;border-radius:8px;border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;background:rgba(15,23,42,0.5);" 
                 onmouseover="this.style.background='rgba(239,68,68,0.1)';this.style.borderColor='rgba(239,68,68,0.5)'" 
                 onmouseout="this.style.background='rgba(15,23,42,0.5)';this.style.borderColor='var(--ui-card-border)'">
            <input type="radio" name="report-reason" value="harassment" style="cursor:pointer;">
            <span style="flex:1;color:#fff;">Harc√®lement / Intimidation</span>
          </label>
          <label style="display:flex;align-items:center;gap:10px;padding:12px;border-radius:8px;border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;background:rgba(15,23,42,0.5);" 
                 onmouseover="this.style.background='rgba(239,68,68,0.1)';this.style.borderColor='rgba(239,68,68,0.5)'" 
                 onmouseout="this.style.background='rgba(15,23,42,0.5)';this.style.borderColor='var(--ui-card-border)'">
            <input type="radio" name="report-reason" value="other" style="cursor:pointer;">
            <span style="flex:1;color:#fff;">Autre</span>
          </label>
        </div>
      </div>
      
      <div style="margin-bottom:20px;">
        <label style="display:block;font-size:13px;font-weight:600;color:#fff;margin-bottom:8px;">D√©tails suppl√©mentaires (optionnel)</label>
        <textarea id="report-details" placeholder="D√©crivez le probl√®me en d√©tail..." rows="4" 
                  style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);resize:none;font-size:14px;font-family:inherit;"></textarea>
      </div>
      
      <div style="display:flex;gap:12px;">
        <button onclick="closePublishModal()" style="flex:1;padding:12px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-weight:600;">
          Annuler
        </button>
        <button onclick="submitReport('${type}', '${id}', '${parentType || ''}', '${parentId || ''}')" 
                style="flex:1;padding:12px;border-radius:999px;border:none;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;font-weight:700;cursor:pointer;">
          üö® Signaler
        </button>
      </div>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
}

async function submitReport(type, id, parentType = null, parentId = null) {
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  const reason = document.querySelector('input[name="report-reason"]:checked');
  if (!reason) {
    showNotification("‚ö†Ô∏è Veuillez s√©lectionner une raison", "warning");
    return;
  }
  
  const details = document.getElementById('report-details')?.value.trim() || '';
  
  // R√©cup√©rer les infos de l'item signal√©
  let itemInfo = "";
  if (type === "event") {
    const ev = eventsData.find(e => e.id == id);
    itemInfo = ev ? `${ev.title} (${ev.city || 'N/A'})` : `Event #${id}`;
  } else if (type === "booking") {
    const b = bookingsData.find(b => b.id == id);
    itemInfo = b ? `${b.name} (${b.city || 'N/A'})` : `Booking #${id}`;
  } else if (type === "service") {
    const s = servicesData.find(s => s.id == id);
    itemInfo = s ? `${s.name} (${s.city || 'N/A'})` : `Service #${id}`;
  } else {
    itemInfo = `${type} #${id}`;
  }
  
  const reportData = {
    userId: currentUser.id ? currentUser.id.toString() : 'anonymous',
    userEmail: currentUser.email || 'N/A',
    userName: currentUser.name || 'Anonyme',
    itemType: type,
    itemId: id.toString(),
    itemInfo: itemInfo,
    parentType: parentType || null,
    parentId: parentId || null,
    reason: reason.value,
    details: details,
    reportedAt: new Date().toISOString(),
    notifyEmail: MAPEVENT_CONTACT_EMAIL // Email de destination pour les alertes
  };
  
  try {
    // Sauvegarder dans le backend
    const response = await fetch(`${window.API_BASE_URL}/user/reports`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(reportData)
    });
    
    if (response.ok) {
      showNotification("üö® Signalement envoy√© ! Notre √©quipe va examiner ce contenu rapidement.", "success");
      closePublishModal();
    } else {
      throw new Error('Erreur serveur');
    }
  } catch (error) {
    console.error('Erreur signalement:', error);
    // Fallback : sauvegarder localement ET afficher un message avec l'email
    if (!window.moderationQueue) window.moderationQueue = [];
    window.moderationQueue.push(reportData);
    
    // Sauvegarder dans localStorage aussi
    try {
      const existingReports = JSON.parse(localStorage.getItem('pendingReports') || '[]');
      existingReports.push(reportData);
      localStorage.setItem('pendingReports', JSON.stringify(existingReports));
    } catch (e) {
      console.error('Erreur sauvegarde locale:', e);
    }
    
    showNotification(`üö® Signalement enregistr√©. En cas d'urgence, contactez : ${MAPEVENT_CONTACT_EMAIL}`, "success");
    closePublishModal();
  }
}

function openPaymentModal(type, id, action) {
  const item = type === "booking" ? bookingsData.find(b => b.id === id) : servicesData.find(s => s.id === id);
  const itemName = item ? (item.name || item.title || `Contact ${type}`) : "Contact";
  
  const html = `
    <div style="padding:10px;text-align:center;">
      <div style="font-size:48px;margin-bottom:16px;">üí≥</div>
      <h2 style="margin:0 0 10px;font-size:18px;">Obtenir le contact</h2>
      <p style="color:var(--ui-text-muted);margin-bottom:8px;font-size:13px;">${escapeHtml(itemName)}</p>
      <p style="color:var(--ui-text-muted);margin-bottom:20px;font-size:12px;">Choisissez votre option :</p>
      
      <div style="display:grid;gap:10px;margin-bottom:16px;">
        <button onclick="processContactPayment('${type}', ${id})" style="padding:14px;border-radius:12px;border:2px solid #00ffc3;background:rgba(0,255,195,0.1);color:#00ffc3;font-weight:700;cursor:pointer;text-align:left;display:flex;justify-content:space-between;align-items:center;">
          <span>üí≥ Payer CHF 1.‚Äì</span>
          <span style="font-size:12px;color:var(--ui-text-muted);">Imm√©diat</span>
        </button>
        
        <button onclick="openSubscriptionModal()" style="padding:14px;border-radius:12px;border:2px solid #8b5cf6;background:rgba(139,92,246,0.1);color:#a78bfa;font-weight:700;cursor:pointer;text-align:left;display:flex;justify-content:space-between;align-items:center;">
          <span>üíé Voir les abonnements</span>
          <span style="font-size:12px;color:var(--ui-text-muted);">√Ä partir de 5.‚Äì/mois</span>
        </button>
        
        <button onclick="addToCart('${type}', ${id})" style="padding:14px;border-radius:12px;border:2px solid #f59e0b;background:rgba(245,158,11,0.1);color:#f59e0b;font-weight:700;cursor:pointer;text-align:left;display:flex;justify-content:space-between;align-items:center;">
          <span>üõí Ajouter au panier</span>
          <span style="font-size:12px;color:var(--ui-text-muted);">Payer plus tard</span>
        </button>
      </div>
      
      <button onclick="closePublishModal()" style="width:100%;padding:10px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;">
        Annuler
      </button>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
}

// Son de paiement
function playPaymentSound() {
  try {
    const audio = new Audio('/assets/popopo.m4a');
    audio.volume = 0.7;
    audio.play().catch(e => {
      console.log("Son de paiement non disponible", e);
    });
  } catch (e) {
    console.log("Son de paiement non disponible", e);
  }
}

function addToCart(type, id) {
  const key = `${type}:${id}`;
  
  // V√©rifier si d√©j√† dans le panier
  if (cart.some(item => item.key === key)) {
    showNotification("‚ö†Ô∏è D√©j√† dans le panier", "warning");
    return;
  }
  
  // Trouver l'item
  const data = type === "booking" ? bookingsData : servicesData;
  const item = data.find(i => i.id === id);
  
  if (item) {
    cart.push({
      key,
      type,
      id,
      name: item.name || item.title || `Contact ${type}`,
      price: 1.0
    });
    
    updateCartCount();
    showNotification(`üõí ${item.name || item.title} ajout√© au panier !`, "success");
    closePublishModal();
  }
}

function removeFromCart(key) {
  cart = cart.filter(item => item.key !== key);
  updateCartCount();
  showNotification("üóëÔ∏è Retir√© du panier", "info");
  openCartModal(); // Rafra√Æchir
}

function updateCartCount() {
  const cartCount = document.getElementById("cart-count");
  if (cartCount) {
    if (cart.length > 0) {
      cartCount.textContent = cart.length;
      cartCount.style.display = "flex";
    } else {
      cartCount.style.display = "none";
    }
  }
}

function openCartModal() {
  if (cart.length === 0) {
    const html = `
      <div style="padding:20px;text-align:center;">
        <div style="font-size:64px;margin-bottom:16px;">üõí</div>
        <h2 style="margin:0 0 10px;font-size:18px;">Votre panier est vide</h2>
        <p style="color:var(--ui-text-muted);margin-bottom:20px;">Ajoutez des contacts depuis les popups !</p>
        <button onclick="closePublishModal()" style="padding:10px 20px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;">
          Fermer
        </button>
      </div>
    `;
    document.getElementById("publish-modal-inner").innerHTML = html;
    const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
    return;
  }
  
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  
  const html = `
    <div style="padding:10px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 style="margin:0;font-size:18px;">üõí Mon Panier</h2>
        <button onclick="closePublishModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--ui-text-muted);">‚úï</button>
      </div>
      
      <div style="max-height:300px;overflow-y:auto;margin-bottom:16px;">
        ${cart.map(item => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(15,23,42,0.5);border-radius:8px;margin-bottom:8px;border:1px solid var(--ui-card-border);">
            <div style="flex:1;">
              <div style="font-weight:600;margin-bottom:4px;">${escapeHtml(item.name)}</div>
              <div style="font-size:11px;color:var(--ui-text-muted);">${item.type === 'booking' ? 'üé§ Booking' : 'üîß Service'}</div>
            </div>
            <div style="text-align:right;margin-right:12px;">
              <div style="font-weight:700;color:#00ffc3;">CHF ${item.price.toFixed(2)}</div>
            </div>
            <button onclick="removeFromCart('${item.key}')" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:18px;padding:4px;">üóëÔ∏è</button>
          </div>
        `).join('')}
      </div>
      
      <div style="padding:12px;background:rgba(0,255,195,0.1);border:1px solid rgba(0,255,195,0.3);border-radius:12px;margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span style="font-weight:700;font-size:16px;">Total</span>
          <span style="font-weight:800;font-size:20px;color:#00ffc3;">CHF ${total.toFixed(2)}</span>
        </div>
        <div style="font-size:11px;color:var(--ui-text-muted);text-align:center;">${cart.length} contact(s)</div>
      </div>
      
      <div style="display:grid;gap:10px;margin-bottom:12px;">
        <button onclick="checkoutCart()" style="width:100%;padding:14px;border-radius:999px;border:none;background:var(--btn-main-bg);color:var(--btn-main-text);font-weight:700;cursor:pointer;font-size:16px;">
          üí≥ Payer ${total.toFixed(2)} CHF
        </button>
        
        <button onclick="openSubscriptionModal()" style="width:100%;padding:12px;border-radius:999px;border:2px solid #8b5cf6;background:rgba(139,92,246,0.1);color:#a78bfa;font-weight:600;cursor:pointer;">
          üíé Voir les abonnements (√©conomisez !)
        </button>
        
        <button onclick="openEcoMissionModal()" style="width:100%;padding:12px;border-radius:999px;border:2px solid #22c55e;background:rgba(34,197,94,0.1);color:#22c55e;font-weight:600;cursor:pointer;">
          üåç Faire un don pour la plan√®te
        </button>
      </div>
      
      <button onclick="closePublishModal()" style="width:100%;padding:10px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;">
        Continuer mes achats
      </button>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
}

async function processCartCheckout() {
  if (cart.length === 0) return;
  
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  const count = cart.length;
  
  try {
    showNotification("üí≥ Redirection vers le paiement...", "info");
    
    // Cr√©er une session Stripe Checkout
    const response = await fetch(`${window.API_BASE_URL}/payments/create-checkout-session`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id.toString(),
        paymentType: 'cart',
        items: cart.map(item => ({
          type: item.type,
          id: item.id,
          price: item.price
        })),
        amount: total,
        currency: 'CHF',
        email: currentUser.email
      })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Erreur lors de la cr√©ation de la session');
    }
    
    const { sessionId, publicKey } = await response.json();
    
    // Initialiser Stripe si pas encore fait
    if (!stripe && publicKey) {
      initStripe(publicKey);
    }
    
    if (!stripe) {
      throw new Error('Stripe non disponible');
    }
    
    // Rediriger vers Stripe Checkout
    const result = await stripe.redirectToCheckout({ sessionId });
    
    if (result.error) {
      showNotification(`‚ùå Erreur : ${result.error.message}`, "error");
    }
  } catch (error) {
    console.error('Erreur checkout:', error);
    showNotification(`‚ùå Erreur lors du paiement : ${error.message}`, "error");
  }
}

// Fonction de compatibilit√© (fallback si Stripe √©choue)
function checkoutCart() {
  processCartCheckout().catch(() => {
    // Fallback : simulation locale si l'API √©choue
    const total = cart.reduce((sum, item) => sum + item.price, 0);
    const count = cart.length;
    cart.forEach(item => {
      if (!paidContacts.includes(item.key)) {
        paidContacts.push(item.key);
      }
      if (!currentUser.agenda.includes(item.key)) {
        currentUser.agenda.push(item.key);
      }
    });
    playPaymentSound();
    cart = [];
    updateCartCount();
    showNotification(`‚úÖ Paiement simul√© (mode d√©mo) : ${total.toFixed(2)} CHF`, "info");
    closePublishModal();
    refreshMarkers();
  });
}

async function processContactPayment(type, id) {
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  try {
    showNotification("üí≥ Redirection vers le paiement...", "info");
    
    // Cr√©er une session Stripe Checkout
    const response = await fetch(`${window.API_BASE_URL}/payments/create-checkout-session`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id.toString(),
        paymentType: 'contact',
        itemType: type,
        itemId: id,
        amount: 1.00, // CHF 1.‚Äì
        currency: 'CHF',
        email: currentUser.email
      })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Erreur lors de la cr√©ation de la session');
    }
    
    const { sessionId, publicKey } = await response.json();
    
    // Initialiser Stripe si pas encore fait
    if (!stripe && publicKey) {
      initStripe(publicKey);
    }
    
    if (!stripe) {
      throw new Error('Stripe non disponible');
    }
    
    // Rediriger vers Stripe Checkout
    const result = await stripe.redirectToCheckout({ sessionId });
    
    if (result.error) {
      showNotification(`‚ùå Erreur : ${result.error.message}`, "error");
    }
  } catch (error) {
    console.error('Erreur paiement:', error);
    showNotification(`‚ùå Erreur lors du paiement : ${error.message}`, "error");
  }
}

// Fonction de compatibilit√© (fallback si Stripe √©choue)
function simulatePayment(type, id) {
  processContactPayment(type, id).catch(() => {
    // Fallback : simulation locale si l'API √©choue
    const key = `${type}:${id}`;
    if (!paidContacts.includes(key)) {
      paidContacts.push(key);
    }
    if (!currentUser.agenda.includes(key)) {
      currentUser.agenda.push(key);
    }
    playPaymentSound();
    showNotification("‚úÖ Paiement simul√© (mode d√©mo)", "info");
    closePublishModal();
    refreshMarkers();
  });
}

// ============================================
// AGENDA MINI WINDOW (comme Event List)
// ============================================
let agendaMiniWindowOpen = false;

// Toggle la fen√™tre Agenda depuis la topbar
function toggleAgendaWindow() {
  // L'agenda s'ouvre automatiquement quand on ajoute un √©l√©ment
  // Cette fonction ouvre simplement la mini-fen√™tre
  if (!agendaMiniWindowOpen) {
    showAgendaMiniWindow();
  } else {
    hideAgendaMiniWindow();
  }
}

async function showAgendaMiniWindow() {
  // R√©soudre les items agenda - chercher d'abord en m√©moire, puis fetch si manquant
  const agendaItems = [];
  for (const key of currentUser.agenda) {
    const [type, id] = key.split(":");
    const numId = parseInt(id);
    const data = type === "event" ? eventsData : type === "booking" ? bookingsData : servicesData;
    let item = data.find(i => i.id === numId);
    
    // Si pas en m√©moire (event hors viewport), fetch depuis l'API
    if (!item && type === "event") {
      try {
        const resp = await fetch(`${window.API_BASE_URL}/events/${numId}`);
        if (resp.ok) {
          const eventData = await resp.json();
          if (eventData && eventData.id) {
            eventData.type = 'event';
            eventsData.push(eventData); // Ajouter en cache m√©moire
            item = eventData;
          }
        }
      } catch(e) { console.warn('[AGENDA] Fetch event', numId, 'failed:', e); }
    }
    
    if (item) {
      if (!item.type) item.type = type;
      agendaItems.push(item);
    }
  }

  let agendaView = document.getElementById("agenda-mini-window");
  if (!agendaView) {
    agendaView = document.createElement("div");
    agendaView.id = "agenda-mini-window";
    agendaView.style.cssText = "position:fixed;bottom:20px;right:20px;width:380px;max-height:500px;background:var(--ui-card-bg);border:1px solid var(--ui-card-border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.5);z-index:100000;display:flex;flex-direction:column;overflow:hidden;";
    document.body.appendChild(agendaView);
  }

  agendaView.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:12px;padding:16px;background:var(--ui-card-bg);border-bottom:1px solid var(--ui-card-border);">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="font-size:16px;font-weight:700;">üìÖ Mon agenda (${agendaItems.length})</div>
        <div style="display:flex;gap:8px;">
          <button onclick="hideAgendaMiniWindow()" style="padding:6px 12px;border-radius:8px;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.4);color:#ef4444;font-size:11px;cursor:pointer;">‚úï</button>
        </div>
      </div>
    </div>
    <div style="flex:1;overflow-y:auto;padding:12px;max-height:400px;">
      ${agendaItems.length === 0 ? `
        <div style="text-align:center;padding:20px;color:var(--ui-text-muted);font-size:12px;">
          <div style="font-size:32px;margin-bottom:8px;">üì≠</div>
          <div>Votre agenda est vide</div>
        </div>
      ` : agendaItems.slice(0, 5).map(item => {
        const imgTag = buildMainImageTag(item, item.title || item.name || "");
        return `
          <div style="display:flex;gap:10px;padding:10px;border-radius:10px;margin-bottom:8px;background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;" onclick="openItemFromAgenda('${item.type}', ${item.id})" onmouseover="this.style.background='rgba(0,255,195,0.1)';this.style.borderColor='rgba(0,255,195,0.5)'" onmouseout="this.style.background='rgba(15,23,42,0.5)';this.style.borderColor='var(--ui-card-border)'">
            <div style="width:60px;height:60px;border-radius:8px;overflow:hidden;flex-shrink:0;">
              ${imgTag}
            </div>
            <div style="flex:1;min-width:0;">
              <div style="font-weight:600;font-size:13px;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(item.title || item.name)}</div>
              <div style="font-size:11px;color:var(--ui-text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.startDate ? formatEventDateRange(item.startDate, item.endDate) : item.city}</div>
              ${item.type === 'event' ? `
                <button onclick="event.stopPropagation();openAddAlarmModal('event', ${item.id})" style="margin-top:6px;padding:4px 8px;border-radius:6px;border:1px solid rgba(245,158,11,0.5);background:rgba(245,158,11,0.1);color:#f59e0b;cursor:pointer;font-size:10px;font-weight:600;">‚è∞ Alarme</button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('')}
      ${agendaItems.length > 5 ? `
        <div style="text-align:center;padding:8px;color:var(--ui-text-muted);font-size:11px;">
          +${agendaItems.length - 5} autres... Cliquez sur un √©l√©ment pour voir plus
        </div>
      ` : ''}
    </div>
  `;

  agendaView.style.display = "flex";
  agendaMiniWindowOpen = true;
}

function hideAgendaMiniWindow() {
  const agendaView = document.getElementById("agenda-mini-window");
  if (agendaView) {
    agendaView.style.display = "none";
    agendaMiniWindowOpen = false;
  }
}

// FONCTION SUPPRIM√âE - Le bloc compte ne doit JAMAIS √™tre modifi√©
// function updateAccountButton() { ... }

// Fonctions pour les photos
window.openPhotoViewer = function(photoUrl) {
  const html = `
    <div style="padding:20px;max-width:600px;margin:0 auto;text-align:center;">
      <h2 style="margin:0 0 20px;font-size:20px;color:var(--ui-text-main);">üì∏ Photo</h2>
      <img src="${photoUrl}" style="max-width:100%;max-height:70vh;border-radius:12px;border:1px solid var(--ui-card-border);" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=\\'padding:40px;color:var(--ui-text-muted);\\'>Erreur de chargement de l\\'image</div>';" />
      <button onclick="closePublishModal()" style="margin-top:20px;padding:10px 24px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:14px;">Fermer</button>
    </div>
  `;
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
};

window.openPhotoUploader = function() {
  const html = `
    <div style="padding:24px;max-width:500px;margin:0 auto;">
      <h2 style="margin:0 0 20px;font-size:20px;color:var(--ui-text-main);display:flex;align-items:center;gap:10px;">
        <span>üì∏</span> <span>Ajouter une photo</span>
      </h2>
      <div style="border:2px dashed var(--ui-card-border);border-radius:12px;padding:40px;text-align:center;background:rgba(15,23,42,0.3);margin-bottom:20px;">
        <div style="font-size:48px;margin-bottom:12px;">üì∑</div>
        <div style="color:var(--ui-text-muted);margin-bottom:16px;">Glissez-d√©posez une image ou cliquez pour s√©lectionner</div>
        <input type="file" id="photo-upload-input" accept="image/*" style="display:none;" onchange="handlePhotoUpload(event)">
        <button onclick="document.getElementById('photo-upload-input').click()" style="padding:12px 24px;border-radius:999px;border:none;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-weight:600;cursor:pointer;font-size:14px;">
          Choisir un fichier
        </button>
      </div>
      <div style="display:flex;gap:12px;">
        <button onclick="closePublishModal()" style="flex:1;padding:12px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:14px;">Annuler</button>
      </div>
    </div>
  `;
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
};

window.handlePhotoUpload = function(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    showNotification("‚ö†Ô∏è Veuillez s√©lectionner une image", "warning");
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const photoUrl = e.target.result;
    if (!currentUser.photos) currentUser.photos = [];
    currentUser.photos.unshift({ url: photoUrl, timestamp: Date.now() });
    
    // Ajouter √† l'historique
    if (!currentUser.history) currentUser.history = [];
    currentUser.history.unshift({
      action: "Photo ajout√©e",
      icon: "üì∏",
      timestamp: Date.now()
    });
    
    saveUser();
    showNotification("‚úÖ Photo ajout√©e avec succ√®s !", "success");
    openAccountModal(); // Rafra√Æchir le modal compte
  };
  reader.readAsDataURL(file);
};

// ============================================
// AGENDA POPUP (Style Facebook) - Version compl√®te
// ============================================
function openAgendaModal() {
  // Fermer la mini-fen√™tre si elle est ouverte
  hideAgendaMiniWindow();
  
  // Protection contre les erreurs TDZ
  // NE JAMAIS cr√©er de variable locale 't' - utiliser directement window.t() pour √©viter toute TDZ
  const agendaItems = currentUser.agenda.map(key => {
    const [type, id] = key.split(":");
    const data = type === "event" ? eventsData : type === "booking" ? bookingsData : servicesData;
    return data.find(i => i.id === parseInt(id));
  }).filter(Boolean);

  // Filtrer uniquement les √©v√©nements pour les alarmes
  const agendaEvents = agendaItems.filter(item => item.type === 'event');
  
  const html = `
    <div style="padding:10px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 style="margin:0;font-size:18px;">üìÖ ${window.t("my_agenda")}</h2>
        <button onclick="closePublishModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--ui-text-muted);">${window.t("close") === "Fermer" ? "‚úï" : "√ó"}</button>
      </div>
      
      ${agendaEvents.length > 0 ? `
        <!-- Bouton Ajouter Alarme -->
        <button onclick="closePublishModal();setTimeout(() => openAddAlarmModal('agenda'), 300);" style="width:100%;padding:12px;border-radius:12px;border:2px solid #f59e0b;background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px;">
          <span>‚è∞</span>
          <span>Ajouter alarme</span>
        </button>
      ` : ''}
      
      ${agendaItems.length === 0 ? `
        <div style="text-align:center;padding:40px;color:var(--ui-text-muted);">
          <div style="font-size:48px;margin-bottom:16px;">üì≠</div>
          <p>${window.t("agenda_empty")}</p>
          <p style="font-size:12px;">${window.t("add_from_map")}</p>
        </div>
      ` : `
        <div style="margin-bottom:12px;font-size:12px;color:var(--ui-text-muted);text-align:center;">
          ${agendaItems.length} ${agendaItems.length === 1 ? '√©l√©ment' : '√©l√©ments'} dans votre agenda
        </div>
        <div id="agenda-list-container" style="max-height:calc(80vh - 180px);overflow-y:auto;padding-right:8px;">
          ${agendaItems.slice(0, 20).map(item => `
            <div style="display:flex;gap:12px;padding:12px;border-radius:12px;margin-bottom:8px;background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;" onclick="openItemFromAgenda('${item.type}', ${item.id})" onmouseover="this.style.background='rgba(0,255,195,0.1)';this.style.borderColor='rgba(0,255,195,0.5)'" onmouseout="this.style.background='rgba(15,23,42,0.5)';this.style.borderColor='var(--ui-card-border)'">
              <div style="width:60px;height:60px;border-radius:8px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:24px;">
                ${getCategoryEmoji(item)}
              </div>
              <div style="flex:1;">
                <div style="font-weight:600;margin-bottom:4px;">${escapeHtml(item.title || item.name)}</div>
                <div style="font-size:12px;color:var(--ui-text-muted);">${item.startDate ? formatEventDateRange(item.startDate, item.endDate) : item.city}</div>
                <div style="font-size:11px;color:var(--ui-text-muted);">${item.city}</div>
                ${(currentUser.eventAlarms || []).some(a => a.eventId === item.id.toString() && item.type === 'event') ? `
                  <div style="margin-top:4px;display:flex;align-items:center;gap:4px;font-size:11px;color:#f59e0b;">
                    <span>‚è∞</span>
                    <span>${(currentUser.eventAlarms || []).filter(a => a.eventId === item.id.toString()).length} alarme${(currentUser.eventAlarms || []).filter(a => a.eventId === item.id.toString()).length > 1 ? 's' : ''}</span>
                  </div>
                ` : ''}
              </div>
              <button onclick="event.stopPropagation();removeFromAgenda('${item.type}', ${item.id})" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:18px;padding:4px;" title="${window.t('remove_from_agenda')}">üóëÔ∏è</button>
            </div>
          `).join('')}
        </div>
        ${agendaItems.length > 20 ? `
          <div style="text-align:center;margin-top:12px;padding:12px;background:rgba(15,23,42,0.5);border-radius:8px;border:1px solid var(--ui-card-border);">
            <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:8px;">
              Affichage de 20 sur ${agendaItems.length} √©l√©ments
            </div>
            <button onclick="loadMoreAgendaItems()" style="padding:8px 16px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:12px;">
              Afficher plus (${Math.min(20, agendaItems.length - 20)} suivants)
            </button>
          </div>
        ` : ''}
      `}
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
  
  // Stocker les items complets pour la pagination
  window.agendaItemsFull = agendaItems;
  window.agendaItemsDisplayed = 20;
}

function loadMoreAgendaItems() {
  // Protection contre les erreurs TDZ
  const t = window.t || function(key) { return key; };
  
  if (!window.agendaItemsFull) return;
  const container = document.getElementById("agenda-list-container");
  if (!container) return;
  
  const start = window.agendaItemsDisplayed;
  const end = Math.min(start + 20, window.agendaItemsFull.length);
  const newItems = window.agendaItemsFull.slice(start, end);
  
  newItems.forEach(item => {
    const itemHtml = `
      <div style="display:flex;gap:12px;padding:12px;border-radius:12px;margin-bottom:8px;background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;" onclick="openItemFromAgenda('${item.type}', ${item.id})" onmouseover="this.style.background='rgba(0,255,195,0.1)';this.style.borderColor='rgba(0,255,195,0.5)'" onmouseout="this.style.background='rgba(15,23,42,0.5)';this.style.borderColor='var(--ui-card-border)'">
        <div style="width:60px;height:60px;border-radius:8px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:24px;">
          ${getCategoryEmoji(item)}
        </div>
        <div style="flex:1;">
          <div style="font-weight:600;margin-bottom:4px;">${escapeHtml(item.title || item.name)}</div>
          <div style="font-size:12px;color:var(--ui-text-muted);">${item.startDate ? formatEventDateRange(item.startDate, item.endDate) : item.city}</div>
          <div style="font-size:11px;color:var(--ui-text-muted);">${item.city}</div>
          ${(currentUser.eventAlarms || []).some(a => a.eventId === item.id.toString() && item.type === 'event') ? `
            <div style="margin-top:4px;display:flex;align-items:center;gap:4px;font-size:11px;color:#f59e0b;">
              <span>‚è∞</span>
              <span>${(currentUser.eventAlarms || []).filter(a => a.eventId === item.id.toString()).length} alarme${(currentUser.eventAlarms || []).filter(a => a.eventId === item.id.toString()).length > 1 ? 's' : ''}</span>
            </div>
          ` : ''}
        </div>
        <button onclick="event.stopPropagation();removeFromAgenda('${item.type}', ${item.id})" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:18px;padding:4px;" title="${window.t('remove_from_agenda')}">üóëÔ∏è</button>
      </div>
    `;
    container.insertAdjacentHTML('beforeend', itemHtml);
  });
  
  window.agendaItemsDisplayed = end;
  
  // Mettre √† jour le bouton "Afficher plus"
  const moreButton = container.nextElementSibling?.querySelector('button');
  if (moreButton) {
    const remaining = window.agendaItemsFull.length - end;
    if (remaining > 0) {
      moreButton.textContent = `Afficher plus (${Math.min(20, remaining)} suivants)`;
    } else {
      moreButton.parentElement.remove();
    }
  }
}

function removeFromAgenda(type, id) {
  // Protection contre les erreurs TDZ
  const t = window.t || function(key) { return key; };
  
  const key = `${type}:${id}`;
  currentUser.agenda = currentUser.agenda.filter(k => k !== key);
  showNotification(`üìÖ ${window.t("removed_from_agenda")}`, "info");
  openAgendaModal(); // Rafra√Æchir
}

// ============================================
// SYST√àME D'ALARMES POUR √âV√âNEMENTS
// ============================================

// Initialiser les alarmes si elles n'existent pas
if (!currentUser.eventAlarms) {
  currentUser.eventAlarms = [];
}

// Ouvrir le modal pour ajouter une alarme
function openAddAlarmModal(source, eventId = null) {
  if (!currentUser || !currentUser.isLoggedIn) {
    showNotification("‚ö†Ô∏è Vous devez √™tre connect√© pour ajouter une alarme", "warning");
    openLoginModal();
    return;
  }
  
  // Si appel√© depuis l'agenda, proposer de choisir un √©v√©nement
  let eventsToChoose = [];
  if (source === 'agenda') {
    const agendaItems = currentUser.agenda.map(key => {
      const [type, id] = key.split(":");
      if (type === "event") {
        return eventsData.find(e => e.id === parseInt(id));
      }
      return null;
    }).filter(Boolean);
    
    eventsToChoose = agendaItems.filter(ev => {
      const alarms = (currentUser.eventAlarms || []).filter(a => a.eventId === ev.id.toString());
      return alarms.length < 2;
    });
    
    if (eventsToChoose.length === 0) {
      showNotification("‚ö†Ô∏è Aucun √©v√©nement disponible pour ajouter une alarme (limite de 2 alarmes atteinte)", "warning");
      return;
    }
  }
  
  // Si eventId est fourni, utiliser cet √©v√©nement
  let selectedEvent = null;
  if (eventId) {
    selectedEvent = eventsData.find(e => e.id === eventId);
    if (!selectedEvent) {
      showNotification("‚ö†Ô∏è √âv√©nement introuvable", "error");
      return;
    }
    const alarms = (currentUser.eventAlarms || []).filter(a => a.eventId === eventId.toString());
    if (alarms.length >= 2) {
      showNotification("‚ö†Ô∏è Limite de 2 alarmes atteinte pour cet √©v√©nement", "warning");
      return;
    }
  }
  
  const html = `
    <div style="padding:24px;max-width:500px;margin:0 auto;max-height:85vh;overflow-y:auto;">
      <div style="text-align:center;margin-bottom:24px;">
        <div style="font-size:48px;margin-bottom:12px;">‚è∞</div>
        <h2 style="margin:0;font-size:22px;font-weight:700;color:#fff;">Ajouter une alarme</h2>
        <p style="color:var(--ui-text-muted);margin-top:8px;font-size:13px;">Recevez un rappel avant ou pendant l'√©v√©nement</p>
        <div style="margin-top:12px;padding:12px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:10px;font-size:12px;color:var(--ui-text-muted);line-height:1.6;">
          <div style="font-weight:600;color:#3b82f6;margin-bottom:6px;">üì± Comment √ßa fonctionne ?</div>
          <div>‚Ä¢ <strong>Notifications navigateur</strong> : Une notification appara√Ætra sur votre √©cran (comme les notifications WhatsApp)</div>
          <div>‚Ä¢ <strong>Email</strong> : Vous recevrez un email √† l'adresse enregistr√©e</div>
          <div>‚Ä¢ <strong>SMS</strong> : Si configur√©, vous recevrez un SMS sur votre t√©l√©phone</div>
          <div style="margin-top:8px;font-size:11px;color:#00ffc3;">üí° Pour les notifications navigateur, autorisez-les quand le navigateur vous le demande</div>
        </div>
      </div>
      
      ${source === 'agenda' && !eventId ? `
        <div style="margin-bottom:20px;">
          <label style="display:block;font-size:14px;font-weight:600;color:#fff;margin-bottom:8px;">
            Choisir un √©v√©nement <span style="color:#ef4444;">*</span>
          </label>
          <select id="alarm-event-select" style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:14px;cursor:pointer;">
            ${eventsToChoose.map(ev => `
              <option value="${ev.id}">${escapeHtml(ev.title || 'Sans titre')} - ${formatEventDateRange(ev.startDate, ev.endDate)}</option>
            `).join('')}
          </select>
        </div>
      ` : selectedEvent ? `
        <div style="padding:12px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:10px;margin-bottom:20px;">
          <div style="font-weight:600;font-size:14px;color:#fff;margin-bottom:4px;">${escapeHtml(selectedEvent.title || 'Sans titre')}</div>
          <div style="font-size:12px;color:var(--ui-text-muted);">${formatEventDateRange(selectedEvent.startDate, selectedEvent.endDate)}</div>
        </div>
      ` : ''}
      
      <div style="margin-bottom:20px;">
        <label style="display:block;font-size:14px;font-weight:600;color:#fff;margin-bottom:8px;">
          Type d'alarme <span style="color:#ef4444;">*</span>
        </label>
        <select id="alarm-type" style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:14px;cursor:pointer;">
          <option value="before">Avant l'√©v√©nement</option>
          <option value="during">Pendant l'√©v√©nement</option>
        </select>
      </div>
      
      <div id="alarm-timing-container">
        <div style="margin-bottom:20px;">
          <label style="display:block;font-size:14px;font-weight:600;color:#fff;margin-bottom:8px;">
            Moment <span style="color:#ef4444;">*</span>
          </label>
          <select id="alarm-timing" style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:14px;cursor:pointer;">
            <option value="hour">1 heure avant</option>
            <option value="day">1 jour avant</option>
            <option value="week">1 semaine avant</option>
          </select>
        </div>
      </div>
      
      <div style="display:flex;gap:12px;">
        <button onclick="closePublishModal()" style="flex:1;padding:12px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-weight:600;">
          Annuler
        </button>
        <button onclick="saveAlarm(${eventId || 'null'})" style="flex:1;padding:12px;border-radius:999px;border:none;background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;font-weight:700;cursor:pointer;">
          Enregistrer
        </button>
      </div>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
  
  // Mettre √† jour les options selon le type
  document.getElementById("alarm-type").addEventListener('change', function() {
    const timingSelect = document.getElementById("alarm-timing");
    const container = document.getElementById("alarm-timing-container");
    if (this.value === 'during') {
      container.innerHTML = `
        <div style="margin-bottom:20px;">
          <label style="display:block;font-size:14px;font-weight:600;color:#fff;margin-bottom:8px;">
            Heure <span style="color:#ef4444;">*</span>
          </label>
          <input type="time" id="alarm-time" style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:14px;">
        </div>
      `;
    } else {
      container.innerHTML = `
        <div style="margin-bottom:20px;">
          <label style="display:block;font-size:14px;font-weight:600;color:#fff;margin-bottom:8px;">
            Moment <span style="color:#ef4444;">*</span>
          </label>
          <select id="alarm-timing" style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:14px;cursor:pointer;">
            <option value="hour">1 heure avant</option>
            <option value="day">1 jour avant</option>
            <option value="week">1 semaine avant</option>
          </select>
        </div>
      `;
    }
  });
}

window.openAddAlarmModal = openAddAlarmModal;

// Sauvegarder une alarme
function saveAlarm(eventId) {
  const eventSelect = document.getElementById("alarm-event-select");
  const finalEventId = eventId || (eventSelect ? parseInt(eventSelect.value) : null);
  
  if (!finalEventId) {
    showNotification("‚ö†Ô∏è Veuillez s√©lectionner un √©v√©nement", "warning");
    return;
  }
  
  const event = eventsData.find(e => e.id === finalEventId);
  if (!event) {
    showNotification("‚ö†Ô∏è √âv√©nement introuvable", "error");
    return;
  }
  
  // V√©rifier la limite de 2 alarmes
  const existingAlarms = (currentUser.eventAlarms || []).filter(a => a.eventId === finalEventId.toString());
  if (existingAlarms.length >= 2) {
    showNotification("‚ö†Ô∏è Limite de 2 alarmes atteinte pour cet √©v√©nement", "warning");
    return;
  }
  
  const alarmType = document.getElementById("alarm-type").value;
  let alarmTime = null;
  let alarmTiming = null;
  
  if (alarmType === 'during') {
    const timeInput = document.getElementById("alarm-time");
    if (!timeInput || !timeInput.value) {
      showNotification("‚ö†Ô∏è Veuillez s√©lectionner une heure", "warning");
      return;
    }
    alarmTime = timeInput.value;
  } else {
    const timingSelect = document.getElementById("alarm-timing");
    if (!timingSelect || !timingSelect.value) {
      showNotification("‚ö†Ô∏è Veuillez s√©lectionner un moment", "warning");
      return;
    }
    alarmTiming = timingSelect.value;
  }
  
  // Calculer la date de d√©clenchement
  const startDate = event.startDate ? new Date(event.startDate) : null;
  if (!startDate) {
    showNotification("‚ö†Ô∏è L'√©v√©nement n'a pas de date de d√©but", "error");
    return;
  }
  
  let triggerDate = null;
  if (alarmType === 'during') {
    const [hours, minutes] = alarmTime.split(':');
    triggerDate = new Date(startDate);
    triggerDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
  } else {
    triggerDate = new Date(startDate);
    if (alarmTiming === 'hour') {
      triggerDate.setHours(triggerDate.getHours() - 1);
    } else if (alarmTiming === 'day') {
      triggerDate.setDate(triggerDate.getDate() - 1);
    } else if (alarmTiming === 'week') {
      triggerDate.setDate(triggerDate.getDate() - 7);
    }
  }
  
  const alarm = {
    id: `alarm-${finalEventId}-${Date.now()}`,
    eventId: finalEventId.toString(),
    type: alarmType,
    timing: alarmTiming,
    time: alarmTime,
    triggerDate: triggerDate.toISOString(),
    triggered: false,
    createdAt: new Date().toISOString()
  };
  
  if (!currentUser.eventAlarms) {
    currentUser.eventAlarms = [];
  }
  currentUser.eventAlarms.push(alarm);
  saveUser();
  
  showNotification("‚úÖ Alarme ajout√©e avec succ√®s !", "success");
  closePublishModal();
  
  // Rafra√Æchir la popup si elle est ouverte
  if (currentPopupMarker) {
    const item = getItemById('event', finalEventId);
    if (item) {
      const popupContent = buildEventPopup(item);
      const backdrop = document.getElementById("popup-modal-backdrop");
      if (backdrop) {
        backdrop.innerHTML = `
          <div id="popup-modal-content" style="position:relative;width:380px;max-height:85vh;overflow:hidden;background:var(--ui-card-bg);border-radius:16px;border:1px solid var(--ui-card-border);margin:20px;box-shadow:0 20px 60px rgba(0,0,0,0.5);display:flex;flex-direction:column;padding:0;box-sizing:border-box;pointer-events:auto;">
            <button onclick="closePopupModal()" style="position:absolute;top:12px;right:12px;width:36px;height:36px;border-radius:50%;border:none;background:rgba(0,0,0,0.6);color:#fff;cursor:pointer;font-size:20px;z-index:1001;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.8)'" onmouseout="this.style.background='rgba(0,0,0,0.6)'">‚úï</button>
            <div id="popup-scroll-container" style="flex:1;overflow-y:auto;overflow-x:hidden;scrollbar-width:none;-webkit-overflow-scrolling:touch;width:100%;margin:0;padding:0;box-sizing:border-box;touch-action:pan-y;overscroll-behavior:contain;">
              ${popupContent}
            </div>
          </div>
        `;
      }
    }
  }
}

window.saveAlarm = saveAlarm;

// V√©rifier et d√©clencher les alarmes
function checkEventAlarms() {
  if (!isLoggedIn() || !currentUser.eventAlarms || currentUser.eventAlarms.length === 0) {
    return;
  }
  
  const now = new Date();
  const alarmsToTrigger = currentUser.eventAlarms.filter(alarm => {
    if (alarm.triggered) return false;
    const triggerDate = new Date(alarm.triggerDate);
    return triggerDate <= now;
  });
  
  alarmsToTrigger.forEach(alarm => {
    const event = eventsData.find(e => e.id === parseInt(alarm.eventId));
    if (event) {
      const message = alarm.type === 'during' 
        ? `‚è∞ ${event.title || '√âv√©nement'} commence maintenant !`
        : `‚è∞ Rappel : ${event.title || '√âv√©nement'} ${alarm.timing === 'hour' ? 'dans 1 heure' : alarm.timing === 'day' ? 'demain' : 'dans 1 semaine'}`;
      
      showNotification(message, "info");
      alarm.triggered = true;
    }
  });
  
  if (alarmsToTrigger.length > 0) {
    saveUser();
  }
}

// V√©rifier les alarmes toutes les minutes
setInterval(checkEventAlarms, 60000);
checkEventAlarms(); // V√©rifier imm√©diatement au chargement

// ============================================
// NETTOYAGE DES √âV√âNEMENTS EXPIR√âS
// ============================================

function cleanExpiredEvents() {
  if (!isLoggedIn()) {
    // Nettoyer les √©v√©nements expir√©s m√™me si non connect√© (pour la liste publique)
    // Mais ne pas toucher aux alarmes/agenda de l'utilisateur
  }
  
  const now = new Date();
  const organizerEvents = {}; // {organizerEmail: [events]}
  
  // Compter les √©v√©nements par organisateur
  eventsData.forEach(event => {
    if (event.organizerEmail) {
      if (!organizerEvents[event.organizerEmail]) {
        organizerEvents[event.organizerEmail] = [];
      }
      organizerEvents[event.organizerEmail].push(event);
    }
  });
  
  // Filtrer les √©v√©nements expir√©s
  const beforeCount = eventsData.length;
  eventsData = eventsData.filter(event => {
    // Si l'√©v√©nement n'a pas de date de fin, le garder
    if (!event.endDate) return true;
    
    const endDate = new Date(event.endDate);
    
    // Si l'√©v√©nement n'est pas encore termin√©, le garder
    if (endDate > now) return true;
    
    // Si l'√©v√©nement est termin√© mais appartient √† un organisateur avec moins de 30 √©v√©nements, le garder
    if (event.organizerEmail) {
      const organizerEventCount = organizerEvents[event.organizerEmail]?.length || 0;
      if (organizerEventCount <= 30) {
        return true;
      }
    }
    
    // Sinon, supprimer l'√©v√©nement
    return false;
  });
  
  const afterCount = eventsData.length;
  const removedCount = beforeCount - afterCount;
  
  if (removedCount > 0) {
    console.log(`üßπ Nettoyage : ${removedCount} √©v√©nement(s) expir√©(s) supprim√©(s)`);
    
    // V√©rifier si des organisateurs ont trop d'√©v√©nements
    Object.keys(organizerEvents).forEach(email => {
      const count = organizerEvents[email].filter(e => {
        if (!e.endDate) return true;
        return new Date(e.endDate) > now;
      }).length;
      
      if (count > 30) {
        // Trouver l'organisateur dans les √©v√©nements restants
        const organizerEventsRemaining = eventsData.filter(e => e.organizerEmail === email);
        if (organizerEventsRemaining.length > 30) {
          // Avertir l'organisateur (simulation - √† impl√©menter avec notification r√©elle)
          console.warn(`‚ö†Ô∏è Organisateur ${email} a ${organizerEventsRemaining.length} √©v√©nements. Limite de 30 atteinte.`);
          // TODO: Envoyer une notification √† l'organisateur pour qu'il supprime des √©v√©nements
        }
      }
    });
  }
  
  // Nettoyer aussi les alarmes des √©v√©nements supprim√©s
  if (isLoggedIn() && currentUser.eventAlarms) {
    const eventIds = new Set(eventsData.map(e => e.id.toString()));
    const beforeAlarmsCount = currentUser.eventAlarms.length;
    currentUser.eventAlarms = currentUser.eventAlarms.filter(alarm => eventIds.has(alarm.eventId));
    const afterAlarmsCount = currentUser.eventAlarms.length;
    
    if (beforeAlarmsCount !== afterAlarmsCount) {
      saveUser();
    }
  }
  
  // Nettoyer aussi l'agenda des √©v√©nements supprim√©s
  if (isLoggedIn() && currentUser.agenda) {
    const eventIds = new Set(eventsData.map(e => e.id.toString()));
    const beforeAgendaCount = currentUser.agenda.length;
    currentUser.agenda = currentUser.agenda.filter(key => {
      const [type, id] = key.split(':');
      if (type === 'event') {
        return eventIds.has(id);
      }
      return true;
    });
    const afterAgendaCount = currentUser.agenda.length;
    
    if (beforeAgendaCount !== afterAgendaCount) {
      saveUser();
    }
  }
}

// Nettoyer les √©v√©nements toutes les heures
setInterval(cleanExpiredEvents, 3600000);
cleanExpiredEvents(); // Nettoyer imm√©diatement au chargement

// Ouvrir la popup originale d'un item depuis l'agenda
function openItemFromAgenda(type, id) {
  // Fermer la modal agenda
  closePublishModal();
  
  // Switcher le mode si n√©cessaire
  if (currentMode !== type) {
    switchMode(type);
  }
  
  // Attendre que le mode soit charg√© avant de chercher l'item
  setTimeout(() => {
    const data = type === "event" ? eventsData : type === "booking" ? bookingsData : servicesData;
    const item = data.find(i => i.id === parseInt(id));
    
    if (!item) {
      showNotification("‚ö†Ô∏è Item introuvable", "error");
      return;
    }
    
    const key = `${type}:${id}`;
    const marker = markerMap[key];
    
    if (marker) {
      map.setView([item.lat, item.lng], Math.max(map.getZoom(), 13));
      setTimeout(() => {
        currentPopupMarker = marker;
        const popupContent = buildPopupHtml(item);
        openPopupModal(popupContent, item);
      }, 300);
    } else {
      map.setView([item.lat, item.lng], Math.max(map.getZoom(), 13));
      setTimeout(() => {
        const popupContent = buildPopupHtml(item);
        openPopupModal(popupContent, item);
      }, 300);
    }
  }, 500);
}

// FONCTION SUPPRIM√âE - Le bloc compte ne doit JAMAIS √™tre modifi√©
// function updateUserUI() { ... }

// ============================================
// SYST√àME D'ABONNEMENTS & ALERTES
// ============================================

// Obtenir le nombre d'utilisateurs actifs depuis l'API
async function getActiveUsersCount() {
  try {
    const response = await fetch(`${window.API_BASE_URL}/stats/active-users`, {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (response.ok) {
      const data = await response.json();
      return (data.count || data.activeUsers || 0).toLocaleString('fr-CH');
    }
  } catch (error) {
    console.warn('Erreur r√©cup√©ration utilisateurs actifs:', error);
  }
  
  // Fallback : simulation si l'API n'est pas disponible
  const base = 1247;
  const variation = Math.floor(Math.random() * 909);
  return (base + variation).toLocaleString('fr-CH');
}

// Mettre √† jour le compteur d'utilisateurs actifs
async function updateActiveUsersCount() {
  const countElement = document.getElementById("active-users-count");
  if (countElement) {
    const count = await getActiveUsersCount();
    countElement.textContent = count;
  }
}

function openSubscriptionModal() {
  const currentSub = currentUser.subscription || "free";
  const maxAgenda = getAgendaLimit();
  const maxAlerts = getAlertLimit();
  const alertText = maxAlerts === Infinity ? "‚àû" : maxAlerts;
  
  const html = `
    <div style="padding:10px;max-height:90vh;overflow-y:auto;">
      <h2 style="margin:0 0 16px;font-size:18px;text-align:center;">üíé Abonnements</h2>
      <p style="text-align:center;color:var(--ui-text-muted);margin-bottom:20px;font-size:12px;">
        Choisissez votre formule selon vos besoins !
      </p>
      
      <div style="margin-bottom:16px;">
        <div style="font-size:13px;font-weight:600;color:#00ffc3;margin-bottom:8px;text-align:center;">üéâ Pour les utilisateurs d'√©v√©nements</div>
        <div style="display:grid;gap:10px;margin-bottom:16px;">
          <div style="padding:14px;border-radius:12px;border:2px solid ${currentSub === 'events-explorer' ? '#22c55e' : '#22c55e'};background:rgba(34,197,94,0.05);cursor:pointer;position:relative;overflow:hidden;${currentSub === 'events-explorer' ? 'box-shadow:0 0 15px rgba(34,197,94,0.3);' : ''}" onclick="selectPlan('events-explorer')">
            ${currentSub === 'events-explorer' ? '<div style="position:absolute;top:0;right:0;background:#22c55e;color:#fff;padding:2px 10px;font-size:9px;font-weight:700;border-bottom-left-radius:8px;">ACTIF</div>' : '<div style="position:absolute;top:0;right:0;background:#22c55e;color:#fff;padding:2px 10px;font-size:9px;font-weight:700;border-bottom-left-radius:8px;">POPULAIRE</div>'}
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="font-weight:700;font-size:14px;">üå± Events Explorer</span>
              <span style="color:#22c55e;font-weight:700;font-size:14px;">CHF 5.‚Äì/mois</span>
            </div>
            <ul style="margin:0;padding-left:18px;font-size:11px;color:var(--ui-text-muted);line-height:1.6;">
              <li><strong>10 alertes personnalis√©es/mois</strong></li>
              <li><strong>10 alarmes</strong></li>
              <li>Notifications instantan√©es</li>
              <li><strong>Agenda 50 places</strong> (vs 20 gratuit)</li>
              <li>√âcoute des sons booking illimit√©s</li>
            </ul>
          </div>
          
          <div style="padding:14px;border-radius:12px;border:2px solid ${currentSub === 'events-alerts-pro' ? '#3b82f6' : '#3b82f6'};background:rgba(59,130,246,0.05);cursor:pointer;position:relative;overflow:hidden;${currentSub === 'events-alerts-pro' ? 'box-shadow:0 0 15px rgba(59,130,246,0.3);' : ''}" onclick="selectPlan('events-alerts-pro')">
            ${currentSub === 'events-alerts-pro' ? '<div style="position:absolute;top:0;right:0;background:#3b82f6;color:#fff;padding:2px 10px;font-size:9px;font-weight:700;border-bottom-left-radius:8px;">ACTIF</div>' : '<div style="position:absolute;top:0;right:0;background:#3b82f6;color:#fff;padding:2px 10px;font-size:9px;font-weight:700;border-bottom-left-radius:8px;">ALERTES</div>'}
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="font-weight:700;font-size:14px;">üîî Events Alertes Pro</span>
              <span style="color:#3b82f6;font-weight:700;font-size:14px;">CHF 10.‚Äì/mois</span>
            </div>
            <ul style="margin:0;padding-left:18px;font-size:11px;color:var(--ui-text-muted);line-height:1.6;">
              <li><strong>Tout de Events Explorer +</strong></li>
              <li><strong>Alertes jusqu'√† 200</strong> avec notifications push + email</li>
              <li><strong>Agenda jusqu'√† 200 places</strong></li>
            </ul>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom:16px;">
        <div style="font-size:13px;font-weight:600;color:#a78bfa;margin-bottom:8px;text-align:center;">üé§ Pour les professionnels</div>
        <div style="display:grid;gap:10px;margin-bottom:16px;">
          <div style="padding:14px;border-radius:12px;border:2px solid ${currentSub === 'service-pro' ? '#8b5cf6' : '#8b5cf6'};background:rgba(139,92,246,0.05);cursor:pointer;position:relative;overflow:hidden;${currentSub === 'service-pro' ? 'box-shadow:0 0 15px rgba(139,92,246,0.3);' : ''}" onclick="selectPlan('service-pro')">
            ${currentSub === 'service-pro' ? '<div style="position:absolute;top:0;right:0;background:#8b5cf6;color:#fff;padding:2px 10px;font-size:9px;font-weight:700;border-bottom-left-radius:8px;">ACTIF</div>' : ''}
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="font-weight:700;font-size:14px;">üíº Service Pro</span>
              <span style="color:#8b5cf6;font-weight:700;font-size:14px;">CHF 10.‚Äì/mois</span>
            </div>
            <ul style="margin:0;padding-left:18px;font-size:11px;color:var(--ui-text-muted);line-height:1.6;">
              <li><strong>Tout de Events Explorer</strong></li>
              <li><strong>Contacts illimit√©s</strong> - voit toutes les infos directement</li>
              <li><strong>Badge Pro</strong> visible sur avatar</li>
              <li>Support prioritaire</li>
            </ul>
          </div>
          
          <div style="padding:14px;border-radius:12px;border:2px solid ${currentSub === 'service-ultra' ? '#a78bfa' : '#a78bfa'};background:rgba(167,139,250,0.05);cursor:pointer;position:relative;overflow:hidden;${currentSub === 'service-ultra' ? 'box-shadow:0 0 15px rgba(167,139,250,0.3);' : ''}" onclick="selectPlan('service-ultra')">
            ${currentSub === 'service-ultra' ? '<div style="position:absolute;top:0;right:0;background:#a78bfa;color:#fff;padding:2px 10px;font-size:9px;font-weight:700;border-bottom-left-radius:8px;">ACTIF</div>' : '<div style="position:absolute;top:0;right:0;background:#a78bfa;color:#fff;padding:2px 10px;font-size:9px;font-weight:700;border-bottom-left-radius:8px;">ULTRA</div>'}
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="font-weight:700;font-size:14px;">üöÄ Service Ultra</span>
              <span style="color:#a78bfa;font-weight:700;font-size:14px;">CHF 18.‚Äì/mois</span>
            </div>
            <ul style="margin:0;padding-left:18px;font-size:11px;color:var(--ui-text-muted);line-height:1.6;">
              <li>Tout de Pro +</li>
              <li><strong>Acc√®s API</strong> pour d√©veloppeurs</li>
              <li><strong>Ajout automatique d'events</strong> pour organisateurs</li>
              <li>Contacts infos illimit√©s</li>
              <li><strong>Statistiques avanc√©es</strong></li>
              <li><strong>5 events gratuits / mois plac√©s OR</strong></li>
              <li>Support 24/7</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom:20px;">
        <div style="font-size:13px;font-weight:600;color:#ffd700;margin-bottom:8px;text-align:center;">‚≠ê Tout compris</div>
        <div style="padding:16px;border-radius:12px;border:2px solid ${currentSub === 'full-premium' ? '#ffd700' : '#ffd700'};background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,215,0,0.05));cursor:pointer;position:relative;overflow:hidden;${currentSub === 'full-premium' ? 'box-shadow:0 0 20px rgba(255,215,0,0.4);' : ''}" onclick="selectPlan('full-premium')">
          ${currentSub === 'full-premium' ? '<div style="position:absolute;top:0;right:0;background:#ffd700;color:#000;padding:2px 12px;font-size:10px;font-weight:700;border-bottom-left-radius:8px;">ACTIF</div>' : '<div style="position:absolute;top:0;right:0;background:#ffd700;color:#000;padding:2px 12px;font-size:10px;font-weight:700;border-bottom-left-radius:8px;">TOP</div>'}
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <span style="font-weight:700;font-size:16px;">üëë Full Premium</span>
            <span style="color:#ffd700;font-weight:700;font-size:16px;">CHF 25.‚Äì/mois</span>
          </div>
          <ul style="margin:0;padding-left:20px;font-size:12px;color:var(--ui-text-muted);line-height:1.8;">
            <li><strong>Tout de Events Alertes Pro, Tout de Service Ultra</strong></li>
            <li><strong>Agenda 250 places</strong></li>
            <li><strong>Alertes 250</strong> avec notifications push + email</li>
            <li><strong>Alarmes 250 places</strong></li>
            <li><strong>Contacts illimit√©s</strong> partout</li>
            <li><strong>Acc√®s API complet</strong> et facilit√© pour poser tous les events</li>
            <li><strong>Statistiques ultras avanc√©es</strong></li>
            <li>Support 24/7 prioritaire</li>
          </ul>
        </div>
      </div>
      
      <div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:12px;padding:12px;margin-bottom:20px;">
        <div style="font-size:12px;font-weight:600;color:#22c55e;margin-bottom:6px;">üåç 70% de vos paiements vont √† la Mission Plan√®te</div>
        <div style="font-size:11px;color:var(--ui-text-muted);">Achat de for√™ts, filtres CO2, protection des oc√©ans...</div>
      </div>
      
      
      
      <button onclick="closePublishModal()" style="width:100%;padding:10px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;margin-top:16px;">
        Fermer
      </button>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
}

function createAlert() {
  const category = document.getElementById("alert-category").value;
  const city = document.getElementById("alert-city").value;
  
  if (!category) {
    showNotification("‚ö†Ô∏è Veuillez s√©lectionner une cat√©gorie", "warning");
    return;
  }
  
  // V√©rifier la limite selon l'abonnement
  const maxAlerts = getAlertLimit();
  if (maxAlerts === 0) {
    showNotification("‚ö†Ô∏è Les alertes n√©cessitent un abonnement Events Explorer ou sup√©rieur", "warning");
    openSubscriptionModal();
    return;
  }
  
  if (maxAlerts !== Infinity && currentUser.alerts.length >= maxAlerts) {
    showNotification(`‚ö†Ô∏è Limite atteinte (${maxAlerts} alertes) ! Passez √† Events Alertes Pro pour des alertes illimit√©es.`, "warning");
    openSubscriptionModal();
    return;
  }
  
  currentUser.alerts.push({ category, city, createdAt: new Date().toISOString() });
  showNotification("üîî Alerte cr√©√©e ! Vous serez notifi√© des nouveaux √©v√©nements et changements.", "success");
  openSubscriptionModal(); // Rafra√Æchir
}

function removeAlert(index) {
  currentUser.alerts.splice(index, 1);
  showNotification("üîï Alerte supprim√©e", "info");
  openSubscriptionModal(); // Rafra√Æchir
}

function selectPlan(plan) {
  if (plan === 'free') {
    currentUser.subscription = "free";
    showNotification("‚úÖ Plan gratuit actif", "info");
    updateSubscriptionBadge();
    openSubscriptionModal();
  } else if (plan === 'events-explorer') {
    openPremiumPaymentModal('events-explorer', 5);
  } else if (plan === 'events-alerts-pro') {
    openPremiumPaymentModal('events-alerts-pro', 10);
  } else if (plan === 'service-pro') {
    openPremiumPaymentModal('service-pro', 10);
  } else if (plan === 'service-ultra') {
    openPremiumPaymentModal('service-ultra', 18);
  } else if (plan === 'full-premium') {
    openPremiumPaymentModal('full-premium', 25);
  }
}

function openPremiumPaymentModal(plan = 'full-premium', price = 25) {
  const planInfo = {
    'events-explorer': { emoji: 'üå±', name: 'Events Explorer', color: '#22c55e', bg: 'rgba(34,197,94,0.2)' },
    'events-alerts-pro': { emoji: 'üîî', name: 'Events Alertes Pro', color: '#3b82f6', bg: 'rgba(59,130,246,0.2)' },
    'service-pro': { emoji: 'üíº', name: 'Service Pro', color: '#8b5cf6', bg: 'rgba(139,92,246,0.2)' },
    'service-ultra': { emoji: 'üöÄ', name: 'Service Ultra', color: '#a78bfa', bg: 'rgba(167,139,250,0.2)' },
    'full-premium': { emoji: 'üëë', name: 'Full Premium', color: '#ffd700', bg: 'rgba(255,215,0,0.2)' },
    // Anciens noms pour compatibilit√©
    'events-alerts': { emoji: 'üîî', name: 'Events Alertes Pro', color: '#3b82f6', bg: 'rgba(59,130,246,0.2)' },
    'booking-pro': { emoji: 'üíº', name: 'Service Pro', color: '#8b5cf6', bg: 'rgba(139,92,246,0.2)' },
    'booking-ultra': { emoji: 'üöÄ', name: 'Service Ultra', color: '#a78bfa', bg: 'rgba(167,139,250,0.2)' },
    'full': { emoji: 'üëë', name: 'Full Premium', color: '#ffd700', bg: 'rgba(255,215,0,0.2)' },
    explorer: { emoji: 'üå±', name: 'Explorer', color: '#22c55e', bg: 'rgba(34,197,94,0.2)' },
    pro: { emoji: 'üíº', name: 'Pro', color: '#8b5cf6', bg: 'rgba(139,92,246,0.2)' },
    premium: { emoji: '‚≠ê', name: 'Premium', color: '#ffd700', bg: 'rgba(255,215,0,0.2)' }
  };
  
  const info = planInfo[plan] || planInfo.full;
  
  const html = `
    <div style="padding:10px;text-align:center;">
      <div style="font-size:48px;margin-bottom:16px;">${info.emoji}</div>
      <h2 style="margin:0 0 10px;font-size:20px;">Passer en ${info.name}</h2>
      <p style="color:var(--ui-text-muted);margin-bottom:20px;">
        D√©bloquez toutes les fonctionnalit√©s ${info.name} !
      </p>
      
      <div style="background:linear-gradient(135deg,${info.bg},transparent);border:2px solid ${info.color};border-radius:16px;padding:20px;margin-bottom:20px;">
        <div style="font-size:32px;font-weight:800;color:${info.color};">CHF ${price.toFixed(2)}</div>
        <div style="font-size:12px;color:var(--ui-text-muted);">par mois ‚Ä¢ Sans engagement</div>
      </div>
      
      <div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:12px;padding:12px;margin-bottom:20px;">
        <div style="font-size:12px;font-weight:600;color:#22c55e;margin-bottom:4px;">üåç 70% ‚Üí Mission Plan√®te</div>
        <div style="font-size:11px;color:var(--ui-text-muted);">Votre contribution sauve la Terre</div>
      </div>
      
        <button onclick="processSubscriptionPayment('${plan}', ${price})" style="width:100%;padding:14px;border-radius:999px;border:none;background:linear-gradient(135deg,${info.color},${info.color}dd);color:${plan === 'premium' ? '#1f2937' : '#fff'};font-weight:700;cursor:pointer;font-size:16px;box-shadow:0 8px 24px ${info.color}66;">
          üí≥ Payer CHF ${price.toFixed(2)}/mois
        </button>
      
      <button onclick="openSubscriptionModal()" style="width:100%;margin-top:10px;padding:10px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;">
        Retour
      </button>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
}

async function processSubscriptionPayment(plan = 'full-premium', price = 25) {
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  try {
    showNotification("üí≥ Redirection vers le paiement...", "info");
    
    // Cr√©er une session Stripe Checkout pour abonnement
    const response = await fetch(`${window.API_BASE_URL}/payments/create-checkout-session`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id.toString(),
        paymentType: 'subscription',
        plan: plan,
        amount: price,
        currency: 'CHF',
        email: currentUser.email
      })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Erreur lors de la cr√©ation de la session');
    }
    
    const { sessionId, publicKey } = await response.json();
    
    // Initialiser Stripe si pas encore fait
    if (!stripe && publicKey) {
      initStripe(publicKey);
    }
    
    if (!stripe) {
      throw new Error('Stripe non disponible');
    }
    
    // Rediriger vers Stripe Checkout
    const result = await stripe.redirectToCheckout({ sessionId });
    
    if (result.error) {
      showNotification(`‚ùå Erreur : ${result.error.message}`, "error");
    }
  } catch (error) {
    console.error('Erreur abonnement:', error);
    showNotification(`‚ùå Erreur lors de l'abonnement : ${error.message}`, "error");
  }
}

// Fonction de compatibilit√© (fallback si Stripe √©choue)
function simulatePremiumPayment(plan = 'full-premium', price = 25) {
  processSubscriptionPayment(plan, price).catch(() => {
    // Fallback : simulation locale si l'API √©choue
    currentUser.subscription = plan;
    currentUser.agendaLimit = getAgendaLimit();
    currentUser.alertLimit = getAlertLimit();
    updateSubscriptionBadge();
    
    const planNames = {
      'events-explorer': 'üå± Events Explorer',
      'events-alerts-pro': 'üîî Events Alertes Pro',
      'service-pro': 'üíº Service Pro',
      'service-ultra': 'üöÄ Service Ultra',
      'full-premium': 'üëë Full Premium',
      'events-alerts': 'üîî Events Alertes Pro',
      'booking-pro': 'üíº Service Pro',
      'booking-ultra': 'üöÄ Service Ultra',
      'full': 'üëë Full Premium',
      explorer: 'üå± Explorer',
      pro: 'üíº Pro',
      premium: '‚≠ê Premium'
    };
    
    const planName = planNames[plan] || 'Premium';
    playPaymentSound();
    showNotification(`üíé Abonnement simul√© (mode d√©mo) : ${planName}`, "info");
    closePublishModal();
    openSubscriptionModal();
  });
}

// ============================================
// MODAL "√Ä PROPOS" - CLIC SUR LOGO MAPEVENT
// ============================================
function openAboutModal() {
  // R√©cup√©rer la date de derni√®re connexion
  const lastLogin = currentUser.lastLoginAt ? new Date(currentUser.lastLoginAt).toLocaleDateString('fr-FR', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  }) : 'Premi√®re visite';
  
  const html = `
    <div style="padding:24px;max-width:600px;margin:0 auto;max-height:85vh;overflow-y:auto;">
      <!-- Header avec logo -->
      <div style="text-align:center;margin-bottom:24px;">
        <div style="font-size:48px;margin-bottom:12px;">üó∫Ô∏è</div>
        <h2 style="margin:0;font-size:28px;font-weight:800;background:linear-gradient(90deg,#00ffc3,#3b82f6);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;">MAP EVENT</h2>
        <p style="color:var(--ui-text-muted);margin-top:8px;font-size:14px;">La plateforme √©v√©nementielle mondiale</p>
      </div>
      
      <!-- Contact -->
      <div style="background:linear-gradient(135deg,rgba(0,255,195,0.1),rgba(59,130,246,0.1));border:1px solid rgba(0,255,195,0.3);border-radius:16px;padding:16px;margin-bottom:20px;text-align:center;">
        <div style="font-size:14px;font-weight:600;color:#00ffc3;margin-bottom:8px;">üìß Contact</div>
        <a href="mailto:${MAPEVENT_CONTACT_EMAIL}" style="color:#3b82f6;font-size:16px;font-weight:600;text-decoration:none;">${MAPEVENT_CONTACT_EMAIL}</a>
      </div>
      
      <!-- √âtat actuel -->
      <div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:16px;padding:16px;margin-bottom:20px;">
        <div style="font-size:14px;font-weight:700;color:#22c55e;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
          <span>‚úÖ</span> Fonctionnalit√©s disponibles
        </div>
        <ul style="margin:0;padding-left:20px;color:var(--ui-text-main);font-size:13px;line-height:1.8;">
          <li><strong>Carte interactive</strong> - 3 modes : Events, Booking, Services</li>
          <li><strong>Filtres avanc√©s</strong> - Par cat√©gorie, date, distance</li>
          <li><strong>Popups d√©taill√©es</strong> - Infos compl√®tes sur chaque point</li>
          <li><strong>Comptes utilisateurs</strong> - Inscription, connexion, profil avec avatar</li>
          <li><strong>Favoris & Agenda</strong> - Sauvegardez vos √©v√©nements pr√©f√©r√©s</li>
          <li><strong>Likes & Commentaires</strong> - Interagissez avec la communaut√©</li>
          <li><strong>Signalements</strong> - Signalez les contenus inappropri√©s</li>
          <li><strong>Paiements Stripe</strong> - Abonnements et boosts s√©curis√©s</li>
          <li><strong>Multi-langues</strong> - FR, EN, ES, ZH, HI</li>
          <li><strong>Mode sombre</strong> - Design premium adaptatif</li>
        </ul>
      </div>
      
      <!-- Prochaines fonctionnalit√©s -->
      <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:16px;padding:16px;margin-bottom:20px;">
        <div style="font-size:14px;font-weight:700;color:#3b82f6;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
          <span>üöÄ</span> Prochaines √©tapes
        </div>
        <ul style="margin:0;padding-left:20px;color:var(--ui-text-main);font-size:13px;line-height:1.8;">
          <li><strong>106 langues</strong> - Traduction automatique mondiale</li>
          <li><strong>Safe Social</strong> - R√©seau social s√©curis√© et bienveillant</li>
          <li><strong>Messagerie</strong> - Discutez avec vos amis</li>
          <li><strong>Groupes</strong> - Cr√©ez des groupes comme WhatsApp</li>
          <li><strong>Invitations</strong> - Invitez vos amis aux √©v√©nements</li>
          <li><strong>Localisation live</strong> - Retrouvez vos amis sur place</li>
          <li><strong>Last Minute Tickets</strong> - Revente de billets s√©curis√©e</li>
          <li><strong>Transport partag√©</strong> - Covoiturage vers les events</li>
          <li><strong>Qu√™tes & Gamification</strong> - Gagnez des r√©compenses</li>
          <li><strong>Scraping 200+ events/pays</strong> - Donn√©es automatiques</li>
        </ul>
      </div>
      
      <!-- Derni√®re connexion -->
      ${currentUser.isLoggedIn ? `
        <div style="background:rgba(148,163,184,0.1);border:1px solid rgba(148,163,184,0.3);border-radius:16px;padding:16px;margin-bottom:20px;text-align:center;">
          <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:4px;">Derni√®re connexion</div>
          <div style="font-size:14px;font-weight:600;color:var(--ui-text-main);">${lastLogin}</div>
        </div>
      ` : `
        <div style="background:rgba(0,255,195,0.05);border:2px solid rgba(0,255,195,0.4);border-radius:16px;padding:20px;margin-bottom:20px;text-align:center;">
          <div style="font-size:15px;font-weight:700;color:#00ffc3;margin-bottom:12px;">üëã Bienvenue sur MapEvent !</div>
          <button onclick="closePublishModal();setTimeout(function(){if(typeof window.openAuthModal==='function'){window.openAuthModal('register');}else if(typeof window.showProRegisterForm==='function'){window.showProRegisterForm();}else if(typeof window.openRegisterModal==='function'){window.openRegisterModal();}},300);" style="width:100%;padding:14px 24px;border-radius:12px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-weight:700;font-size:16px;cursor:pointer;box-shadow:0 4px 20px rgba(0,255,195,0.4);" id="register-modal-btn">
            Cr√©er un compte
          </button>
        </div>
      `}
      
      <!-- Version -->
      <div style="text-align:center;color:var(--ui-text-muted);font-size:11px;margin-bottom:16px;">
        Version 1.0.0 ‚Ä¢ D√©cembre 2024 ‚Ä¢ Made with ‚ù§Ô∏è in Switzerland
      </div>
      
      <!-- Bouton fermer -->
      <button onclick="closePublishModal()" style="width:100%;padding:14px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-weight:600;font-size:14px;">
        Fermer
      </button>
    </div>
  `;
  
  showModalWithContent(html);
}

// ============================================
// MODAL D'ANNONCE - POINTS TEST
// ============================================
// openTestAnnouncementModal supprim√© - plus de points test

// ============================================
// SYST√àME D'AMIS ET MESSAGERIE
// ============================================

// Donn√©es des utilisateurs simul√©s (pour la d√©mo)
let allUsers = [];

// Initialiser des utilisateurs de d√©mo
function initDemoUsers() {
  if (allUsers.length > 0) return;
  
  const demoNames = [
    "Alex_DJ", "Sophie_Techno", "Marco_Festivals", "Julie_Dance", "Thomas_Music",
    "Emma_Events", "Lucas_Party", "L√©a_Vibes", "Hugo_Sound", "Camille_Beat",
    "Nathan_Bass", "Chlo√©_Electro", "Arthur_Rave", "Manon_House", "Th√©o_Groove"
  ];
  
  allUsers = demoNames.map((name, i) => {
    const avatar = AVAILABLE_AVATARS[i % AVAILABLE_AVATARS.length];
    return {
      id: `demo_user_${i + 1}`,
      name: name,
      avatar: avatar.emoji,
      avatarId: avatar.id,
      avatarDescription: `Fan de ${['techno', 'house', 'festivals', 'concerts', 'musique'][i % 5]}`,
      isOnline: Math.random() > 0.5,
      lastSeen: new Date(Date.now() - Math.random() * 86400000 * 7).toISOString()
    };
  });
}

// Ouvrir le modal des amis
function openFriendsModal() {
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  initDemoUsers();
  
  const friendsList = currentUser.friends || [];
  const friendRequests = currentUser.friendRequests || [];
  
  // Trouver les infos des amis
  const friendsInfo = friendsList.map(friendId => {
    return allUsers.find(u => u.id === friendId) || { id: friendId, name: 'Utilisateur', avatar: 'üë§' };
  });
  
  const html = `
    <div style="padding:20px;max-width:550px;margin:0 auto;max-height:85vh;overflow-y:auto;">
      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:40px;margin-bottom:8px;">üë•</div>
        <h2 style="margin:0;font-size:22px;font-weight:700;color:#fff;">Mes Amis</h2>
        <p style="color:var(--ui-text-muted);margin-top:6px;font-size:13px;">${friendsList.length} ami(s)</p>
      </div>
      
      <!-- Demandes d'amis en attente -->
      ${friendRequests.length > 0 ? `
        <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:14px;margin-bottom:16px;">
          <div style="font-size:13px;font-weight:600;color:#f59e0b;margin-bottom:10px;">üì¨ Demandes en attente (${friendRequests.length})</div>
          ${friendRequests.map(req => `
            <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(15,23,42,0.5);border-radius:10px;margin-bottom:8px;">
              <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:20px;">${req.fromUserAvatar || 'üë§'}</div>
              <div style="flex:1;">
                <div style="font-weight:600;font-size:14px;color:#fff;">${escapeHtml(req.fromUserName)}</div>
                <div style="font-size:11px;color:var(--ui-text-muted);">${new Date(req.date).toLocaleDateString('fr-FR')}</div>
              </div>
              <button onclick="acceptFriendRequest('${req.fromUserId}')" style="padding:6px 12px;border-radius:8px;border:none;background:#22c55e;color:#fff;font-size:12px;font-weight:600;cursor:pointer;">‚úì</button>
              <button onclick="declineFriendRequest('${req.fromUserId}')" style="padding:6px 12px;border-radius:8px;border:none;background:#ef4444;color:#fff;font-size:12px;font-weight:600;cursor:pointer;">‚úó</button>
            </div>
          `).join('')}
        </div>
      ` : ''}
      
      <!-- Rechercher des amis -->
      <div style="margin-bottom:16px;">
        <label style="display:block;font-size:13px;font-weight:600;color:#fff;margin-bottom:8px;">üîç Rechercher des utilisateurs</label>
        <input type="text" id="search-friends-input" placeholder="Nom d'utilisateur..." 
               onkeyup="searchUsers(this.value)"
               style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:14px;">
        <div id="search-friends-results" style="margin-top:10px;"></div>
      </div>
      
      <!-- Liste des amis -->
      <div style="margin-bottom:20px;">
        <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px;">üë´ Mes amis</div>
        ${friendsInfo.length > 0 ? friendsInfo.map(friend => `
          <div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(15,23,42,0.5);border-radius:12px;margin-bottom:8px;border:1px solid var(--ui-card-border);">
            <div style="position:relative;">
              <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:24px;">${friend.avatar}</div>
              <div style="position:absolute;bottom:2px;right:2px;width:12px;height:12px;border-radius:50%;background:${friend.isOnline ? '#22c55e' : '#6b7280'};border:2px solid var(--ui-card-bg);"></div>
            </div>
            <div style="flex:1;">
              <div style="font-weight:600;font-size:14px;color:#fff;">${escapeHtml(friend.name)}</div>
              <div style="font-size:11px;color:var(--ui-text-muted);">${friend.avatarDescription || ''}</div>
            </div>
            <button onclick="openChatWith('${friend.id}')" style="padding:8px 14px;border-radius:8px;border:none;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-size:12px;font-weight:600;cursor:pointer;">üí¨ Chat</button>
            <button onclick="removeFriend('${friend.id}')" style="padding:8px 10px;border-radius:8px;border:1px solid rgba(239,68,68,0.5);background:transparent;color:#ef4444;font-size:12px;cursor:pointer;">üóëÔ∏è</button>
          </div>
        `).join('') : `
          <div style="text-align:center;padding:30px;color:var(--ui-text-muted);">
            <div style="font-size:32px;margin-bottom:8px;">üîç</div>
            <p>Vous n'avez pas encore d'amis.<br>Recherchez des utilisateurs ci-dessus !</p>
          </div>
        `}
      </div>
      
      <button onclick="closePublishModal()" style="width:100%;padding:12px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-weight:600;">
        Fermer
      </button>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
}

// Ouvrir le modal des groupes
function openGroupsModal() {
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  // R√©cup√©rer les groupes de l'utilisateur (simulation)
  const userGroups = currentUser.groups || [];
  const registeredCountry = currentUser.registeredCountry || "CH";
  
  const html = `
    <div style="padding:20px;max-width:600px;margin:0 auto;max-height:85vh;overflow-y:auto;">
      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:40px;margin-bottom:8px;">üë•</div>
        <h2 style="margin:0;font-size:22px;font-weight:700;color:#fff;">Groupes</h2>
      </div>
      
      <!-- Sections principales -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
        <!-- Canaux par pays -->
        <div onclick="changeGroupCountry()" style="padding:20px;background:rgba(0,255,195,0.1);border:2px solid rgba(0,255,195,0.3);border-radius:12px;cursor:pointer;text-align:center;">
          <div style="font-size:32px;margin-bottom:8px;">üåç</div>
          <div style="font-weight:600;color:#00ffc3;margin-bottom:4px;">Par Pays</div>
          <div style="font-size:12px;color:var(--ui-text-muted);">${registeredCountry}</div>
        </div>
        
        <!-- Cat√©gories MapEvent -->
        <div onclick="openGroupChannel('category', 'events')" style="padding:20px;background:rgba(59,130,246,0.1);border:2px solid rgba(59,130,246,0.3);border-radius:12px;cursor:pointer;text-align:center;">
          <div style="font-size:32px;margin-bottom:8px;">üìÖ</div>
          <div style="font-weight:600;color:#3b82f6;margin-bottom:4px;">Events</div>
          <div style="font-size:12px;color:var(--ui-text-muted);">Discussion</div>
        </div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
        <div onclick="openGroupChannel('category', 'booking')" style="padding:20px;background:rgba(139,92,246,0.1);border:2px solid rgba(139,92,246,0.3);border-radius:12px;cursor:pointer;text-align:center;">
          <div style="font-size:32px;margin-bottom:8px;">üéµ</div>
          <div style="font-weight:600;color:#8b5cf6;margin-bottom:4px;">Booking</div>
          <div style="font-size:12px;color:var(--ui-text-muted);">Discussion</div>
        </div>
        
        <div onclick="openGroupChannel('category', 'services')" style="padding:20px;background:rgba(245,158,11,0.1);border:2px solid rgba(245,158,11,0.3);border-radius:12px;cursor:pointer;text-align:center;">
          <div style="font-size:32px;margin-bottom:8px;">üíº</div>
          <div style="font-weight:600;color:#f59e0b;margin-bottom:4px;">Services</div>
          <div style="font-size:12px;color:var(--ui-text-muted);">Discussion</div>
        </div>
      </div>
      
      <!-- Vos groupes -->
        <div style="margin-bottom:20px;">
        <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px;">üë• Vos groupes</div>
        ${userGroups.length > 0 ? userGroups.map(group => `
          <div onclick="openGroupChannel('custom', '${group.id}')" style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(15,23,42,0.5);border-radius:12px;margin-bottom:8px;border:1px solid var(--ui-card-border);cursor:pointer;">
              <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:24px;">${group.emoji || 'üë•'}</div>
              <div style="flex:1;">
                <div style="font-weight:600;font-size:14px;color:#fff;">${escapeHtml(group.name)}</div>
                <div style="font-size:11px;color:var(--ui-text-muted);">${group.memberCount || 0} membres</div>
              </div>
            </div>
        `).join('') : `
          <div style="text-align:center;padding:30px;color:var(--ui-text-muted);">
            <div style="font-size:32px;margin-bottom:8px;">üîç</div>
            <p>Vous n'avez pas encore de groupes.<br>Cr√©ez-en un ci-dessous !</p>
        </div>
        `}
      </div>
      
      <!-- Cr√©er un groupe -->
      <div onclick="createGroup()" style="padding:20px;background:linear-gradient(135deg,rgba(0,255,195,0.2),rgba(59,130,246,0.2));border:2px dashed rgba(0,255,195,0.5);border-radius:12px;cursor:pointer;text-align:center;margin-bottom:20px;">
        <div style="font-size:40px;margin-bottom:8px;">‚ûï</div>
        <div style="font-weight:700;color:#00ffc3;font-size:16px;">Cr√©er un groupe</div>
      </div>
      
      <button onclick="closePublishModal()" style="width:100%;padding:12px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-weight:600;">
        Fermer
      </button>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
}

// Mettre √† jour la fonction globale avec l'impl√©mentation compl√®te
// Cette assignation remplace le stub d√©fini plus t√¥t
window.openGroupsModal = openGroupsModal;

// Rechercher des utilisateurs
function searchUsers(query) {
  const resultsContainer = document.getElementById("search-friends-results");
  if (!resultsContainer) return;
  
  if (!query || query.length < 2) {
    resultsContainer.innerHTML = '';
    return;
  }
  
  initDemoUsers();
  
  const results = allUsers.filter(u => 
    u.name.toLowerCase().includes(query.toLowerCase()) && 
    u.id !== currentUser.id &&
    !currentUser.friends.includes(u.id)
  ).slice(0, 5);
  
  if (results.length === 0) {
    resultsContainer.innerHTML = '<div style="color:var(--ui-text-muted);font-size:12px;padding:10px;">Aucun utilisateur trouv√©</div>';
    return;
  }
  
  resultsContainer.innerHTML = results.map(user => `
    <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(0,255,195,0.05);border-radius:10px;margin-bottom:6px;border:1px solid rgba(0,255,195,0.2);">
      <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:18px;">${user.avatar}</div>
      <div style="flex:1;">
        <div style="font-weight:600;font-size:13px;color:#fff;">${escapeHtml(user.name)}</div>
        <div style="font-size:10px;color:var(--ui-text-muted);">${user.isOnline ? 'üü¢ En ligne' : '‚ö´ Hors ligne'}</div>
      </div>
      <button onclick="sendFriendRequest('${user.id}', '${escapeHtml(user.name)}', '${user.avatar}')" style="padding:6px 12px;border-radius:8px;border:none;background:#00ffc3;color:#000;font-size:11px;font-weight:600;cursor:pointer;">+ Ajouter</button>
    </div>
  `).join('');
}

// Envoyer une demande d'ami
function sendFriendRequest(userId, userName, userAvatar) {
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  if (!currentUser.sentRequests) currentUser.sentRequests = [];
  
  if (currentUser.sentRequests.includes(userId)) {
    showNotification("‚è≥ Demande d√©j√† envoy√©e", "info");
    return;
  }
  
  if (currentUser.friends.includes(userId)) {
    showNotification("‚úÖ D√©j√† ami avec cet utilisateur", "info");
    return;
  }
  
  currentUser.sentRequests.push(userId);
  
  // Simuler l'ajout d'une demande c√¥t√© destinataire (pour la d√©mo, on accepte automatiquement)
  setTimeout(() => {
    if (!currentUser.friends.includes(userId)) {
      currentUser.friends.push(userId);
      currentUser.sentRequests = currentUser.sentRequests.filter(id => id !== userId);
      showNotification(`üéâ ${userName} a accept√© votre demande d'ami !`, "success");
      saveUserData();
    }
  }, 2000);
  
  showNotification(`üì§ Demande envoy√©e √† ${userName}`, "success");
  saveUserData();
  openFriendsModal(); // Rafra√Æchir
}

// Accepter une demande d'ami
function acceptFriendRequest(fromUserId) {
  if (!currentUser.friendRequests) return;
  
  const request = currentUser.friendRequests.find(r => r.fromUserId === fromUserId);
  if (!request) return;
  
  // Ajouter comme ami
  if (!currentUser.friends.includes(fromUserId)) {
    currentUser.friends.push(fromUserId);
  }
  
  // Retirer de la liste des demandes
  currentUser.friendRequests = currentUser.friendRequests.filter(r => r.fromUserId !== fromUserId);
  
  showNotification(`üéâ Vous √™tes maintenant ami avec ${request.fromUserName} !`, "success");
  saveUserData();
  openFriendsModal(); // Rafra√Æchir
}

// Refuser une demande d'ami
function declineFriendRequest(fromUserId) {
  if (!currentUser.friendRequests) return;
  
  currentUser.friendRequests = currentUser.friendRequests.filter(r => r.fromUserId !== fromUserId);
  
  showNotification("‚ùå Demande refus√©e", "info");
  saveUserData();
  openFriendsModal(); // Rafra√Æchir
}

// Retirer un ami
function removeFriend(friendId) {
  if (!confirm("Voulez-vous vraiment retirer cet ami ?")) return;
  
  currentUser.friends = currentUser.friends.filter(id => id !== friendId);
  
  showNotification("üëã Ami retir√©", "info");
  saveUserData();
  openFriendsModal(); // Rafra√Æchir
}

// Ouvrir le chat avec un ami
function openChatWith(friendId) {
  initDemoUsers();
  const friend = allUsers.find(u => u.id === friendId) || { id: friendId, name: 'Utilisateur', avatar: 'üë§' };
  
  // R√©cup√©rer les messages existants
  const conversationKey = [currentUser.id, friendId].sort().join(':');
  if (!window.conversations) window.conversations = {};
  if (!window.conversations[conversationKey]) {
    window.conversations[conversationKey] = [
      { from: friendId, text: "Salut ! üëã", time: new Date(Date.now() - 3600000).toISOString() },
      { from: currentUser.id, text: "Hey ! Comment √ßa va ?", time: new Date(Date.now() - 3500000).toISOString() },
      { from: friendId, text: "Super bien, tu vas √† la soir√©e ce weekend ?", time: new Date(Date.now() - 3400000).toISOString() }
    ];
  }
  
  const messages = window.conversations[conversationKey] || [];
  
  const html = `
    <div style="display:flex;flex-direction:column;height:70vh;max-width:500px;margin:0 auto;">
      <!-- Header -->
      <div style="display:flex;align-items:center;gap:12px;padding:16px;border-bottom:1px solid var(--ui-card-border);">
        <button onclick="openFriendsModal()" style="width:36px;height:36px;border-radius:50%;border:none;background:rgba(15,23,42,0.9);color:#fff;cursor:pointer;font-size:16px;">‚Üê</button>
        <div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:22px;">${friend.avatar}</div>
        <div style="flex:1;">
          <div style="font-weight:600;font-size:16px;color:#fff;">${escapeHtml(friend.name)}</div>
          <div style="font-size:11px;color:${friend.isOnline ? '#22c55e' : 'var(--ui-text-muted)'};">${friend.isOnline ? 'üü¢ En ligne' : 'Hors ligne'}</div>
        </div>
        <button onclick="openReportModal('user', '${friendId}')" style="padding:8px;border-radius:8px;border:1px solid rgba(239,68,68,0.3);background:transparent;color:#ef4444;font-size:12px;cursor:pointer;">üö®</button>
      </div>
      
      <!-- Messages -->
      <div id="chat-messages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;">
        ${messages.map(msg => `
          <div style="display:flex;${msg.from === currentUser.id ? 'justify-content:flex-end;' : 'justify-content:flex-start;'}">
            <div style="max-width:75%;padding:10px 14px;border-radius:16px;${msg.from === currentUser.id ? 'background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;border-bottom-right-radius:4px;' : 'background:rgba(15,23,42,0.9);color:#fff;border-bottom-left-radius:4px;'}">
              <div style="font-size:14px;">${escapeHtml(msg.text)}</div>
              <div style="font-size:10px;opacity:0.7;margin-top:4px;text-align:right;">${new Date(msg.time).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</div>
            </div>
          </div>
        `).join('')}
      </div>
      
      <!-- Input -->
      <div style="padding:16px;border-top:1px solid var(--ui-card-border);display:flex;gap:10px;">
        <input type="text" id="chat-input" placeholder="Votre message..." 
               onkeypress="if(event.key==='Enter')sendChatMessage('${friendId}')"
               style="flex:1;padding:12px;border-radius:999px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.9);color:var(--ui-text-main);font-size:14px;">
        <button onclick="sendChatMessage('${friendId}')" style="width:48px;height:48px;border-radius:50%;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;cursor:pointer;font-size:20px;">‚û§</button>
      </div>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  
  // Scroll to bottom
  setTimeout(() => {
    const chatMessages = document.getElementById("chat-messages");
    if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
  }, 100);
}

// Envoyer un message
function sendChatMessage(friendId) {
  const input = document.getElementById("chat-input");
  if (!input || !input.value.trim()) return;
  
  const conversationKey = [currentUser.id, friendId].sort().join(':');
  if (!window.conversations) window.conversations = {};
  if (!window.conversations[conversationKey]) window.conversations[conversationKey] = [];
  
  window.conversations[conversationKey].push({
    from: currentUser.id,
    text: input.value.trim(),
    time: new Date().toISOString()
  });
  
  // Simuler une r√©ponse automatique (pour la d√©mo)
  setTimeout(() => {
    const autoResponses = [
      "Super ! üéâ",
      "Ah cool !",
      "On se retrouve l√†-bas ?",
      "J'ai h√¢te !",
      "Trop bien üëç",
      "√Ä bient√¥t !"
    ];
    window.conversations[conversationKey].push({
      from: friendId,
      text: autoResponses[Math.floor(Math.random() * autoResponses.length)],
      time: new Date().toISOString()
    });
    openChatWith(friendId); // Rafra√Æchir
  }, 1500);
  
  openChatWith(friendId); // Rafra√Æchir imm√©diatement pour montrer notre message
}

// Sauvegarder les donn√©es utilisateur
function saveUserData() {
  try {
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
  } catch (e) {
    console.error('Erreur sauvegarde:', e);
  }
}

// Exposer saveUser globalement pour compatibilit√©
window.saveUser = saveUserData;

// R√©cup√©rer les amis qui participent √† un √©v√©nement
function getFriendsParticipatingToEvent(eventId) {
  if (!currentUser.isLoggedIn || !currentUser.friends || currentUser.friends.length === 0) {
    return [];
  }
  
  initDemoUsers();
  
  // Simuler que certains amis participent √† des √©v√©nements (pour la d√©mo)
  // Dans la vraie impl√©mentation, cela viendrait du backend
  const friendsParticipating = [];
  
  currentUser.friends.forEach(friendId => {
    // Simuler une participation al√©atoire bas√©e sur l'ID de l'√©v√©nement
    const hashCode = (str) => {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash);
    };
    
    const combinedHash = hashCode(`${friendId}:${eventId}`);
    const participates = combinedHash % 5 === 0; // ~20% de chance de participer
    
    if (participates) {
      const friend = allUsers.find(u => u.id === friendId);
      if (friend) {
        friendsParticipating.push({
          id: friend.id,
          name: friend.name,
          avatar: friend.avatar
        });
      }
    }
  });
  
  return friendsParticipating;
}

// Charger l'utilisateur sauvegard√© au d√©marrage
// REMOVED: loadSavedUser() est maintenant dans auth.js et expos√© via window.loadSavedUser

// Fonctions helper pour le modal compte
function acceptFriendRequest(requestId) {
  const request = currentUser.friendRequests?.find(r => r.id === requestId);
  if (!request) return;
  
  // Ajouter aux amis
  if (!currentUser.friends) currentUser.friends = [];
  currentUser.friends.push({
    id: request.fromUserId,
    name: request.fromUserName,
    avatar: request.fromUserAvatar,
    username: request.username
  });
  
  // Retirer de la liste des demandes
  currentUser.friendRequests = currentUser.friendRequests.filter(r => r.id !== requestId);
  
  // Sauvegarder
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
  showNotification(`‚úÖ ${request.fromUserName} ajout√©(e) √† vos amis !`, 'success');
  
  // Rafra√Æchir le modal
  showAccountModalTab('amis');
}

function rejectFriendRequest(requestId) {
  currentUser.friendRequests = currentUser.friendRequests.filter(r => r.id !== requestId);
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
  showNotification('Demande d\'ami refus√©e', 'info');
  showAccountModalTab('amis');
}

function openUserProfile(userId) {
  showNotification('Profil utilisateur √† venir', 'info');
  // TODO: Impl√©menter l'ouverture du profil utilisateur
}

function openGroupDetails(groupId) {
  showNotification('D√©tails du groupe √† venir', 'info');
  // TODO: Impl√©menter l'ouverture des d√©tails du groupe
}

// ============================================
// COMPTE UTILISATEUR COMPLET - DESIGN PREMIUM
// ============================================
// Variable pour g√©rer l'onglet actif du modal Compte
let accountModalActiveTab = 'agenda';

function openAccountModal() {
  console.log('[ACCOUNT MODAL] openAccountModal appel√©e', {
    currentUser: currentUser ? { isLoggedIn: currentUser.isLoggedIn, email: currentUser.email } : null,
    getUserDisplayName: typeof getUserDisplayName,
    getUserAvatar: typeof getUserAvatar,
    windowGetUserDisplayName: typeof window.getUserDisplayName,
    windowGetUserAvatar: typeof window.getUserAvatar
  });
  
  if (!currentUser || !currentUser.isLoggedIn) {
    console.log('[ACCOUNT MODAL] Utilisateur non connect√©, ouverture modal login');
    openAuthModal('login');
    return;
  }
  
  let backdrop = document.getElementById('publish-modal-backdrop');
  let modal = document.getElementById('publish-modal-inner');
  
  if (!backdrop || !modal) {
    if (!backdrop) {
      backdrop = document.createElement('div');
      backdrop.id = 'publish-modal-backdrop';
      backdrop.style.cssText = 'position:fixed!important;inset:0!important;background:rgba(0,0,0,0.8)!important;z-index:99999!important;display:flex!important;align-items:center!important;justify-content:center!important;visibility:visible!important;opacity:1!important;padding:40px!important;box-sizing:border-box!important;';
      backdrop.onclick = function(e) {
        if (e.target === backdrop) closePublishModal();
      };
      document.body.appendChild(backdrop);
    }
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'publish-modal-inner';
      modal.style.cssText = 'background:#1e293b!important;border-radius:20px!important;padding:0!important;max-width:600px!important;width:90%!important;max-height:90vh!important;overflow-y:auto!important;';
      if (backdrop) backdrop.appendChild(modal);
    }
  }
  if (!backdrop || !modal) {
    console.error('[ACCOUNT MODAL] Impossible de cr√©er les √©l√©ments modal');
    return;
  }
  
  // Obtenir le nom d'affichage (utiliser window.getUserDisplayName si disponible)
  const getUserDisplayNameFunc = window.getUserDisplayName || getUserDisplayName;
  const getUserAvatarFunc = window.getUserAvatar || getUserAvatar;
  
  if (typeof getUserDisplayNameFunc !== 'function') {
    console.error('[ACCOUNT MODAL] getUserDisplayName n\'est pas une fonction');
    return;
  }
  if (typeof getUserAvatarFunc !== 'function') {
    console.error('[ACCOUNT MODAL] getUserAvatar n\'est pas une fonction');
    return;
  }
  
  // FORCER l'utilisation du username, jamais l'email
  // DEBUG: V√©rifier les donn√©es de currentUser AVANT traitement
  console.log('[ACCOUNT MODAL] currentUser AVANT traitement:', JSON.stringify({
    username: currentUser.username,
    email: currentUser.email,
    name: currentUser.name,
    profile_photo_url: currentUser.profile_photo_url ? currentUser.profile_photo_url.substring(0, 50) + '...' : null,
    profilePhoto: currentUser.profilePhoto ? currentUser.profilePhoto.substring(0, 50) + '...' : null,
    isLoggedIn: currentUser.isLoggedIn
  }));
  
  let displayName = currentUser.username || currentUser.name || 'Compte';
  if (!displayName || displayName === currentUser.email || displayName.includes('@')) {
    // Si c'est l'email ou vide, utiliser le username ou "Compte"
    displayName = currentUser.username || 'Compte';
  }
  
  // Si toujours pas de username, essayer de le r√©cup√©rer depuis le storage
  if (!displayName || displayName === 'Compte') {
    try {
      const storedUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
      if (storedUser) {
        const parsed = JSON.parse(storedUser);
        displayName = parsed.username || parsed.name || 'Compte';
        console.log('[ACCOUNT MODAL] Username r√©cup√©r√© depuis storage:', displayName);
        // Mettre √† jour currentUser avec les donn√©es du storage
        if (parsed.username && !currentUser.username) {
          currentUser.username = parsed.username;
        }
        if (parsed.profile_photo_url && !currentUser.profile_photo_url) {
          currentUser.profile_photo_url = parsed.profile_photo_url;
        }
      }
    } catch (e) {
      console.warn('[ACCOUNT MODAL] Erreur r√©cup√©ration storage:', e);
    }
  }
  
  // Nettoyer le nom (enlever caract√®res sp√©ciaux) - utiliser une fonction locale si cleanAccountText n'est pas disponible
  if (typeof cleanAccountText === 'function') {
    displayName = cleanAccountText(displayName) || 'Compte';
  } else {
    // Fallback : nettoyer manuellement
    displayName = displayName.replace(/[<>]/g, '').trim() || 'Compte';
  }
  
  const avatar = getUserAvatarFunc();
  
  console.log('[ACCOUNT MODAL] displayName final:', displayName, 'avatar:', avatar ? avatar.substring(0, 50) + '...' : 'null', 'currentUser.username:', currentUser.username);
  
  // Fonction pour cr√©er un avatar avec initiales (style Facebook)
  function getInitialsAvatar(name) {
    if (!name || name === "Compte") return "üë§";
    const parts = name.trim().split(/\s+/);
    let initials = "";
    if (parts.length >= 2) {
      initials = (parts[0][0] || "").toUpperCase() + (parts[parts.length - 1][0] || "").toUpperCase();
    } else if (parts.length === 1) {
      initials = parts[0].substring(0, 2).toUpperCase();
    }
    if (!initials) return "üë§";
    
    // Couleur de fond bas√©e sur le nom (pour avoir toujours la m√™me couleur pour le m√™me nom)
    const colors = [
      '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
      '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52BE80'
    ];
    const colorIndex = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % colors.length;
    const bgColor = colors[colorIndex];
    
    return `<div style="width:100%;height:100%;border-radius:50%;background:${bgColor};display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:32px;text-transform:uppercase;">${initials}</div>`;
  }
  
  // Cr√©er un avatar avec la premi√®re lettre du nom (comme Facebook) si pas de photo
  let avatarDisplay;
  
  // DEBUG: V√©rifier toutes les sources possibles de l'avatar
  console.log('[ACCOUNT MODAL] Avatar check - TOUTES les sources:', {
    avatar: avatar ? avatar.substring(0, 50) + '...' : 'null',
    profile_photo_url: currentUser.profile_photo_url ? currentUser.profile_photo_url.substring(0, 50) + '...' : 'null',
    profilePhoto: currentUser.profilePhoto ? currentUser.profilePhoto.substring(0, 50) + '...' : 'null',
    isHttp: avatar && avatar.startsWith('http'),
    isData: avatar && avatar.startsWith('data:image'),
    avatarLength: avatar ? avatar.length : 0
  });
  
  // Essayer de r√©cup√©rer l'avatar depuis currentUser si pas trouv√© dans avatar
  let finalAvatar = avatar;
  if ((!finalAvatar || finalAvatar === "üë§") && currentUser.profile_photo_url) {
    finalAvatar = currentUser.profile_photo_url;
    console.log('[ACCOUNT MODAL] Avatar r√©cup√©r√© depuis currentUser.profile_photo_url');
  }
  if ((!finalAvatar || finalAvatar === "üë§") && currentUser.profilePhoto) {
    finalAvatar = currentUser.profilePhoto;
    console.log('[ACCOUNT MODAL] Avatar r√©cup√©r√© depuis currentUser.profilePhoto');
  }
  
  if (finalAvatar && finalAvatar !== "üë§" && (finalAvatar.startsWith('http') || finalAvatar.startsWith('data:image'))) {
    // Utiliser directement l'URL - √©chapper seulement les guillemets doubles pour l'attribut HTML
    const safeAvatar = finalAvatar.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    // Obtenir les initiales et la couleur pour le fallback
    const initials = getInitials(displayName);
    const bgColor = getInitialsColor(displayName);
    // Cr√©er un conteneur avec l'image et un fallback cach√©
    avatarDisplay = `<div style="position:relative;width:100%;height:100%;"><img src="${safeAvatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;position:absolute;top:0;left:0;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" /><div style="display:none;width:100%;height:100%;border-radius:50%;background:${bgColor};display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:32px;text-transform:uppercase;position:absolute;top:0;left:0;">${initials}</div></div>`;
    console.log('[ACCOUNT MODAL] Avatar URL utilis√©e:', safeAvatar.substring(0, 100) + '...');
  } else {
    // Si pas de photo, afficher les initiales (comme Facebook)
    console.log('[ACCOUNT MODAL] Pas de photo valide, utilisation initiales pour:', displayName);
    avatarDisplay = getInitialsAvatar(displayName);
  }
  
  // Fonction helper pour obtenir les initiales
  function getInitials(name) {
    if (!name || name === "Compte") return "üë§";
    const parts = name.trim().split(/\s+/);
    if (parts.length >= 2) {
      return (parts[0][0] || "").toUpperCase() + (parts[parts.length - 1][0] || "").toUpperCase();
    } else if (parts.length === 1) {
      return parts[0].substring(0, 2).toUpperCase();
    }
    return "üë§";
  }
  
  // Fonction helper pour obtenir la couleur
  function getInitialsColor(name) {
    if (!name || name === "Compte") return '#4ECDC4';
    const colors = [
      '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
      '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52BE80'
    ];
    const colorIndex = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % colors.length;
    return colors[colorIndex];
  }
  
  console.log('[ACCOUNT MODAL] Donn√©es pr√©par√©es', { 
    displayName, 
    avatar: avatar ? avatar.substring(0, 50) + '...' : 'null',
    avatarDisplay: avatarDisplay ? avatarDisplay.substring(0, 100) + '...' : 'null',
    currentUser: currentUser ? {
      username: currentUser.username,
      email: currentUser.email,
      profile_photo_url: currentUser.profile_photo_url ? currentUser.profile_photo_url.substring(0, 50) + '...' : 'null',
      profilePhoto: currentUser.profilePhoto ? currentUser.profilePhoto.substring(0, 50) + '...' : 'null'
    } : null
  });
  
  // FORCER l'affichage du nom d'utilisateur - ne jamais utiliser l'email
  const finalDisplayName = displayName && displayName !== 'Compte' && !displayName.includes('@') ? displayName : (currentUser.username || 'Compte');
  console.log('[ACCOUNT MODAL] finalDisplayName:', finalDisplayName, 'displayName original:', displayName);
  
  // Compter les donn√©es pour les blocs
  const agendaCount = currentUser.agenda ? currentUser.agenda.length : 0;
  const favCount = currentUser.favorites ? currentUser.favorites.length : 0;
  const userEvents = eventsData.filter(e => e.creator_id && e.creator_id.toString() === (currentUser.id || '').toString());
  const userBookings = bookingsData.filter(b => b.creator_id && b.creator_id.toString() === (currentUser.id || '').toString());
  const annoncesCount = userEvents.length + userBookings.length;

  const html = `
    <div style="padding:28px 24px;max-width:600px;margin:0 auto;position:relative;">
      <!-- Bouton X -->
      <button onclick="closePublishModal()" style="position:absolute;top:12px;right:12px;background:none;border:none;color:var(--ui-text-muted);font-size:22px;cursor:pointer;padding:6px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s;z-index:10;" onmouseover="this.style.background='rgba(239,68,68,0.2)';this.style.color='#ef4444'" onmouseout="this.style.background='none';this.style.color='var(--ui-text-muted)'" title="Fermer">‚úï</button>
      
      <!-- En-t√™te avec avatar et nom -->
      <div style="text-align:center;margin-bottom:24px;">
        <div style="width:72px;height:72px;border-radius:50%;margin:0 auto 12px;background:rgba(0,255,195,0.1);border:3px solid rgba(0,255,195,0.3);display:flex;align-items:center;justify-content:center;font-size:36px;overflow:hidden;">
          ${avatarDisplay}
        </div>
        <h2 style="margin:0;font-size:22px;font-weight:700;color:#fff;" id="account-modal-display-name">${escapeHtml(finalDisplayName)}</h2>
        <p style="margin:6px 0 0;font-size:12px;color:var(--ui-text-muted);">${currentUser.email || ''}</p>
      </div>
      
      <!-- MAP FRIEND - Bloc pleine largeur, tr√®s visible -->
      <div onclick="closePublishModal();setTimeout(() => openMapFriendModal(), 300);" style="padding:18px 20px;border-radius:14px;background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(139,92,246,0.1));border:2px solid rgba(59,130,246,0.4);cursor:pointer;transition:all 0.3s;margin-bottom:20px;display:flex;align-items:center;gap:16px;" onmouseover="this.style.borderColor='rgba(59,130,246,0.8)';this.style.background='linear-gradient(135deg,rgba(59,130,246,0.25),rgba(139,92,246,0.15))';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(59,130,246,0.2)'" onmouseout="this.style.borderColor='rgba(59,130,246,0.4)';this.style.background='linear-gradient(135deg,rgba(59,130,246,0.15),rgba(139,92,246,0.1))';this.style.transform='translateY(0)';this.style.boxShadow='none'">
        <div style="font-size:36px;flex-shrink:0;">üåê</div>
        <div style="flex:1;text-align:left;">
          <div style="font-weight:700;font-size:16px;color:#fff;">Map Friend</div>
          <div style="font-size:12px;color:#93c5fd;margin-top:3px;">Fil social, partage d'events entre amis et messages</div>
        </div>
        <div style="font-size:18px;color:#60a5fa;flex-shrink:0;">‚Üí</div>
      </div>
      
      <!-- Blocs principaux avec descriptions -->
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px;">
        <div onclick="closePublishModal();setTimeout(() => openAgendaModal(), 300);" style="padding:16px;border-radius:14px;background:rgba(15,23,42,0.5);border:1px solid rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;text-align:center;" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(0,255,195,0.08)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.background='rgba(15,23,42,0.5)';this.style.transform='translateY(0)'">
          <div style="font-size:28px;margin-bottom:6px;">üìÖ</div>
          <div style="font-weight:600;font-size:13px;color:#fff;">Agenda</div>
          <div style="font-size:11px;color:#94a3b8;margin-top:4px;">${agendaCount > 0 ? agendaCount + ' √©v√©nement' + (agendaCount > 1 ? 's' : '') + ' sauvegard√©' + (agendaCount > 1 ? 's' : '') : 'Sauvegardez des events depuis la carte'}</div>
        </div>
        
        <div onclick="openAccountWindow('amis')" style="padding:16px;border-radius:14px;background:rgba(15,23,42,0.5);border:1px solid rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;text-align:center;" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(0,255,195,0.08)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.background='rgba(15,23,42,0.5)';this.style.transform='translateY(0)'">
          <div style="font-size:28px;margin-bottom:6px;">üë•</div>
          <div style="font-weight:600;font-size:13px;color:#fff;">Amis</div>
          <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Ajoutez des amis pour partager vos events</div>
        </div>
        
        <div onclick="openAccountWindow('notifications')" style="padding:16px;border-radius:14px;background:rgba(15,23,42,0.5);border:1px solid rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;text-align:center;" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(0,255,195,0.08)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.background='rgba(15,23,42,0.5)';this.style.transform='translateY(0)'">
          <div style="font-size:28px;margin-bottom:6px;">üîî</div>
          <div style="font-weight:600;font-size:13px;color:#fff;">Notifications</div>
          <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Invitations, rappels et mises √† jour</div>
        </div>
        
        <div onclick="openAccountWindow('parametres')" style="padding:16px;border-radius:14px;background:rgba(15,23,42,0.5);border:1px solid rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;text-align:center;" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(0,255,195,0.08)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.background='rgba(15,23,42,0.5)';this.style.transform='translateY(0)'">
          <div style="font-size:28px;margin-bottom:6px;">‚öôÔ∏è</div>
          <div style="font-weight:600;font-size:13px;color:#fff;">Param√®tres</div>
          <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Langue, th√®me et pr√©f√©rences</div>
        </div>
        
        <div onclick="openAccountWindow('profil')" style="padding:16px;border-radius:14px;background:rgba(15,23,42,0.5);border:1px solid rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;text-align:center;" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(0,255,195,0.08)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.background='rgba(15,23,42,0.5)';this.style.transform='translateY(0)'">
          <div style="font-size:28px;margin-bottom:6px;">üë§</div>
          <div style="font-weight:600;font-size:13px;color:#fff;">Profil</div>
          <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Voir votre profil public</div>
        </div>
        
        <div onclick="event.stopPropagation(); openAccountWindow('modifier-profil')" style="padding:16px;border-radius:14px;background:rgba(15,23,42,0.5);border:1px solid rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;text-align:center;" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(0,255,195,0.08)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.background='rgba(15,23,42,0.5)';this.style.transform='translateY(0)'">
          <div style="font-size:28px;margin-bottom:6px;">‚úèÔ∏è</div>
          <div style="font-weight:600;font-size:13px;color:#fff;">Modifier mon profil</div>
          <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Photo, bio et infos personnelles</div>
        </div>
      </div>
      
      <!-- Mes annonces - bloc pleine largeur -->
      <div onclick="event.stopPropagation(); openAccountWindow('mes-annonces')" style="padding:16px 20px;border-radius:14px;background:rgba(15,23,42,0.5);border:1px solid rgba(139,92,246,0.3);cursor:pointer;transition:all 0.3s;margin-bottom:20px;display:flex;align-items:center;gap:14px;" onmouseover="this.style.borderColor='rgba(139,92,246,0.6)';this.style.background='rgba(139,92,246,0.1)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='rgba(139,92,246,0.3)';this.style.background='rgba(15,23,42,0.5)';this.style.transform='translateY(0)'">
        <div style="font-size:28px;flex-shrink:0;">üì¢</div>
        <div style="flex:1;text-align:left;">
          <div style="font-weight:600;font-size:14px;color:#fff;">Mes annonces</div>
          <div style="font-size:11px;color:#a78bfa;margin-top:3px;">${annoncesCount > 0 ? annoncesCount + ' annonce' + (annoncesCount > 1 ? 's' : '') + ' publi√©e' + (annoncesCount > 1 ? 's' : '') : 'Publiez un event ou booking pour le voir appara√Ætre ici'}</div>
        </div>
        <div style="font-size:16px;color:#a78bfa;flex-shrink:0;">‚Üí</div>
      </div>
      
      <!-- Bouton Installation PWA (visible uniquement sur mobile) -->
      <button id="account-pwa-install-btn" style="display:none;width:100%;margin-bottom:16px;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-weight:600;font-size:13px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.opacity='0.9';" onmouseout="this.style.opacity='1';">
        üì± Installer l'app mobile
      </button>
      
      <!-- Blocs suppl√©mentaires pour mobile (cach√©s sur desktop) -->
      <div id="account-mobile-extras" style="display:none;margin-bottom:16px;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <button onclick="openSubscriptionView()" style="padding:10px;border-radius:10px;border:1px solid rgba(148,163,184,0.2);background:rgba(255,255,255,0.04);color:var(--ui-text-main);cursor:pointer;font-size:12px;display:flex;flex-direction:column;align-items:center;gap:3px;">
            <span style="font-size:16px;">üíé</span>
            <span>Abos</span>
          </button>
          <button onclick="openProximityAlertsView()" style="padding:10px;border-radius:10px;border:1px solid rgba(148,163,184,0.2);background:rgba(255,255,255,0.04);color:var(--ui-text-main);cursor:pointer;font-size:12px;display:flex;flex-direction:column;align-items:center;gap:3px;">
            <span style="font-size:16px;">üîî</span>
            <span>Alertes</span>
          </button>
          <button onclick="openCartModal()" style="padding:10px;border-radius:10px;border:1px solid rgba(148,163,184,0.2);background:rgba(255,255,255,0.04);color:var(--ui-text-main);cursor:pointer;font-size:12px;display:flex;flex-direction:column;align-items:center;gap:3px;">
            <span style="font-size:16px;">üõí</span>
            <span>Panier</span>
          </button>
          <button onclick="openEcoMissionModal()" style="padding:10px;border-radius:10px;border:1px solid rgba(148,163,184,0.2);background:rgba(255,255,255,0.04);color:var(--ui-text-main);cursor:pointer;font-size:12px;display:flex;flex-direction:column;align-items:center;gap:3px;">
            <span style="font-size:16px;">üåç</span>
            <span>Sauver la Terre</span>
          </button>
        </div>
      </div>
      
      <!-- Blocs fins : Rester connect√©, D√©connexion, Supprimer -->
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div id="account-block-content" style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-radius:10px;background:rgba(0,255,195,0.05);border:1px solid rgba(0,255,195,0.15);cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(0,255,195,0.3)'" onmouseout="this.style.borderColor='rgba(0,255,195,0.15)'">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:18px;">üîê</span>
            <div>
              <div style="font-weight:600;font-size:13px;color:#fff;">Rester connect√©</div>
              <div style="font-size:11px;color:var(--ui-text-muted);">Reconnexion automatique</div>
            </div>
          </div>
          <label style="position:relative;display:inline-block;width:44px;height:22px;cursor:pointer;" onclick="event.stopPropagation()">
            <input type="checkbox" id="account-remember-me-toggle" style="opacity:0;width:0;height:0;" />
            <span id="account-remember-me-slider" style="position:absolute;top:0;left:0;right:0;bottom:0;background-color:rgba(255,255,255,0.2);border-radius:22px;transition:all 0.3s;"></span>
            <span id="account-remember-me-knob" style="position:absolute;top:2px;left:2px;width:18px;height:18px;background-color:#fff;border-radius:50%;transition:all 0.3s;box-shadow:0 2px 4px rgba(0,0,0,0.2);"></span>
          </label>
        </div>
        
        <div id="account-logout-btn" style="display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:10px;background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15);cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(239,68,68,0.4)';this.style.background='rgba(239,68,68,0.12)'" onmouseout="this.style.borderColor='rgba(239,68,68,0.15)';this.style.background='rgba(239,68,68,0.06)'">
          <span style="font-size:18px;">üö™</span>
          <div style="font-weight:600;font-size:13px;color:#ef4444;">Se d√©connecter</div>
        </div>
        
        <div id="account-delete-btn" style="display:flex;align-items:center;gap:10px;padding:10px 16px;border-radius:10px;background:transparent;border:1px solid rgba(148,163,184,0.1);cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(239,68,68,0.3)';this.style.background='rgba(239,68,68,0.05)'" onmouseout="this.style.borderColor='rgba(148,163,184,0.1)';this.style.background='transparent'">
          <span style="font-size:16px;">üóëÔ∏è</span>
          <div style="font-size:12px;color:var(--ui-text-muted);">Supprimer mon compte</div>
        </div>
      </div>
    </div>
  `;
  
  modal.innerHTML = html;
  modal.style.display = 'block';
  modal.style.visibility = 'visible';
  modal.style.opacity = '1';
  backdrop.style.display = 'flex';
  backdrop.style.visibility = 'visible';
  backdrop.style.opacity = '1';
  backdrop.style.zIndex = '9999';
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Attacher les event listeners apr√®s injection HTML (CSP)
  setTimeout(() => {
    const logoutBtn = document.getElementById('account-logout-btn');
    const deleteBtn = document.getElementById('account-delete-btn');
    const rememberMeToggle = document.getElementById('account-remember-me-toggle');
    const rememberMeSlider = document.getElementById('account-remember-me-slider');
    const rememberMeKnob = document.getElementById('account-remember-me-knob');
    const pwaInstallBtn = document.getElementById('account-pwa-install-btn');
    const mobileExtras = document.getElementById('account-mobile-extras');
    
    // Afficher les √©l√©ments mobile si on est sur mobile
    const isMobile = window.innerWidth <= 768;
    if (isMobile) {
      // Afficher les extras mobile (abos, alertes, panier, etc.)
      if (mobileExtras) {
        mobileExtras.style.display = 'block';
      }
      
      // Afficher le bouton d'installation PWA si disponible
      if (pwaInstallBtn && (window.pwaInstallPrompt || !window.isPWAInstalled)) {
        pwaInstallBtn.style.display = 'block';
        pwaInstallBtn.addEventListener('click', () => {
          if (typeof window.installPWA === 'function') {
            window.installPWA();
          }
        });
      }
    }
    
    // Initialiser le toggle "Rester connect√©" avec la valeur actuelle
    const currentRememberMe = localStorage.getItem('rememberMe') === 'true';
    if (rememberMeToggle) {
      rememberMeToggle.checked = currentRememberMe;
      updateRememberMeToggleUI(currentRememberMe, rememberMeSlider, rememberMeKnob);
    }
    
    // Event listener pour le toggle "Rester connect√©"
    if (rememberMeToggle) {
      rememberMeToggle.addEventListener('change', (e) => {
        const checked = e.target.checked;
        localStorage.setItem('rememberMe', checked ? 'true' : 'false');
        updateRememberMeToggleUI(checked, rememberMeSlider, rememberMeKnob);
        console.log('[ACCOUNT MODAL] "Rester connect√©" chang√©:', checked);
        if (typeof showNotification === 'function') {
          showNotification(checked ? '‚úÖ Vous serez reconnect√© automatiquement' : '‚ÑπÔ∏è Vous devrez vous reconnecter √† la prochaine visite', 'info');
        }
      });
    }
    
    // Fonction helper pour mettre √† jour l'UI du toggle
    function updateRememberMeToggleUI(checked, slider, knob) {
      if (slider && knob) {
        if (checked) {
          slider.style.backgroundColor = 'rgba(0,255,195,0.5)';
          knob.style.transform = 'translateX(24px)';
          knob.style.backgroundColor = '#00ffc3';
        } else {
          slider.style.backgroundColor = 'rgba(255,255,255,0.2)';
          knob.style.transform = 'translateX(0)';
          knob.style.backgroundColor = '#fff';
        }
      }
    }
    
    if (logoutBtn) {
      logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('[ACCOUNT MODAL] Bouton "Se d√©connecter" cliqu√©');
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FLUX STANDARD : D√©connexion simple (sans demander "rester connect√©")
        // La valeur du toggle est d√©j√† sauvegard√©e dans localStorage
        if (typeof window.logout === 'function') {
          window.logout();
        } else if (typeof window.performLogout === 'function') {
          // Utiliser la valeur actuelle du toggle pour la d√©connexion
          const rememberMeValue = rememberMeToggle ? rememberMeToggle.checked : false;
          console.log('[ACCOUNT MODAL] D√©connexion avec rememberMe:', rememberMeValue);
          
          // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è D√âCONNEXION COMPL√àTE : Rafra√Æchir la page pour r√©initialiser tout
          if (!rememberMeValue) {
            console.log('[ACCOUNT MODAL] ‚úÖ D√©connexion compl√®te - Rafra√Æchissement de la page');
            window.performLogout(false);
            // Attendre un peu pour que la d√©connexion se termine, puis rafra√Æchir
            setTimeout(() => {
              window.location.reload();
            }, 300);
          } else {
            // D√©connexion avec "rester connect√©" activ√© - pas de rafra√Æchissement
            window.performLogout(true);
          }
        } else {
          console.error('[ACCOUNT MODAL] ‚ùå Fonction logout non trouv√©e');
          alert('Erreur: fonction de d√©connexion non disponible');
        }
      }, { capture: true });
    }
    
    if (deleteBtn) {
      deleteBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('[ACCOUNT MODAL] Bouton "Supprimer mon compte" cliqu√©');
        if (typeof showDeleteAccountConfirmation === 'function') {
          showDeleteAccountConfirmation();
        } else {
          console.error('[ACCOUNT MODAL] ‚ùå Fonction showDeleteAccountConfirmation non trouv√©e');
        }
      }, { capture: true });
    }
    
    console.log('[ACCOUNT MODAL] ‚úÖ Event listeners attach√©s', { logoutBtn: !!logoutBtn, deleteBtn: !!deleteBtn, rememberMeToggle: !!rememberMeToggle });
  }, 100);
  
  console.log('[ACCOUNT MODAL] Modal affich√©', {
    backdropDisplay: backdrop.style.display,
    modalDisplay: modal.style.display,
    htmlLength: html.length,
    backdropComputed: window.getComputedStyle(backdrop).display,
    modalComputed: window.getComputedStyle(modal).display
  });
}

// Fonction pour afficher la confirmation de suppression de compte
function showDeleteAccountConfirmation() {
  const backdrop = document.getElementById('publish-modal-backdrop');
  const modal = document.getElementById('publish-modal-inner');
  
  if (!backdrop || !modal) return;
  
  const html = `
    <div style="padding:40px;max-width:500px;margin:0 auto;text-align:center;">
      <div style="font-size:64px;margin-bottom:20px;">‚ö†Ô∏è</div>
      <h2 style="margin:0 0 16px;font-size:24px;font-weight:700;color:#fff;">Supprimer mon compte</h2>
      <p style="margin:0 0 24px;font-size:14px;color:var(--ui-text-muted);line-height:1.6;">
        Cette action est <strong style="color:#ef4444;">irr√©versible</strong>. Toutes vos donn√©es seront d√©finitivement supprim√©es :
      </p>
      <ul style="text-align:left;margin:0 0 24px;padding-left:20px;color:var(--ui-text-muted);font-size:13px;line-height:2;">
        <li>Votre profil et vos informations personnelles</li>
        <li>Tous vos √©v√©nements cr√©√©s</li>
        <li>Vos avis et commentaires</li>
        <li>Vos favoris et participations</li>
        <li>Vos alertes et notifications</li>
      </ul>
      <p style="margin:0 0 24px;font-size:13px;color:var(--ui-text-muted);">
        √ätes-vous s√ªr de vouloir continuer ?
      </p>
      <div style="display:flex;gap:12px;">
        <button onclick="closePublishModal();" style="flex:1;padding:12px;border-radius:12px;border:2px solid rgba(255,255,255,0.2);background:transparent;color:#fff;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.4)';this.style.background='rgba(255,255,255,0.1)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.2)';this.style.background='transparent';">
          Annuler
        </button>
        <button onclick="confirmDeleteAccount();" style="flex:1;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;font-weight:700;font-size:14px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='0 4px 12px rgba(239,68,68,0.4)';" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none';">
          Oui, supprimer
        </button>
      </div>
    </div>
  `;
  
  modal.innerHTML = html;
}

// Fonction pour confirmer et ex√©cuter la suppression du compte
async function confirmDeleteAccount() {
  if (!currentUser || !currentUser.isLoggedIn) {
    showNotification('‚ùå Vous devez √™tre connect√© pour supprimer votre compte', 'error');
    return;
  }
  
  // Demander une confirmation finale
  const finalConfirm = confirm('‚ö†Ô∏è DERNI√àRE CONFIRMATION\n\nCette action supprimera d√©finitivement votre compte et toutes vos donn√©es.\n\nCette action est IRR√âVERSIBLE.\n\nVoulez-vous vraiment continuer ?');
  
  if (!finalConfirm) {
    return;
  }
  
  try {
    showNotification('üóëÔ∏è Suppression du compte en cours...', 'info');
    
    const token = localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
    if (!token) {
      showNotification('‚ùå Token d\'authentification manquant', 'error');
      return;
    }
    
    const response = await fetch(`${window.API_BASE_URL}/user/account`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        confirm: true
      })
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      if (result.code === 'CONFIRMATION_REQUIRED') {
        showNotification('‚ùå Confirmation requise pour supprimer le compte', 'error');
      } else {
        showNotification(`‚ùå Erreur: ${result.error || 'Impossible de supprimer le compte'}`, 'error');
      }
      return;
    }
    
    // Suppression r√©ussie - tout supprimer (compte n'existe plus)
    showNotification('‚úÖ Compte supprim√© avec succ√®s', 'success');
    
    localStorage.removeItem('currentUser');
    sessionStorage.removeItem('currentUser');
    localStorage.removeItem('accessToken');
    localStorage.removeItem('refreshToken');
    localStorage.removeItem('rememberMe');
    sessionStorage.removeItem('accessToken');
    sessionStorage.removeItem('refreshToken');
    sessionStorage.removeItem('rememberMe');
    
    currentUser = getDefaultUser();
    currentUser = null;
    
    // Fermer le modal
    closePublishModal();
    
    // Recharger la page apr√®s 2 secondes
    setTimeout(() => {
      window.location.reload();
    }, 2000);
    
  } catch (error) {
    console.error('Erreur suppression compte:', error);
    showNotification('‚ùå Erreur lors de la suppression du compte. Veuillez r√©essayer.', 'error');
  }
}

// Fonction pour ouvrir une fen√™tre externe pour chaque bloc
function openAccountWindow(blockType) {
  console.log('[ACCOUNT WINDOW] Ouverture fen√™tre pour:', blockType);
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Ne pas fermer le modal si c'est pour modifier-profil
  // Car openEditProfileModal a besoin que le modal soit ouvert
  if (blockType !== 'modifier-profil') {
    closePublishModal();
  }
  
  // Cr√©er une nouvelle fen√™tre avec le contenu du bloc
  const windowFeatures = 'width=600,height=700,scrollbars=yes,resizable=yes';
  const windowName = `account_${blockType}_${Date.now()}`;
  
  // Cr√©er le HTML pour la fen√™tre
  let windowContent = '';
  
  if (blockType === 'agenda') {
    const agendaItems = (currentUser.agenda || []).map(key => {
      const [type, id] = key.split(":");
      const data = type === "event" ? eventsData : type === "booking" ? bookingsData : servicesData;
      return data.find(i => i.id === parseInt(id));
    }).filter(Boolean);
    
    windowContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Mon Agenda - MapEvent</title>
        <style>
          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #fff; margin: 0; padding: 20px; }
          h1 { margin: 0 0 20px; font-size: 24px; }
        </style>
      </head>
      <body>
        <h1>üìÖ Mon Agenda</h1>
        ${agendaItems.length === 0 ? '<p>Votre agenda est vide</p>' : agendaItems.map(item => `<div style="padding:12px;margin-bottom:8px;background:rgba(15,23,42,0.5);border-radius:8px;">${escapeHtml(item.title || item.name || 'Sans titre')}</div>`).join('')}
      </body>
      </html>
    `;
  } else if (blockType === 'amis') {
    openFriendsModal();
    return;
  } else if (blockType === 'notifications') {
    openNotificationsModal();
    return;
  } else if (blockType === 'modifier-profil') {
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Pour modifier-profil, afficher le formulaire dans le modal au lieu d'une nouvelle fen√™tre
    console.log('[ACCOUNT WINDOW] modifier-profil d√©tect√© - Affichage dans modal au lieu de nouvelle fen√™tre');
    
    // Essayer d'abord showAccountBlockContent (affiche dans le modal)
    if (typeof showAccountBlockContent === 'function') {
      console.log('[ACCOUNT WINDOW] Utilisation showAccountBlockContent pour modifier-profil');
      showAccountBlockContent('modifier-profil');
      return; // Ne pas ouvrir de nouvelle fen√™tre
    }
    
    // Fallback : ouvrir le formulaire d'√©dition complet
    if (typeof window.openEditProfileModal === 'function') {
      console.log('[ACCOUNT WINDOW] Utilisation window.openEditProfileModal (fallback)');
      window.openEditProfileModal();
      return;
    } else if (typeof openEditProfileModal === 'function') {
      console.log('[ACCOUNT WINDOW] Utilisation openEditProfileModal (fallback)');
      openEditProfileModal();
      return;
    } else {
      console.error('[ACCOUNT WINDOW] ‚ùå Aucune fonction disponible pour modifier-profil');
      showNotification('‚ö†Ô∏è Fonctionnalit√© en cours de d√©veloppement', 'info');
      return;
    }
  } else if (blockType === 'mes-annonces') {
    // ‚úÖ MES ANNONCES - Afficher dans un modal
    console.log('[ACCOUNT WINDOW] mes-annonces d√©tect√© - Ouverture du modal Mes annonces');
    showMesAnnoncesModal();
    return;
  } else {
    // Pour les autres blocs, utiliser showAccountBlockContent dans une nouvelle fen√™tre
    windowContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>${blockType} - MapEvent</title>
        <style>
          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #fff; margin: 0; padding: 20px; }
        </style>
      </head>
      <body>
        <p>Fonctionnalit√© √† venir</p>
      </body>
      </html>
    `;
  }
  
  try {
    const newWindow = window.open('', windowName, windowFeatures);
    if (newWindow) {
      newWindow.document.write(windowContent);
      newWindow.document.close();
      console.log('[ACCOUNT WINDOW] Fen√™tre ouverte avec succ√®s:', windowName);
    } else {
      console.error('[ACCOUNT WINDOW] √âchec ouverture fen√™tre - popup bloqu√©e?');
      alert('Veuillez autoriser les popups pour cette fonctionnalit√©');
    }
  } catch (e) {
    console.error('[ACCOUNT WINDOW] Erreur ouverture fen√™tre:', e);
    alert('Erreur lors de l\'ouverture de la fen√™tre: ' + e.message);
  }
}

// Fonction pour demander "rester connect√©" avant d√©connexion
function askRememberMeBeforeLogout() {
  console.log('[LOGOUT] Demande "rester connect√©" avant d√©connexion');
  
  // Trouver le modal pour afficher la question (NE PAS FERMER AVANT)
  const modal = document.getElementById('publish-modal-inner');
  const backdrop = document.getElementById('publish-modal-backdrop');
  
  if (!modal || !backdrop) {
    console.error('[LOGOUT] Modal non trouv√©, d√©connexion directe');
    if (typeof window.logout === 'function') {
      window.logout();
    }
    return;
  }
  
  const rememberMeHtml = `
    <div style="padding:40px;max-width:500px;margin:0 auto;text-align:center;position:relative;">
      <!-- Bouton X pour fermer -->
      <button onclick="closePublishModal();" style="position:absolute;top:16px;right:16px;background:none;border:none;color:var(--ui-text-muted);font-size:24px;cursor:pointer;padding:8px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s;z-index:10;" onmouseover="this.style.background='rgba(239,68,68,0.2)';this.style.color='#ef4444';this.style.transform='scale(1.1)';" onmouseout="this.style.background='none';this.style.color='var(--ui-text-muted)';this.style.transform='scale(1)';" title="Fermer">‚úï</button>
      
      <div style="font-size:48px;margin-bottom:24px;">üëã</div>
      <h2 style="margin:0 0 16px;font-size:24px;font-weight:700;color:#fff;">Voulez-vous rester connect√© ?</h2>
      <p style="margin:0 0 32px;font-size:14px;color:var(--ui-text-muted);line-height:1.6;">
        Si vous choisissez "Oui", vous resterez connect√© pour la prochaine fois.<br>
        Si vous choisissez "Non", vous devrez vous reconnecter √† chaque visite.
      </p>
      
      <div style="display:flex;gap:12px;justify-content:center;">
        <button id="logout-yes-btn" style="flex:1;padding:14px;border-radius:12px;border:2px solid rgba(34,197,94,0.5);background:rgba(34,197,94,0.1);color:#22c55e;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.background='rgba(34,197,94,0.2)';this.style.borderColor='rgba(34,197,94,0.7)';" onmouseout="this.style.background='rgba(34,197,94,0.1)';this.style.borderColor='rgba(34,197,94,0.5)';">
          Oui, rester connect√©
        </button>
        <button id="logout-no-btn" style="flex:1;padding:14px;border-radius:12px;border:2px solid rgba(239,68,68,0.5);background:rgba(239,68,68,0.1);color:#ef4444;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.background='rgba(239,68,68,0.2)';this.style.borderColor='rgba(239,68,68,0.7)';" onmouseout="this.style.background='rgba(239,68,68,0.1)';this.style.borderColor='rgba(239,68,68,0.5)';">
          Non, me d√©connecter
        </button>
      </div>
      
      <button onclick="closePublishModal();" style="margin-top:16px;padding:10px 20px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:var(--ui-text-muted);font-weight:500;font-size:13px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.1)';" onmouseout="this.style.background='transparent';">
        Annuler
      </button>
    </div>
  `;
  
  // Injecter le HTML dans le modal
  modal.innerHTML = rememberMeHtml;
  
  // FORCER l'affichage du modal
  modal.style.display = 'block';
  modal.style.visibility = 'visible';
  modal.style.opacity = '1';
  backdrop.style.display = 'flex';
  backdrop.style.visibility = 'visible';
  backdrop.style.opacity = '1';
  backdrop.style.zIndex = '9999';
  
  // Attacher les event listeners aux boutons imm√©diatement apr√®s injection
  // Utiliser requestAnimationFrame pour garantir que le DOM est pr√™t
  requestAnimationFrame(() => {
    const yesBtn = document.getElementById('logout-yes-btn');
    const noBtn = document.getElementById('logout-no-btn');
    
    console.log('[LOGOUT] Recherche boutons:', { yesBtn: !!yesBtn, noBtn: !!noBtn });
    
    if (yesBtn) {
      // Supprimer l'ancien listener s'il existe en clonant le bouton
      const newYesBtn = yesBtn.cloneNode(true);
      yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
      newYesBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('[LOGOUT] ‚úÖ Bouton "Oui" cliqu√©');
        if (typeof window.confirmLogoutWithRememberMe === 'function') {
          window.confirmLogoutWithRememberMe(true);
        } else if (typeof confirmLogoutWithRememberMe === 'function') {
          confirmLogoutWithRememberMe(true);
        } else {
          console.error('[LOGOUT] ‚ùå confirmLogoutWithRememberMe non trouv√©');
        }
      });
      console.log('[LOGOUT] ‚úÖ Event listener attach√© au bouton "Oui"');
    } else {
      console.error('[LOGOUT] ‚ùå Bouton "Oui" non trouv√© dans le DOM');
    }
    
    if (noBtn) {
      // Supprimer l'ancien listener s'il existe en clonant le bouton
      const newNoBtn = noBtn.cloneNode(true);
      noBtn.parentNode.replaceChild(newNoBtn, noBtn);
      newNoBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('[LOGOUT] ‚úÖ Bouton "Non" cliqu√©');
        if (typeof window.confirmLogoutWithRememberMe === 'function') {
          window.confirmLogoutWithRememberMe(false);
        } else if (typeof confirmLogoutWithRememberMe === 'function') {
          confirmLogoutWithRememberMe(false);
        } else {
          console.error('[LOGOUT] ‚ùå confirmLogoutWithRememberMe non trouv√©');
        }
      });
      console.log('[LOGOUT] ‚úÖ Event listener attach√© au bouton "Non"');
    } else {
      console.error('[LOGOUT] ‚ùå Bouton "Non" non trouv√© dans le DOM');
    }
    
    console.log('[LOGOUT] ‚úÖ Modal "rester connect√©" affich√©, boutons attach√©s');
  });
}

// Fonction pour confirmer la d√©connexion avec choix "rester connect√©"
function confirmLogoutWithRememberMe(rememberMe) {
  console.log('[LOGOUT] Confirmation d√©connexion, rememberMe:', rememberMe);
  
  // Sauvegarder le choix "rester connect√©" AVANT d√©connexion
  try {
    if (rememberMe) {
      // Garder les tokens dans localStorage pour la prochaine fois
      const accessToken = localStorage.getItem('access_token') || localStorage.getItem('accessToken') || sessionStorage.getItem('access_token') || sessionStorage.getItem('accessToken');
      const refreshToken = localStorage.getItem('refresh_token') || localStorage.getItem('refreshToken') || sessionStorage.getItem('refresh_token') || sessionStorage.getItem('refreshToken');
      if (accessToken) {
        localStorage.setItem('access_token', accessToken);
        localStorage.setItem('refresh_token', refreshToken || '');
        localStorage.setItem('rememberMe', 'true');
        console.log('[LOGOUT] Tokens sauvegard√©s dans localStorage pour la prochaine fois');
      }
    } else {
      // Tokens JAMAIS supprim√©s - r√®gle: toujours conserver
      localStorage.setItem('rememberMe', 'true');
      console.log('[LOGOUT] Tokens conserv√©s');
    }
  } catch (e) {
    console.warn('[LOGOUT] Erreur sauvegarde tokens:', e);
  }
  
  // Fermer le modal
  if (typeof closePublishModal === 'function') {
    closePublishModal();
  }
  
  // D√©connecter l'utilisateur
  if (typeof window.logout === 'function') {
    window.logout();
  } else if (typeof logout === 'function') {
    logout();
  } else {
    console.error('[LOGOUT] Fonction logout non trouv√©e');
    // Fallback : nettoyer manuellement
    if (typeof window !== 'undefined' && window.currentUser) {
      window.currentUser.isLoggedIn = false;
    }
    localStorage.removeItem('currentUser');
    sessionStorage.removeItem('currentUser');
  }
  
  // Mettre √† jour l'UI pour remettre tout comme avant la connexion
  setTimeout(() => {
    if (typeof window.updateAccountBlockLegitimately === 'function') {
      window.updateAccountBlockLegitimately();
    }
    if (typeof updateAuthButtons === 'function') {
      updateAuthButtons();
    }
  }, 100);
  
  // Afficher une notification
  setTimeout(() => {
    if (typeof showNotification === 'function') {
      showNotification(rememberMe ? 'üëã Vous resterez connect√© pour la prochaine fois' : 'üëã √Ä bient√¥t ! Vous devrez vous reconnecter √† la prochaine visite', 'info');
    }
  }, 200);
}

// Exposer les fonctions globalement
window.openAccountWindow = openAccountWindow;
window.askRememberMeBeforeLogout = askRememberMeBeforeLogout;
window.confirmLogoutWithRememberMe = confirmLogoutWithRememberMe;

// ‚úÖ MODAL "MES ANNONCES" - Affiche les annonces de l'utilisateur (avec API backend)
async function showMesAnnoncesModal() {
  const modal = document.getElementById('publish-modal-inner');
  const backdrop = document.getElementById('publish-modal-backdrop');
  
  if (!modal || !backdrop) {
    console.error('[MES ANNONCES] Modal non trouv√©');
    return;
  }
  
  // Afficher le loader
  modal.innerHTML = '<div style="padding:60px;text-align:center;"><div style="font-size:48px;margin-bottom:16px;">‚è≥</div><p style="color:var(--ui-text-muted);">Chargement...</p></div>';
  modal.style.display = 'block';
  modal.style.visibility = 'visible';
  backdrop.style.display = 'flex';
  backdrop.style.visibility = 'visible';
  backdrop.style.zIndex = '9999';
  
  // R√©cup√©rer les annonces depuis l'API backend ET les donn√©es locales
  const userAnnonces = [];
  const userId = currentUser ? (currentUser.id || currentUser.cognitoSub) : null;
  const token = typeof getAuthToken === 'function' ? getAuthToken() : localStorage.getItem('accessToken');
  
  // Charger depuis l'API backend
  if (token) {
    try {
      const response = await fetch(window.API_BASE_URL + '/user/events', {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
      });
      if (response.ok) {
        const events = await response.json();
        events.forEach(e => {
          // Ajouter √† userAnnonces pour l'affichage dans la modal
          userAnnonces.push({
            id: e.id, title: e.title, location: e.location, lat: e.latitude, lng: e.longitude,
            date: e.date, status: e.status || 'active', type: 'event', emoji: 'üìÖ',
            view_count: e.view_count || 0
          });
          
          // ‚ö†Ô∏è CRITIQUE : Ajouter aussi √† eventsData si pas d√©j√† pr√©sent
          // Cela permet √† focusOnMapItem de trouver l'√©v√©nement pour "Voir"
          if (!eventsData.find(ev => ev.id === e.id)) {
            eventsData.push({
              id: e.id,
              type: 'event',
              title: e.title,
              description: e.description || '',
              location: e.location,
              address: e.location,
              lat: e.latitude,
              lng: e.longitude,
              startDate: e.date ? new Date(e.date + (e.time ? 'T' + e.time : '')) : null,
              endDate: e.end_date ? new Date(e.end_date + (e.end_time ? 'T' + e.end_time : '')) : null,
              status: e.status || 'active',
              creator_id: e.creator_id,
              image_url: e.image_url,
              categories: e.categories || [],
              boost: '1.-',
              likes: 0,
              favorites: 0,
              participations: 0
            });
            console.log('[MES ANNONCES] √âv√©nement ajout√© √† eventsData:', e.id, e.title);
          }
        });
        // Rafra√Æchir les marqueurs pour afficher les nouveaux √©v√©nements sur la carte
        if (events.length > 0) {
          refreshMarkers();
        }
      }
    } catch (err) { console.warn('[MES ANNONCES] API error:', err); }
  }
  
  // Chercher aussi dans les donn√©es locales (fallback + bookings/services)
  eventsData.filter(e => e.userId === userId || e.createdBy === userId || e.creator_id === userId).forEach(e => {
    if (!userAnnonces.find(a => a.id === e.id && a.type === 'event')) {
      userAnnonces.push({ id: e.id, title: e.title || e.name, location: e.location || e.address, lat: e.lat, lng: e.lng, status: e.status || 'active', type: 'event', emoji: 'üìÖ', view_count: 0 });
    }
  });
  bookingsData.filter(b => b.userId === userId || b.createdBy === userId).forEach(b => {
    userAnnonces.push({ id: b.id, title: b.title || b.name, location: b.location || b.address, lat: b.lat, lng: b.lng, status: 'active', type: 'booking', emoji: 'üè®', view_count: 0 });
  });
  servicesData.filter(s => s.userId === userId || s.createdBy === userId).forEach(s => {
    userAnnonces.push({ id: s.id, title: s.title || s.name, location: s.location || s.address, lat: s.lat, lng: s.lng, status: 'active', type: 'service', emoji: 'üîß', view_count: 0 });
  });
  // R√©cup√©rer les vues popup pour les items sans view_count (bookings, services, events locaux)
  if (userAnnonces.length > 0 && window.API_BASE_URL) {
    try {
      const batch = userAnnonces.map(a => ({ type: a.type, id: a.id }));
      const r = await fetch(window.API_BASE_URL + '/analytics/popup-views-batch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: batch })
      });
      if (r.ok) {
        const data = await r.json();
        const views = data.views || {};
        userAnnonces.forEach(a => {
          const k = a.type + ':' + a.id;
          if (views[k] !== undefined) a.view_count = views[k];
        });
      }
    } catch (_) {}
  }
  
  const statusLabels = {
    'active': { label: 'Actif', color: '#22c55e', bg: 'rgba(34,197,94,0.15)' },
    'cancelled': { label: 'Annul√©', color: '#ef4444', bg: 'rgba(239,68,68,0.15)' },
    'postponed': { label: 'Report√©', color: '#f59e0b', bg: 'rgba(245,158,11,0.15)' }
  };
  
  var html = '<div style="padding:24px;max-width:600px;margin:0 auto;position:relative;">' +
    '<button id="mes-annonces-back-btn" style="position:absolute;top:16px;left:16px;background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:14px;cursor:pointer;padding:8px 16px;border-radius:8px;">‚Üê Retour</button>' +
    '<button id="mes-annonces-close-btn" style="position:absolute;top:16px;right:16px;background:none;border:none;color:var(--ui-text-muted);font-size:24px;cursor:pointer;">‚úï</button>' +
    '<h2 style="text-align:center;margin:0 0 24px;font-size:24px;color:#fff;">üì¢ Mes annonces</h2>';
  
  if (userAnnonces.length === 0) {
    html += '<div style="text-align:center;padding:40px;color:var(--ui-text-muted);"><div style="font-size:48px;margin-bottom:16px;">üì≠</div><p>Vous n\'avez pas encore d\'annonces</p><button id="mes-annonces-publish-btn" style="margin-top:16px;padding:12px 24px;border-radius:12px;border:none;background:#00ffc3;color:#000;font-weight:600;cursor:pointer;">+ Publier une annonce</button></div>';
  } else {
    html += '<div id="mes-annonces-list" style="display:flex;flex-direction:column;gap:16px;">';
    userAnnonces.forEach(item => {
      const st = statusLabels[item.status] || statusLabels['active'];
      const vc = item.view_count != null ? item.view_count : 0;
      html += '<div class="annonce-item" data-type="' + item.type + '" data-id="' + item.id + '" data-status="' + item.status + '" style="padding:16px;border-radius:12px;background:rgba(15,23,42,0.5);border:1px solid rgba(255,255,255,0.1);">' +
        '<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;cursor:pointer;" class="annonce-header">' +
          '<div style="font-size:28px;">' + item.emoji + '</div>' +
          '<div style="flex:1;"><div style="font-weight:600;font-size:15px;color:#fff;">' + escapeHtml(item.title || 'Sans titre') + '</div><div style="font-size:12px;color:var(--ui-text-muted);">' + escapeHtml(item.location || '') + '</div><div style="font-size:11px;color:var(--ui-text-muted);margin-top:4px;">üëÅ ' + vc + ' vue' + (vc !== 1 ? 's' : '') + '</div></div>' +
          '<span style="padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;background:' + st.bg + ';color:' + st.color + ';">' + st.label + '</span>' +
        '</div>' +
        // Premi√®re ligne de boutons
        '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">' +
          '<button class="annonce-btn-view" data-id="' + item.id + '" data-type="' + item.type + '" style="flex:1;min-width:60px;padding:10px;border-radius:8px;border:1px solid rgba(0,255,195,0.4);background:rgba(0,255,195,0.1);color:#00ffc3;font-size:12px;font-weight:600;cursor:pointer;">üìç Voir</button>' +
          '<button class="annonce-btn-edit" data-id="' + item.id + '" data-type="' + item.type + '" style="flex:1;min-width:60px;padding:10px;border-radius:8px;border:1px solid rgba(59,130,246,0.4);background:rgba(59,130,246,0.1);color:#3b82f6;font-size:12px;font-weight:600;cursor:pointer;">‚úèÔ∏è Modifier</button>' +
        '</div>' +
        // Deuxi√®me ligne - Statuts
        '<div style="display:flex;gap:8px;flex-wrap:wrap;">' +
          (item.status === 'active' ? '<button class="annonce-btn-cancel" data-id="' + item.id + '" data-type="' + item.type + '" style="flex:1;min-width:60px;padding:10px;border-radius:8px;border:1px solid rgba(239,68,68,0.4);background:rgba(239,68,68,0.1);color:#ef4444;font-size:12px;font-weight:600;cursor:pointer;">‚ùå Annuler</button>' : '') +
          (item.status === 'active' ? '<button class="annonce-btn-postpone" data-id="' + item.id + '" data-type="' + item.type + '" style="flex:1;min-width:60px;padding:10px;border-radius:8px;border:1px solid rgba(245,158,11,0.4);background:rgba(245,158,11,0.1);color:#f59e0b;font-size:12px;font-weight:600;cursor:pointer;">‚è∏Ô∏è Reporter</button>' : '') +
          (item.status === 'cancelled' || item.status === 'postponed' ? '<button class="annonce-btn-reactivate" data-id="' + item.id + '" data-type="' + item.type + '" style="flex:1;min-width:60px;padding:10px;border-radius:8px;border:1px solid rgba(34,197,94,0.4);background:rgba(34,197,94,0.1);color:#22c55e;font-size:12px;font-weight:600;cursor:pointer;">‚úÖ R√©activer</button>' : '') +
          '<button class="annonce-btn-delete" data-id="' + item.id + '" data-type="' + item.type + '" style="flex:1;min-width:60px;padding:10px;border-radius:8px;border:1px solid rgba(127,29,29,0.4);background:rgba(127,29,29,0.1);color:#dc2626;font-size:12px;font-weight:600;cursor:pointer;">üóëÔ∏è Supprimer</button>' +
        '</div></div>';
    });
    html += '</div>';
  }
  html += '</div>';
  modal.innerHTML = html;
  
  setTimeout(() => {
    document.getElementById('mes-annonces-back-btn')?.addEventListener('click', () => openAccountModal());
    document.getElementById('mes-annonces-close-btn')?.addEventListener('click', () => closePublishModal());
    document.getElementById('mes-annonces-publish-btn')?.addEventListener('click', () => { closePublishModal(); setTimeout(() => openPublishModal(), 200); });
    document.querySelectorAll('.annonce-btn-view').forEach(btn => btn.addEventListener('click', function() { closePublishModal(); focusOnMapItem(this.dataset.type, parseInt(this.dataset.id)); }));
    document.querySelectorAll('.annonce-btn-edit').forEach(btn => btn.addEventListener('click', function() { openEditEventModal(this.dataset.type, parseInt(this.dataset.id)); }));
    document.querySelectorAll('.annonce-btn-cancel').forEach(btn => btn.addEventListener('click', function() { updateEventStatus(parseInt(this.dataset.id), 'cancelled', this.dataset.type); }));
    document.querySelectorAll('.annonce-btn-postpone').forEach(btn => btn.addEventListener('click', function() { updateEventStatus(parseInt(this.dataset.id), 'postponed', this.dataset.type); }));
    document.querySelectorAll('.annonce-btn-reactivate').forEach(btn => btn.addEventListener('click', function() { updateEventStatus(parseInt(this.dataset.id), 'active', this.dataset.type); }));
    document.querySelectorAll('.annonce-btn-delete').forEach(btn => btn.addEventListener('click', function() { confirmDeleteEvent(parseInt(this.dataset.id), this.dataset.type); }));
    document.querySelectorAll('.annonce-header').forEach(h => h.addEventListener('click', function() { const p = this.closest('.annonce-item'); closePublishModal(); focusOnMapItem(p.dataset.type, parseInt(p.dataset.id)); }));
  }, 50);
}

// Mettre √† jour le statut d'un √©v√©nement (annuler/reporter/r√©activer)
async function updateEventStatus(eventId, newStatus, itemType = 'event') {
  const token = typeof getAuthToken === 'function' ? getAuthToken() : localStorage.getItem('accessToken');
  if (!token) { showNotification('‚ùå Vous devez √™tre connect√©', 'error'); return; }
  try {
    const endpoint = itemType === 'event' ? 'events' : itemType === 'booking' ? 'bookings' : 'services';
    const response = await fetch(window.API_BASE_URL + '/' + endpoint + '/' + eventId + '/status', {
      method: 'PATCH',
      headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    });
    if (response.ok) {
      const messages = {
        'cancelled': '‚ùå Annonce annul√©e',
        'postponed': '‚è∏Ô∏è Annonce report√©e',
        'active': '‚úÖ Annonce r√©activ√©e'
      };
      showNotification(messages[newStatus] || '‚úÖ Statut mis √† jour', 'success');
      await loadEventsFromBackend();
      showMesAnnoncesModal();
    } else {
      const err = await response.json();
      showNotification('‚ùå ' + (err.error || 'Erreur'), 'error');
    }
  } catch (err) {
    showNotification('‚ùå Erreur de connexion', 'error');
  }
}

// Ouvrir le formulaire de modification d'une annonce (formulaire d√©di√©)
function openEditEventModal(itemType, itemId) {
  // R√©cup√©rer les donn√©es de l'item
  const dataArray = itemType === 'event' ? eventsData : itemType === 'booking' ? bookingsData : servicesData;
  const item = dataArray.find(i => i.id === parseInt(itemId));
  
  if (!item) {
    showNotification('‚ùå Annonce introuvable', 'error');
    return;
  }
  
  // Stocker les donn√©es de l'item √† modifier
  window.editingItem = { ...item, mode: itemType, id: itemId };
  
  const modal = document.getElementById('publish-modal-inner');
  const backdrop = document.getElementById('publish-modal-backdrop');
  if (!modal || !backdrop) return;
  
  // Images de statut
  const statusImages = {
    active: '/assets/event_overlays/eventdefault.jpg',
    cancelled: '/assets/event_overlays/Event canceled.jpeg',
    postponed: '/assets/event_overlays/postponed.jpeg',
    completed: '/assets/event_overlays/completed.jpeg'
  };
  
  const currentStatus = item.status || 'active';
  
  // Construire le formulaire de modification
  const html = `
    <div style="padding:24px;max-width:550px;margin:0 auto;position:relative;">
      <button id="edit-back-btn" style="position:absolute;top:16px;left:16px;background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:14px;cursor:pointer;padding:8px 16px;border-radius:8px;">‚Üê Retour</button>
      <button id="edit-close-btn" style="position:absolute;top:16px;right:16px;background:none;border:none;color:var(--ui-text-muted);font-size:24px;cursor:pointer;">‚úï</button>
      
      <h2 style="text-align:center;margin:40px 0 24px;font-size:22px;color:#fff;">‚úèÔ∏è Modifier l'annonce</h2>
      
      <!-- Informations de base -->
      <div style="margin-bottom:16px;">
        <label style="display:block;font-size:12px;font-weight:600;color:#e2e8f0;margin-bottom:4px;">Titre *</label>
        <input type="text" id="edit-title" value="${escapeHtml(item.title || item.name || '')}" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#fff;font-size:14px;">
      </div>
      
      <div style="margin-bottom:16px;">
        <label style="display:block;font-size:12px;font-weight:600;color:#e2e8f0;margin-bottom:4px;">Description</label>
        <textarea id="edit-description" rows="3" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#fff;font-size:14px;resize:vertical;">${escapeHtml(item.description || '')}</textarea>
      </div>
      
      <div style="margin-bottom:16px;">
        <label style="display:block;font-size:12px;font-weight:600;color:#e2e8f0;margin-bottom:4px;">Adresse *</label>
        <input type="text" id="edit-address" value="${escapeHtml(item.address || item.location || '')}" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#fff;font-size:14px;">
      </div>
      
      <div style="display:flex;gap:12px;margin-bottom:16px;">
        <div style="flex:1;">
          <label style="display:block;font-size:12px;font-weight:600;color:#e2e8f0;margin-bottom:4px;">Email</label>
          <input type="email" id="edit-email" value="${escapeHtml(item.email || '')}" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#fff;font-size:14px;">
        </div>
        <div style="flex:1;">
          <label style="display:block;font-size:12px;font-weight:600;color:#e2e8f0;margin-bottom:4px;">T√©l√©phone</label>
          <input type="tel" id="edit-phone" value="${escapeHtml(item.phone || '')}" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#fff;font-size:14px;">
        </div>
      </div>
      
      ${itemType === 'event' ? `
      <div style="display:flex;gap:12px;margin-bottom:16px;">
        <div style="flex:1;">
          <label style="display:block;font-size:12px;font-weight:600;color:#e2e8f0;margin-bottom:4px;">Date/Heure d√©but</label>
          <input type="datetime-local" id="edit-start" value="${item.startDate || ''}" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#fff;font-size:14px;">
        </div>
        <div style="flex:1;">
          <label style="display:block;font-size:12px;font-weight:600;color:#e2e8f0;margin-bottom:4px;">Date/Heure fin</label>
          <input type="datetime-local" id="edit-end" value="${item.endDate || ''}" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#fff;font-size:14px;">
        </div>
      </div>
      ` : ''}
      
      <!-- Changement de statut avec images -->
      <div style="margin:24px 0;padding:16px;background:rgba(15,23,42,0.8);border:1px solid rgba(255,255,255,0.1);border-radius:12px;">
        <h3 style="margin:0 0 16px;font-size:14px;color:#00ffc3;">üìå Statut de l'annonce</h3>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
          <label style="cursor:pointer;text-align:center;">
            <input type="radio" name="edit-status" value="active" ${currentStatus === 'active' ? 'checked' : ''} style="display:none;">
            <div class="status-option" style="padding:8px;border-radius:10px;border:2px solid ${currentStatus === 'active' ? '#22c55e' : 'transparent'};background:${currentStatus === 'active' ? 'rgba(34,197,94,0.1)' : 'rgba(0,0,0,0.2)'};">
              <img src="${statusImages.active}" alt="Actif" style="width:100%;height:60px;object-fit:cover;border-radius:6px;margin-bottom:6px;">
              <div style="font-size:11px;font-weight:600;color:#22c55e;">‚úÖ Actif</div>
            </div>
          </label>
          <label style="cursor:pointer;text-align:center;">
            <input type="radio" name="edit-status" value="postponed" ${currentStatus === 'postponed' ? 'checked' : ''} style="display:none;">
            <div class="status-option" style="padding:8px;border-radius:10px;border:2px solid ${currentStatus === 'postponed' ? '#f59e0b' : 'transparent'};background:${currentStatus === 'postponed' ? 'rgba(245,158,11,0.1)' : 'rgba(0,0,0,0.2)'};">
              <img src="${statusImages.postponed}" alt="Report√©" style="width:100%;height:60px;object-fit:cover;border-radius:6px;margin-bottom:6px;">
              <div style="font-size:11px;font-weight:600;color:#f59e0b;">‚è∏Ô∏è Report√©</div>
            </div>
          </label>
          <label style="cursor:pointer;text-align:center;">
            <input type="radio" name="edit-status" value="cancelled" ${currentStatus === 'cancelled' ? 'checked' : ''} style="display:none;">
            <div class="status-option" style="padding:8px;border-radius:10px;border:2px solid ${currentStatus === 'cancelled' ? '#ef4444' : 'transparent'};background:${currentStatus === 'cancelled' ? 'rgba(239,68,68,0.1)' : 'rgba(0,0,0,0.2)'};">
              <img src="${statusImages.cancelled}" alt="Annul√©" style="width:100%;height:60px;object-fit:cover;border-radius:6px;margin-bottom:6px;">
              <div style="font-size:11px;font-weight:600;color:#ef4444;">‚ùå Annul√©</div>
            </div>
          </label>
        </div>
      </div>
      
      <!-- Boutons d'action -->
      <div style="display:flex;gap:12px;margin-top:24px;">
        <button id="edit-save-btn" style="flex:2;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#00ffc3,#00d4a0);color:#000;font-size:15px;font-weight:700;cursor:pointer;">
          üíæ Enregistrer les modifications
        </button>
        <button id="edit-delete-btn" style="flex:1;padding:14px;border-radius:12px;border:1px solid rgba(239,68,68,0.4);background:rgba(239,68,68,0.1);color:#ef4444;font-size:14px;font-weight:600;cursor:pointer;">
          üóëÔ∏è Supprimer
        </button>
      </div>
    </div>
  `;
  
  modal.innerHTML = html;
  modal.style.display = 'block';
  backdrop.style.display = 'flex';
  backdrop.style.zIndex = '9999';
  
  // Attacher les event listeners
  setTimeout(() => {
    document.getElementById('edit-back-btn')?.addEventListener('click', () => showMesAnnoncesModal());
    document.getElementById('edit-close-btn')?.addEventListener('click', () => { window.editingItem = null; closePublishModal(); });
    document.getElementById('edit-save-btn')?.addEventListener('click', () => saveEditedEvent(itemType, itemId));
    document.getElementById('edit-delete-btn')?.addEventListener('click', () => confirmDeleteEvent(itemId, itemType));
    
    // Mettre √† jour les styles des options de statut au clic
    document.querySelectorAll('input[name="edit-status"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.querySelectorAll('.status-option').forEach(opt => {
          opt.style.border = '2px solid transparent';
          opt.style.background = 'rgba(0,0,0,0.2)';
        });
        const selected = this.closest('label').querySelector('.status-option');
        const colors = { active: '#22c55e', postponed: '#f59e0b', cancelled: '#ef4444' };
        selected.style.border = `2px solid ${colors[this.value]}`;
        selected.style.background = `rgba(${this.value === 'active' ? '34,197,94' : this.value === 'postponed' ? '245,158,11' : '239,68,68'},0.1)`;
      });
    });
  }, 100);
}

// Sauvegarder les modifications d'une annonce
async function saveEditedEvent(itemType, itemId) {
  const title = document.getElementById('edit-title')?.value.trim();
  const description = document.getElementById('edit-description')?.value.trim();
  const address = document.getElementById('edit-address')?.value.trim();
  const email = document.getElementById('edit-email')?.value.trim();
  const phone = document.getElementById('edit-phone')?.value.trim();
  const startDate = document.getElementById('edit-start')?.value;
  const endDate = document.getElementById('edit-end')?.value;
  const newStatus = document.querySelector('input[name="edit-status"]:checked')?.value || 'active';
  
  if (!title || !address) {
    showNotification('‚ö†Ô∏è Le titre et l\'adresse sont obligatoires', 'warning');
    return;
  }
  
  showNotification('‚è≥ Enregistrement...', 'info');
  
  try {
    const token = typeof getAuthToken === 'function' ? getAuthToken() : localStorage.getItem('accessToken');
    const endpoint = itemType === 'event' ? 'events' : itemType === 'booking' ? 'bookings' : 'services';
    
    const updateData = {
      title, description, location: address, address, email, phone, status: newStatus
    };
    
    if (itemType === 'event') {
      if (startDate) {
        updateData.date = startDate.split('T')[0];
        updateData.time = startDate.split('T')[1];
      }
      if (endDate) {
        updateData.end_date = endDate.split('T')[0];
        updateData.end_time = endDate.split('T')[1];
      }
    }
    
    const response = await fetch(`${window.API_BASE_URL}/${endpoint}/${itemId}`, {
      method: 'PUT',
      headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
      body: JSON.stringify(updateData)
    });
    
    if (response.ok) {
      // Mettre √† jour localement
      const dataArray = itemType === 'event' ? eventsData : itemType === 'booking' ? bookingsData : servicesData;
      const index = dataArray.findIndex(i => i.id === parseInt(itemId));
      if (index !== -1) {
        dataArray[index] = { ...dataArray[index], ...updateData, title, name: title };
      }
      
      window.editingItem = null;
      refreshMarkers();
      playPaymentSound();
      showNotification('‚úÖ Modifications enregistr√©es !', 'success');
      
      setTimeout(() => showMesAnnoncesModal(), 500);
    } else {
      const err = await response.json();
      showNotification('‚ùå Erreur: ' + (err.error || 'Impossible de modifier'), 'error');
    }
  } catch (error) {
    console.error('Erreur modification:', error);
    showNotification('‚ùå Erreur de connexion', 'error');
  }
}

// Confirmation de suppression
function confirmDeleteEvent(itemId, itemType) {
  const modal = document.getElementById('publish-modal-inner');
  if (!modal) return;
  
  modal.innerHTML = `
    <div style="padding:40px;text-align:center;max-width:400px;margin:0 auto;">
      <div style="font-size:64px;margin-bottom:20px;">üóëÔ∏è</div>
      <h2 style="color:#fff;margin-bottom:16px;">Supprimer cette annonce ?</h2>
      <p style="color:var(--ui-text-muted);margin-bottom:24px;">Cette action est irr√©versible. L'annonce sera d√©finitivement supprim√©e.</p>
      <div style="display:flex;gap:12px;justify-content:center;">
        <button id="delete-cancel-btn" style="padding:12px 24px;border-radius:12px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:#fff;font-weight:600;cursor:pointer;">Annuler</button>
        <button id="delete-confirm-btn" style="padding:12px 24px;border-radius:12px;border:none;background:#dc2626;color:#fff;font-weight:600;cursor:pointer;">üóëÔ∏è Supprimer</button>
      </div>
    </div>
  `;
  
  document.getElementById('delete-cancel-btn')?.addEventListener('click', () => showMesAnnoncesModal());
  document.getElementById('delete-confirm-btn')?.addEventListener('click', () => deleteEvent(itemId, itemType));
}

// Supprimer une annonce
async function deleteEvent(itemId, itemType) {
  const token = typeof getAuthToken === 'function' ? getAuthToken() : localStorage.getItem('accessToken');
  if (!token) { showNotification('‚ùå Vous devez √™tre connect√©', 'error'); return; }
  
  try {
    const endpoint = itemType === 'event' ? 'events' : itemType === 'booking' ? 'bookings' : 'services';
    const response = await fetch(window.API_BASE_URL + '/' + endpoint + '/' + itemId, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    
    if (response.ok) {
      showNotification('üóëÔ∏è Annonce supprim√©e', 'success');
      
      // Supprimer localement aussi
      if (itemType === 'event') {
        eventsData = eventsData.filter(e => e.id !== itemId);
        window.eventsData = eventsData;
      } else if (itemType === 'booking') {
        bookingsData = bookingsData.filter(b => b.id !== itemId);
        window.bookingsData = bookingsData;
      } else if (itemType === 'service') {
        servicesData = servicesData.filter(s => s.id !== itemId);
        window.servicesData = servicesData;
      }
      
      refreshMarkers();
      showMesAnnoncesModal();
    } else {
      const err = await response.json();
      showNotification('‚ùå ' + (err.error || 'Erreur de suppression'), 'error');
      showMesAnnoncesModal();
    }
  } catch (err) {
    console.error('Erreur suppression:', err);
    showNotification('‚ùå Erreur de connexion', 'error');
    showMesAnnoncesModal();
  }
}

// Fonction pour centrer la map sur un item et ouvrir sa popup
function focusOnMapItem(type, id) {
  var data = type === 'event' ? eventsData : type === 'booking' ? bookingsData : servicesData;
  var item = data.find(function(i) { return i.id === parseInt(id); });
  
  if (item && item.lat && item.lng) {
    // Changer le mode si n√©cessaire
    if (currentMode !== type) {
      setMode(type);
    }
    
    // Centrer la carte
    if (map) {
      map.setView([item.lat, item.lng], 16);
    }
    
    // Ouvrir la popup de l'item apr√®s un court d√©lai
    setTimeout(function() {
      if (typeof openEventCard === 'function') {
        openEventCard(item);
      }
    }, 500);
    
    showNotification('üìç ' + (item.title || item.name), 'info');
  } else {
    showNotification('‚ùå Impossible de localiser cette annonce', 'error');
  }
}

// Fonction pour afficher le contenu d'un bloc
function showAccountBlockContent(blockType) {
  console.log('[ACCOUNT BLOCK] showAccountBlockContent appel√© avec blockType:', blockType);
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Pour modifier-profil, utiliser directement openEditProfileModal
  if (blockType === 'modifier-profil') {
    console.log('[ACCOUNT BLOCK] modifier-profil d√©tect√© - Utilisation directe openEditProfileModal');
    if (typeof window.openEditProfileModal === 'function') {
      window.openEditProfileModal();
      return;
    } else if (typeof openEditProfileModal === 'function') {
      openEditProfileModal();
      return;
    } else {
      console.error('[ACCOUNT BLOCK] ‚ùå openEditProfileModal non disponible');
      if (typeof showNotification === 'function') {
        showNotification('‚ö†Ô∏è Fonctionnalit√© en cours de d√©veloppement', 'info');
      }
      return;
    }
  }
  
  const contentDiv = document.getElementById('account-block-content');
  if (!contentDiv) {
    console.error('[ACCOUNT BLOCK] ‚ùå account-block-content non trouv√©!');
    return;
  }
  console.log('[ACCOUNT BLOCK] ‚úÖ account-block-content trouv√©');
  
  let content = '';
  
  if (blockType === 'agenda') {
    const agendaItems = (currentUser.agenda || []).map(key => {
      const [type, id] = key.split(":");
      const data = type === "event" ? eventsData : type === "booking" ? bookingsData : servicesData;
      return data.find(i => i.id === parseInt(id));
    }).filter(Boolean);
    
    content = `
      <div style="padding:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;font-size:18px;font-weight:700;color:#fff;">üìÖ Mon Agenda</h3>
          <button onclick="openAccountModal()" style="background:none;border:none;color:var(--ui-text-muted);font-size:20px;cursor:pointer;padding:4px;">‚úï</button>
        </div>
        ${agendaItems.length === 0 ? `
          <div style="text-align:center;padding:40px;color:var(--ui-text-muted);">
            <div style="font-size:48px;margin-bottom:16px;">üì≠</div>
            <p>Votre agenda est vide</p>
            <p style="font-size:12px;margin-top:8px;">Ajoutez des √©v√©nements depuis la carte !</p>
          </div>
        ` : `
          <div style="display:flex;flex-direction:column;gap:12px;">
            ${agendaItems.slice(0, 10).map(item => {
              const imgTag = buildMainImageTag(item, item.title || item.name || "");
              return `
                <div onclick="openPopupFromList('${item.type}', ${item.id}); closePublishModal();" style="display:flex;gap:12px;padding:12px;border-radius:12px;background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='rgba(0,255,195,0.1)';this.style.borderColor='rgba(0,255,195,0.5)'" onmouseout="this.style.background='rgba(15,23,42,0.5)';this.style.borderColor='var(--ui-card-border)'">
                  <div style="width:80px;height:80px;border-radius:8px;overflow:hidden;flex-shrink:0;">
                    ${imgTag}
                  </div>
                  <div style="flex:1;min-width:0;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(item.title || item.name || 'Sans titre')}</div>
                    <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:4px;">${getCategoryEmoji(item)} ${item.category || 'Autre'}</div>
                    ${item.startDate ? `<div style="font-size:11px;color:var(--ui-text-muted);">üìÖ ${formatDate(item.startDate)}</div>` : ''}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `}
      </div>
    `;
  } else if (blockType === 'amis') {
    const friends = currentUser.friends || [];
    const friendRequests = currentUser.friendRequests || [];
    
    content = `
      <div style="padding:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;font-size:18px;font-weight:700;color:#fff;">üë• Mes Amis</h3>
          <button onclick="openAccountModal()" style="background:none;border:none;color:var(--ui-text-muted);font-size:20px;cursor:pointer;padding:4px;">‚úï</button>
        </div>
        ${friendRequests.length > 0 ? `
          <div style="margin-bottom:20px;">
            <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:12px;font-weight:600;">üîî Demandes en attente (${friendRequests.length})</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              ${friendRequests.slice(0, 5).map(req => `
                <div style="display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);">
                  <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:20px;">${req.avatar || 'üë§'}</div>
                  <div style="flex:1;">
                    <div style="font-weight:600;font-size:14px;">${escapeHtml(req.name || 'Utilisateur')}</div>
                    <div style="font-size:11px;color:var(--ui-text-muted);">${req.username || ''}</div>
                  </div>
                  <div style="display:flex;gap:8px;">
                    <button onclick="acceptFriendRequest(${req.id})" style="padding:6px 12px;border-radius:8px;border:none;background:#22c55e;color:#fff;font-size:12px;font-weight:600;cursor:pointer;">‚úì</button>
                    <button onclick="rejectFriendRequest(${req.id})" style="padding:6px 12px;border-radius:8px;border:none;background:#ef4444;color:#fff;font-size:12px;font-weight:600;cursor:pointer;">‚úï</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
        ${friends.length === 0 ? `
          <div style="text-align:center;padding:40px;color:var(--ui-text-muted);">
            <div style="font-size:48px;margin-bottom:16px;">üë•</div>
            <p>Vous n'avez pas encore d'amis</p>
            <p style="font-size:12px;margin-top:8px;">Ajoutez des amis pour partager vos √©v√©nements !</p>
          </div>
        ` : `
          <div style="display:flex;flex-direction:column;gap:8px;">
            ${friends.slice(0, 20).map(friend => `
              <div style="display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);cursor:pointer;" onmouseover="this.style.background='rgba(0,255,195,0.1)';this.style.borderColor='rgba(0,255,195,0.5)'" onmouseout="this.style.background='rgba(15,23,42,0.5)';this.style.borderColor='var(--ui-card-border)'">
                <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:20px;">${friend.avatar || 'üë§'}</div>
                <div style="flex:1;">
                  <div style="font-weight:600;font-size:14px;">${escapeHtml(friend.name || friend.username || 'Ami')}</div>
                  <div style="font-size:11px;color:var(--ui-text-muted);">${friend.username || ''}</div>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>
    `;
  } else if (blockType === 'parametres') {
    content = `
      <div style="padding:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;font-size:18px;font-weight:700;color:#fff;">‚öôÔ∏è Param√®tres</h3>
          <button onclick="openAccountModal()" style="background:none;border:none;color:var(--ui-text-muted);font-size:20px;cursor:pointer;padding:4px;">‚úï</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <button onclick="openUserProfile()" style="padding:14px;border-radius:12px;border:2px solid rgba(255,255,255,0.1);background:rgba(15,23,42,0.5);color:#fff;font-weight:600;font-size:14px;cursor:pointer;text-align:left;transition:all 0.3s;" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(0,255,195,0.1)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.background='rgba(15,23,42,0.5)';">
            üë§ Modifier mon profil
          </button>
          <button onclick="showNotification('Fonctionnalit√© √† venir', 'info')" style="padding:14px;border-radius:12px;border:2px solid rgba(255,255,255,0.1);background:rgba(15,23,42,0.5);color:#fff;font-weight:600;font-size:14px;cursor:pointer;text-align:left;transition:all 0.3s;" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(0,255,195,0.1)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.background='rgba(15,23,42,0.5)';">
            üîî Notifications
          </button>
          <button onclick="showNotification('Fonctionnalit√© √† venir', 'info')" style="padding:14px;border-radius:12px;border:2px solid rgba(255,255,255,0.1);background:rgba(15,23,42,0.5);color:#fff;font-weight:600;font-size:14px;cursor:pointer;text-align:left;transition:all 0.3s;" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(0,255,195,0.1)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.background='rgba(15,23,42,0.5)';">
            üîí Confidentialit√©
          </button>
        </div>
      </div>
    `;
  } else if (blockType === 'profil') {
    content = `
      <div style="padding:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;font-size:18px;font-weight:700;color:#fff;">üë§ Mon Profil</h3>
          <button onclick="openAccountModal()" style="background:none;border:none;color:var(--ui-text-muted);font-size:20px;cursor:pointer;padding:4px;">‚úï</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:16px;">
          <div>
            <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:8px;">Nom d'utilisateur</div>
            <div style="font-weight:600;font-size:16px;color:#fff;">${escapeHtml(currentUser.username || 'Non d√©fini')}</div>
          </div>
          <div>
            <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:8px;">Email</div>
            <div style="font-weight:600;font-size:16px;color:#fff;">${escapeHtml(currentUser.email || 'Non d√©fini')}</div>
          </div>
          ${currentUser.firstName || currentUser.lastName ? `
            <div>
              <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:8px;">Nom complet</div>
              <div style="font-weight:600;font-size:16px;color:#fff;">${escapeHtml((currentUser.firstName || '') + ' ' + (currentUser.lastName || ''))}</div>
            </div>
          ` : ''}
          <button onclick="openUserProfile()" style="padding:14px;border-radius:12px;border:2px solid rgba(0,255,195,0.5);background:rgba(0,255,195,0.1);color:#00ffc3;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.background='rgba(0,255,195,0.2)';" onmouseout="this.style.background='rgba(0,255,195,0.1)';">
            ‚úèÔ∏è Modifier mon profil
          </button>
        </div>
      </div>
    `;
  } else if (blockType === 'modifier-profil') {
    // Afficher TOUTES les donn√©es du profil
    const addresses = currentUser.addresses || [];
    const mainAddress = addresses.length > 0 ? addresses[0] : (currentUser.postalAddress ? { label: currentUser.postalAddress } : null);
    
    content = `
      <div style="padding:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;font-size:18px;font-weight:700;color:#fff;">‚úèÔ∏è Modifier mon profil</h3>
          <button onclick="openAccountModal()" style="background:none;border:none;color:var(--ui-text-muted);font-size:20px;cursor:pointer;padding:4px;">‚úï</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:16px;">
          <div>
            <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:8px;">Nom d'utilisateur</div>
            <div style="font-weight:600;font-size:16px;color:#fff;">${escapeHtml(currentUser.username || 'Non d√©fini')}</div>
          </div>
          <div>
            <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:8px;">Email</div>
            <div style="font-weight:600;font-size:16px;color:#fff;">${escapeHtml(currentUser.email || 'Non d√©fini')}</div>
          </div>
          ${currentUser.firstName ? `
            <div>
              <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:8px;">Pr√©nom</div>
              <div style="font-weight:600;font-size:16px;color:#fff;">${escapeHtml(currentUser.firstName)}</div>
            </div>
          ` : ''}
          ${currentUser.lastName ? `
            <div>
              <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:8px;">Nom</div>
              <div style="font-weight:600;font-size:16px;color:#fff;">${escapeHtml(currentUser.lastName)}</div>
            </div>
          ` : ''}
          ${mainAddress ? `
            <div>
              <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:8px;">Adresse postale</div>
              <div style="font-weight:600;font-size:16px;color:#fff;">${escapeHtml(mainAddress.label || mainAddress)}</div>
            </div>
          ` : ''}
          ${currentUser.profile_photo_url ? `
            <div>
              <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:8px;">Photo de profil</div>
              <div style="width:80px;height:80px;border-radius:50%;overflow:hidden;border:2px solid rgba(0,255,195,0.3);">
                <img src="${currentUser.profile_photo_url}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';" />
              </div>
            </div>
          ` : ''}
          <button onclick="if(typeof window.openEditProfileModal === 'function') { window.openEditProfileModal(); } else if(typeof openEditProfileModal === 'function') { openEditProfileModal(); } else { showNotification('Fonctionnalit√© √† venir', 'info'); }" style="width:100%;padding:14px;border-radius:12px;border:2px solid rgba(0,255,195,0.5);background:rgba(0,255,195,0.1);color:#00ffc3;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.background='rgba(0,255,195,0.2)';" onmouseout="this.style.background='rgba(0,255,195,0.1)';">
            ‚úèÔ∏è Modifier mes informations
          </button>
        </div>
      </div>
    `;
  }
  
  if (content) {
    contentDiv.innerHTML = content;
  }
}

// Exposer les fonctions globalement
window.openAccountModal = openAccountModal;
window.showAccountBlockContent = showAccountBlockContent;

function showAccountModalTab(tab) {
  accountModalActiveTab = tab;
  
  // Calculer les statistiques
  const memberSince = currentUser.createdAt ? new Date(currentUser.createdAt).toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' }) : 'D√©c. 2024';
  const totalEvents = eventsData.length;
  const alertsCount = currentUser.alerts?.length || 0;
  const notificationsCount = (currentUser.friendRequests?.length || 0) + (currentUser.pendingStatusNotifications?.length || 0);
  
  // Initialiser les propri√©t√©s si elles sont undefined
  if (!currentUser.likes) currentUser.likes = [];
  if (!currentUser.agenda) currentUser.agenda = [];
  if (!currentUser.participating) currentUser.participating = [];
  if (!currentUser.favorites) currentUser.favorites = [];
  if (!currentUser.friendRequests) currentUser.friendRequests = [];
  
  // D√©terminer le niveau et les badges
  const activityScore = (currentUser.likes.length || 0) + (currentUser.agenda.length || 0) * 2 + (currentUser.participating.length || 0) * 3;
  const level = activityScore > 50 ? 'Expert' : activityScore > 20 ? 'Actif' : activityScore > 5 ? 'D√©couvreur' : 'Nouveau';
  const levelColor = activityScore > 50 ? '#ffd700' : activityScore > 20 ? '#8b5cf6' : activityScore > 5 ? '#3b82f6' : '#6b7280';
  const levelEmoji = activityScore > 50 ? 'üèÜ' : activityScore > 20 ? '‚≠ê' : activityScore > 5 ? 'üå±' : 'üëã';
  
  // Badges gagn√©s
  const badges = [];
  if ((currentUser.likes?.length || 0) >= 1) badges.push({ emoji: '‚ù§Ô∏è', name: 'Premier like' });
  if ((currentUser.agenda?.length || 0) >= 5) badges.push({ emoji: 'üìÖ', name: '5 √©v√©nements' });
  if ((currentUser.participating?.length || 0) >= 1) badges.push({ emoji: 'üéâ', name: 'Participant' });
  if (currentUser.subscription !== 'free') badges.push({ emoji: 'üíé', name: 'Premium' });
  if (alertsCount >= 3) badges.push({ emoji: 'üîî', name: 'Alert√©' });
  
  // Plan d'abonnement actuel
  const planNames = {
    'free': { name: 'Gratuit', color: '#6b7280', emoji: 'üÜì' },
    'events-explorer': { name: 'Events Explorer', color: '#22c55e', emoji: 'üå±' },
    'events-alerts-pro': { name: 'Events Alerts Pro', color: '#3b82f6', emoji: 'üîî' },
    'service-pro': { name: 'Service Pro', color: '#8b5cf6', emoji: 'üíº' },
    'service-ultra': { name: 'Service Ultra', color: '#a78bfa', emoji: 'üöÄ' },
    'full-premium': { name: 'Full Premium', color: '#ffd700', emoji: 'üëë' }
  };
  const currentPlan = planNames[currentUser.subscription] || planNames.free;
  
  // Avatar √† afficher (photo de profil ou emoji)
  // PRIORIT√â: profile_photo_url > profilePhoto > avatarUrl > avatar
  const avatarUrl = currentUser.profile_photo_url || currentUser.profilePhoto || currentUser.avatarUrl || currentUser.avatar;
  const avatarDisplay = (avatarUrl && (avatarUrl.startsWith('http') || avatarUrl.startsWith('data:image')))
    ? `<img src="${avatarUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.parentElement.innerHTML='${currentUser.avatar || 'üë§'}';" />`
    : (avatarUrl || currentUser.avatar || "üë§");
  
  // Contenu des onglets
  let tabContent = '';
  
  if (tab === 'agenda') {
    const agendaItems = (currentUser.agenda || []).map(key => {
      const [type, id] = key.split(":");
      const data = type === "event" ? eventsData : type === "booking" ? bookingsData : servicesData;
      const item = data.find(i => i.id === parseInt(id));
      // ‚ö†Ô∏è CRITIQUE : S'assurer que item.type est d√©fini
      if (item && !item.type) {
        item.type = type;
      }
      return item;
    }).filter(Boolean);
    
    tabContent = `
      <div style="padding:16px;">
        <h3 style="margin:0 0 16px;font-size:18px;font-weight:700;">üìÖ Mon Agenda</h3>
        ${agendaItems.length === 0 ? `
          <div style="text-align:center;padding:40px;color:var(--ui-text-muted);">
            <div style="font-size:48px;margin-bottom:16px;">üì≠</div>
            <p>Votre agenda est vide</p>
            <p style="font-size:12px;margin-top:8px;">Ajoutez des √©v√©nements depuis la carte !</p>
          </div>
        ` : `
          <div style="display:flex;flex-direction:column;gap:12px;">
            ${agendaItems.slice(0, 10).map(item => {
              const imgTag = buildMainImageTag(item, item.title || item.name || "");
              const itemType = item.type || 'event';
              return `
                <div onclick="openPopupFromList('${itemType}', ${item.id}); closePublishModal();" style="display:flex;gap:12px;padding:12px;border-radius:12px;background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='rgba(0,255,195,0.1)';this.style.borderColor='rgba(0,255,195,0.5)'" onmouseout="this.style.background='rgba(15,23,42,0.5)';this.style.borderColor='var(--ui-card-border)'">
                  <div style="width:80px;height:80px;border-radius:8px;overflow:hidden;flex-shrink:0;">
                    ${imgTag}
                  </div>
                  <div style="flex:1;min-width:0;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(item.title || item.name || 'Sans titre')}</div>
                    <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:4px;">${getCategoryEmoji(item)} ${item.category || 'Autre'}</div>
                    ${item.startDate ? `<div style="font-size:11px;color:var(--ui-text-muted);">üìÖ ${formatDate(item.startDate)}</div>` : ''}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `}
      </div>
    `;
  } else if (tab === 'groupes') {
    const groups = currentUser.groups || [];
    tabContent = `
      <div style="padding:16px;">
        <h3 style="margin:0 0 16px;font-size:18px;font-weight:700;">üë• Mes Groupes</h3>
        ${groups.length === 0 ? `
          <div style="text-align:center;padding:40px;color:var(--ui-text-muted);">
            <div style="font-size:48px;margin-bottom:16px;">üë•</div>
            <p>Vous n'√™tes dans aucun groupe</p>
            <button onclick="openGroupsModal()" style="margin-top:16px;padding:12px 24px;border-radius:999px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-weight:700;cursor:pointer;">Cr√©er un groupe</button>
          </div>
        ` : `
          <div style="display:flex;flex-direction:column;gap:12px;">
            ${groups.map(group => `
              <div onclick="openGroupDetails(${group.id})" style="display:flex;gap:12px;padding:12px;border-radius:12px;background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);cursor:pointer;">
                <div style="width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:24px;">${group.emoji || 'üë•'}</div>
                <div style="flex:1;">
                  <div style="font-weight:600;font-size:14px;">${escapeHtml(group.name || 'Groupe sans nom')}</div>
                  <div style="font-size:12px;color:var(--ui-text-muted);">${group.members?.length || 0} membres</div>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>
    `;
  } else if (tab === 'amis') {
    // Chargement dynamique depuis l'API - afficher un placeholder, puis charger async
    tabContent = `
      <div style="padding:16px;" id="friends-tab-content">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <h3 style="margin:0;font-size:18px;font-weight:700;">Mes Amis</h3>
                  </div>
        
        <!-- Recherche d'amis -->
        <div style="margin-bottom:16px;">
                  <div style="display:flex;gap:8px;">
            <div style="flex:1;position:relative;">
              <input id="friend-search-input" type="text" placeholder="Rechercher un utilisateur..." 
                style="width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(15,23,42,0.5);color:#e4e6eb;font-size:14px;" 
                oninput="searchFriendsDebounced(this.value)">
              <div id="friend-search-results" style="position:absolute;top:100%;left:0;right:0;z-index:100;background:#1e293b;border-radius:0 0 12px 12px;border:1px solid rgba(255,255,255,0.1);display:none;max-height:200px;overflow-y:auto;"></div>
                  </div>
                </div>
            </div>
        
        <!-- Demandes en attente -->
        <div id="friend-requests-section" style="display:none;margin-bottom:20px;">
          <div style="font-size:12px;color:#94a3b8;margin-bottom:12px;font-weight:600;">Demandes en attente</div>
          <div id="friend-requests-list" style="display:flex;flex-direction:column;gap:8px;"></div>
          </div>
        
        <!-- Liste des amis -->
        <div id="friends-list-section">
          <div style="text-align:center;padding:20px;color:#94a3b8;">Chargement...</div>
          </div>
      </div>
    `;
    // Charger les amis apr√®s le rendu
    setTimeout(() => loadFriendsTab(), 50);
  } else if (tab === 'notifications') {
    const notifications = [
      ...(currentUser.pendingStatusNotifications || []).map(n => ({...n, type: 'status'})),
      ...(currentUser.friendRequests || []).map(n => ({...n, type: 'friend'})),
    ].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
    
    tabContent = `
      <div style="padding:16px;">
        <h3 style="margin:0 0 16px;font-size:18px;font-weight:700;">üîî Notifications</h3>
        ${notifications.length === 0 ? `
          <div style="text-align:center;padding:40px;color:var(--ui-text-muted);">
            <div style="font-size:48px;margin-bottom:16px;">üîî</div>
            <p>Aucune notification</p>
          </div>
        ` : `
          <div style="display:flex;flex-direction:column;gap:8px;">
            ${notifications.slice(0, 20).map(notif => `
              <div style="display:flex;gap:12px;padding:12px;border-radius:12px;background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);">
                <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">
                  ${notif.type === 'status' ? 'üìä' : notif.type === 'friend' ? 'üë•' : 'üîî'}
                </div>
                <div style="flex:1;">
                  <div style="font-size:13px;color:var(--ui-text-main);line-height:1.4;">${escapeHtml(notif.message || 'Nouvelle notification')}</div>
                  <div style="font-size:11px;color:var(--ui-text-muted);margin-top:4px;">${formatTime(notif.timestamp || Date.now())}</div>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>
    `;
  } else if (tab === 'privacy') {
    // Initialiser les valeurs de confidentialit√© par d√©faut si non d√©finies
    const profilePublic = currentUser.profile_public !== undefined ? currentUser.profile_public : false;
    const showName = currentUser.show_name !== undefined ? currentUser.show_name : false;
    const showPhoto = currentUser.show_photo !== undefined ? currentUser.show_photo : false;
    const showCityCountryOnly = currentUser.show_city_country_only !== undefined ? currentUser.show_city_country_only : false;
    
    tabContent = `
      <div style="padding:16px;">
        <div style="margin-bottom:20px;padding:12px;background:rgba(0,255,195,0.1);border:1px solid rgba(0,255,195,0.3);border-radius:12px;">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
            <span style="font-size:20px;">üîí</span>
            <div style="font-weight:700;font-size:14px;color:#00ffc3;">Compte priv√© (par d√©faut)</div>
          </div>
          <div style="font-size:12px;color:var(--ui-text-muted);line-height:1.5;">
            Vos donn√©es personnelles (email, adresse compl√®te) ne sont <strong>jamais</strong> affich√©es publiquement. 
            Vous pouvez choisir de rendre certains √©l√©ments de votre profil visibles via les options ci-dessous.
          </div>
        </div>
        
        <h3 style="margin:0 0 16px;font-size:16px;font-weight:700;">Visibilit√© du profil</h3>
        
        <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:20px;">
          <label style="display:flex;align-items:start;justify-content:space-between;padding:14px;background:rgba(15,23,42,0.5);border-radius:10px;border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)'" onmouseout="this.style.borderColor='var(--ui-card-border)'">
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                <span style="font-size:18px;">üåê</span>
                <span style="font-weight:600;font-size:14px;">Rendre mon profil visible</span>
              </div>
              <div style="font-size:12px;color:var(--ui-text-muted);line-height:1.4;">
                Si activ√©, votre profil peut √™tre d√©couvert par d'autres utilisateurs. Vos donn√©es sensibles (email, adresse compl√®te) restent toujours priv√©es.
              </div>
            </div>
            <input type="checkbox" id="privacy-profile-public" ${profilePublic ? 'checked' : ''} onchange="togglePrivacySetting('profile_public', this.checked)" style="width:20px;height:20px;margin-left:12px;accent-color:#00ffc3;cursor:pointer;">
          </label>
          
          <label style="display:flex;align-items:start;justify-content:space-between;padding:14px;background:rgba(15,23,42,0.5);border-radius:10px;border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)'" onmouseout="this.style.borderColor='var(--ui-card-border)'">
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                <span style="font-size:18px;">üë§</span>
                <span style="font-weight:600;font-size:14px;">Afficher mon nom</span>
              </div>
              <div style="font-size:12px;color:var(--ui-text-muted);line-height:1.4;">
                Permet d'afficher votre nom d'utilisateur ou votre nom complet sur votre profil public.
              </div>
            </div>
            <input type="checkbox" id="privacy-show-name" ${showName ? 'checked' : ''} onchange="togglePrivacySetting('show_name', this.checked)" style="width:20px;height:20px;margin-left:12px;accent-color:#00ffc3;cursor:pointer;">
          </label>
          
          <label style="display:flex;align-items:start;justify-content:space-between;padding:14px;background:rgba(15,23,42,0.5);border-radius:10px;border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)'" onmouseout="this.style.borderColor='var(--ui-card-border)'">
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                <span style="font-size:18px;">üì∏</span>
                <span style="font-weight:600;font-size:14px;">Afficher ma photo</span>
              </div>
              <div style="font-size:12px;color:var(--ui-text-muted);line-height:1.4;">
                Permet d'afficher votre photo de profil sur votre profil public.
              </div>
            </div>
            <input type="checkbox" id="privacy-show-photo" ${showPhoto ? 'checked' : ''} onchange="togglePrivacySetting('show_photo', this.checked)" style="width:20px;height:20px;margin-left:12px;accent-color:#00ffc3;cursor:pointer;">
          </label>
          
          <label style="display:flex;align-items:start;justify-content:space-between;padding:14px;background:rgba(15,23,42,0.5);border-radius:10px;border:1px solid var(--ui-card-border);cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(0,255,195,0.5)'" onmouseout="this.style.borderColor='var(--ui-card-border)'">
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                <span style="font-size:18px;">üìç</span>
                <span style="font-weight:600;font-size:14px;">Afficher ville/pays uniquement</span>
              </div>
              <div style="font-size:12px;color:var(--ui-text-muted);line-height:1.4;">
                Permet d'afficher uniquement votre ville et pays (sans adresse compl√®te) sur votre profil public.
              </div>
            </div>
            <input type="checkbox" id="privacy-show-city-country" ${showCityCountryOnly ? 'checked' : ''} onchange="togglePrivacySetting('show_city_country_only', this.checked)" style="width:20px;height:20px;margin-left:12px;accent-color:#00ffc3;cursor:pointer;">
          </label>
        </div>
        
        <div style="padding:12px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:10px;margin-top:20px;">
          <div style="font-size:12px;color:var(--ui-text-muted);line-height:1.5;">
            <strong style="color:#ef4444;">‚ö†Ô∏è Important :</strong> Votre email et votre adresse postale compl√®te ne sont <strong>jamais</strong> affich√©s publiquement, m√™me si vous activez ces options.
          </div>
        </div>
      </div>
    `;
  }
  
  const html = `
    <div style="padding:0;max-width:500px;margin:0 auto;">
      <!-- Header avec avatar et infos -->
      <div style="background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f172a 100%);padding:20px;border-radius:16px 16px 0 0;position:relative;">
        <div style="display:flex;align-items:center;gap:16px;">
          <div style="position:relative;">
            <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:24px;border:2px solid rgba(255,255,255,0.2);overflow:hidden;" data-account-avatar="true">
              ${avatarDisplay}
            </div>
            <div style="position:absolute;bottom:-2px;right:-2px;width:20px;height:20px;background:${levelColor};border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;border:2px solid #0f172a;">
              ${levelEmoji}
            </div>
          </div>
          <div style="flex:1;">
            <div style="font-size:18px;font-weight:800;color:#fff;margin-bottom:2px;">${currentUser.username || currentUser.name || 'Utilisateur'}</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:4px;">${currentUser.email || ''}</div>
            ${(currentUser.address_city || currentUser.address_country_code) && currentUser.show_city_country_only ? `
              <div style="font-size:11px;color:rgba(255,255,255,0.5);display:flex;align-items:center;gap:4px;">
                <span>üìç</span>
                <span>${currentUser.address_city || ''}${currentUser.address_city && currentUser.address_country_code ? ', ' : ''}${currentUser.address_country_code || ''}</span>
              </div>
            ` : ''}
          </div>
        </div>
      </div>
      
      <!-- Onglets style Facebook -->
      <div style="display:flex;background:var(--ui-card-bg);border-top:1px solid var(--ui-card-border);border-bottom:1px solid var(--ui-card-border);">
        <button onclick="closePublishModal();setTimeout(() => openAgendaModal(), 300);" style="flex:1;padding:14px;border:none;background:${tab === 'agenda' ? 'rgba(0,255,195,0.1)' : 'transparent'};color:${tab === 'agenda' ? '#00ffc3' : 'var(--ui-text-main)'};font-weight:${tab === 'agenda' ? '700' : '600'};font-size:13px;cursor:pointer;border-bottom:${tab === 'agenda' ? '3px solid #00ffc3' : 'none'};transition:all 0.2s;">
          üìÖ Agenda
        </button>
        <button onclick="showAccountModalTab('groupes')" style="flex:1;padding:14px;border:none;background:${tab === 'groupes' ? 'rgba(0,255,195,0.1)' : 'transparent'};color:${tab === 'groupes' ? '#00ffc3' : 'var(--ui-text-main)'};font-weight:${tab === 'groupes' ? '700' : '600'};font-size:13px;cursor:pointer;border-bottom:${tab === 'groupes' ? '3px solid #00ffc3' : 'none'};transition:all 0.2s;">
          üë• Groupes
        </button>
        <button onclick="showAccountModalTab('amis')" style="flex:1;padding:14px;border:none;background:${tab === 'amis' ? 'rgba(0,255,195,0.1)' : 'transparent'};color:${tab === 'amis' ? '#00ffc3' : 'var(--ui-text-main)'};font-weight:${tab === 'amis' ? '700' : '600'};font-size:13px;cursor:pointer;border-bottom:${tab === 'amis' ? '3px solid #00ffc3' : 'none'};transition:all 0.2s;position:relative;">
          üë• Amis
          ${(currentUser.friendRequests?.length || 0) > 0 ? `<span style="position:absolute;top:8px;right:8px;width:16px;height:16px;background:#ef4444;border-radius:50%;font-size:9px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;">${currentUser.friendRequests.length}</span>` : ''}
        </button>
        <button onclick="showAccountModalTab('notifications')" style="flex:1;padding:14px;border:none;background:${tab === 'notifications' ? 'rgba(0,255,195,0.1)' : 'transparent'};color:${tab === 'notifications' ? '#00ffc3' : 'var(--ui-text-main)'};font-weight:${tab === 'notifications' ? '700' : '600'};font-size:13px;cursor:pointer;border-bottom:${tab === 'notifications' ? '3px solid #00ffc3' : 'none'};transition:all 0.2s;position:relative;">
          üîî Notifs
          ${notificationsCount > 0 ? `<span style="position:absolute;top:8px;right:8px;width:16px;height:16px;background:#ef4444;border-radius:50%;font-size:9px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;">${notificationsCount}</span>` : ''}
        </button>
        <button onclick="showAccountModalTab('mapfriend')" style="flex:1;padding:14px;border:none;background:${tab === 'mapfriend' ? 'rgba(0,255,195,0.1)' : 'transparent'};color:${tab === 'mapfriend' ? '#00ffc3' : 'var(--ui-text-main)'};font-weight:${tab === 'mapfriend' ? '700' : '600'};font-size:13px;cursor:pointer;border-bottom:${tab === 'mapfriend' ? '3px solid #00ffc3' : 'none'};transition:all 0.2s;">
          üåç Map Friend
        </button>
        <button onclick="showAccountModalTab('privacy')" style="flex:1;padding:14px;border:none;background:${tab === 'privacy' ? 'rgba(0,255,195,0.1)' : 'transparent'};color:${tab === 'privacy' ? '#00ffc3' : 'var(--ui-text-main)'};font-weight:${tab === 'privacy' ? '700' : '600'};font-size:13px;cursor:pointer;border-bottom:${tab === 'privacy' ? '3px solid #00ffc3' : 'none'};transition:all 0.2s;">
          üîí Confidentialit√©
        </button>
      </div>
      
      <!-- Contenu de l'onglet -->
      <div style="max-height:calc(80vh - 200px);overflow-y:auto;">
        ${tabContent}
      </div>
      
      <!-- Footer avec actions -->
      <div style="padding:12px 16px;background:var(--ui-card-bg);border-top:1px solid var(--ui-card-border);border-radius:0 0 16px 16px;display:flex;flex-direction:column;gap:8px;">
        <div style="display:flex;gap:8px;">
          <button onclick="openEditProfileModal()" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(0,255,195,0.3);background:rgba(0,255,195,0.1);color:#00ffc3;cursor:pointer;font-size:12px;font-weight:600;">‚úèÔ∏è Modifier profil</button>
          <button onclick="openSettingsModal()" style="flex:1;padding:10px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:12px;">‚öôÔ∏è Param√®tres</button>
        </div>
        <div style="display:flex;gap:8px;">
          <button onclick="logout()" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.1);color:#ef4444;cursor:pointer;font-size:12px;">üö™ D√©connexion</button>
          <button onclick="closePublishModal()" style="flex:1;padding:10px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-muted);cursor:pointer;font-size:12px;">Fermer</button>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
}

// Modal Param√®tres
function openSettingsModal() {
  const html = `
    <div style="padding:20px;max-width:400px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 style="margin:0;font-size:20px;display:flex;align-items:center;gap:10px;">‚öôÔ∏è Param√®tres</h2>
        <button onclick="closePublishModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--ui-text-muted);">‚úï</button>
      </div>
      
      <!-- Notifications -->
      <div style="margin-bottom:20px;">
        <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:12px;font-weight:600;">üîî NOTIFICATIONS</div>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(15,23,42,0.5);border-radius:10px;cursor:pointer;">
            <div style="display:flex;align-items:center;gap:10px;">
              <span>üìß</span>
              <span style="font-size:14px;">Notifications par email</span>
            </div>
            <input type="checkbox" ${currentUser.notificationPreferences?.email ? 'checked' : ''} onchange="toggleNotification('email')" style="width:20px;height:20px;">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(15,23,42,0.5);border-radius:10px;cursor:pointer;">
            <div style="display:flex;align-items:center;gap:10px;">
              <span>üì±</span>
              <span style="font-size:14px;">Notifications SMS</span>
            </div>
            <input type="checkbox" ${currentUser.notificationPreferences?.sms ? 'checked' : ''} onchange="toggleNotification('sms')" style="width:20px;height:20px;">
          </label>
        </div>
      </div>
      
      <!-- Th√®me -->
      <div style="margin-bottom:20px;">
        <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:12px;font-weight:600;">üé® APPARENCE</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
          <button onclick="openColorPickerModal()" style="padding:16px;border-radius:12px;border:1px solid var(--ui-card-border);background:linear-gradient(135deg,#1e293b,#0f172a);color:var(--ui-text-main);cursor:pointer;font-size:12px;">
            <div style="font-size:20px;margin-bottom:4px;">üé®</div>
            Couleurs
          </button>
          <button onclick="cycleMapTheme()" style="padding:16px;border-radius:12px;border:1px solid var(--ui-card-border);background:linear-gradient(135deg,#1e293b,#0f172a);color:var(--ui-text-main);cursor:pointer;font-size:12px;">
            <div style="font-size:20px;margin-bottom:4px;">üó∫Ô∏è</div>
            Th√®me carte
          </button>
          <button onclick="showNotification('üåç Langue √† venir', 'info')" style="padding:16px;border-radius:12px;border:1px solid var(--ui-card-border);background:linear-gradient(135deg,#1e293b,#0f172a);color:var(--ui-text-main);cursor:pointer;font-size:12px;">
            <div style="font-size:20px;margin-bottom:4px;">üåç</div>
            Langue
          </button>
        </div>
      </div>
      
      <!-- Confidentialit√© - Ce qui est visible publiquement -->
      <div style="margin-bottom:20px;">
        <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:8px;font-weight:600;">üîí CONFIDENTIALIT√â</div>
        <div style="font-size:11px;color:var(--ui-text-muted);margin-bottom:12px;">Choisissez ce qui est visible par les autres utilisateurs</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <!-- Toujours visibles (non modifiables) -->
          <div style="padding:10px 12px;background:rgba(0,255,195,0.1);border:1px solid rgba(0,255,195,0.2);border-radius:8px;display:flex;align-items:center;justify-content:space-between;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>üë§</span>
              <span style="font-size:13px;">Nom + Avatar</span>
            </div>
            <span style="font-size:11px;color:#00ffc3;font-weight:600;">Toujours visible</span>
          </div>
          
          <!-- Options modifiables -->
          <label style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(15,23,42,0.5);border-radius:8px;cursor:pointer;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>üìù</span>
              <span style="font-size:13px;">Ma bio / description</span>
            </div>
            <input type="checkbox" ${currentUser.privacySettings?.showBio !== false ? 'checked' : ''} onchange="togglePrivacy('showBio')" style="width:18px;height:18px;accent-color:#00ffc3;">
          </label>
          
          <label style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(15,23,42,0.5);border-radius:8px;cursor:pointer;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>üìß</span>
              <span style="font-size:13px;">Mon email</span>
            </div>
            <input type="checkbox" ${currentUser.privacySettings?.showEmail ? 'checked' : ''} onchange="togglePrivacy('showEmail')" style="width:18px;height:18px;accent-color:#00ffc3;">
          </label>
          
          <label style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(15,23,42,0.5);border-radius:8px;cursor:pointer;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>üìç</span>
              <span style="font-size:13px;">Mes adresses</span>
            </div>
            <input type="checkbox" ${currentUser.privacySettings?.showAddresses ? 'checked' : ''} onchange="togglePrivacy('showAddresses')" style="width:18px;height:18px;accent-color:#00ffc3;">
          </label>
          
          <label style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(15,23,42,0.5);border-radius:8px;cursor:pointer;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>‚ù§Ô∏è</span>
              <span style="font-size:13px;">Mes favoris</span>
            </div>
            <input type="checkbox" ${currentUser.privacySettings?.showFavorites !== false ? 'checked' : ''} onchange="togglePrivacy('showFavorites')" style="width:18px;height:18px;accent-color:#00ffc3;">
          </label>
          
          <label style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(15,23,42,0.5);border-radius:8px;cursor:pointer;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>üìÖ</span>
              <span style="font-size:13px;">Mon agenda</span>
            </div>
            <input type="checkbox" ${currentUser.privacySettings?.showAgenda !== false ? 'checked' : ''} onchange="togglePrivacy('showAgenda')" style="width:18px;height:18px;accent-color:#00ffc3;">
          </label>
          
          <label style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(15,23,42,0.5);border-radius:8px;cursor:pointer;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>üéâ</span>
              <span style="font-size:13px;">Mes participations</span>
            </div>
            <input type="checkbox" ${currentUser.privacySettings?.showParticipating !== false ? 'checked' : ''} onchange="togglePrivacy('showParticipating')" style="width:18px;height:18px;accent-color:#00ffc3;">
          </label>
          
          <label style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(15,23,42,0.5);border-radius:8px;cursor:pointer;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>üë•</span>
              <span style="font-size:13px;">Mes amis</span>
            </div>
            <input type="checkbox" ${currentUser.privacySettings?.showFriends !== false ? 'checked' : ''} onchange="togglePrivacy('showFriends')" style="width:18px;height:18px;accent-color:#00ffc3;">
          </label>
          
          <label style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(15,23,42,0.5);border-radius:8px;cursor:pointer;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>üìä</span>
              <span style="font-size:13px;">Mes statistiques</span>
            </div>
            <input type="checkbox" ${currentUser.privacySettings?.showActivity !== false ? 'checked' : ''} onchange="togglePrivacy('showActivity')" style="width:18px;height:18px;accent-color:#00ffc3;">
          </label>
        </div>
      </div>
      
      <!-- Compte -->
      <div style="margin-bottom:20px;">
        <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:12px;font-weight:600;">üë§ COMPTE</div>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <button onclick="showNotification('üìß Modification email √† venir', 'info')" style="padding:12px;border-radius:10px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;font-size:14px;">
            <span>üìß</span> Modifier mon email
          </button>
          <button onclick="showNotification('üîí Modification mot de passe √† venir', 'info')" style="padding:12px;border-radius:10px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;font-size:14px;">
            <span>üîí</span> Modifier mon mot de passe
          </button>
          <button onclick="showNotification('üóëÔ∏è Suppression compte √† venir', 'info')" style="padding:12px;border-radius:10px;border:1px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.05);color:#ef4444;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;font-size:14px;">
            <span>üóëÔ∏è</span> Supprimer mon compte
          </button>
        </div>
      </div>
      
      <button onclick="openAccountModal()" style="width:100%;padding:12px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;">
        ‚Üê Retour au compte
      </button>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
}

function toggleNotification(type) {
  if (!currentUser.notificationPreferences) {
    currentUser.notificationPreferences = { email: true, sms: false };
  }
  currentUser.notificationPreferences[type] = !currentUser.notificationPreferences[type];
  saveUserData();
  showNotification(`${type === 'email' ? 'üìß' : 'üì±'} Notifications ${type} ${currentUser.notificationPreferences[type] ? 'activ√©es' : 'd√©sactiv√©es'}`, 'success');
}

// Basculer une option de confidentialit√©
// Modal Modifier le profil
function openEditProfileModal() {
  // Construire la valeur de l'adresse de mani√®re s√©curis√©e
  let addressValue = '';
  try {
    if (currentUser.postalAddress) {
      if (typeof currentUser.postalAddress === 'object' && currentUser.postalAddress !== null) {
        const parts = [];
        if (currentUser.postalAddress.address) parts.push(currentUser.postalAddress.address);
        if (currentUser.postalAddress.city) parts.push(currentUser.postalAddress.city);
        if (currentUser.postalAddress.zip) parts.push(currentUser.postalAddress.zip);
        addressValue = parts.join(', ');
      } else if (typeof currentUser.postalAddress === 'string') {
        addressValue = currentUser.postalAddress;
      }
    }
  } catch (e) {
    console.warn('Erreur construction adresse:', e);
    addressValue = '';
  }
  
  const html = `
    <div style="padding:24px;max-width:500px;margin:0 auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
        <h2 style="margin:0;font-size:22px;font-weight:800;color:#fff;display:flex;align-items:center;gap:10px;">
          <span>‚úèÔ∏è</span> Modifier mon profil
        </h2>
        <button onclick="openAccountModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--ui-text-muted);transition:color 0.2s;" onmouseover="this.style.color='#fff';" onmouseout="this.style.color='var(--ui-text-muted)';">‚úï</button>
      </div>
      
      <!-- Photo de profil -->
      <div style="margin-bottom:24px;text-align:center;">
        <label style="display:block;font-size:13px;font-weight:600;color:var(--ui-text-main);margin-bottom:12px;">üì∏ Photo de profil</label>
        <div style="position:relative;display:inline-block;">
          <div id="edit-profile-photo-preview" style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:32px;border:3px solid rgba(255,255,255,0.2);overflow:hidden;margin:0 auto;position:relative;">
            ${(() => {
              // PRIORIT√â: profile_photo_url > profilePhoto > avatarUrl > avatar
              const avatarUrl = currentUser.profile_photo_url || currentUser.profilePhoto || currentUser.avatarUrl || currentUser.avatar;
              if (avatarUrl && (avatarUrl.startsWith('http') || avatarUrl.startsWith('data:image'))) {
                const safeUrl = avatarUrl.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                return `<img src="${safeUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;position:absolute;top:0;left:0;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" /><div style="display:none;width:100%;height:100%;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);align-items:center;justify-content:center;font-size:32px;position:absolute;top:0;left:0;">üë§</div>`;
              }
              return '<div style="width:100%;height:100%;border-radius:50%;background:linear-gradient(135deg,#00ffc3,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:32px;">üë§</div>';
            })()}
          </div>
          <input type="file" id="edit-profile-photo-input" accept="image/*" style="display:none;" onchange="handleEditProfilePhoto(event)">
          <button onclick="document.getElementById('edit-profile-photo-input').click()" style="margin-top:12px;padding:8px 16px;border-radius:8px;border:2px solid rgba(0,255,195,0.3);background:rgba(0,255,195,0.1);color:#00ffc3;font-weight:600;font-size:13px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.background='rgba(0,255,195,0.2)';this.style.borderColor='rgba(0,255,195,0.5)';" onmouseout="this.style.background='rgba(0,255,195,0.1)';this.style.borderColor='rgba(0,255,195,0.3)';">
            üì∑ Changer la photo
          </button>
        </div>
      </div>
      
      <!-- Nom d'utilisateur -->
      <div style="margin-bottom:20px;">
        <label style="display:block;font-size:13px;font-weight:600;color:var(--ui-text-main);margin-bottom:8px;">üë§ Nom d'utilisateur</label>
        <input type="text" id="edit-profile-username" value="${escapeHtml(currentUser.username || '')}" placeholder="Votre nom d'utilisateur" maxlength="20" style="width:100%;padding:12px 16px;border-radius:10px;border:2px solid rgba(255,255,255,0.1);background:rgba(15,23,42,0.5);color:var(--ui-text-main);font-size:14px;transition:all 0.3s;" onfocus="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(15,23,42,0.8)';" onblur="this.style.borderColor='rgba(255,255,255,0.1)';this.style.background='rgba(15,23,42,0.5)';">
        <div style="font-size:11px;color:var(--ui-text-muted);margin-top:4px;">Ce nom sera visible par tous les utilisateurs</div>
      </div>
      
      <!-- Adresse postale -->
      <div style="margin-bottom:24px;">
        <label style="display:block;font-size:13px;font-weight:600;color:var(--ui-text-main);margin-bottom:8px;">üìç Adresse postale</label>
        <input type="text" id="edit-profile-address" value="${escapeHtml(addressValue)}" placeholder="Rue, Ville, Code postal" style="width:100%;padding:12px 16px;border-radius:10px;border:2px solid rgba(255,255,255,0.1);background:rgba(15,23,42,0.5);color:var(--ui-text-main);font-size:14px;transition:all 0.3s;" onfocus="this.style.borderColor='rgba(0,255,195,0.5)';this.style.background='rgba(15,23,42,0.8)';" onblur="this.style.borderColor='rgba(255,255,255,0.1)';this.style.background='rgba(15,23,42,0.5)';">
      </div>
      
      <!-- Boutons -->
      <div style="display:flex;gap:12px;">
        <button onclick="saveProfileChanges()" style="flex:1;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#00ffc3,#3b82f6);color:#000;font-weight:700;font-size:15px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 20px rgba(0,255,195,0.3)';" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none';">
          üíæ Enregistrer
        </button>
        <button onclick="openAccountModal()" style="flex:1;padding:14px;border-radius:12px;border:2px solid rgba(255,255,255,0.1);background:transparent;color:var(--ui-text-muted);font-weight:600;font-size:15px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.3)';this.style.color='var(--ui-text-main)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='var(--ui-text-muted)';">
          Annuler
        </button>
      </div>
    </div>
  `;
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : S'assurer que le modal est ouvert avant d'injecter le HTML
  const modal = document.getElementById("publish-modal-inner");
  const backdrop = document.getElementById("publish-modal-backdrop");
  
  if (!modal || !backdrop) {
    console.error('[EDIT PROFILE] ‚ùå Modal non trouv√©');
    if (typeof showNotification === 'function') {
      showNotification('‚ö†Ô∏è Erreur: Modal non trouv√©', 'error');
    }
    return;
  }
  
  // Forcer l'ouverture du modal
  backdrop.style.display = 'flex';
  backdrop.style.visibility = 'visible';
  backdrop.style.opacity = '1';
  backdrop.style.zIndex = '9999';
  modal.style.display = 'block';
  modal.style.visibility = 'visible';
  modal.style.opacity = '1';
  
  // Injecter le HTML
  modal.innerHTML = html;
  
  console.log('[EDIT PROFILE] ‚úÖ Formulaire de modification affich√©');
  
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITIQUE : Emp√™cher la fermeture du modal pendant l'injection
  // Attendre un peu pour que le HTML soit compl√®tement inject√©
  setTimeout(() => {
    // R√©attacher les event listeners apr√®s l'injection
    const closeBtn = modal.querySelector('.modal-close-btn, [onclick*="closePublishModal"]');
    if (closeBtn) {
      closeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        e.preventDefault();
        closePublishModal(e);
      });
    }
  }, 100);
}

// G√©rer le changement de photo de profil
function handleEditProfilePhoto(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    showNotification("‚ö†Ô∏è Veuillez s√©lectionner une image", "warning");
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const photoUrl = e.target.result;
    const preview = document.getElementById('edit-profile-photo-preview');
    if (preview) {
      preview.innerHTML = `<img src="${photoUrl}" style="width:100%;height:100%;object-fit:cover;" />`;
    }
    // Stocker temporairement pour la sauvegarde
    window.tempProfilePhoto = photoUrl;
  };
  reader.readAsDataURL(file);
}

// Sauvegarder les modifications du profil - AVEC VALIDATION GOOGLE/EMAIL
async function saveProfileChanges() {
  const username = document.getElementById('edit-profile-username')?.value.trim();
  const address = document.getElementById('edit-profile-address')?.value.trim();
  const photo = window.tempProfilePhoto || currentUser.profile_photo_url || currentUser.profilePhoto;
  
  if (!username || username.length < 3) {
    showNotification("‚ö†Ô∏è Le nom d'utilisateur doit contenir au moins 3 caract√®res", "warning");
    return;
  }
  
  // Sauvegarder directement les modifications
  window.pendingProfileChanges = {
    username: username,
    postalAddress: address,
    photo: photo
  };
  
  // Appliquer directement sans confirmation Google/Email
  await applyProfileChanges();
}

// Afficher le choix de validation pour les modifications de profil
function showProfileVerificationChoice() {
  const backdrop = document.getElementById('publish-modal-backdrop');
  const modal = document.getElementById('publish-modal-inner');
  
  if (!backdrop || !modal) {
    showNotification("‚ö†Ô∏è Erreur d'affichage", "warning");
    return;
  }
  
  modal.innerHTML = `
    <div style="padding:40px;max-width:500px;margin:0 auto;text-align:center;position:relative;">
      <button onclick="openEditProfileModal()" style="position:absolute;top:16px;right:16px;background:none;border:none;color:var(--ui-text-muted);font-size:24px;cursor:pointer;padding:8px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s;z-index:10;" onmouseover="this.style.background='rgba(239,68,68,0.2)';this.style.color='#ef4444';this.style.transform='scale(1.1)';" onmouseout="this.style.background='none';this.style.color='var(--ui-text-muted)';this.style.transform='scale(1)';" title="Fermer">‚úï</button>
      
      <div style="margin-bottom:32px;">
        <div style="font-size:64px;margin-bottom:16px;">üîê</div>
        <h2 style="margin:0 0 8px;font-size:28px;font-weight:800;color:#fff;background:linear-gradient(135deg,#00ffc3,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Confirmer les modifications</h2>
        <p style="margin:0;font-size:14px;color:var(--ui-text-muted);">Choisissez votre m√©thode de v√©rification</p>
      </div>
      
      <div style="display:flex;flex-direction:column;gap:12px;">
        <button onclick="confirmProfileChangesWithGoogle()" style="width:100%;padding:16px;border-radius:12px;border:2px solid rgba(0,255,195,0.3);background:linear-gradient(135deg,rgba(0,255,195,0.1),rgba(59,130,246,0.1));color:var(--ui-text-main);font-weight:600;font-size:15px;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:12px;" onmouseover="this.style.borderColor='rgba(0,255,195,0.6)';this.style.background='linear-gradient(135deg,rgba(0,255,195,0.2),rgba(59,130,246,0.2))';" onmouseout="this.style.borderColor='rgba(0,255,195,0.3)';this.style.background='linear-gradient(135deg,rgba(0,255,195,0.1),rgba(59,130,246,0.1))';">
          <span>üîµ</span> Confirmer avec Google
        </button>
        <button onclick="confirmProfileChangesWithEmail()" style="width:100%;padding:16px;border-radius:12px;border:2px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:var(--ui-text-main);font-weight:600;font-size:15px;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:12px;" onmouseover="this.style.borderColor='rgba(255,255,255,0.4)';this.style.background='rgba(255,255,255,0.1)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.2)';this.style.background='rgba(255,255,255,0.05)';">
          <span>üìß</span> Confirmer par email
        </button>
      </div>
    </div>
  `;
}

// Confirmer les modifications avec Google
async function confirmProfileChangesWithGoogle() {
  if (!window.pendingProfileChanges) {
    showNotification("‚ö†Ô∏è Aucune modification en attente", "warning");
    return;
  }
  
  // D√©marrer la connexion Google
  if (typeof window.startGoogleLogin === 'function') {
    window.isUpdatingProfile = true;
    window.startGoogleLogin();
  } else {
    showNotification("‚ö†Ô∏è Erreur de connexion Google", "warning");
  }
}

// Confirmer les modifications avec Email
async function confirmProfileChangesWithEmail() {
  if (!window.pendingProfileChanges) {
    showNotification("‚ö†Ô∏è Aucune modification en attente", "warning");
    return;
  }
  
  // Envoyer un email de v√©rification
  try {
    const response = await fetch(`${window.API_BASE_URL || '/api'}/user/send-profile-verification-link`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        changes: window.pendingProfileChanges
      })
    });
    
    if (response.ok) {
      showNotification("‚úÖ Email de v√©rification envoy√© ! V√©rifiez votre bo√Æte mail.", "success");
      openAccountModal();
    } else {
      showNotification("‚ö†Ô∏è Erreur lors de l'envoi de l'email", "warning");
    }
  } catch (error) {
    console.error('Erreur envoi email:', error);
    showNotification("‚ö†Ô∏è Erreur lors de l'envoi de l'email", "warning");
  }
}

// Appliquer les modifications apr√®s validation
async function applyProfileChanges() {
  if (!window.pendingProfileChanges) return;
  
  const { username, postalAddress, photo } = window.pendingProfileChanges;
  
  // Mettre √† jour currentUser
  currentUser.username = username;
  currentUser.postalAddress = postalAddress;
  if (photo) {
    currentUser.profile_photo_url = photo;
    currentUser.profilePhoto = photo;
  }
  
  // Sauvegarder dans localStorage
  try {
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
  } catch (e) {
    try { sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); } catch (e2) {}
  }
  
  // Mettre √† jour le backend
  if (currentUser.isLoggedIn && currentUser.id) {
    try {
      const response = await fetch(`${window.API_BASE_URL || '/api'}/user/profile`, {
        method: 'PUT',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken') || ''}`
        },
        body: JSON.stringify({
          userId: currentUser.id,
          username: username,
          postalAddress: postalAddress,
          profilePhoto: photo
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.user) {
          currentUser = { ...currentUser, ...data.user };
          try {
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
          } catch (e) {
            try { sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); } catch (e2) {}
          }
        }
      }
    } catch (error) {
      console.warn('Erreur sauvegarde profil backend:', error);
    }
  }
  
  // Nettoyer
  window.pendingProfileChanges = null;
  window.isUpdatingProfile = false;
  
  showNotification("‚úÖ Profil modifi√© avec succ√®s !", "success");
  openAccountModal();
  
  // Mettre √† jour l'affichage
  if (typeof window.updateAccountBlock === 'function') {
    window.updateAccountBlock();
  }
}

// Exposer les fonctions globalement pour les onclick
// Exposer les fonctions globalement pour les onclick
window.openEditProfileModal = openEditProfileModal;
window.handleEditProfilePhoto = handleEditProfilePhoto;
window.saveProfileChanges = saveProfileChanges;

// V√©rifier que les fonctions sont bien expos√©es
console.log('‚úÖ Fonctions profil expos√©es:', {
  openEditProfileModal: typeof window.openEditProfileModal,
  handleEditProfilePhoto: typeof window.handleEditProfilePhoto,
  saveProfileChanges: typeof window.saveProfileChanges
});

function togglePrivacy(setting) {
  if (!currentUser.privacySettings) {
    currentUser.privacySettings = {
      showName: true,
      showAvatar: true,
      showBio: true,
      showEmail: false,
      showAddresses: false,
      showFavorites: true,
      showAgenda: true,
      showParticipating: true,
      showFriends: true,
      showActivity: true
    };
  }
  
  currentUser.privacySettings[setting] = !currentUser.privacySettings[setting];
  saveUserData();
  
  const labels = {
    showBio: 'Bio',
    showEmail: 'Email',
    showAddresses: 'Adresses',
    showFavorites: 'Favoris',
    showAgenda: 'Agenda',
    showParticipating: 'Participations',
    showFriends: 'Amis',
    showActivity: 'Statistiques'
  };
  
  showNotification(
    `${currentUser.privacySettings[setting] ? 'üëÅÔ∏è Visible' : 'üîí Masqu√©'}: ${labels[setting] || setting}`, 
    'success'
  );
}

window.togglePrivacy = togglePrivacy;

function openFavoritesModal() {
  // Utiliser currentUser.favorites au lieu de currentUser.likes
  const favorites = currentUser.favorites.map(fav => {
    const type = fav.mode || fav.type;
    const id = parseInt(fav.id);
    const data = type === "event" ? eventsData : type === "booking" ? bookingsData : servicesData;
    const item = data.find(i => i.id === id);
    if (item) {
      return { ...item, favoriteId: fav.id };
    }
    return null;
  }).filter(Boolean);

  const html = `
    <div style="padding:10px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 style="margin:0;font-size:18px;">‚ù§Ô∏è Mes Favoris</h2>
        <button onclick="closePublishModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--ui-text-muted);">‚úï</button>
      </div>
      
      ${favorites.length === 0 ? `
        <div style="text-align:center;padding:40px;color:var(--ui-text-muted);">
          <div style="font-size:48px;margin-bottom:16px;">üíî</div>
          <p>Aucun favori pour le moment</p>
        </div>
      ` : `
        <div style="margin-bottom:12px;font-size:12px;color:var(--ui-text-muted);text-align:center;">
          ${favorites.length} ${favorites.length === 1 ? 'favori' : 'favoris'}
        </div>
        <div id="favorites-list-container" style="max-height:calc(80vh - 180px);overflow-y:auto;">
          ${favorites.slice(0, 20).map(item => `
            <div style="display:flex;gap:12px;padding:12px;border-radius:12px;margin-bottom:8px;background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);cursor:pointer;" onclick="focusOnItem('${item.type}', ${item.id})">
              <div style="width:60px;height:60px;border-radius:8px;background:linear-gradient(135deg,#ef4444,#f97316);display:flex;align-items:center;justify-content:center;font-size:24px;">
                ${getCategoryEmoji(item)}
              </div>
              <div style="flex:1;">
                <div style="font-weight:600;margin-bottom:4px;">${escapeHtml(item.title || item.name)}</div>
                <div style="font-size:12px;color:var(--ui-text-muted);">${item.city}</div>
              </div>
            </div>
          `).join('')}
        </div>
        ${favorites.length > 20 ? `
          <div style="text-align:center;margin-top:12px;padding:12px;background:rgba(15,23,42,0.5);border-radius:8px;border:1px solid var(--ui-card-border);">
            <div style="font-size:12px;color:var(--ui-text-muted);margin-bottom:8px;">
              Affichage de 20 sur ${favorites.length} favoris
            </div>
            <button onclick="loadMoreFavorites()" style="padding:8px 16px;border-radius:8px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-size:12px;">
              Afficher plus (${Math.min(20, favorites.length - 20)} suivants)
            </button>
          </div>
        ` : ''}
      `}
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
  
  // Stocker les favoris complets pour la pagination
  window.favoritesFull = favorites;
  window.favoritesDisplayed = 20;
}

function loadMoreFavorites() {
  if (!window.favoritesFull) return;
  const container = document.getElementById("favorites-list-container");
  if (!container) return;
  
  const start = window.favoritesDisplayed;
  const end = Math.min(start + 20, window.favoritesFull.length);
  const newItems = window.favoritesFull.slice(start, end);
  
  newItems.forEach(item => {
    const itemHtml = `
      <div style="display:flex;gap:12px;padding:12px;border-radius:12px;margin-bottom:8px;background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);cursor:pointer;" onclick="focusOnItem('${item.type}', ${item.id})">
        <div style="width:60px;height:60px;border-radius:8px;background:linear-gradient(135deg,#ef4444,#f97316);display:flex;align-items:center;justify-content:center;font-size:24px;">
          ${getCategoryEmoji(item)}
        </div>
        <div style="flex:1;">
          <div style="font-weight:600;margin-bottom:4px;">${escapeHtml(item.title || item.name)}</div>
          <div style="font-size:12px;color:var(--ui-text-muted);">${item.city}</div>
        </div>
      </div>
    `;
    container.insertAdjacentHTML('beforeend', itemHtml);
  });
  
  window.favoritesDisplayed = end;
  
  // Mettre √† jour le bouton "Afficher plus"
  const moreButton = container.nextElementSibling?.querySelector('button');
  if (moreButton) {
    const remaining = window.favoritesFull.length - end;
    if (remaining > 0) {
      moreButton.textContent = `Afficher plus (${Math.min(20, remaining)} suivants)`;
    } else {
      moreButton.parentElement.remove();
    }
  }
}

function focusOnItem(type, id) {
  closePublishModal();
  const key = `${type}:${id}`;
  const marker = markerMap[key];
  if (marker && map) {
    map.setView(marker.getLatLng(), 14);
    setTimeout(() => marker.openPopup(), 300);
  }
}

// REMOVED: logout() est maintenant dans auth.js et expos√© via window.logout

// ============================================
// UTILITAIRES
// ============================================
function formatEventDateRange(startIso, endIso, isScraped = false) {
  // Date obligatoire - r√©f√©rence: js/core/utils.js
  if (!startIso || !endIso) return "";
  const s = new Date(startIso);
  const e = new Date(endIso);

  const optD = { day: "2-digit", month: "2-digit" };
  const optT = { hour: "2-digit", minute: "2-digit" };

  const sd = s.toLocaleDateString("fr-CH", optD);
  const ed = e.toLocaleDateString("fr-CH", optD);
  
  // Pour les √©v√©nements scrap√©s, on affiche --:-- √† la place de l'heure
  if (isScraped) {
    if (sd === ed) return `${sd} --:-- ‚Äì --:--`;
    return `${sd} --:-- ‚Äì ${ed} --:--`;
  }
  
  const st = s.toLocaleTimeString("fr-CH", optT);
  const et = e.toLocaleTimeString("fr-CH", optT);

  if (sd === ed) return `${sd} ${st}‚Äì${et}`;
  return `${sd} ${st} ‚Äì ${ed} ${et}`;
}

function escapeHtml(str) {
  if (!str) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/"/g, "&quot;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

// Retirer tous les num√©ros de t√©l√©phone des descriptions (bookings, services)
function stripPhoneNumbers(text) {
  if (!text) return "";
  return String(text)
    .replace(/üìû\s*[^\n|]*/g, '')
    .replace(/‚òé\s*[^\n|]*/g, '')
    .replace(/üì±\s*[^\n|]*[\d\s\.\-\(\)]{7,}[^\n|]*/g, '')
    .replace(/(?:Tel|T√©l|T√©l√©phone|Phone|Tel\.|T√©l\.)\s*[:.]?\s*[\+]?[\d\s\.\-\(\)]{7,}/gi, '')
    .replace(/(?:Mobile|Portable|Cell)\s*[:.]?\s*[\+]?[\d\s\.\-\(\)]{7,}/gi, '')
    .replace(/(?:\+\d{1,3}[\s\.\-]?)?\(?\d{2,4}\)?[\s\.\-]?\d{2,4}[\s\.\-]?\d{2,4}[\s\.\-]?\d{0,4}/g, (m) => {
      const d = m.replace(/\D/g, '');
      return d.length >= 8 ? '' : m;
    })
    .replace(/\d{2}[\s\.\-]?\d{2}[\s\.\-]?\d{2}[\s\.\-]?\d{2}[\s\.\-]?\d{2}/g, '')
    .replace(/\b0\d[\s\.\-]?\d{2}[\s\.\-]?\d{2}[\s\.\-]?\d{2}[\s\.\-]?\d{2}\b/g, '')
    .replace(/\s{2,}/g, ' ')
    .trim();
}

// ============================================
// DRAG & DROP PANNEAU FILTRE
// ============================================
function initDragDropPanel() {
  const panel = document.getElementById("left-panel");
  if (!panel) return;
  
  let isDragging = false;
  let startX, startY, startLeft, startTop;
  
  panel.addEventListener("mousedown", (e) => {
    // Ne drag que si on clique sur l'en-t√™te
    if (e.target.closest("#explorer-columns") || e.target.closest("input") || e.target.closest("button")) {
      return;
    }
    
    isDragging = true;
    panel.classList.add("dragging");
    
    startX = e.clientX;
    startY = e.clientY;
    startLeft = panel.offsetLeft;
    startTop = panel.offsetTop;
    
    e.preventDefault();
  });
  
  document.addEventListener("mousemove", (e) => {
    if (!isDragging) return;
    
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    
    panel.style.left = (startLeft + dx) + "px";
    panel.style.top = (startTop + dy) + "px";
  });
  
  document.addEventListener("mouseup", () => {
    isDragging = false;
    panel.classList.remove("dragging");
  });
}

// Initialiser apr√®s le chargement
document.addEventListener("DOMContentLoaded", () => {
  setTimeout(initDragDropPanel, 500);
});

// ============================================
// PLUS DE TH√àMES
// ============================================
const EXTRA_THEMES = [
  {
    name: "Ocean Deep",
    bodyBg: "#0a192f",
    topbarBg: "#000",
    cardBg: "linear-gradient(135deg,#0a192f 0%,#112240 100%)",
    cardBorder: "rgba(100,255,218,0.3)",
    textMain: "#ccd6f6",
    textMuted: "#8892b0",
    btnMainBg: "linear-gradient(135deg,#64ffda 0%,#00bcd4 100%)",
    btnMainText: "#0a192f",
    btnMainShadow: "0 8px 22px rgba(100,255,218,0.5)",
    btnAltBg: "rgba(17,34,64,0.9)",
    btnAltText: "#ccd6f6",
    pillBorder: "rgba(100,255,218,0.3)",
    logoColor: "#64ffda",
    taglineColor: "#8892b0",
    markerAccent: "#64ffda",
    markerBorder: "#00bcd4",
    clusterGradient: "linear-gradient(135deg,#64ffda,#00bcd4,#0ea5e9)"
  },
  {
    name: "Sunset Vibes",
    bodyBg: "linear-gradient(180deg,#1a1a2e 0%,#16213e 100%)",
    topbarBg: "#000",
    cardBg: "rgba(26,26,46,0.9)",
    cardBorder: "rgba(233,69,96,0.4)",
    textMain: "#edf2f4",
    textMuted: "#8d99ae",
    btnMainBg: "linear-gradient(135deg,#e94560 0%,#ff6b6b 100%)",
    btnMainText: "#1a1a2e",
    btnMainShadow: "0 8px 22px rgba(233,69,96,0.6)",
    btnAltBg: "rgba(22,33,62,0.9)",
    btnAltText: "#edf2f4",
    pillBorder: "rgba(233,69,96,0.4)",
    logoColor: "#e94560",
    taglineColor: "#8d99ae",
    markerAccent: "#e94560",
    markerBorder: "#ff6b6b",
    clusterGradient: "linear-gradient(180deg,#e94560,#ff6b6b,#f4a261)"
  },
  {
    name: "Forest Night",
    bodyBg: "#1b2d1b",
    topbarBg: "#000",
    cardBg: "linear-gradient(135deg,#1b2d1b 0%,#2d4a2d 100%)",
    cardBorder: "rgba(144,238,144,0.4)",
    textMain: "#e8f5e9",
    textMuted: "#a5d6a7",
    btnMainBg: "linear-gradient(135deg,#66bb6a 0%,#81c784 100%)",
    btnMainText: "#1b2d1b",
    btnMainShadow: "0 8px 22px rgba(102,187,106,0.6)",
    btnAltBg: "rgba(45,74,45,0.9)",
    btnAltText: "#e8f5e9",
    pillBorder: "rgba(144,238,144,0.4)",
    logoColor: "#81c784",
    taglineColor: "#a5d6a7",
    markerAccent: "#66bb6a",
    markerBorder: "#81c784",
    clusterGradient: "linear-gradient(135deg,#66bb6a,#81c784,#a5d6a7)"
  },
  { name: "Aurore", bodyBg: "#1a0a2e", topbarBg: "#000", cardBg: "linear-gradient(315deg,#2d1b4e 0%,#1a0a2e 100%)", cardBorder: "rgba(251,191,36,0.5)", textMain: "#fef3c7", textMuted: "#fcd34d", btnMainBg: "linear-gradient(270deg,#f59e0b 0%,#ef4444 100%)", btnMainText: "#1a0a2e", btnMainShadow: "0 8px 22px rgba(245,158,11,0.6)", btnAltBg: "rgba(45,27,78,0.9)", btnAltText: "#fef3c7", pillBorder: "rgba(251,191,36,0.5)", logoColor: "#fcd34d", taglineColor: "#fcd34d", markerAccent: "#f59e0b", markerBorder: "#fbbf24", clusterGradient: "linear-gradient(135deg,#f59e0b,#ef4444,#fbbf24)" },
  { name: "Mint Frais", bodyBg: "#ecfdf5", topbarBg: "#000", cardBg: "#ffffff", cardBorder: "rgba(16,185,129,0.4)", textMain: "#064e3b", textMuted: "#047857", btnMainBg: "#10b981", btnMainText: "#ffffff", btnMainShadow: "0 4px 14px rgba(16,185,129,0.4)", btnAltBg: "#d1fae5", btnAltText: "#065f46", pillBorder: "rgba(16,185,129,0.5)", logoColor: "#059669", taglineColor: "#047857", markerAccent: "#10b981", markerBorder: "#34d399", clusterGradient: "linear-gradient(135deg,#10b981,#34d399,#6ee7b7)" },
  { name: "Lavande", bodyBg: "linear-gradient(45deg,#4c1d95 0%,#7c3aed 100%)", topbarBg: "#000", cardBg: "rgba(124,58,237,0.2)", cardBorder: "rgba(196,181,253,0.6)", textMain: "#f5f3ff", textMuted: "#c4b5fd", btnMainBg: "linear-gradient(180deg,#8b5cf6 0%,#a78bfa 100%)", btnMainText: "#1e1b4b", btnMainShadow: "0 8px 24px rgba(139,92,246,0.6)", btnAltBg: "rgba(76,29,149,0.8)", btnAltText: "#f5f3ff", pillBorder: "rgba(196,181,253,0.6)", logoColor: "#e9d5ff", taglineColor: "#c4b5fd", markerAccent: "#8b5cf6", markerBorder: "#a78bfa", clusterGradient: "linear-gradient(135deg,#8b5cf6,#a78bfa,#c084fc)" },
  { name: "Braise", bodyBg: "#1c1917", topbarBg: "#000", cardBg: "linear-gradient(225deg,#292524 0%,#1c1917 100%)", cardBorder: "rgba(251,146,60,0.5)", textMain: "#ffedd5", textMuted: "#fdba74", btnMainBg: "linear-gradient(90deg,#ea580c 0%,#f97316 100%)", btnMainText: "#1c1917", btnMainShadow: "0 8px 22px rgba(234,88,12,0.6)", btnAltBg: "rgba(41,37,36,0.9)", btnAltText: "#ffedd5", pillBorder: "rgba(251,146,60,0.5)", logoColor: "#fb923c", taglineColor: "#fdba74", markerAccent: "#f97316", markerBorder: "#fb923c", clusterGradient: "linear-gradient(225deg,#ea580c,#f97316,#fb923c)" },
  { name: "Arctique", bodyBg: "#f0f9ff", topbarBg: "#000", cardBg: "#e0f2fe", cardBorder: "rgba(14,165,233,0.4)", textMain: "#0c4a6e", textMuted: "#0369a1", btnMainBg: "#0ea5e9", btnMainText: "#ffffff", btnMainShadow: "0 4px 14px rgba(14,165,233,0.4)", btnAltBg: "#bae6fd", btnAltText: "#0c4a6e", pillBorder: "rgba(14,165,233,0.5)", logoColor: "#0284c7", taglineColor: "#0369a1", markerAccent: "#0ea5e9", markerBorder: "#38bdf8", clusterGradient: "linear-gradient(135deg,#0ea5e9,#38bdf8,#7dd3fc)" },
  { name: "Noir Profond", bodyBg: "#000000", topbarBg: "#000", cardBg: "#0a0a0a", cardBorder: "rgba(255,255,255,0.15)", textMain: "#fafafa", textMuted: "#a3a3a3", btnMainBg: "#525252", btnMainText: "#fafafa", btnMainShadow: "none", btnAltBg: "#171717", btnAltText: "#fafafa", pillBorder: "rgba(255,255,255,0.2)", logoColor: "#ffffff", taglineColor: "#a3a3a3", markerAccent: "#737373", markerBorder: "#a3a3a3" },
  { name: "Jade", bodyBg: "linear-gradient(135deg,#022c22 0%,#064e3b 100%)", topbarBg: "#000", cardBg: "rgba(6,78,59,0.4)", cardBorder: "rgba(52,211,153,0.4)", textMain: "#ccfbf1", textMuted: "#5eead4", btnMainBg: "linear-gradient(315deg,#059669 0%,#10b981 100%)", btnMainText: "#022c22", btnMainShadow: "0 8px 22px rgba(5,150,105,0.5)", btnAltBg: "rgba(2,44,34,0.9)", btnAltText: "#ccfbf1", pillBorder: "rgba(52,211,153,0.4)", logoColor: "#5eead4", taglineColor: "#99f6e4", markerAccent: "#10b981", markerBorder: "#34d399", clusterGradient: "linear-gradient(315deg,#059669,#10b981,#34d399)" },
  { name: "Coral", bodyBg: "#fff5f5", topbarBg: "#000", cardBg: "#ffe4e6", cardBorder: "rgba(244,63,94,0.4)", textMain: "#881337", textMuted: "#be123c", btnMainBg: "#f43f5e", btnMainText: "#ffffff", btnMainShadow: "0 4px 14px rgba(244,63,94,0.4)", btnAltBg: "#fecdd3", btnAltText: "#881337", pillBorder: "rgba(244,63,94,0.5)", logoColor: "#e11d48", taglineColor: "#be123c", markerAccent: "#f43f5e", markerBorder: "#fb7185", clusterGradient: "linear-gradient(135deg,#f43f5e,#fb7185,#e11d48)" },
  { name: "Violet Nocturne", bodyBg: "linear-gradient(60deg,#1e1b4b 0%,#312e81 100%)", topbarBg: "#000", cardBg: "rgba(67,56,202,0.3)", cardBorder: "rgba(167,139,250,0.5)", textMain: "#ede9fe", textMuted: "#c4b5fd", btnMainBg: "linear-gradient(120deg,#6366f1 0%,#8b5cf6 100%)", btnMainText: "#ffffff", btnMainShadow: "0 8px 24px rgba(99,102,241,0.6)", btnAltBg: "rgba(30,27,75,0.9)", btnAltText: "#ede9fe", pillBorder: "rgba(167,139,250,0.5)", logoColor: "#c4b5fd", taglineColor: "#a78bfa", markerAccent: "#6366f1", markerBorder: "#8b5cf6", clusterGradient: "linear-gradient(120deg,#6366f1,#8b5cf6,#a78bfa)" },
  { name: "√âlectrique", bodyBg: "#0f172a", topbarBg: "#000", cardBg: "#1e293b", cardBorder: "rgba(34,211,238,0.6)", textMain: "#e0f2fe", textMuted: "#7dd3fc", btnMainBg: "linear-gradient(135deg,#06b6d4 0%,#22d3ee 100%)", btnMainText: "#0f172a", btnMainShadow: "0 8px 24px rgba(34,211,238,0.6)", btnAltBg: "rgba(30,41,59,0.9)", btnAltText: "#e0f2fe", pillBorder: "rgba(34,211,238,0.6)", logoColor: "#22d3ee", taglineColor: "#7dd3fc", markerAccent: "#22d3ee", markerBorder: "#67e8f9", clusterGradient: "linear-gradient(135deg,#06b6d4,#22d3ee,#67e8f9)" },
  { name: "Ciel Lumineux", bodyBg: "#eff6ff", topbarBg: "#000", cardBg: "#dbeafe", cardBorder: "rgba(59,130,246,0.5)", textMain: "#1e3a8a", textMuted: "#2563eb", btnMainBg: "#3b82f6", btnMainText: "#ffffff", btnMainShadow: "0 4px 14px rgba(59,130,246,0.5)", btnAltBg: "#bfdbfe", btnAltText: "#1e40af", pillBorder: "rgba(59,130,246,0.5)", logoColor: "#2563eb", taglineColor: "#3b82f6", markerAccent: "#3b82f6", markerBorder: "#60a5fa", clusterGradient: "linear-gradient(135deg,#3b82f6,#60a5fa,#93c5fd)" },
  // +10 th√®mes : d√©grad√©s vari√©s (direction/sens diff√©rents) + couleurs plates
  { name: "Citron Vert", bodyBg: "#052e16", topbarBg: "#000", cardBg: "#064e3b", cardBorder: "rgba(34,197,94,0.5)", textMain: "#dcfce7", textMuted: "#86efac", btnMainBg: "#22c55e", btnMainText: "#052e16", btnMainShadow: "0 4px 14px rgba(34,197,94,0.5)", btnAltBg: "rgba(6,78,59,0.9)", btnAltText: "#dcfce7", pillBorder: "rgba(34,197,94,0.5)", logoColor: "#4ade80", taglineColor: "#86efac", markerAccent: "#22c55e", markerBorder: "#4ade80", clusterGradient: "linear-gradient(225deg,#22c55e,#4ade80,#16a34a)" },
  { name: "Feu", bodyBg: "#0c0a09", topbarBg: "#000", cardBg: "linear-gradient(0deg,#1c1917 0%,#292524 100%)", cardBorder: "rgba(249,115,22,0.5)", textMain: "#fff7ed", textMuted: "#fdba74", btnMainBg: "#f97316", btnMainText: "#fafafa", btnMainShadow: "0 4px 14px rgba(249,115,22,0.5)", btnAltBg: "rgba(41,37,36,0.9)", btnAltText: "#fff7ed", pillBorder: "rgba(249,115,22,0.5)", logoColor: "#fb923c", taglineColor: "#fdba74", markerAccent: "#f97316", markerBorder: "#fb923c", clusterGradient: "linear-gradient(90deg,#ef4444,#f97316,#fbbf24)" },
  { name: "Oc√©an", bodyBg: "#0c4a6e", topbarBg: "#000", cardBg: "linear-gradient(180deg,#0e7490 0%,#0c4a6e 100%)", cardBorder: "rgba(34,211,238,0.5)", textMain: "#ecfeff", textMuted: "#67e8f9", btnMainBg: "#06b6d4", btnMainText: "#0c4a6e", btnMainShadow: "0 4px 14px rgba(6,182,212,0.5)", btnAltBg: "rgba(8,145,178,0.9)", btnAltText: "#ecfeff", pillBorder: "rgba(34,211,238,0.5)", logoColor: "#22d3ee", taglineColor: "#67e8f9", markerAccent: "#06b6d4", markerBorder: "#22d3ee", clusterGradient: "linear-gradient(135deg,#0ea5e9,#06b6d4,#22d3ee)" },
  { name: "Rouge Plat", bodyBg: "#450a0a", topbarBg: "#000", cardBg: "#7f1d1d", cardBorder: "rgba(248,113,113,0.5)", textMain: "#fef2f2", textMuted: "#fecaca", btnMainBg: "#dc2626", btnMainText: "#fff", btnMainShadow: "0 4px 14px rgba(220,38,38,0.5)", btnAltBg: "#991b1b", btnAltText: "#fef2f2", pillBorder: "rgba(248,113,113,0.5)", logoColor: "#f87171", taglineColor: "#fecaca", markerAccent: "#dc2626", markerBorder: "#f87171" },
  { name: "Vert Plat", bodyBg: "#052e16", topbarBg: "#000", cardBg: "#14532d", cardBorder: "rgba(74,222,128,0.5)", textMain: "#f0fdf4", textMuted: "#bbf7d0", btnMainBg: "#16a34a", btnMainText: "#fff", btnMainShadow: "0 4px 14px rgba(22,163,74,0.5)", btnAltBg: "#166534", btnAltText: "#f0fdf4", pillBorder: "rgba(74,222,128,0.5)", logoColor: "#4ade80", taglineColor: "#bbf7d0", markerAccent: "#16a34a", markerBorder: "#4ade80" },
  { name: "Bleu Plat", bodyBg: "#0c4a6e", topbarBg: "#000", cardBg: "#1e3a8a", cardBorder: "rgba(96,165,250,0.5)", textMain: "#eff6ff", textMuted: "#bfdbfe", btnMainBg: "#2563eb", btnMainText: "#fff", btnMainShadow: "0 4px 14px rgba(37,99,235,0.5)", btnAltBg: "#1e40af", btnAltText: "#eff6ff", pillBorder: "rgba(96,165,250,0.5)", logoColor: "#60a5fa", taglineColor: "#bfdbfe", markerAccent: "#2563eb", markerBorder: "#60a5fa" },
  { name: "Violet Plat", bodyBg: "#2e1065", topbarBg: "#000", cardBg: "#4c1d95", cardBorder: "rgba(167,139,250,0.5)", textMain: "#f5f3ff", textMuted: "#c4b5fd", btnMainBg: "#7c3aed", btnMainText: "#fff", btnMainShadow: "0 4px 14px rgba(124,58,237,0.5)", btnAltBg: "#5b21b6", btnAltText: "#f5f3ff", pillBorder: "rgba(167,139,250,0.5)", logoColor: "#a78bfa", taglineColor: "#c4b5fd", markerAccent: "#7c3aed", markerBorder: "#a78bfa" },
  { name: "Arc-en-ciel", bodyBg: "#0f172a", topbarBg: "#000", cardBg: "linear-gradient(270deg,#0f172a 0%,#1e1b4b 50%,#0f172a 100%)", cardBorder: "rgba(139,92,246,0.5)", textMain: "#f8fafc", textMuted: "#c4b5fd", btnMainBg: "linear-gradient(90deg,#ec4899 0%,#8b5cf6 50%,#06b6d4 100%)", btnMainText: "#fff", btnMainShadow: "0 4px 14px rgba(139,92,246,0.5)", btnAltBg: "rgba(30,27,75,0.9)", btnAltText: "#f8fafc", pillBorder: "rgba(139,92,246,0.5)", logoColor: "#a78bfa", taglineColor: "#c4b5fd", markerAccent: "#8b5cf6", markerBorder: "#a78bfa", clusterGradient: "linear-gradient(135deg,#ec4899,#8b5cf6,#06b6d4)" },
  { name: "Rouge-Or", bodyBg: "#1c1917", topbarBg: "#000", cardBg: "linear-gradient(45deg,#450a0a 0%,#78350f 100%)", cardBorder: "rgba(251,191,36,0.5)", textMain: "#fef3c7", textMuted: "#fde68a", btnMainBg: "linear-gradient(270deg,#dc2626 0%,#f59e0b 100%)", btnMainText: "#1c1917", btnMainShadow: "0 4px 14px rgba(245,158,11,0.5)", btnAltBg: "rgba(68,64,60,0.9)", btnAltText: "#fef3c7", pillBorder: "rgba(251,191,36,0.5)", logoColor: "#fbbf24", taglineColor: "#fde68a", markerAccent: "#f59e0b", markerBorder: "#fbbf24", clusterGradient: "linear-gradient(135deg,#dc2626,#f59e0b,#fbbf24)" },
  { name: "Menthe", bodyBg: "#134e4a", topbarBg: "#000", cardBg: "linear-gradient(120deg,#0f766e 0%,#134e4a 100%)", cardBorder: "rgba(45,212,191,0.5)", textMain: "#ccfbf1", textMuted: "#5eead4", btnMainBg: "#14b8a6", btnMainText: "#042f2e", btnMainShadow: "0 4px 14px rgba(20,184,166,0.5)", btnAltBg: "rgba(13,148,136,0.9)", btnAltText: "#ccfbf1", pillBorder: "rgba(45,212,191,0.5)", logoColor: "#2dd4bf", taglineColor: "#5eead4", markerAccent: "#14b8a6", markerBorder: "#2dd4bf", clusterGradient: "linear-gradient(135deg,#0d9488,#14b8a6,#2dd4bf)" },
  { name: "Indigo Plat", bodyBg: "#1e1b4b", topbarBg: "#000", cardBg: "#312e81", cardBorder: "rgba(129,140,248,0.5)", textMain: "#e0e7ff", textMuted: "#a5b4fc", btnMainBg: "#4f46e5", btnMainText: "#fff", btnMainShadow: "0 4px 14px rgba(79,70,229,0.5)", btnAltBg: "#3730a3", btnAltText: "#e0e7ff", pillBorder: "rgba(129,140,248,0.5)", logoColor: "#818cf8", taglineColor: "#a5b4fc", markerAccent: "#4f46e5", markerBorder: "#818cf8" },
  { name: "Tropical", bodyBg: "linear-gradient(45deg,#0f766e 0%,#0c4a6e 50%,#7c3aed 100%)", topbarBg: "#000", cardBg: "linear-gradient(315deg,#134e4a 0%,#1e3a8a 50%,#4c1d95 100%)", cardBorder: "rgba(45,212,191,0.5)", textMain: "#ccfbf1", textMuted: "#67e8f9", btnMainBg: "linear-gradient(90deg,#14b8a6 0%,#3b82f6 50%,#8b5cf6 100%)", btnMainText: "#fff", btnMainShadow: "0 4px 14px rgba(20,184,166,0.5)", btnAltBg: "rgba(13,148,136,0.9)", btnAltText: "#ccfbf1", pillBorder: "rgba(45,212,191,0.5)", logoColor: "#2dd4bf", taglineColor: "#a78bfa", markerAccent: "#14b8a6", markerBorder: "#8b5cf6", clusterGradient: "linear-gradient(135deg,#14b8a6,#3b82f6,#8b5cf6)" },
  { name: "Sunset Fire", bodyBg: "linear-gradient(225deg,#7f1d1d 0%,#c2410c 30%,#ea580c 60%,#fbbf24 100%)", topbarBg: "#000", cardBg: "linear-gradient(315deg,#450a0a 0%,#78350f 50%,#b45309 100%)", cardBorder: "rgba(251,191,36,0.5)", textMain: "#fef3c7", textMuted: "#fde68a", btnMainBg: "linear-gradient(180deg,#dc2626 0%,#f97316 50%,#eab308 100%)", btnMainText: "#111827", btnMainShadow: "0 4px 14px rgba(249,115,22,0.5)", btnAltBg: "rgba(127,29,29,0.9)", btnAltText: "#fef3c7", pillBorder: "rgba(251,191,36,0.5)", logoColor: "#fbbf24", taglineColor: "#fde68a", markerAccent: "#f97316", markerBorder: "#fbbf24", clusterGradient: "linear-gradient(225deg,#dc2626,#f97316,#fbbf24)" },
  { name: "Neon Glow", bodyBg: "linear-gradient(135deg,#0f172a 0%,#1e1b4b 40%,#4c1d95 70%,#701a75 100%)", topbarBg: "#000", cardBg: "linear-gradient(60deg,#1e293b 0%,#312e81 50%,#5b21b6 100%)", cardBorder: "rgba(251,113,133,0.5)", textMain: "#fef3c7", textMuted: "#fbcfe8", btnMainBg: "linear-gradient(270deg,#06b6d4 0%,#22d3ee 33%,#fb7185 66%,#ec4899 100%)", btnMainText: "#0f172a", btnMainShadow: "0 4px 14px rgba(34,211,238,0.5)", btnAltBg: "rgba(30,27,75,0.9)", btnAltText: "#fef3c7", pillBorder: "rgba(251,113,133,0.5)", logoColor: "#fbcfe8", taglineColor: "#fb7185", markerAccent: "#22d3ee", markerBorder: "#fb7185", clusterGradient: "linear-gradient(135deg,#06b6d4,#a78bfa,#ec4899)" }
];

// Ajouter les nouveaux th√®mes
UI_THEMES.push(...EXTRA_THEMES);

// ============================================
// EXPOSE FUNCTIONS
// ============================================
window.switchMode = switchMode;
window.toggleLeftPanel = toggleLeftPanel;
window.toggleListView = toggleListView;
window.openPublishModal = openPublishModal;
window.closePublishModal = closePublishModal;
// REMOVED: closeAuthModal est maintenant dans auth.js et expos√© via window.closeAuthModal
// REMOVED: openRegisterModal est maintenant dans auth.js (ou wrapper utilisant window.openAuthModal)
window.showProRegisterForm = showProRegisterForm;
window.cycleUITheme = cycleUITheme;
window.cycleMapTheme = cycleMapTheme;
window.onSearchCity = onSearchCity;
// Exposer les fonctions de validation et d'affichage
// ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è validateProField est d√©j√† expos√©e ligne 13013, ne pas r√©exposer ici si elle n'existe pas encore
if (typeof validateProField !== 'undefined') {
  window.validateProField = validateProField;
}
if (typeof validateProPassword !== 'undefined') {
  window.validateProPassword = validateProPassword;
}
if (typeof showError !== 'undefined') {
  window.showError = showError;
}
if (typeof showSuccess !== 'undefined') {
  window.showSuccess = showSuccess;
}

// Exposer les fonctions du formulaire de publication
window.toggleRepeatOptions = toggleRepeatOptions;
window.updateRepeatPreview = updateRepeatPreview;
window.onRepeatFrequencyChange = onRepeatFrequencyChange;
window.selectMonthDay = selectMonthDay;
window.initWeekdayCheckboxStyles = initWeekdayCheckboxStyles;
window.toggleAdvancedOptions = toggleAdvancedOptions;
window.initRepeatHandlers = initRepeatHandlers;
window.initMultipleImagesHandler = initMultipleImagesHandler;
window.onAction = onAction;
window.onBuyContact = onBuyContact;
window.toggleCategory = toggleCategory;
window.setTimeFilter = setTimeFilter;
window.openNextLevel = openNextLevel;
window.removeSelectedCategory = removeSelectedCategory;
window.closePopupModal = closePopupModal;
window.openPopupFromList = openPopupFromList;
window.closePopupModal = closePopupModal;
window.selectCityForSorting = selectCityForSorting;
window.resetExplorerFilter = resetExplorerFilter;
window.closeLeftPanel = closeLeftPanel;
window.toggleDateFilter = toggleDateFilter;
window.openAgendaModal = openAgendaModal;
window.toggleAgendaWindow = toggleAgendaWindow;
window.showAgendaMiniWindow = showAgendaMiniWindow;
window.hideAgendaMiniWindow = hideAgendaMiniWindow;
// REMOVED: Les fonctions AUTH sont maintenant dans auth.js
// Les wrappers openLoginModal et openRegisterModal sont d√©finis plus haut et utilisent window.openAuthModal
// REMOVED: performRegister est maintenant dans auth.js et expos√© via window.performRegister
window.simulateLogin = simulateLogin;
// REMOVED: performLogin est maintenant dans auth.js et expos√© via window.performLogin
window.openReviewModal = openReviewModal;
window.setRating = setRating;
window.submitReview = submitReview;
window.openDiscussionModal = openDiscussionModal;
window.openEventDiscussion = window.openEventDiscussion || function(type, id) {
  if (typeof window.openDiscussionModal === 'function') {
    window.openDiscussionModal(type, id);
  }
};
window.submitDiscussionComment = window.submitDiscussionComment || function(type, id) {
  // D√©j√† d√©fini plus haut dans le code
};
window.showReplyForm = window.showReplyForm || function(commentId) {
  // D√©j√† d√©fini plus haut dans le code
};
window.submitReply = window.submitReply || function(type, id, commentId) {
  // D√©j√† d√©fini plus haut dans le code
};
window.loadReviewPage = loadReviewPage;
window.validateStep2 = validateStep2;
window.showRegisterStep1 = showRegisterStep1;
window.showRegisterStep2 = showRegisterStep2;
window.showRegisterStep3 = showRegisterStep3;
window.completeRegistration = completeRegistration;
window.openSubscriptionModal = openSubscriptionModal;
window.openCartModal = openCartModal;

// Fonction formatDate globale
function formatDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString("fr-CH", { day: "2-digit", month: "short", year: date.getFullYear() !== new Date().getFullYear() ? "numeric" : undefined });
}
window.formatDate = formatDate;
window.openReportModal = openReportModal;
window.submitReport = submitReport;
window.openPaymentModal = openPaymentModal;
window.simulatePayment = simulatePayment; // Fallback
window.processContactPayment = processContactPayment;
window.processSubscriptionPayment = processSubscriptionPayment;
window.processCartCheckout = processCartCheckout;
window.loadUserSubscription = loadUserSubscription;
window.removeFromAgenda = removeFromAgenda;
window.showRegisterForm = showRegisterForm;
window.addAddressField = addAddressField;
window.removeAddressField = removeAddressField;
window.geocodeAddress = geocodeAddress;
window.showRegisterStep1 = showRegisterStep1;
window.showRegisterStep2 = showRegisterStep2;
window.showRegisterStep2_5 = showRegisterStep2_5;
window.showRegisterStep3 = showRegisterStep3;
window.validateEmailRealTime = validateEmailRealTime;
window.validateUsernameRealTime = validateUsernameRealTime;
window.validateNameRealTime = validateNameRealTime;
window.checkPasswordStrength = checkPasswordStrength;
window.togglePasswordVisibility = togglePasswordVisibility;
window.socialLogin = socialLogin;
window.showTermsModal = showTermsModal;
window.showPrivacyModal = showPrivacyModal;
window.sendVerificationCode = sendVerificationCode;
window.resendVerificationCode = resendVerificationCode;
window.verifyEmailCode = verifyEmailCode;
window.handleCodeInput = handleCodeInput;
window.handleCodeKeydown = handleCodeKeydown;
window.generateCaptcha = generateCaptcha;
window.completeRegistration = completeRegistration;
window.deleteAlertWithWarning = deleteAlertWithWarning;
window.openSubscriptionModal = openSubscriptionModal;
window.createAlert = createAlert;
window.removeAlert = removeAlert;
window.addEventAlert = addEventAlert;
window.selectPlan = selectPlan;
window.openPremiumPaymentModal = openPremiumPaymentModal;
window.simulatePremiumPayment = simulatePremiumPayment;
window.openAboutModal = openAboutModal;
window.selectAvatar = selectAvatar;
window.openFavoritesModal = openFavoritesModal;
window.openFriendsModal = openFriendsModal;
// openGroupsModal est d√©j√† expos√© imm√©diatement apr√®s sa d√©finition (ligne 10436)
// window.openGroupsModal = openGroupsModal; // D√âJ√Ä EXPOS√â
// openSocialAlertsModal sera expos√© apr√®s sa d√©finition
// Fonction stub pour openGroupChannel (√† impl√©menter si n√©cessaire)
function openGroupChannel(groupId) {
  console.warn('openGroupChannel appel√© mais non impl√©ment√©:', groupId);
  showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
}
window.openGroupChannel = openGroupChannel;
// Fonction stub pour createGroup (√† impl√©menter si n√©cessaire)
function createGroup() {
  console.warn('createGroup appel√© mais non impl√©ment√©');
  showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
}
window.createGroup = createGroup;
// Fonction stub pour confirmCreateGroup (√† impl√©menter si n√©cessaire)
function confirmCreateGroup() {
  console.warn('confirmCreateGroup appel√© mais non impl√©ment√©');
  showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
}
window.confirmCreateGroup = confirmCreateGroup;
// Fonction stub pour changeGroupCountry (√† impl√©menter si n√©cessaire)
function changeGroupCountry() {
  console.warn('changeGroupCountry appel√© mais non impl√©ment√©');
  showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
}
window.changeGroupCountry = changeGroupCountry;
// Fonction stub pour sendGroupMessage (√† impl√©menter si n√©cessaire)
function sendGroupMessage() {
  console.warn('sendGroupMessage appel√© mais non impl√©ment√©');
  showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
}
window.sendGroupMessage = sendGroupMessage;
// Fonction stub pour inviteFriendFromPopup (√† impl√©menter si n√©cessaire)
function inviteFriendFromPopup() {
  console.warn('inviteFriendFromPopup appel√© mais non impl√©ment√©');
  showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
}
window.inviteFriendFromPopup = inviteFriendFromPopup;
window.inviteFriendsToEvent = inviteFriendsToEvent;
// sharePopup est d√©j√† expos√© apr√®s sa d√©finition (ligne 7060)
// window.sharePopup = sharePopup; // D√âJ√Ä EXPOS√â
// Fonction stub pour viewEventAttendees (√† impl√©menter si n√©cessaire)
function viewEventAttendees(type, id) {
  console.warn('viewEventAttendees appel√© mais non impl√©ment√©:', type, id);
  showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
}
window.viewEventAttendees = viewEventAttendees;
// Fonction stub pour shareToGroup (√† impl√©menter si n√©cessaire)
function shareToGroup() {
  console.warn('shareToGroup appel√© mais non impl√©ment√©');
  showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
}
window.shareToGroup = shareToGroup;
// Fonction stub pour shareToFriend (√† impl√©menter si n√©cessaire)
function shareToFriend() {
  console.warn('shareToFriend appel√© mais non impl√©ment√©');
  showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
}
window.shareToFriend = shareToFriend;
// copyShareLink est d√©j√† d√©fini ailleurs (ligne 7375)
// window.copyShareLink = copyShareLink;
// Fonction stub pour shareEventToChannel (√† impl√©menter si n√©cessaire)
function shareEventToChannel() {
  console.warn('shareEventToChannel appel√© mais non impl√©ment√©');
  showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
}
window.shareEventToChannel = shareEventToChannel;
// Fonction stub pour addToAgendaFromChannel (√† impl√©menter si n√©cessaire)
function addToAgendaFromChannel(type, id) {
  console.warn('addToAgendaFromChannel appel√© mais non impl√©ment√©:', type, id);
  // Utiliser la fonction existante toggleAgenda si disponible
  if (typeof toggleAgenda === 'function') {
    toggleAgenda(type, id);
  } else {
    showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
  }
}
window.addToAgendaFromChannel = addToAgendaFromChannel;
// Fonction stub pour reportMessage (√† impl√©menter si n√©cessaire)
function reportMessage() {
  console.warn('reportMessage appel√© mais non impl√©ment√©');
  showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
}
window.reportMessage = reportMessage;
// Fonction stub pour shareGroupChannel (√† impl√©menter si n√©cessaire)
function shareGroupChannel() {
  console.warn('shareGroupChannel appel√© mais non impl√©ment√©');
  showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
}
window.shareGroupChannel = shareGroupChannel;
// Fonction stub pour handleSocialAlert (√† impl√©menter si n√©cessaire)
function handleSocialAlert() {
  console.warn('handleSocialAlert appel√© mais non impl√©ment√©');
  showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
}
window.handleSocialAlert = handleSocialAlert;
// Fonction stub pour updateSocialAlertsCount (√† impl√©menter si n√©cessaire)
function updateSocialAlertsCount() {
  console.warn('updateSocialAlertsCount appel√© mais non impl√©ment√©');
  // Ne rien faire pour l'instant
}
window.updateSocialAlertsCount = updateSocialAlertsCount;
window.inviteFriendsToEvent = inviteFriendsToEvent;
window.filterInviteFriends = filterInviteFriends;
window.sendInvitationToFriend = sendInvitationToFriend;
window.openUserProfile = openUserProfile;
window.editProfile = editProfile;
window.saveProfile = saveProfile;
window.viewPhoto = viewPhoto;
window.viewVideo = viewVideo;

// ============================================
// INT√âGRATION BACKEND ET WEBSOCKET
// ============================================

// Connexion WebSocket pour notifications temps r√©el
let socket = null;
let socketConnected = false;

function initWebSocket() {
  if (!currentUser || !currentUser.isLoggedIn) return;
  
  try {
    // Pour Lambda/API Gateway, WebSocket n√©cessite un endpoint s√©par√©
    // Pour l'instant, on simule avec polling
    // En production, utiliser: const wsUrl = 'wss://your-websocket-api.execute-api.region.amazonaws.com/production';
    
    // Simulation avec polling toutes les 5 secondes
    if (window.socketInterval) clearInterval(window.socketInterval);
    
    window.socketInterval = setInterval(() => {
      checkForNewNotifications();
      checkForNewMessages();
    }, 5000);
    
    socketConnected = true;
    console.log('‚úÖ WebSocket simul√© activ√© (polling)');
  } catch (error) {
    console.error('Erreur connexion WebSocket:', error);
    socketConnected = false;
  }
}

// V√©rifier les nouvelles notifications
// D√âSACTIV√â TEMPORAIREMENT - route /api/social/alerts pas encore cr√©√©e
async function checkForNewNotifications() {
  // Route pas encore impl√©ment√©e c√¥t√© backend - √©vite le spam de 404
  return;
}

// V√©rifier les nouveaux messages dans les groupes actifs
async function checkForNewMessages() {
  if (!currentUser.isLoggedIn || !window.activeGroupChannels) return;
  
  for (const groupId of window.activeGroupChannels) {
    try {
      const response = await fetch(`${window.API_BASE_URL}/social/groups/${groupId}/messages?userId=${currentUser.id}&limit=1`);
      if (response.ok) {
        const data = await response.json();
        if (data.messages && data.messages.length > 0) {
          const latestMessage = data.messages[0];
          // V√©rifier si c'est un nouveau message
          if (!window.groupChannels[groupId] || 
              !window.groupChannels[groupId].find(m => m.id === latestMessage.id)) {
            // Ajouter le nouveau message
            if (!window.groupChannels[groupId]) window.groupChannels[groupId] = [];
            window.groupChannels[groupId].unshift({
              id: latestMessage.id,
              from: latestMessage.userId,
              fromName: latestMessage.username,
              fromAvatar: currentUser.avatar,
              text: latestMessage.message,
              attachments: latestMessage.attachments || [],
              reactions: latestMessage.reactions || {},
              time: latestMessage.createdAt,
              status: latestMessage.status,
              type: 'user'
            });
            
            // Rafra√Æchir la vue si le canal est ouvert
            if (document.getElementById(`group-messages-${groupId}`)) {
              openGroupChannel(groupId, '', '', '');
            }
          }
        }
      }
    } catch (error) {
      console.error(`Erreur v√©rification messages groupe ${groupId}:`, error);
    }
  }
}

// Mod√©rer une image avant upload
async function moderateImageBeforeUpload(imageUrl) {
  try {
    const response = await fetch(`${window.API_BASE_URL}/social/moderation/image`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        imageUrl: imageUrl,
        userId: currentUser.id
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      return data.isSafe;
    }
    return true; // En cas d'erreur, on accepte (sera mod√©r√© manuellement)
  } catch (error) {
    console.error('Erreur mod√©ration image:', error);
    return true; // En cas d'erreur, on accepte
  }
}

// Envoyer un message avec int√©gration backend
async function sendGroupMessageBackend(channelId, channelName, messageText) {
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  try {
    const response = await fetch(`${window.API_BASE_URL}/social/groups/${channelId}/messages`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id,
        message: messageText,
        attachments: []
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      
      // Ajouter le message localement
      if (!window.groupChannels) window.groupChannels = {};
      if (!window.groupChannels[channelId]) window.groupChannels[channelId] = [];
      
      window.groupChannels[channelId].push({
        id: data.messageId,
        from: currentUser.id,
        fromName: currentUser.name,
        fromAvatar: currentUser.avatar,
        text: messageText,
        time: data.createdAt,
        status: data.status,
        type: 'user'
      });
      
      // Si en attente de mod√©ration, afficher un message
      if (data.status === 'pending_moderation') {
        showNotification("‚ö†Ô∏è Votre message est en attente de mod√©ration", "warning");
      }
      
      // Rafra√Æchir la vue
      openGroupChannel(channelId, channelName, '', '');
      
      // Simuler l'envoi via WebSocket
      if (socketConnected) {
        // En production, utiliser socket.emit('send_message', {...})
        console.log('Message envoy√© via backend');
      }
    } else {
      const error = await response.json();
      showNotification(`Erreur: ${error.error}`, "error");
    }
  } catch (error) {
    console.error('Erreur envoi message:', error);
    showNotification("Erreur lors de l'envoi du message", "error");
  }
}

// Ajouter une r√©action √† un message
async function addMessageReaction(messageId, emoji) {
  if (!currentUser || !currentUser.isLoggedIn) return;
  
  try {
    const response = await fetch(`${window.API_BASE_URL}/social/messages/${messageId}/reaction`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id,
        emoji: emoji
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      return data.reactions;
    }
  } catch (error) {
    console.error('Erreur ajout r√©action:', error);
  }
  return null;
}

// Mettre √† jour la fonction sendGroupMessage pour utiliser le backend
const originalSendGroupMessage = sendGroupMessage;
sendGroupMessage = function(channelId, channelName) {
  const input = document.getElementById(`group-input-${channelId}`);
  if (!input || !input.value.trim()) return;
  
  const messageText = input.value.trim();
  input.value = '';
  
  // Utiliser le backend
  sendGroupMessageBackend(channelId, channelName, messageText);
};

// Mettre √† jour saveProfile pour mod√©rer les images
const originalSaveProfile = saveProfile;
saveProfile = async function() {
  const bio = document.getElementById("edit-profile-bio")?.value.trim() || '';
  const photosText = document.getElementById("edit-profile-photos")?.value.trim() || '';
  const photos = photosText.split('\n').filter(url => url.trim() && url.startsWith('http'));
  
  // Mod√©rer chaque photo
  const photosFiltered = [];
  for (const photo of photos) {
    const isSafe = await moderateImageBeforeUpload(photo);
    if (isSafe) {
      photosFiltered.push(photo);
    } else {
      showNotification(`‚ö†Ô∏è Photo rejet√©e (contenu inappropri√©): ${photo.substring(0, 50)}...`, "warning");
    }
  }
  
  // Sauvegarder via backend
  try {
    const response = await fetch(`${window.API_BASE_URL}/social/profile`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id,
        bio: bio,
        profilePhotos: photosFiltered,
        profileVideos: currentUser.profileVideos || [],
        profileLinks: currentUser.profileLinks || []
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      currentUser.bio = bio;
      currentUser.profilePhotos = photosFiltered;
      
      saveUserData();
      showNotification(`‚úÖ Profil mis √† jour ! ${data.photosAccepted} photos accept√©es, ${data.photosRejected} rejet√©es`, "success");
      openUserProfile();
    } else {
      const error = await response.json();
      showNotification(`Erreur: ${error.error}`, "error");
    }
  } catch (error) {
    console.error('Erreur sauvegarde profil:', error);
    showNotification("Erreur lors de la sauvegarde", "error");
  }
};

// Initialiser WebSocket au login - wrapper autour de performLogin existante
(function() {
  const originalPerformLogin = window.performLogin;
  window.performLogin = async function() {
    await originalPerformLogin();
    if (currentUser && currentUser.isLoggedIn) {
      initWebSocket();
    }
  };
})();

// Mettre √† jour openGroupChannel pour charger les messages depuis le backend
const originalOpenGroupChannel = openGroupChannel;
openGroupChannel = async function(channelId, channelName, channelType, channelCategory) {
  if (!currentUser || !currentUser.isLoggedIn) {
    openLoginModal();
    return;
  }
  
  // Marquer le canal comme actif
  if (!window.activeGroupChannels) window.activeGroupChannels = [];
  if (!window.activeGroupChannels.includes(channelId)) {
    window.activeGroupChannels.push(channelId);
  }
  
  // Charger les messages depuis le backend
  try {
    const response = await fetch(`${window.API_BASE_URL}/social/groups/${channelId}/messages?userId=${currentUser.id}&limit=50`);
    if (response.ok) {
      const data = await response.json();
      
      // Convertir les messages du backend au format local
      if (!window.groupChannels) window.groupChannels = {};
      window.groupChannels[channelId] = data.messages.map(msg => ({
        id: msg.id,
        from: msg.userId,
        fromName: msg.username,
        fromAvatar: currentUser.avatar,
        text: msg.message,
        attachments: msg.attachments || [],
        reactions: msg.reactions || {},
        time: msg.createdAt,
        status: msg.status,
        type: 'user'
      })).reverse(); // Inverser pour avoir les plus anciens en premier
      
      // Ajouter un message syst√®me si vide
      if (window.groupChannels[channelId].length === 0) {
        window.groupChannels[channelId] = [{
          from: 'system',
          fromName: 'Syst√®me',
          text: `Bienvenue dans le canal "${channelName}" ! üëã`,
          time: new Date().toISOString(),
          type: 'system'
        }];
      }
    }
  } catch (error) {
    console.error('Erreur chargement messages:', error);
    // Utiliser les messages locaux en fallback
    if (!window.groupChannels) window.groupChannels = {};
    if (!window.groupChannels[channelId]) {
      window.groupChannels[channelId] = [{
        from: 'system',
        fromName: 'Syst√®me',
        text: `Bienvenue dans le canal "${channelName}" ! üëã`,
        time: new Date().toISOString(),
        type: 'system'
      }];
    }
  }
  
  // Appeler la fonction originale
  originalOpenGroupChannel(channelId, channelName, channelType, channelCategory);
};

// Am√©liorer l'affichage des messages avec r√©actions
function renderMessageWithReactions(msg, idx, channelId) {
  if (msg.type === 'system') return '';
  
  const reactions = msg.reactions || {};
  const hasReactions = Object.keys(reactions).length > 0;
  const userReacted = hasReactions && Object.values(reactions).some(userIds => 
    Array.isArray(userIds) && userIds.includes(currentUser.id)
  );
  
  const reactionsHtml = hasReactions ? `
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;">
      ${Object.entries(reactions).map(([emoji, userIds]) => {
        const count = Array.isArray(userIds) ? userIds.length : (typeof userIds === 'number' ? userIds : 0);
        const userHasReacted = Array.isArray(userIds) && userIds.includes(currentUser.id);
        return `
          <button onclick="toggleReaction('${channelId}', ${idx}, '${emoji}')" 
                  style="display:flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;border:1px solid ${userHasReacted ? 'rgba(0,255,195,0.5)' : 'var(--ui-card-border)'};background:${userHasReacted ? 'rgba(0,255,195,0.2)' : 'rgba(15,23,42,0.5)'};color:${userHasReacted ? '#00ffc3' : 'var(--ui-text-muted)'};font-size:12px;cursor:pointer;transition:all 0.2s;"
                  onmouseover="this.style.background='rgba(0,255,195,0.3)'"
                  onmouseout="this.style.background='${userHasReacted ? 'rgba(0,255,195,0.2)' : 'rgba(15,23,42,0.5)'}'">
            <span>${emoji}</span>
            <span>${count}</span>
          </button>
        `;
      }).join('')}
      <button onclick="showReactionPicker('${channelId}', ${idx})" 
              style="padding:4px 8px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-muted);font-size:12px;cursor:pointer;transition:all 0.2s;"
              onmouseover="this.style.background='rgba(0,255,195,0.1)'"
              onmouseout="this.style.background='transparent'">
        ‚ûï
      </button>
    </div>
  ` : `
    <button onclick="showReactionPicker('${channelId}', ${idx})" 
            style="margin-top:8px;padding:4px 8px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-muted);font-size:12px;cursor:pointer;transition:all 0.2s;"
            onmouseover="this.style.background='rgba(0,255,195,0.1)'"
            onmouseout="this.style.background='transparent'">
      ‚ûï R√©agir
    </button>
  `;
  
  return reactionsHtml;
}

// Afficher le s√©lecteur de r√©actions
function showReactionPicker(channelId, messageIndex) {
  const emojis = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üî•', 'üéâ', 'üëè'];
  
  const html = `
    <div style="padding:16px;max-width:300px;margin:0 auto;">
      <h3 style="margin:0 0 16px 0;font-size:18px;font-weight:600;color:#fff;">R√©agir</h3>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
        ${emojis.map(emoji => `
          <button onclick="addReactionToMessage('${channelId}', ${messageIndex}, '${emoji}');closePublishModal();" 
                  style="padding:12px;border-radius:12px;border:1px solid var(--ui-card-border);background:rgba(15,23,42,0.5);font-size:24px;cursor:pointer;transition:all 0.2s;"
                  onmouseover="this.style.background='rgba(0,255,195,0.2)';this.style.transform='scale(1.1)'"
                  onmouseout="this.style.background='rgba(15,23,42,0.5)';this.style.transform='scale(1)'">
            ${emoji}
          </button>
        `).join('')}
      </div>
      <button onclick="closePublishModal()" style="width:100%;margin-top:16px;padding:10px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);cursor:pointer;font-weight:600;">
        Annuler
      </button>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
}

// Ajouter une r√©action √† un message
async function addReactionToMessage(channelId, messageIndex, emoji) {
  const messages = window.groupChannels[channelId];
  if (!messages || messageIndex >= messages.length) return;
  
  const message = messages[messageIndex];
  if (!message.id) {
    showNotification("‚ö†Ô∏è Impossible de r√©agir √† ce message", "warning");
    return;
  }
  
  const reactions = await addMessageReaction(message.id, emoji);
  if (reactions) {
    message.reactions = reactions;
    // Rafra√Æchir uniquement la vue sans recharger depuis le backend
    const messagesDiv = document.getElementById(`group-messages-${channelId}`);
    if (messagesDiv) {
      // Trouver le message dans le DOM et mettre √† jour les r√©actions
      const messageElement = messagesDiv.children[messageIndex];
      if (messageElement) {
        const reactionsContainer = messageElement.querySelector('.message-reactions');
        if (reactionsContainer) {
          reactionsContainer.outerHTML = renderMessageWithReactions(message, messageIndex, channelId);
        }
      }
    }
  }
}

// Toggle une r√©action
async function toggleReaction(channelId, messageIndex, emoji) {
  await addReactionToMessage(channelId, messageIndex, emoji);
}

window.initWebSocket = initWebSocket;
window.addReactionToMessage = addReactionToMessage;
window.toggleReaction = toggleReaction;
window.showReactionPicker = showReactionPicker;
window.moderateImageBeforeUpload = moderateImageBeforeUpload;
window.searchUsers = searchUsers;
window.sendFriendRequest = sendFriendRequest;
window.acceptFriendRequest = acceptFriendRequest;
window.declineFriendRequest = declineFriendRequest;
window.removeFriend = removeFriend;
window.openChatWith = openChatWith;
window.sendChatMessage = sendChatMessage;
window.focusOnItem = focusOnItem;
// REMOVED: logout est maintenant dans auth.js et expos√© via window.logout
window.playPreview = function(bookingId, trackIndex) {
  if (typeof toggleBookingAudio === 'function') toggleBookingAudio(bookingId, trackIndex);
};
window.openEcoMissionModal = openEcoMissionModal;
window.makeDonation = makeDonation;
window.openCartModal = openCartModal;
window.addToCart = addToCart;
window.removeFromCart = removeFromCart;
window.checkoutCart = checkoutCart;
window.openAlertsView = openAlertsView;
// NOTE: openProximityAlertsView, closeProximityAlertsView, removeProximityAlert, openItemFromProximityAlert
// sont expos√©es plus tard dans le fichier apr√®s leur d√©finition (voir apr√®s ligne 21750)
// Compatibilit√© : rediriger openAlertsModal vers openSubscriptionModal
window.openAlertsModal = function() {
  console.warn("openAlertsModal() est obsol√®te, redirection vers openSubscriptionModal()");
  openSubscriptionModal();
};
window.closeAlertsView = closeAlertsView;
window.openAddAlarmModal = openAddAlarmModal;
window.toggleAlarmItemSelection = toggleAlarmItemSelection;
window.saveAlarm = saveAlarm;
window.closeAddAlarmModal = closeAddAlarmModal;
window.closeAlertsLoginPopup = closeAlertsLoginPopup;
window.closeAlertsLoginPopupAndOpenAlerts = closeAlertsLoginPopupAndOpenAlerts;
window.closeStatusChangeNotification = closeStatusChangeNotification;
window.addEventToAlertsFromNotification = addEventToAlertsFromNotification;
window.openEventFromAlert = openEventFromAlert;

// ============================================
// GESTION DES LANGUES - STRAT√âGIE MONDIALE #1
// ============================================
//
// üéØ OBJECTIF : √äTRE LA PLATEFORME √âV√âNEMENTIELLE LA PLUS MULTILINGUE AU MONDE
//
// üìã STRAT√âGIE COMPL√àTE POUR DEVENIR #1 MONDIAL :
//
// 1. COUVERTURE LINGUISTIQUE MAXIMALE
//    ‚úÖ Phase 1 (ACTUELLE) : 5 langues principales (FR, EN, ES, ZH, HI)
//       ‚Üí Couvre ~70% de la population mondiale
//    üîÑ Phase 2 : Ajouter 10 langues suppl√©mentaires
//       ‚Üí Arabe (AR), Portugais (PT), Russe (RU), Japonais (JA), 
//         Allemand (DE), Italien (IT), Cor√©en (KO), Turc (TR), 
//         Polonais (PL), N√©erlandais (NL)
//       ‚Üí Couvre ~85% de la population mondiale
//    üöÄ Phase 3 : Support de 50+ langues (via compte utilisateur)
//       ‚Üí Toutes les langues majeures + langues r√©gionales
//       ‚Üí Couvre ~95% de la population mondiale
//
// 2. SYST√àME DE TRADUCTION HYBRIDE (QUALIT√â MAXIMALE)
//    A. TRADUCTIONS MANUELLES (Priorit√© #1 - Meilleure qualit√©)
//       ‚Üí Lors de la publication, l'utilisateur peut ajouter des traductions
//       ‚Üí Syst√®me de validation par la communaut√©
//       ‚Üí Traductions certifi√©es par des traducteurs professionnels
//       ‚Üí Stockage : item.translations = { en: "...", es: "...", etc. }
//
//    B. TRADUCTION AUTOMATIQUE (Fallback - Qualit√© acceptable)
//       ‚Üí API Google Translate (meilleure qualit√©, payant)
//       ‚Üí API DeepL (excellente qualit√©, payant)
//       ‚Üí API LibreTranslate (gratuit, qualit√© moyenne)
//       ‚Üí Cache agressif pour √©viter les co√ªts
//
//    C. D√âTECTION AUTOMATIQUE DE LA LANGUE
//       ‚Üí D√©tecter la langue du contenu source (titre, description)
//       ‚Üí Utiliser la bonne traduction selon la langue de l'utilisateur
//
// 3. TRADUCTION EN TEMPS R√âEL
//    ‚úÖ Interface utilisateur : Traduite instantan√©ment (dictionnaire)
//    ‚úÖ Contenu √©v√©nements : Traduit √† la vol√©e (cache + API)
//    ‚úÖ Commentaires : Traduction √† la demande (bouton "Traduire")
//    ‚úÖ Cat√©gories : Dictionnaire multilingue complet
//    ‚úÖ Messages syst√®me : Tous traduits
//
// 4. EXP√âRIENCE UTILISATEUR OPTIMALE
//    ‚úÖ D√©tection automatique de la langue du navigateur
//    ‚úÖ Changement de langue en 1 clic (sans rechargement)
//    ‚úÖ Sauvegarde de la pr√©f√©rence (localStorage + compte)
//    ‚úÖ Traduction contextuelle (selon le contenu)
//    ‚úÖ Support RTL (arabe, h√©breu) pour l'interface
//
// 5. OPTIMISATIONS PERFORMANCE
//    ‚úÖ Cache local (localStorage) pour les traductions fr√©quentes
//    ‚úÖ Cache serveur (base de donn√©es) pour √©viter les appels API
//    ‚úÖ Lazy loading : Traduire seulement ce qui est visible
//    ‚úÖ Pr√©chargement : Traductions des √©v√©nements populaires
//    ‚úÖ CDN : Servir les traductions depuis un CDN
//
// 6. QUALIT√â DES TRADUCTIONS
//    ‚úÖ Syst√®me de notation des traductions (utilisateurs)
//    ‚úÖ Suggestions d'am√©lioration (crowdsourcing)
//    ‚úÖ Traductions professionnelles pour les √©v√©nements premium
//    ‚úÖ V√©rification par IA (d√©tecter les erreurs)
//
// 7. MON√âTISATION
//    ‚úÖ Traductions gratuites pour les utilisateurs
//    ‚úÖ Traductions premium pour les organisateurs (meilleure visibilit√©)
//    ‚úÖ Service de traduction professionnelle (option payante)
//    ‚úÖ API de traduction pour les partenaires
//
// 8. AVANTAGE CONCURRENTIEL
//    ‚úÖ Aucune plateforme √©v√©nementielle n'offre un multilinguisme aussi complet
//    ‚úÖ Accessible √† 95% de la population mondiale
//    ‚úÖ Exp√©rience native dans la langue de l'utilisateur
//    ‚úÖ Communaut√© mondiale unie
//
// üìä M√âTRIQUES DE SUCC√àS :
//    - Nombre de langues support√©es : 50+
//    - % de contenu traduit : 90%+
//    - Temps de traduction : <100ms
//    - Satisfaction utilisateurs : 95%+
//    - Couverture mondiale : 95%+
//
// üîß IMPL√âMENTATION TECHNIQUE :
//
// 1. INTERFACE UTILISATEUR (UI) :
//    - Tous les textes de l'interface (boutons, labels, messages)
//    - G√©r√© par le dictionnaire `translations` ci-dessous
//    - Fonction `t(key)` pour obtenir la traduction
//    - Fonction `updateUITranslations()` met √† jour l'UI dynamiquement
//
// 2. CONTENU DES √âV√âNEMENTS (Events/Booking/Service) :
//    - Titres, descriptions, cat√©gories, adresses
//    - Solution A : API de traduction (Google Translate, DeepL, etc.)
//      ‚Üí Traduction automatique √† la vol√©e lors de l'affichage
//      ‚Üí Cache des traductions pour √©viter les appels r√©p√©t√©s
//    - Solution B : Base de donn√©es multilingue
//      ‚Üí Chaque √©v√©nement stocke ses traductions dans plusieurs langues
//      ‚Üí Lors de la publication, l'utilisateur peut ajouter des traductions
//    - Solution C : Hybrid (recommand√©)
//      ‚Üí Traductions manuelles prioritaires (meilleure qualit√©)
//      ‚Üí Fallback sur traduction automatique si manquant
//
// 3. IMPL√âMENTATION TECHNIQUE :
//    - Frontend : Fonction `translateContent(item, lang)` qui :
//      a) Cherche une traduction manuelle dans item.translations[lang]
//      b) Si absente, appelle l'API de traduction
//      c) Cache le r√©sultat dans localStorage/sessionStorage
//    - Backend : Endpoint `/api/translate` qui :
//      a) Re√ßoit le texte source + langue cible
//      b) V√©rifie le cache en base de donn√©es
//      c) Si absent, appelle l'API externe et sauvegarde
//      d) Retourne la traduction
//
// 4. EXEMPLE D'UTILISATION :
//    - Utilisateur s√©lectionne "English"
//    - Tous les popups affichent les √©v√©nements en anglais
//    - Les descriptions sont traduites automatiquement
//    - Les cat√©gories sont traduites (via dictionnaire)
//    - L'interface est traduite (via `translations`)
//
// 5. OPTIMISATIONS :
//    - Cache agressif des traductions (√©viter les appels r√©p√©t√©s)
//    - Traduction lazy (seulement ce qui est visible)
//    - Pr√©chargement des traductions courantes
//    - Support des langues RTL (arabe, h√©breu)
//
// ============================================
// DICTIONNAIRE DE TRADUCTIONS COMPLET (d√©plac√© au d√©but du fichier)
// ============================================
// Ce dictionnaire a √©t√© d√©plac√© apr√®s la d√©claration de currentLanguage pour √©viter les erreurs d'initialisation
// L'ancienne d√©claration a √©t√© supprim√©e - voir ligne 55 pour la nouvelle d√©claration

// ============================================
// API DE TRADUCTION - INT√âGRATION
// ============================================
//
// üéØ MEILLEURES APIs DE TRADUCTION (avec liens) :
//

// Initialisation du dictionnaire de traductions complet
// NOTE: Cette section a √©t√© supprim√©e car les traductions sont d√©j√† d√©finies ailleurs dans le fichier
// (voir lignes 219-431 pour la structure compl√®te et correcte)
if (typeof window !== 'undefined') {
  window.translations = window.translations || { fr: {}, en: {}, es: {}, zh: {}, hi: {} };
}

// NOTE: Section de traductions mal form√©e supprim√©e (lignes 12663-12860)
// Les traductions sont d√©j√† d√©finies correctement ailleurs dans le fichier (lignes 219-431)

// ============================================
// API DE TRADUCTION - INT√âGRATION
// ============================================
//
// üéØ MEILLEURES APIs DE TRADUCTION (avec liens) :
//
// 1. GOOGLE CLOUD TRANSLATE API (RECOMMAND√â - Meilleure qualit√©)
//    üìç Lien : https://cloud.google.com/translate/docs/setup
//    üí∞ Prix : 20$/million de caract√®res (gratuit jusqu'√† 500k/mois)
//    ‚úÖ Avantages : Meilleure qualit√©, support 100+ langues, tr√®s rapide
//    ‚úÖ Paiement : Carte bancaire, Twint via Stripe
//    üìù Documentation : https://cloud.google.com/translate/docs/reference/rest/v2/translate
//
// 2. DEEPL API (EXCELLENTE QUALIT√â - Sp√©cialis√© europ√©en)
// ============================================
// API DE TRADUCTION - INT√âGRATION
// ============================================
//
// üéØ MEILLEURES APIs DE TRADUCTION (avec liens) :
//
// 1. GOOGLE CLOUD TRANSLATE API (RECOMMAND√â - Meilleure qualit√©)
//    üìç Lien : https://cloud.google.com/translate/docs/setup
//    üí∞ Prix : 20$/million de caract√®res (gratuit jusqu'√† 500k/mois)
//    ‚úÖ Avantages : Meilleure qualit√©, support 100+ langues, tr√®s rapide
//    ‚úÖ Paiement : Carte bancaire, Twint via Stripe
//    üìù Documentation : https://cloud.google.com/translate/docs/reference/rest/v2/translate
//
// 2. DEEPL API (EXCELLENTE QUALIT√â - Sp√©cialis√© europ√©en)
//    üìç Lien : https://www.deepl.com/fr/pro-api
//    üí∞ Prix : 25‚Ç¨/million de caract√®res (gratuit jusqu'√† 500k/mois)
//    ‚úÖ Avantages : Meilleure qualit√© pour langues europ√©ennes, tr√®s naturel
//    ‚úÖ Paiement : Carte bancaire, PayPal, Twint via Stripe
//    üìù Documentation : https://www.deepl.com/fr/docs-api
//
// 3. AZURE TRANSLATOR (Microsoft - Bon compromis)
//    üìç Lien : https://azure.microsoft.com/fr-fr/services/cognitive-services/translator/
//    üí∞ Prix : 10$/million de caract√®res (gratuit jusqu'√† 2M/mois)
//    ‚úÖ Avantages : Bon prix, bonne qualit√©, int√©gration facile
//    ‚úÖ Paiement : Carte bancaire, Twint via Stripe
//    üìù Documentation : https://docs.microsoft.com/fr-fr/azure/cognitive-services/translator/
//
// 4. LIBRETRANSLATE (GRATUIT - Open Source)
//    üìç Lien : https://libretranslate.com/
//    üí∞ Prix : GRATUIT (ou self-hosted)
//    ‚ö†Ô∏è Avantages : Gratuit, open source
//    ‚ö†Ô∏è Inconv√©nients : Qualit√© moindre, limit√© en langues
//    üìù Documentation : https://github.com/LibreTranslate/LibreTranslate
//
// üí° RECOMMANDATION : Utiliser GOOGLE CLOUD TRANSLATE pour la production
//    ‚Üí Meilleure qualit√© mondiale
//    ‚Üí Support de toutes les langues
//    ‚Üí Tr√®s fiable et rapide
//    ‚Üí Paiement flexible (Twint via Stripe)
//
// üîß CONFIGURATION :
//    1. Cr√©er un compte Google Cloud : https://console.cloud.google.com/
//    2. Activer l'API Translate : https://console.cloud.google.com/apis/library/translate.googleapis.com
//    3. Cr√©er une cl√© API : https://console.cloud.google.com/apis/credentials
//    4. Configurer le paiement (Twint via Stripe accept√©)
//    5. Mettre la cl√© dans les variables d'environnement (NE JAMAIS la commiter!)
//
// Cache pour les traductions de contenu (√©vite les appels r√©p√©t√©s)
const contentTranslationCache = {};

// ============================================
// SYST√àME INTELLIGENT MULTI-PROVIDER DE TRADUCTION
// ============================================
// Strat√©gie #1 Mondial : Utiliser plusieurs providers selon la r√©gion/langue
// pour optimiser qualit√©, co√ªts et vitesse

// Configuration des providers de traduction
const TRANSLATION_PROVIDERS = {
  google: {
    name: "Google Cloud Translate",
    apiKey: "", // √Ä configurer
    endpoint: "https://translation.googleapis.com/language/translate/v2",
    regions: ["global"], // Toutes les r√©gions
    languages: ["all"], // Toutes les langues
    quality: "excellent",
    speed: "very_fast",
    cost: "medium",
    priority: 1 // Priorit√© pour l'Europe et langues principales
  },
  deepl: {
    name: "DeepL API",
    apiKey: "", // √Ä configurer
    endpoint: "https://api-free.deepl.com/v2/translate",
    regions: ["europe", "americas"], // Sp√©cialis√© Europe/Am√©riques
    languages: ["en", "fr", "de", "es", "it", "pt", "ru", "pl", "nl", "ja", "zh"],
    quality: "excellent", // Meilleure qualit√© pour langues europ√©ennes
    speed: "fast",
    cost: "medium",
    priority: 2 // Priorit√© pour langues europ√©ennes
  },
  azure: {
    name: "Azure Translator",
    apiKey: "", // √Ä configurer
    endpoint: "https://api.cognitive.microsofttranslator.com/translate",
    regions: ["global"],
    languages: ["all"],
    quality: "very_good",
    speed: "fast",
    cost: "low", // Meilleur rapport qualit√©/prix
    priority: 3 // Fallback √©conomique
  },
  libretranslate: {
    name: "LibreTranslate",
    apiKey: "", // Optionnel (gratuit)
    endpoint: "https://libretranslate.com/translate",
    regions: ["global"],
    languages: ["en", "fr", "es", "de", "it", "pt", "ru", "zh", "ja"],
    quality: "good",
    speed: "medium",
    cost: "free",
    priority: 4 // Fallback gratuit
  }
};

// Mapping intelligent r√©gion/langue ‚Üí provider optimal
const INTELLIGENT_PROVIDER_MAPPING = {
  // Europe ‚Üí DeepL (meilleure qualit√©) ou Google (fallback)
  "europe": {
    primary: "deepl",
    fallback: "google",
    languages: ["fr", "en", "de", "es", "it", "pt", "ru", "pl", "nl", "cs", "sk", "hu", "ro", "bg", "hr", "sl", "et", "lv", "lt", "fi", "sv", "da", "no", "is", "ga", "mt", "el"]
  },
  // Am√©riques ‚Üí Google (meilleure couverture) ou DeepL
  "americas": {
    primary: "google",
    fallback: "deepl",
    languages: ["en", "es", "pt", "fr"]
  },
  // Asie ‚Üí Google (meilleure couverture langues asiatiques)
  "asia": {
    primary: "google",
    fallback: "azure",
    languages: ["zh", "ja", "ko", "hi", "th", "vi", "id", "ms", "tl", "my", "km", "lo"]
  },
  // Afrique ‚Üí Google (meilleure couverture)
  "africa": {
    primary: "google",
    fallback: "azure",
    languages: ["ar", "sw", "am", "zu", "xh", "af", "yo", "ig", "ha", "fr", "en", "pt"]
  },
  // Moyen-Orient ‚Üí Google (meilleure couverture arabe)
  "middle_east": {
    primary: "google",
    fallback: "azure",
    languages: ["ar", "he", "fa", "tr", "ku"]
  },
  // Oc√©anie ‚Üí Google ou DeepL
  "oceania": {
    primary: "google",
    fallback: "deepl",
    languages: ["en", "fr", "mi", "haw"]
  }
};

// Fonction intelligente pour s√©lectionner le meilleur provider
function getBestProviderForTranslation(sourceLang, targetLang, region = null) {
  // Si r√©gion sp√©cifi√©e, utiliser le mapping intelligent
  if (region && INTELLIGENT_PROVIDER_MAPPING[region]) {
    const mapping = INTELLIGENT_PROVIDER_MAPPING[region];
    const provider = TRANSLATION_PROVIDERS[mapping.primary];
    
    // V√©rifier si le provider supporte la langue
    if (provider && (provider.languages.includes(targetLang) || provider.languages.includes("all"))) {
      if (provider.apiKey) return mapping.primary;
    }
    
    // Fallback
    const fallbackProvider = TRANSLATION_PROVIDERS[mapping.fallback];
    if (fallbackProvider && fallbackProvider.apiKey) {
      return mapping.fallback;
    }
  }
  
  // D√©tection automatique de la r√©gion selon la langue
  let detectedRegion = "global";
  
  // Langues europ√©ennes ‚Üí Europe
  if (["fr", "de", "es", "it", "pt", "ru", "pl", "nl", "cs", "sk", "hu", "ro", "bg", "hr", "sl", "et", "lv", "lt", "fi", "sv", "da", "no"].includes(targetLang)) {
    detectedRegion = "europe";
  }
  // Langues asiatiques ‚Üí Asie
  else if (["zh", "ja", "ko", "hi", "th", "vi", "id", "ms", "tl", "my", "km", "lo"].includes(targetLang)) {
    detectedRegion = "asia";
  }
  // Langues arabes ‚Üí Moyen-Orient
  else if (["ar", "he", "fa"].includes(targetLang)) {
    detectedRegion = "middle_east";
  }
  
  // Utiliser le mapping d√©tect√©
  if (INTELLIGENT_PROVIDER_MAPPING[detectedRegion]) {
    const mapping = INTELLIGENT_PROVIDER_MAPPING[detectedRegion];
    const provider = TRANSLATION_PROVIDERS[mapping.primary];
    
    if (provider && provider.apiKey && (provider.languages.includes(targetLang) || provider.languages.includes("all"))) {
      return mapping.primary;
    }
    
    const fallbackProvider = TRANSLATION_PROVIDERS[mapping.fallback];
    if (fallbackProvider && fallbackProvider.apiKey) {
      return mapping.fallback;
    }
  }
  
  // Fallback final : Google (si disponible) ou Azure ou LibreTranslate
  if (TRANSLATION_PROVIDERS.google.apiKey) return "google";
  if (TRANSLATION_PROVIDERS.azure.apiKey) return "azure";
  if (TRANSLATION_PROVIDERS.libretranslate.apiKey) return "libretranslate";
  
  return null; // Aucun provider disponible
}

// Configuration globale (pour compatibilit√©)
const TRANSLATION_API_CONFIG = {
  provider: "auto", // "auto" = s√©lection intelligente
  apiKey: "", // D√©pr√©ci√©, utiliser TRANSLATION_PROVIDERS
  cacheEnabled: true,
  cacheMaxSize: 10000
};

// ============================================
// TRADUCTION AUTOMATIQUE COMPL√àTE - IA
// ============================================
// Fonction pour traduire automatiquement TOUT le contenu d'un item
// (titre, description, cat√©gories, etc.) - Utilis√©e par l'IA
async function translateItemContentAuto(item, targetLang = currentLanguage) {
  if (!item || targetLang === "fr") return item; // Pas besoin de traduire si d√©j√† en fran√ßais
  
  const translated = { ...item };
  
  // Traduire le titre
  if (item.title) {
    translated.title = await translateContent(item.title, "auto", targetLang);
  }
  if (item.name) {
    translated.name = await translateContent(item.name, "auto", targetLang);
  }
  
  // Traduire la description
  if (item.description) {
    translated.description = await translateContent(item.description, "auto", targetLang);
  }
  
  // Traduire les cat√©gories (si ce sont des strings)
  if (item.categories && Array.isArray(item.categories)) {
    translated.categories = await Promise.all(
      item.categories.map(cat => translateContent(cat, "auto", targetLang))
    );
  }
  
  // Traduire le nom de l'organisateur/artiste/entreprise
  if (item.organizer) {
    translated.organizer = await translateContent(item.organizer, "auto", targetLang);
  }
  if (item.artist) {
    translated.artist = await translateContent(item.artist, "auto", targetLang);
  }
  if (item.company) {
    translated.company = await translateContent(item.company, "auto", targetLang);
  }
  
  // Mettre en cache les traductions
  const cacheKey = `item_${item.id}_${targetLang}`;
  localStorage.setItem(cacheKey, JSON.stringify(translated));
  
  return translated;
}

// Version synchrone qui utilise le cache (pour affichage imm√©diat)
function getTranslatedItemSync(item, targetLang = currentLanguage) {
  if (!item || targetLang === "fr") return item;
  
  // V√©rifier le cache
  const cacheKey = `item_${item.id}_${targetLang}`;
  const cached = localStorage.getItem(cacheKey);
  if (cached) {
    try {
      return JSON.parse(cached);
    } catch (e) {
      console.warn("Erreur parsing cache traduction", e);
    }
  }
  
  // Si pas en cache, retourner l'original et lancer la traduction en arri√®re-plan
  translateItemContentAuto(item, targetLang).then(translated => {
    // Mettre √† jour les popups si elles sont ouvertes
    refreshMarkers();
  });
  
  return item; // Retourner l'original en attendant
}

// Fonction pour traduire le contenu d'un √©v√©nement (titre, description)
// Utilise le syst√®me intelligent multi-provider avec fallback automatique
async function translateContent(text, sourceLang = "auto", targetLang = currentLanguage, region = null) {
  if (!text || targetLang === sourceLang) return text;
  
  // V√©rifier le cache
  const cacheKey = `${text}|${sourceLang}|${targetLang}`;
  if (TRANSLATION_API_CONFIG.cacheEnabled && contentTranslationCache[cacheKey]) {
    return contentTranslationCache[cacheKey];
  }
  
  // S√©lectionner le meilleur provider intelligemment
  const provider = getBestProviderForTranslation(sourceLang, targetLang, region);
  
  if (!provider) {
    console.warn("‚ö†Ô∏è Aucun provider de traduction disponible. Retour du texte original.");
    return text;
  }
  
  try {
    let translated = text;
    let lastError = null;
    
    // Essayer le provider principal
    try {
      switch (provider) {
        case "google":
          translated = await translateWithGoogle(text, sourceLang, targetLang);
          break;
        case "deepl":
          translated = await translateWithDeepL(text, sourceLang, targetLang);
          break;
        case "azure":
          translated = await translateWithAzure(text, sourceLang, targetLang);
          break;
        case "libretranslate":
          translated = await translateWithLibreTranslate(text, sourceLang, targetLang);
          break;
        default:
          throw new Error("Provider inconnu");
      }
    } catch (error) {
      lastError = error;
      console.warn(`‚ö†Ô∏è Erreur avec ${provider}, tentative fallback...`, error);
      
      // Fallback automatique : essayer les autres providers
      const fallbackProviders = ["google", "azure", "libretranslate"].filter(p => p !== provider);
      
      for (const fallbackProvider of fallbackProviders) {
        const fallback = TRANSLATION_PROVIDERS[fallbackProvider];
        if (!fallback || !fallback.apiKey) continue;
        
        try {
          switch (fallbackProvider) {
            case "google":
              translated = await translateWithGoogle(text, sourceLang, targetLang);
              break;
            case "azure":
              translated = await translateWithAzure(text, sourceLang, targetLang);
              break;
            case "libretranslate":
              translated = await translateWithLibreTranslate(text, sourceLang, targetLang);
              break;
          }
          
          console.log(`‚úÖ Traduction r√©ussie avec fallback ${fallbackProvider}`);
          break; // Succ√®s avec le fallback
        } catch (fallbackError) {
          console.warn(`‚ùå Fallback ${fallbackProvider} √©chou√©`, fallbackError);
          continue; // Essayer le suivant
        }
      }
      
      // Si tous les fallbacks ont √©chou√©
      if (translated === text && lastError) {
        throw lastError;
      }
    }
    
    // Mettre en cache
    if (TRANSLATION_API_CONFIG.cacheEnabled && translated !== text) {
      // Limiter la taille du cache
      const keys = Object.keys(contentTranslationCache);
      if (keys.length >= TRANSLATION_API_CONFIG.cacheMaxSize) {
        delete contentTranslationCache[keys[0]]; // Supprimer la plus ancienne
      }
      contentTranslationCache[cacheKey] = translated;
    }
    
    return translated;
  } catch (error) {
    console.error("‚ùå Erreur traduction finale:", error);
    return text; // Retourner le texte original en cas d'erreur
  }
}

// Fonction pour traduire avec Google Cloud Translate
async function translateWithGoogle(text, sourceLang, targetLang) {
  const apiKey = TRANSLATION_PROVIDERS.google.apiKey;
  if (!apiKey) throw new Error("Cl√© API Google non configur√©e");
  
  const response = await fetch(
    `${TRANSLATION_PROVIDERS.google.endpoint}?key=${apiKey}`,
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        q: text,
        source: sourceLang === "auto" ? "" : sourceLang,
        target: targetLang,
        format: "text"
      })
    }
  );
  
  if (!response.ok) throw new Error("Erreur Google Translate API");
  
  const data = await response.json();
  return data.data.translations[0].translatedText;
}

// Fonction pour traduire avec DeepL
async function translateWithDeepL(text, sourceLang, targetLang) {
  const apiKey = TRANSLATION_PROVIDERS.deepl.apiKey;
  if (!apiKey) throw new Error("Cl√© API DeepL non configur√©e");
  
  const response = await fetch(
    TRANSLATION_PROVIDERS.deepl.endpoint,
    {
      method: "POST",
      headers: {
        "Authorization": `DeepL-Auth-Key ${apiKey}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        text: [text],
        source_lang: sourceLang === "auto" ? null : sourceLang.toUpperCase(),
        target_lang: targetLang.toUpperCase()
      })
    }
  );
  
  if (!response.ok) throw new Error("Erreur DeepL API");
  
  const data = await response.json();
  return data.translations[0].text;
}

// Fonction pour traduire avec Azure Translator
async function translateWithAzure(text, sourceLang, targetLang) {
  const apiKey = TRANSLATION_PROVIDERS.azure.apiKey;
  if (!apiKey) throw new Error("Cl√© API Azure non configur√©e");
  
  const endpoint = TRANSLATION_PROVIDERS.azure.endpoint;
  const location = "global"; // ou la r√©gion de ta ressource Azure
  
  const response = await fetch(
    `${endpoint}?api-version=3.0&from=${sourceLang === "auto" ? "" : sourceLang}&to=${targetLang}`,
    {
      method: "POST",
      headers: {
        "Ocp-Apim-Subscription-Key": apiKey,
        "Ocp-Apim-Subscription-Region": location,
        "Content-Type": "application/json",
      },
      body: JSON.stringify([{ text }])
    }
  );
  
  if (!response.ok) throw new Error("Erreur Azure Translator API");
  
  const data = await response.json();
  return data[0].translations[0].text;
}

// Fonction pour traduire avec LibreTranslate (gratuit)
async function translateWithLibreTranslate(text, sourceLang, targetLang) {
  const response = await fetch(
    `https://libretranslate.com/translate`,
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        q: text,
        source: sourceLang === "auto" ? "auto" : sourceLang,
        target: targetLang,
        format: "text"
      })
    }
  );
  
  if (!response.ok) throw new Error("Erreur LibreTranslate API");
  
  const data = await response.json();
  return data.translatedText;
}

// ============================================
// FONCTION POUR L'IA : TRADUIRE AUTOMATIQUEMENT LES POINTS
// ============================================
//
// Cette fonction permet √† l'IA de traduire automatiquement les √©v√©nements
// qu'elle ins√®re depuis le bout du monde dans toutes les langues support√©es
//
async function translateItemForAI(item, targetLanguages = ["fr", "en", "es", "zh", "hi"]) {
  if (!item || !TRANSLATION_API_CONFIG.apiKey) {
    console.warn("‚ö†Ô∏è Impossible de traduire : cl√© API manquante");
    return item;
  }
  
  // D√©tecter la langue source du contenu
  const sourceLang = detectLanguage(item.title || item.description || "");
  
  // Cr√©er un objet de traductions
  if (!item.translations) item.translations = {};
  
  // Traduire dans chaque langue cible
  for (const targetLang of targetLanguages) {
    if (targetLang === sourceLang) continue; // Pas besoin de traduire dans la m√™me langue
    
    try {
      // Traduire le titre
      if (item.title) {
        const titleKey = `title_${targetLang}`;
        if (!item.translations[titleKey]) {
          item.translations[titleKey] = await translateContent(item.title, sourceLang, targetLang);
        }
      }
      
      // Traduire la description
      if (item.description) {
        const descKey = `description_${targetLang}`;
        if (!item.translations[descKey]) {
          item.translations[descKey] = await translateContent(item.description, sourceLang, targetLang);
        }
      }
      
      // Traduire les cat√©gories (via dictionnaire si possible, sinon API)
      if (item.categories && item.categories.length > 0) {
        const catKey = `categories_${targetLang}`;
        if (!item.translations[catKey]) {
          item.translations[catKey] = await Promise.all(
            item.categories.map(cat => translateContent(cat, sourceLang, targetLang))
          );
        }
      }
      
      console.log(`‚úÖ Traduit en ${targetLang.toUpperCase()}: ${item.title || item.name}`);
    } catch (error) {
      console.error(`‚ùå Erreur traduction en ${targetLang}:`, error);
    }
  }
  
  return item;
}

// Fonction simple de d√©tection de langue (basique)
function detectLanguage(text) {
  if (!text) return "en";
  
  // D√©tection basique par patterns
  const patterns = {
    fr: /[√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ø√ß]/i,
    es: /[√±√°√©√≠√≥√∫√º¬ø¬°]/i,
    zh: /[\u4e00-\u9fff]/,
    hi: /[\u0900-\u097f]/,
    ar: /[\u0600-\u06ff]/,
    ja: /[\u3040-\u309f\u30a0-\u30ff]/,
    ko: /[\uac00-\ud7a3]/
  };
  
  for (const [lang, pattern] of Object.entries(patterns)) {
    if (pattern.test(text)) return lang;
  }
  
  return "en"; // Par d√©faut anglais
}

// Fonction pour obtenir le contenu traduit d'un item
function getTranslatedContent(item, field, lang = currentLanguage) {
  if (!item.translations) return item[field] || "";
  
  const key = `${field}_${lang}`;
  return item.translations[key] || item[field] || "";
}

// Fonction pour traduire un commentaire (avec bouton de traduction si diff√©rent de la langue actuelle)
function translateComment(comment, commentLang = "auto") {
  if (!comment) return "";
  
  // Protection contre les erreurs TDZ - utiliser directement window.t()
  // Si le commentaire est d√©j√† dans la langue actuelle, pas besoin de traduire
  if (commentLang === currentLanguage || commentLang === "auto") {
    return comment;
  }
  
  // Sinon, afficher le commentaire original + bouton de traduction
  return `
    <div class="comment-translation-wrapper" data-original="${escapeHtml(comment)}" data-lang="${commentLang}">
      <div class="comment-original" style="margin-bottom:4px;">${escapeHtml(comment)}</div>
      <button onclick="translateThisComment(this)" style="background:rgba(0,255,195,0.1);border:1px solid rgba(0,255,195,0.3);color:#00ffc3;padding:2px 8px;border-radius:4px;font-size:10px;cursor:pointer;">
        üåç ${window.t("translate")}
      </button>
      <div class="comment-translated" style="display:none;margin-top:4px;padding:4px;background:rgba(0,255,195,0.05);border-left:2px solid #00ffc3;font-size:11px;"></div>
    </div>
  `;
}

// Fonction pour traduire un commentaire sp√©cifique
async function translateThisComment(button) {
  // Protection contre les erreurs TDZ - utiliser directement window.t()
  
  const wrapper = button.closest(".comment-translation-wrapper");
  if (!wrapper) return;
  
  const original = wrapper.dataset.original;
  const sourceLang = wrapper.dataset.lang || "auto";
  const translatedDiv = wrapper.querySelector(".comment-translated");
  
  if (translatedDiv.style.display === "block") {
    translatedDiv.style.display = "none";
    button.textContent = `üåç ${window.t("translate")}`;
    return;
  }
  
  button.textContent = `${window.t("loading")}...`;
  
  try {
    const translated = await translateContent(original, sourceLang, currentLanguage);
    translatedDiv.innerHTML = escapeHtml(translated);
    translatedDiv.style.display = "block";
    button.textContent = `üåç ${window.t("hide_translation")}`;
  } catch (error) {
    console.error("Erreur traduction:", error);
    button.textContent = `üåç ${window.t("translate")}`;
    showNotification(window.t("translation_error"), "error");
  }
}

// Fonction pour changer de langue
const LANG_FLAGS = { fr: "üá´üá∑", en: "üá¨üáß", es: "üá™üá∏", zh: "üá®üá≥", hi: "üáÆüá≥", de: "üá©üá™", it: "üáÆüáπ", pt: "üáµüáπ", ru: "üá∑üá∫", ar: "üá∏üá¶", ja: "üáØüáµ", ko: "üá∞üá∑", nl: "üá≥üá±", tr: "üáπüá∑", pl: "üáµüá±", vi: "üáªüá≥", id: "üáÆüá©", th: "üáπüá≠", uk: "üá∫üá¶", sv: "üá∏üá™", no: "üá≥üá¥", da: "üá©üá∞", fi: "üá´üáÆ", el: "üá¨üá∑", he: "üáÆüá±", ro: "üá∑üá¥", ms: "üá≤üáæ", cs: "üá®üáø", hu: "üá≠üá∫", sk: "üá∏üá∞", bg: "üáßüá¨", hr: "üá≠üá∑", sr: "üá∑üá∏", lt: "üá±üáπ", lv: "üá±üáª", et: "üá™üá™", sl: "üá∏üáÆ", ta: "üáÆüá≥", bn: "üáßüá©", ur: "üáµüá∞", fa: "üáÆüá∑", mr: "üáÆüá≥", sw: "üá∞üá™", am: "üá™üáπ", af: "üáøüá¶", ca: "üá™üá∏", pa: "üáÆüá≥", tl: "üáµüá≠", my: "üá≤üá≤", ne: "üá≥üáµ", is: "üáÆüá∏", sq: "üá¶üá±", mk: "üá≤üá∞", bs: "üáßüá¶", gl: "üá™üá∏", cy: "üá¨üáß", ka: "üá¨üá™", hy: "üá¶üá≤", az: "üá¶üáø", kk: "üá∞üáø", uz: "üá∫üáø", ml: "üáÆüá≥", te: "üáÆüá≥", gu: "üáÆüá≥", kn: "üáÆüá≥", si: "üá±üá∞", eu: "üá™üá∏", mn: "üá≤üá≥", ga: "üáÆüá™", lb: "üá±üá∫", mt: "üá≤üáπ", yo: "üá≥üá¨", ha: "üá≥üá¨", ig: "üá≥üá¨", so: "üá∏üá¥", rw: "üá∑üáº", mg: "üá≤üá¨", wo: "üá∏üá≥", st: "üá±üá∏", tn: "üáßüáº", xh: "üáøüá¶", zu: "üáøüá¶", km: "üá∞üá≠", lo: "üá±üá¶", sd: "üáµüá∞", ps: "üá¶üá´", ky: "üá∞üá¨", tk: "üáπüá≤", tg: "üáπüáØ", br: "üá´üá∑", gd: "üá¨üáß", fy: "üá≥üá±", ku: "üáÆüá∂", ht: "üá≠üáπ", jv: "üáÆüá©", su: "üáÆüá©", ny: "üá≤üáº", om: "üá™üáπ", ti: "üá™üá∑", dv: "üá≤üáª", bo: "üá®üá≥", dz: "üáßüáπ", or: "üáÆüá≥", as: "üáÆüá≥", kmr: "üáπüá∑", ckb: "üáÆüá∂" };
const LANG_CODES = { fr: "FR", en: "EN", es: "ES", zh: "ZH", hi: "HI", de: "DE", it: "IT", pt: "PT", ru: "RU", ar: "AR", ja: "JA", ko: "KO", nl: "NL", tr: "TR", pl: "PL", vi: "VI", id: "ID", th: "TH", uk: "UK", sv: "SV", no: "NO", da: "DA", fi: "FI", el: "EL", he: "HE", ro: "RO", ms: "MS", cs: "CS", hu: "HU", sk: "SK", bg: "BG", hr: "HR", sr: "SR", lt: "LT", lv: "LV", et: "ET", sl: "SL", ta: "TA", bn: "BN", ur: "UR", fa: "FA", mr: "MR", sw: "SW", am: "AM", af: "AF", ca: "CA", pa: "PA", tl: "TL", my: "MY", ne: "NE", is: "IS", sq: "SQ", mk: "MK", bs: "BS", gl: "GL", cy: "CY", ka: "KA", hy: "HY", az: "AZ", kk: "KK", uz: "UZ", ml: "ML", te: "TE", gu: "GU", kn: "KN", si: "SI", eu: "EU", mn: "MN", ga: "GA", lb: "LB", mt: "MT", yo: "YO", ha: "HA", ig: "IG", so: "SO", rw: "RW", mg: "MG", wo: "WO", st: "ST", tn: "TN", xh: "XH", zu: "ZU", km: "KM", lo: "LO", sd: "SD", ps: "PS", ky: "KY", tk: "TK", tg: "TG", br: "BR", gd: "GD", fy: "FY", ku: "KU", ht: "HT", jv: "JV", su: "SU", ny: "NY", om: "OM", ti: "TI", dv: "DV", bo: "BO", dz: "DZ", or: "OR", as: "AS", kmr: "KU", ckb: "KU" };

function setLanguage(lang) {
  if (!SUPPORTED_LANGUAGES.includes(lang)) return;
  
  currentLanguage = lang;
  localStorage.setItem("mapEventLanguage", lang);
  
  const flagEl = document.getElementById("current-lang-flag");
  const codeEl = document.getElementById("current-lang-code");
  
  if (flagEl) flagEl.textContent = LANG_FLAGS[lang] || "üåç";
  if (codeEl) codeEl.textContent = LANG_CODES[lang] || lang.toUpperCase();
  
  SUPPORTED_LANGUAGES.forEach(l => {
    const check = document.getElementById(`lang-check-${l}`);
    if (check) check.style.display = l === lang ? "block" : "none";
  });
  
  // Fermer le menu
  const menu = document.getElementById("language-menu");
  if (menu) menu.style.display = "none";
  
  // Re-traduire l'interface (√† impl√©menter compl√®tement plus tard)
  updateUITranslations();
  
  showNotification(`üåç Langue chang√©e : ${LANG_FLAGS[lang] || "üåç"} ${LANG_CODES[lang] || lang.toUpperCase()}`, "success");
}

// Fonction pour mettre √† jour les traductions de l'UI (TOUT LE SITE)
function updateUITranslations() {
  // CRITIQUE: S'assurer que window.translations est compl√®tement initialis√© AVANT d'utiliser t()
  if (typeof window === 'undefined' || !window.translations || typeof window.translations !== 'object') {
    window.translations = {};
  }
  SUPPORTED_LANGUAGES.forEach(lang => {
    if (!window.translations[lang] || typeof window.translations[lang] !== 'object') {
      window.translations[lang] = window.translations[lang] || {};
    }
  });
  // NE JAMAIS red√©finir window.t ici - utiliser la version globale s√©curis√©e
  // window.t est d√©j√† d√©fini au d√©but du fichier et ne doit jamais √™tre red√©fini
  
  // 1. Topbar - Boutons principaux
  const filterBtn = document.querySelector('button[onclick="toggleLeftPanel()"]');
  if (filterBtn) filterBtn.textContent = `üîç ${window.t("filter")}`;
  
  const listBtn = document.querySelector('button[onclick="toggleListView()"]');
  if (listBtn) listBtn.textContent = `üìã ${window.t("list")}`;
  
  // 2. Boutons de navigation
  const agendaBtn = document.querySelector('button[onclick="openAgendaModal()"]');
  if (agendaBtn) agendaBtn.textContent = `üìÖ ${window.t("agenda")}`;
  
  const alertsBtn = document.querySelector('button[onclick="openSubscriptionModal()"]');
  const alertsLabel = document.getElementById("subscription-label");
  if (alertsLabel) {
    alertsLabel.textContent = "ABOS";
    alertsLabel.innerHTML = "ABOS"; // Double v√©rification avec innerHTML
  }
  
  // ‚ö†Ô∏è Ne pas √©craser le contenu du bouton compte - mettre √† jour seulement le span account-name
  const accountNameSpan = document.getElementById("account-name");
  if (accountNameSpan) {
    accountNameSpan.textContent = window.t("account");
  }
  
  const cartBtn = document.getElementById("cart-btn");
  if (cartBtn) {
    const count = cartBtn.querySelector("#cart-count");
    cartBtn.innerHTML = `üõí ${window.t("cart")}`;
    if (count) cartBtn.appendChild(count);
  }
  
  // 3. Champ de recherche de ville (IMPORTANT!)
  const searchInput = document.getElementById("map-search-input");
  if (searchInput) {
    searchInput.placeholder = window.t("search_city");
  }
  
  // 4. Bouton Publier
  const publishBtn = document.getElementById("map-publish-btn");
  if (publishBtn) publishBtn.textContent = window.t("publish");
  
  // 5. FILTRES - Traduire les labels de dates dans l'explorer
  setTimeout(() => {
    const explorerPanel = document.getElementById("left-panel");
    if (explorerPanel) {
      // Traduire "Filtrer par date"
      const dateFilterText = Array.from(explorerPanel.querySelectorAll('div')).find(d => 
        d.textContent.includes("Filtrer par date") || d.textContent.includes("Filter by date")
      );
      if (dateFilterText) {
        dateFilterText.textContent = `üìÖ ${window.t("filter_by_date")} (${window.t("cumulative") || "cumulable"})`;
      }
      
      // Traduire "Ou s√©lectionner une p√©riode"
      const periodText = Array.from(explorerPanel.querySelectorAll('div')).find(d => 
        d.textContent.includes("Ou s√©lectionner") || d.textContent.includes("Or select")
      );
      if (periodText) {
        periodText.textContent = `üìÜ ${window.t("select_period")}`;
      }
    }
  }, 100);
  
  // 6. Rafra√Æchir les marqueurs pour mettre √† jour les popups
  // CRITIQUE: Ne pas appeler refreshMarkers() imm√©diatement car cela peut cr√©er une boucle infinie
  // Attendre que tout soit initialis√© avant de rafra√Æchir
  // D√âSACTIV√â temporairement pour √©viter les boucles infinies
  // setTimeout(() => {
  //   try {
  //     refreshMarkers();
  //     refreshListView();
  //   } catch (e) {
  //     // Ne pas logger pour √©viter les milliers de messages
  //   }
  // }, 500);
  
  // 8. Rafra√Æchir les modals si ouvertes
  if (document.getElementById("publish-modal-backdrop")?.style.display === "flex") {
    const modalInner = document.getElementById("publish-modal-inner");
    if (modalInner) {
      const content = modalInner.innerHTML;
      if (content.includes("Mon Agenda") || content.includes("My agenda") || content.includes("Mi agenda")) {
        openAgendaModal();
      } else if (content.includes("Abonnements") || content.includes("Subscriptions")) {
        openSubscriptionModal();
      } else if (content.includes("Mon compte") || content.includes("My account")) {
        openAccountModal();
      }
    }
  }
  
  console.log(`‚úÖ Traduction compl√®te termin√©e en ${currentLanguage.toUpperCase()}`);
}

// Fonction pour ouvrir/fermer le menu de langue
function toggleLanguageMenu() {
  const menu = document.getElementById("language-menu");
  if (!menu) return;
  
  const isOpen = menu.style.display === "block";
  menu.style.display = isOpen ? "none" : "block";
  
  // Fermer si on clique ailleurs
  if (!isOpen) {
    setTimeout(() => {
      document.addEventListener("click", function closeMenu(e) {
        if (!menu.contains(e.target) && !e.target.closest("#language-selector")) {
          menu.style.display = "none";
          document.removeEventListener("click", closeMenu);
        }
      });
    }, 100);
  }
}

// D√©tecter la langue de l'utilisateur (smartphone = langue du t√©l√©phone, desktop = langue du navigateur)
function detectUserLanguage() {
  const saved = localStorage.getItem("mapEventLanguage");
  if (saved && SUPPORTED_LANGUAGES.includes(saved)) return saved;
  const nav = (typeof navigator !== 'undefined' && (navigator.language || navigator.userLanguage)) ? (navigator.language || navigator.userLanguage) : "";
  const browser = nav.split("-")[0].toLowerCase();
  if (SUPPORTED_LANGUAGES.includes(browser)) return browser;
  // Correspondances courantes (navigator peut renvoyer pt-BR, zh-CN, etc.)
  const map = { "pt": "pt", "zh": "zh", "nb": "no", "nn": "no", "he": "he", "uk": "uk", "el": "el", "sv": "sv", "da": "da", "fi": "fi", "ro": "ro", "cs": "cs", "hu": "hu", "sk": "sk", "pl": "pl", "tr": "tr", "ru": "ru", "ar": "ar", "ja": "ja", "ko": "ko", "th": "th", "vi": "vi", "id": "id", "ms": "ms", "nl": "nl", "de": "de", "it": "it", "es": "es", "fr": "fr", "en": "en", "hi": "hi", "bg": "bg", "hr": "hr", "sr": "sr", "lt": "lt", "lv": "lv", "et": "et", "sl": "sl", "ta": "ta", "bn": "bn", "ur": "ur", "fa": "fa", "mr": "mr", "sw": "sw", "am": "am", "af": "af", "ca": "ca", "pa": "pa", "tl": "tl", "my": "my", "ne": "ne", "is": "is", "sq": "sq", "mk": "mk", "bs": "bs", "gl": "gl", "cy": "cy", "ka": "ka", "hy": "hy", "az": "az", "kk": "kk", "uz": "uz", "ml": "ml", "te": "te", "gu": "gu", "kn": "kn", "si": "si", "eu": "eu", "mn": "mn", "ga": "ga", "lb": "lb", "mt": "mt", "yo": "yo", "ha": "ha", "ig": "ig", "so": "so", "rw": "rw", "mg": "mg", "wo": "wo", "st": "st", "tn": "tn", "xh": "xh", "zu": "zu", "km": "km", "lo": "lo", "sd": "sd", "ps": "ps", "ky": "ky", "tk": "tk", "tg": "tg", "br": "br", "gd": "gd", "fy": "fy", "ku": "ku", "ckb": "ckb", "kmr": "kmr", "ht": "ht", "jv": "jv", "su": "su", "ny": "ny", "om": "om", "ti": "ti", "dv": "dv", "bo": "bo", "dz": "dz", "or": "or", "as": "as" };
  return map[browser] || "en";
}

// Charger la langue sauvegard√©e ou d√©tect√©e au d√©marrage (smartphone + desktop)
function initLanguage() {
  // CRITIQUE: S'assurer que window.translations est compl√®tement initialis√© AVANT updateUITranslations()
  if (typeof window === 'undefined' || !window.translations || typeof window.translations !== 'object') {
    window.translations = { fr: {}, en: {}, es: {}, zh: {}, hi: {} };
  }
  SUPPORTED_LANGUAGES.forEach(lang => {
    if (!window.translations[lang] || typeof window.translations[lang] !== 'object') {
      window.translations[lang] = window.translations[lang] || {};
    }
  });
  
  // Priorit√© : 1) langue sauvegard√©e, 2) langue du navigateur/t√©l√©phone, 3) anglais
  currentLanguage = detectUserLanguage();
  localStorage.setItem("mapEventLanguage", currentLanguage);
  updateUITranslations();
  console.log("üåç Langue : " + (currentLanguage === "fr" ? "fran√ßais (d√©faut)" : currentLanguage.toUpperCase() + " (d√©tect√©e ou sauvegard√©e)"));
}

// Exports
window.toggleLanguageMenu = toggleLanguageMenu;
window.setLanguage = setLanguage;
window.translateThisComment = translateThisComment;
window.openItemFromAgenda = openItemFromAgenda;
window.selectSuggestion = selectSuggestion;
window.highlightSuggestion = highlightSuggestion;

// Mettre √† jour le badge abonnement dans la topbar
function updateSubscriptionBadge() {
  if (!isLoggedIn()) {
    const badge = document.getElementById("subscription-badge");
    if (badge) {
      const label = document.getElementById("subscription-label");
      if (label) label.textContent = "ABOS";
    }
    return;
  }
  
  const badge = document.getElementById("subscription-badge");
  const label = document.getElementById("subscription-label");
  if (!badge || !label) return;
  
  const sub = currentUser.subscription || "free";
  
  // TOUJOURS afficher "ABOS" peu importe l'abonnement - FORCER IMM√âDIATEMENT
  label.textContent = "ABOS";
  label.innerHTML = "ABOS"; // Double v√©rification avec innerHTML
  
  // Plans Full Premium
  if (sub === "full-premium" || sub === "full") {
    badge.style.background = "linear-gradient(135deg,rgba(255,215,0,0.3),rgba(255,215,0,0.1))";
    badge.style.borderColor = "rgba(255,215,0,0.6)";
    label.style.color = "#ffd700";
  }
  // Plans Service Ultra
  else if (sub === "service-ultra" || sub === "booking-ultra") {
    badge.style.background = "linear-gradient(135deg,rgba(167,139,250,0.3),rgba(139,92,246,0.2))";
    badge.style.borderColor = "rgba(167,139,250,0.6)";
    label.style.color = "#a78bfa";
  }
  // Plans Service Pro
  else if (sub === "service-pro" || sub === "booking-pro" || sub === "pro") {
    badge.style.background = "linear-gradient(135deg,rgba(139,92,246,0.3),rgba(59,130,246,0.2))";
    badge.style.borderColor = "rgba(139,92,246,0.6)";
    label.style.color = "#a78bfa";
  }
  // Plans Events Alertes Pro
  else if (sub === "events-alerts-pro" || sub === "events-alerts") {
    badge.style.background = "linear-gradient(135deg,rgba(59,130,246,0.3),rgba(37,99,235,0.2))";
    badge.style.borderColor = "rgba(59,130,246,0.6)";
    label.style.color = "#3b82f6";
  }
  // Plans Events Explorer
  else if (sub === "events-explorer" || sub === "explorer") {
    badge.style.background = "linear-gradient(135deg,rgba(34,197,94,0.3),rgba(16,185,129,0.2))";
    badge.style.borderColor = "rgba(34,197,94,0.6)";
    label.style.color = "#22c55e";
  }
  // Ancien premium (compatibilit√©)
  else if (sub === "premium") {
    badge.style.background = "linear-gradient(135deg,rgba(255,215,0,0.3),rgba(255,215,0,0.1))";
    badge.style.borderColor = "rgba(255,215,0,0.6)";
    label.style.color = "#ffd700";
  }
  // Gratuit
  else {
    badge.style.background = "linear-gradient(135deg,rgba(139,92,246,0.2),rgba(59,130,246,0.1))";
    badge.style.borderColor = "rgba(139,92,246,0.4)";
    label.style.color = "#a78bfa";
  }
}

// ============================================
// MISSION √âCOLOGIQUE - SAUVER LA TERRE üåç
// ============================================
function openEcoMissionModal() {
  const html = `
    <div style="padding:16px;text-align:center;">
      <div style="font-size:60px;margin-bottom:16px;">üåç</div>
      <h2 style="margin:0 0 12px;font-size:22px;background:linear-gradient(90deg,#22c55e,#10b981);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;">
        Notre Mission : Sauver la Plan√®te
      </h2>
      
      <p style="font-size:14px;color:var(--ui-text-main);line-height:1.6;margin-bottom:20px;">
        <strong>Map Event</strong> n'est pas qu'une plateforme d'√©v√©nements.<br>
        C'est un projet engag√© pour l'environnement.
      </p>
      
      <div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:12px;padding:16px;margin-bottom:20px;text-align:left;">
        <div style="font-size:14px;font-weight:600;color:#22c55e;margin-bottom:12px;">üíö O√π vont vos contributions ?</div>
        <ul style="margin:0;padding-left:20px;font-size:13px;color:var(--ui-text-main);line-height:1.8;">
          <li><strong>üå≥ Achat de terrains forestiers</strong> ‚Äì Protection des √©cosyst√®mes</li>
          <li><strong>üè≠ Filtres CO2 pour entreprises</strong> ‚Äì Offerts aux plus gros pollueurs</li>
          <li><strong>üåä Nettoyage des oc√©ans</strong> ‚Äì Partenariats avec Ocean Cleanup</li>
          <li><strong>‚òÄÔ∏è √ânergie renouvelable</strong> ‚Äì Financement de projets solaires</li>
          <li><strong>üêù Protection de la biodiversit√©</strong> ‚Äì Ruches urbaines & r√©serves</li>
          <li><strong>üéì √âducation environnementale</strong> ‚Äì Sensibilisation des jeunes</li>
        </ul>
      </div>
      
      <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:16px;margin-bottom:20px;">
        <div style="font-size:14px;font-weight:600;color:#3b82f6;margin-bottom:8px;">üìä R√©partition de nos revenus</div>
        <div style="display:flex;justify-content:center;gap:20px;font-size:12px;color:var(--ui-text-main);">
          <div><strong style="color:#22c55e;font-size:24px;">70%</strong><br>Mission Plan√®te</div>
          <div><strong style="color:#f59e0b;font-size:24px;">20%</strong><br>D√©veloppement</div>
          <div><strong style="color:#8b5cf6;font-size:24px;">10%</strong><br>√âquipe</div>
        </div>
      </div>
      
      <div style="font-size:13px;color:var(--ui-text-muted);margin-bottom:16px;">
        Chaque paiement sur Map Event contribue directement √† ces actions.<br>
        <strong>Ensemble, on peut faire la diff√©rence.</strong> üå±
      </div>
      
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <button onclick="makeDonation(5)" style="flex:1;padding:12px;border-radius:12px;border:none;cursor:pointer;font-weight:600;background:rgba(34,197,94,0.2);color:#22c55e;font-size:14px;">
          üå± 5 CHF
        </button>
        <button onclick="makeDonation(10)" style="flex:1;padding:12px;border-radius:12px;border:none;cursor:pointer;font-weight:600;background:rgba(34,197,94,0.3);color:#22c55e;font-size:14px;">
          üå≥ 10 CHF
        </button>
        <button onclick="makeDonation(25)" style="flex:1;padding:12px;border-radius:12px;border:none;cursor:pointer;font-weight:600;background:rgba(34,197,94,0.4);color:#22c55e;font-size:14px;">
          üå≤ 25 CHF
        </button>
      </div>
      
      <button onclick="makeDonation(0)" style="width:100%;padding:14px;border-radius:999px;border:none;cursor:pointer;font-weight:700;font-size:15px;background:linear-gradient(135deg,#22c55e,#10b981);color:white;box-shadow:0 8px 24px rgba(34,197,94,0.4);">
        üíö Faire un don personnalis√©
      </button>
      
      <button onclick="closePublishModal()" style="width:100%;margin-top:12px;padding:10px;border-radius:999px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-muted);cursor:pointer;font-size:12px;">
        Fermer
      </button>
    </div>
  `;
  
  document.getElementById("publish-modal-inner").innerHTML = html;
  const backdrop = document.getElementById("publish-modal-backdrop");
  if (backdrop) {
    backdrop.setAttribute('data-auth-modal', 'true');
    backdrop.style.display = "flex";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
    backdrop.style.paddingTop = "40px";
    backdrop.style.paddingBottom = "40px";
    backdrop.style.boxSizing = "border-box";
  }
}

function makeDonation(amount) {
  if (amount === 0) {
    const customAmount = prompt("Montant de votre don (CHF) :");
    if (customAmount && !isNaN(customAmount) && parseFloat(customAmount) > 0) {
      amount = parseFloat(customAmount);
    } else {
      return;
    }
  }
  
  showNotification(`üåç Merci pour votre don de ${amount} CHF ! La Terre vous remercie üíö`, "success");
  closePublishModal();
  
  // Afficher un message de remerciement apr√®s
  setTimeout(() => {
    showNotification("üå≥ Votre contribution sera utilis√©e pour prot√©ger notre plan√®te.", "info");
  }, 2000);
}

// ============================================
// SYST√àME D'ALERTES ET D'ALARMES - LEADER MONDIAL
// ============================================

// API_BASE_URL est maintenant d√©fini en haut du fichier

// Fonction pour charger l'utilisateur depuis /api/user/me (source de v√©rit√©)
async function loadCurrentUserFromAPI() {
  try {
    // LOG: API_BASE_URL utilis√©
    console.log('[AUTH] API_BASE_URL:', window.API_BASE_URL);
    
    const accessToken = getAuthToken();
    const refreshToken = getRefreshToken();
    
    if (!accessToken) {
      console.log('[AUTH] Pas de token');
      localStorage.removeItem('currentUser');
      sessionStorage.removeItem('currentUser');
      currentUser = getDefaultUser();
      return null;
    }
    
    // LOG: Tentative /api/user/me
    console.log('[AUTH] Appel GET /api/user/me...');
    
    // Appeler /api/user/me avec le token
    const response = await fetch(`${window.API_BASE_URL}/user/me`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${accessToken}`
      }
    });
    
    // LOG: Status /api/user/me
    console.log('[AUTH] GET /api/user/me - Status:', response.status, response.statusText);
    
    if (response.ok) {
      const data = await response.json();
      const user = data.user;
      
      // IMPORTANT: Normaliser la source d'avatar avec priorit√© claire
      // Priorit√©: profile_photo_url > profilePhoto > avatarUrl > avatar > emoji
      const avatarUrl = user.profile_photo_url || user.profilePhoto || user.avatarUrl || user.avatar || null;
      
      // Mettre √† jour currentUser avec les donn√©es du serveur (source de v√©rit√©)
      // Exclure agenda du spread car il sera charg√© s√©par√©ment par loadAgendaFromBackend()
      const { agenda: _apiAgenda, ...userWithoutAgenda } = user;
      const existingAgenda = currentUser?.agenda || [];
      
      currentUser = {
        ...userWithoutAgenda,
        isLoggedIn: true,
        accessToken: accessToken,
        refreshToken: refreshToken,
        // Normaliser avatar avec priorit√©
        avatarUrl: avatarUrl, // Champ unifi√©
        profilePhoto: avatarUrl, // Alias
        profile_photo_url: avatarUrl, // Alias
        avatar: avatarUrl || 'üë§', // Fallback emoji
        // Pr√©server l'agenda existant en attendant le chargement complet par loadAgendaFromBackend()
        agenda: (_apiAgenda && Array.isArray(_apiAgenda) && _apiAgenda.length > 0) ? _apiAgenda : existingAgenda
      };
      
      window.currentUser = currentUser;
      
      console.log('[AUTH] Utilisateur charge depuis /api/user/me:', user.email);
      console.log('[AVATAR] Avatar normalise:', avatarUrl ? avatarUrl.substring(0, 50) + '...' : 'null (emoji)');
      
      // Mettre √† jour l'UI imm√©diatement apr√®s chargement
      if (typeof updateAccountBlockLegitimately === 'function') {
        setTimeout(() => updateAccountBlockLegitimately(), 100);
      }
      
      return currentUser;
    } else if (response.status === 401) {
      // Token expir√©, tenter refresh
      console.log('[AUTH] Token expire (401), tentative refresh...');
      
      if (!refreshToken) {
        console.log('[AUTH] Pas de refresh token');
        localStorage.removeItem('currentUser');
        sessionStorage.removeItem('currentUser');
        currentUser = getDefaultUser();
        return null;
      }
      
      // LOG: Tentative /api/auth/refresh
      console.log('[AUTH] Appel POST /api/auth/refresh...');
      
      // Appeler /api/auth/refresh
      const refreshResponse = await fetch(`${window.API_BASE_URL}/auth/refresh`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ refreshToken: refreshToken })
      });
      
      // LOG: Status refresh
      console.log('[AUTH] POST /api/auth/refresh - Status:', refreshResponse.status, refreshResponse.statusText);
      
      if (refreshResponse.ok) {
        const refreshData = await refreshResponse.json();
        const newAccessToken = refreshData.accessToken;
        
        // Sauvegarder le nouveau token
        localStorage.setItem('accessToken', newAccessToken);
        console.log('[AUTH] Nouveau accessToken obtenu');
        
        // R√©essayer /api/user/me avec le nouveau token
        console.log('[AUTH] Retry GET /api/user/me avec nouveau token...');
        const retryResponse = await fetch(`${window.API_BASE_URL}/user/me`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${newAccessToken}`
          }
        });
        
        // LOG: Status retry /api/user/me
        console.log('[AUTH] Retry GET /api/user/me - Status:', retryResponse.status, retryResponse.statusText);
        
        if (retryResponse.ok) {
          const retryData = await retryResponse.json();
          const user = retryData.user;
          
          // IMPORTANT: Normaliser avatar avec priorit√© claire
          const avatarUrl = user.profile_photo_url || user.profilePhoto || user.avatarUrl || user.avatar || null;
          
          // Exclure agenda du spread car charg√© s√©par√©ment par loadAgendaFromBackend()
          const { agenda: _retryAgenda, ...retryUserWithoutAgenda } = user;
          const retryExistingAgenda = currentUser?.agenda || [];
          
          currentUser = {
            ...retryUserWithoutAgenda,
            isLoggedIn: true,
            accessToken: newAccessToken,
            refreshToken: refreshToken,
            avatarUrl: avatarUrl, // Champ unifi√©
            profilePhoto: avatarUrl, // Alias
            profile_photo_url: avatarUrl, // Alias
            avatar: avatarUrl || 'üë§', // Fallback emoji
            agenda: (_retryAgenda && Array.isArray(_retryAgenda) && _retryAgenda.length > 0) ? _retryAgenda : retryExistingAgenda
          };
          
          window.currentUser = currentUser;
          console.log('[AUTH] Utilisateur charge apres refresh:', user.email);
          console.log('[AVATAR] Avatar normalise apres refresh:', avatarUrl ? avatarUrl.substring(0, 50) + '...' : 'null (emoji)');
          
          // Mettre √† jour l'UI imm√©diatement apr√®s refresh
          if (typeof updateAccountBlockLegitimately === 'function') {
            setTimeout(() => updateAccountBlockLegitimately(), 100);
          }
          
          return currentUser;
        } else {
          console.log('[AUTH] Retry /api/user/me echoue:', retryResponse.status);
        }
      } else {
        console.log('[AUTH] Refresh echoue:', refreshResponse.status);
      }
      
      // Refresh √©chou√© - tokens conserv√©s
      console.log('[AUTH] Refresh echoue');
      localStorage.removeItem('currentUser');
      sessionStorage.removeItem('currentUser');
      currentUser = getDefaultUser();
      return null;
    } else {
      // Autre erreur
      console.error('[AUTH] Erreur chargement utilisateur:', response.status);
      return null;
    }
  } catch (error) {
    console.error('[AUTH] Erreur lors du chargement utilisateur:', error);
    return null;
  }
}

// --- CONFIGURATION STRIPE ---
// Note: La cl√© publique sera r√©cup√©r√©e depuis le backend lors de la cr√©ation de la session
let stripe = null;
let stripePublicKey = null;

// Initialiser Stripe (sera fait apr√®s r√©cup√©ration de la cl√© publique)
function initStripe(publicKey) {
  if (!publicKey) {
    console.warn('‚ö†Ô∏è Cl√© publique Stripe manquante');
    return;
  }
  
  // Charger Stripe.js √† la demande si pas encore charg√©
  if (typeof Stripe === 'undefined') {
    console.log('‚è≥ Chargement de Stripe.js √† la demande...');
    if (typeof window.loadStripe === 'function') {
      window.loadStripe().then(() => {
      if (typeof Stripe !== 'undefined') {
          try {
        stripe = Stripe(publicKey);
        stripePublicKey = publicKey;
            console.log('‚úÖ Stripe initialis√© (charg√© √† la demande)');
          } catch (error) {
            console.error('‚ùå Erreur initialisation Stripe:', error);
          }
      } else {
          console.error('‚ùå Stripe.js toujours non disponible apr√®s chargement');
      }
      });
    } else {
      console.error('‚ùå loadStripe non disponible');
    }
    return;
  }
  
  try {
    stripe = Stripe(publicKey);
    stripePublicKey = publicKey;
    console.log('‚úÖ Stripe initialis√© avec succ√®s');
  } catch (error) {
    console.error('‚ùå Erreur initialisation Stripe:', error);
  }
}

// Stripe.js est charg√© √† la demande (lazy-load) - pas de v√©rification au d√©marrage

// √âtat des alertes
let alertsViewOpen = false;
let alertsScrollPosition = 0;
let selectedAlertId = null;
let alarmsViewOpen = false;

// Variables pour les alarmes
let currentUserAlarms = []; // [{alertId, eventId, favoriteId, favoriteName, favoriteMode, timeBefore: {value, unit}, createdAt}]
let alarmsForAgenda = []; // M√™me structure pour l'agenda

// ============================================
// D√âTECTION AUTOMATIQUE DES FAVORIS DANS LES √âV√âNEMENTS
// ============================================

// V√©rifier si des favoris apparaissent dans de nouveaux √©v√©nements
async function checkFavoritesInNewEvents(newEvents) {
  if (!currentUser.isLoggedIn || !currentUser.favorites || currentUser.favorites.length === 0) {
    return;
  }

  const maxAlerts = getAlertLimit();
  if (maxAlerts === 0) return; // Pas d'alertes pour les utilisateurs gratuits

  const newAlerts = [];

  // Pour chaque nouvel √©v√©nement
  newEvents.forEach(event => {
    if (!event || !event.title) return;

    const eventTitle = (event.title || '').toLowerCase();
    const eventDescription = (event.description || '').toLowerCase();
    const eventLocation = (event.location || event.city || '').toLowerCase();

    // Pour chaque favori de l'utilisateur
    currentUser.favorites.forEach(favorite => {
      if (!favorite || !favorite.name) return;

      const favoriteName = favorite.name.toLowerCase();
      
      // V√©rifier si le nom du favori appara√Æt dans le titre, description ou location
      const foundInTitle = eventTitle.includes(favoriteName);
      const foundInDescription = eventDescription.includes(favoriteName);
      const foundInLocation = eventLocation.includes(favoriteName);

      if (foundInTitle || foundInDescription || foundInLocation) {
        // V√©rifier si l'alerte existe d√©j√†
        const alertExists = currentUser.alerts.some(a => 
          a.eventId === event.id.toString() && 
          a.favoriteId === favorite.id &&
          a.status !== 'deleted'
        );

        if (!alertExists) {
          // ‚úÖ NOUVEAU : V√©rifier la distance entre l'utilisateur et l'√©v√©nement
          // L'alerte n'est cr√©√©e que si l'√©v√©nement est √† moins de 75 km d'au moins une adresse de l'utilisateur
          if (!event.lat || !event.lng) {
            // Si l'√©v√©nement n'a pas de coordonn√©es, on ne peut pas calculer la distance
            // On ne cr√©e pas l'alerte
            return;
          }

          // V√©rifier si l'utilisateur a au moins une adresse d√©finie
          if (!currentUser.addresses || currentUser.addresses.length === 0) {
            // Si l'utilisateur n'a pas d'adresse, on ne cr√©e pas l'alerte
            console.log('‚ö†Ô∏è Aucune adresse utilisateur d√©finie - alerte non cr√©√©e');
            return;
          }

          // V√©rifier la distance pour chaque adresse de l'utilisateur
          let distanceToUser = null;
          let closestAddress = null;
          
          for (const address of currentUser.addresses) {
            if (address.lat && address.lng) {
              const distance = calculateDistance(
                address.lat, address.lng,
                event.lat, event.lng
              );
              
              // Si l'√©v√©nement est √† moins de 75 km de cette adresse
              if (distance <= 75) {
                if (!distanceToUser || distance < distanceToUser) {
                  distanceToUser = distance;
                  closestAddress = address;
                }
              }
            }
          }

          // ‚úÖ Condition : L'alerte n'est cr√©√©e que si l'√©v√©nement est √† moins de 75 km d'au moins une adresse
          if (distanceToUser === null || distanceToUser > 75) {
            console.log(`‚ö†Ô∏è √âv√©nement trop loin (${distanceToUser ? distanceToUser + ' km' : 'distance inconnue'} > 75 km) - alerte non cr√©√©e`);
            return;
          }

          // Calculer la distance entre le favori et l'√©v√©nement (pour affichage)
          let distanceToFavorite = null;
          if (favorite.lat && favorite.lng) {
            distanceToFavorite = calculateDistance(
              event.lat, event.lng,
              favorite.lat, favorite.lng
            );
          }

          // V√©rifier la limite d'alertes pour d√©terminer si elle doit √™tre flout√©e
          const alertLimit = getAlertLimit();
          const activeAlerts = currentUser.alerts.filter(a => a.status !== 'deleted' && !a.isBlurred);
          const isBlurred = alertLimit !== Infinity && activeAlerts.length >= alertLimit;

          const alert = {
            id: `alert-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            eventId: event.id.toString(),
            favoriteId: favorite.id,
            favoriteName: favorite.name,
            favoriteMode: favorite.mode || favorite.type || 'event',
            distance: distanceToFavorite, // Distance entre favori et √©v√©nement
            distanceToUser: distanceToUser, // Distance entre utilisateur et √©v√©nement
            closestAddress: closestAddress ? (closestAddress.address || closestAddress.city) : null,
            status: 'new',
            isBlurred: isBlurred, // ‚úÖ Alerte flout√©e si limite atteinte
            creationDate: new Date().toISOString(),
            eventTitle: event.title,
            eventDate: event.startDate || event.date
          };

          newAlerts.push(alert);
          
          // Si l'alerte est flout√©e, supprimer les alarmes correspondantes (elles n'existent pas encore, mais on pr√©pare)
          // Les alarmes seront supprim√©es automatiquement quand elles seront cr√©√©es pour une alerte flout√©e
        }
      }
    });
  });

  // Ajouter les nouvelles alertes
  if (newAlerts.length > 0) {
    // Sauvegarder dans le backend
    for (const alert of newAlerts) {
      try {
        const response = await fetch(`${window.API_BASE_URL}/user/alerts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: currentUser.id.toString(),
            alert: alert
          })
        });

        if (response.ok) {
          currentUser.alerts.push(alert);
        }
      } catch (error) {
        console.error('Erreur cr√©ation alerte:', error);
      }
    }

    // Afficher la fen√™tre popup au login si l'utilisateur vient de se connecter
    if (currentUser && currentUser.isLoggedIn) {
      showAlertsLoginPopup(newAlerts);
    }
  }
}

// Calculer la distance entre deux points (formule de Haversine)
// Fonction calculateDistance d√©j√† d√©finie plus haut (ligne 2753)
// Cette fonction utilise la signature: calculateDistance(lat1, lng1, lat2, lng2)

// ============================================
// FEN√äTRE POPUP D'ALERTES AU LOGIN
// ============================================

function showAlertsLoginPopup(newAlerts) {
  if (!newAlerts || newAlerts.length === 0) return;

  const html = `
    <div style="position:relative;width:100%;max-width:500px;background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:20px;border:2px solid #3b82f6;box-shadow:0 20px 60px rgba(59,130,246,0.3);overflow:hidden;">
      <div style="background:linear-gradient(135deg,#3b82f6,#2563eb);padding:20px;text-align:center;">
        <div style="font-size:32px;margin-bottom:8px;">üîî</div>
        <h2 style="margin:0;font-size:22px;font-weight:700;color:#fff;">Nouvelles Alertes</h2>
        <p style="margin:8px 0 0;font-size:14px;color:rgba(255,255,255,0.9);">Vos favoris apparaissent dans de nouveaux √©v√©nements !</p>
      </div>
      
      <div style="padding:20px;max-height:400px;overflow-y:auto;">
        ${newAlerts.map(alert => `
          <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:16px;margin-bottom:12px;">
            <div style="display:flex;align-items:start;gap:12px;">
              <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#2563eb);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">
                ${getFavoriteEmoji(alert.favoriteMode)}
              </div>
              <div style="flex:1;">
                <div style="font-weight:700;font-size:16px;margin-bottom:4px;color:#fff;">
                  ${escapeHtml(alert.favoriteName)}
                </div>
                <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-bottom:6px;">
                  appara√Æt dans l'√©v√©nement
                </div>
                <div style="font-weight:600;font-size:14px;color:#00ffc3;margin-bottom:4px;">
                  ${escapeHtml(alert.eventTitle)}
                </div>
                ${alert.distanceToUser ? `<div style="font-size:12px;color:rgba(255,255,255,0.6);">üìç √Ä ${alert.distanceToUser} km de chez vous</div>` : alert.distance ? `<div style="font-size:12px;color:rgba(255,255,255,0.6);">üìç √Ä ${alert.distance} km</div>` : ''}
              </div>
            </div>
          </div>
        `).join('')}
        
        <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:16px;margin-top:16px;text-align:center;">
          <div style="font-size:14px;color:rgba(255,255,255,0.8);">
            üí° Toutes vos alertes sont disponibles dans le bloc <strong style="color:#3b82f6;">Alertes</strong>
          </div>
        </div>
      </div>
      
      <div style="padding:20px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:12px;">
        <button onclick="closeAlertsLoginPopup()" style="flex:1;padding:14px;border-radius:12px;border:none;background:rgba(255,255,255,0.1);color:#fff;font-weight:600;cursor:pointer;transition:all 0.2s;">
          Fermer
        </button>
        <button onclick="closeAlertsLoginPopupAndOpenAlerts()" style="flex:1;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-weight:600;cursor:pointer;transition:all 0.2s;">
          OK, j'ai compris
        </button>
      </div>
    </div>
  `;

  // Cr√©er ou r√©utiliser le backdrop
  let backdrop = document.getElementById("alerts-login-popup-backdrop");
  if (!backdrop) {
    backdrop = document.createElement("div");
    backdrop.id = "alerts-login-popup-backdrop";
    backdrop.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(10px);";
    backdrop.onclick = (e) => {
      if (e.target === backdrop) closeAlertsLoginPopup();
    };
    document.body.appendChild(backdrop);
  }
  
  backdrop.innerHTML = html;
  backdrop.style.display = "flex";
}

function closeAlertsLoginPopup() {
  const backdrop = document.getElementById("alerts-login-popup-backdrop");
  if (backdrop) {
    backdrop.style.display = "none";
  }
}

function closeAlertsLoginPopupAndOpenAlerts() {
  closeAlertsLoginPopup();
  setTimeout(() => {
    openAlertsView();
  }, 300);
}

// Afficher les notifications de changement de statut pour les √©v√©nements o√π l'utilisateur a particip√©
function showStatusChangeNotifications() {
  if (!currentUser.isLoggedIn || !currentUser.pendingStatusNotifications || currentUser.pendingStatusNotifications.length === 0) {
    return;
  }
  
  // Filtrer les notifications qui concernent des √©v√©nements toujours dans participating
  const validNotifications = currentUser.pendingStatusNotifications.filter(notif => {
    const key = `event:${notif.eventId}`;
    return currentUser.participating.includes(key);
  });
  
  if (validNotifications.length === 0) {
    // Nettoyer les notifications obsol√®tes
    currentUser.pendingStatusNotifications = [];
    saveUser();
    return;
  }
  
  // Afficher la premi√®re notification
  const notification = validNotifications[0];
  const event = eventsData.find(e => e.id === notification.eventId);
  if (!event) {
    // Supprimer la notification si l'√©v√©nement n'existe plus
    currentUser.pendingStatusNotifications = currentUser.pendingStatusNotifications.filter(n => n.eventId !== notification.eventId);
    saveUser();
    return;
  }
  
  // Cr√©er la fen√™tre de notification
  let backdrop = document.getElementById("status-change-notification-backdrop");
  if (!backdrop) {
    backdrop = document.createElement("div");
    backdrop.id = "status-change-notification-backdrop";
    backdrop.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(2px);padding-top:40px;padding-bottom:40px;box-sizing:border-box;";
    document.body.appendChild(backdrop);
  }
  
  const statusEmoji = notification.status === 'REPORT√â' || notification.status === 'REPORTE' ? 'üìÖ' :
                     notification.status === 'ANNULE' || notification.status === 'ANNUL√â' ? '‚ùå' :
                     notification.status === 'COMPLET' || notification.status === 'SOLDOUT' ? 'üîí' : '‚ö†Ô∏è';
  
  const statusColor = notification.status === 'REPORT√â' || notification.status === 'REPORTE' ? '#3b82f6' :
                      notification.status === 'ANNULE' || notification.status === 'ANNUL√â' ? '#ef4444' :
                      notification.status === 'COMPLET' || notification.status === 'SOLDOUT' ? '#f59e0b' : '#ef4444';
  
  backdrop.innerHTML = `
    <div style="position:relative;width:100%;max-width:500px;background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:20px;border:2px solid ${statusColor};box-shadow:0 20px 60px rgba(0,0,0,0.5);overflow:hidden;">
      <button onclick="closeStatusChangeNotification(${notification.eventId})" style="position:absolute;top:12px;right:12px;width:36px;height:36px;border-radius:50%;border:none;background:rgba(255,255,255,0.1);color:#fff;cursor:pointer;font-size:20px;z-index:1001;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.8)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">‚úï</button>
      
      <div style="background:linear-gradient(135deg,${statusColor},${statusColor}dd);padding:20px;text-align:center;">
        <div style="font-size:48px;margin-bottom:8px;">${statusEmoji}</div>
        <h2 style="margin:0;font-size:22px;font-weight:700;color:#fff;">Changement d'√©v√©nement</h2>
        <p style="margin:8px 0 0;font-size:14px;color:rgba(255,255,255,0.9);">L'√©v√©nement auquel vous participez a chang√©</p>
      </div>
      
      <div style="padding:24px;">
        <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:16px;margin-bottom:20px;">
          <div style="font-size:18px;font-weight:700;color:#fff;margin-bottom:8px;">${escapeHtml(event.title)}</div>
          <div style="font-size:14px;color:var(--ui-text-muted);margin-bottom:12px;">${escapeHtml(event.address || '')}</div>
          <div style="padding:8px 12px;background:rgba(239,68,68,0.2);border-radius:8px;display:inline-block;">
            <span style="font-size:13px;font-weight:600;color:#ef4444;">‚ö†Ô∏è √âv√©nement ${notification.statusText}</span>
          </div>
        </div>
        
        <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:16px;margin-bottom:20px;">
          <div style="font-size:13px;font-weight:600;color:#3b82f6;margin-bottom:8px;">üí° Que souhaitez-vous faire ?</div>
          <div style="font-size:12px;color:var(--ui-text-muted);line-height:1.6;">
            Vous pouvez ajouter cette annonce dans le bloc <strong style="color:#3b82f6;">ABOS</strong> pour recevoir des alertes sur les changements futurs.
          </div>
        </div>
        
        <div style="display:flex;gap:10px;">
          <button onclick="closeStatusChangeNotification(${notification.eventId})" style="flex:1;padding:12px;border-radius:12px;border:1px solid var(--ui-card-border);background:transparent;color:var(--ui-text-main);font-weight:600;cursor:pointer;transition:all 0.2s;">
            Fermer
          </button>
          <button onclick="addEventToAlertsFromNotification(${notification.eventId})" style="flex:1;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-weight:600;cursor:pointer;transition:all 0.2s;">
            Ajouter aux alertes
          </button>
        </div>
      </div>
    </div>
  `;
  
  backdrop.style.display = "flex";
}

function closeStatusChangeNotification(eventId) {
  // Supprimer la notification de la liste
  currentUser.pendingStatusNotifications = currentUser.pendingStatusNotifications.filter(n => n.eventId !== eventId);
  saveUser();
  
  // Fermer la fen√™tre
  const backdrop = document.getElementById("status-change-notification-backdrop");
  if (backdrop) {
    backdrop.style.display = "none";
  }
  
  // Afficher la notification suivante s'il y en a
  setTimeout(() => {
    showStatusChangeNotifications();
  }, 300);
}

// Ajouter une alerte pour un √©v√©nement depuis l'agenda
function addEventAlert(eventId) {
  const event = eventsData.find(e => e.id === eventId);
  if (!event) {
    showNotification("‚ö†Ô∏è √âv√©nement introuvable", "warning");
    return;
  }
  
  if (!currentUser || !currentUser.isLoggedIn) {
    showNotification("‚ö†Ô∏è Vous devez √™tre connect√© pour ajouter des alertes", "warning");
    openLoginModal();
    return;
  }
  
  // V√©rifier la limite d'alertes
  const maxAlerts = getAlertLimit();
  if (maxAlerts === 0) {
    showNotification("‚ö†Ô∏è Les alertes n√©cessitent un abonnement Events Explorer ou sup√©rieur", "warning");
    openSubscriptionModal();
    return;
  }
  
  if (currentUser.alerts && currentUser.alerts.length >= maxAlerts) {
    showNotification(`‚ö†Ô∏è Limite atteinte (${maxAlerts} alertes) ! Passez √† Events Alertes Pro pour des alertes illimit√©es.`, "warning");
    openSubscriptionModal();
    return;
  }
  
  // V√©rifier si l'alerte existe d√©j√†
  const existingAlert = currentUser.alerts?.find(a => a.eventId === eventId && a.status !== 'deleted');
  if (existingAlert) {
    showNotification("‚ÑπÔ∏è Cet √©v√©nement est d√©j√† dans vos alertes", "info");
    return;
  }
  
  // Cr√©er l'alerte
  if (!currentUser.alerts) currentUser.alerts = [];
  currentUser.alerts.push({
    id: Date.now(),
    eventId: eventId,
    type: 'event',
    category: event.category,
    city: event.city,
    createdAt: new Date().toISOString(),
    status: 'active'
  });
  
  saveUser();
  showNotification(`‚úÖ Alerte ajout√©e pour "${event.title}"`, "success");
  
  // Rafra√Æchir la vue agenda si elle est ouverte
  if (agendaMiniWindowOpen) {
    showAgendaMiniWindow();
  }
}

function addEventToAlertsFromNotification(eventId) {
  const event = eventsData.find(e => e.id === eventId);
  if (!event) return;
  
  // Utiliser la fonction addEventAlert
  addEventAlert(eventId);
  closeStatusChangeNotification(eventId);
  setTimeout(() => {
    openSubscriptionModal();
    showNotification("üí° Vous pouvez cr√©er une alerte dans le bloc ABOS pour cet √©v√©nement", "info");
  }, 300);
}

function getFavoriteEmoji(mode) {
  const emojis = {
    'event': 'üéâ',
    'booking': 'üé§',
    'service': '‚öôÔ∏è',
    'avatar': 'üë§'
  };
  return emojis[mode] || '‚≠ê';
}

// ============================================
// ============================================
// SYST√àME D'ALERTES DE PROXIMIT√â (rayon 70km)
// ============================================

let proximityAlertsViewOpen = false;

// V√©rifier les alertes de proximit√© bas√©es sur les likes et les adresses
function checkProximityAlerts() {
  if (!currentUser.isLoggedIn || !currentUser.addresses || currentUser.addresses.length === 0) {
    currentUser.proximityAlerts = [];
    updateProximityAlertsBadge();
    return;
  }
  
  const alerts = [];
  const likedItems = currentUser.likes || [];
  
  // Parcourir tous les items lik√©s
  likedItems.forEach(likeKey => {
    const [type, idStr] = likeKey.split(':');
    const id = parseInt(idStr);
    
    let item = null;
    if (type === 'event') {
      item = eventsData.find(e => e.id === id);
    } else if (type === 'booking') {
      item = bookingsData.find(b => b.id === id);
    } else if (type === 'service') {
      item = servicesData.find(s => s.id === id);
    }
    
    if (!item) return;
    
    // CAS 1: Item lik√© directement (event, booking, service)
    if (item.lat && item.lng) {
      currentUser.addresses.forEach((address, addrIndex) => {
        if (!address.lat || !address.lng) return;
        
        const distance = calculateDistance(address.lat, address.lng, item.lat, item.lng);
        
        if (distance <= 70) {
          const existingAlert = alerts.find(a => 
            a.itemId === id && a.itemType === type && a.addressIndex === addrIndex && a.alertType === 'direct'
          );
          
          if (!existingAlert) {
            const typeEmoji = type === 'event' ? 'üéâ' : type === 'booking' ? 'üé§' : 'üîß';
            const typeName = type === 'event' ? '√âv√©nement' : type === 'booking' ? 'Booking' : 'Service';
            
            alerts.push({
              id: `proximity-${type}-${id}-${addrIndex}-direct-${Date.now()}`,
              itemId: id,
              itemType: type,
              itemTitle: item.title || item.name || 'Sans titre',
              itemCity: item.city || '',
              itemLat: item.lat,
              itemLng: item.lng,
              addressIndex: addrIndex,
              address: address.address || address.city || 'Adresse inconnue',
              distance: Math.round(distance * 10) / 10,
              emoji: typeEmoji,
              typeName: typeName,
              alertType: 'direct', // Item lik√© directement
              timestamp: new Date().toISOString()
            });
          }
        }
      });
    }
    
    // CAS 2: Booking (artiste) lik√© appara√Æt dans un √©v√©nement
    if (type === 'booking' && item.lat && item.lng) {
      eventsData.forEach(event => {
        if (!event.lat || !event.lng) return;
        
        // V√©rifier si l'√©v√©nement r√©f√©rence ce booking (par ID, nom, ou organisateur)
        const eventReferencesBooking = 
          event.bookingIds?.includes(id) ||
          event.bookings?.some(b => b.id === id || b.name === item.name) ||
          event.organizerId === id ||
          (event.organizer && event.organizer.toLowerCase().includes((item.name || '').toLowerCase()));
        
        if (eventReferencesBooking) {
          currentUser.addresses.forEach((address, addrIndex) => {
            if (!address.lat || !address.lng) return;
            
            const distance = calculateDistance(address.lat, address.lng, event.lat, event.lng);
            
            if (distance <= 70) {
              const existingAlert = alerts.find(a => 
                a.eventId === event.id && a.likedItemId === id && a.likedItemType === 'booking' && a.addressIndex === addrIndex && a.alertType === 'artist_in_event'
              );
              
              if (!existingAlert) {
                alerts.push({
                  id: `proximity-event-${event.id}-booking-${id}-${addrIndex}-${Date.now()}`,
                  eventId: event.id,
                  eventTitle: event.title || 'Sans titre',
                  eventCity: event.city || '',
                  eventLat: event.lat,
                  eventLng: event.lng,
                  likedItemId: id,
                  likedItemType: 'booking',
                  likedItemTitle: item.name || 'Artiste',
                  addressIndex: addrIndex,
                  address: address.address || address.city || 'Adresse inconnue',
                  distance: Math.round(distance * 10) / 10,
                  emoji: 'üé§',
                  typeName: 'Artiste dans √©v√©nement',
                  alertType: 'artist_in_event',
                  message: `${item.name || 'Artiste'} se produit dans "${event.title || '√âv√©nement'}"`,
                  timestamp: new Date().toISOString()
                });
              }
            }
          });
        }
      });
    }
    
    // CAS 3: Service lik√© appara√Æt dans un √©v√©nement
    if (type === 'service' && item.lat && item.lng) {
      eventsData.forEach(event => {
        if (!event.lat || !event.lng) return;
        
        const eventReferencesService = 
          event.serviceIds?.includes(id) ||
          event.services?.some(s => s.id === id || s.name === item.name) ||
          (event.description && event.description.toLowerCase().includes((item.name || '').toLowerCase()));
        
        if (eventReferencesService) {
          currentUser.addresses.forEach((address, addrIndex) => {
            if (!address.lat || !address.lng) return;
            
            const distance = calculateDistance(address.lat, address.lng, event.lat, event.lng);
            
            if (distance <= 70) {
              const existingAlert = alerts.find(a => 
                a.eventId === event.id && a.likedItemId === id && a.likedItemType === 'service' && a.addressIndex === addrIndex && a.alertType === 'service_in_event'
              );
              
              if (!existingAlert) {
                alerts.push({
                  id: `proximity-event-${event.id}-service-${id}-${addrIndex}-${Date.now()}`,
                  eventId: event.id,
                  eventTitle: event.title || 'Sans titre',
                  eventCity: event.city || '',
                  eventLat: event.lat,
                  eventLng: event.lng,
                  likedItemId: id,
                  likedItemType: 'service',
                  likedItemTitle: item.name || 'Service',
                  addressIndex: addrIndex,
                  address: address.address || address.city || 'Adresse inconnue',
                  distance: Math.round(distance * 10) / 10,
                  emoji: 'üîß',
                  typeName: 'Service dans √©v√©nement',
                  alertType: 'service_in_event',
                  message: `${item.name || 'Service'} est utilis√© dans "${event.title || '√âv√©nement'}"`,
                  timestamp: new Date().toISOString()
                });
              }
            }
          });
        }
      });
    }
  });
  
  // Trier par distance (plus proche en premier)
  alerts.sort((a, b) => a.distance - b.distance);
  
  currentUser.proximityAlerts = alerts;
  updateProximityAlertsBadge();
  saveUser();
}

// Mettre √† jour le badge de notifications
function updateProximityAlertsBadge() {
  const alertsCount = currentUser.proximityAlerts?.length || 0;
  const badge = document.getElementById("alerts-count");
  if (badge) {
    if (alertsCount > 0) {
      badge.textContent = alertsCount > 99 ? '99+' : alertsCount;
      badge.style.display = 'flex';
    } else {
      badge.style.display = 'none';
    }
  }
}

// Fonction pour ouvrir les alertes sociales (alertes de proximit√©)
function openSocialAlertsModal() {
  if (!currentUser || !currentUser.isLoggedIn) {
    showNotification("‚ö†Ô∏è Vous devez √™tre connect√© pour voir vos alertes", "warning");
    openLoginModal();
    return;
  }
  // Ouvrir la vue des alertes de proximit√© (qui inclut les alertes sociales)
  openProximityAlertsView();
}
window.openSocialAlertsModal = openSocialAlertsModal;

// Ouvrir la vue des alertes de proximit√©
function openProximityAlertsView() {
  proximityAlertsViewOpen = true;
  refreshProximityAlertsView();
  
  // Si pas d'alertes, expliquer comment √ßa marche
  if (!currentUser || !currentUser.isLoggedIn) {
    showNotification("‚ö†Ô∏è Vous devez √™tre connect√© pour recevoir des alertes", "warning");
    openLoginModal();
    proximityAlertsViewOpen = false;
    return;
  }
}

// Fermer la vue des alertes de proximit√©
function closeProximityAlertsView() {
  proximityAlertsViewOpen = false;
  const alertsView = document.getElementById("proximity-alerts-view");
  if (alertsView) {
    alertsView.style.display = "none";
  }
}

// Rafra√Æchir la vue des alertes de proximit√©
function refreshProximityAlertsView() {
  let alertsView = document.getElementById("proximity-alerts-view");
  if (!alertsView) {
    alertsView = document.createElement("div");
    alertsView.id = "proximity-alerts-view";
    alertsView.style.cssText = "position:fixed;inset:0;z-index:1500;display:none;background:rgba(0,0,0,0.8);backdrop-filter:blur(4px);";
    document.body.appendChild(alertsView);
  }
  
  if (!proximityAlertsViewOpen) {
    alertsView.style.display = "none";
    return;
  }
  
  const alerts = currentUser.proximityAlerts || [];
  
  alertsView.innerHTML = `
    <div style="position:relative;width:100%;max-width:800px;height:100%;background:var(--ui-card-bg);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;margin:20px auto;">
      <!-- Header -->
      <div style="padding:20px;border-bottom:1px solid var(--ui-card-border);background:linear-gradient(135deg,#0f172a,#1e293b);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div>
            <h2 style="margin:0;font-size:24px;font-weight:700;color:#fff;">üîî Alertes de proximit√©</h2>
            <p style="margin:4px 0 0;font-size:13px;color:rgba(255,255,255,0.7);">${alerts.length} alerte${alerts.length > 1 ? 's' : ''} dans un rayon de 70 km</p>
          </div>
          <button onclick="closeProximityAlertsView()" style="width:40px;height:40px;border-radius:50%;border:none;background:rgba(255,255,255,0.1);color:#fff;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;">‚úï</button>
        </div>
        
        <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:10px;padding:12px;">
          <div style="font-size:12px;color:#3b82f6;line-height:1.6;">
            üí° Vous recevez des alertes quand un <strong>booking, service, organisateur ou √©v√©nement</strong> que vous avez <strong>lik√©</strong> se trouve √† moins de <strong>70 km</strong> de l'une de vos adresses.
          </div>
        </div>
      </div>
      
      <!-- Liste des alertes -->
      <div style="flex:1;overflow-y:auto;padding:20px;">
        ${alerts.length === 0 ? `
          <div style="text-align:center;padding:40px 20px;color:var(--ui-text-muted);">
            <div style="font-size:64px;margin-bottom:16px;">üîî</div>
            <h3 style="font-size:18px;font-weight:700;color:#fff;margin-bottom:12px;">Comment fonctionnent les alertes ?</h3>
            <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:16px;margin:20px 0;text-align:left;">
              <p style="font-size:14px;color:#fff;margin:0 0 12px 0;line-height:1.6;">
                <strong style="color:#3b82f6;">1. Ajoutez des favoris</strong><br>
                Likez des √©v√©nements, bookings, services ou organisateurs qui vous int√©ressent.
              </p>
              <p style="font-size:14px;color:#fff;margin:0 0 12px 0;line-height:1.6;">
                <strong style="color:#3b82f6;">2. Configurez vos adresses</strong><br>
                Ajoutez jusqu'√† 2 adresses dans votre profil pour d√©finir votre zone de proximit√©.
              </p>
              <p style="font-size:14px;color:#fff;margin:0;line-height:1.6;">
                <strong style="color:#3b82f6;">3. Recevez des alertes</strong><br>
                Quand un favori se trouve √† moins de 70 km d'une de vos adresses, vous recevez une alerte ici !
              </p>
            </div>
            <p style="font-size:13px;margin:16px 0 0;color:var(--ui-text-muted);">Les alertes appara√Ætront ici quand vos favoris seront √† proximit√©</p>
          </div>
        ` : `
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;">
            ${alerts.map(alert => `
              <div onclick="openItemFromProximityAlert('${alert.itemType}', ${alert.itemId})" style="background:rgba(15,23,42,0.5);border:1px solid var(--ui-card-border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='#3b82f6';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--ui-card-border)';this.style.transform='translateY(0)'">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                  <span style="font-size:24px;">${alert.emoji}</span>
                  <div style="flex:1;">
                    <div style="font-size:14px;font-weight:600;color:#fff;margin-bottom:4px;">${escapeHtml(alert.itemTitle)}</div>
                    <div style="font-size:12px;color:var(--ui-text-muted);">${alert.typeName}</div>
                  </div>
                </div>
                <div style="background:rgba(59,130,246,0.1);border-radius:8px;padding:8px;margin-bottom:8px;">
                  <div style="font-size:12px;color:#3b82f6;font-weight:600;">üìç √Ä ${alert.distance} km</div>
                  <div style="font-size:11px;color:var(--ui-text-muted);margin-top:4px;">de ${escapeHtml(alert.address)}</div>
                </div>
                <div style="font-size:11px;color:var(--ui-text-muted);">
                  üìç ${escapeHtml(alert.itemCity)}
                </div>
                <button onclick="event.stopPropagation();removeProximityAlert('${alert.id}')" style="margin-top:12px;width:100%;padding:8px;border-radius:8px;border:1px solid rgba(239,68,68,0.5);background:rgba(239,68,68,0.1);color:#ef4444;cursor:pointer;font-size:12px;font-weight:600;">
                  ‚úï Marquer comme lue
                </button>
              </div>
            `).join('')}
          </div>
        `}
      </div>
    </div>
  `;
  
  alertsView.style.display = "flex";
}

// Ouvrir un item depuis une alerte de proximit√©
function openItemFromProximityAlert(type, id) {
  closeProximityAlertsView();
  setTimeout(() => {
    openPopupFromList(type, id);
  }, 300);
}

// Supprimer une alerte de proximit√©
function removeProximityAlert(alertId) {
  currentUser.proximityAlerts = currentUser.proximityAlerts.filter(a => a.id !== alertId);
  saveUser();
  updateProximityAlertsBadge();
  refreshProximityAlertsView();
}

// Exposer les fonctions d'alertes de proximit√© globalement
window.openProximityAlertsView = openProximityAlertsView;
window.closeProximityAlertsView = closeProximityAlertsView;
window.removeProximityAlert = removeProximityAlert;
window.openItemFromProximityAlert = openItemFromProximityAlert;

// BLOC ALERTES - INTERFACE SIMILAIRE √Ä EVENT LIST
// ============================================

function openAlertsView() {
  alertsViewOpen = true;
  refreshAlertsView();
}

function closeAlertsView() {
  alertsViewOpen = false;
  const alertsView = document.getElementById("alerts-view");
  if (alertsView) {
    alertsView.style.display = "none";
  }
}

function refreshAlertsView() {
  const alertsView = document.getElementById("alerts-view");
  if (!alertsView) {
    // Cr√©er le bloc Alertes s'il n'existe pas
    createAlertsViewElement();
    return;
  }

  if (!alertsViewOpen) {
    alertsView.style.display = "none";
    return;
  }

  // Filtrer les alertes actives (non supprim√©es)
  const activeAlerts = currentUser.alerts.filter(a => a.status !== 'deleted');
  const visibleAlerts = activeAlerts.filter(a => !a.isBlurred);
  const blurredAlerts = activeAlerts.filter(a => a.isBlurred);
  const alertLimit = getAlertLimit();
  
  // Trier par date de cr√©ation (plus r√©centes en premier)
  activeAlerts.sort((a, b) => new Date(b.creationDate) - new Date(a.creationDate));
  
  // Afficher un message si limite atteinte
  const limitMessage = alertLimit !== Infinity && visibleAlerts.length >= alertLimit
    ? `<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:12px;margin-bottom:16px;text-align:center;">
         <div style="font-weight:700;font-size:14px;color:#ef4444;margin-bottom:4px;">‚ö†Ô∏è Limite atteinte (${visibleAlerts.length}/${alertLimit})</div>
         <div style="font-size:12px;color:rgba(255,255,255,0.7);">Les nouvelles alertes seront flout√©es. Effacez une alerte pour en afficher une nouvelle.</div>
       </div>`
    : '';

  alertsView.style.display = "block";
  alertsView.innerHTML = `
    <div style="position:relative;width:100%;height:100%;background:var(--ui-card-bg);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;">
      <!-- Header -->
      <div style="padding:20px;border-bottom:1px solid var(--ui-card-border);background:linear-gradient(135deg,#0f172a,#1e293b);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div>
            <h2 style="margin:0;font-size:24px;font-weight:700;color:#fff;">üîî Mes Alertes</h2>
            <p style="margin:4px 0 0;font-size:13px;color:rgba(255,255,255,0.7);">${visibleAlerts.length} visible${visibleAlerts.length > 1 ? 's' : ''}${blurredAlerts.length > 0 ? ` ‚Ä¢ ${blurredAlerts.length} flout√©e${blurredAlerts.length > 1 ? 's' : ''}` : ''}</p>
          </div>
          <button onclick="closeAlertsView()" style="width:40px;height:40px;border-radius:50%;border:none;background:rgba(255,255,255,0.1);color:#fff;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;">‚úï</button>
        </div>
        
        <!-- Bouton Ajouter Alarme -->
        <button onclick="openAddAlarmModal('alerts')" style="width:100%;padding:12px;border-radius:12px;border:2px solid #3b82f6;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:12px;">
          <span>‚è∞</span>
          <span>Ajouter alarme</span>
        </button>
        
        ${limitMessage}
      </div>
      
      <!-- Info alertes gratuites -->
      <div style="margin:12px 20px 0;padding:12px 16px;background:linear-gradient(135deg,rgba(0,255,195,0.1),rgba(34,197,94,0.1));border:1px solid rgba(0,255,195,0.3);border-radius:10px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="font-size:20px;">üÜì</span>
          <div>
            <div style="font-size:13px;font-weight:600;color:#00ffc3;">Alertes de statut : GRATUITES & ILLIMIT√âES</div>
            <div style="font-size:11px;color:var(--ui-text-muted);">Annulation, complet, report√©... Vous serez toujours inform√© gratuitement pour vos √©v√©nements en agenda.</div>
          </div>
        </div>
      </div>
      
      <!-- Liste des alertes -->
      <div id="alerts-list-container" style="flex:1;overflow-y:auto;padding:20px;">
        ${activeAlerts.length === 0 ? `
          <div style="text-align:center;padding:40px 20px;color:var(--ui-text-muted);">
            <div style="font-size:64px;margin-bottom:16px;">üîî</div>
            <p style="font-size:16px;margin:0;">Les alertes arriveront ici</p>
            <p style="font-size:13px;margin:8px 0 0;color:var(--ui-text-muted);">selon vos likes et votre agenda</p>
            <p style="font-size:12px;margin:16px 0 0;padding:10px;background:rgba(0,255,195,0.1);border-radius:8px;color:#00ffc3;">
              üíö Si un event de votre agenda est annul√©, complet ou report√©,<br>vous recevrez une alerte <strong>gratuite et illimit√©e</strong> !
            </p>
          </div>
        ` : `
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;">
            ${activeAlerts.map((alert, index) => buildAlertCard(alert, index)).join('')}
          </div>
        `}
      </div>
    </div>
  `;

  // Restaurer la position de scroll
  const container = document.getElementById("alerts-list-container");
  if (container && alertsScrollPosition > 0) {
    container.scrollTop = alertsScrollPosition;
  }

  // Restaurer la s√©lection
  if (selectedAlertId) {
    const selectedCard = alertsView.querySelector(`[data-alert-id="${selectedAlertId}"]`);
    if (selectedCard) {
      selectedCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
}

function createAlertsViewElement() {
  let alertsView = document.getElementById("alerts-view");
  if (!alertsView) {
    alertsView = document.createElement("div");
    alertsView.id = "alerts-view";
    alertsView.style.cssText = "position:fixed;inset:0;z-index:1500;display:none;";
    document.body.appendChild(alertsView);
  }
  refreshAlertsView();
}

function buildAlertCard(alert, index) {
  const event = eventsData.find(e => e.id.toString() === alert.eventId);
  const isNew = alert.status === 'new';
  const isBlurred = alert.isBlurred || false;
  const hasAlarm = currentUserAlarms.some(a => a.alertId === alert.id && !isBlurred);
  const alertLimit = getAlertLimit();
  const activeAlerts = currentUser.alerts.filter(a => a.status !== 'deleted' && !a.isBlurred);
  const canDelete = isBlurred || (alertLimit !== Infinity && activeAlerts.length > alertLimit);
  
  return `
    <div data-alert-id="${alert.id}" class="alert-card" style="
      border:2px solid ${isBlurred ? '#ef4444' : isNew ? '#3b82f6' : 'var(--ui-card-border)'};
      border-radius:16px;
      background:${isBlurred ? 'rgba(239,68,68,0.1)' : isNew ? 'rgba(59,130,246,0.1)' : 'var(--ui-card-bg)'};
      overflow:hidden;
      cursor:${isBlurred ? 'default' : 'pointer'};
      transition:all 0.2s ease;
      box-shadow:0 4px 20px rgba(0,0,0,0.2);
      position:relative;
      filter:${isBlurred ? 'blur(3px)' : 'none'};
      opacity:${isBlurred ? '0.6' : '1'};
    " ${!isBlurred ? `onclick="openEventFromAlert('${alert.eventId}', '${alert.id}')"` : ''}>
      ${isNew && !isBlurred ? '<div style="position:absolute;top:8px;right:8px;width:12px;height:12px;border-radius:50%;background:#3b82f6;box-shadow:0 0 8px rgba(59,130,246,0.8);"></div>' : ''}
      ${isBlurred ? '<div style="position:absolute;top:8px;right:8px;width:32px;height:32px;border-radius:50%;background:rgba(239,68,68,0.9);display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff;box-shadow:0 2px 8px rgba(239,68,68,0.4);">üîí</div>' : ''}
      ${hasAlarm && !isBlurred ? '<div style="position:absolute;top:8px;left:8px;width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#f59e0b,#d97706);display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 8px rgba(245,158,11,0.4);">‚è∞</div>' : ''}
      
      <div style="padding:16px;position:relative;">
        ${isBlurred ? `
          <div style="position:absolute;inset:0;background:rgba(0,0,0,0.3);border-radius:12px;display:flex;align-items:center;justify-content:center;z-index:10;">
            <div style="text-align:center;padding:20px;">
              <div style="font-size:32px;margin-bottom:8px;">üîí</div>
              <div style="font-weight:700;font-size:14px;color:#fff;margin-bottom:4px;">Alerte flout√©e</div>
              <div style="font-size:12px;color:rgba(255,255,255,0.8);">Limite atteinte (${activeAlerts.length}/${alertLimit})</div>
              <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-top:8px;">Effacez une alerte pour afficher celle-ci</div>
            </div>
          </div>
        ` : ''}
        
        <div style="display:flex;align-items:start;gap:12px;margin-bottom:12px;">
          <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#3b82f6,#2563eb);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">
            ${getFavoriteEmoji(alert.favoriteMode)}
          </div>
          <div style="flex:1;">
            <div style="font-weight:700;font-size:15px;margin-bottom:4px;color:#fff;">
              ${escapeHtml(alert.favoriteName)}
            </div>
            <div style="font-size:12px;color:rgba(255,255,255,0.6);">
              ${alert.favoriteMode === 'event' ? '√âv√©nement' : alert.favoriteMode === 'booking' ? 'Booking' : alert.favoriteMode === 'service' ? 'Service' : 'Avatar'}
            </div>
          </div>
          ${canDelete ? `
            <button onclick="event.stopPropagation();deleteAlertWithWarning('${alert.id}')" style="width:32px;height:32px;border-radius:50%;border:none;background:rgba(239,68,68,0.2);color:#ef4444;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;flex-shrink:0;" title="Supprimer l'alerte">
              üóëÔ∏è
            </button>
          ` : ''}
        </div>
        
        <div style="background:rgba(0,255,195,0.1);border:1px solid rgba(0,255,195,0.3);border-radius:8px;padding:12px;margin-bottom:12px;">
          <div style="font-size:11px;color:rgba(0,255,195,0.8);margin-bottom:4px;text-transform:uppercase;font-weight:600;">Appara√Æt dans</div>
          <div style="font-weight:600;font-size:14px;color:#00ffc3;margin-bottom:4px;">
            ${escapeHtml(alert.eventTitle || '√âv√©nement')}
          </div>
          ${alert.eventDate ? `<div style="font-size:12px;color:rgba(0,255,195,0.7);">üìÖ ${formatEventDateRange(alert.eventDate, alert.eventDate)}</div>` : ''}
        </div>
        
        <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--ui-text-muted);">
          ${alert.distanceToUser ? `<span>üìç ${alert.distanceToUser} km de chez vous</span>` : alert.distance ? `<span>üìç ${alert.distance} km</span>` : '<span></span>'}
          <span>${new Date(alert.creationDate).toLocaleDateString('fr-CH', {day:'2-digit', month:'2-digit'})}</span>
        </div>
      </div>
    </div>
  `;
}

function openEventFromAlert(eventId, alertId) {
  selectedAlertId = alertId;
  
  // Sauvegarder la position de scroll
  const container = document.getElementById("alerts-list-container");
  if (container) {
    alertsScrollPosition = container.scrollTop;
  }
  
  // Trouver l'√©v√©nement
  const event = eventsData.find(e => e.id.toString() === eventId);
  if (!event) {
    showNotification("‚ö†Ô∏è √âv√©nement introuvable", "error");
    return;
  }
  
  // Marquer l'alerte comme vue
  markAlertAsSeen(alertId);
  
  // Ouvrir la popup de l'√©v√©nement
  openPopupFromList('event', parseInt(eventId));
  
  // Quand on ferme la popup, revenir aux alertes
  setTimeout(() => {
    const backdrop = document.getElementById("popup-modal-backdrop");
    if (backdrop) {
      const originalClose = backdrop.onclick;
      backdrop.onclick = (e) => {
        if (e.target === backdrop) {
          closePopupModal();
          setTimeout(() => {
            refreshAlertsView();
          }, 300);
        }
      };
    }
  }, 100);
}

function markAlertAsSeen(alertId) {
  const alert = currentUser.alerts.find(a => a.id === alertId);
  if (alert && alert.status === 'new') {
    alert.status = 'seen';
    alert.seenAt = new Date().toISOString();
    
    // Sauvegarder dans le backend
    fetch(`${window.API_BASE_URL}/user/alerts/seen`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id.toString(),
        alertId: alertId
      })
    }).catch(err => console.error('Erreur marquage alerte vue:', err));
  }
}

function deleteAlertWithWarning(alertId) {
  const alert = currentUser.alerts.find(a => a.id === alertId);
  if (!alert) return;
  
  const isBlurred = alert.isBlurred || false;
  const alertLimit = getAlertLimit();
  const activeAlerts = currentUser.alerts.filter(a => a.status !== 'deleted' && !a.isBlurred);
  
  // Avertissement si alerte flout√©e
  if (isBlurred) {
    const confirmMessage = `‚ö†Ô∏è Attention : Cette alerte est flout√©e.\n\n` +
      `Limite atteinte (${activeAlerts.length}/${alertLimit}).\n\n` +
      `Notez bien les informations avant d'effacer, car vous ne pourrez plus les voir !\n\n` +
      `Voulez-vous vraiment supprimer cette alerte ?`;
    
    if (!confirm(confirmMessage)) {
      return;
    }
  }
  
  // Supprimer l'alerte
  alert.status = 'deleted';
  
  // Supprimer les alarmes associ√©es
  currentUserAlarms = currentUserAlarms.filter(a => a.alertId !== alertId);
  
  // Sauvegarder dans le backend
  fetch(`${window.API_BASE_URL}/user/alerts`, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      userId: currentUser.id.toString(),
      alertId: alertId
    })
  }).catch(err => console.error('Erreur suppression alerte:', err));
  
  // Si l'alerte √©tait flout√©e, v√©rifier s'il faut d√©flouter d'autres alertes
  if (isBlurred && alertLimit !== Infinity) {
    const remainingBlurred = currentUser.alerts.filter(a => a.status !== 'deleted' && a.isBlurred);
    if (remainingBlurred.length > 0 && activeAlerts.length < alertLimit) {
      // D√©flouter la premi√®re alerte flout√©e
      const toUnblur = remainingBlurred[0];
      toUnblur.isBlurred = false;
      showNotification(`‚úÖ Alerte "${toUnblur.eventTitle}" est maintenant visible !`, "success");
    }
  }
  
  refreshAlertsView();
  showNotification("‚úÖ Alerte supprim√©e", "success");
}

// ============================================
// SYST√àME D'ALARMES
// ============================================

function openAddAlarmModal(context) {
  // context = 'alerts' ou 'agenda'
  const items = context === 'alerts' 
    ? currentUser.alerts.filter(a => a.status !== 'deleted')
    : currentUser.agenda.map(key => {
        const [type, id] = key.split(':');
        const data = type === 'event' ? eventsData : type === 'booking' ? bookingsData : servicesData;
        const item = data.find(i => i.id === parseInt(id));
        if (item && type === 'event') {
          return {
            id: `agenda-${key}`,
            eventId: id,
            eventTitle: item.title,
            eventDate: item.startDate || item.date,
            type: 'agenda'
          };
        }
        return null;
      }).filter(Boolean);

  if (items.length === 0) {
    showNotification("‚ö†Ô∏è Aucun √©l√©ment disponible pour ajouter une alarme", "warning");
    return;
  }

  const selectedItems = [];
  const maxSelections = 3;

  const html = `
    <div style="position:relative;width:100%;max-width:600px;background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:20px;border:2px solid #f59e0b;box-shadow:0 20px 60px rgba(245,158,11,0.3);overflow:hidden;">
      <div style="background:linear-gradient(135deg,#f59e0b,#d97706);padding:20px;text-align:center;">
        <div style="font-size:32px;margin-bottom:8px;">‚è∞</div>
        <h2 style="margin:0;font-size:22px;font-weight:700;color:#fff;">Ajouter une alarme</h2>
        <p style="margin:8px 0 0;font-size:14px;color:rgba(255,255,255,0.9);">S√©lectionnez jusqu'√† ${maxSelections} √©l√©ment${maxSelections > 1 ? 's' : ''}</p>
      </div>
      
      <div style="padding:20px;max-height:400px;overflow-y:auto;">
        <div style="font-size:14px;font-weight:600;color:#fff;margin-bottom:12px;">S√©lectionner des √©l√©ments :</div>
        <div style="display:grid;gap:8px;">
          ${items.map(item => {
            const itemId = item.id || `item-${item.eventId}`;
            const isSelected = selectedItems.includes(itemId);
            return `
              <div data-item-id="${itemId}" onclick="toggleAlarmItemSelection('${itemId}', '${context}')" style="
                padding:12px;
                border-radius:12px;
                border:2px solid ${isSelected ? '#f59e0b' : 'rgba(255,255,255,0.1)'};
                background:${isSelected ? 'rgba(245,158,11,0.2)' : 'rgba(255,255,255,0.05)'};
                cursor:pointer;
                transition:all 0.2s;
                display:flex;
                align-items:center;
                gap:12px;
              ">
                <div style="width:24px;height:24px;border-radius:50%;border:2px solid ${isSelected ? '#f59e0b' : 'rgba(255,255,255,0.3)'};background:${isSelected ? '#f59e0b' : 'transparent'};display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                  ${isSelected ? '‚úì' : ''}
                </div>
                <div style="flex:1;">
                  <div style="font-weight:600;font-size:14px;color:#fff;">
                    ${escapeHtml(item.eventTitle || item.favoriteName || '√âl√©ment')}
                  </div>
                  ${item.eventDate ? `<div style="font-size:12px;color:rgba(255,255,255,0.6);">üìÖ ${formatEventDateRange(item.eventDate, item.eventDate)}</div>` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
        
        <div style="margin-top:20px;padding:16px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:12px;">
          <div style="font-size:14px;font-weight:600;color:#f59e0b;margin-bottom:12px;">Configuration de l'alarme :</div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
            <div>
              <label style="display:block;font-size:12px;color:rgba(255,255,255,0.7);margin-bottom:6px;">Temps avant</label>
              <input type="number" id="alarm-time-value" min="1" value="1" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:#fff;font-size:14px;">
            </div>
            <div>
              <label style="display:block;font-size:12px;color:rgba(255,255,255,0.7);margin-bottom:6px;">Unit√©</label>
              <select id="alarm-time-unit" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:#fff;font-size:14px;">
                <option value="hours">Heures</option>
                <option value="days" selected>Jours</option>
                <option value="weeks">Semaines</option>
              </select>
            </div>
          </div>
          
          <div style="font-size:12px;color:rgba(255,255,255,0.6);">
            Exemple : 1 jour avant = l'alarme sonnera 1 jour avant l'√©v√©nement
          </div>
        </div>
      </div>
      
      <div style="padding:20px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:12px;">
        <button onclick="closeAddAlarmModal()" style="flex:1;padding:14px;border-radius:12px;border:none;background:rgba(255,255,255,0.1);color:#fff;font-weight:600;cursor:pointer;">Annuler</button>
        <button onclick="saveAlarm('${context}')" style="flex:1;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;font-weight:600;cursor:pointer;">
          Enregistrer (${selectedItems.length}/${maxSelections})
        </button>
      </div>
    </div>
  `;

  // Cr√©er ou r√©utiliser le backdrop
  let backdrop = document.getElementById("add-alarm-modal-backdrop");
  if (!backdrop) {
    backdrop = document.createElement("div");
    backdrop.id = "add-alarm-modal-backdrop";
    backdrop.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(10px);";
    backdrop.onclick = (e) => {
      if (e.target === backdrop) closeAddAlarmModal();
    };
    document.body.appendChild(backdrop);
  }
  
  backdrop.innerHTML = html;
  backdrop.style.display = "flex";
  
  // Stocker le contexte et les items s√©lectionn√©s
  backdrop.dataset.context = context;
  backdrop.dataset.selectedItems = JSON.stringify([]);
}

function toggleAlarmItemSelection(itemId, context) {
  const backdrop = document.getElementById("add-alarm-modal-backdrop");
  if (!backdrop) return;
  
  const selectedItems = JSON.parse(backdrop.dataset.selectedItems || '[]');
  const maxSelections = 3;
  
  const index = selectedItems.indexOf(itemId);
  if (index > -1) {
    selectedItems.splice(index, 1);
  } else {
    if (selectedItems.length >= maxSelections) {
      showNotification(`‚ö†Ô∏è Maximum ${maxSelections} s√©lections autoris√©es`, "warning");
      return;
    }
    selectedItems.push(itemId);
  }
  
  backdrop.dataset.selectedItems = JSON.stringify(selectedItems);
  
  // Mettre √† jour l'affichage
  const item = backdrop.querySelector(`[data-item-id="${itemId}"]`);
  if (item) {
    const isSelected = selectedItems.includes(itemId);
    item.style.border = `2px solid ${isSelected ? '#f59e0b' : 'rgba(255,255,255,0.1)'}`;
    item.style.background = isSelected ? 'rgba(245,158,11,0.2)' : 'rgba(255,255,255,0.05)';
    const checkbox = item.querySelector('div:first-child');
    if (checkbox) {
      checkbox.style.border = `2px solid ${isSelected ? '#f59e0b' : 'rgba(255,255,255,0.3)'}`;
      checkbox.style.background = isSelected ? '#f59e0b' : 'transparent';
      checkbox.innerHTML = isSelected ? '‚úì' : '';
    }
  }
  
  // Mettre √† jour le bouton
  const saveBtn = backdrop.querySelector('button:last-child');
  if (saveBtn) {
    saveBtn.innerHTML = `Enregistrer (${selectedItems.length}/${maxSelections})`;
    saveBtn.disabled = selectedItems.length === 0;
    saveBtn.style.opacity = selectedItems.length === 0 ? '0.5' : '1';
  }
}

function saveAlarm(context) {
  const backdrop = document.getElementById("add-alarm-modal-backdrop");
  if (!backdrop) return;
  
  const selectedItems = JSON.parse(backdrop.dataset.selectedItems || '[]');
  if (selectedItems.length === 0) {
    showNotification("‚ö†Ô∏è Veuillez s√©lectionner au moins un √©l√©ment", "warning");
    return;
  }
  
  const timeValue = parseInt(document.getElementById("alarm-time-value").value) || 1;
  const timeUnit = document.getElementById("alarm-time-unit").value;
  
  // Cr√©er les alarmes
  const items = context === 'alerts' 
    ? currentUser.alerts.filter(a => a.status !== 'deleted')
    : currentUser.agenda.map(key => {
        const [type, id] = key.split(':');
        const data = type === 'event' ? eventsData : type === 'booking' ? bookingsData : servicesData;
        const item = data.find(i => i.id === parseInt(id));
        if (item && type === 'event') {
          return {
            id: `agenda-${key}`,
            alertId: `agenda-${key}`,
            eventId: id,
            eventTitle: item.title,
            eventDate: item.startDate || item.date,
            type: 'agenda'
          };
        }
        return null;
      }).filter(Boolean);
  
  selectedItems.forEach(itemId => {
    const item = items.find(i => (i.id || `item-${i.eventId}`) === itemId);
    if (item) {
      // ‚úÖ V√©rifier si l'alerte correspondante est flout√©e (pour les alertes)
      if (context === 'alerts') {
        const alert = currentUser.alerts.find(a => a.id === (item.id || item.alertId));
        if (alert && alert.isBlurred) {
          showNotification("‚ö†Ô∏è Impossible d'ajouter une alarme √† une alerte flout√©e. Effacez une alerte pour la rendre visible.", "warning");
          return;
        }
      }
      
      const alarm = {
        id: `alarm-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        alertId: item.id || item.alertId || `agenda-${item.eventId}`,
        eventId: item.eventId || item.id,
        favoriteId: item.favoriteId,
        favoriteName: item.favoriteName || item.eventTitle,
        favoriteMode: item.favoriteMode || 'event',
        timeBefore: {
          value: timeValue,
          unit: timeUnit
        },
        notificationMethod: currentUser.notificationPreferences.email && currentUser.notificationPreferences.sms ? 'both' : 
                           currentUser.notificationPreferences.email ? 'email' : 
                           currentUser.notificationPreferences.sms ? 'sms' : 'email',
        createdAt: new Date().toISOString()
      };
      
      if (context === 'alerts') {
        currentUserAlarms.push(alarm);
      } else {
        alarmsForAgenda.push(alarm);
      }
    }
  });
  
  showNotification(`‚úÖ ${selectedItems.length} alarme${selectedItems.length > 1 ? 's' : ''} ajout√©e${selectedItems.length > 1 ? 's' : ''} !`, "success");
  closeAddAlarmModal();
  
  if (context === 'alerts') {
    refreshAlertsView();
  } else {
    // Rafra√Æchir la vue agenda si elle existe
    if (typeof refreshAgendaView === 'function') {
      refreshAgendaView();
    }
  }
}

function closeAddAlarmModal() {
  const backdrop = document.getElementById("add-alarm-modal-backdrop");
  if (backdrop) {
    backdrop.style.display = "none";
  }
}

// ============================================
// V√âRIFICATION ET D√âCLENCHEMENT DES ALARMES
// ============================================

// Stocker les alarmes d√©j√† d√©clench√©es pour √©viter les doublons
let triggeredAlarms = new Set();

function checkAndTriggerAlarms() {
  if (!isLoggedIn()) return;
  
  const now = new Date();
  const allAlarms = [...currentUserAlarms, ...alarmsForAgenda];
  
  allAlarms.forEach(alarm => {
    // V√©rifier si l'alarme a d√©j√† √©t√© d√©clench√©e
    if (triggeredAlarms.has(alarm.id)) return;
    
    // Trouver l'√©v√©nement associ√©
    const event = eventsData.find(e => e.id.toString() === alarm.eventId);
    if (!event) return;
    
    // Obtenir la date de l'√©v√©nement
    const eventDate = new Date(event.startDate || event.date);
    if (isNaN(eventDate.getTime())) return; // Date invalide
    
    // Calculer le temps avant l'√©v√©nement
    const timeDiff = eventDate.getTime() - now.getTime();
    const timeDiffMs = timeDiff;
    
    // Convertir le timeBefore en millisecondes
    let timeBeforeMs = 0;
    const { value, unit } = alarm.timeBefore || { value: 1, unit: 'days' };
    
    switch(unit) {
      case 'hours':
        timeBeforeMs = value * 60 * 60 * 1000;
        break;
      case 'days':
        timeBeforeMs = value * 24 * 60 * 60 * 1000;
        break;
      case 'weeks':
        timeBeforeMs = value * 7 * 24 * 60 * 60 * 1000;
        break;
      default:
        timeBeforeMs = value * 24 * 60 * 60 * 1000; // Par d√©faut en jours
    }
    
    // V√©rifier si on est dans la fen√™tre de d√©clenchement (entre timeBefore et timeBefore - 1h)
    // Cela permet d'√©viter de d√©clencher plusieurs fois la m√™me alarme
    const oneHourMs = 60 * 60 * 1000;
    const isInWindow = timeDiffMs <= timeBeforeMs && timeDiffMs > (timeBeforeMs - oneHourMs);
    
    if (isInWindow) {
      triggerAlarm(alarm, event);
      triggeredAlarms.add(alarm.id);
    }
  });
}

function triggerAlarm(alarm, event) {
  const { notificationMethod } = alarm;
  
  // Pr√©parer le message
  const eventTitle = event.title || '√âv√©nement';
  const eventDate = new Date(event.startDate || event.date);
  const dateStr = eventDate.toLocaleDateString('fr-CH', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  const favoriteName = alarm.favoriteName || 'Votre favori';
  const { value, unit } = alarm.timeBefore || { value: 1, unit: 'days' };
  const unitText = unit === 'hours' ? 'heure(s)' : unit === 'days' ? 'jour(s)' : 'semaine(s)';
  
  const message = `‚è∞ Alarme : ${favoriteName} appara√Æt dans "${eventTitle}"\n\n` +
    `üìÖ Date : ${dateStr}\n` +
    `üìç Lieu : ${event.location || event.city || 'Lieu √† confirmer'}\n\n` +
    `Cette alarme a √©t√© configur√©e pour ${value} ${unitText} avant l'√©v√©nement.`;
  
  // Envoyer les notifications selon les pr√©f√©rences
  if (notificationMethod === 'email' || notificationMethod === 'both') {
    sendEmailNotification(currentUser.email, `Alarme MapEventAI : ${eventTitle}`, message);
    currentUser.emailNotifications++;
  }
  
  if (notificationMethod === 'sms' || notificationMethod === 'both') {
    if (canSendSMS()) {
      sendSMSNotification(currentUser.phone || '', message);
      updateSmsCount();
      currentUser.smsNotifications++;
    } else {
      // Si limite SMS atteinte, envoyer par email √† la place
      if (!currentUser.notificationPreferences.email) {
        showNotification(`‚ö†Ô∏è Limite SMS atteinte. Alarme envoy√©e par email.`, "warning");
      }
      sendEmailNotification(currentUser.email, `Alarme MapEventAI : ${eventTitle}`, message);
      currentUser.emailNotifications++;
    }
  }
  
  // Afficher une notification dans l'interface
  showNotification(`‚è∞ Alarme : ${eventTitle} dans ${value} ${unitText} !`, "info");
  
  // Notification push pour smartphone (si l'utilisateur a autoris√©)
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(`‚è∞ Alarme MapEvent`, {
      body: `${favoriteName} appara√Æt dans "${eventTitle}"\n${dateStr}\nüìç ${event.location || event.city || 'Lieu √† confirmer'}`,
      icon: '/favicon.ico',
      badge: '/favicon.ico',
      tag: `alarm-${alarm.id}`,
      requireInteraction: false,
      silent: false
    });
  } else if ('Notification' in window && Notification.permission === 'default') {
    // Demander la permission pour les notifications push
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        new Notification(`‚è∞ Alarme MapEvent`, {
          body: `${favoriteName} appara√Æt dans "${eventTitle}"\n${dateStr}\nüìç ${event.location || event.city || 'Lieu √† confirmer'}`,
          icon: '/favicon.ico',
          badge: '/favicon.ico',
          tag: `alarm-${alarm.id}`,
          requireInteraction: false,
          silent: false
        });
      }
    });
  }
  
  // Sauvegarder les pr√©f√©rences mises √† jour
  try {
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
  } catch (e) {
    console.error('Erreur sauvegarde utilisateur:', e);
  }
}

// Simuler l'envoi d'email (√† remplacer par un vrai service d'email)
function sendEmailNotification(email, subject, message) {
  console.log(`üìß Email envoy√© √† ${email}`);
  console.log(`Sujet: ${subject}`);
  console.log(`Message: ${message}`);
  
  // TODO: Int√©grer un service d'email (SendGrid, AWS SES, etc.)
  // Pour l'instant, on simule juste
}

// Simuler l'envoi de SMS (√† remplacer par un vrai service SMS)
function sendSMSNotification(phone, message) {
  console.log(`üì± SMS envoy√© √† ${phone}`);
  console.log(`Message: ${message}`);
  
  // TODO: Int√©grer un service SMS (Twilio, AWS SNS, etc.)
  // Pour l'instant, on simule juste
}

function updateSmsCount() {
  const limit = getSMSLimit();
  
  // R√©initialiser le compteur au d√©but du mois
  const now = new Date();
  const lastReset = new Date(currentUser.smsResetDate || 0);
  const isNewMonth = now.getMonth() !== lastReset.getMonth() || now.getFullYear() !== lastReset.getFullYear();
  
  if (isNewMonth) {
    currentUser.smsNotifications = 0;
    currentUser.smsResetDate = now.toISOString();
  }
  
  // V√©rifier si la limite est atteinte
  if (limit !== Infinity && currentUser.smsNotifications >= limit) {
    // D√©sactiver les notifications SMS si la limite est atteinte
    if (currentUser.notificationPreferences.sms) {
      currentUser.notificationPreferences.sms = false;
      showNotification(`‚ö†Ô∏è Limite SMS mensuelle atteinte (${limit}). Les alarmes seront envoy√©es par email uniquement.`, "warning");
    }
  }
  
  // Sauvegarder
  try {
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
  } catch (e) {
    console.error('Erreur sauvegarde compteur SMS:', e);
  }
}

// V√©rifier les alarmes p√©riodiquement (toutes les heures)
function startAlarmChecker() {
  // V√©rifier imm√©diatement
  checkAndTriggerAlarms();
  
  // Puis toutes les heures
  setInterval(() => {
    checkAndTriggerAlarms();
  }, 60 * 60 * 1000); // 1 heure
}

// D√©marrer le v√©rificateur d'alarmes au chargement
// ET charger l'utilisateur depuis /api/user/me (source de v√©rit√©)
if (typeof window !== 'undefined') {
  window.addEventListener('load', () => {
    // PRIORIT√â 1: Charger l'utilisateur depuis /api/user/me (source de v√©rit√©)
    // Ne pas faire confiance √† localStorage.currentUser
    loadCurrentUserFromAPI().then(user => {
      if (user) {
        console.log('[AUTH] Utilisateur charg√© au d√©marrage depuis /api/user/me:', user.email);
        // Mettre √† jour le bloc compte
        if (typeof updateAccountBlockLegitimately === 'function') {
          setTimeout(() => updateAccountBlockLegitimately(), 100);
        }
        
        // IMPORTANT: Ne JAMAIS afficher l'onboarding apr√®s reconnexion
        // L'onboarding est demand√© UNIQUEMENT lors de la premi√®re cr√©ation de compte (dans performRegister)
        // Apr√®s d√©connexion/reconnexion, on charge simplement le profil depuis /user/me
        console.log('[AUTH] Utilisateur reconnexion - pas d\'onboarding (uniquement a la creation de compte)');
      } else {
        console.log('[AUTH] Aucun utilisateur charg√©');
        localStorage.removeItem('currentUser');
        sessionStorage.removeItem('currentUser');
        currentUser = getDefaultUser();
      }
    }).catch(error => {
      console.error('[AUTH] Erreur lors du chargement utilisateur au d√©marrage:', error);
    });
    
    // PRIORIT√â 2: D√©marrer le v√©rificateur d'alarmes
    setTimeout(() => {
      startAlarmChecker();
    }, 5000); // Attendre 5 secondes apr√®s le chargement
  });
}

// ============================================
// INT√âGRATION DANS LE CHARGEMENT DES √âV√âNEMENTS
// ============================================

// Modifier la fonction de chargement des √©v√©nements pour appeler checkFavoritesInNewEvents
// Cette fonction doit √™tre appel√©e apr√®s chaque chargement d'√©v√©nements depuis le backend

// ============================================
// CHARGEMENT DES DONN√âES DEPUIS LE BACKEND
// ============================================

// Charger les favoris depuis le backend
async function loadFavoritesFromBackend() {
  if (!currentUser || !currentUser.isLoggedIn) return;
  
  try {
    const response = await fetch(`${window.API_BASE_URL}/user/favorites?userId=${currentUser.id}`);
    if (response.ok) {
      const data = await response.json();
      if (data.success && data.favorites) {
        currentUser.favorites = data.favorites;
      }
    }
  } catch (error) {
    console.error('Erreur chargement favoris:', error);
  }
}

// Charger les alertes depuis le backend
async function loadAlertsFromBackend() {
  if (!currentUser || !currentUser.isLoggedIn) return;
  
  try {
    const response = await fetch(`${window.API_BASE_URL}/user/alerts?userId=${currentUser.id}`);
    if (response.ok) {
      const data = await response.json();
      if (data.success && data.alerts) {
        currentUser.alerts = data.alerts;
      }
    }
  } catch (error) {
    console.error('Erreur chargement alertes:', error);
  }
}

// Charger l'agenda depuis le backend (persistant en base)
async function loadAgendaFromBackend() {
  if (!currentUser || !currentUser.isLoggedIn) return;
  
  try {
    // Utiliser le token JWT pour identifier l'utilisateur de mani√®re fiable
    const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
    const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
    const userId = currentUser.id || currentUser.email || '';
    
    const response = await fetch(`${window.API_BASE_URL}/user/agenda?userId=${userId}`, { headers });
    if (response.ok) {
      const data = await response.json();
      if (data.agenda && Array.isArray(data.agenda)) {
        currentUser.agenda = data.agenda;
        // Sauvegarder aussi en localStorage comme backup
        try { localStorage.setItem('user_agenda_backup', JSON.stringify(data.agenda)); } catch(e) {}
        console.log('[AGENDA] ' + data.agenda.length + ' elements charges depuis la base');
      }
    } else {
      console.warn('[AGENDA] API retourne', response.status, '- tentative localStorage');
      // Fallback localStorage
      try {
        const backup = localStorage.getItem('user_agenda_backup');
        if (backup) {
          currentUser.agenda = JSON.parse(backup);
          console.log('[AGENDA] ' + currentUser.agenda.length + ' elements restaures depuis localStorage');
        }
      } catch(e) {}
    }
  } catch (error) {
    console.error('[AGENDA] Erreur chargement:', error);
    // Fallback localStorage
    try {
      const backup = localStorage.getItem('user_agenda_backup');
      if (backup) {
        currentUser.agenda = JSON.parse(backup);
        console.log('[AGENDA] Fallback localStorage:', currentUser.agenda.length, 'elements');
      }
    } catch(e) {}
  }
}

// =====================================================
// üåç VIEWPORT PROGRESSIF - Chargement par zone visible
// =====================================================

// Debounce handler quand la carte bouge/zoome
function onViewportChange() {
  clearTimeout(viewportFetchTimeout);
  viewportFetchTimeout = setTimeout(() => {
    loadViewportData();
  }, 400); // 400ms debounce pour √©viter les appels en rafale
}

// Charger les donn√©es adapt√©es au zoom et viewport actuels
async function loadViewportData() {
  if (!map) return;
  
  // Ne charger les donn√©es viewport que pour le mode events
  // Pour booking/services, on utilise refreshMarkers() qui respecte currentMode
  if (typeof currentMode !== 'undefined' && currentMode !== 'event') {
    return;
  }
  
  const zoom = map.getZoom();
  const bounds = map.getBounds();
  const south = bounds.getSouth();
  const north = bounds.getNorth();
  const west = bounds.getWest();
  const east = bounds.getEast();
  
  // Cl√© unique pour ce viewport (√©vite les re-fetch inutiles)
  const viewportKey = `${zoom}-${south.toFixed(2)}-${north.toFixed(2)}-${west.toFixed(2)}-${east.toFixed(2)}`;
  if (viewportKey === lastViewportKey) return;
  lastViewportKey = viewportKey;
  
  const params = new URLSearchParams({
    zoom: zoom,
    south: south.toFixed(4),
    north: north.toFixed(4),
    west: west.toFixed(4),
    east: east.toFixed(4)
  });
  
  try {
    const response = await fetch(`${window.API_BASE_URL}/events/viewport?${params}`);
    if (!response.ok) {
      console.warn('[VIEWPORT] Erreur API:', response.status);
      return;
    }
    const data = await response.json();
    
    // RE-V√âRIFIER le mode apr√®s le fetch async (l'utilisateur a pu changer de mode pendant le fetch)
    if (typeof currentMode !== 'undefined' && currentMode !== 'event') {
      console.log('[VIEWPORT] Mode chang√© pendant le fetch, abandon');
      return;
    }
    
    // V√©rifier si un filtre est actif c√¥t√© client
    const hasActiveFilter = (selectedCategories && selectedCategories.length > 0) || 
                            timeFilter || dateRangeStart || dateRangeEnd || 
                            (selectedDates && selectedDates.length > 0);
    
    if (data.type === 'clusters') {
      if (hasActiveFilter) {
        // FILTRE ACTIF + ZOOM FAIBLE : ne PAS afficher les clusters serveur (ils ignorent le filtre)
        // Garder markersLayer visible - le MarkerClusterGroup de Leaflet regroupera
        // automatiquement les marqueurs filtr√©s avec les bons chiffres
        geoCirclesLayer.clearLayers();
        if (markersLayer && !map.hasLayer(markersLayer)) {
          markersLayer.addTo(map);
        }
        console.log('[VIEWPORT] Filtre actif ‚Üí clusters serveur ignor√©s, MarkerClusterGroup utilis√©');
      } else {
        // PAS DE FILTRE : comportement normal - afficher les cercles de comptage serveur
        showGeoClusters(data.data);
        // Cacher le layer de marqueurs individuels
        if (markersLayer && map.hasLayer(markersLayer)) {
          map.removeLayer(markersLayer);
        }
      }
    } else if (data.type === 'events') {
      // MODE D√âTAILL√â: afficher les events r√©els
      geoCirclesLayer.clearLayers();
      // Afficher le layer de marqueurs
      if (markersLayer && !map.hasLayer(markersLayer)) {
        markersLayer.addTo(map);
      }
      // Ajouter les nouveaux events (sans dupliquer)
      addViewportEvents(data);
    }
      } catch (e) {
    console.warn('[VIEWPORT] Erreur:', e);
  }
}

// Afficher les cercles agr√©g√©s (zoom faible) - UNIQUEMENT en mode event
function showGeoClusters(clusters) {
  geoCirclesLayer.clearLayers();
  
  // Ne JAMAIS afficher les clusters events en mode booking ou service
  if (typeof currentMode !== 'undefined' && currentMode !== 'event') {
    return;
  }
  
  const theme = getThemeMarkerColors ? getThemeMarkerColors() : {accent: '#FF6B35', border: 'rgba(255,255,255,0.5)'};
  const t = UI_THEMES && typeof uiThemeIndex !== "undefined" ? UI_THEMES[uiThemeIndex] : null;
  // Utiliser gradient custom si disponible, sinon couleur accent
  const customGrad = theme.gradient ? buildMarkerGradient(theme.gradient, 135) : null;
  const accentColor = customGrad || theme.accent || '#FF6B35';
  const geoBorderColor = theme.border || 'rgba(255,255,255,0.5)';
  
  clusters.forEach(([lat, lng, count]) => {
    // Taille COMPACTE - petits cercles discrets qui ne masquent pas la carte
    // Min 22px, max 36px - proportionnel au log du nombre d'events
    const radius = Math.max(11, Math.min(18, 8 + Math.log10(count + 1) * 3));
    
    // Formater le nombre (ex: 12345 -> "12K")
    let label;
    if (count >= 10000) {
      label = Math.round(count / 1000) + 'K';
    } else if (count >= 1000) {
      label = (count / 1000).toFixed(1) + 'K';
    } else {
      label = count.toString();
    }
    
    // Cr√©er un DivIcon compact - ne masque pas les noms de villes
    const size = radius * 2;
    const icon = L.divIcon({
      html: `<div style="
        background: ${accentColor};
        opacity: 0.85;
        border-radius: 50%;
        width: ${size}px;
        height: ${size}px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: ${size < 26 ? 9 : size < 32 ? 10 : 11}px;
        color: #fff;
        text-shadow: 0 1px 1px rgba(0,0,0,0.6);
        box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        border: 1.5px solid ${geoBorderColor};
        cursor: pointer;
        transition: transform 0.15s;
      " onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">${label}</div>`,
      className: 'geo-cluster-icon',
      iconSize: L.point(size, size),
      iconAnchor: L.point(size / 2, size / 2)
    });
    
    const marker = L.marker([lat, lng], { icon: icon });
    
    // Au clic: zoomer vers cette zone
    marker.on('click', function() {
      const targetZoom = Math.min(map.getZoom() + 3, VIEWPORT_ZOOM_THRESHOLD);
      map.setView([lat, lng], targetZoom, { animate: true });
    });
    
    geoCirclesLayer.addLayer(marker);
  });
  
  console.log(`[VIEWPORT] üåç ${clusters.length} cercles agr√©g√©s affich√©s (zoom ${map.getZoom()})`);
}

// Ajouter les events du viewport au layer de marqueurs (incr√©mental, sans tout effacer)
function addViewportEvents(data) {
  if (!data.k || !data.d) return;
  
  const keys = data.k;
  let newCount = 0;
  
  data.d.forEach(row => {
    // D√©coder le format compact
    const obj = {};
    for (let i = 0; i < keys.length; i++) {
      if (row[i] !== null && row[i] !== undefined) {
        obj[keys[i]] = row[i];
      }
    }
    
    // Skip si d√©j√† charg√©
    if (loadedEventIds.has(obj.id)) return;
    loadedEventIds.add(obj.id);
    
    // Construire l'objet event complet
    const event = {
      ...obj,
      type: 'event',
      lat: obj.latitude,
      lng: obj.longitude,
      startDate: obj.date ? new Date(obj.date + (obj.time ? 'T' + obj.time : '')) : null,
      endDate: obj.end_date ? new Date(obj.end_date) : null,
      address: obj.location || '',
      boost: '1.-',
      likes: 0,
      favorites: 0,
      participations: 0
    };
    
    // V√©rifier lat/lng valides
    if (typeof event.lat !== 'number' || typeof event.lng !== 'number' || isNaN(event.lat) || isNaN(event.lng)) return;
    
    // Ajouter √† eventsData (pour la recherche, les filtres, etc.)
    eventsData.push(event);
    
    // V√©rifier si cet event passe le filtre actif avant de cr√©er un marqueur
    let shouldAddMarker = true;
    if (selectedCategories && selectedCategories.length > 0) {
      // Filtre cat√©gories actif ‚Üí v√©rifier si l'event match
      const lowerCats = selectedCategories.map(c => c.toLowerCase());
      const itemCatParts = getEffectiveCategoryParts(event);
      
      // Construire les cat√©gories autoris√©es (avec descendants et alias) - utilise FILTER_ALIASES global
      const allowed = new Set();
      lowerCats.forEach(sc => {
        allowed.add(sc);
        if (explorerTree) {
          findCategoryDescendants(sc, explorerTree).forEach(d => allowed.add(d));
        }
        (FILTER_ALIASES[sc] || []).forEach(a => {
          allowed.add(a);
          if (explorerTree) findCategoryDescendants(a, explorerTree).forEach(d => allowed.add(d));
        });
      });
      
      shouldAddMarker = Array.from(itemCatParts).some(cat => allowed.has(cat));
    }
    
    // Cr√©er et ajouter le marqueur directement (incr√©mental, sans refreshMarkers)
    if (shouldAddMarker) {
      try {
        const icon = buildMarkerIcon(event);
        const marker = L.marker([event.lat, event.lng], { icon });
        marker.bindPopup('', { maxWidth: 360 });
        marker.on('popupopen', function() {
          marker.closePopup();
          currentPopupMarker = marker;
          const popupContent = buildPopupHtml(event);
          openPopupModal(popupContent, event);
        });
        markersLayer.addLayer(marker);
        markerMap[`event:${event.id}`] = marker;
        newCount++;
      } catch (err) {
        // Silencieux - erreur de marqueur individuel
      }
    }
  });
  
  if (newCount > 0) {
    window.eventsData = eventsData;
    buildSameLocationMap(getActiveData());
    if (typeof refreshListView === 'function') refreshListView();
    console.log(`[VIEWPORT] üìç +${newCount} events ajout√©s sur carte (total eventsData: ${eventsData.length})`);
  }
}

// Charger les √©v√©nements depuis le backend et v√©rifier les favoris
async function loadEventsFromBackend() {
  // MODE VIEWPORT PROGRESSIF: d√©l√©guer au chargement par viewport
  // Cette fonction est gard√©e pour compatibilit√© (appel√©e apr√®s login, changement de statut, etc.)
  // Elle force un rechargement du viewport actuel
  console.log('[EVENTS] üîÑ loadEventsFromBackend ‚Üí rechargement viewport');
  lastViewportKey = ''; // Forcer le re-fetch
  await loadViewportData();
}

// Charger les bookings depuis le backend
async function loadBookingsFromBackend() {
  try {
    const response = await fetch(`${window.API_BASE_URL}/bookings`);
    if (!response.ok) {
      console.warn('[BOOKINGS] Erreur API:', response.status);
      return;
    }
    
    const rawBookings = await response.json();
    const bookingsList = Array.isArray(rawBookings) ? rawBookings : (rawBookings.bookings || []);
    
    if (bookingsList.length === 0) {
      console.log('[BOOKINGS] Aucun booking trouv√© dans le backend');
      return;
    }
    
    // Mapping cat√©gorie -> image dans le dossier event/
    const bookingCategoryImageMap = {
      'musique > electro': 'electronic.jpg',
      'musique > techno': 'techno.jpg',
      'musique > house': 'house.jpg',
      'musique > trance': 'Trance.jpeg',
      'musique > jazz': 'jazzsoulfunk.jpg',
      'musique > blues': 'jazzsoulfunk.jpg',
      'musique > rock': 'rock.jpg',
      'musique > metal': 'metal.jpg',
      'musique > punk': 'punkrock.jpg',
      'musique > hip-hop': 'hiphop.jpg',
      'musique > hip-hop/rap': 'hiphop.jpg',
      'musique > rap': 'rap.jpg',
      'musique > reggae': 'reggae.jpg',
      'musique > soul': 'jazzsoulfunk.jpg',
      'musique > soul/funk': 'jazzsoulfunk.jpg',
      'musique > funk': 'jazzsoulfunk.jpg',
      'musique > pop': 'PopVari√©t√©.jpg',
      'musique > folk': 'folk.jpg',
      'musique > classique': 'op√©ra.jpg',
      'musique > world': 'world.jpg',
      'musique > latin': 'latin.jpg',
      'musique > r&b': 'RnB.jpg',
      'musique > concert': 'live musique.jpg',
      'musique > chanson': 'PopVari√©t√©.jpg',
      'musique > dnb': 'Drum&Bass.jpg',
      'musique > drum & bass': 'Drum&Bass.jpg',
      'performers': 'performers.png',
      'vj & visuels': 'VJ.jpg',
      'mcs & animateurs': 'bookingdefault.jpg',
      'live acts': 'LiveActs.jpg',
    };
    
    // Transformer les bookings API en format frontend
    const backendBookings = bookingsList.map(b => {
      // Cat√©gories : peut √™tre un string JSON ou un array
      let cats = b.categories || [];
      if (typeof cats === 'string') {
        try { cats = JSON.parse(cats); } catch(e) { cats = [cats]; }
      }
      if (!Array.isArray(cats)) cats = [cats];
      
      const desc = b.description || '';
      
      // Extraire les URLs audio depuis la description (format: "üîä Audio: https://...")
      let audioUrls = [];
      const audioMatches = desc.matchAll(/üîä\s*Audio:\s*(https?:\/\/[^\s|]+)/g);
      for (const m of audioMatches) {
        audioUrls.push(m[1]);
      }
      
      // Extraire le lien source (publication originale) depuis la description
      let sourceUrl = b.source_url || null;
      const sourceMatch = desc.match(/üîó\s*Source:\s*(https?:\/\/[^\s|]+)/);
      if (sourceMatch) sourceUrl = sourceMatch[1];
      
      // Extraire les URLs cover depuis la description (format: "üñºÔ∏è Cover: https://...")
      let coverUrl = null;
      const coverMatch = desc.match(/üñºÔ∏è\s*Cover:\s*(https?:\/\/[^\s|]+)/);
      if (coverMatch) {
        coverUrl = coverMatch[1];
      }
      
      // Nettoyer la description (retirer les URLs audio/cover/source + num√©ros de t√©l√©phone)
      let cleanDesc = desc
        .replace(/\s*\|\s*üîä\s*Audio:\s*https?:\/\/[^\s|]+/g, '')
        .replace(/\s*\|\s*üñºÔ∏è\s*Cover:\s*https?:\/\/[^\s|]+/g, '')
        .replace(/\s*\|\s*üîó\s*Source:\s*https?:\/\/[^\s|]+/g, '')
        // Supprimer les num√©ros de t√©l√©phone (formats: +41 xx xxx xx xx, 0xx xxx xx xx, 07x.xxx.xx.xx, etc.)
        .replace(/üìû\s*[^|\n]*/g, '')
        .replace(/‚òé\s*[^|\n]*/g, '')
        .replace(/(?:Tel|T√©l|T√©l√©phone|Phone|Tel\.|T√©l\.)\s*[:.]?\s*[\+]?[\d\s\.\-\(\)]{7,}/gi, '')
        .replace(/(?:\+\d{1,3}[\s\.\-]?)?\(?\d{2,4}\)?[\s\.\-]?\d{2,4}[\s\.\-]?\d{2,4}[\s\.\-]?\d{0,4}/g, (match) => {
          // Ne supprimer que si √ßa ressemble vraiment √† un num√©ro de t√©l√©phone (min 10 chiffres)
          const digits = match.replace(/\D/g, '');
          return digits.length >= 10 ? '' : match;
        })
        .replace(/\s{2,}/g, ' ')
        .trim();
      
      // Trouver la bonne image bas√©e sur la cat√©gorie
      let categoryImage = null;
      for (const cat of cats) {
        const catLower = (cat || '').toLowerCase();
        if (bookingCategoryImageMap[catLower]) {
          // Utiliser le dossier event/ pour les images musicales
          const imgFile = bookingCategoryImageMap[catLower];
          const folder = ['performers.png', 'VJ.jpg', 'LiveActs.jpg', 'bookingdefault.jpg'].includes(imgFile) ? 'booking' : 'event';
          categoryImage = `/assets/category_images/${folder}/${imgFile}`;
          break;
        }
      }
      // Fallback: image musicale g√©n√©rique
      if (!categoryImage) {
        categoryImage = '/assets/category_images/event/music.jpg';
      }
      
      return {
        id: b.id,
        type: 'booking',
        name: b.title || b.name || '',
        title: b.title || b.name || '',
        description: cleanDesc,
        city: b.city || '',
        address: b.location || b.address || '',
        lat: parseFloat(b.latitude) || parseFloat(b.lat) || null,
        lng: parseFloat(b.longitude) || parseFloat(b.lng) || null,
        categories: cats,
        mainCategory: cats[0] || 'Musique',
        categoryImage: null,
        // Image: cover Audius ou image par cat√©gorie
        imageUrl: coverUrl || categoryImage,
        boost: b.boost || 'basic',
        soundLinks: audioUrls.length > 0 ? audioUrls : (b.sound_links || []),
        email: b.email || '',
        website: b.website || '',
        sourceUrl: sourceUrl,
        source_url: sourceUrl,
        validation_status: b.validation_status || 'scraped',
        isAI: false,
        verified: false,
        likes: b.likes || 0,
        rating: b.rating || '0'
      };
    }).filter(b => {
      // Filtrer : GPS valide ET au moins un son
      if (!b.lat || !b.lng || isNaN(b.lat) || isNaN(b.lng)) return false;
      if (!b.soundLinks || b.soundLinks.length === 0) return false;
      return true;
    });
    
    // Filtrer les doublons
    const existingIds = new Set(bookingsData.map(b => b.id));
    const newBookings = backendBookings.filter(b => !existingIds.has(b.id));
    
    if (newBookings.length > 0) {
      bookingsData.push(...newBookings);
      window.bookingsData = bookingsData;
      console.log(`‚úÖ ${newBookings.length} bookings charg√©s (avec audio, marqueurs orange)`);
      
      // Rafra√Æchir si on est en mode booking
      if (currentMode === 'booking') {
        refreshMarkers();
        refreshListView();
      }
    }
  } catch (error) {
    console.error('[BOOKINGS] Erreur chargement:', error);
  }
}

// Charger les services depuis le backend
async function loadServicesFromBackend() {
  try {
    const response = await fetch(`${window.API_BASE_URL}/services`);
    if (!response.ok) {
      console.warn('[SERVICES] Erreur API:', response.status);
      return;
    }
    
    const rawServices = await response.json();
    const servicesList = Array.isArray(rawServices) ? rawServices : (rawServices.services || []);
    
    if (servicesList.length === 0) {
      console.log('[SERVICES] Aucun service trouv√© dans le backend');
      return;
    }
    
    // Transformer les services API en format frontend
    const backendServices = servicesList.map(s => {
      let cats = s.categories || [];
      if (typeof cats === 'string') {
        try { cats = JSON.parse(cats); } catch(e) { cats = [cats]; }
      }
      if (!Array.isArray(cats)) cats = [cats];
      
      return {
        id: s.id,
        type: 'service',
        name: s.name || '',
        title: s.name || '',
        description: s.description || '',
        address: s.location || '',
        location: s.location || '',
        lat: parseFloat(s.latitude) || parseFloat(s.lat) || null,
        lng: parseFloat(s.longitude) || parseFloat(s.lng) || null,
        categories: cats,
        mainCategory: cats[0] || 'Prestataires & Logistique',
        boost: '1.-',
        likes: s.likes_count || 0,
        favorites: s.favorites_count || 0,
        isAI: false,
        verified: false,
        created_at: s.created_at
      };
    }).filter(s => s.lat && s.lng && !isNaN(s.lat) && !isNaN(s.lng));
    
    // Filtrer les doublons
    const existingIds = new Set(servicesData.map(s => s.id));
    const newServices = backendServices.filter(s => !existingIds.has(s.id));
    
    if (newServices.length > 0) {
      servicesData.push(...newServices);
      window.servicesData = servicesData;
      console.log(`‚úÖ ${newServices.length} services charg√©s depuis le backend`);
      
      // Rafra√Æchir si on est en mode service
      if (currentMode === 'service') {
        refreshMarkers();
        refreshListView();
      }
    }
  } catch (error) {
    console.error('[SERVICES] Erreur chargement:', error);
  }
}

// Parser une date fran√ßaise (ex: "5 Avr. 2026" + "08:30:00")
function parseFrenchDate(dateStr, timeStr) {
  if (!dateStr) return null;
  
  const months = {
    'janv.': '01', 'f√©vr.': '02', 'mars': '03', 'avr.': '04',
    'mai': '05', 'juin': '06', 'juil.': '07', 'ao√ªt': '08',
    'sept.': '09', 'oct.': '10', 'nov.': '11', 'd√©c.': '12'
  };
  
  // Parser "5 Avr. 2026"
  const parts = dateStr.trim().split(' ');
  if (parts.length !== 3) return null;
  
  const day = parts[0].padStart(2, '0');
  const month = months[parts[1].toLowerCase()] || '01';
  const year = parts[2];
  
  // Parser l'heure "08:30:00"
  const time = timeStr ? timeStr.substring(0, 5) : '00:00';
  
  return `${year}-${month}-${day}T${time}:00`;
}

// Charger toutes les donn√©es utilisateur au login
async function loadUserDataOnLogin() {
  // 1. Charger l'utilisateur depuis /api/user/me (source de v√©rit√©)
  const user = await loadCurrentUserFromAPI().catch(err => {
    console.error('[AUTH] Erreur chargement utilisateur au d√©marrage:', err);
    return null;
  });
  
  if (user) {
    console.log('[AUTH] Utilisateur charg√© depuis /api/user/me:', user.email);
    if (typeof window.updateAccountBlock === 'function') {
      setTimeout(() => window.updateAccountBlock(), 100);
    }
  } else {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
      try {
        const parsed = JSON.parse(savedUser);
        if (parsed.addresses && parsed.addresses.length > 0) {
          currentUser.addresses = parsed.addresses || [];
        }
      } catch (e) {
        console.error('Erreur chargement adresses:', e);
      }
    }
  }
  
  loadUserLocationFromStorage();
  
  if (!currentUser.location || !currentUser.location.lat || !currentUser.location.lng) {
    requestUserLocation().catch(() => console.log('G√©olocalisation refus√©e ou indisponible'));
  }
  
  // Charger agenda, favoris, alertes depuis la base (persistant)
  if (currentUser && currentUser.isLoggedIn) {
    await loadAgendaFromBackend();
    await loadFavoritesFromBackend();
    await loadAlertsFromBackend();
    
    // Charger le theme custom depuis la BDD
    try {
      const token = typeof getAuthToken === 'function' ? getAuthToken() : null;
      if (token) {
        const themeResp = await fetch(`${window.API_BASE_URL}/user/theme`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (themeResp.ok) {
          const themeConfig = await themeResp.json();
          if (themeConfig && themeConfig.markerColors) {
            window.customThemeConfig = themeConfig;
            localStorage.setItem('customThemeConfig', JSON.stringify(themeConfig));
            applyCustomColors();
            console.log('[THEME] Theme custom charge depuis la BDD');
          }
        }
      }
    } catch (e) {
      console.warn('[THEME] Erreur chargement theme:', e);
    }
    
    if (typeof refreshMarkers === 'function') refreshMarkers();
    if (typeof refreshListView === 'function') refreshListView();
  }
  
  await loadEventsFromBackend();
  
  // Afficher la popup d'alertes si il y en a de nouvelles
  // CORRECTION: V√©rifier que currentUser.alerts existe avant d'utiliser filter
  if (currentUser && currentUser.alerts && Array.isArray(currentUser.alerts)) {
    const newAlerts = currentUser.alerts.filter(a => a.status === 'new');
    if (newAlerts.length > 0) {
      setTimeout(() => {
        showAlertsLoginPopup(newAlerts);
      }, 1000);
    }
  } else {
    // Initialiser alerts si undefined
    if (currentUser && !currentUser.alerts) {
      currentUser.alerts = [];
    }
  }
}

// ============================================
// G√âOLOCALISATION UTILISATEUR
// ============================================

// Obtenir la position de l'utilisateur (g√©olocalisation)
function getUserLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('G√©olocalisation non support√©e'));
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const location = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          city: null // Peut √™tre rempli avec une API de g√©ocodage inverse
        };
        
        // Sauvegarder dans currentUser
        if (currentUser) {
          currentUser.location = location;
        }
        
        // Sauvegarder dans localStorage
        try {
          localStorage.setItem('userLocation', JSON.stringify(location));
        } catch (e) {
          console.error('Erreur sauvegarde position:', e);
        }
        
        resolve(location);
      },
      (error) => {
        console.error('Erreur g√©olocalisation:', error);
        reject(error);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 300000 // Cache de 5 minutes
      }
    );
  });
}

// D√©finir manuellement la position de l'utilisateur (par ville ou coordonn√©es)
function setUserLocation(lat, lng, city = null) {
  if (currentUser) {
    currentUser.location = {
      lat: lat,
      lng: lng,
      city: city
    };
    
    // Sauvegarder dans localStorage
    try {
      localStorage.setItem('userLocation', JSON.stringify(currentUser.location));
    } catch (e) {
      console.error('Erreur sauvegarde position:', e);
    }
    
    showNotification('üìç Position mise √† jour', 'success');
  }
}

// Charger la position depuis localStorage
function loadUserLocationFromStorage() {
  try {
    const saved = localStorage.getItem('userLocation');
    if (saved) {
      const location = JSON.parse(saved);
      if (currentUser) {
        currentUser.location = location;
      }
      return location;
    }
  } catch (e) {
    console.error('Erreur chargement position:', e);
  }
  return null;
}

// Demander la g√©olocalisation √† l'utilisateur
async function requestUserLocation() {
  try {
    const location = await getUserLocation();
    showNotification('üìç Position obtenue avec succ√®s', 'success');
    return location;
  } catch (error) {
    showNotification('‚ö†Ô∏è Impossible d\'obtenir votre position. Vous pouvez la d√©finir manuellement dans les param√®tres.', 'warning');
    return null;
  }
}

// ============================================
// INT√âGRATION DANS L'AGENDA
// ============================================

// Modifier openAgendaModal pour ajouter le bouton "Ajouter alarme"
// Cette fonction doit √™tre modifi√©e pour inclure le syst√®me d'alarmes

// ============================================
// EXPOSITION GLOBALE EXPLICITE DES FONCTIONS D'AUTHENTIFICATION
// ============================================
// Garantir que les fonctions sont disponibles globalement √† la fin du chargement
// Ces assignations sont critiques pour que les boutons/links HTML puissent les appeler

// Fonction helper pour exposer de mani√®re robuste
(function exposeAuthFunctions() {
  // V√©rifier que window existe
  if (typeof window === 'undefined') {
    console.error('[AUTH] window n\'est pas disponible');
    return;
  }
  
  // REMOVED: Les fonctions AUTH sont maintenant dans auth.js et expos√©es globalement
  // V√©rification que les fonctions sont bien charg√©es depuis auth.js
  if (typeof window.openAuthModal === 'function') {
    console.log('[AUTH] ‚úÖ openAuthModal charg√©e depuis auth.js');
  } else {
    console.error('[AUTH] ‚ùå ERREUR: window.openAuthModal n\'est pas disponible (auth.js non charg√© ?)');
  }
  
  if (typeof window.openLoginModal === 'function') {
    console.log('[AUTH] ‚úÖ openLoginModal charg√©e depuis auth.js');
  } else {
    console.warn('[AUTH] ‚ö†Ô∏è window.openLoginModal non disponible (utilisera wrapper local)');
  }
  
  if (typeof window.openRegisterModal === 'function') {
    console.log('[AUTH] ‚úÖ openRegisterModal charg√©e depuis auth.js');
  } else {
    console.warn('[AUTH] ‚ö†Ô∏è window.openRegisterModal non disponible (utilisera wrapper local)');
  }
  
  // showRegisterStep1 peut rester ici si elle n'est pas dans auth.js
  // Exposer seulement si elle n'est pas d√©j√† expos√©e
  if (typeof showRegisterStep1 === 'function' && typeof window.showRegisterStep1 !== 'function') {
    window.showRegisterStep1 = showRegisterStep1;
    console.log('[AUTH] showRegisterStep1 expose globalement (local)');
  } else if (typeof window.showRegisterStep1 === 'function') {
    console.log('[AUTH] ‚úÖ showRegisterStep1 d√©j√† charg√©e');
  } else {
    // Cr√©er une fonction de fallback seulement si elle n'existe pas
    if (typeof window.showRegisterStep1 !== 'function') {
      window.showRegisterStep1 = function() {
        console.warn('[AUTH] showRegisterStep1 non disponible, redirection vers openAuthModal("register")');
        if (typeof window.openAuthModal === 'function') {
          window.openAuthModal('register');
        } else {
          console.error('[AUTH] ERREUR: window.openAuthModal n\'est pas disponible');
        }
      };
      console.log('[AUTH] showRegisterStep1 (fallback) cree et expose');
    }
  }
  
  // Les fonctions d'onboarding restent dans map_logic.js (elles ne sont pas dans auth.js)
  // Exposer seulement si elles ne sont pas d√©j√† expos√©es
  if (typeof startOnboardingIfNeeded === 'function' && typeof window.startOnboardingIfNeeded !== 'function') {
    window.startOnboardingIfNeeded = startOnboardingIfNeeded;
    window.startOnboarding = startOnboardingIfNeeded; // Alias
    console.log('[ONBOARDING] startOnboardingIfNeeded expose globalement');
  } else if (typeof window.startOnboardingIfNeeded === 'function') {
    console.log('[ONBOARDING] ‚úÖ startOnboardingIfNeeded d√©j√† charg√©e');
  } else {
    console.warn('[ONBOARDING] startOnboardingIfNeeded non disponible');
  }
  
  if (typeof openOnboardingModal === 'function' && typeof window.openOnboardingModal !== 'function') {
    window.openOnboardingModal = openOnboardingModal;
    console.log('[ONBOARDING] openOnboardingModal expose globalement');
  } else if (typeof window.openOnboardingModal === 'function') {
    console.log('[ONBOARDING] ‚úÖ openOnboardingModal d√©j√† charg√©e');
  } else {
    console.warn('[ONBOARDING] openOnboardingModal non disponible');
  }
  
  if (typeof checkProfileCompleteness === 'function' && typeof window.checkProfileCompleteness !== 'function') {
    window.checkProfileCompleteness = checkProfileCompleteness;
    console.log('[ONBOARDING] checkProfileCompleteness expose globalement');
  } else if (typeof window.checkProfileCompleteness === 'function') {
    console.log('[ONBOARDING] ‚úÖ checkProfileCompleteness d√©j√† charg√©e');
  } else {
    console.warn('[ONBOARDING] checkProfileCompleteness non disponible');
  }
  
  // V√©rification finale avec logs ASCII
  console.log('[AUTH] Verification finale des fonctions globales:');
  console.log('  typeof window.openAuthModal:', typeof window.openAuthModal);
  console.log('  typeof window.openLoginModal:', typeof window.openLoginModal);
  console.log('  typeof window.openRegisterModal:', typeof window.openRegisterModal);
  console.log('  typeof window.showRegisterStep1:', typeof window.showRegisterStep1);
  console.log('  typeof window.closeAuthModal:', typeof window.closeAuthModal);
  console.log('  typeof window.fermerModalAuth:', typeof window.fermerModalAuth);
  console.log('[ONBOARDING] Verification finale des fonctions onboarding:');
  console.log('  typeof window.startOnboardingIfNeeded:', typeof window.startOnboardingIfNeeded);
  console.log('  typeof window.startOnboarding:', typeof window.startOnboarding);
  console.log('  typeof window.openOnboardingModal:', typeof window.openOnboardingModal);
  console.log('  typeof window.checkProfileCompleteness:', typeof window.checkProfileCompleteness);
  
  // V√©rification suppl√©mentaire: tester si les fonctions sont vraiment dans window
  console.log('[AUTH] Verification window:');
  console.log('  window.hasOwnProperty("openAuthModal"):', window.hasOwnProperty('openAuthModal'));
  console.log('  "openAuthModal" in window:', 'openAuthModal' in window);
  console.log('  Object.keys(window).includes("openAuthModal"):', Object.keys(window).includes('openAuthModal'));
  console.log('[ONBOARDING] Verification window onboarding:');
  console.log('  window.hasOwnProperty("startOnboardingIfNeeded"):', window.hasOwnProperty('startOnboardingIfNeeded'));
  console.log('  "startOnboardingIfNeeded" in window:', 'startOnboardingIfNeeded' in window);
})();
